# =============================================================================
# Author: John Iselin
# Date:   August 17th, 2025
# File:   api_code.R
#
# Load ACS Data VIA IPUMS
# =============================================================================
# --- Load Packages ---
library(dplyr)      # data wrangling
library(ipumsr)     # download data
library(stringr)    # string functions
# --- File Paths (relative to Rproj root) ---
setwd("C:/Users/ji252/Documents/GitHub/multnomah-county-tax")
dir_data_acs <- file.path("C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/acs")
# --- PARAMETERS ---
runanyway <- 1
# --- Get IPUMS and BLS API codes  ---
if (file.exists("api_codes.txt") == TRUE) {
## Load values
api_codes <- read.delim("api_codes.txt", sep = ",")
## Store values
ipums_key <- str_trim(api_codes[1, 2])
# bls_key <- str_trim(api_codes[2, 2])
# --- IPUMS KEY ---
set_ipums_api_key( ipums_key, save = TRUE, overwrite = TRUE)
# --- BLS KEY ---
#bls_set_key(bls_key)
} else stop("STOP, NO API KEYS")
# --- Parameters ---
start_year       <- 2015
end_year         <- 2023
# -----------------------------
# Define, Submit, and read ACS Extract Request
# -----------------------------
## PREFORM THIS PROCESS ITERATIVELY OVER YEARS
years <- start_year:end_year
for (y in years) {
# File path for the raw and processed RDS version
file_acs <- file.path(dir_data_acs, paste0("acs_", y, ".csv"))
if (!file.exists(file_acs) | runanyway == 1) {
message("Downloading ACS data for ", y, " via IPUMS...")
# Define extract name
extract_name <- paste0("ACS  microdata for CalEITC, Year: ", y)
## Specified vars
gq <- var_spec("GQ", case_selections = c("1", "2"))
workedyr <- var_spec("WORKEDYR", data_quality_flags = TRUE)
empstat <- var_spec("EMPSTAT", data_quality_flags = TRUE)
empstatd <- var_spec("EMPSTATD", data_quality_flags = TRUE)
inctot <- var_spec("INCTOT", data_quality_flags = TRUE)
incwage <- var_spec("INCWAGE", data_quality_flags = TRUE)
ftotinc <- var_spec("FTOTINC", data_quality_flags = TRUE)
incearn <- var_spec("INCEARN", data_quality_flags = TRUE)
migrate1 <- var_spec("MIGRATE1", data_quality_flags = TRUE)
migrate1d <- var_spec("MIGRATE1D", data_quality_flags = TRUE)
migplac1 <- var_spec("MIGPLAC1", data_quality_flags = TRUE)
migcounty1 <- var_spec("MIGCOUNTY1", data_quality_flags = TRUE)
pwstate2 <- var_spec("PWSTATE2", data_quality_flags = TRUE)
pwcounty <- var_spec("PWCOUNTY", data_quality_flags = TRUE)
## Extract data
acs_data <- define_extract_micro(
collection = "usa",
description = extract_name,
samples = paste0("us", y, "a"),
variables = list(
"YEAR",
"SAMPLE",
"SERIAL",
"HHWT",
"PERWT",
"CLUSTER",
"STRATA",
"CPI99",
"STATEFIP",
"COUNTYFIP",
"PERNUM",
"RELATED",
"NCHILD",
"YNGCH",
"Nchlt5",
"AGE",
"SEX",
"RACE",
"HISPAN",
"MARST",
"CITIZEN",
"SCHOOL",
"EDUCD",
inctot,
ftotinc,
incwage,
incearn,
gq,
workedyr,
empstat,
empstatd,
migrate1,
migrate1d,
migplac1,
migcounty1,
pwcounty,
pwstate2
)
) %>%
submit_extract() %>%
wait_for_extract() %>%
download_extract(download_dir = dir_data_acs, overwrite = TRUE) %>%
read_ipums_micro() %>%
rename_with(tolower)
# Save file
write.csv(acs_data, file_acs)
rm(acs_data)
}
}
# =============================================================================
# Author: John Iselin
# Date:   August 17th, 2025
# File:   api_code.R
#
# Load ACS Data VIA IPUMS
# =============================================================================
# --- Load Packages ---
library(dplyr)      # data wrangling
library(ipumsr)     # download data
library(stringr)    # string functions
# --- File Paths (relative to Rproj root) ---
setwd("C:/Users/ji252/Documents/GitHub/multnomah-county-tax")
dir_data_acs <- file.path("C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/acs")
# --- PARAMETERS ---
runanyway <- 1
# --- Get IPUMS and BLS API codes  ---
if (file.exists("api_codes.txt") == TRUE) {
## Load values
api_codes <- read.delim("api_codes.txt", sep = ",")
## Store values
ipums_key <- str_trim(api_codes[1, 2])
# bls_key <- str_trim(api_codes[2, 2])
# --- IPUMS KEY ---
set_ipums_api_key( ipums_key, save = TRUE, overwrite = TRUE)
# --- BLS KEY ---
#bls_set_key(bls_key)
} else stop("STOP, NO API KEYS")
# --- Parameters ---
start_year       <- 2015
end_year         <- 2023
# -----------------------------
# Define, Submit, and read ACS Extract Request
# -----------------------------
## PREFORM THIS PROCESS ITERATIVELY OVER YEARS
years <- start_year:end_year
for (y in years) {
# File path for the raw and processed RDS version
file_acs <- file.path(dir_data_acs, paste0("acs_", y, ".csv"))
if (!file.exists(file_acs) | runanyway == 1) {
message("Downloading ACS data for ", y, " via IPUMS...")
# Define extract name
extract_name <- paste0("ACS  microdata for CalEITC, Year: ", y)
## Specified vars
gq <- var_spec("GQ", case_selections = c("1", "2"))
workedyr <- var_spec("WORKEDYR", data_quality_flags = TRUE)
empstat <- var_spec("EMPSTAT", data_quality_flags = TRUE)
empstatd <- var_spec("EMPSTATD", data_quality_flags = TRUE)
inctot <- var_spec("INCTOT", data_quality_flags = TRUE)
incwage <- var_spec("INCWAGE", data_quality_flags = TRUE)
ftotinc <- var_spec("FTOTINC", data_quality_flags = TRUE)
incearn <- var_spec("INCEARN", data_quality_flags = TRUE)
migrate1 <- var_spec("MIGRATE1", data_quality_flags = TRUE)
migrate1d <- var_spec("MIGRATE1D", data_quality_flags = TRUE)
migplac1 <- var_spec("MIGPLAC1", data_quality_flags = TRUE)
migcounty1 <- var_spec("MIGCOUNTY1")
pwstate2 <- var_spec("PWSTATE2")
pwcounty <- var_spec("PWCOUNTY")
## Extract data
acs_data <- define_extract_micro(
collection = "usa",
description = extract_name,
samples = paste0("us", y, "a"),
variables = list(
"YEAR",
"SAMPLE",
"SERIAL",
"HHWT",
"PERWT",
"CLUSTER",
"STRATA",
"CPI99",
"STATEFIP",
"COUNTYFIP",
"PERNUM",
"RELATED",
"NCHILD",
"YNGCH",
"Nchlt5",
"AGE",
"SEX",
"RACE",
"HISPAN",
"MARST",
"CITIZEN",
"SCHOOL",
"EDUCD",
inctot,
ftotinc,
incwage,
incearn,
gq,
workedyr,
empstat,
empstatd,
migrate1,
migrate1d,
migplac1,
migcounty1,
pwcounty,
pwstate2
)
) %>%
submit_extract() %>%
wait_for_extract() %>%
download_extract(download_dir = dir_data_acs, overwrite = TRUE) %>%
read_ipums_micro() %>%
rename_with(tolower)
# Save file
write.csv(acs_data, file_acs)
rm(acs_data)
}
}
