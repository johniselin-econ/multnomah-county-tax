)
# Loop over measures
for (measure in c("n1", "n2", "agi")) {
# Load flow comparison data from working directory
csv_path <- file.path(flows_data_dir, paste0("multnomah_flow_comparison_", measure, ".csv"))
# Check if file exists
if (!file.exists(csv_path)) {
message(paste0("Warning: File not found - ", csv_path))
next
}
flow_data <- read_csv(csv_path, show_col_types = FALSE)
# Loop over directions
for (direction in c("out", "in", "net")) {
# ---- US Map (excluding AK, HI) ----
us_map <- create_flow_map(
data = flow_data,
counties_sf = us_counties_flow,
direction = direction,
measure = measure,
region_name = "Continental US"
)
# Save US map to maps folder
us_filepath <- file.path(flows_output_dir, paste0("map_", measure, "_", direction, "_us.png"))
ggsave(us_filepath, us_map, width = 14, height = 9, dpi = 300, bg = "white")
message(paste0("Saved: ", us_filepath))
# ---- West Coast Map (cropped to only show CA, OR, WA) ----
wc_map <- create_flow_map(
data = flow_data,
counties_sf = west_coast_counties,
direction = direction,
measure = measure,
region_name = "West Coast (CA, OR, WA)",
coord_limits = wc_coord_limits
)
# Save West Coast map to maps folder
wc_filepath <- file.path(flows_output_dir, paste0("map_", measure, "_", direction, "_westcoast.png"))
ggsave(wc_filepath, wc_map, width = 8, height = 14, dpi = 300, bg = "white")
message(paste0("Saved: ", wc_filepath))
}
}
message("All flow delta maps created successfully!")
# ------------------------------------------------------------
# GENERATE RATE CHANGE MAPS (using pre-calculated differences)
# ------------------------------------------------------------
# Loop over measures
for (measure in c("n1", "n2", "agi")) {
# Load flow comparison data from working directory
csv_path <- file.path(flows_data_dir, paste0("multnomah_flow_comparison_", measure, ".csv"))
# Check if file exists
if (!file.exists(csv_path)) {
message(paste0("Warning: File not found - ", csv_path))
next
}
flow_data <- read_csv(csv_path, show_col_types = FALSE)
# Check if rate_change columns exist
if (!all(c("out_rate_change", "in_rate_change", "net_rate_change") %in% names(flow_data))) {
message(paste0("Warning: Rate change columns not found in ", csv_path))
next
}
# Loop over directions for rate change maps
for (direction in c("out", "in", "net")) {
# ---- US Map (excluding AK, HI) ----
us_rate_map <- create_rate_change_map(
data = flow_data,
counties_sf = us_counties_flow,
direction = direction,
measure = measure,
region_name = "Continental US"
)
# Save US rate change map
us_rate_filepath <- file.path(flows_output_dir, paste0("map_", measure, "_", direction, "_rate_change_us.png"))
ggsave(us_rate_filepath, us_rate_map, width = 14, height = 9, dpi = 300, bg = "white")
message(paste0("Saved: ", us_rate_filepath))
# ---- West Coast Map (cropped to only show CA, OR, WA) ----
wc_rate_map <- create_rate_change_map(
data = flow_data,
counties_sf = west_coast_counties,
direction = direction,
measure = measure,
region_name = "West Coast (CA, OR, WA)",
coord_limits = wc_coord_limits
)
# Save West Coast rate change map
wc_rate_filepath <- file.path(flows_output_dir, paste0("map_", measure, "_", direction, "_rate_change_westcoast.png"))
ggsave(wc_rate_filepath, wc_rate_map, width = 8, height = 14, dpi = 300, bg = "white")
message(paste0("Saved: ", wc_rate_filepath))
}
}
message("All rate change maps created successfully!")
suppressPackageStartupMessages({
library(sf)
library(tidyverse)
library(tigris)
library(readxl)
library(here)
library(patchwork)
library(cowplot)
})
options(tigris_use_cache = TRUE)
home_base <- here()
results_dir <- file.path(home_base, "results")
data_dir    <- file.path(home_base, "data")
maps_dir    <- file.path(results_dir, "maps")
# Create maps directory if it doesn't exist
if (!dir.exists(maps_dir)) {
dir.create(maps_dir, recursive = TRUE)
}
# ------------------------------------------------------------
# Relative file paths (edit only if your repo layout differs)
# ------------------------------------------------------------
filepath1   <- file.path(maps_dir, "map1.png")
filepath2   <- file.path(maps_dir, "map2.png")
filepath_combined <- file.path(maps_dir, "map_combined.png")
filepath_us <- file.path(maps_dir, "map_us_pool.png")
metro_path  <- file.path(data_dir, "mapping", "Metro_District_Boundary", "Metro_District_Boundary.shp")
county_path <- file.path(data_dir, "working", "acs_county_sample.xlsx")
# ------------------------------------------------------------
# 1. LOAD COUNTIES (OR + WA) + County Pool
# ------------------------------------------------------------
or_counties <- counties("OR", cb = TRUE, year = 2023) |> st_transform(3857)
wa_counties <- counties("WA", cb = TRUE, year = 2023) |> st_transform(3857)
multnomah <- or_counties |> filter(NAME == "Multnomah")
pool <- readxl::read_excel(county_path)
# ------------------------------------------------------------
# 2. LOAD SELECTED CITIES
# ------------------------------------------------------------
or_places <- places("OR", cb = TRUE, year = 2023) |> st_transform(3857)
wa_places <- places("WA", cb = TRUE, year = 2023) |> st_transform(3857)
selected_or <- c("Portland","Eugene","Salem","Bend")
selected_wa <- c("Vancouver","Seattle","Tacoma","Spokane")
major_cities <- bind_rows(
or_places |> filter(NAME %in% selected_or),
wa_places |> filter(NAME %in% selected_wa)
)
city_points <- major_cities |> st_centroid()
# ------------------------------------------------------------
# 3. STATE POLYGONS AND LABEL POINTS
# ------------------------------------------------------------
or_state <- st_union(or_counties)
wa_state <- st_union(wa_counties)
or_centroid <- st_centroid(or_state)
wa_centroid <- st_centroid(wa_state)
# ============================================================
# MAP 1 — Oregon + Washington (counties + selected cities)
# ============================================================
map1 <- ggplot() +
geom_sf(data = or_counties, fill = "gray92", color = "white", size = 0.3) +
geom_sf(data = wa_counties, fill = "gray88", color = "white", size = 0.3) +
geom_sf(data = multnomah, fill = "yellow", color = "black", size = 0.5) +
# county labels
geom_sf_text(
data = or_counties |> filter(NAME == "Multnomah"),
aes(label = NAME),
nudge_y = -12000,
nudge_x =  40000,
size = 2.0,
fontface = "bold"
) +
geom_sf_text(data = or_counties |> filter(NAME != "Multnomah"), aes(label = NAME), size = 2.0) +
geom_sf_text(data = wa_counties, aes(label = NAME), size = 2.0) +
# state labels
geom_sf_text(
data = or_centroid, aes(label = "OREGON"),
nudge_y = -30000,
size = 6, fontface = "bold"
) +
geom_sf_text(
data = wa_centroid, aes(label = "WASHINGTON"),
size = 6, fontface = "bold"
) +
# city points
geom_sf(data = city_points, color = "red", size = 2) +
# city labels: Vancouver above; others below
geom_sf_text(
data = city_points |> filter(NAME == "Vancouver"),
aes(label = NAME),
nudge_y = 15000,
size = 2.4,
fontface = "bold"
) +
geom_sf_text(
data = city_points |> filter(NAME != "Vancouver"),
aes(label = NAME),
nudge_y = -15000,
size = 2.4,
fontface = "bold"
) +
theme_void() +
coord_sf(expand = FALSE)
ggsave(filepath1, map1, width = 10, height = 8, dpi = 300)
# ------------------------------------------------------------
# 4. CREATE MULTNOMAH REGION CLOSE-UP BOUNDING BOX
# ------------------------------------------------------------
bb  <- st_bbox(multnomah)
pad <- 50000
xspan <- (bb["xmax"] - bb["xmin"]) + 2 * pad
yspan <- (bb["ymax"] - bb["ymin"]) + 2 * pad
side  <- max(xspan, yspan) / 2
cx <- (bb["xmin"] + bb["xmax"]) / 2
cy <- (bb["ymin"] + bb["ymax"]) / 2
square_poly <- st_polygon(list(rbind(
c(cx - side, cy - side),
c(cx + side, cy - side),
c(cx + side, cy + side),
c(cx - side, cy + side),
c(cx - side, cy - side)
)))
square_box <- st_sfc(square_poly, crs = st_crs(multnomah))
# crop data
or_cty_reg <- st_intersection(or_counties, square_box)
wa_cty_reg <- st_intersection(wa_counties, square_box)
portland  <- or_places |> filter(NAME == "Portland")
port_reg  <- st_intersection(portland, square_box)
vancouver <- wa_places |> filter(NAME == "Vancouver")
van_reg   <- st_intersection(vancouver, square_box)
selected_counties <- c(
"Yamhill","Columbia","Washington","Marion","Polk","Clackamas",
"Clark","Hood River","Wasco","Cowlitz","Skamania","Klickitat","Yakima"
)
# county labels
county_centroids <- bind_rows(or_cty_reg, wa_cty_reg) |>
filter(NAME %in% selected_counties) |>
st_centroid()
multnomah_centroid <- bind_rows(or_cty_reg, wa_cty_reg) |>
filter(NAME == "Multnomah") |>
st_centroid()
# City Labels
portland_centroid <- st_centroid(port_reg)
# --------------------------------------------------------
# 5. LOAD METRO CORPORATE BOUNDARY SHAPEFILE
# --------------------------------------------------------
metro <- st_read(metro_path) |> st_transform(3857)
metro_outline <- metro |>
st_make_valid() |>
st_union() |>
st_intersection(square_box) |>
st_boundary()
# ============================================================
# MAP 2 — CLOSE-UP WITH PORTLAND + VANCOUVER + METRO
# ============================================================
map2 <- ggplot() +
geom_sf(data = or_cty_reg, fill = "gray90", color = "white", size = 0.4) +
geom_sf(data = wa_cty_reg, fill = "gray85", color = "white", size = 0.4) +
geom_sf(data = multnomah, fill = "yellow", color = "black", size = 0.6) +
# Portland + Vancouver
geom_sf(data = port_reg, color = "#3182BD", fill = "#3182BD", size = 4) +
geom_sf(data = van_reg,  color = "#31A354", fill = "#31A354", size = 4) +
# Metro Boundary (official)
geom_sf(data = metro_outline, color = "#9E0168",
linetype = "dashed", linewidth = 0.9) +
# labels
geom_sf_text(data = county_centroids, aes(label = NAME), size = 3) +
geom_sf_text(
data = multnomah_centroid, aes(label = NAME),
nudge_x = 10000, nudge_y = -5000,
size = 4, fontface = "bold"
) +
geom_sf_text(
data = portland_centroid, aes(label = NAME),
nudge_x = 2000, nudge_y = -1000,
size = 3, fontface = "bold"
) +
geom_sf_text(
data = st_centroid(van_reg), aes(label = "Vancouver"),
size = 3, fontface = "bold"
) +
geom_sf_text(
data = st_centroid(metro_outline), aes(label = "METRO"),
color = "#9E0168",
size = 3, fontface = "bold"
) +
theme_void() +
coord_sf(expand = FALSE)
ggsave(filepath2, map2, width = 10, height = 8, dpi = 300)
# ============================================================
# COMBINED MAP — Overview with inset close-up
# ============================================================
# Use the square_box directly as the zoom rectangle (already an sfc object)
zoom_rect <- square_box
# Modified Map 1 with zoom rectangle indicator
map1_with_box <- ggplot() +
geom_sf(data = or_counties, fill = "gray92", color = "white", size = 0.3) +
geom_sf(data = wa_counties, fill = "gray88", color = "white", size = 0.3) +
geom_sf(data = multnomah, fill = "yellow", color = "black", size = 0.5) +
# Zoom area rectangle
geom_sf(data = zoom_rect, fill = NA, color = "red", linewidth = 1.2, linetype = "solid") +
# County labels (restored)
geom_sf_text(
data = or_counties |> filter(NAME == "Multnomah"),
aes(label = NAME),
nudge_y = -12000,
nudge_x =  40000,
size = 2.0,
fontface = "bold"
) +
geom_sf_text(data = or_counties |> filter(NAME != "Multnomah"), aes(label = NAME), size = 2.0) +
geom_sf_text(data = wa_counties, aes(label = NAME), size = 2.0) +
# State labels
geom_sf_text(
data = or_centroid, aes(label = "OREGON"),
nudge_y = -30000,
size = 6, fontface = "bold"
) +
geom_sf_text(
data = wa_centroid, aes(label = "WASHINGTON"),
size = 6, fontface = "bold"
) +
# City points
geom_sf(data = city_points, color = "red", size = 2) +
# City labels
geom_sf_text(
data = city_points |> filter(NAME == "Vancouver"),
aes(label = NAME),
nudge_y = 15000,
size = 2.4, fontface = "bold"
) +
geom_sf_text(
data = city_points |> filter(NAME != "Vancouver"),
aes(label = NAME),
nudge_y = -15000,
size = 2.4, fontface = "bold"
) +
theme_void() +
coord_sf(expand = FALSE)
# Modified Map 2 (inset) - with all labels restored
map2_inset <- ggplot() +
geom_sf(data = or_cty_reg, fill = "gray90", color = "white", size = 0.3) +
geom_sf(data = wa_cty_reg, fill = "gray85", color = "white", size = 0.3) +
geom_sf(data = multnomah, fill = "yellow", color = "black", size = 0.5) +
# Portland + Vancouver
geom_sf(data = port_reg, color = "#3182BD", fill = "#3182BD", alpha = 0.4) +
geom_sf(data = van_reg,  color = "#31A354", fill = "#31A354", alpha = 0.4) +
# Metro Boundary
geom_sf(data = metro_outline, color = "#9E0168",
linetype = "dashed", linewidth = 0.7) +
# County labels
geom_sf_text(data = county_centroids, aes(label = NAME), size = 2.5) +
geom_sf_text(
data = multnomah_centroid, aes(label = NAME),
nudge_x = 10000, nudge_y = -5000,
size = 3, fontface = "bold"
) +
# Portland label
geom_sf_text(
data = portland_centroid, aes(label = NAME),
nudge_x = 2000, nudge_y = -1000,
size = 2.5, fontface = "bold"
) +
# Vancouver label
geom_sf_text(
data = st_centroid(van_reg), aes(label = "Vancouver"),
size = 2.5, fontface = "bold"
) +
# Metro label
geom_sf_text(
data = st_centroid(metro_outline), aes(label = "METRO"),
color = "#9E0168",
size = 2.5, fontface = "bold"
) +
theme_void() +
theme(
panel.border = element_rect(color = "red", fill = NA, linewidth = 1.5),
plot.background = element_rect(fill = "white", color = NA)
) +
coord_sf(expand = FALSE)
# Combine using cowplot - main map with inset
# Inset position parameters
inset_x <- 0.55
inset_y <- 0.05
inset_w <- 0.43
inset_h <- 0.55
# Zoom box approximate position on main map (in 0-1 coordinates)
# These values position the lines at the right edge of the zoom rectangle
zoom_box_right <- 0.47
zoom_box_top <- 0.54
zoom_box_bottom <- 0.36
map_combined <- ggdraw() +
draw_plot(map1_with_box) +
draw_plot(map2_inset, x = inset_x, y = inset_y, width = inset_w, height = inset_h) +
# Connector lines: from zoom box corners to inset corners (dashed)
# Top-right corner of zoom box to top-left corner of inset
draw_line(
x = c(zoom_box_right, inset_x),
y = c(zoom_box_top, inset_y + inset_h),
color = "red", size = 0.6, linetype = "dashed"
) +
# Bottom-right corner of zoom box to bottom-left corner of inset
draw_line(
x = c(zoom_box_right, inset_x),
y = c(zoom_box_bottom, inset_y),
color = "red", size = 0.6, linetype = "dashed"
)
map_combined
ggsave(filepath_combined, map_combined, width = 14, height = 10, dpi = 300, bg = "white")
message("Saved: ", filepath_combined)
?draw_line
ggdraw() +
draw_line(
x = c(0.2, 0.7, 0.7, 0.3),
y = c(0.1, 0.3, 0.9, 0.8),
color = "blue", size = 2
)
map_combined <- ggdraw() +
draw_plot(map1_with_box) +
draw_plot(map2_inset, x = inset_x, y = inset_y, width = inset_w, height = inset_h) +
# Connector lines: from zoom box corners to inset corners (dashed)
# Top-right corner of zoom box to top-left corner of inset
draw_line(
x = c(zoom_box_right, inset_x),
y = c(zoom_box_top + inset_h, inset_y + inset_h),
color = "red", size = 0.6, linetype = "dashed"
) +
# Bottom-right corner of zoom box to bottom-left corner of inset
draw_line(
x = c(zoom_box_right, inset_x),
y = c(zoom_box_bottom, inset_y),
color = "red", size = 0.6, linetype = "dashed"
)
ggsave(filepath_combined, map_combined, width = 14, height = 10, dpi = 300, bg = "white")
message("Saved: ", filepath_combined)
# Zoom box approximate position on main map (in 0-1 coordinates)
# These values position the lines at the right edge of the zoom rectangle
zoom_box_right <- 0.47
zoom_box_top <- 0.56
zoom_box_bottom <- 0.38
map_combined <- ggdraw() +
draw_plot(map1_with_box) +
draw_plot(map2_inset, x = inset_x, y = inset_y, width = inset_w, height = inset_h) +
# Connector lines: from zoom box corners to inset corners (dashed)
# Top-right corner of zoom box to top-left corner of inset
draw_line(
x = c(zoom_box_right, inset_x),
y = c(zoom_box_top, inset_y + inset_h),
color = "red", size = 0.6, linetype = "dashed"
) +
# Bottom-right corner of zoom box to bottom-left corner of inset
draw_line(
x = c(zoom_box_right, inset_x),
y = c(zoom_box_bottom, inset_y),
color = "red", size = 0.6, linetype = "dashed"
)
ggsave(filepath_combined, map_combined, width = 14, height = 10, dpi = 300, bg = "white")
message("Saved: ", filepath_combined)
# Zoom box approximate position on main map (in 0-1 coordinates)
# These values position the lines at the right edge of the zoom rectangle
zoom_box_right <- 0.45
zoom_box_top <- 0.58
zoom_box_bottom <- 0.38
map_combined <- ggdraw() +
draw_plot(map1_with_box) +
draw_plot(map2_inset, x = inset_x, y = inset_y, width = inset_w, height = inset_h) +
# Connector lines: from zoom box corners to inset corners (dashed)
# Top-right corner of zoom box to top-left corner of inset
draw_line(
x = c(zoom_box_right, inset_x),
y = c(zoom_box_top, inset_y + inset_h),
color = "red", size = 0.6, linetype = "dashed"
) +
# Bottom-right corner of zoom box to bottom-left corner of inset
draw_line(
x = c(zoom_box_right, inset_x),
y = c(zoom_box_bottom, inset_y),
color = "red", size = 0.6, linetype = "dashed"
)
ggsave(filepath_combined, map_combined, width = 14, height = 10, dpi = 300, bg = "white")
message("Saved: ", filepath_combined)
# Zoom box approximate position on main map (in 0-1 coordinates)
# These values position the lines at the right edge of the zoom rectangle
zoom_box_right <- 0.45
zoom_box_top <- 0.59
zoom_box_bottom <- 0.38
map_combined <- ggdraw() +
draw_plot(map1_with_box) +
draw_plot(map2_inset, x = inset_x, y = inset_y, width = inset_w, height = inset_h) +
# Connector lines: from zoom box corners to inset corners (dashed)
# Top-right corner of zoom box to top-left corner of inset
draw_line(
x = c(zoom_box_right, inset_x),
y = c(zoom_box_top, inset_y + inset_h),
color = "red", size = 0.6, linetype = "dashed"
) +
# Bottom-right corner of zoom box to bottom-left corner of inset
draw_line(
x = c(zoom_box_right, inset_x + .01),
y = c(zoom_box_bottom, inset_y),
color = "red", size = 0.6, linetype = "dashed"
)
ggsave(filepath_combined, map_combined, width = 14, height = 10, dpi = 300, bg = "white")
message("Saved: ", filepath_combined)
# Zoom box approximate position on main map (in 0-1 coordinates)
# These values position the lines at the right edge of the zoom rectangle
zoom_box_right <- 0.45
zoom_box_top <- 0.595
zoom_box_bottom <- 0.38
map_combined <- ggdraw() +
draw_plot(map1_with_box) +
draw_plot(map2_inset, x = inset_x, y = inset_y, width = inset_w, height = inset_h) +
# Connector lines: from zoom box corners to inset corners (dashed)
# Top-right corner of zoom box to top-left corner of inset
draw_line(
x = c(zoom_box_right, inset_x + .01),
y = c(zoom_box_top, inset_y + inset_h),
color = "red", size = 0.6, linetype = "dashed"
) +
# Bottom-right corner of zoom box to bottom-left corner of inset
draw_line(
x = c(zoom_box_right, inset_x + .01),
y = c(zoom_box_bottom, inset_y),
color = "red", size = 0.6, linetype = "dashed"
)
ggsave(filepath_combined, map_combined, width = 14, height = 10, dpi = 300, bg = "white")
message("Saved: ", filepath_combined)
