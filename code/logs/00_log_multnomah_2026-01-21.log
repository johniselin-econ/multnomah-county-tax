-------------------------------------------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  C:/Users/ji252/Documents/GitHub/multnomah-county-tax/code/logs/00_log_multnomah_2026-01-21.log
  log type:  text
 opened on:  21 Jan 2026, 16:25:09

. 
. ** Set Seed 
. set seed 56403

. 
. ** Set scheme
. set scheme plotplainblind

. 
. ** Set parameters 
. local overwrite_csv = 0

. global start_year_acs = 2015

. global end_year_acs = 2024

. 
. ** CALL R CODE TO IMPORT IPUMS DATA 
. rcall script "${code}R/api_code.R", ///
>     args( project_root  <- "${dir}"; ///
>           dir_data_acs  <- "${data}acs"; ///
>           api_codes_path<- "${dir}api_codes.txt"; ///
>           start_year    <- ${start_year_acs}; ///
>           end_year      <- ${end_year_acs}; ///
>           overwrite_csv <- as.logical(`overwrite_csv'); ///
>     ) vanilla
Warning message:
 In read.table(file = file, header = header, sep = sep, quote = quote, dec = dec, fill = fill, comment.char = comment.char, ...) : incomplete final line foun
> d by readTableHeader on 'C:/Users/ji252/Documents/GitHub/multnomah-county-tax/api_codes.txt' 

. 
. ** CLEAN DATA (01)
. ** (a)  Demographic data via IPUMS NHGIS 
. **              - https://www.nhgis.org/
. ** (b)  Individual-level ACS data via IPUMS USA 
. **              - https://usa.ipums.org/usa/index.shtml
. ** (c)  County-level IRS migration via IRS SOI 
. **              - https://www.irs.gov/statistics/soi-tax-stats-migration-data
. ** (d) County-level IRS data via IRS SOI 
. **              - https://www.irs.gov/statistics/soi-tax-stats-county-data
. ** (e) NYTimes Covid-19 Cases and Deaths by county
. **              - https://github.com/nytimes/covid-19-data
. ** (f) County-level childcare cost data via DOL 
. **              - www.dol.gov/sites/dolgov/files/WB/NDCP2022.xlsx
. ** (g) County-level Unemployment data via BLS 
. **              - https://www.bls.gov/lau/
. do ${code}01_clean_data.do

. /*****************************************************************************
> * Program:                      01_clean_data.do 
> * Author(s):            John Iselin 
> * Date Updated:         October 19, 2025
> 
> **** Data that has been / will be automatically download
> 
> ** Demographic data via IPUMS NHGIS 
> ** Via https://www.nhgis.org/
> ** Downloaded on October 19, 2025
> ** EXTRACT DETAILS in "nhgis0031_ts_nominal_county_codebook"
> 
> ** Economic data via BEA Regional Economic Accounts (CAINC1)
> ** Via https://apps.bea.gov/regional/downloadzip.htm
> 
> ** ACS individual data via IPUMS USA 
> ** Via https://usa.ipums.org/usa/index.shtml
> ** Downloaded via R program 
> 
> ** IRS SOI County-Level Migration Files
> ** Via https://www.irs.gov/statistics/soi-tax-stats-migration-data
> 
> ** IRS SOI County-Level Files
> ** Via https://www.irs.gov/statistics/soi-tax-stats-county-data
> 
> ** NYTimes COVID Cases and Deaths 
> ** Via https://github.com/nytimes/covid-19-data
> 
> **** Data that must be manually downloaded
> 
> ** DOL Childcare Cost Data 
> ** Via www.dol.gov/sites/dolgov/files/WB/NDCP2022.xlsx
> 
> ** BLS Unemployment data 
> ** Via https://download.bls.gov/pub/time.series/la/la.data.64.County 
> 
> ** County Centroids (center of population)
> ** Via https://arc-gis-hub-home-arcgishub.hub.arcgis.com/datasets/myUTK::popcenterstate-us-csv/about
> 
> *******************************************************************************/
. 
. ** Start log file 
. capture log close log_01

. log using "${logs}01_log_data_clean_${pr_name}_${date}", replace text name(log_01)
(file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/code/logs/01_log_data_clean_multnomah_2026-01-21.log not found)
-------------------------------------------------------------------------------------------------------------------------------------------------------------
      name:  log_01
       log:  C:/Users/ji252/Documents/GitHub/multnomah-county-tax/code/logs/01_log_data_clean_multnomah_2026-01-21.log
  log type:  text
 opened on:  21 Jan 2026, 16:25:16

. 
. //--------------------------------------------------
. // STEP 0: Preliminary Set-Up 
. //--------------------------------------------------
. 
. ** Define labels 
. label define lb_move_type       0 "ERROR"                               ///
>                                                         1 "Non-movers"                  ///
>                                                         2 "All movers"                  ///
>                                                         3 "Domestic movers"             ///
>                                                         4 "Within-state movers" ///
>                                                         5 "Inter-state movers"  ///
>                                                         6 "Foreign movers", modify

.                                                         
. label define lb_agi             1 "Under $1"                    ///
>                                                         2 "$1 under $10K"               ///
>                                                         3 "$10K under $25K"             ///
>                                                         4 "$25K under $50K"             ///
>                                                         5 "$50K under $75K"             ///
>                                                         6 "$75K under $100K"    ///
>                                                         7 "$100K under $200K"   ///
>                                                         8 "$200K or more", modify                                                       

. 
. 
. ** Define Programs
. 
. ** Make FIPS code from state and county fips codes 
. capture program drop make_fips

. program define make_fips
  1.     syntax varlist(min=2 max=2 numeric), GEN(name)
  2. 
.     quietly {
  3.         tempvar s c
  4. 
.         local v1 : word 1 of `varlist'
  5.         local v2 : word 2 of `varlist'
  6. 
.         gen `s' = string(`v1', "%02.0f")
  7.         gen `c' = string(`v2', "%03.0f")
  8. 
.         gen `gen' = real(`s' + `c')
  9.     }
 10. end

. 
. ** Reclassify suppressed values as 0 
. 
. capture program drop unsuppress

. program define unsuppress
  1.     syntax varlist
  2. 
.     foreach v of varlist `varlist' {
  3.         replace `v' = 0 if `v' == -1
  4.     }
  5. end

. 
. 
. ** Create a gross-migration file via ACS 
. capture program drop acs_make_gross_migration

. program define acs_make_gross_migration
  1.     version 16.0
  2.     /*
>       Build county-year gross migration totals from ACS microdata with origin/destination counties.
> 
>       Outputs (wide):
>         persons_in_*, persons_out_*, persons_net_*
>         households_in_*, households_out_*, households_net_*
>         dollars_in_*, dollars_out_*, dollars_net_*
> 
>       Move-type indices (mirrors your IRS convention as closely as possible):
>         1 = Non-movers (same county)
>         2 = All movers (different county) = 4 + 5
>         3 = Domestic movers (same as 2 here; foreign already dropped upstream)
>         4 = Within-state movers (different county, same state)
>         5 = Inter-state movers (different state)
>     */
. 
.     syntax using/ [if] [in], SAVING(string) [REPLACE] ///
>         [ IDSFILE(string) ///
>           YEARVAR(name) ORIGFIPS(name) DESTFIPS(name) ///
>           PERSONWT(name) HHWT(name) HHPERWT(name) HEADVAR(name) INCOME(name) SAMPLE(string)]
  3. 
.     // Defaults consistent with your 01_clean_data.do
.     if "`idsfile'"  == "" local idsfile  "${data}working/ids"
  4.     if "`yearvar'"  == "" local yearvar  year
  5.     if "`origfips'" == "" local origfips fips_o
  6.     if "`destfips'" == "" local destfips fips_d
  7.         if "`personwt'" == "" local personwt perwt
  8.     if "`hhperwt'"  == "" local hhperwt  hh_perwt
  9.     if "`hhwt'"     == "" local hhwt     hhwt
 10.     if "`headvar'"  == "" local headvar  hh_head
 11.     if "`income'"   == "" local income   inctot
 12. 
.     // Load microdata (optionally subset via if/in)
.     use "`using'" `if' `in', clear
 13.         
.         if "`sample'" != "" keep if `sample'
 14. 
.     // Basic checks
.     foreach v in `yearvar' `origfips' `destfips' `personwt' `hhwt' `headvar' `income' {
 15.         capture confirm variable `v'
 16.         if _rc {
 17.             di as err "Required variable `v' not found in `using'."
 18.             exit 198
 19.         }
 20.     }
 21. 
.     // Keep only valid year/origin/destination
.     drop if missing(`yearvar') | missing(`origfips') | missing(`destfips')
 22. 
.     // Income: treat missing as 0 (keep negatives as reported)
.     replace `income' = 0 if missing(`income')
 23. 
.     // Build weighted components at the person level
.     gen double persons_wt = `hhperwt' if `headvar' == 1
 24.     gen double dollars_wt = `income' * `personwt'
 25.     gen double households_wt = `hhwt' if `headvar' == 1
 26.     replace households_wt = 0 if missing(households_wt)
 27. 
.     // Collapse to origin-destination-year flow first
.     keep `yearvar' `origfips' `destfips' persons_wt dollars_wt households_wt
 28.     collapse (sum) persons=persons_wt dollars=dollars_wt households=households_wt, ///
>         by(`yearvar' `origfips' `destfips')
 29. 
.     // Derive state/county components for mover-type logic
.     gen int state_o  = floor(`origfips'/1000)
 30.     gen int state_d  = floor(`destfips'/1000)
 31. 
.     gen byte same_county = (`origfips' == `destfips')
 32.     gen byte same_state  = (state_o == state_d)
 33.     gen byte within_state_mover = same_state & !same_county
 34.     gen byte inter_state_mover  = !same_state
 35. 
.     // -----------------------
.     // IN-MIGRATION (by destination county)
.     // -----------------------
.     preserve
 36.         gen long fips = `destfips'
 37.         gen int state_fips  = floor(fips/1000)
 38.         gen int county_fips = mod(fips, 1000)
 39. 
.         // type 1/4/5 components
.         foreach m in persons households dollars {
 40.             gen double `m'_1 = `m' if same_county
 41.             gen double `m'_4 = `m' if within_state_mover
 42.             gen double `m'_5 = `m' if inter_state_mover
 43.         }
 44. 
.         collapse (sum) persons_1 persons_4 persons_5 ///
>                        households_1 households_4 households_5 ///
>                        dollars_1 dollars_4 dollars_5, ///
>                 by(`yearvar' fips state_fips county_fips)
 45. 
.         // build 2 and 3
.         gen double persons_2    = persons_4 + persons_5
 46.         gen double persons_3    = persons_2
 47.         gen double households_2 = households_4 + households_5
 48.         gen double households_3 = households_2
 49.         gen double dollars_2    = dollars_4 + dollars_5
 50.         gen double dollars_3    = dollars_2
 51. 
.         // rename to *_in_*
.         foreach t in 1 2 3 4 5 {
 52.             rename persons_`t'    persons_in_`t'
 53.             rename households_`t' households_in_`t'
 54.             rename dollars_`t'    dollars_in_`t'
 55.         }
 56. 
.         tempfile __in
 57.         save `__in', replace
 58.     restore
 59. 
.     // -----------------------
.     // OUT-MIGRATION (by origin county)
.     // -----------------------
.     preserve
 60.         gen long fips = `origfips'
 61.         gen int state_fips  = floor(fips/1000)
 62.         gen int county_fips = mod(fips, 1000)
 63. 
.         foreach m in persons households dollars {
 64.             gen double `m'_1 = `m' if same_county
 65.             gen double `m'_4 = `m' if within_state_mover
 66.             gen double `m'_5 = `m' if inter_state_mover
 67.         }
 68. 
.         collapse (sum) persons_1 persons_4 persons_5 ///
>                        households_1 households_4 households_5 ///
>                        dollars_1 dollars_4 dollars_5, ///
>                 by(`yearvar' fips state_fips county_fips)
 69. 
.         gen double persons_2    = persons_4 + persons_5
 70.         gen double persons_3    = persons_2
 71.         gen double households_2 = households_4 + households_5
 72.         gen double households_3 = households_2
 73.         gen double dollars_2    = dollars_4 + dollars_5
 74.         gen double dollars_3    = dollars_2
 75. 
.         foreach t in 1 2 3 4 5 {
 76.             rename persons_`t'    persons_out_`t'
 77.             rename households_`t' households_out_`t'
 78.             rename dollars_`t'    dollars_out_`t'
 79.         }
 80. 
.         tempfile __out
 81.         save `__out', replace
 82.     restore
 83. 
.     // -----------------------
.     // Merge in/out; compute net
.     // -----------------------
.     use `__in', clear
 84.     merge 1:1 `yearvar' fips state_fips county_fips using `__out', nogen
 85. 
.     // Replace missings with 0 prior to net calcs (counties can be only in or only out)
.     foreach m in persons households dollars {
 86.         foreach t in 1 2 3 4 5 {
 87.             replace `m'_in_`t'  = 0 if missing(`m'_in_`t')
 88.             replace `m'_out_`t' = 0 if missing(`m'_out_`t')
 89.         }
 90.     }
 91. 
.     // Net = in - out (types 2/3/4/5 are the meaningful migration nets; 1 will be ~0 by construction)
.     foreach m in persons households dollars {
 92.         foreach t in 2 3 4 5 {
 93.             gen double `m'_net_`t' = `m'_in_`t' - `m'_out_`t'
 94.         }
 95.     }
 96. 
.     // Merge names
.     merge m:1 state_fips county_fips using "`idsfile'", keep(master match) nogen
 97. 
.     // Labels
.     label var fips "County FIPS (state*1000 + county)"
 98.     label var state_fips "State FIPS"
 99.     label var county_fips "County FIPS"
100. 
.     label var persons_in_2  "Persons, in-migration, all movers"
101.     label var persons_out_2 "Persons, out-migration, all movers"
102.     label var persons_net_2 "Persons, net migration, all movers"
103. 
.     label var households_in_2  "Households, in-migration, all movers (HH heads)"
104.     label var households_out_2 "Households, out-migration, all movers (HH heads)"
105.     label var households_net_2 "Households, net migration, all movers (HH heads)"
106. 
.     label var dollars_in_2  "Dollars, in-migration, all movers (INCTOT*PERWT)"
107.     label var dollars_out_2 "Dollars, out-migration, all movers (INCTOT*PERWT)"
108.     label var dollars_net_2 "Dollars, net migration, all movers (INCTOT*PERWT)"
109. 
.     order `yearvar' fips state_fips county_fips state_name county_name, first
110.     sort `yearvar' state_fips county_fips
111.     compress
112. 
.     // Save
.     save "`saving'", `replace'
113.         clear
114.         
. end

. 
. ********************************************************************************
. ** STEP 1: Download and check non-IPUMS data 
. ********************************************************************************
. 
. ** Ensure expected directory structure exists
. capture mkdir "${data}"

. capture mkdir "${data}working"

. capture mkdir "${data}demographic"

. capture mkdir "${data}demographic/CAINC1"

. capture mkdir "${data}demographic/nhgis0031_csv"

. capture mkdir "${data}demographic/dol"

. capture mkdir "${data}demographic/bls"

. capture mkdir "${data}irs"

. capture mkdir "${data}covid"

. 
. ** This block downloads public-use source data directly from official URLs if 
. ** not present locally.
. /*
> Automated downloads included:
>   - IRS SOI county-to-county migration: countyinflowYYZZ.csv / countyoutflowYYZZ.csv
>   - IRS SOI county data: YYincyallagi.csv
>   - BEA Regional Economic Accounts (CAINC1): CAINC1.zip (unzips to CAINC1__ALL_AREAS_*.csv and related files)
> */
. 
. * ----------------------------
. * IRS SOI: migration files
. * ----------------------------
. local irs_base "https://www.irs.gov/pub/irs-soi"

. 
. forvalues yy = 15/21 {
  2.     local zz = `yy' + 1
  3.     local fn_out "countyoutflow`yy'`zz'.csv"
  4.     local fn_in  "countyinflow`yy'`zz'.csv"
  5. 
.     capture confirm file "${data}irs/`fn_out'"
  6.     if _rc {
  7.         di as txt "Downloading (IRS SOI) `fn_out' ..."
  8.         copy "`irs_base'/`fn_out'" "${data}irs/`fn_out'", replace
  9.     }
 10. 
.     capture confirm file "${data}irs/`fn_in'"
 11.     if _rc {
 12.         di as txt "Downloading (IRS SOI) `fn_in' ..."
 13.         copy "`irs_base'/`fn_in'" "${data}irs/`fn_in'", replace
 14.     }
 15. }

. 
. * ----------------------------
. * IRS SOI: county income (AGI) files
. * ----------------------------
. forvalues yy = 15/22 {
  2.     local fn_inc "`yy'incyallagi.csv"
  3. 
.     capture confirm file "${data}irs/`fn_inc'"
  4.     if _rc {
  5.         di as txt "Downloading (IRS SOI) `fn_inc' ..."
  6.         copy "`irs_base'/`fn_inc'" "${data}irs/`fn_inc'", replace
  7.     }
  8. }

. 
. * ----------------------------
. * BEA Regional: CAINC1.zip
. * ----------------------------
. local bea_dir "${data}demographic/CAINC1"

. local bea_url "https://apps.bea.gov/regional/zip/CAINC1.zip"

. local bea_zip "`bea_dir'/CAINC1.zip"

. 
. * If we don't already have a CAINC1 "_ALL_AREAS" file, download + unzip the ZIP.
. local bea_files : dir "`bea_dir'" files "CAINC1__ALL_AREAS_*.csv"

. if "`bea_files'"=="" {
.     local bea_files : dir "`bea_dir'" files "CAINC1__ALL_STATES_*.csv"
. }

. 
. if "`bea_files'"=="" {
.     di as txt "Downloading (BEA) CAINC1.zip ..."
Downloading (BEA) CAINC1.zip ...
.     copy "`bea_url'" "`bea_zip'", replace
(file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/demographic/CAINC1/CAINC1.zip not found)
. 
.     local curdir "`c(pwd)'"
.     cd "`bea_dir'"
C:\Users\ji252\Documents\GitHub\multnomah-county-tax\data\demographic\CAINC1
.     unzipfile "CAINC1.zip", replace
    inflating: CAINC1__ALL_AREAS_1969_2023.csv
    inflating: CAINC1__definition.xml
    inflating: CAINC1__Footnotes.html
    inflating: CAINC1_AK_1969_2023.csv
    inflating: CAINC1_AL_1969_2023.csv
    inflating: CAINC1_AR_1969_2023.csv
    inflating: CAINC1_AZ_1969_2023.csv
    inflating: CAINC1_CA_1969_2023.csv
    inflating: CAINC1_CO_1969_2023.csv
    inflating: CAINC1_CSA_1969_2023.csv
    inflating: CAINC1_CT_1969_2023.csv
    inflating: CAINC1_DC_1969_2023.csv
    inflating: CAINC1_DE_1969_2023.csv
    inflating: CAINC1_FL_1969_2023.csv
    inflating: CAINC1_GA_1969_2023.csv
    inflating: CAINC1_HI_1969_2023.csv
    inflating: CAINC1_IA_1969_2023.csv
    inflating: CAINC1_ID_1969_2023.csv
    inflating: CAINC1_IL_1969_2023.csv
    inflating: CAINC1_IN_1969_2023.csv
    inflating: CAINC1_KS_1969_2023.csv
    inflating: CAINC1_KY_1969_2023.csv
    inflating: CAINC1_LA_1969_2023.csv
    inflating: CAINC1_MA_1969_2023.csv
    inflating: CAINC1_MD_1969_2023.csv
    inflating: CAINC1_MDIV_1969_2023.csv
    inflating: CAINC1_ME_1969_2023.csv
    inflating: CAINC1_MI_1969_2023.csv
    inflating: CAINC1_MIC_1969_2023.csv
    inflating: CAINC1_MN_1969_2023.csv
    inflating: CAINC1_MO_1969_2023.csv
    inflating: CAINC1_MS_1969_2023.csv
    inflating: CAINC1_MSA_1969_2023.csv
    inflating: CAINC1_MT_1969_2023.csv
    inflating: CAINC1_NC_1969_2023.csv
    inflating: CAINC1_ND_1969_2023.csv
    inflating: CAINC1_NE_1969_2023.csv
    inflating: CAINC1_NH_1969_2023.csv
    inflating: CAINC1_NJ_1969_2023.csv
    inflating: CAINC1_NM_1969_2023.csv
    inflating: CAINC1_NV_1969_2023.csv
    inflating: CAINC1_NY_1969_2023.csv
    inflating: CAINC1_OH_1969_2023.csv
    inflating: CAINC1_OK_1969_2023.csv
    inflating: CAINC1_OR_1969_2023.csv
    inflating: CAINC1_PA_1969_2023.csv
    inflating: CAINC1_PORT_1969_2023.csv
    inflating: CAINC1_RI_1969_2023.csv
    inflating: CAINC1_SC_1969_2023.csv
    inflating: CAINC1_SD_1969_2023.csv
    inflating: CAINC1_TN_1969_2023.csv
    inflating: CAINC1_TX_1969_2023.csv
    inflating: CAINC1_US_1969_2023.csv
    inflating: CAINC1_UT_1969_2023.csv
    inflating: CAINC1_VA_1969_2023.csv
    inflating: CAINC1_VT_1969_2023.csv
    inflating: CAINC1_WA_1969_2023.csv
    inflating: CAINC1_WI_1969_2023.csv
    inflating: CAINC1_WV_1969_2023.csv
    inflating: CAINC1_WY_1969_2023.csv

successfully unzipped CAINC1.zip to current directory
total processed:  60
        skipped:  0
      extracted:  60
.     cd "`curdir'"
C:\Users\ji252\Documents\GitHub\multnomah-county-tax
. 
.     capture erase "`bea_zip'"
. }

. 
. * ----------------------------
. * NYTimes COVID Data 
. * ----------------------------
. local covid_dir "${data}covid"

. local covid_url "https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-counties.csv"

. 
. * If we don't already have a COVID file, download.
. local covid_file : dir "`covid_dir'" files "covid_nyt.csv"

. if "`covid_file'"=="" {
.     local covid_file : dir "`covid_dir'" files "covid_nyt.csv"
. }

. 
. if "`covid_file'"=="" {
.     di as txt "Downloading (COVID)  ..."
Downloading (COVID)  ...
.     copy "`covid_url'" "`covid_dir'/covid_nyt.csv", replace
. }

. 
. ** This block checks that non-automatically downloaded data are present: 
. /*
> Non-automtated downloads included:
>   - DOL childcare data (through 2022)
>   - BLS unemployment data 
> */
. 
. ** Define paths 
. local dol_dir "${data}demographic/dol/NDCP2022.xlsx"

. local bls_dir "${data}demographic/bls/la.data.64.County" 

. 
. capture confirm file `dol_dir' // Check if the file exists

. 
. if _rc != 0 {
.     display "Error: The file `dol_dir' was not found."
.     display "Execution of the do-file is stopping."
.     exit // Stops the do-file/program
. }

. 
. capture confirm file `bls_dir' // Check if the file exists

. 
. if _rc != 0 {
.     display "Error: The file `bls_dir' was not found."
.     display "Execution of the do-file is stopping."
.     exit // Stops the do-file/program
. }

. 
. 
. 
. ********************************************************************************
. ** STEP 2: Clean demographic + economic data via IPUMS, BLS, and BEA 
. ********************************************************************************
. 
. ** Import data 
. import delimited        ///
>         "${data}demographic/nhgis0031_csv/nhgis0031_ts_nominal_county.csv", clear 
(encoding automatically selected: ISO-8859-1)
(15 vars, 54,673 obs)

. 
. ** Describe data 
. des 

Contains data
 Observations:        54,673                  
    Variables:            15                  
-------------------------------------------------------------------------------------------------------------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable label
-------------------------------------------------------------------------------------------------------------------------------------------------------------
gisjoin         str8    %9s                   GISJOIN
year            str9    %9s                   YEAR
state           str20   %20s                  STATE
statefp         byte    %8.0g                 STATEFP
statenh         int     %8.0g                 STATENH
county          str46   %46s                  COUNTY
countyfp        int     %8.0g                 COUNTYFP
countynh        int     %8.0g                 COUNTYNH
name            str59   %59s                  NAME
av0aa           long    %12.0g                AV0AA
d15aa           long    %12.0g                D15AA
d15ab           long    %12.0g                D15AB
b79aa           long    %12.0g                B79AA
av0aam          long    %12.0g                AV0AAM
b79aam          long    %8.0g                 B79AAM
-------------------------------------------------------------------------------------------------------------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.

. 
. ** Drop unnecc variables 
. drop gisjoin statenh countynh name 

. 
. ** Rename 
. rename state state_name 

. rename statefp state_fips 

. rename county county_name 

. rename countyfp county_fips 

. rename av0aa population 

. rename d15aa pop_urban 

. rename d15ab pop_rural 

. rename b79aa median_income 

. rename av0aam population_margin

. rename b79aam median_income_margin 

. 
. ** Create urban percent 
. gen percent_urban = pop_urban / population
(45,090 missing values generated)

. 
. ** Label variables 
. label var state_name "State name"

. label var state_fips "State FIPS code"

. label var county_name "County name"

. label var county_fips "County FIPS code"

. label var population "Population count"

. label var pop_rural "Rural population count"

. label var pop_urban "Urban population count"

. label var percent_urban "Percent of population in urban areas"

. label var median_income "Median household income (prior year)"

. label var population_margin "ACS margin for error: population"

. label var median_income_margin "ACS margin for error: median income"

. 
. ** Save as temporary file 
. tempfile demo

. save `demo'
file C:\Users\ji252\AppData\Local\Temp\ST_8758_000001.tmp saved as .dta format

. 
. ** Create three datasets 
. 
. ** (1) Basic state and county IDs 
. keep if year == "2020" 
(51,452 observations deleted)

. keep state* county* 

. 
. ** Make FIPS 
. make_fips state_fips county_fips, gen(fips)

. 
. ** Save as state and county Ids 
. save "${data}working/ids", replace 
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/ids.dta saved

. 
. ** Save state IDS 
. keep state_fips state_name 

. duplicates drop 

Duplicates in terms of all variables

(3,169 observations deleted)

. 
. ** Save as state and county Ids 
. save "${data}working/state_ids", replace 
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/state_ids.dta saved

. 
. clear  

. 
. ** (2) Population data 
. use `demo'

. keep if !missing(pop_urban) 
(45,090 observations deleted)

. tab year 

       YEAR |      Freq.     Percent        Cum.
------------+-----------------------------------
       2000 |      3,141       32.78       32.78
       2010 |      3,221       33.61       66.39
       2020 |      3,221       33.61      100.00
------------+-----------------------------------
      Total |      9,583      100.00

. 
. ** Keep 2020 
. keep if year == "2020"
(6,362 observations deleted)

. drop year median_income* population_margin

. 
. ** Make FIPS 
. make_fips state_fips county_fips, gen(fips)

. 
. ** Save data
. save "${data}working/population_2020", replace 
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/population_2020.dta saved

. clear  

. 
. ** (3) 2015-2019 ACS data 
. use `demo'

. keep if !missing(median_income) 
(6,447 observations deleted)

. tab year 

       YEAR |      Freq.     Percent        Cum.
------------+-----------------------------------
       2000 |      3,141        6.51        6.51
  2006-2010 |      3,221        6.68       13.19
  2007-2011 |      3,221        6.68       19.87
  2008-2012 |      3,221        6.68       26.55
  2009-2013 |      3,221        6.68       33.23
  2010-2014 |      3,220        6.68       39.91
  2011-2015 |      3,219        6.67       46.58
  2012-2016 |      3,220        6.68       53.26
  2013-2017 |      3,220        6.68       59.93
  2014-2018 |      3,219        6.67       66.61
  2015-2019 |      3,220        6.68       73.29
  2016-2020 |      3,220        6.68       79.96
  2017-2021 |      3,220        6.68       86.64
  2018-2022 |      3,221        6.68       93.32
  2019-2023 |      3,222        6.68      100.00
------------+-----------------------------------
      Total |     48,226      100.00

. 
. ** Keep 2020 
. keep if year == "2015-2019"
(45,006 observations deleted)

. drop year pop_rural pop_urban percent_urban

. 
. ** Make FIPS 
. make_fips state_fips county_fips, gen(fips)

. 
. ** Save data
. save "${data}working/acs_2015_2019_data", replace 
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/acs_2015_2019_data.dta saved

. 
. ** Rename for merge 
. rename population population_acs

. 
. ** Merge with other data 
. merge 1:1 state_fips county_fips using "${data}working/population_2020",                ///
>         keep(match) nogen 

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                             3,219  
    -----------------------------------------

. 
. ** Save data
. save "${data}working/demographics_2020", replace 
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/demographics_2020.dta saved

. 
. ** Load BEA Data 
. import delimited "${data}demographic/CAINC1/CAINC1__ALL_AREAS_1969_2023.csv",   ///
>         clear 
(encoding automatically selected: ISO-8859-1)
(63 vars, 9,604 obs)

. 
. ** Drop unnecc variables 
. drop region tablename industryclassification unit geoname 

. 
. ** Drop empty cells 
. drop if missing(linecode)
(4 observations deleted)

. 
. ** Update names 
. rename geofips fips 

. replace fips = subinstr(fips, `"""', "", .)
(9,600 real changes made)

. destring fips, replace 
fips: all characters numeric; replaced as long

. 
. ** Keep population and per-capita income, dropping personal income (total)
. tab description linecode

                      |             LineCode
          Description |         1          2          3 |     Total
----------------------+---------------------------------+----------
Per capita personal.. |         0          0      3,200 |     3,200 
Personal income (th.. |     3,200          0          0 |     3,200 
Population (persons.. |         0      3,200          0 |     3,200 
----------------------+---------------------------------+----------
                Total |     3,200      3,200      3,200 |     9,600 

. drop if linecode == 1   
(3,200 observations deleted)

. drop description

.         
. ** Get V* to be in terms of years 
. ** V9 == 1969 
. forvalues i = 9/63 {
  2.         
.         local j = 1960 + `i'
  3.         rename v`i' value`j'
  4.         
. } // END I LOOP 

. 
. ** Reshape 
. reshape long value, i(fips linecode) j(year)
(j = 1969 1970 1971 1972 1973 1974 1975 1976 1977 1978 1979 1980 1981 1982 1983 1984 1985 1986 1987 1988 1989 1990 1991 1992 1993 1994 1995 1996 1997 1998 19
> 99 2000 2001 2002 2003 2004 2005 2006 2007 2008 2009 2010 2011 2012 2013 2014 2015 2016 2017 2018 2019 2020 2021 2022 2023)

Data                               Wide   ->   Long
-----------------------------------------------------------------------------
Number of observations            6,400   ->   352,000     
Number of variables                  57   ->   4           
j variable (55 values)                    ->   year
xij variables:
      value1969 value1970 ... value2023   ->   value
-----------------------------------------------------------------------------

. reshape wide value, i(fips year ) j(linecode)
(j = 2 3)

Data                               Long   ->   Wide
-----------------------------------------------------------------------------
Number of observations          352,000   ->   176,000     
Number of variables                   4   ->   4           
j variable (2 values)          linecode   ->   (dropped)
xij variables:
                                  value   ->   value2 value3
-----------------------------------------------------------------------------

. 
. ** Keep years 
. keep if inrange(year, 2015, ${end_year_acs})
(147,200 observations deleted)

. 
. ** Rename values 
. rename value2 population 

. rename value3 per_capita_income

. 
. ** Drop if missing values 
. drop if population == "(NA)"
(239 observations deleted)

. 
. ** Keep only counties with all observations 
. bysort fips: gen ct = _N 

. tab ct

         ct |      Freq.     Percent        Cum.
------------+-----------------------------------
          4 |          8        0.03        0.03
          5 |          5        0.02        0.05
          9 |     28,548       99.95      100.00
------------+-----------------------------------
      Total |     28,561      100.00

. keep if ct == 9
(13 observations deleted)

. drop ct

. 
. ** Destring 
. destring population, replace 
population: all characters numeric; replaced as long

. destring per_capita_income, replace 
per_capita_income: all characters numeric; replaced as long

. 
. ** Extrapolate through 2024 
. expand 2 if year == 2023, gen(tag)
(3,172 observations created)

. replace year = 2024 if tag == 1 
(3,172 real changes made)

. replace population = . if tag == 1 
(3,172 real changes made, 3,172 to missing)

. replace per_capita_income = . if tag == 1 
(3,172 real changes made, 3,172 to missing)

. 
. ** Get list of all counties 
. qui levelsof fips, local(fips)

. 
. ** Loop over variables
. foreach v of varlist population per_capita_income {
  2.         
.         ** Loop over all FIPS 
.     foreach c of local fips {
  3.                 
.                 quietly{
  4.                         
.                         regress `v' year if fips == `c' & tag != 1 
  5.                         predict `v'_hat
  6.                         replace `v' = `v'_hat if fips == `c' & year == 2024
  7.                         drop `v'_hat
  8.                         
.                 } // END QUIET
  9.     } // END FIPS LOOP 
 10. } // END VAR LOOP 
--Break--
r(1);

end of do-file
--Break--
r(1);

end of do-file

--Break--
r(1);

. clear

. exit
