----------------------------------------------------------------------------------------------------------------------------------------
      name:  log_02rev
       log:  C:/Users/ji252/Documents/GitHub/multnomah-county-tax/code/logs/02_log_revenue_2026-02-08.log
  log type:  text
 opened on:   8 Feb 2026, 21:19:01

. 
. ** Parameters
. scalar effect_agi = 0.02                        // 2% net out-migration effect on AGI

. scalar effect_agi_oregon = 0.02         // Oregon-level effect

. local  n_sims = 1000                            // Monte Carlo iterations

. local  cpi_2019_to_2022 = 1.136 // CPI-U inflation factor 2019→2022

. 
. ** PFA tax brackets (2022)
. local pfa_thresh1_single = 125000

. local pfa_thresh2_single = 250000

. local pfa_thresh1_joint  = 200000

. local pfa_thresh2_joint  = 400000

. local pfa_rate = 0.015

. 
. ** Create output directory
. capture mkdir "${results}revenue"

. 
. ********************************************************************************
. ** SECTION 0B: SDID Estimation of Migration Effects
. ********************************************************************************
. 
. dis ""


. dis "=============================================="
==============================================

. dis "Section 0B: SDID estimation of migration effects"
Section 0B: SDID estimation of migration effects

. dis "=============================================="
==============================================

. 
. ** Check if SDID panel data exists
. capture confirm file "${data}working/sdid_analysis_data.dta"

. if _rc == 0 {
. 
.         ** Save current data state
.         preserve
. 
.         ** Load SDID panel data
.         use "${data}working/sdid_analysis_data.dta", clear
. 
.         ** ---- Run 1: effect_agi (county-level, domestic type 3) ----
.         dis "Running SDID for effect_agi (agi_net_rate_irs)..."
Running SDID for effect_agi (agi_net_rate_irs)...
.         capture noisily sdid agi_net_rate_irs fips year Treated ///
>                 if irs_sample_1 == 1 & sample_all == 1 & year != 2020, ///
>                 vce(noinference)  ///
>                 covariates(population per_capita_income, projected)


Synthetic Difference-in-Differences Estimator

-----------------------------------------------------------------------------
agi_net_ra~5 |     ATT     Std. Err.     t      P>|t|    [95% Conf. Interval]
-------------+---------------------------------------------------------------
     Treated |  -2.31123          .        .        .           .           .
-----------------------------------------------------------------------------
95% CIs and p-values are based on large-sample approximations.
Refer to Arkhangelsky et al., (2021) for theoretical derivations.
. 
.         if _rc == 0 {
.                 ** Extract ATT from e(ATT) — tau is in percentage points
.                 scalar tau_agi = e(ATT)
.                 scalar effect_agi = abs(tau_agi) / 100
.                 dis "  SDID effect_agi: tau = " %8.4f tau_agi " pp -> effect = " %8.4f effect_agi
  SDID effect_agi: tau =  -2.3112 pp -> effect =   0.0231
.         }
.         else {
.                 dis "  SDID for effect_agi failed, using default: " %8.4f effect_agi
.         }
. 
.         ** ---- Run 2: effect_agi_oregon (state-level, interstate type 5) ----
.         dis "Running SDID for effect_agi_oregon (agi_net_rate_irs5)..."
Running SDID for effect_agi_oregon (agi_net_rate_irs5)...
.         capture noisily sdid agi_net_rate_irs5 fips year Treated ///
>                 if irs_sample_1 == 1 & sample_all == 1 & year != 2020, ///
>                 vce(noinference)  ///
>                 covariates(population per_capita_income, projected)


Synthetic Difference-in-Differences Estimator

-----------------------------------------------------------------------------
agi_net_ra~5 |     ATT     Std. Err.     t      P>|t|    [95% Conf. Interval]
-------------+---------------------------------------------------------------
     Treated |  -2.31123          .        .        .           .           .
-----------------------------------------------------------------------------
95% CIs and p-values are based on large-sample approximations.
Refer to Arkhangelsky et al., (2021) for theoretical derivations.
. 
.         if _rc == 0 {
.                 scalar tau_agi_oregon = e(ATT)
.                 scalar effect_agi_oregon = abs(tau_agi_oregon) / 100
.                 dis "  SDID effect_agi_oregon: tau = " %8.4f tau_agi_oregon " pp -> effect = " %8.4f effect_agi_oregon
  SDID effect_agi_oregon: tau =  -2.3112 pp -> effect =   0.0231
.         }
.         else {
.                 dis "  SDID for effect_agi_oregon failed, using default: " %8.4f effect_agi_oregon
.         }
. 
.         ** Restore original data state
.         restore
. }

. else {
.         dis "  SDID panel data not found. Using default effects."
. }

. 
. dis "  Final parameters:"
  Final parameters:

. dis "    effect_agi         = " %8.4f effect_agi
    effect_agi         =   0.0231

. dis "    effect_agi_oregon  = " %8.4f effect_agi_oregon
    effect_agi_oregon  =   0.0231

. 
. ********************************************************************************
. ** SECTION 1: Load 2019 ACS Microdata for Multnomah County
. ********************************************************************************
. 
. dis ""


. dis "=============================================="
==============================================

. dis "Section 1: Load ACS 2019 microdata"
Section 1: Load ACS 2019 microdata

. dis "=============================================="
==============================================

. 
. import delimited "${data}acs/acs_2019.csv", clear
(encoding automatically selected: ISO-8859-1)
(68 vars, 3,087,291 obs)

. 
. ** Filter to Multnomah County, Oregon
. keep if statefip == 41 & countyfip == 51
(3,079,935 observations deleted)

. 
. ** Drop group quarters
. drop if gq > 2
(0 observations deleted)

. 
. ** Keep ages 18+ (tax-filing-relevant population)
. keep if age >= 18
(1,283 observations deleted)

. 
. ** Handle top-coded / missing income
. foreach v of varlist inctot incwage incbus00 incinvst incearn {
  2.         replace `v' = . if `v' == 9999999
  3. }
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)

. 
. ** Create household ID
. gen double hh_id = serial

. 
. ** Summarize
. dis "ACS 2019 Multnomah County observations (18+, non-GQ): " _N
ACS 2019 Multnomah County observations (18+, non-GQ): 6073

. 
. ********************************************************************************
. ** SECTION 2: Create Tax Units
. ********************************************************************************
. 
. dis ""


. dis "=============================================="
==============================================

. dis "Section 2: Create tax units"
Section 2: Create tax units

. dis "=============================================="
==============================================

. 
. ** -------------------------------------------------------------------------
. ** (a) Link married couples via SPLOC
. ** -------------------------------------------------------------------------
. 
. gen unit_id = pernum

. replace unit_id = sploc if marst == 1 & sploc != 0 & pernum > sploc
(1,463 real changes made)

. label var unit_id "Unique ID for tax units"

. 
. ** Count of individuals per tax unit
. bysort hh_id unit_id: gen byte unit_ct = _N

. 
. ** -------------------------------------------------------------------------
. ** (b) Filing status
. ** -------------------------------------------------------------------------
. 
. gen byte married = inlist(marst, 1, 2)          // married, spouse present or absent

. gen byte mfs = (marst == 3 & sploc == 0)        // married filing separately

. 
. gen byte filing_status = 1                                      // single (default)

. replace filing_status = 2 if married == 1       // MFJ
(3,002 real changes made)

. replace filing_status = 6 if mfs == 1           // MFS
(58 real changes made)

. label var filing_status "Filing status (1=single, 2=MFJ, 6=MFS)"

. 
. ** -------------------------------------------------------------------------
. ** (c) Dependents (simplified — use NCHILD, capped at 3)
. ** -------------------------------------------------------------------------
. 
. gen byte depx = min(nchild, 3)

. label var depx "Dependent exemptions (capped at 3)"

. 
. ** -------------------------------------------------------------------------
. ** (d) Income variable construction (at tax-unit level)
. ** -------------------------------------------------------------------------
. 
. ** Nominal income variables
. gen double incwage_nom = max(incwage, 0)

. gen double incse_nom = incearn - incwage                        // self-employment

. gen double incinvst_nom = incinvst                                      // investment (can be negative)

. gen double inctot_nom = inctot

. gen double incwel_nom = 0

. replace incwel_nom = incwelfr if !missing(incwelfr) & incwelfr != 999999
(105 real changes made)

. 
. ** Subtract untaxed welfare income from total income (floor at 0)
. replace inctot_nom = max(inctot_nom - incwel_nom, 0)
(112 real changes made)

. 
. ** Tax-unit aggregation
. foreach v in inctot incwage incse incinvst {
  2.         replace `v'_nom = 0 if `v'_nom == .  
  3.         bysort hh_id unit_id: egen double `v'_tax = total(`v'_nom)
  4. }
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)

. 
. ** -------------------------------------------------------------------------
. ** (e) Primary filer flag
. ** -------------------------------------------------------------------------
. 
. gen byte primary_filer = (unit_id == pernum)

. label var primary_filer "Primary filer in tax unit"

. 
. ** -------------------------------------------------------------------------
. ** (f) Compute tax-unit AGI proxy
. ** -------------------------------------------------------------------------
. 
. gen double agi_proxy = inctot_tax

. label var agi_proxy "Tax-unit AGI proxy (total income)"

. 
. ** Summary
. dis "Number of tax units: "
Number of tax units: 

. count if primary_filer == 1
  4,610

. 
. ********************************************************************************
. ** SECTION 3: Load IRS County Data for Raking Targets
. ********************************************************************************
. 
. dis ""


. dis "=============================================="
==============================================

. dis "Section 3: Load IRS county data for raking"
Section 3: Load IRS county data for raking

. dis "=============================================="
==============================================

. 
. ** Save ACS data
. tempfile acs_data

. save `acs_data'
file C:\Users\ji252\AppData\Local\Temp\ST_87c8_000002.tmp saved as .dta format

. 
. ** Import 2019 IRS county data
. import delimited "${data}irs/19incyallagi.csv", clear
(encoding automatically selected: ISO-8859-1)
(153 vars, 25,544 obs)

. 
. ** Keep Multnomah County
. keep if statefips == 41 & countyfips == 51
(25,536 observations deleted)

. 
. ** Rename variables (following 01_clean_data.do pattern)
. rename n1 irs_n1

. rename mars2 irs_mars2

. rename a00100 irs_agi

. rename a00200 irs_wages

. rename n04470 irs_n_itemizers

. rename a04470 irs_itemded

. 
. ** Rescale (IRS reports in thousands)
. replace irs_agi = irs_agi * 1000
variable irs_agi was long now double
(8 real changes made)

. replace irs_wages = irs_wages * 1000
variable irs_wages was long now double
(8 real changes made)

. replace irs_itemded = irs_itemded * 1000
(7 real changes made)

. 
. ** Keep relevant variables
. keep agi_stub irs_n1 irs_mars2 irs_agi irs_wages irs_n_itemizers irs_itemded

. 
. ** Drop the "all" stub (agi_stub == 0) for bracket-level calibration
. drop if agi_stub == 0
(0 observations deleted)

. 
. ** Label AGI stubs
. label define lb_agi_stub 1 "Under $1" 2 "$1-$10k" 3 "$10k-$25k" ///
>         4 "$25k-$50k" 5 "$50k-$75k" 6 "$75k-$100k" 7 "$100k-$200k" 8 "$200k+"

. label values agi_stub lb_agi_stub

. 
. ** Display IRS targets
. list agi_stub irs_n1 irs_mars2 irs_agi irs_wages, sep(0)

     +------------------------------------------------------------+
     |    agi_stub   irs_n1   irs_ma~2       irs_agi    irs_wages |
     |------------------------------------------------------------|
  1. |    Under $1     5720       1010    -372789000     40370000 |
  2. |     $1-$10k    43390       2400     222375000    184827000 |
  3. |   $10k-$25k    70700       6270    1236475000    964786000 |
  4. |   $25k-$50k   108430      14630    3958982000   3375398000 |
  5. |   $50k-$75k    63220      17090    3883894000   3134364000 |
  6. |  $75k-$100k    40180      17640    3478623000   2681153000 |
  7. | $100k-$200k    61240      40820    8391132000   6224996000 |
  8. |      $200k+    26910      21730   1.24020e+10   6929984000 |
     +------------------------------------------------------------+

. 
. ** Save as tempfile
. tempfile irs_targets

. save `irs_targets'
file C:\Users\ji252\AppData\Local\Temp\ST_87c8_000003.tmp saved as .dta format

. 
. ********************************************************************************
. ** SECTION 4: Raking / Calibration
. ********************************************************************************
. 
. dis ""


. dis "=============================================="
==============================================

. dis "Section 4: Raking / calibration"
Section 4: Raking / calibration

. dis "=============================================="
==============================================

. 
. ** Reload ACS data
. use `acs_data', clear

. 
. ** -------------------------------------------------------------------------
. ** (a) Create AGI brackets matching IRS stubs
. ** -------------------------------------------------------------------------
. 
. gen byte agi_stub = .
(6,073 missing values generated)

. replace agi_stub = 1 if agi_proxy < 1
(186 real changes made)

. replace agi_stub = 2 if agi_proxy >= 1     & agi_proxy < 10000
(449 real changes made)

. replace agi_stub = 3 if agi_proxy >= 10000 & agi_proxy < 25000
(764 real changes made)

. replace agi_stub = 4 if agi_proxy >= 25000 & agi_proxy < 50000
(1,185 real changes made)

. replace agi_stub = 5 if agi_proxy >= 50000 & agi_proxy < 75000
(895 real changes made)

. replace agi_stub = 6 if agi_proxy >= 75000 & agi_proxy < 100000
(633 real changes made)

. replace agi_stub = 7 if agi_proxy >= 100000 & agi_proxy < 200000
(1,350 real changes made)

. replace agi_stub = 8 if agi_proxy >= 200000
(611 real changes made)

. 
. label values agi_stub lb_agi_stub

. 
. ** -------------------------------------------------------------------------
. ** (b) IPF raking (calibrate weights to IRS margins)
. ** -------------------------------------------------------------------------
. 
. ** Keep only primary filers for calibration
. keep if primary_filer == 1
(1,463 observations deleted)

. 
. ** Merge IRS targets
. merge m:1 agi_stub using `irs_targets', keep(master match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                             4,610  
    -----------------------------------------

. 
. ** IPF raking via ipfraking — calibrate weights to match IRS return
. ** counts (N1) and MFJ counts (MARS2) by AGI bracket
. 
. ** Create 16-cell interaction variable: stub × MFJ
. gen byte is_mfj = (filing_status == 2)

. gen byte stub_mfj = (agi_stub - 1) * 2 + is_mfj + 1

. label var stub_mfj "AGI stub x MFJ cell (1-16)"

. 
. svyset [pw = perwt]

Sampling weights: perwt
             VCE: linearized
     Single unit: missing
        Strata 1: <one>
 Sampling unit 1: <observations>
           FPC 1: <zero>

. 
. ** Build target matrix: 1 × 16, cells = stub(1-8) × MFJ(0,1)
. ** Odd columns = non-MFJ (N1 - MARS2), even columns = MFJ (MARS2)
. matrix rake_cells = J(1, 16, 0)

. forvalues s = 1/8 {
  2.         qui sum irs_n1 if agi_stub == `s', meanonly
  3.         local n1 = r(mean)
  4.         qui sum irs_mars2 if agi_stub == `s', meanonly
  5.         local mars2 = r(mean)
  6.         local col_nonmfj = (`s' - 1) * 2 + 1
  7.         local col_mfj    = (`s' - 1) * 2 + 2
  8.         matrix rake_cells[1, `col_nonmfj'] = `n1' - `mars2'
  9.         matrix rake_cells[1, `col_mfj']    = `mars2'
 10. }

. matrix colnames rake_cells = 1.stub_mfj 2.stub_mfj 3.stub_mfj 4.stub_mfj ///
>         5.stub_mfj 6.stub_mfj 7.stub_mfj 8.stub_mfj ///
>         9.stub_mfj 10.stub_mfj 11.stub_mfj 12.stub_mfj ///
>         13.stub_mfj 14.stub_mfj 15.stub_mfj 16.stub_mfj

. 
. ** Rake weights
. ipfraking [pw = perwt], ctotal(rake_cells) generate(cal_wt)

variable _ corresponding to the control matrix rake_cells not found
r(111);

end of do-file

r(111);

. help ipfraking

. do "C:\Users\ji252\AppData\Local\Temp\STD87c8_
> 000003.tmp"

. sort agi_stub

. bysort agi_stub: gen ct = _n 

. gen tmp1 = irs_n1 if ct == 1 
(4,602 missing values generated)

. gen tmp2 = irs_mars2 if ct == 1 
(4,602 missing values generated)

. svy: total tmp1, over(agi_stub, nolab)
(running total on estimation sample)

Survey: Total estimation

Number of strata = 1                        Numb
> er of obs                                     
>             =   8
Number of PSUs   = 8                        Popu
> lation size                                   
>             = 716
                                            Desi
> gn df                                         
>             =   7

------------------------------------------------
> -----------------
                |             Linearized
                |      Total   std. err.     [95
> % con                                         
>      f. interval]
----------------+-------------------------------
> -----------------
c.tmp1@agi_stub |
      Under $1  |     411840     411840     -562
> 006.9                                         
>           1385687
       $1-$10k  |    2560010    2560010      -34
> 93452                                         
>           8613472
     $10k-$25k  |    4807600    4807600      -65
> 60568                                         
>          1.62e+07
     $25k-$50k  |   1.66e+07   1.66e+07     -2.2
> 6e+07                                         
>          5.58e+07
     $50k-$75k  |   1.26e+07   1.26e+07     -1.7
> 2e+07                                         
>          4.23e+07
    $75k-$100k  |    2290260    2290260      -31
> 25344                                         
>           7705864
   $100k-$200k  |    3735640    3735640      -50
> 97745                                         
>          1.26e+07
        $200k+  |    1264770    1264770      -17
> 25936                                         
>           4255476
------------------------------------------------
> -----------------

. matrix total_n1 = e(b)

. matrix rownames total_n1 = agi_stub

. svy: total tmp2, over(agi_stub, nolab)
(running total on estimation sample)

Survey: Total estimation

Number of strata = 1                        Numb
> er of obs                                     
>             =   8
Number of PSUs   = 8                        Popu
> lation size                                   
>             = 716
                                            Desi
> gn df                                         
>             =   7

------------------------------------------------
> -----------------
                |             Linearized
                |      Total   std. err.     [95
> % con                                         
>      f. interval]
----------------+-------------------------------
> -----------------
c.tmp2@agi_stub |
      Under $1  |      72720      72720     -992
> 35.48                                         
>          244675.5
       $1-$10k  |     141600     141600     -193
> 230.8                                         
>          476430.8
     $10k-$25k  |     426360     426360     -581
> 821.2                                         
>           1434541
     $25k-$50k  |    2238390    2238390      -30
> 54561                                         
>           7531341
     $50k-$75k  |    3400910    3400910      -46
> 40964                                         
>          1.14e+07
    $75k-$100k  |    1005480    1005480      -13
> 72102                                         
>           3383062
   $100k-$200k  |    2490020    2490020      -33
> 97942                                         
>           8377982
        $200k+  |    1021310    1021310      -13
> 93704                                         
>           3436324
------------------------------------------------
> -----------------

. matrix total_mars2 = e(b)

. matrix rownames total_mars2 = agi_stub  

. 
. ** Rake weights
. ipfraking [pw = perwt], ctotal(total_n1 total_
> mars2) generate(cal_wt)

variable _ corresponding to the control matrix t
> otal_n1 not found
r(111);

end of do-file

r(111);

. do "C:\Users\ji252\AppData\Local\Temp\STD87c8_000004.tmp"

. version 14: svy: total tmp1, over(agi_stub, nolab)
(running total on estimation sample)

Survey: Total estimation

Number of strata = 1                     Number of obs   =   8
Number of PSUs   = 8                     Population size = 716
                                         Design df       =   7

            1: agi_stub = 1
            2: agi_stub = 2
            3: agi_stub = 3
            4: agi_stub = 4
            5: agi_stub = 5
            6: agi_stub = 6
            7: agi_stub = 7
            8: agi_stub = 8

--------------------------------------------------------------
             |             Linearized
        Over |      Total   std. err.     [95% conf. interval]
-------------+------------------------------------------------
tmp1         |
           1 |     411840     411840     -562006.9     1385687
           2 |    2560010    2560010      -3493452     8613472
           3 |    4807600    4807600      -6560568    1.62e+07
           4 |   1.66e+07   1.66e+07     -2.26e+07    5.58e+07
           5 |   1.26e+07   1.26e+07     -1.72e+07    4.23e+07
           6 |    2290260    2290260      -3125344     7705864
           7 |    3735640    3735640      -5097745    1.26e+07
           8 |    1264770    1264770      -1725936     4255476
--------------------------------------------------------------

. matrix total_n1 = e(b)

. matrix rownames total_n1 = agi_stub

. version 14: svy: total tmp2, over(agi_stub, nolab)
(running total on estimation sample)

Survey: Total estimation

Number of strata = 1                     Number of obs   =   8
Number of PSUs   = 8                     Population size = 716
                                         Design df       =   7

            1: agi_stub = 1
            2: agi_stub = 2
            3: agi_stub = 3
            4: agi_stub = 4
            5: agi_stub = 5
            6: agi_stub = 6
            7: agi_stub = 7
            8: agi_stub = 8

--------------------------------------------------------------
             |             Linearized
        Over |      Total   std. err.     [95% conf. interval]
-------------+------------------------------------------------
tmp2         |
           1 |      72720      72720     -99235.48    244675.5
           2 |     141600     141600     -193230.8    476430.8
           3 |     426360     426360     -581821.2     1434541
           4 |    2238390    2238390      -3054561     7531341
           5 |    3400910    3400910      -4640964    1.14e+07
           6 |    1005480    1005480      -1372102     3383062
           7 |    2490020    2490020      -3397942     8377982
           8 |    1021310    1021310      -1393704     3436324
--------------------------------------------------------------

. matrix total_mars2 = e(b)

. matrix rownames total_mars2 = agi_stub  

. 
. ** Rake weights
. ipfraking [pw = perwt], ctotal(total_n1 total_mars2) generate(cal_wt)

Warning: the totals of the control matrices are different:
   Target 1 (total_n1) total                 =             44240690
   Target 2 (total_mars2) total              =             10796790

 Iteration 1, max rel difference of raked weights = 0
The worst relative discrepancy of       0 is observed for agi_stub == 8           
Target value =    1021310; achieved value =    1021310

   Summary of the weight changes

              |    Mean    Std. dev.    Min        Max       CV
--------------+-------------------------------------------------- 
Orig weights  |      110      85.84         9        1283   .7801
Raked weights |      110      85.84         9        1283   .7801
Adjust factor |   1.0000               1.0000      1.0000

. label var cal_wt "Calibrated weight (IPF raked to IRS)"

. 
end of do-file

. summ perwt cal_wt

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
       perwt |      4,610    110.0449    85.84089          9       1283
      cal_wt |      4,610    110.0449    85.84089          9       1283

. clear

. exit
