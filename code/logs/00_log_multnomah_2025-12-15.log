------------------------------------------------------
      name:  <unnamed>
       log:  C:/Users/ji252/Documents/GitHub/multnomah
> -county-tax/code/logs/00_log_multnomah_2025-12-15.lo
> g
  log type:  text
 opened on:  15 Dec 2025, 15:46:16

. 
. ** Set Seed 
. set seed 56403

. 
. ** Set scheme
. set scheme plotplainblind

. 
. ** Set parameters 
. local overwrite_csv = 0

. global start_year_acs = 2015

. global end_year_acs = 2023

. 
. ** CALL R CODE TO IMPORT IPUMS DATA 
. rcall script "${code}api_code.R", ///
>     args( project_root  <- "${dir}"; ///
>           dir_data_acs  <- "${data}acs"; ///
>           api_codes_path<- "${dir}api_codes.txt"; //
> /
>           start_year    <- ${start_year_acs}; ///
>           end_year      <- ${end_year_acs}; ///
>           overwrite_csv <- as.logical(`overwrite_csv
> '); ///
>     ) vanilla
Warning message:
 In read.table(file = file, header = header, sep = sep
> , quote = quote, dec = dec, fill = fill, comment.cha
> r = comment.char, ...) : incomplete final line found
>  by readTableHeader on 'C:/Users/ji252/Documents/Git
> Hub/multnomah-county-tax/api_codes.txt' 

. 
. ** CLEAN DATA (01)
. ** (a)  Demographic data via IPUMS NHGIS 
. **              - https://www.nhgis.org/
. ** (b)  Individual-level ACS data via IPUMS USA 
. **              - https://usa.ipums.org/usa/index.sh
> tml
. ** (c)  County-level IRS migration via IRS SOI 
. **              - https://www.irs.gov/statistics/soi
> -tax-stats-migration-data
. ** (d) County-level IRS data via IRS SOI 
. **              - https://www.irs.gov/statistics/soi
> -tax-stats-county-data
. ** (e) NYTimes Covid-19 Cases and Deaths by county
. **              - https://github.com/nytimes/covid-1
> 9-data
. do ${code}01_clean_data.do

. /***************************************************
> **************************
> * Program:                      01_clean_data.do 
> * Author(s):            John Iselin 
> * Date Updated:         October 19, 2025
> 
> *** Demographic data via IPUMS NHGIS 
> ** Via https://www.nhgis.org/
> ** Downloaded on October 19, 2025
> ** EXTRACT DETAILS in "nhgis0031_ts_nominal_county_c
> odebook"
> 
> *** Economic data via BEA Regional Economic Accounts
>  (CAINC1)
> ** Via https://apps.bea.gov/regional/downloadzip.htm
> 
> *** ACS individual data via IPUMS USA 
> ** Via https://usa.ipums.org/usa/index.shtml
> ** Downloaded via R program 
> 
> *** IRS SOI County-Level Migration Files
> ** Via https://www.irs.gov/statistics/soi-tax-stats-
> migration-data
> 
> *** IRS SOI County-Level Files
> ** Via https://www.irs.gov/statistics/soi-tax-stats-
> county-data
> 
> *** NYTimes COVID Cases and Deaths 
> ** Via https://github.com/nytimes/covid-19-data
> 
> ****************************************************
> ***************************/
. 
. ** Start log file 
. capture log close log_01

. log using "${logs}01_log_data_clean_${pr_name}_${dat
> e}", replace text name(log_01)
------------------------------------------------------
      name:  log_01
       log:  C:/Users/ji252/Documents/GitHub/multnomah
> -county-tax/code/logs/01_log_data_clean_multnomah_20
> 25-12-15.log
  log type:  text
 opened on:  15 Dec 2025, 15:46:23

. 
. //--------------------------------------------------
. // STEP 0: Preliminary Set-Up 
. //--------------------------------------------------
. 
. ** Define labels 
. label define lb_move_type       0 "ERROR"           
>                     ///
>                                                     
>     1 "Non-movers"                  ///
>                                                     
>     2 "All movers"                  ///
>                                                     
>     3 "Domestic movers"             ///
>                                                     
>     4 "Within-state movers" ///
>                                                     
>     5 "Inter-state movers"  ///
>                                                     
>     6 "Foreign movers", modify

.                                                     
>     
. label define lb_agi             1 "Under $1"        
>             ///
>                                                     
>     2 "$1 under $10K"               ///
>                                                     
>     3 "$10K under $25K"             ///
>                                                     
>     4 "$25K under $50K"             ///
>                                                     
>     5 "$50K under $75K"             ///
>                                                     
>     6 "$75K under $100K"    ///
>                                                     
>     7 "$100K under $200K"   ///
>                                                     
>     8 "$200K or more", modify                       
>                                 

. 
. 
. ** Define Programs
. 
. ** Make FIPS code from state and county fips codes 
. capture program drop make_fips

. program define make_fips
  1.     syntax varlist(min=2 max=2 numeric), GEN(name
> )
  2. 
.     quietly {
  3.         tempvar s c
  4. 
.         local v1 : word 1 of `varlist'
  5.         local v2 : word 2 of `varlist'
  6. 
.         gen `s' = string(`v1', "%02.0f")
  7.         gen `c' = string(`v2', "%03.0f")
  8. 
.         gen `gen' = real(`s' + `c')
  9.     }
 10. end

. 
. ** Reclassify suppressed values as 0 
. 
. capture program drop unsuppress

. program define unsuppress
  1.     syntax varlist
  2. 
.     foreach v of varlist `varlist' {
  3.         replace `v' = 0 if `v' == -1
  4.     }
  5. end

. 
. //--------------------------------------------------
. // STEP -1: Acquire raw data (automated where possib
> le)
. //--------------------------------------------------
. /*
> This block downloads public-use source data directly
>  from official URLs if not present locally.
> 
> Automated downloads included:
>   - IRS SOI county-to-county migration: countyinflow
> YYZZ.csv / countyoutflowYYZZ.csv
>   - IRS SOI county data: YYincyallagi.csv
>   - BEA Regional Economic Accounts (CAINC1): CAINC1.
> zip (unzips to CAINC1__ALL_AREAS_*.csv and related f
> iles)
> 
> */
. 
. * Ensure expected directory structure exists
. capture mkdir "${data}"

. capture mkdir "${data}working"

. capture mkdir "${data}demographic"

. capture mkdir "${data}demographic/CAINC1"

. capture mkdir "${data}demographic/nhgis0031_csv"

. capture mkdir "${data}irs"

. capture mkdir "${data}covid"

. 
. * ----------------------------
. * IRS SOI: migration files
. * ----------------------------
. local irs_base "https://www.irs.gov/pub/irs-soi"

. 
. forvalues yy = 15/21 {
  2.     local zz = `yy' + 1
  3.     local fn_out "countyoutflow`yy'`zz'.csv"
  4.     local fn_in  "countyinflow`yy'`zz'.csv"
  5. 
.     capture confirm file "${data}irs/`fn_out'"
  6.     if _rc {
  7.         di as txt "Downloading (IRS SOI) `fn_out'
>  ..."
  8.         copy "`irs_base'/`fn_out'" "${data}irs/`f
> n_out'", replace
  9.     }
 10. 
.     capture confirm file "${data}irs/`fn_in'"
 11.     if _rc {
 12.         di as txt "Downloading (IRS SOI) `fn_in' 
> ..."
 13.         copy "`irs_base'/`fn_in'" "${data}irs/`fn
> _in'", replace
 14.     }
 15. }

. 
. * ----------------------------
. * IRS SOI: county income (AGI) files
. * ----------------------------
. forvalues yy = 15/22 {
  2.     local fn_inc "`yy'incyallagi.csv"
  3. 
.     capture confirm file "${data}irs/`fn_inc'"
  4.     if _rc {
  5.         di as txt "Downloading (IRS SOI) `fn_inc'
>  ..."
  6.         copy "`irs_base'/`fn_inc'" "${data}irs/`f
> n_inc'", replace
  7.     }
  8. }

. 
. * ----------------------------
. * BEA Regional: CAINC1.zip
. * ----------------------------
. local bea_dir "${data}demographic/CAINC1"

. local bea_url "https://apps.bea.gov/regional/zip/CAI
> NC1.zip"

. local bea_zip "`bea_dir'/CAINC1.zip"

. 
. * If we don't already have a CAINC1 "_ALL_AREAS" fil
> e, download + unzip the ZIP.
. local bea_files : dir "`bea_dir'" files "CAINC1__ALL
> _AREAS_*.csv"

. if "`bea_files'"=="" {
.     local bea_files : dir "`bea_dir'" files "CAINC1_
> _ALL_STATES_*.csv"
. }

. 
. if "`bea_files'"=="" {
.     di as txt "Downloading (BEA) CAINC1.zip ..."
Downloading (BEA) CAINC1.zip ...
.     copy "`bea_url'" "`bea_zip'", replace
(file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/demographic/CAINC1/CAINC1.zip not
    found)
. 
.     local curdir "`c(pwd)'"
.     cd "`bea_dir'"
C:\Users\ji252\Documents\GitHub\multnomah-county-tax\d
> ata\demographic\CAINC1
.     unzipfile "CAINC1.zip", replace
    inflating: CAINC1__ALL_AREAS_1969_2023.csv
    inflating: CAINC1__definition.xml
    inflating: CAINC1__Footnotes.html
    inflating: CAINC1_AK_1969_2023.csv
    inflating: CAINC1_AL_1969_2023.csv
    inflating: CAINC1_AR_1969_2023.csv
    inflating: CAINC1_AZ_1969_2023.csv
    inflating: CAINC1_CA_1969_2023.csv
    inflating: CAINC1_CO_1969_2023.csv
    inflating: CAINC1_CSA_1969_2023.csv
    inflating: CAINC1_CT_1969_2023.csv
    inflating: CAINC1_DC_1969_2023.csv
    inflating: CAINC1_DE_1969_2023.csv
    inflating: CAINC1_FL_1969_2023.csv
    inflating: CAINC1_GA_1969_2023.csv
    inflating: CAINC1_HI_1969_2023.csv
    inflating: CAINC1_IA_1969_2023.csv
    inflating: CAINC1_ID_1969_2023.csv
    inflating: CAINC1_IL_1969_2023.csv
    inflating: CAINC1_IN_1969_2023.csv
    inflating: CAINC1_KS_1969_2023.csv
    inflating: CAINC1_KY_1969_2023.csv
    inflating: CAINC1_LA_1969_2023.csv
    inflating: CAINC1_MA_1969_2023.csv
    inflating: CAINC1_MD_1969_2023.csv
    inflating: CAINC1_MDIV_1969_2023.csv
    inflating: CAINC1_ME_1969_2023.csv
    inflating: CAINC1_MI_1969_2023.csv
    inflating: CAINC1_MIC_1969_2023.csv
    inflating: CAINC1_MN_1969_2023.csv
    inflating: CAINC1_MO_1969_2023.csv
    inflating: CAINC1_MS_1969_2023.csv
    inflating: CAINC1_MSA_1969_2023.csv
    inflating: CAINC1_MT_1969_2023.csv
    inflating: CAINC1_NC_1969_2023.csv
    inflating: CAINC1_ND_1969_2023.csv
    inflating: CAINC1_NE_1969_2023.csv
    inflating: CAINC1_NH_1969_2023.csv
    inflating: CAINC1_NJ_1969_2023.csv
    inflating: CAINC1_NM_1969_2023.csv
    inflating: CAINC1_NV_1969_2023.csv
    inflating: CAINC1_NY_1969_2023.csv
    inflating: CAINC1_OH_1969_2023.csv
    inflating: CAINC1_OK_1969_2023.csv
    inflating: CAINC1_OR_1969_2023.csv
    inflating: CAINC1_PA_1969_2023.csv
    inflating: CAINC1_PORT_1969_2023.csv
    inflating: CAINC1_RI_1969_2023.csv
    inflating: CAINC1_SC_1969_2023.csv
    inflating: CAINC1_SD_1969_2023.csv
    inflating: CAINC1_TN_1969_2023.csv
    inflating: CAINC1_TX_1969_2023.csv
    inflating: CAINC1_US_1969_2023.csv
    inflating: CAINC1_UT_1969_2023.csv
    inflating: CAINC1_VA_1969_2023.csv
    inflating: CAINC1_VT_1969_2023.csv
    inflating: CAINC1_WA_1969_2023.csv
    inflating: CAINC1_WI_1969_2023.csv
    inflating: CAINC1_WV_1969_2023.csv
    inflating: CAINC1_WY_1969_2023.csv

successfully unzipped CAINC1.zip to current directory
total processed:  60
        skipped:  0
      extracted:  60
.     cd "`curdir'"
C:\Users\ji252\Documents\GitHub\multnomah-county-tax
. 
.     capture erase "`bea_zip'"
. }

. 
. * ----------------------------
. * NYTimes COVID Data 
. * ----------------------------
. local covid_dir "${data}covid"

. local covid_url "https://raw.githubusercontent.com/n
> ytimes/covid-19-data/master/us-counties.csv"

. 
. * If we don't already have a COVID file, download.
. local covid_file : dir "`covid_dir'" files "covid_ny
> t.csv"

. if "`covid_file'"=="" {
.     local covid_file : dir "`covid_dir'" files "covi
> d_nyt.csv"
. }

. 
. if "`covid_file'"=="" {
.     di as txt "Downloading (COVID)  ..."
Downloading (COVID)  ...
.     copy "`covid_url'" "`covid_dir'/covid_nyt.csv", 
> replace
. }

. 
. 
. 
. //--------------------------------------------------
> ---------
. // STEP 1: Import and Clean Demographic Data via IPU
> MS + BEA  
. //--------------------------------------------------
> ---------
. 
. ** Import data 
. import delimited        ///
>         "${data}demographic/nhgis0031_csv/nhgis0031_
> ts_nominal_county.csv", clear 
(encoding automatically selected: ISO-8859-1)
(15 vars, 54,673 obs)

. 
. ** Describe data 
. des 

Contains data
 Observations:        54,673                  
    Variables:            15                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
gisjoin         str8    %9s                   GISJOIN
year            str9    %9s                   YEAR
state           str20   %20s                  STATE
statefp         byte    %8.0g                 STATEFP
statenh         int     %8.0g                 STATENH
county          str46   %46s                  COUNTY
countyfp        int     %8.0g                 COUNTYFP
countynh        int     %8.0g                 COUNTYNH
name            str59   %59s                  NAME
av0aa           long    %12.0g                AV0AA
d15aa           long    %12.0g                D15AA
d15ab           long    %12.0g                D15AB
b79aa           long    %12.0g                B79AA
av0aam          long    %12.0g                AV0AAM
b79aam          long    %8.0g                 B79AAM
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.

. 
. ** Drop unnecc variables 
. drop gisjoin statenh countynh name 

. 
. ** Rename 
. rename state state_name 

. rename statefp state_fips 

. rename county county_name 

. rename countyfp county_fips 

. rename av0aa population 

. rename d15aa pop_urban 

. rename d15ab pop_rural 

. rename b79aa median_income 

. rename av0aam population_margin

. rename b79aam median_income_margin 

. 
. ** Create urban percent 
. gen percent_urban = pop_urban / population
(45,090 missing values generated)

. 
. ** Label variables 
. label var state_name "State name"

. label var state_fips "State FIPS code"

. label var county_name "County name"

. label var county_fips "County FIPS code"

. label var population "Population count"

. label var pop_rural "Rural population count"

. label var pop_urban "Urban population count"

. label var percent_urban "Percent of population in ur
> ban areas"

. label var median_income "Median household income (pr
> ior year)"

. label var population_margin "ACS margin for error: p
> opulation"

. label var median_income_margin "ACS margin for error
> : median income"

. 
. ** Save as temporary file 
. tempfile demo

. save `demo'
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000001
    > .tmp saved as .dta format

. 
. ** Create three datasets 
. 
. ** (1) Basic state and county IDs 
. keep if year == "2020" 
(51,452 observations deleted)

. keep state* county* 

. 
. ** Make FIPS 
. make_fips state_fips county_fips, gen(fips)

. 
. ** Save as state and county Ids 
. save "${data}working/ids", replace 
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/ids.dta saved

. clear  

. 
. ** (2) Population data 
. use `demo'

. keep if !missing(pop_urban) 
(45,090 observations deleted)

. tab year 

       YEAR |      Freq.     Percent        Cum.
------------+-----------------------------------
       2000 |      3,141       32.78       32.78
       2010 |      3,221       33.61       66.39
       2020 |      3,221       33.61      100.00
------------+-----------------------------------
      Total |      9,583      100.00

. 
. ** Keep 2020 
. keep if year == "2020"
(6,362 observations deleted)

. drop year median_income* population_margin

. 
. ** Make FIPS 
. make_fips state_fips county_fips, gen(fips)

. 
. ** Save data
. save "${data}working/population_2020", replace 
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/population_2020.dta saved

. clear  

. 
. ** (3) 2015-2019 ACS data 
. use `demo'

. keep if !missing(median_income) 
(6,447 observations deleted)

. tab year 

       YEAR |      Freq.     Percent        Cum.
------------+-----------------------------------
       2000 |      3,141        6.51        6.51
  2006-2010 |      3,221        6.68       13.19
  2007-2011 |      3,221        6.68       19.87
  2008-2012 |      3,221        6.68       26.55
  2009-2013 |      3,221        6.68       33.23
  2010-2014 |      3,220        6.68       39.91
  2011-2015 |      3,219        6.67       46.58
  2012-2016 |      3,220        6.68       53.26
  2013-2017 |      3,220        6.68       59.93
  2014-2018 |      3,219        6.67       66.61
  2015-2019 |      3,220        6.68       73.29
  2016-2020 |      3,220        6.68       79.96
  2017-2021 |      3,220        6.68       86.64
  2018-2022 |      3,221        6.68       93.32
  2019-2023 |      3,222        6.68      100.00
------------+-----------------------------------
      Total |     48,226      100.00

. 
. ** Keep 2020 
. keep if year == "2015-2019"
(45,006 observations deleted)

. drop year pop_rural pop_urban percent_urban

. 
. ** Make FIPS 
. make_fips state_fips county_fips, gen(fips)

. 
. ** Save data
. save "${data}working/acs_2015_2019_data", replace 
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/acs_2015_2019_data.dta saved

. 
. ** Rename for merge 
. rename population population_acs

. 
. ** Merge with other data 
. merge 1:1 state_fips county_fips using "${data}worki
> ng/population_2020",                ///
>         keep(match) nogen 

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                             3,219  
    -----------------------------------------

. 
. ** Save data
. save "${data}working/demographics_2020", replace 
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/demographics_2020.dta saved

. 
. ** Load BEA Data 
. import delimited "${data}demographic/CAINC1/CAINC1__
> ALL_AREAS_1969_2023.csv",   ///
>         clear 
(encoding automatically selected: ISO-8859-1)
(63 vars, 9,604 obs)

. 
. ** Drop unnecc variables 
. drop region tablename industryclassification unit ge
> oname 

. 
. ** Drop empty cells 
. drop if missing(linecode)
(4 observations deleted)

. 
. ** Update names 
. rename geofips fips 

. replace fips = subinstr(fips, `"""', "", .)
(9,600 real changes made)

. destring fips, replace 
fips: all characters numeric; replaced as long

. 
. ** Keep population and per-capita income, dropping p
> ersonal income (total)
. tab description linecode

                      |  LineCode
          Description |         1 |     Total
----------------------+-----------+----------
Per capita personal.. |         0 |     3,200 
Personal income (th.. |     3,200 |     3,200 
Population (persons.. |         0 |     3,200 
----------------------+-----------+----------
                Total |     3,200 |     9,600 


                      |  LineCode
          Description |         2 |     Total
----------------------+-----------+----------
Per capita personal.. |         0 |     3,200 
Personal income (th.. |         0 |     3,200 
Population (persons.. |     3,200 |     3,200 
----------------------+-----------+----------
                Total |     3,200 |     9,600 


                      |  LineCode
          Description |         3 |     Total
----------------------+-----------+----------
Per capita personal.. |     3,200 |     3,200 
Personal income (th.. |         0 |     3,200 
Population (persons.. |         0 |     3,200 
----------------------+-----------+----------
                Total |     3,200 |     9,600 

. drop if linecode == 1   
(3,200 observations deleted)

. drop description

.         
. ** Get V* to be in terms of years 
. ** V9 == 1969 
. forvalues i = 9/63 {
  2.         
.         local j = 1960 + `i'
  3.         rename v`i' value`j'
  4.         
. } // END I LOOP 

. 
. ** Reshape 
. reshape long value, i(fips linecode) j(year)
(j = 1969 1970 1971 1972 1973 1974 1975 1976 1977 1978
>  1979 1980 1981 1982 1983 1984 1985 1986 1987 1988 1
> 989 1990 1991 1992 1993 1994 1995 1996 1997 1998 199
> 9 2000 2001 2002 2003 2004 2005 2006 2007 2008 2009 
> 2010 2011 2012 2013 2014 2015 2016 2017 2018 2019 20
> 20 2021 2022 2023)

Data                               Wide   ->   Long
------------------------------------------------------
> -----------------------
Number of observations            6,400   ->   352,000
>      
Number of variables                  57   ->   4      
>      
j variable (55 values)                    ->   year
xij variables:
      value1969 value1970 ... value2023   ->   value
------------------------------------------------------
> -----------------------

. reshape wide value, i(fips year ) j(linecode)
(j = 2 3)

Data                               Long   ->   Wide
------------------------------------------------------
> -----------------------
Number of observations          352,000   ->   176,000
>      
Number of variables                   4   ->   4      
>      
j variable (2 values)          linecode   ->   (droppe
> d)
xij variables:
                                  value   ->   value2 
> value3
------------------------------------------------------
> -----------------------

. 
. ** Keep years 
. keep if inrange(year, 2015, 2023)
(147,200 observations deleted)

. 
. ** Rename values 
. rename value2 population 

. rename value3 per_capita_income

. 
. ** Drop if missing values 
. drop if population == "(NA)"
(239 observations deleted)

. 
. ** Keep only counties with all observations 
. bysort fips: gen ct = _N 

. tab ct

         ct |      Freq.     Percent        Cum.
------------+-----------------------------------
          4 |          8        0.03        0.03
          5 |          5        0.02        0.05
          9 |     28,548       99.95      100.00
------------+-----------------------------------
      Total |     28,561      100.00

. keep if ct == 9
(13 observations deleted)

. drop ct

. 
. ** Destring 
. destring population, replace 
population: all characters numeric; replaced as long

. destring per_capita_income, replace 
per_capita_income: all characters numeric; replaced as
>  long

. 
. ** Save data
. save "${data}working/bea_economics", replace 
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/bea_economics.dta saved

. 
. //--------------------------------------------------
> --
. // STEP 2: Import and Clean NYTimes COVID-19 Data 
. //--------------------------------------------------
> --
.  
. ** Import data 
. import delimited using "${data}covid/covid_nyt.csv",
>  varnames(1) clear case(lower) 
(encoding automatically selected: ISO-8859-1)
(6 vars, 2,502,832 obs)

. 
. ** Describe data 
. des 

Contains data
 Observations:     2,502,832                  
    Variables:             6                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
date            str10   %10s                  
county          str35   %35s                  
state           str24   %24s                  
fips            long    %12.0g                
cases           long    %12.0g                
deaths          long    %8.0g                 
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.

. 
. ** Set up date information 
. generate num_date = date(date, "YMD")

. format num_date %td

. drop date 

. 
. ** Rename 
. rename state state_name 

. rename county county_name 

. rename num_date date 

. 
. ** keep only counties 
. keep if !missing(fips)
(23,678 observations deleted)

. 
. ** Keep in 50 states 
. drop if state_name == "Puerto Rico"
(57,605 observations deleted)

. drop if state_name == "Virgin Islands"
(2,304 observations deleted)

. drop if state_name == "Northern Mariana Islands"
(1,452 observations deleted)

. 
. ** Sort 
. sort date fips 

. 
. ** Create panel 
. xtset fips date

Panel variable: fips (unbalanced)
 Time variable: date, 21jan2020 to 13may2022, but
                with gaps
         Delta: 1 day

. 
. ** Fill in panel 
. tsfill, full 

. 
. ** Fill in missing values 
. replace cases = 0 if missing(cases)
(228,991 real changes made)

. replace deaths = 0 if missing(deaths)
(228,991 real changes made)

. 
. ** Preserve data 
. preserve 

. 
. ** Preserve fips codes and names 
. keep if !missing(state_name)
(228,991 observations deleted)

. keep if !missing(county_name)
(0 observations deleted)

. duplicates drop fips state_name county_name, force 

Duplicates in terms of fips state_name county_name

(2,414,657 observations deleted)

. 
. ** Save as temporary data 
. tempfile state_county_names 

. save `state_county_names'
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000003
    > .tmp saved as .dta format

. clear 

. 
. ** Restore 
. restore 

. 
. ** Drop and merge in names 
. drop state_name county_name

. merge m:1 fips using `state_county_names', keep(mast
> er match) nogen 

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                         2,646,784  
    -----------------------------------------

. 
. ** Get year, month, day 
. gen year = year(date)

. gen month = month(date)

. gen day = day(date)

. 
. ** Order data 
. order date year month day fips state county cases de
> aths 

. 
. ** Calculate cumulative cases and deaths 
. bysort fips (date): gen cases_cum = sum(cases)

. bysort fips (date): gen deaths_cum = sum(deaths)

. 
. ** Merge population data (2020)
. merge m:1 fips using "${data}working/population_2020
> ", keep(match) nogen  
(variable county_name was str35, now str46 to
       accommodate using data's values)
(variable fips was long, now double to accommodate
       using data's values)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                         2,643,408  
    -----------------------------------------

. 
. ** Save file 
. save ${data}working/covid_cleaned.dta, replace 
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/covid_cleaned.dta saved

. 
. ** Generate Clustering Variables 
. 
. ** Keep one observation per month 
. keep year month fips state_name county_name cases_cu
> m deaths_cum population

. collapse (sum) cases deaths population, by(year mont
> h fips state_name county_name) 

. sort year month fips 

. egen date = group(year month)

. drop year month 

. 
. ** Generate per capita figures
. replace cases = 1000 * cases / population
(82,955 real changes made)

. replace deaths = 1000 * deaths / population
(74,723 real changes made)

. drop population 

. 
. ** Reshape wide 
. reshape wide cases deaths, i(fips state_name county_
> name) j(date)
(j = 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 2
> 0 21 22 23 24 25 26 27 28 29)

Data                               Long   ->   Wide
------------------------------------------------------
> -----------------------
Number of observations           90,828   ->   3,132  
>      
Number of variables                   6   ->   61     
>      
j variable (29 values)             date   ->   (droppe
> d)
xij variables:
                              cases_cum   ->   cases_c
> um1 cases_cum2 ... cases_cum29
                             deaths_cum   ->   deaths_
> cum1 deaths_cum2 ... deaths_cum29
------------------------------------------------------
> -----------------------

. 
. ** Save file 
. save ${data}working/covid_cleaned_wide.dta, replace 
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/covid_cleaned_wide.dta saved

. clear

. 
. //--------------------------------------------------
> --
. // STEP 3: Import and Clean ACS Micro Data via IPUMS
>  
. //--------------------------------------------------
> --
. 
. ** Load data 
. forvalues y = 2015(1)2023 {
  2.         
.         ** Import CSV
.         import delimited using "${data}acs/acs_`y'",
>  varnames(1) clear case(lower)
  3.         
.         ** Save as temporary data 
.         tempfile acs_`y'
  4.         save `acs_`y''
  5.         clear 
  6.         
. } // END YEAR LOOP 
(encoding automatically selected: ISO-8859-1)
(57 vars, 2,997,503 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000004
    > .tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(57 vars, 3,007,847 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000005
    > .tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(57 vars, 3,038,696 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000006
    > .tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(57 vars, 3,060,442 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000007
    > .tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(57 vars, 3,087,291 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000008
    > .tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(57 vars, 2,454,160 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000009
    > .tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(57 vars, 3,092,079 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000a
    > .tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(55 vars, 3,190,848 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000b
    > .tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(55 vars, 3,228,659 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000c
    > .tmp saved as .dta format

. 
. ** Append data 
. forvalues y = 2015(1)2023 {
  2.         
.         append using `acs_`y''  
  3.         
. } // END YEAR LOOP 
(variable cbserial was long, now double to
       accommodate using data's values)

. 
. ** Des 
. tab year 

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       2015 |  2,997,503       11.04       11.04
       2016 |  3,007,847       11.08       22.11
       2017 |  3,038,696       11.19       33.30
       2018 |  3,060,442       11.27       44.57
       2019 |  3,087,291       11.37       55.94
       2020 |  2,454,160        9.04       64.98
       2021 |  3,092,079       11.39       76.36
       2022 |  3,190,848       11.75       88.11
       2023 |  3,228,659       11.89      100.00
------------+-----------------------------------
      Total | 27,157,525      100.00

. 
. ** Define # of adults and kids in HHs 
. gen adult = age >= 18 

. gen child = age < 18 

. bysort year serial: gen hh_size = _N 

. bysort year serial: egen hh_adult_ct = total(adult)

. bysort year serial: egen hh_child_ct = total(child)

. 
. ** Sample 18+
. drop if child == 1 
(5,629,869 observations deleted)

. drop child adult 

. 
. ** Sample not living abroad last year 
. drop if migplac1 > 56 
(108,862 observations deleted)

. drop if migrate1 == 4 
(0 observations deleted)

. 
. ** Rename variables 
. rename statefip state_fips_d

. rename countyfip county_fips_d 

. 
. ** Set up origin data 
. fre migrate1
command fre is unrecognized
r(199);

end of do-file
r(199);

end of do-file

r(199);

. ssc install fre
checking fre consistency and verifying not already ins
> talled...
installing into C:\Users\ji252\ado\plus\...
installation complete.

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_00001f
> .tmp"

. 
. ** Set up origin data 
. fre migrate1

migrate1
------------------------------------------------------
> -----
              |      Freq.    Percent      Valid      
>  Cum.
--------------+---------------------------------------
> -----
Valid   1     |   1.92e+07      89.51      89.51      
> 89.51
        2     |    1809920       8.45       8.45      
> 97.96
        3     |     436745       2.04       2.04     1
> 00.00
        Total |   2.14e+07     100.00     100.00      
>      
------------------------------------------------------
> -----

. drop migrate1d

. tab migplac1

   migplac1 |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 | 19,172,129       89.51       89.51
          1 |     31,329        0.15       89.66
          2 |      5,825        0.03       89.68
          4 |     54,912        0.26       89.94
          5 |     21,714        0.10       90.04
          6 |    260,673        1.22       91.26
          8 |     52,539        0.25       91.50
          9 |     21,577        0.10       91.61
         10 |      5,369        0.03       91.63
         11 |      8,664        0.04       91.67
         12 |    152,989        0.71       92.38
         13 |     71,263        0.33       92.72
         15 |      9,845        0.05       92.76
         16 |     13,536        0.06       92.83
         17 |     86,306        0.40       93.23
         18 |     47,941        0.22       93.45
         19 |     21,469        0.10       93.55
         20 |     22,338        0.10       93.66
         21 |     31,888        0.15       93.81
         22 |     28,776        0.13       93.94
         23 |      7,911        0.04       93.98
         24 |     40,223        0.19       94.17
         25 |     48,684        0.23       94.39
         26 |     65,444        0.31       94.70
         27 |     35,177        0.16       94.86
         28 |     16,994        0.08       94.94
         29 |     45,200        0.21       95.15
         30 |      7,453        0.03       95.19
         31 |     13,567        0.06       95.25
         32 |     24,785        0.12       95.37
         33 |      8,787        0.04       95.41
         34 |     50,561        0.24       95.64
         35 |     12,299        0.06       95.70
         36 |    118,674        0.55       96.26
         37 |     70,555        0.33       96.59
         38 |      5,884        0.03       96.61
         39 |     81,541        0.38       96.99
         40 |     28,921        0.14       97.13
         41 |     36,246        0.17       97.30
         42 |     76,201        0.36       97.65
         44 |      6,551        0.03       97.68
         45 |     33,552        0.16       97.84
         46 |      6,067        0.03       97.87
         47 |     48,061        0.22       98.09
         48 |    197,912        0.92       99.02
         49 |     25,798        0.12       99.14
         50 |      4,106        0.02       99.16
         51 |     64,560        0.30       99.46
         53 |     64,790        0.30       99.76
         54 |     10,532        0.05       99.81
         55 |     35,653        0.17       99.98
         56 |      5,023        0.02      100.00
------------+-----------------------------------
      Total | 21,418,794      100.00

. rename migplac1 state_fips_o

. tab migcounty1

 migcounty1 |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 | 19,952,847       93.16       93.16
          1 |     35,752        0.17       93.32
          3 |     58,525        0.27       93.60
          5 |     21,286        0.10       93.70
          7 |     13,720        0.06       93.76
          9 |     11,958        0.06       93.82
         11 |     23,663        0.11       93.93
         13 |     53,927        0.25       94.18
         15 |      7,126        0.03       94.21
         17 |     21,840        0.10       94.31
         19 |     24,348        0.11       94.43
         20 |      2,061        0.01       94.44
         21 |     12,848        0.06       94.50
         23 |      7,725        0.04       94.53
         25 |     21,090        0.10       94.63
         27 |     15,274        0.07       94.70
         29 |     32,454        0.15       94.85
         31 |     57,529        0.27       95.12
         33 |     33,851        0.16       95.28
         35 |     24,912        0.12       95.40
         37 |     72,280        0.34       95.73
         39 |     10,381        0.05       95.78
         41 |      8,696        0.04       95.82
         43 |      8,893        0.04       95.86
         45 |      5,998        0.03       95.89
         47 |     22,821        0.11       96.00
         49 |     21,522        0.10       96.10
         51 |     17,488        0.08       96.18
         53 |     17,759        0.08       96.26
         55 |     12,676        0.06       96.32
         57 |     18,309        0.09       96.41
         59 |     30,944        0.14       96.55
         61 |     31,725        0.15       96.70
         63 |     12,421        0.06       96.76
         65 |     18,670        0.09       96.85
         67 |     29,982        0.14       96.99
         69 |      4,036        0.02       97.01
         71 |     27,649        0.13       97.13
         73 |     36,959        0.17       97.31
         75 |     11,968        0.06       97.36
         77 |      8,293        0.04       97.40
         79 |      7,681        0.04       97.44
         81 |     30,275        0.14       97.58
         83 |      9,053        0.04       97.62
         85 |     28,918        0.14       97.76
         87 |      6,680        0.03       97.79
         89 |     10,158        0.05       97.83
         91 |     15,565        0.07       97.91
         93 |      4,960        0.02       97.93
         95 |     19,883        0.09       98.02
         97 |     19,460        0.09       98.11
         99 |     19,554        0.09       98.21
        101 |     14,457        0.07       98.27
        103 |     18,351        0.09       98.36
        105 |      7,421        0.03       98.39
        107 |      5,600        0.03       98.42
        109 |     10,761        0.05       98.47
        111 |     14,844        0.07       98.54
        113 |     30,918        0.14       98.68
        115 |      4,818        0.02       98.71
        117 |      7,798        0.04       98.74
        119 |     14,739        0.07       98.81
        121 |     10,181        0.05       98.86
        123 |      3,671        0.02       98.88
        125 |      9,036        0.04       98.92
        127 |      2,348        0.01       98.93
        129 |      1,814        0.01       98.94
        133 |      5,313        0.02       98.96
        135 |      7,844        0.04       99.00
        139 |      5,952        0.03       99.03
        141 |      6,936        0.03       99.06
        143 |      4,286        0.02       99.08
        145 |      1,975        0.01       99.09
        147 |      2,327        0.01       99.10
        149 |      2,146        0.01       99.11
        151 |      1,900        0.01       99.12
        153 |      5,155        0.02       99.14
        157 |     11,532        0.05       99.20
        159 |        751        0.00       99.20
        160 |        149        0.00       99.20
        161 |      4,716        0.02       99.22
        163 |     13,817        0.06       99.29
        165 |      2,418        0.01       99.30
        167 |      5,023        0.02       99.32
        169 |        850        0.00       99.33
        171 |        529        0.00       99.33
        173 |        264        0.00       99.33
        179 |      1,879        0.01       99.34
        183 |     11,521        0.05       99.39
        185 |        871        0.00       99.40
        187 |      2,303        0.01       99.41
        189 |      6,599        0.03       99.44
        191 |        759        0.00       99.44
        197 |      3,401        0.02       99.46
        201 |     29,158        0.14       99.59
        209 |      2,664        0.01       99.60
        215 |      3,046        0.01       99.62
        223 |        758        0.00       99.62
        227 |        946        0.00       99.63
        245 |      3,068        0.01       99.64
        251 |      1,020        0.00       99.65
        257 |        850        0.00       99.65
        303 |      3,247        0.02       99.67
        309 |      2,351        0.01       99.68
        313 |        456        0.00       99.68
        329 |      1,177        0.01       99.68
        339 |      3,176        0.01       99.70
        355 |      2,646        0.01       99.71
        367 |        977        0.00       99.72
        375 |      1,001        0.00       99.72
        381 |      1,199        0.01       99.73
        423 |      1,497        0.01       99.73
        439 |     14,652        0.07       99.80
        441 |      1,419        0.01       99.81
        451 |        952        0.00       99.81
        453 |     12,549        0.06       99.87
        479 |      1,301        0.01       99.88
        485 |      1,288        0.01       99.88
        491 |      4,036        0.02       99.90
        510 |     10,140        0.05       99.95
        550 |      1,187        0.01       99.95
        650 |      1,031        0.00       99.96
        700 |      1,438        0.01       99.97
        710 |        466        0.00       99.97
        760 |      2,799        0.01       99.98
        810 |      3,933        0.02      100.00
------------+-----------------------------------
      Total | 21,418,794      100.00

. rename migcounty1 county_fips_o

. 
. ** Use migrate1 to update values 
. 
end of do-file

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_00001g
> .tmp"

. 
. ** Within same house 
. replace state_fips_o = state_fips_d if migrate1 == 1
(19,172,129 real changes made)

. replace county_fips_o = county_fips_d if migrate1 ==
>  1 
(11,640,515 real changes made)

. 
. ** Within same state 
. replace state_fips_o = state_fips_d if migrate1 == 2
(0 real changes made)

. 
. ** Generate county IDS 
. foreach x in "o" "d" {
  2.         
.         make_fips state_fips_`x' county_fips_`x', ge
> n(fips_`x')
  3. 
. }

. 
. ** Check for within-state migration 
. gen same_county = fips_o == fips_d 

. tab year same_county

           |      same_county
      year |         0          1 |     Total
-----------+----------------------+----------
      2015 |    89,492  2,245,481 | 2,334,973 
      2016 |    91,109  2,255,901 | 2,347,010 
      2017 |    93,553  2,278,348 | 2,371,901 
      2018 |    96,080  2,306,022 | 2,402,102 
      2019 |    96,088  2,344,171 | 2,440,259 
      2020 |    71,827  1,877,155 | 1,948,982 
      2021 |    97,600  2,361,518 | 2,459,118 
      2022 |   106,231  2,430,426 | 2,536,657 
      2023 |    98,226  2,479,566 | 2,577,792 
-----------+----------------------+----------
     Total |   840,206 20,578,588 |21,418,794 

. tab year same_county if migrate1 == 2

           |      same_county
      year |         0          1 |     Total
-----------+----------------------+----------
      2015 |    42,597    172,956 |   215,553 
      2016 |    43,823    172,091 |   215,914 
      2017 |    45,058    174,386 |   219,444 
      2018 |    46,477    173,182 |   219,659 
      2019 |    46,329    168,101 |   214,430 
      2020 |    34,625    119,307 |   153,932 
      2021 |    46,470    148,925 |   195,395 
      2022 |    50,584    141,717 |   192,301 
      2023 |    47,498    135,794 |   183,292 
-----------+----------------------+----------
     Total |   403,461  1,406,459 | 1,809,920 

. 
. ** Tag HH head 
. gen byte hh_head = (relate == 1)

. 
. ** Compress file 
. compress 
  variable state_fips_o was int now byte
  variable hh_size was float now byte
  variable hh_adult_ct was float now byte
  variable hh_child_ct was float now byte
  variable same_county was float now byte
  (278,444,322 bytes saved)

. 
. ** Save 
. save "${data}working/acs_migration_file", replace 
(file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/acs_migration_file.dta not
    found)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/acs_migration_file.dta saved

. 
end of do-file

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_00001h
> .tmp"

. 
. // Keep only observations with valid origin/destinat
> ion counties and YEAR
. drop if missing(year) | missing(fips_o) | missing(fi
> ps_d)
(0 observations deleted)

. 
. // Clean income (treat missing as 0; keep negative v
> alues as reported)
. replace inctot = 0 if missing(inctot)
(0 real changes made)

. gen double income_wt = inctot * perwt

. label var income_wt "Person income (INCTOT) weighted
>  by PERWT"

. 
. // --- Persons + income totals by origin/destination
> /year
. preserve

. keep year fips_o fips_d perwt income_wt

. collapse (sum) persons=perwt income_total=income_wt,
>  by(year fips_o fips_d)

. tempfile acs_pi

. save `acs_pi'
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000002
    > .tmp saved as .dta format

. restore

. 
. // --- Households by origin/destination/year
. // Use HHWT among household heads (RELATE==1) if ava
> ilable; else PERNUM==1 fallback.
. 
. preserve

. keep if hh_head
(10,269,992 observations deleted)

. keep year fips_o fips_d hhwt

. collapse (sum) households=hhwt, by(year fips_o fips_
> d)

. tempfile acs_hh

. save `acs_hh'
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000004
    > .tmp saved as .dta format

. restore

. 
. // --- Merge persons/income with households
. use `acs_pi', clear

. merge 1:1 year fips_o fips_d using `acs_hh', nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                        45,163
        from master                    45,163  
        from using                          0  

    Matched                           162,899  
    -----------------------------------------

. 
. label var persons "Estimated number of persons (sum 
> PERWT)"

. label var households "Estimated number of households
>  (sum HHWT among heads)"

. label var income_total "Estimated total personal inc
> ome (sum INCTOT*PERWT)"

. 
. // --- Derive state/county components for merges wit
> h name crosswalk
. gen int state_fips_o  = floor(fips_o/1000)

. gen int county_fips_o = mod(fips_o,1000)

. gen int state_fips_d  = floor(fips_d/1000)

. gen int county_fips_d = mod(fips_d,1000)

. 
. label var state_fips_o "State FIPS (origin)"

. label var county_fips_o "County FIPS (origin)"

. label var state_fips_d "State FIPS (destination)"

. label var county_fips_d "County FIPS (destination)"

. 
. // --- Merge in names (from NHGIS IDs snapshot)
. preserve

. use "${data}working/ids", clear

. rename (state_fips county_fips state_name county_nam
> e) (state_fips_o county_fips_o state_name_o county_n
> ame_o)

. tempfile ids_o

. save `ids_o'
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000006
    > .tmp saved as .dta format

. restore

. merge m:1 state_fips_o county_fips_o using `ids_o', 
> keep(master match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                        46,997
        from master                    46,997  
        from using                          0  

    Matched                           161,065  
    -----------------------------------------

. 
. preserve

. use "${data}working/ids", clear

. rename (state_fips county_fips state_name county_nam
> e) (state_fips_d county_fips_d state_name_d county_n
> ame_d)

. tempfile ids_d

. save `ids_d'
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000008
    > .tmp saved as .dta format

. restore

. merge m:1 state_fips_d county_fips_d using `ids_d', 
> keep(master match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                        50,197
        from master                    50,197  
        from using                          0  

    Matched                           157,865  
    -----------------------------------------

. 
. order year ///
>     state_fips_o county_fips_o state_name_o county_n
> ame_o fips_o ///
>     state_fips_d county_fips_d state_name_d county_n
> ame_d fips_d ///
>     persons households income_total

. 
. sort year state_fips_o county_fips_o state_fips_d co
> unty_fips_d

. 
. save "${data}working/acs_county_flow", replace
(file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/acs_county_flow.dta not
    found)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/acs_county_flow.dta saved

. 
. // Optional: Multnomah-focused flow extract (origin 
> = Multnomah County, OR)
. // Multnomah County, OR = state 41, county 051
. preserve

. keep if state_fips_o == 41 & county_fips_o == 51
(207,316 observations deleted)

. save "${data}working/multnomah_acs_flow", replace
(file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/multnomah_acs_flow.dta not
    found)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/multnomah_acs_flow.dta saved

. restore

. 
. 
end of do-file

. use  "${data}working/acs_county_flow", clear

. use "${data}working/acs_migration_file", clear 

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_00001i
> .tmp"

. // Keep only observations with valid origin/destinat
> ion counties and YEAR
. drop if missing(year) | missing(fips_o) | missing(fi
> ps_d)
(0 observations deleted)

. 
end of do-file

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_00001j
> .tmp"

. // Keep only observations with valid origin/destinat
> ion counties and YEAR
. drop if missing(year) | missing(fips_o) | missing(fi
> ps_d)
(0 observations deleted)

. 
. // Clean income (treat missing as 0; keep negative v
> alues as reported)
. replace inctot = 0 if missing(inctot)
(0 real changes made)

. gen double income_wt = inctot * perwt

. label var income_wt "Person income (INCTOT) weighted
>  by PERWT"

. 
. // --- Persons + income totals by origin/destination
> /year
. preserve

. keep year fips_o fips_d perwt income_wt

. collapse (sum) persons=perwt income_total=income_wt,
>  by(year fips_o fips_d)

. tempfile acs_pi

. save `acs_pi'
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000002
    > .tmp saved as .dta format

. restore

. 
. // --- Households by origin/destination/year
. // Use HHWT among household heads (RELATE==1) if ava
> ilable; else PERNUM==1 fallback.
. 
. preserve

. keep if hh_head
(10,269,992 observations deleted)

. keep year fips_o fips_d hhwt

. collapse (sum) households=hhwt, by(year fips_o fips_
> d)

. tempfile acs_hh

. save `acs_hh'
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000004
    > .tmp saved as .dta format

. restore

. 
. // --- Merge persons/income with households
. use `acs_pi', clear

. merge 1:1 year fips_o fips_d using `acs_hh', nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                        45,163
        from master                    45,163  
        from using                          0  

    Matched                           162,899  
    -----------------------------------------

. 
. label var persons "Estimated number of persons (sum 
> PERWT)"

. label var households "Estimated number of households
>  (sum HHWT among heads)"

. label var income_total "Estimated total personal inc
> ome (sum INCTOT*PERWT)"

. 
. // --- Derive state/county components for merges wit
> h name crosswalk
. gen int state_fips_o  = floor(fips_o/1000)

. gen int county_fips_o = mod(fips_o,1000)

. gen int state_fips_d  = floor(fips_d/1000)

. gen int county_fips_d = mod(fips_d,1000)

. 
. label var state_fips_o "State FIPS (origin)"

. label var county_fips_o "County FIPS (origin)"

. label var state_fips_d "State FIPS (destination)"

. label var county_fips_d "County FIPS (destination)"

. 
. // --- Merge in names (from NHGIS IDs snapshot)
. preserve

. use "${data}working/ids", clear

. rename (state_fips county_fips state_name county_nam
> e) (state_fips_o county_fips_o state_name_o county_n
> ame_o)

. tempfile ids_o

. save `ids_o'
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000006
    > .tmp saved as .dta format

. restore

. merge m:1 state_fips_o county_fips_o using `ids_o', 
> keep(master match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                        46,997
        from master                    46,997  
        from using                          0  

    Matched                           161,065  
    -----------------------------------------

. 
. preserve

. use "${data}working/ids", clear

. rename (state_fips county_fips state_name county_nam
> e) (state_fips_d county_fips_d state_name_d county_n
> ame_d)

. tempfile ids_d

. save `ids_d'
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000008
    > .tmp saved as .dta format

. restore

. merge m:1 state_fips_d county_fips_d using `ids_d', 
> keep(master match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                        50,197
        from master                    50,197  
        from using                          0  

    Matched                           157,865  
    -----------------------------------------

. 
. order year ///
>     state_fips_o county_fips_o state_name_o county_n
> ame_o fips_o ///
>     state_fips_d county_fips_d state_name_d county_n
> ame_d fips_d ///
>     persons households income_total

. 
. sort year state_fips_o county_fips_o state_fips_d co
> unty_fips_d

. 
end of do-file

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_00001k
> .tmp"

. /***************************************************
> **************************
> * Program:                      01_clean_data.do 
> * Author(s):            John Iselin 
> * Date Updated:         October 19, 2025
> 
> *** Demographic data via IPUMS NHGIS 
> ** Via https://www.nhgis.org/
> ** Downloaded on October 19, 2025
> ** EXTRACT DETAILS in "nhgis0031_ts_nominal_county_c
> odebook"
> 
> *** Economic data via BEA Regional Economic Accounts
>  (CAINC1)
> ** Via https://apps.bea.gov/regional/downloadzip.htm
> 
> *** ACS individual data via IPUMS USA 
> ** Via https://usa.ipums.org/usa/index.shtml
> ** Downloaded via R program 
> 
> *** IRS SOI County-Level Migration Files
> ** Via https://www.irs.gov/statistics/soi-tax-stats-
> migration-data
> 
> *** IRS SOI County-Level Files
> ** Via https://www.irs.gov/statistics/soi-tax-stats-
> county-data
> 
> *** NYTimes COVID Cases and Deaths 
> ** Via https://github.com/nytimes/covid-19-data
> 
> ****************************************************
> ***************************/
. 
. ** Start log file 
. capture log close log_01

. log using "${logs}01_log_data_clean_${pr_name}_${dat
> e}", replace text name(log_01)
------------------------------------------------------
      name:  log_01
       log:  C:/Users/ji252/Documents/GitHub/multnomah
> -county-tax/code/logs/01_log_data_clean_multnomah_20
> 25-12-15.log
  log type:  text
 opened on:  15 Dec 2025, 16:08:19

. 
. //--------------------------------------------------
. // STEP 0: Preliminary Set-Up 
. //--------------------------------------------------
. 
. ** Define labels 
. label define lb_move_type       0 "ERROR"           
>                     ///
>                                                     
>     1 "Non-movers"                  ///
>                                                     
>     2 "All movers"                  ///
>                                                     
>     3 "Domestic movers"             ///
>                                                     
>     4 "Within-state movers" ///
>                                                     
>     5 "Inter-state movers"  ///
>                                                     
>     6 "Foreign movers", modify

.                                                     
>     
. label define lb_agi             1 "Under $1"        
>             ///
>                                                     
>     2 "$1 under $10K"               ///
>                                                     
>     3 "$10K under $25K"             ///
>                                                     
>     4 "$25K under $50K"             ///
>                                                     
>     5 "$50K under $75K"             ///
>                                                     
>     6 "$75K under $100K"    ///
>                                                     
>     7 "$100K under $200K"   ///
>                                                     
>     8 "$200K or more", modify                       
>                                 

. 
. 
. ** Define Programs
. 
. ** Make FIPS code from state and county fips codes 
. capture program drop make_fips

. program define make_fips
  1.     syntax varlist(min=2 max=2 numeric), GEN(name
> )
  2. 
.     quietly {
  3.         tempvar s c
  4. 
.         local v1 : word 1 of `varlist'
  5.         local v2 : word 2 of `varlist'
  6. 
.         gen `s' = string(`v1', "%02.0f")
  7.         gen `c' = string(`v2', "%03.0f")
  8. 
.         gen `gen' = real(`s' + `c')
  9.     }
 10. end

. 
. ** Reclassify suppressed values as 0 
. 
. capture program drop unsuppress

. program define unsuppress
  1.     syntax varlist
  2. 
.     foreach v of varlist `varlist' {
  3.         replace `v' = 0 if `v' == -1
  4.     }
  5. end

. 
. //--------------------------------------------------
. // STEP -1: Acquire raw data (automated where possib
> le)
. //--------------------------------------------------
. /*
> This block downloads public-use source data directly
>  from official URLs if not present locally.
> 
> Automated downloads included:
>   - IRS SOI county-to-county migration: countyinflow
> YYZZ.csv / countyoutflowYYZZ.csv
>   - IRS SOI county data: YYincyallagi.csv
>   - BEA Regional Economic Accounts (CAINC1): CAINC1.
> zip (unzips to CAINC1__ALL_AREAS_*.csv and related f
> iles)
> 
> */
. 
. * Ensure expected directory structure exists
. capture mkdir "${data}"

. capture mkdir "${data}working"

. capture mkdir "${data}demographic"

. capture mkdir "${data}demographic/CAINC1"

. capture mkdir "${data}demographic/nhgis0031_csv"

. capture mkdir "${data}irs"

. capture mkdir "${data}covid"

. 
. * ----------------------------
. * IRS SOI: migration files
. * ----------------------------
. local irs_base "https://www.irs.gov/pub/irs-soi"

. 
. forvalues yy = 15/21 {
  2.     local zz = `yy' + 1
  3.     local fn_out "countyoutflow`yy'`zz'.csv"
  4.     local fn_in  "countyinflow`yy'`zz'.csv"
  5. 
.     capture confirm file "${data}irs/`fn_out'"
  6.     if _rc {
  7.         di as txt "Downloading (IRS SOI) `fn_out'
>  ..."
  8.         copy "`irs_base'/`fn_out'" "${data}irs/`f
> n_out'", replace
  9.     }
 10. 
.     capture confirm file "${data}irs/`fn_in'"
 11.     if _rc {
 12.         di as txt "Downloading (IRS SOI) `fn_in' 
> ..."
 13.         copy "`irs_base'/`fn_in'" "${data}irs/`fn
> _in'", replace
 14.     }
 15. }

. 
. * ----------------------------
. * IRS SOI: county income (AGI) files
. * ----------------------------
. forvalues yy = 15/22 {
  2.     local fn_inc "`yy'incyallagi.csv"
  3. 
.     capture confirm file "${data}irs/`fn_inc'"
  4.     if _rc {
  5.         di as txt "Downloading (IRS SOI) `fn_inc'
>  ..."
  6.         copy "`irs_base'/`fn_inc'" "${data}irs/`f
> n_inc'", replace
  7.     }
  8. }

. 
. * ----------------------------
. * BEA Regional: CAINC1.zip
. * ----------------------------
. local bea_dir "${data}demographic/CAINC1"

. local bea_url "https://apps.bea.gov/regional/zip/CAI
> NC1.zip"

. local bea_zip "`bea_dir'/CAINC1.zip"

. 
. * If we don't already have a CAINC1 "_ALL_AREAS" fil
> e, download + unzip the ZIP.
. local bea_files : dir "`bea_dir'" files "CAINC1__ALL
> _AREAS_*.csv"

. if "`bea_files'"=="" {
.     local bea_files : dir "`bea_dir'" files "CAINC1_
> _ALL_STATES_*.csv"
. }

. 
. if "`bea_files'"=="" {
.     di as txt "Downloading (BEA) CAINC1.zip ..."
Downloading (BEA) CAINC1.zip ...
.     copy "`bea_url'" "`bea_zip'", replace
(file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/demographic/CAINC1/CAINC1.zip not
    found)
. 
.     local curdir "`c(pwd)'"
.     cd "`bea_dir'"
C:\Users\ji252\Documents\GitHub\multnomah-county-tax\d
> ata\demographic\CAINC1
.     unzipfile "CAINC1.zip", replace
    inflating: CAINC1__ALL_AREAS_1969_2023.csv
    inflating: CAINC1__definition.xml
    inflating: CAINC1__Footnotes.html
    inflating: CAINC1_AK_1969_2023.csv
    inflating: CAINC1_AL_1969_2023.csv
    inflating: CAINC1_AR_1969_2023.csv
    inflating: CAINC1_AZ_1969_2023.csv
    inflating: CAINC1_CA_1969_2023.csv
    inflating: CAINC1_CO_1969_2023.csv
    inflating: CAINC1_CSA_1969_2023.csv
    inflating: CAINC1_CT_1969_2023.csv
    inflating: CAINC1_DC_1969_2023.csv
    inflating: CAINC1_DE_1969_2023.csv
    inflating: CAINC1_FL_1969_2023.csv
    inflating: CAINC1_GA_1969_2023.csv
    inflating: CAINC1_HI_1969_2023.csv
    inflating: CAINC1_IA_1969_2023.csv
    inflating: CAINC1_ID_1969_2023.csv
    inflating: CAINC1_IL_1969_2023.csv
    inflating: CAINC1_IN_1969_2023.csv
    inflating: CAINC1_KS_1969_2023.csv
    inflating: CAINC1_KY_1969_2023.csv
    inflating: CAINC1_LA_1969_2023.csv
    inflating: CAINC1_MA_1969_2023.csv
    inflating: CAINC1_MD_1969_2023.csv
    inflating: CAINC1_MDIV_1969_2023.csv
    inflating: CAINC1_ME_1969_2023.csv
    inflating: CAINC1_MI_1969_2023.csv
    inflating: CAINC1_MIC_1969_2023.csv
    inflating: CAINC1_MN_1969_2023.csv
    inflating: CAINC1_MO_1969_2023.csv
    inflating: CAINC1_MS_1969_2023.csv
    inflating: CAINC1_MSA_1969_2023.csv
    inflating: CAINC1_MT_1969_2023.csv
    inflating: CAINC1_NC_1969_2023.csv
    inflating: CAINC1_ND_1969_2023.csv
    inflating: CAINC1_NE_1969_2023.csv
    inflating: CAINC1_NH_1969_2023.csv
    inflating: CAINC1_NJ_1969_2023.csv
    inflating: CAINC1_NM_1969_2023.csv
    inflating: CAINC1_NV_1969_2023.csv
    inflating: CAINC1_NY_1969_2023.csv
    inflating: CAINC1_OH_1969_2023.csv
    inflating: CAINC1_OK_1969_2023.csv
    inflating: CAINC1_OR_1969_2023.csv
    inflating: CAINC1_PA_1969_2023.csv
    inflating: CAINC1_PORT_1969_2023.csv
    inflating: CAINC1_RI_1969_2023.csv
    inflating: CAINC1_SC_1969_2023.csv
    inflating: CAINC1_SD_1969_2023.csv
    inflating: CAINC1_TN_1969_2023.csv
    inflating: CAINC1_TX_1969_2023.csv
    inflating: CAINC1_US_1969_2023.csv
    inflating: CAINC1_UT_1969_2023.csv
    inflating: CAINC1_VA_1969_2023.csv
    inflating: CAINC1_VT_1969_2023.csv
    inflating: CAINC1_WA_1969_2023.csv
    inflating: CAINC1_WI_1969_2023.csv
    inflating: CAINC1_WV_1969_2023.csv
    inflating: CAINC1_WY_1969_2023.csv

successfully unzipped CAINC1.zip to current directory
total processed:  60
        skipped:  0
      extracted:  60
.     cd "`curdir'"
C:\Users\ji252\Documents\GitHub\multnomah-county-tax
. 
.     capture erase "`bea_zip'"
. }

. 
. * ----------------------------
. * NYTimes COVID Data 
. * ----------------------------
. local covid_dir "${data}covid"

. local covid_url "https://raw.githubusercontent.com/n
> ytimes/covid-19-data/master/us-counties.csv"

. 
. * If we don't already have a COVID file, download.
. local covid_file : dir "`covid_dir'" files "covid_ny
> t.csv"

. if "`covid_file'"=="" {
.     local covid_file : dir "`covid_dir'" files "covi
> d_nyt.csv"
. }

. 
. if "`covid_file'"=="" {
.     di as txt "Downloading (COVID)  ..."
Downloading (COVID)  ...
.     copy "`covid_url'" "`covid_dir'/covid_nyt.csv", 
> replace
. }

. 
. 
. 
. //--------------------------------------------------
> ---------
. // STEP 1: Import and Clean Demographic Data via IPU
> MS + BEA  
. //--------------------------------------------------
> ---------
. 
. ** Import data 
. import delimited        ///
>         "${data}demographic/nhgis0031_csv/nhgis0031_
> ts_nominal_county.csv", clear 
(encoding automatically selected: ISO-8859-1)
(15 vars, 54,673 obs)

. 
. ** Describe data 
. des 

Contains data
 Observations:        54,673                  
    Variables:            15                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
gisjoin         str8    %9s                   GISJOIN
year            str9    %9s                   YEAR
state           str20   %20s                  STATE
statefp         byte    %8.0g                 STATEFP
statenh         int     %8.0g                 STATENH
county          str46   %46s                  COUNTY
countyfp        int     %8.0g                 COUNTYFP
countynh        int     %8.0g                 COUNTYNH
name            str59   %59s                  NAME
av0aa           long    %12.0g                AV0AA
d15aa           long    %12.0g                D15AA
d15ab           long    %12.0g                D15AB
b79aa           long    %12.0g                B79AA
av0aam          long    %12.0g                AV0AAM
b79aam          long    %8.0g                 B79AAM
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.

. 
. ** Drop unnecc variables 
. drop gisjoin statenh countynh name 

. 
. ** Rename 
. rename state state_name 

. rename statefp state_fips 

. rename county county_name 

. rename countyfp county_fips 

. rename av0aa population 

. rename d15aa pop_urban 

. rename d15ab pop_rural 

. rename b79aa median_income 

. rename av0aam population_margin

. rename b79aam median_income_margin 

. 
. ** Create urban percent 
. gen percent_urban = pop_urban / population
(45,090 missing values generated)

. 
. ** Label variables 
. label var state_name "State name"

. label var state_fips "State FIPS code"

. label var county_name "County name"

. label var county_fips "County FIPS code"

. label var population "Population count"

. label var pop_rural "Rural population count"

. label var pop_urban "Urban population count"

. label var percent_urban "Percent of population in ur
> ban areas"

. label var median_income "Median household income (pr
> ior year)"

. label var population_margin "ACS margin for error: p
> opulation"

. label var median_income_margin "ACS margin for error
> : median income"

. 
. ** Save as temporary file 
. tempfile demo

. save `demo'
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000001
    > .tmp saved as .dta format

. 
. ** Create three datasets 
. 
. ** (1) Basic state and county IDs 
. keep if year == "2020" 
(51,452 observations deleted)

. keep state* county* 

. 
. ** Make FIPS 
. make_fips state_fips county_fips, gen(fips)

. 
. ** Save as state and county Ids 
. save "${data}working/ids", replace 
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/ids.dta saved

. clear  

. 
. ** (2) Population data 
. use `demo'

. keep if !missing(pop_urban) 
(45,090 observations deleted)

. tab year 

       YEAR |      Freq.     Percent        Cum.
------------+-----------------------------------
       2000 |      3,141       32.78       32.78
       2010 |      3,221       33.61       66.39
       2020 |      3,221       33.61      100.00
------------+-----------------------------------
      Total |      9,583      100.00

. 
. ** Keep 2020 
. keep if year == "2020"
(6,362 observations deleted)

. drop year median_income* population_margin

. 
. ** Make FIPS 
. make_fips state_fips county_fips, gen(fips)

. 
. ** Save data
. save "${data}working/population_2020", replace 
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/population_2020.dta saved

. clear  

. 
. ** (3) 2015-2019 ACS data 
. use `demo'

. keep if !missing(median_income) 
(6,447 observations deleted)

. tab year 

       YEAR |      Freq.     Percent        Cum.
------------+-----------------------------------
       2000 |      3,141        6.51        6.51
  2006-2010 |      3,221        6.68       13.19
  2007-2011 |      3,221        6.68       19.87
  2008-2012 |      3,221        6.68       26.55
  2009-2013 |      3,221        6.68       33.23
  2010-2014 |      3,220        6.68       39.91
  2011-2015 |      3,219        6.67       46.58
  2012-2016 |      3,220        6.68       53.26
  2013-2017 |      3,220        6.68       59.93
  2014-2018 |      3,219        6.67       66.61
  2015-2019 |      3,220        6.68       73.29
  2016-2020 |      3,220        6.68       79.96
  2017-2021 |      3,220        6.68       86.64
  2018-2022 |      3,221        6.68       93.32
  2019-2023 |      3,222        6.68      100.00
------------+-----------------------------------
      Total |     48,226      100.00

. 
. ** Keep 2020 
. keep if year == "2015-2019"
(45,006 observations deleted)

. drop year pop_rural pop_urban percent_urban

. 
. ** Make FIPS 
. make_fips state_fips county_fips, gen(fips)

. 
. ** Save data
. save "${data}working/acs_2015_2019_data", replace 
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/acs_2015_2019_data.dta saved

. 
. ** Rename for merge 
. rename population population_acs

. 
. ** Merge with other data 
. merge 1:1 state_fips county_fips using "${data}worki
> ng/population_2020",                ///
>         keep(match) nogen 

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                             3,219  
    -----------------------------------------

. 
. ** Save data
. save "${data}working/demographics_2020", replace 
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/demographics_2020.dta saved

. 
. ** Load BEA Data 
. import delimited "${data}demographic/CAINC1/CAINC1__
> ALL_AREAS_1969_2023.csv",   ///
>         clear 
(encoding automatically selected: ISO-8859-1)
(63 vars, 9,604 obs)

. 
. ** Drop unnecc variables 
. drop region tablename industryclassification unit ge
> oname 

. 
. ** Drop empty cells 
. drop if missing(linecode)
(4 observations deleted)

. 
. ** Update names 
. rename geofips fips 

. replace fips = subinstr(fips, `"""', "", .)
(9,600 real changes made)

. destring fips, replace 
fips: all characters numeric; replaced as long

. 
. ** Keep population and per-capita income, dropping p
> ersonal income (total)
. tab description linecode

                      |  LineCode
          Description |         1 |     Total
----------------------+-----------+----------
Per capita personal.. |         0 |     3,200 
Personal income (th.. |     3,200 |     3,200 
Population (persons.. |         0 |     3,200 
----------------------+-----------+----------
                Total |     3,200 |     9,600 


                      |  LineCode
          Description |         2 |     Total
----------------------+-----------+----------
Per capita personal.. |         0 |     3,200 
Personal income (th.. |         0 |     3,200 
Population (persons.. |     3,200 |     3,200 
----------------------+-----------+----------
                Total |     3,200 |     9,600 


                      |  LineCode
          Description |         3 |     Total
----------------------+-----------+----------
Per capita personal.. |     3,200 |     3,200 
Personal income (th.. |         0 |     3,200 
Population (persons.. |         0 |     3,200 
----------------------+-----------+----------
                Total |     3,200 |     9,600 

. drop if linecode == 1   
(3,200 observations deleted)

. drop description

.         
. ** Get V* to be in terms of years 
. ** V9 == 1969 
. forvalues i = 9/63 {
  2.         
.         local j = 1960 + `i'
  3.         rename v`i' value`j'
  4.         
. } // END I LOOP 

. 
. ** Reshape 
. reshape long value, i(fips linecode) j(year)
(j = 1969 1970 1971 1972 1973 1974 1975 1976 1977 1978
>  1979 1980 1981 1982 1983 1984 1985 1986 1987 1988 1
> 989 1990 1991 1992 1993 1994 1995 1996 1997 1998 199
> 9 2000 2001 2002 2003 2004 2005 2006 2007 2008 2009 
> 2010 2011 2012 2013 2014 2015 2016 2017 2018 2019 20
> 20 2021 2022 2023)

Data                               Wide   ->   Long
------------------------------------------------------
> -----------------------
Number of observations            6,400   ->   352,000
>      
Number of variables                  57   ->   4      
>      
j variable (55 values)                    ->   year
xij variables:
      value1969 value1970 ... value2023   ->   value
------------------------------------------------------
> -----------------------

. reshape wide value, i(fips year ) j(linecode)
(j = 2 3)

Data                               Long   ->   Wide
------------------------------------------------------
> -----------------------
Number of observations          352,000   ->   176,000
>      
Number of variables                   4   ->   4      
>      
j variable (2 values)          linecode   ->   (droppe
> d)
xij variables:
                                  value   ->   value2 
> value3
------------------------------------------------------
> -----------------------

. 
. ** Keep years 
. keep if inrange(year, 2015, 2023)
(147,200 observations deleted)

. 
. ** Rename values 
. rename value2 population 

. rename value3 per_capita_income

. 
. ** Drop if missing values 
. drop if population == "(NA)"
(239 observations deleted)

. 
. ** Keep only counties with all observations 
. bysort fips: gen ct = _N 

. tab ct

         ct |      Freq.     Percent        Cum.
------------+-----------------------------------
          4 |          8        0.03        0.03
          5 |          5        0.02        0.05
          9 |     28,548       99.95      100.00
------------+-----------------------------------
      Total |     28,561      100.00

. keep if ct == 9
(13 observations deleted)

. drop ct

. 
. ** Destring 
. destring population, replace 
population: all characters numeric; replaced as long

. destring per_capita_income, replace 
per_capita_income: all characters numeric; replaced as
>  long

. 
. ** Save data
. save "${data}working/bea_economics", replace 
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/bea_economics.dta saved

. 
. //--------------------------------------------------
> --
. // STEP 2: Import and Clean NYTimes COVID-19 Data 
. //--------------------------------------------------
> --
.  
. ** Import data 
. import delimited using "${data}covid/covid_nyt.csv",
>  varnames(1) clear case(lower) 
(encoding automatically selected: ISO-8859-1)
(6 vars, 2,502,832 obs)

. 
. ** Describe data 
. des 

Contains data
 Observations:     2,502,832                  
    Variables:             6                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
date            str10   %10s                  
county          str35   %35s                  
state           str24   %24s                  
fips            long    %12.0g                
cases           long    %12.0g                
deaths          long    %8.0g                 
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.

. 
. ** Set up date information 
. generate num_date = date(date, "YMD")

. format num_date %td

. drop date 

. 
. ** Rename 
. rename state state_name 

. rename county county_name 

. rename num_date date 

. 
. ** keep only counties 
. keep if !missing(fips)
(23,678 observations deleted)

. 
. ** Keep in 50 states 
. drop if state_name == "Puerto Rico"
(57,605 observations deleted)

. drop if state_name == "Virgin Islands"
(2,304 observations deleted)

. drop if state_name == "Northern Mariana Islands"
(1,452 observations deleted)

. 
. ** Sort 
. sort date fips 

. 
. ** Create panel 
. xtset fips date

Panel variable: fips (unbalanced)
 Time variable: date, 21jan2020 to 13may2022, but
                with gaps
         Delta: 1 day

. 
. ** Fill in panel 
. tsfill, full 

. 
. ** Fill in missing values 
. replace cases = 0 if missing(cases)
(228,991 real changes made)

. replace deaths = 0 if missing(deaths)
(228,991 real changes made)

. 
. ** Preserve data 
. preserve 

. 
. ** Preserve fips codes and names 
. keep if !missing(state_name)
(228,991 observations deleted)

. keep if !missing(county_name)
(0 observations deleted)

. duplicates drop fips state_name county_name, force 

Duplicates in terms of fips state_name county_name

(2,414,657 observations deleted)

. 
. ** Save as temporary data 
. tempfile state_county_names 

. save `state_county_names'
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000003
    > .tmp saved as .dta format

. clear 

. 
. ** Restore 
. restore 

. 
. ** Drop and merge in names 
. drop state_name county_name

. merge m:1 fips using `state_county_names', keep(mast
> er match) nogen 

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                         2,646,784  
    -----------------------------------------

. 
. ** Get year, month, day 
. gen year = year(date)

. gen month = month(date)

. gen day = day(date)

. 
. ** Order data 
. order date year month day fips state county cases de
> aths 

. 
. ** Calculate cumulative cases and deaths 
. bysort fips (date): gen cases_cum = sum(cases)

. bysort fips (date): gen deaths_cum = sum(deaths)

. 
. ** Merge population data (2020)
. merge m:1 fips using "${data}working/population_2020
> ", keep(match) nogen  
(variable county_name was str35, now str46 to
       accommodate using data's values)
(variable fips was long, now double to accommodate
       using data's values)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                         2,643,408  
    -----------------------------------------

. 
. ** Save file 
. save ${data}working/covid_cleaned.dta, replace 
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/covid_cleaned.dta saved

. 
. ** Generate Clustering Variables 
. 
. ** Keep one observation per month 
. keep year month fips state_name county_name cases_cu
> m deaths_cum population

. collapse (sum) cases deaths population, by(year mont
> h fips state_name county_name) 

. sort year month fips 

. egen date = group(year month)

. drop year month 

. 
. ** Generate per capita figures
. replace cases = 1000 * cases / population
(82,955 real changes made)

. replace deaths = 1000 * deaths / population
(74,723 real changes made)

. drop population 

. 
. ** Reshape wide 
. reshape wide cases deaths, i(fips state_name county_
> name) j(date)
(j = 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 2
> 0 21 22 23 24 25 26 27 28 29)

Data                               Long   ->   Wide
------------------------------------------------------
> -----------------------
Number of observations           90,828   ->   3,132  
>      
Number of variables                   6   ->   61     
>      
j variable (29 values)             date   ->   (droppe
> d)
xij variables:
                              cases_cum   ->   cases_c
> um1 cases_cum2 ... cases_cum29
                             deaths_cum   ->   deaths_
> cum1 deaths_cum2 ... deaths_cum29
------------------------------------------------------
> -----------------------

. 
. ** Save file 
. save ${data}working/covid_cleaned_wide.dta, replace 
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/covid_cleaned_wide.dta saved

. clear

. 
. //--------------------------------------------------
> --
. // STEP 3: Import and Clean ACS Micro Data via IPUMS
>  
. //--------------------------------------------------
> --
. 
. ** Load data 
. forvalues y = 2015(1)2023 {
  2.         
.         ** Import CSV
.         import delimited using "${data}acs/acs_`y'",
>  varnames(1) clear case(lower)
  3.         
.         ** Save as temporary data 
.         tempfile acs_`y'
  4.         save `acs_`y''
  5.         clear 
  6.         
. } // END YEAR LOOP 
(encoding automatically selected: ISO-8859-1)
(57 vars, 2,997,503 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000004
    > .tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(57 vars, 3,007,847 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000005
    > .tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(57 vars, 3,038,696 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000006
    > .tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(57 vars, 3,060,442 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000007
    > .tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(57 vars, 3,087,291 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000008
    > .tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(57 vars, 2,454,160 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000009
    > .tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(57 vars, 3,092,079 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000a
    > .tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(55 vars, 3,190,848 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000b
    > .tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(55 vars, 3,228,659 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000c
    > .tmp saved as .dta format

. 
. ** Append data 
. forvalues y = 2015(1)2023 {
  2.         
.         append using `acs_`y''  
  3.         
. } // END YEAR LOOP 
(variable cbserial was long, now double to
       accommodate using data's values)

. 
. ** Des 
. tab year 

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       2015 |  2,997,503       11.04       11.04
       2016 |  3,007,847       11.08       22.11
       2017 |  3,038,696       11.19       33.30
       2018 |  3,060,442       11.27       44.57
       2019 |  3,087,291       11.37       55.94
       2020 |  2,454,160        9.04       64.98
       2021 |  3,092,079       11.39       76.36
       2022 |  3,190,848       11.75       88.11
       2023 |  3,228,659       11.89      100.00
------------+-----------------------------------
      Total | 27,157,525      100.00

. 
. ** Define # of adults and kids in HHs 
. gen adult = age >= 18 

. gen child = age < 18 

. bysort year serial: gen hh_size = _N 

. bysort year serial: egen hh_adult_ct = total(adult)

. bysort year serial: egen hh_child_ct = total(child)

. 
. ** Sample 18+
. drop if child == 1 
(5,629,869 observations deleted)

. drop child adult 

. 
. ** Sample not living abroad last year 
. drop if migplac1 > 56 
(108,862 observations deleted)

. drop if migrate1 == 4 
(0 observations deleted)

. 
. ** Rename variables 
. rename statefip state_fips_d

. rename countyfip county_fips_d 

. 
. ** Set up origin data 
. fre migrate1

migrate1
------------------------------------------------------
> -----
              |      Freq.    Percent      Valid      
>  Cum.
--------------+---------------------------------------
> -----
Valid   1     |   1.92e+07      89.51      89.51      
> 89.51
        2     |    1809920       8.45       8.45      
> 97.96
        3     |     436745       2.04       2.04     1
> 00.00
        Total |   2.14e+07     100.00     100.00      
>      
------------------------------------------------------
> -----

. drop migrate1d

. tab migplac1

   migplac1 |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 | 19,172,129       89.51       89.51
          1 |     31,329        0.15       89.66
          2 |      5,825        0.03       89.68
          4 |     54,912        0.26       89.94
          5 |     21,714        0.10       90.04
          6 |    260,673        1.22       91.26
          8 |     52,539        0.25       91.50
          9 |     21,577        0.10       91.61
         10 |      5,369        0.03       91.63
         11 |      8,664        0.04       91.67
         12 |    152,989        0.71       92.38
         13 |     71,263        0.33       92.72
         15 |      9,845        0.05       92.76
         16 |     13,536        0.06       92.83
         17 |     86,306        0.40       93.23
         18 |     47,941        0.22       93.45
         19 |     21,469        0.10       93.55
         20 |     22,338        0.10       93.66
         21 |     31,888        0.15       93.81
         22 |     28,776        0.13       93.94
         23 |      7,911        0.04       93.98
         24 |     40,223        0.19       94.17
         25 |     48,684        0.23       94.39
         26 |     65,444        0.31       94.70
         27 |     35,177        0.16       94.86
         28 |     16,994        0.08       94.94
         29 |     45,200        0.21       95.15
         30 |      7,453        0.03       95.19
         31 |     13,567        0.06       95.25
         32 |     24,785        0.12       95.37
         33 |      8,787        0.04       95.41
         34 |     50,561        0.24       95.64
         35 |     12,299        0.06       95.70
         36 |    118,674        0.55       96.26
         37 |     70,555        0.33       96.59
         38 |      5,884        0.03       96.61
         39 |     81,541        0.38       96.99
         40 |     28,921        0.14       97.13
         41 |     36,246        0.17       97.30
         42 |     76,201        0.36       97.65
         44 |      6,551        0.03       97.68
         45 |     33,552        0.16       97.84
         46 |      6,067        0.03       97.87
         47 |     48,061        0.22       98.09
         48 |    197,912        0.92       99.02
         49 |     25,798        0.12       99.14
         50 |      4,106        0.02       99.16
         51 |     64,560        0.30       99.46
         53 |     64,790        0.30       99.76
         54 |     10,532        0.05       99.81
         55 |     35,653        0.17       99.98
         56 |      5,023        0.02      100.00
------------+-----------------------------------
      Total | 21,418,794      100.00

. rename migplac1 state_fips_o

. tab migcounty1

 migcounty1 |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 | 19,952,847       93.16       93.16
          1 |     35,752        0.17       93.32
          3 |     58,525        0.27       93.60
          5 |     21,286        0.10       93.70
          7 |     13,720        0.06       93.76
          9 |     11,958        0.06       93.82
         11 |     23,663        0.11       93.93
         13 |     53,927        0.25       94.18
         15 |      7,126        0.03       94.21
         17 |     21,840        0.10       94.31
         19 |     24,348        0.11       94.43
         20 |      2,061        0.01       94.44
         21 |     12,848        0.06       94.50
         23 |      7,725        0.04       94.53
         25 |     21,090        0.10       94.63
         27 |     15,274        0.07       94.70
         29 |     32,454        0.15       94.85
         31 |     57,529        0.27       95.12
         33 |     33,851        0.16       95.28
         35 |     24,912        0.12       95.40
         37 |     72,280        0.34       95.73
         39 |     10,381        0.05       95.78
         41 |      8,696        0.04       95.82
         43 |      8,893        0.04       95.86
         45 |      5,998        0.03       95.89
         47 |     22,821        0.11       96.00
         49 |     21,522        0.10       96.10
         51 |     17,488        0.08       96.18
         53 |     17,759        0.08       96.26
         55 |     12,676        0.06       96.32
         57 |     18,309        0.09       96.41
         59 |     30,944        0.14       96.55
         61 |     31,725        0.15       96.70
         63 |     12,421        0.06       96.76
         65 |     18,670        0.09       96.85
         67 |     29,982        0.14       96.99
         69 |      4,036        0.02       97.01
         71 |     27,649        0.13       97.13
         73 |     36,959        0.17       97.31
         75 |     11,968        0.06       97.36
         77 |      8,293        0.04       97.40
         79 |      7,681        0.04       97.44
         81 |     30,275        0.14       97.58
         83 |      9,053        0.04       97.62
         85 |     28,918        0.14       97.76
         87 |      6,680        0.03       97.79
         89 |     10,158        0.05       97.83
         91 |     15,565        0.07       97.91
         93 |      4,960        0.02       97.93
         95 |     19,883        0.09       98.02
         97 |     19,460        0.09       98.11
         99 |     19,554        0.09       98.21
        101 |     14,457        0.07       98.27
        103 |     18,351        0.09       98.36
        105 |      7,421        0.03       98.39
        107 |      5,600        0.03       98.42
        109 |     10,761        0.05       98.47
        111 |     14,844        0.07       98.54
        113 |     30,918        0.14       98.68
        115 |      4,818        0.02       98.71
        117 |      7,798        0.04       98.74
        119 |     14,739        0.07       98.81
        121 |     10,181        0.05       98.86
        123 |      3,671        0.02       98.88
        125 |      9,036        0.04       98.92
        127 |      2,348        0.01       98.93
        129 |      1,814        0.01       98.94
        133 |      5,313        0.02       98.96
        135 |      7,844        0.04       99.00
        139 |      5,952        0.03       99.03
        141 |      6,936        0.03       99.06
        143 |      4,286        0.02       99.08
        145 |      1,975        0.01       99.09
        147 |      2,327        0.01       99.10
        149 |      2,146        0.01       99.11
        151 |      1,900        0.01       99.12
        153 |      5,155        0.02       99.14
        157 |     11,532        0.05       99.20
        159 |        751        0.00       99.20
        160 |        149        0.00       99.20
        161 |      4,716        0.02       99.22
        163 |     13,817        0.06       99.29
        165 |      2,418        0.01       99.30
        167 |      5,023        0.02       99.32
        169 |        850        0.00       99.33
        171 |        529        0.00       99.33
        173 |        264        0.00       99.33
        179 |      1,879        0.01       99.34
        183 |     11,521        0.05       99.39
        185 |        871        0.00       99.40
        187 |      2,303        0.01       99.41
        189 |      6,599        0.03       99.44
        191 |        759        0.00       99.44
        197 |      3,401        0.02       99.46
        201 |     29,158        0.14       99.59
        209 |      2,664        0.01       99.60
        215 |      3,046        0.01       99.62
        223 |        758        0.00       99.62
        227 |        946        0.00       99.63
        245 |      3,068        0.01       99.64
        251 |      1,020        0.00       99.65
        257 |        850        0.00       99.65
        303 |      3,247        0.02       99.67
        309 |      2,351        0.01       99.68
        313 |        456        0.00       99.68
        329 |      1,177        0.01       99.68
        339 |      3,176        0.01       99.70
        355 |      2,646        0.01       99.71
        367 |        977        0.00       99.72
        375 |      1,001        0.00       99.72
        381 |      1,199        0.01       99.73
        423 |      1,497        0.01       99.73
        439 |     14,652        0.07       99.80
        441 |      1,419        0.01       99.81
        451 |        952        0.00       99.81
        453 |     12,549        0.06       99.87
        479 |      1,301        0.01       99.88
        485 |      1,288        0.01       99.88
        491 |      4,036        0.02       99.90
        510 |     10,140        0.05       99.95
        550 |      1,187        0.01       99.95
        650 |      1,031        0.00       99.96
        700 |      1,438        0.01       99.97
        710 |        466        0.00       99.97
        760 |      2,799        0.01       99.98
        810 |      3,933        0.02      100.00
------------+-----------------------------------
      Total | 21,418,794      100.00

. rename migcounty1 county_fips_o

. 
. ** Use migrate1 to update values 
. 
. ** Within same house 
. replace state_fips_o = state_fips_d if migrate1 == 1
(19,172,129 real changes made)

. replace county_fips_o = county_fips_d if migrate1 ==
>  1 
(11,640,515 real changes made)

. 
. ** Within same state 
. replace state_fips_o = state_fips_d if migrate1 == 2
(0 real changes made)

. 
. ** Generate county IDS 
. foreach x in "o" "d" {
  2.         
.         make_fips state_fips_`x' county_fips_`x', ge
> n(fips_`x')
  3. 
. }

. 
. ** Check for within-state migration 
. gen same_county = fips_o == fips_d 

. tab year same_county

           |      same_county
      year |         0          1 |     Total
-----------+----------------------+----------
      2015 |    89,492  2,245,481 | 2,334,973 
      2016 |    91,109  2,255,901 | 2,347,010 
      2017 |    93,553  2,278,348 | 2,371,901 
      2018 |    96,080  2,306,022 | 2,402,102 
      2019 |    96,088  2,344,171 | 2,440,259 
      2020 |    71,827  1,877,155 | 1,948,982 
      2021 |    97,600  2,361,518 | 2,459,118 
      2022 |   106,231  2,430,426 | 2,536,657 
      2023 |    98,226  2,479,566 | 2,577,792 
-----------+----------------------+----------
     Total |   840,206 20,578,588 |21,418,794 

. tab year same_county if migrate1 == 2

           |      same_county
      year |         0          1 |     Total
-----------+----------------------+----------
      2015 |    42,597    172,956 |   215,553 
      2016 |    43,823    172,091 |   215,914 
      2017 |    45,058    174,386 |   219,444 
      2018 |    46,477    173,182 |   219,659 
      2019 |    46,329    168,101 |   214,430 
      2020 |    34,625    119,307 |   153,932 
      2021 |    46,470    148,925 |   195,395 
      2022 |    50,584    141,717 |   192,301 
      2023 |    47,498    135,794 |   183,292 
-----------+----------------------+----------
     Total |   403,461  1,406,459 | 1,809,920 

. 
. ** Tag HH head 
. gen byte hh_head = (relate == 1)

. 
. ** Compress file 
. compress 
  variable state_fips_o was int now byte
  variable hh_size was float now byte
  variable hh_adult_ct was float now byte
  variable hh_child_ct was float now byte
  variable same_county was float now byte
  (278,444,322 bytes saved)

. 
. ** Save 
. save "${data}working/acs_migration_file", replace 
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/acs_migration_file.dta saved

. 
. // Keep only observations with valid origin/destinat
> ion counties and YEAR
. drop if missing(year) | missing(fips_o) | missing(fi
> ps_d)
(0 observations deleted)

. 
. // Clean income (treat missing as 0; keep negative v
> alues as reported)
. replace inctot = 0 if missing(inctot)
(0 real changes made)

. gen double income_wt = inctot * perwt

. label var income_wt "Person income (INCTOT) weighted
>  by PERWT"

. 
. // --- Persons + income totals by origin/destination
> /year
. preserve

. keep year fips_o fips_d perwt income_wt

. collapse (sum) persons=perwt income_total=income_wt,
>  by(year fips_o fips_d)

. tempfile acs_pi

. save `acs_pi'
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000e
    > .tmp saved as .dta format

. restore

. 
. // --- Households by origin/destination/year
. // Use HHWT among household heads (RELATE==1) if ava
> ilable; else PERNUM==1 fallback.
. 
. preserve

. keep if hh_head
(10,269,992 observations deleted)

. keep year fips_o fips_d hhwt

. collapse (sum) households=hhwt, by(year fips_o fips_
> d)

. tempfile acs_hh

. save `acs_hh'
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000g
    > .tmp saved as .dta format

. restore

. 
. // --- Merge persons/income with households
. use `acs_pi', clear

. merge 1:1 year fips_o fips_d using `acs_hh', nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                        45,163
        from master                    45,163  
        from using                          0  

    Matched                           162,899  
    -----------------------------------------

. 
. label var persons "Estimated number of persons (sum 
> PERWT)"

. label var households "Estimated number of households
>  (sum HHWT among heads)"

. label var income_total "Estimated total personal inc
> ome (sum INCTOT*PERWT)"

. 
. // --- Derive state/county components for merges wit
> h name crosswalk
. gen int state_fips_o  = floor(fips_o/1000)

. gen int county_fips_o = mod(fips_o,1000)

. gen int state_fips_d  = floor(fips_d/1000)

. gen int county_fips_d = mod(fips_d,1000)

. 
. label var state_fips_o "State FIPS (origin)"

. label var county_fips_o "County FIPS (origin)"

. label var state_fips_d "State FIPS (destination)"

. label var county_fips_d "County FIPS (destination)"

. 
. // --- Merge in names (from NHGIS IDs snapshot)
. preserve

. use "${data}working/ids", clear

. rename (state_fips county_fips state_name county_nam
> e) (state_fips_o county_fips_o state_name_o county_n
> ame_o)

. tempfile ids_o

. save `ids_o'
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000i
    > .tmp saved as .dta format

. keep state_fips_o state_name_o 

. duplicates drop, force 
options not allowed
r(101);

end of do-file

r(101);

. 
. . keep state_fips_o state_name_o 
variable state_name_o not found
r(111);

. 
. 
. 
. duplicates drop, force 
options not allowed
r(101);

. help duplicates drop

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_00001l
> .tmp"

. /***************************************************
> **************************
> * Program:                      01_clean_data.do 
> * Author(s):            John Iselin 
> * Date Updated:         October 19, 2025
> 
> *** Demographic data via IPUMS NHGIS 
> ** Via https://www.nhgis.org/
> ** Downloaded on October 19, 2025
> ** EXTRACT DETAILS in "nhgis0031_ts_nominal_county_c
> odebook"
> 
> *** Economic data via BEA Regional Economic Accounts
>  (CAINC1)
> ** Via https://apps.bea.gov/regional/downloadzip.htm
> 
> *** ACS individual data via IPUMS USA 
> ** Via https://usa.ipums.org/usa/index.shtml
> ** Downloaded via R program 
> 
> *** IRS SOI County-Level Migration Files
> ** Via https://www.irs.gov/statistics/soi-tax-stats-
> migration-data
> 
> *** IRS SOI County-Level Files
> ** Via https://www.irs.gov/statistics/soi-tax-stats-
> county-data
> 
> *** NYTimes COVID Cases and Deaths 
> ** Via https://github.com/nytimes/covid-19-data
> 
> ****************************************************
> ***************************/
. 
. ** Start log file 
. capture log close log_01

. log using "${logs}01_log_data_clean_${pr_name}_${dat
> e}", replace text name(log_01)
------------------------------------------------------
      name:  log_01
       log:  C:/Users/ji252/Documents/GitHub/multnomah
> -county-tax/code/logs/01_log_data_clean_multnomah_20
> 25-12-15.log
  log type:  text
 opened on:  15 Dec 2025, 16:25:12

. 
. //--------------------------------------------------
. // STEP 0: Preliminary Set-Up 
. //--------------------------------------------------
. 
. ** Define labels 
. label define lb_move_type       0 "ERROR"           
>                     ///
>                                                     
>     1 "Non-movers"                  ///
>                                                     
>     2 "All movers"                  ///
>                                                     
>     3 "Domestic movers"             ///
>                                                     
>     4 "Within-state movers" ///
>                                                     
>     5 "Inter-state movers"  ///
>                                                     
>     6 "Foreign movers", modify

.                                                     
>     
. label define lb_agi             1 "Under $1"        
>             ///
>                                                     
>     2 "$1 under $10K"               ///
>                                                     
>     3 "$10K under $25K"             ///
>                                                     
>     4 "$25K under $50K"             ///
>                                                     
>     5 "$50K under $75K"             ///
>                                                     
>     6 "$75K under $100K"    ///
>                                                     
>     7 "$100K under $200K"   ///
>                                                     
>     8 "$200K or more", modify                       
>                                 

. 
. 
. ** Define Programs
. 
. ** Make FIPS code from state and county fips codes 
. capture program drop make_fips

. program define make_fips
  1.     syntax varlist(min=2 max=2 numeric), GEN(name
> )
  2. 
.     quietly {
  3.         tempvar s c
  4. 
.         local v1 : word 1 of `varlist'
  5.         local v2 : word 2 of `varlist'
  6. 
.         gen `s' = string(`v1', "%02.0f")
  7.         gen `c' = string(`v2', "%03.0f")
  8. 
.         gen `gen' = real(`s' + `c')
  9.     }
 10. end

. 
. ** Reclassify suppressed values as 0 
. 
. capture program drop unsuppress

. program define unsuppress
  1.     syntax varlist
  2. 
.     foreach v of varlist `varlist' {
  3.         replace `v' = 0 if `v' == -1
  4.     }
  5. end

. 
. //--------------------------------------------------
. // STEP -1: Acquire raw data (automated where possib
> le)
. //--------------------------------------------------
. /*
> This block downloads public-use source data directly
>  from official URLs if not present locally.
> 
> Automated downloads included:
>   - IRS SOI county-to-county migration: countyinflow
> YYZZ.csv / countyoutflowYYZZ.csv
>   - IRS SOI county data: YYincyallagi.csv
>   - BEA Regional Economic Accounts (CAINC1): CAINC1.
> zip (unzips to CAINC1__ALL_AREAS_*.csv and related f
> iles)
> 
> */
. 
. * Ensure expected directory structure exists
. capture mkdir "${data}"

. capture mkdir "${data}working"

. capture mkdir "${data}demographic"

. capture mkdir "${data}demographic/CAINC1"

. capture mkdir "${data}demographic/nhgis0031_csv"

. capture mkdir "${data}irs"

. capture mkdir "${data}covid"

. 
. * ----------------------------
. * IRS SOI: migration files
. * ----------------------------
. local irs_base "https://www.irs.gov/pub/irs-soi"

. 
. forvalues yy = 15/21 {
  2.     local zz = `yy' + 1
  3.     local fn_out "countyoutflow`yy'`zz'.csv"
  4.     local fn_in  "countyinflow`yy'`zz'.csv"
  5. 
.     capture confirm file "${data}irs/`fn_out'"
  6.     if _rc {
  7.         di as txt "Downloading (IRS SOI) `fn_out'
>  ..."
  8.         copy "`irs_base'/`fn_out'" "${data}irs/`f
> n_out'", replace
  9.     }
 10. 
.     capture confirm file "${data}irs/`fn_in'"
 11.     if _rc {
 12.         di as txt "Downloading (IRS SOI) `fn_in' 
> ..."
 13.         copy "`irs_base'/`fn_in'" "${data}irs/`fn
> _in'", replace
 14.     }
 15. }

. 
. * ----------------------------
. * IRS SOI: county income (AGI) files
. * ----------------------------
. forvalues yy = 15/22 {
  2.     local fn_inc "`yy'incyallagi.csv"
  3. 
.     capture confirm file "${data}irs/`fn_inc'"
  4.     if _rc {
  5.         di as txt "Downloading (IRS SOI) `fn_inc'
>  ..."
  6.         copy "`irs_base'/`fn_inc'" "${data}irs/`f
> n_inc'", replace
  7.     }
  8. }

. 
. * ----------------------------
. * BEA Regional: CAINC1.zip
. * ----------------------------
. local bea_dir "${data}demographic/CAINC1"

. local bea_url "https://apps.bea.gov/regional/zip/CAI
> NC1.zip"

. local bea_zip "`bea_dir'/CAINC1.zip"

. 
. * If we don't already have a CAINC1 "_ALL_AREAS" fil
> e, download + unzip the ZIP.
. local bea_files : dir "`bea_dir'" files "CAINC1__ALL
> _AREAS_*.csv"

. if "`bea_files'"=="" {
.     local bea_files : dir "`bea_dir'" files "CAINC1_
> _ALL_STATES_*.csv"
. }

. 
. if "`bea_files'"=="" {
.     di as txt "Downloading (BEA) CAINC1.zip ..."
Downloading (BEA) CAINC1.zip ...
.     copy "`bea_url'" "`bea_zip'", replace
(file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/demographic/CAINC1/CAINC1.zip not
    found)
. 
.     local curdir "`c(pwd)'"
.     cd "`bea_dir'"
C:\Users\ji252\Documents\GitHub\multnomah-county-tax\d
> ata\demographic\CAINC1
.     unzipfile "CAINC1.zip", replace
    inflating: CAINC1__ALL_AREAS_1969_2023.csv
    inflating: CAINC1__definition.xml
    inflating: CAINC1__Footnotes.html
    inflating: CAINC1_AK_1969_2023.csv
    inflating: CAINC1_AL_1969_2023.csv
    inflating: CAINC1_AR_1969_2023.csv
    inflating: CAINC1_AZ_1969_2023.csv
    inflating: CAINC1_CA_1969_2023.csv
    inflating: CAINC1_CO_1969_2023.csv
    inflating: CAINC1_CSA_1969_2023.csv
    inflating: CAINC1_CT_1969_2023.csv
    inflating: CAINC1_DC_1969_2023.csv
    inflating: CAINC1_DE_1969_2023.csv
    inflating: CAINC1_FL_1969_2023.csv
    inflating: CAINC1_GA_1969_2023.csv
    inflating: CAINC1_HI_1969_2023.csv
    inflating: CAINC1_IA_1969_2023.csv
    inflating: CAINC1_ID_1969_2023.csv
    inflating: CAINC1_IL_1969_2023.csv
    inflating: CAINC1_IN_1969_2023.csv
    inflating: CAINC1_KS_1969_2023.csv
    inflating: CAINC1_KY_1969_2023.csv
    inflating: CAINC1_LA_1969_2023.csv
    inflating: CAINC1_MA_1969_2023.csv
    inflating: CAINC1_MD_1969_2023.csv
    inflating: CAINC1_MDIV_1969_2023.csv
    inflating: CAINC1_ME_1969_2023.csv
    inflating: CAINC1_MI_1969_2023.csv
    inflating: CAINC1_MIC_1969_2023.csv
    inflating: CAINC1_MN_1969_2023.csv
    inflating: CAINC1_MO_1969_2023.csv
    inflating: CAINC1_MS_1969_2023.csv
    inflating: CAINC1_MSA_1969_2023.csv
    inflating: CAINC1_MT_1969_2023.csv
    inflating: CAINC1_NC_1969_2023.csv
    inflating: CAINC1_ND_1969_2023.csv
    inflating: CAINC1_NE_1969_2023.csv
    inflating: CAINC1_NH_1969_2023.csv
    inflating: CAINC1_NJ_1969_2023.csv
    inflating: CAINC1_NM_1969_2023.csv
    inflating: CAINC1_NV_1969_2023.csv
    inflating: CAINC1_NY_1969_2023.csv
    inflating: CAINC1_OH_1969_2023.csv
    inflating: CAINC1_OK_1969_2023.csv
    inflating: CAINC1_OR_1969_2023.csv
    inflating: CAINC1_PA_1969_2023.csv
    inflating: CAINC1_PORT_1969_2023.csv
    inflating: CAINC1_RI_1969_2023.csv
    inflating: CAINC1_SC_1969_2023.csv
    inflating: CAINC1_SD_1969_2023.csv
    inflating: CAINC1_TN_1969_2023.csv
    inflating: CAINC1_TX_1969_2023.csv
    inflating: CAINC1_US_1969_2023.csv
    inflating: CAINC1_UT_1969_2023.csv
    inflating: CAINC1_VA_1969_2023.csv
    inflating: CAINC1_VT_1969_2023.csv
    inflating: CAINC1_WA_1969_2023.csv
    inflating: CAINC1_WI_1969_2023.csv
    inflating: CAINC1_WV_1969_2023.csv
    inflating: CAINC1_WY_1969_2023.csv

successfully unzipped CAINC1.zip to current directory
total processed:  60
        skipped:  0
      extracted:  60
.     cd "`curdir'"
C:\Users\ji252\Documents\GitHub\multnomah-county-tax
. 
.     capture erase "`bea_zip'"
. }

. 
. * ----------------------------
. * NYTimes COVID Data 
. * ----------------------------
. local covid_dir "${data}covid"

. local covid_url "https://raw.githubusercontent.com/n
> ytimes/covid-19-data/master/us-counties.csv"

. 
. * If we don't already have a COVID file, download.
. local covid_file : dir "`covid_dir'" files "covid_ny
> t.csv"

. if "`covid_file'"=="" {
.     local covid_file : dir "`covid_dir'" files "covi
> d_nyt.csv"
. }

. 
. if "`covid_file'"=="" {
.     di as txt "Downloading (COVID)  ..."
Downloading (COVID)  ...
.     copy "`covid_url'" "`covid_dir'/covid_nyt.csv", 
> replace
. }

. 
. 
. 
. //--------------------------------------------------
> ---------
. // STEP 1: Import and Clean Demographic Data via IPU
> MS + BEA  
. //--------------------------------------------------
> ---------
. 
. ** Import data 
. import delimited        ///
>         "${data}demographic/nhgis0031_csv/nhgis0031_
> ts_nominal_county.csv", clear 
(encoding automatically selected: ISO-8859-1)
(15 vars, 54,673 obs)

. 
. ** Describe data 
. des 

Contains data
 Observations:        54,673                  
    Variables:            15                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
gisjoin         str8    %9s                   GISJOIN
year            str9    %9s                   YEAR
state           str20   %20s                  STATE
statefp         byte    %8.0g                 STATEFP
statenh         int     %8.0g                 STATENH
county          str46   %46s                  COUNTY
countyfp        int     %8.0g                 COUNTYFP
countynh        int     %8.0g                 COUNTYNH
name            str59   %59s                  NAME
av0aa           long    %12.0g                AV0AA
d15aa           long    %12.0g                D15AA
d15ab           long    %12.0g                D15AB
b79aa           long    %12.0g                B79AA
av0aam          long    %12.0g                AV0AAM
b79aam          long    %8.0g                 B79AAM
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.

. 
. ** Drop unnecc variables 
. drop gisjoin statenh countynh name 

. 
. ** Rename 
. rename state state_name 

. rename statefp state_fips 

. rename county county_name 

. rename countyfp county_fips 

. rename av0aa population 

. rename d15aa pop_urban 

. rename d15ab pop_rural 

. rename b79aa median_income 

. rename av0aam population_margin

. rename b79aam median_income_margin 

. 
. ** Create urban percent 
. gen percent_urban = pop_urban / population
(45,090 missing values generated)

. 
. ** Label variables 
. label var state_name "State name"

. label var state_fips "State FIPS code"

. label var county_name "County name"

. label var county_fips "County FIPS code"

. label var population "Population count"

. label var pop_rural "Rural population count"

. label var pop_urban "Urban population count"

. label var percent_urban "Percent of population in ur
> ban areas"

. label var median_income "Median household income (pr
> ior year)"

. label var population_margin "ACS margin for error: p
> opulation"

. label var median_income_margin "ACS margin for error
> : median income"

. 
. ** Save as temporary file 
. tempfile demo

. save `demo'
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000001
    > .tmp saved as .dta format

. 
. ** Create three datasets 
. 
. ** (1) Basic state and county IDs 
. keep if year == "2020" 
(51,452 observations deleted)

. keep state* county* 

. 
. ** Make FIPS 
. make_fips state_fips county_fips, gen(fips)

. 
. ** Save as state and county Ids 
. save "${data}working/ids", replace 
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/ids.dta saved

. clear  

. 
. ** (2) Population data 
. use `demo'

. keep if !missing(pop_urban) 
(45,090 observations deleted)

. tab year 

       YEAR |      Freq.     Percent        Cum.
------------+-----------------------------------
       2000 |      3,141       32.78       32.78
       2010 |      3,221       33.61       66.39
       2020 |      3,221       33.61      100.00
------------+-----------------------------------
      Total |      9,583      100.00

. 
. ** Keep 2020 
. keep if year == "2020"
(6,362 observations deleted)

. drop year median_income* population_margin

. 
. ** Make FIPS 
. make_fips state_fips county_fips, gen(fips)

. 
. ** Save data
. save "${data}working/population_2020", replace 
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/population_2020.dta saved

. clear  

. 
. ** (3) 2015-2019 ACS data 
. use `demo'

. keep if !missing(median_income) 
(6,447 observations deleted)

. tab year 

       YEAR |      Freq.     Percent        Cum.
------------+-----------------------------------
       2000 |      3,141        6.51        6.51
  2006-2010 |      3,221        6.68       13.19
  2007-2011 |      3,221        6.68       19.87
  2008-2012 |      3,221        6.68       26.55
  2009-2013 |      3,221        6.68       33.23
  2010-2014 |      3,220        6.68       39.91
  2011-2015 |      3,219        6.67       46.58
  2012-2016 |      3,220        6.68       53.26
  2013-2017 |      3,220        6.68       59.93
  2014-2018 |      3,219        6.67       66.61
  2015-2019 |      3,220        6.68       73.29
  2016-2020 |      3,220        6.68       79.96
  2017-2021 |      3,220        6.68       86.64
  2018-2022 |      3,221        6.68       93.32
  2019-2023 |      3,222        6.68      100.00
------------+-----------------------------------
      Total |     48,226      100.00

. 
. ** Keep 2020 
. keep if year == "2015-2019"
(45,006 observations deleted)

. drop year pop_rural pop_urban percent_urban

. 
. ** Make FIPS 
. make_fips state_fips county_fips, gen(fips)

. 
. ** Save data
. save "${data}working/acs_2015_2019_data", replace 
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/acs_2015_2019_data.dta saved

. 
. ** Rename for merge 
. rename population population_acs

. 
. ** Merge with other data 
. merge 1:1 state_fips county_fips using "${data}worki
> ng/population_2020",                ///
>         keep(match) nogen 

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                             3,219  
    -----------------------------------------

. 
. ** Save data
. save "${data}working/demographics_2020", replace 
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/demographics_2020.dta saved

. 
. ** Load BEA Data 
. import delimited "${data}demographic/CAINC1/CAINC1__
> ALL_AREAS_1969_2023.csv",   ///
>         clear 
(encoding automatically selected: ISO-8859-1)
(63 vars, 9,604 obs)

. 
. ** Drop unnecc variables 
. drop region tablename industryclassification unit ge
> oname 

. 
. ** Drop empty cells 
. drop if missing(linecode)
(4 observations deleted)

. 
. ** Update names 
. rename geofips fips 

. replace fips = subinstr(fips, `"""', "", .)
(9,600 real changes made)

. destring fips, replace 
fips: all characters numeric; replaced as long

. 
. ** Keep population and per-capita income, dropping p
> ersonal income (total)
. tab description linecode

                      |  LineCode
          Description |         1 |     Total
----------------------+-----------+----------
Per capita personal.. |         0 |     3,200 
Personal income (th.. |     3,200 |     3,200 
Population (persons.. |         0 |     3,200 
----------------------+-----------+----------
                Total |     3,200 |     9,600 


                      |  LineCode
          Description |         2 |     Total
----------------------+-----------+----------
Per capita personal.. |         0 |     3,200 
Personal income (th.. |         0 |     3,200 
Population (persons.. |     3,200 |     3,200 
----------------------+-----------+----------
                Total |     3,200 |     9,600 


                      |  LineCode
          Description |         3 |     Total
----------------------+-----------+----------
Per capita personal.. |     3,200 |     3,200 
Personal income (th.. |         0 |     3,200 
Population (persons.. |         0 |     3,200 
----------------------+-----------+----------
                Total |     3,200 |     9,600 

. drop if linecode == 1   
(3,200 observations deleted)

. drop description

.         
. ** Get V* to be in terms of years 
. ** V9 == 1969 
. forvalues i = 9/63 {
  2.         
.         local j = 1960 + `i'
  3.         rename v`i' value`j'
  4.         
. } // END I LOOP 

. 
. ** Reshape 
. reshape long value, i(fips linecode) j(year)
(j = 1969 1970 1971 1972 1973 1974 1975 1976 1977 1978
>  1979 1980 1981 1982 1983 1984 1985 1986 1987 1988 1
> 989 1990 1991 1992 1993 1994 1995 1996 1997 1998 199
> 9 2000 2001 2002 2003 2004 2005 2006 2007 2008 2009 
> 2010 2011 2012 2013 2014 2015 2016 2017 2018 2019 20
> 20 2021 2022 2023)

Data                               Wide   ->   Long
------------------------------------------------------
> -----------------------
Number of observations            6,400   ->   352,000
>      
Number of variables                  57   ->   4      
>      
j variable (55 values)                    ->   year
xij variables:
      value1969 value1970 ... value2023   ->   value
------------------------------------------------------
> -----------------------

. reshape wide value, i(fips year ) j(linecode)
(j = 2 3)

Data                               Long   ->   Wide
------------------------------------------------------
> -----------------------
Number of observations          352,000   ->   176,000
>      
Number of variables                   4   ->   4      
>      
j variable (2 values)          linecode   ->   (droppe
> d)
xij variables:
                                  value   ->   value2 
> value3
------------------------------------------------------
> -----------------------

. 
. ** Keep years 
. keep if inrange(year, 2015, 2023)
(147,200 observations deleted)

. 
. ** Rename values 
. rename value2 population 

. rename value3 per_capita_income

. 
. ** Drop if missing values 
. drop if population == "(NA)"
(239 observations deleted)

. 
. ** Keep only counties with all observations 
. bysort fips: gen ct = _N 

. tab ct

         ct |      Freq.     Percent        Cum.
------------+-----------------------------------
          4 |          8        0.03        0.03
          5 |          5        0.02        0.05
          9 |     28,548       99.95      100.00
------------+-----------------------------------
      Total |     28,561      100.00

. keep if ct == 9
(13 observations deleted)

. drop ct

. 
. ** Destring 
. destring population, replace 
population: all characters numeric; replaced as long

. destring per_capita_income, replace 
per_capita_income: all characters numeric; replaced as
>  long

. 
. ** Save data
. save "${data}working/bea_economics", replace 
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/bea_economics.dta saved

. 
. //--------------------------------------------------
> --
. // STEP 2: Import and Clean NYTimes COVID-19 Data 
. //--------------------------------------------------
> --
.  
. ** Import data 
. import delimited using "${data}covid/covid_nyt.csv",
>  varnames(1) clear case(lower) 
(encoding automatically selected: ISO-8859-1)
(6 vars, 2,502,832 obs)

. 
. ** Describe data 
. des 

Contains data
 Observations:     2,502,832                  
    Variables:             6                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
date            str10   %10s                  
county          str35   %35s                  
state           str24   %24s                  
fips            long    %12.0g                
cases           long    %12.0g                
deaths          long    %8.0g                 
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.

. 
. ** Set up date information 
. generate num_date = date(date, "YMD")

. format num_date %td

. drop date 

. 
. ** Rename 
. rename state state_name 

. rename county county_name 

. rename num_date date 

. 
. ** keep only counties 
. keep if !missing(fips)
(23,678 observations deleted)

. 
. ** Keep in 50 states 
. drop if state_name == "Puerto Rico"
(57,605 observations deleted)

. drop if state_name == "Virgin Islands"
(2,304 observations deleted)

. drop if state_name == "Northern Mariana Islands"
(1,452 observations deleted)

. 
. ** Sort 
. sort date fips 

. 
. ** Create panel 
. xtset fips date

Panel variable: fips (unbalanced)
 Time variable: date, 21jan2020 to 13may2022, but
                with gaps
         Delta: 1 day

. 
. ** Fill in panel 
. tsfill, full 

. 
. ** Fill in missing values 
. replace cases = 0 if missing(cases)
(228,991 real changes made)

. replace deaths = 0 if missing(deaths)
(228,991 real changes made)

. 
. ** Preserve data 
. preserve 

. 
. ** Preserve fips codes and names 
. keep if !missing(state_name)
(228,991 observations deleted)

. keep if !missing(county_name)
(0 observations deleted)

. duplicates drop fips state_name county_name, force 

Duplicates in terms of fips state_name county_name

(2,414,657 observations deleted)

. 
. ** Save as temporary data 
. tempfile state_county_names 

. save `state_county_names'
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000003
    > .tmp saved as .dta format

. clear 

. 
. ** Restore 
. restore 

. 
. ** Drop and merge in names 
. drop state_name county_name

. merge m:1 fips using `state_county_names', keep(mast
> er match) nogen 

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                         2,646,784  
    -----------------------------------------

. 
. ** Get year, month, day 
. gen year = year(date)

. gen month = month(date)

. gen day = day(date)

. 
. ** Order data 
. order date year month day fips state county cases de
> aths 

. 
. ** Calculate cumulative cases and deaths 
. bysort fips (date): gen cases_cum = sum(cases)

. bysort fips (date): gen deaths_cum = sum(deaths)

. 
. ** Merge population data (2020)
. merge m:1 fips using "${data}working/population_2020
> ", keep(match) nogen  
(variable county_name was str35, now str46 to
       accommodate using data's values)
(variable fips was long, now double to accommodate
       using data's values)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                         2,643,408  
    -----------------------------------------

. 
. ** Save file 
. save ${data}working/covid_cleaned.dta, replace 
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/covid_cleaned.dta saved

. 
. ** Generate Clustering Variables 
. 
. ** Keep one observation per month 
. keep year month fips state_name county_name cases_cu
> m deaths_cum population

. collapse (sum) cases deaths population, by(year mont
> h fips state_name county_name) 

. sort year month fips 

. egen date = group(year month)

. drop year month 

. 
. ** Generate per capita figures
. replace cases = 1000 * cases / population
(82,955 real changes made)

. replace deaths = 1000 * deaths / population
(74,723 real changes made)

. drop population 

. 
. ** Reshape wide 
. reshape wide cases deaths, i(fips state_name county_
> name) j(date)
(j = 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 2
> 0 21 22 23 24 25 26 27 28 29)

Data                               Long   ->   Wide
------------------------------------------------------
> -----------------------
Number of observations           90,828   ->   3,132  
>      
Number of variables                   6   ->   61     
>      
j variable (29 values)             date   ->   (droppe
> d)
xij variables:
                              cases_cum   ->   cases_c
> um1 cases_cum2 ... cases_cum29
                             deaths_cum   ->   deaths_
> cum1 deaths_cum2 ... deaths_cum29
------------------------------------------------------
> -----------------------

. 
. ** Save file 
. save ${data}working/covid_cleaned_wide.dta, replace 
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/covid_cleaned_wide.dta saved

. clear

. 
. //--------------------------------------------------
> --
. // STEP 3: Import and Clean ACS Micro Data via IPUMS
>  
. //--------------------------------------------------
> --
. 
. ** Load data 
. forvalues y = 2015(1)2023 {
  2.         
.         ** Import CSV
.         import delimited using "${data}acs/acs_`y'",
>  varnames(1) clear case(lower)
  3.         
.         ** Save as temporary data 
.         tempfile acs_`y'
  4.         save `acs_`y''
  5.         clear 
  6.         
. } // END YEAR LOOP 
(encoding automatically selected: ISO-8859-1)
(57 vars, 2,997,503 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000004
    > .tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(57 vars, 3,007,847 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000005
    > .tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(57 vars, 3,038,696 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000006
    > .tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(57 vars, 3,060,442 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000007
    > .tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(57 vars, 3,087,291 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000008
    > .tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(57 vars, 2,454,160 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000009
    > .tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(57 vars, 3,092,079 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000a
    > .tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(55 vars, 3,190,848 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000b
    > .tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(55 vars, 3,228,659 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000c
    > .tmp saved as .dta format

. 
. ** Append data 
. forvalues y = 2015(1)2023 {
  2.         
.         append using `acs_`y''  
  3.         
. } // END YEAR LOOP 
(variable cbserial was long, now double to
       accommodate using data's values)

. 
. ** Des 
. tab year 

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       2015 |  2,997,503       11.04       11.04
       2016 |  3,007,847       11.08       22.11
       2017 |  3,038,696       11.19       33.30
       2018 |  3,060,442       11.27       44.57
       2019 |  3,087,291       11.37       55.94
       2020 |  2,454,160        9.04       64.98
       2021 |  3,092,079       11.39       76.36
       2022 |  3,190,848       11.75       88.11
       2023 |  3,228,659       11.89      100.00
------------+-----------------------------------
      Total | 27,157,525      100.00

. 
. ** Define # of adults and kids in HHs 
. gen adult = age >= 18 

. gen child = age < 18 

. bysort year serial: gen hh_size = _N 

. bysort year serial: egen hh_adult_ct = total(adult)

. bysort year serial: egen hh_child_ct = total(child)

. 
. ** Sample 18+
. drop if child == 1 
(5,629,869 observations deleted)

. drop child adult 

. 
. ** Sample not living abroad last year 
. drop if migplac1 > 56 
(108,862 observations deleted)

. drop if migrate1 == 4 
(0 observations deleted)

. 
. ** Rename variables 
. rename statefip state_fips_d

. rename countyfip county_fips_d 

. 
. ** Set up origin data 
. fre migrate1

migrate1
------------------------------------------------------
> -----
              |      Freq.    Percent      Valid      
>  Cum.
--------------+---------------------------------------
> -----
Valid   1     |   1.92e+07      89.51      89.51      
> 89.51
        2     |    1809920       8.45       8.45      
> 97.96
        3     |     436745       2.04       2.04     1
> 00.00
        Total |   2.14e+07     100.00     100.00      
>      
------------------------------------------------------
> -----

. drop migrate1d

. tab migplac1

   migplac1 |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 | 19,172,129       89.51       89.51
          1 |     31,329        0.15       89.66
          2 |      5,825        0.03       89.68
          4 |     54,912        0.26       89.94
          5 |     21,714        0.10       90.04
          6 |    260,673        1.22       91.26
          8 |     52,539        0.25       91.50
          9 |     21,577        0.10       91.61
         10 |      5,369        0.03       91.63
         11 |      8,664        0.04       91.67
         12 |    152,989        0.71       92.38
         13 |     71,263        0.33       92.72
         15 |      9,845        0.05       92.76
         16 |     13,536        0.06       92.83
         17 |     86,306        0.40       93.23
         18 |     47,941        0.22       93.45
         19 |     21,469        0.10       93.55
         20 |     22,338        0.10       93.66
         21 |     31,888        0.15       93.81
         22 |     28,776        0.13       93.94
         23 |      7,911        0.04       93.98
         24 |     40,223        0.19       94.17
         25 |     48,684        0.23       94.39
         26 |     65,444        0.31       94.70
         27 |     35,177        0.16       94.86
         28 |     16,994        0.08       94.94
         29 |     45,200        0.21       95.15
         30 |      7,453        0.03       95.19
         31 |     13,567        0.06       95.25
         32 |     24,785        0.12       95.37
         33 |      8,787        0.04       95.41
         34 |     50,561        0.24       95.64
         35 |     12,299        0.06       95.70
         36 |    118,674        0.55       96.26
         37 |     70,555        0.33       96.59
         38 |      5,884        0.03       96.61
         39 |     81,541        0.38       96.99
         40 |     28,921        0.14       97.13
         41 |     36,246        0.17       97.30
         42 |     76,201        0.36       97.65
         44 |      6,551        0.03       97.68
         45 |     33,552        0.16       97.84
         46 |      6,067        0.03       97.87
         47 |     48,061        0.22       98.09
         48 |    197,912        0.92       99.02
         49 |     25,798        0.12       99.14
         50 |      4,106        0.02       99.16
         51 |     64,560        0.30       99.46
         53 |     64,790        0.30       99.76
         54 |     10,532        0.05       99.81
         55 |     35,653        0.17       99.98
         56 |      5,023        0.02      100.00
------------+-----------------------------------
      Total | 21,418,794      100.00

. rename migplac1 state_fips_o

. tab migcounty1

 migcounty1 |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 | 19,952,847       93.16       93.16
          1 |     35,752        0.17       93.32
          3 |     58,525        0.27       93.60
          5 |     21,286        0.10       93.70
          7 |     13,720        0.06       93.76
          9 |     11,958        0.06       93.82
         11 |     23,663        0.11       93.93
         13 |     53,927        0.25       94.18
         15 |      7,126        0.03       94.21
         17 |     21,840        0.10       94.31
         19 |     24,348        0.11       94.43
         20 |      2,061        0.01       94.44
         21 |     12,848        0.06       94.50
         23 |      7,725        0.04       94.53
         25 |     21,090        0.10       94.63
         27 |     15,274        0.07       94.70
         29 |     32,454        0.15       94.85
         31 |     57,529        0.27       95.12
         33 |     33,851        0.16       95.28
         35 |     24,912        0.12       95.40
         37 |     72,280        0.34       95.73
         39 |     10,381        0.05       95.78
         41 |      8,696        0.04       95.82
         43 |      8,893        0.04       95.86
         45 |      5,998        0.03       95.89
         47 |     22,821        0.11       96.00
         49 |     21,522        0.10       96.10
         51 |     17,488        0.08       96.18
         53 |     17,759        0.08       96.26
         55 |     12,676        0.06       96.32
         57 |     18,309        0.09       96.41
         59 |     30,944        0.14       96.55
         61 |     31,725        0.15       96.70
         63 |     12,421        0.06       96.76
         65 |     18,670        0.09       96.85
         67 |     29,982        0.14       96.99
         69 |      4,036        0.02       97.01
         71 |     27,649        0.13       97.13
         73 |     36,959        0.17       97.31
         75 |     11,968        0.06       97.36
         77 |      8,293        0.04       97.40
         79 |      7,681        0.04       97.44
         81 |     30,275        0.14       97.58
         83 |      9,053        0.04       97.62
         85 |     28,918        0.14       97.76
         87 |      6,680        0.03       97.79
         89 |     10,158        0.05       97.83
         91 |     15,565        0.07       97.91
         93 |      4,960        0.02       97.93
         95 |     19,883        0.09       98.02
         97 |     19,460        0.09       98.11
         99 |     19,554        0.09       98.21
        101 |     14,457        0.07       98.27
        103 |     18,351        0.09       98.36
        105 |      7,421        0.03       98.39
        107 |      5,600        0.03       98.42
        109 |     10,761        0.05       98.47
        111 |     14,844        0.07       98.54
        113 |     30,918        0.14       98.68
        115 |      4,818        0.02       98.71
        117 |      7,798        0.04       98.74
        119 |     14,739        0.07       98.81
        121 |     10,181        0.05       98.86
        123 |      3,671        0.02       98.88
        125 |      9,036        0.04       98.92
        127 |      2,348        0.01       98.93
        129 |      1,814        0.01       98.94
        133 |      5,313        0.02       98.96
        135 |      7,844        0.04       99.00
        139 |      5,952        0.03       99.03
        141 |      6,936        0.03       99.06
        143 |      4,286        0.02       99.08
        145 |      1,975        0.01       99.09
        147 |      2,327        0.01       99.10
        149 |      2,146        0.01       99.11
        151 |      1,900        0.01       99.12
        153 |      5,155        0.02       99.14
        157 |     11,532        0.05       99.20
        159 |        751        0.00       99.20
        160 |        149        0.00       99.20
        161 |      4,716        0.02       99.22
        163 |     13,817        0.06       99.29
        165 |      2,418        0.01       99.30
        167 |      5,023        0.02       99.32
        169 |        850        0.00       99.33
        171 |        529        0.00       99.33
        173 |        264        0.00       99.33
        179 |      1,879        0.01       99.34
        183 |     11,521        0.05       99.39
        185 |        871        0.00       99.40
        187 |      2,303        0.01       99.41
        189 |      6,599        0.03       99.44
        191 |        759        0.00       99.44
        197 |      3,401        0.02       99.46
        201 |     29,158        0.14       99.59
        209 |      2,664        0.01       99.60
        215 |      3,046        0.01       99.62
        223 |        758        0.00       99.62
        227 |        946        0.00       99.63
        245 |      3,068        0.01       99.64
        251 |      1,020        0.00       99.65
        257 |        850        0.00       99.65
        303 |      3,247        0.02       99.67
        309 |      2,351        0.01       99.68
        313 |        456        0.00       99.68
        329 |      1,177        0.01       99.68
        339 |      3,176        0.01       99.70
        355 |      2,646        0.01       99.71
        367 |        977        0.00       99.72
        375 |      1,001        0.00       99.72
        381 |      1,199        0.01       99.73
        423 |      1,497        0.01       99.73
        439 |     14,652        0.07       99.80
        441 |      1,419        0.01       99.81
        451 |        952        0.00       99.81
        453 |     12,549        0.06       99.87
        479 |      1,301        0.01       99.88
        485 |      1,288        0.01       99.88
        491 |      4,036        0.02       99.90
        510 |     10,140        0.05       99.95
        550 |      1,187        0.01       99.95
        650 |      1,031        0.00       99.96
        700 |      1,438        0.01       99.97
        710 |        466        0.00       99.97
        760 |      2,799        0.01       99.98
        810 |      3,933        0.02      100.00
------------+-----------------------------------
      Total | 21,418,794      100.00

. rename migcounty1 county_fips_o

. 
. ** Use migrate1 to update values 
. 
. ** Within same house 
. replace state_fips_o = state_fips_d if migrate1 == 1
(19,172,129 real changes made)

. replace county_fips_o = county_fips_d if migrate1 ==
>  1 
(11,640,515 real changes made)

. 
. ** Within same state 
. replace state_fips_o = state_fips_d if migrate1 == 2
(0 real changes made)

. 
. ** Generate county IDS 
. foreach x in "o" "d" {
  2.         
.         make_fips state_fips_`x' county_fips_`x', ge
> n(fips_`x')
  3. 
. }

. 
. ** Check for within-state migration 
. gen same_county = fips_o == fips_d 

. tab year same_county

           |      same_county
      year |         0          1 |     Total
-----------+----------------------+----------
      2015 |    89,492  2,245,481 | 2,334,973 
      2016 |    91,109  2,255,901 | 2,347,010 
      2017 |    93,553  2,278,348 | 2,371,901 
      2018 |    96,080  2,306,022 | 2,402,102 
      2019 |    96,088  2,344,171 | 2,440,259 
      2020 |    71,827  1,877,155 | 1,948,982 
      2021 |    97,600  2,361,518 | 2,459,118 
      2022 |   106,231  2,430,426 | 2,536,657 
      2023 |    98,226  2,479,566 | 2,577,792 
-----------+----------------------+----------
     Total |   840,206 20,578,588 |21,418,794 

. tab year same_county if migrate1 == 2

           |      same_county
      year |         0          1 |     Total
-----------+----------------------+----------
      2015 |    42,597    172,956 |   215,553 
      2016 |    43,823    172,091 |   215,914 
      2017 |    45,058    174,386 |   219,444 
      2018 |    46,477    173,182 |   219,659 
      2019 |    46,329    168,101 |   214,430 
      2020 |    34,625    119,307 |   153,932 
      2021 |    46,470    148,925 |   195,395 
      2022 |    50,584    141,717 |   192,301 
      2023 |    47,498    135,794 |   183,292 
-----------+----------------------+----------
     Total |   403,461  1,406,459 | 1,809,920 

. 
. ** Tag HH head 
. gen byte hh_head = (relate == 1)

. 
. ** Compress file 
. compress 
  variable state_fips_o was int now byte
  variable hh_size was float now byte
  variable hh_adult_ct was float now byte
  variable hh_child_ct was float now byte
  variable same_county was float now byte
  (278,444,322 bytes saved)

. 
. ** Save 
. save "${data}working/acs_migration_file", replace 
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/acs_migration_file.dta saved

. 
. // Keep only observations with valid origin/destinat
> ion counties and YEAR
. drop if missing(year) | missing(fips_o) | missing(fi
> ps_d)
(0 observations deleted)

. 
. // Clean income (treat missing as 0; keep negative v
> alues as reported)
. replace inctot = 0 if missing(inctot)
(0 real changes made)

. gen double income_wt = inctot * perwt

. label var income_wt "Person income (INCTOT) weighted
>  by PERWT"

. 
. // --- Persons + income totals by origin/destination
> /year
. preserve

. keep year fips_o fips_d perwt income_wt

. collapse (sum) persons=perwt income_total=income_wt,
>  by(year fips_o fips_d)

. tempfile acs_pi

. save `acs_pi'
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000e
    > .tmp saved as .dta format

. restore

. 
. // --- Households by origin/destination/year
. // Use HHWT among household heads (RELATE==1) if ava
> ilable; else PERNUM==1 fallback.
. 
. preserve

. keep if hh_head
(10,269,992 observations deleted)

. keep year fips_o fips_d hhwt

. collapse (sum) households=hhwt, by(year fips_o fips_
> d)

. tempfile acs_hh

. save `acs_hh'
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000g
    > .tmp saved as .dta format

. restore

. 
. // --- Merge persons/income with households
. use `acs_pi', clear

. merge 1:1 year fips_o fips_d using `acs_hh', nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                        45,163
        from master                    45,163  
        from using                          0  

    Matched                           162,899  
    -----------------------------------------

. 
. label var persons "Estimated number of persons (sum 
> PERWT)"

. label var households "Estimated number of households
>  (sum HHWT among heads)"

. label var income_total "Estimated total personal inc
> ome (sum INCTOT*PERWT)"

. 
. // --- Derive state/county components for merges wit
> h name crosswalk
. gen int state_fips_o  = floor(fips_o/1000)

. gen int county_fips_o = mod(fips_o,1000)

. gen int state_fips_d  = floor(fips_d/1000)

. gen int county_fips_d = mod(fips_d,1000)

. 
. label var state_fips_o "State FIPS (origin)"

. label var county_fips_o "County FIPS (origin)"

. label var state_fips_d "State FIPS (destination)"

. label var county_fips_d "County FIPS (destination)"

. 
. // --- Merge in names (from NHGIS IDs snapshot)
. preserve

. use "${data}working/ids", clear

. rename (state_fips county_fips state_name county_nam
> e) (state_fips_o county_fips_o state_name_o county_n
> ame_o)

. tempfile ids_o

. save `ids_o'
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000i
    > .tmp saved as .dta format

. keep state_fips_o state_name_o 

. duplicates drop 

Duplicates in terms of all variables

(3,169 observations deleted)

. save `state_ids_o'
invalid file specification
r(198);

end of do-file

r(198);

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_00001m
> .tmp"

. /***************************************************
> **************************
> * Program:                      01_clean_data.do 
> * Author(s):            John Iselin 
> * Date Updated:         October 19, 2025
> 
> *** Demographic data via IPUMS NHGIS 
> ** Via https://www.nhgis.org/
> ** Downloaded on October 19, 2025
> ** EXTRACT DETAILS in "nhgis0031_ts_nominal_county_c
> odebook"
> 
> *** Economic data via BEA Regional Economic Accounts
>  (CAINC1)
> ** Via https://apps.bea.gov/regional/downloadzip.htm
> 
> *** ACS individual data via IPUMS USA 
> ** Via https://usa.ipums.org/usa/index.shtml
> ** Downloaded via R program 
> 
> *** IRS SOI County-Level Migration Files
> ** Via https://www.irs.gov/statistics/soi-tax-stats-
> migration-data
> 
> *** IRS SOI County-Level Files
> ** Via https://www.irs.gov/statistics/soi-tax-stats-
> county-data
> 
> *** NYTimes COVID Cases and Deaths 
> ** Via https://github.com/nytimes/covid-19-data
> 
> ****************************************************
> ***************************/
. 
. ** Start log file 
. capture log close log_01

. log using "${logs}01_log_data_clean_${pr_name}_${dat
> e}", replace text name(log_01)
------------------------------------------------------
      name:  log_01
       log:  C:/Users/ji252/Documents/GitHub/multnomah
> -county-tax/code/logs/01_log_data_clean_multnomah_20
> 25-12-15.log
  log type:  text
 opened on:  15 Dec 2025, 16:33:54

. 
. //--------------------------------------------------
. // STEP 0: Preliminary Set-Up 
. //--------------------------------------------------
. 
. ** Define labels 
. label define lb_move_type       0 "ERROR"           
>                     ///
>                                                     
>     1 "Non-movers"                  ///
>                                                     
>     2 "All movers"                  ///
>                                                     
>     3 "Domestic movers"             ///
>                                                     
>     4 "Within-state movers" ///
>                                                     
>     5 "Inter-state movers"  ///
>                                                     
>     6 "Foreign movers", modify

.                                                     
>     
. label define lb_agi             1 "Under $1"        
>             ///
>                                                     
>     2 "$1 under $10K"               ///
>                                                     
>     3 "$10K under $25K"             ///
>                                                     
>     4 "$25K under $50K"             ///
>                                                     
>     5 "$50K under $75K"             ///
>                                                     
>     6 "$75K under $100K"    ///
>                                                     
>     7 "$100K under $200K"   ///
>                                                     
>     8 "$200K or more", modify                       
>                                 

. 
. 
. ** Define Programs
. 
. ** Make FIPS code from state and county fips codes 
. capture program drop make_fips

. program define make_fips
  1.     syntax varlist(min=2 max=2 numeric), GEN(name
> )
  2. 
.     quietly {
  3.         tempvar s c
  4. 
.         local v1 : word 1 of `varlist'
  5.         local v2 : word 2 of `varlist'
  6. 
.         gen `s' = string(`v1', "%02.0f")
  7.         gen `c' = string(`v2', "%03.0f")
  8. 
.         gen `gen' = real(`s' + `c')
  9.     }
 10. end

. 
. ** Reclassify suppressed values as 0 
. 
. capture program drop unsuppress

. program define unsuppress
  1.     syntax varlist
  2. 
.     foreach v of varlist `varlist' {
  3.         replace `v' = 0 if `v' == -1
  4.     }
  5. end

. 
. //--------------------------------------------------
. // STEP -1: Acquire raw data (automated where possib
> le)
. //--------------------------------------------------
. /*
> This block downloads public-use source data directly
>  from official URLs if not present locally.
> 
> Automated downloads included:
>   - IRS SOI county-to-county migration: countyinflow
> YYZZ.csv / countyoutflowYYZZ.csv
>   - IRS SOI county data: YYincyallagi.csv
>   - BEA Regional Economic Accounts (CAINC1): CAINC1.
> zip (unzips to CAINC1__ALL_AREAS_*.csv and related f
> iles)
> 
> */
. 
. * Ensure expected directory structure exists
. capture mkdir "${data}"

. capture mkdir "${data}working"

. capture mkdir "${data}demographic"

. capture mkdir "${data}demographic/CAINC1"

. capture mkdir "${data}demographic/nhgis0031_csv"

. capture mkdir "${data}irs"

. capture mkdir "${data}covid"

. 
. * ----------------------------
. * IRS SOI: migration files
. * ----------------------------
. local irs_base "https://www.irs.gov/pub/irs-soi"

. 
. forvalues yy = 15/21 {
  2.     local zz = `yy' + 1
  3.     local fn_out "countyoutflow`yy'`zz'.csv"
  4.     local fn_in  "countyinflow`yy'`zz'.csv"
  5. 
.     capture confirm file "${data}irs/`fn_out'"
  6.     if _rc {
  7.         di as txt "Downloading (IRS SOI) `fn_out'
>  ..."
  8.         copy "`irs_base'/`fn_out'" "${data}irs/`f
> n_out'", replace
  9.     }
 10. 
.     capture confirm file "${data}irs/`fn_in'"
 11.     if _rc {
 12.         di as txt "Downloading (IRS SOI) `fn_in' 
> ..."
 13.         copy "`irs_base'/`fn_in'" "${data}irs/`fn
> _in'", replace
 14.     }
 15. }

. 
. * ----------------------------
. * IRS SOI: county income (AGI) files
. * ----------------------------
. forvalues yy = 15/22 {
  2.     local fn_inc "`yy'incyallagi.csv"
  3. 
.     capture confirm file "${data}irs/`fn_inc'"
  4.     if _rc {
  5.         di as txt "Downloading (IRS SOI) `fn_inc'
>  ..."
  6.         copy "`irs_base'/`fn_inc'" "${data}irs/`f
> n_inc'", replace
  7.     }
  8. }

. 
. * ----------------------------
. * BEA Regional: CAINC1.zip
. * ----------------------------
. local bea_dir "${data}demographic/CAINC1"

. local bea_url "https://apps.bea.gov/regional/zip/CAI
> NC1.zip"

. local bea_zip "`bea_dir'/CAINC1.zip"

. 
. * If we don't already have a CAINC1 "_ALL_AREAS" fil
> e, download + unzip the ZIP.
. local bea_files : dir "`bea_dir'" files "CAINC1__ALL
> _AREAS_*.csv"

. if "`bea_files'"=="" {
.     local bea_files : dir "`bea_dir'" files "CAINC1_
> _ALL_STATES_*.csv"
. }

. 
. if "`bea_files'"=="" {
.     di as txt "Downloading (BEA) CAINC1.zip ..."
Downloading (BEA) CAINC1.zip ...
.     copy "`bea_url'" "`bea_zip'", replace
(file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/demographic/CAINC1/CAINC1.zip not
    found)
. 
.     local curdir "`c(pwd)'"
.     cd "`bea_dir'"
C:\Users\ji252\Documents\GitHub\multnomah-county-tax\d
> ata\demographic\CAINC1
.     unzipfile "CAINC1.zip", replace
    inflating: CAINC1__ALL_AREAS_1969_2023.csv
    inflating: CAINC1__definition.xml
    inflating: CAINC1__Footnotes.html
    inflating: CAINC1_AK_1969_2023.csv
    inflating: CAINC1_AL_1969_2023.csv
    inflating: CAINC1_AR_1969_2023.csv
    inflating: CAINC1_AZ_1969_2023.csv
    inflating: CAINC1_CA_1969_2023.csv
    inflating: CAINC1_CO_1969_2023.csv
    inflating: CAINC1_CSA_1969_2023.csv
    inflating: CAINC1_CT_1969_2023.csv
    inflating: CAINC1_DC_1969_2023.csv
    inflating: CAINC1_DE_1969_2023.csv
    inflating: CAINC1_FL_1969_2023.csv
    inflating: CAINC1_GA_1969_2023.csv
    inflating: CAINC1_HI_1969_2023.csv
    inflating: CAINC1_IA_1969_2023.csv
    inflating: CAINC1_ID_1969_2023.csv
    inflating: CAINC1_IL_1969_2023.csv
    inflating: CAINC1_IN_1969_2023.csv
    inflating: CAINC1_KS_1969_2023.csv
    inflating: CAINC1_KY_1969_2023.csv
    inflating: CAINC1_LA_1969_2023.csv
    inflating: CAINC1_MA_1969_2023.csv
    inflating: CAINC1_MD_1969_2023.csv
    inflating: CAINC1_MDIV_1969_2023.csv
    inflating: CAINC1_ME_1969_2023.csv
    inflating: CAINC1_MI_1969_2023.csv
    inflating: CAINC1_MIC_1969_2023.csv
    inflating: CAINC1_MN_1969_2023.csv
    inflating: CAINC1_MO_1969_2023.csv
    inflating: CAINC1_MS_1969_2023.csv
    inflating: CAINC1_MSA_1969_2023.csv
    inflating: CAINC1_MT_1969_2023.csv
    inflating: CAINC1_NC_1969_2023.csv
    inflating: CAINC1_ND_1969_2023.csv
    inflating: CAINC1_NE_1969_2023.csv
    inflating: CAINC1_NH_1969_2023.csv
    inflating: CAINC1_NJ_1969_2023.csv
    inflating: CAINC1_NM_1969_2023.csv
    inflating: CAINC1_NV_1969_2023.csv
    inflating: CAINC1_NY_1969_2023.csv
    inflating: CAINC1_OH_1969_2023.csv
    inflating: CAINC1_OK_1969_2023.csv
    inflating: CAINC1_OR_1969_2023.csv
    inflating: CAINC1_PA_1969_2023.csv
    inflating: CAINC1_PORT_1969_2023.csv
    inflating: CAINC1_RI_1969_2023.csv
    inflating: CAINC1_SC_1969_2023.csv
    inflating: CAINC1_SD_1969_2023.csv
    inflating: CAINC1_TN_1969_2023.csv
    inflating: CAINC1_TX_1969_2023.csv
    inflating: CAINC1_US_1969_2023.csv
    inflating: CAINC1_UT_1969_2023.csv
    inflating: CAINC1_VA_1969_2023.csv
    inflating: CAINC1_VT_1969_2023.csv
    inflating: CAINC1_WA_1969_2023.csv
    inflating: CAINC1_WI_1969_2023.csv
    inflating: CAINC1_WV_1969_2023.csv
    inflating: CAINC1_WY_1969_2023.csv

successfully unzipped CAINC1.zip to current directory
total processed:  60
        skipped:  0
      extracted:  60
.     cd "`curdir'"
C:\Users\ji252\Documents\GitHub\multnomah-county-tax
. 
.     capture erase "`bea_zip'"
. }

. 
. * ----------------------------
. * NYTimes COVID Data 
. * ----------------------------
. local covid_dir "${data}covid"

. local covid_url "https://raw.githubusercontent.com/n
> ytimes/covid-19-data/master/us-counties.csv"

. 
. * If we don't already have a COVID file, download.
. local covid_file : dir "`covid_dir'" files "covid_ny
> t.csv"

. if "`covid_file'"=="" {
.     local covid_file : dir "`covid_dir'" files "covi
> d_nyt.csv"
. }

. 
. if "`covid_file'"=="" {
.     di as txt "Downloading (COVID)  ..."
Downloading (COVID)  ...
.     copy "`covid_url'" "`covid_dir'/covid_nyt.csv", 
> replace
. }

. 
. 
. 
. //--------------------------------------------------
> ---------
. // STEP 1: Import and Clean Demographic Data via IPU
> MS + BEA  
. //--------------------------------------------------
> ---------
. 
. ** Import data 
. import delimited        ///
>         "${data}demographic/nhgis0031_csv/nhgis0031_
> ts_nominal_county.csv", clear 
(encoding automatically selected: ISO-8859-1)
(15 vars, 54,673 obs)

. 
. ** Describe data 
. des 

Contains data
 Observations:        54,673                  
    Variables:            15                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
gisjoin         str8    %9s                   GISJOIN
year            str9    %9s                   YEAR
state           str20   %20s                  STATE
statefp         byte    %8.0g                 STATEFP
statenh         int     %8.0g                 STATENH
county          str46   %46s                  COUNTY
countyfp        int     %8.0g                 COUNTYFP
countynh        int     %8.0g                 COUNTYNH
name            str59   %59s                  NAME
av0aa           long    %12.0g                AV0AA
d15aa           long    %12.0g                D15AA
d15ab           long    %12.0g                D15AB
b79aa           long    %12.0g                B79AA
av0aam          long    %12.0g                AV0AAM
b79aam          long    %8.0g                 B79AAM
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.

. 
. ** Drop unnecc variables 
. drop gisjoin statenh countynh name 

. 
. ** Rename 
. rename state state_name 

. rename statefp state_fips 

. rename county county_name 

. rename countyfp county_fips 

. rename av0aa population 

. rename d15aa pop_urban 

. rename d15ab pop_rural 

. rename b79aa median_income 

. rename av0aam population_margin

. rename b79aam median_income_margin 

. 
. ** Create urban percent 
. gen percent_urban = pop_urban / population
(45,090 missing values generated)

. 
. ** Label variables 
. label var state_name "State name"

. label var state_fips "State FIPS code"

. label var county_name "County name"

. label var county_fips "County FIPS code"

. label var population "Population count"

. label var pop_rural "Rural population count"

. label var pop_urban "Urban population count"

. label var percent_urban "Percent of population in ur
> ban areas"

. label var median_income "Median household income (pr
> ior year)"

. label var population_margin "ACS margin for error: p
> opulation"

. label var median_income_margin "ACS margin for error
> : median income"

. 
. ** Save as temporary file 
. tempfile demo

. save `demo'
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000001
    > .tmp saved as .dta format

. 
. ** Create three datasets 
. 
. ** (1) Basic state and county IDs 
. keep if year == "2020" 
(51,452 observations deleted)

. keep state* county* 

. 
. ** Make FIPS 
. make_fips state_fips county_fips, gen(fips)

. 
. ** Save as state and county Ids 
. save "${data}working/ids", replace 
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/ids.dta saved

. clear  

. 
. ** (2) Population data 
. use `demo'

. keep if !missing(pop_urban) 
(45,090 observations deleted)

. tab year 

       YEAR |      Freq.     Percent        Cum.
------------+-----------------------------------
       2000 |      3,141       32.78       32.78
       2010 |      3,221       33.61       66.39
       2020 |      3,221       33.61      100.00
------------+-----------------------------------
      Total |      9,583      100.00

. 
. ** Keep 2020 
. keep if year == "2020"
(6,362 observations deleted)

. drop year median_income* population_margin

. 
. ** Make FIPS 
. make_fips state_fips county_fips, gen(fips)

. 
. ** Save data
. save "${data}working/population_2020", replace 
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/population_2020.dta saved

. clear  

. 
. ** (3) 2015-2019 ACS data 
. use `demo'

. keep if !missing(median_income) 
(6,447 observations deleted)

. tab year 

       YEAR |      Freq.     Percent        Cum.
------------+-----------------------------------
       2000 |      3,141        6.51        6.51
  2006-2010 |      3,221        6.68       13.19
  2007-2011 |      3,221        6.68       19.87
  2008-2012 |      3,221        6.68       26.55
  2009-2013 |      3,221        6.68       33.23
  2010-2014 |      3,220        6.68       39.91
  2011-2015 |      3,219        6.67       46.58
  2012-2016 |      3,220        6.68       53.26
  2013-2017 |      3,220        6.68       59.93
  2014-2018 |      3,219        6.67       66.61
  2015-2019 |      3,220        6.68       73.29
  2016-2020 |      3,220        6.68       79.96
  2017-2021 |      3,220        6.68       86.64
  2018-2022 |      3,221        6.68       93.32
  2019-2023 |      3,222        6.68      100.00
------------+-----------------------------------
      Total |     48,226      100.00

. 
. ** Keep 2020 
. keep if year == "2015-2019"
(45,006 observations deleted)

. drop year pop_rural pop_urban percent_urban

. 
. ** Make FIPS 
. make_fips state_fips county_fips, gen(fips)

. 
. ** Save data
. save "${data}working/acs_2015_2019_data", replace 
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/acs_2015_2019_data.dta saved

. 
. ** Rename for merge 
. rename population population_acs

. 
. ** Merge with other data 
. merge 1:1 state_fips county_fips using "${data}worki
> ng/population_2020",                ///
>         keep(match) nogen 

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                             3,219  
    -----------------------------------------

. 
. ** Save data
. save "${data}working/demographics_2020", replace 
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/demographics_2020.dta saved

. 
. ** Load BEA Data 
. import delimited "${data}demographic/CAINC1/CAINC1__
> ALL_AREAS_1969_2023.csv",   ///
>         clear 
(encoding automatically selected: ISO-8859-1)
(63 vars, 9,604 obs)

. 
. ** Drop unnecc variables 
. drop region tablename industryclassification unit ge
> oname 

. 
. ** Drop empty cells 
. drop if missing(linecode)
(4 observations deleted)

. 
. ** Update names 
. rename geofips fips 

. replace fips = subinstr(fips, `"""', "", .)
(9,600 real changes made)

. destring fips, replace 
fips: all characters numeric; replaced as long

. 
. ** Keep population and per-capita income, dropping p
> ersonal income (total)
. tab description linecode

                      |  LineCode
          Description |         1 |     Total
----------------------+-----------+----------
Per capita personal.. |         0 |     3,200 
Personal income (th.. |     3,200 |     3,200 
Population (persons.. |         0 |     3,200 
----------------------+-----------+----------
                Total |     3,200 |     9,600 


                      |  LineCode
          Description |         2 |     Total
----------------------+-----------+----------
Per capita personal.. |         0 |     3,200 
Personal income (th.. |         0 |     3,200 
Population (persons.. |     3,200 |     3,200 
----------------------+-----------+----------
                Total |     3,200 |     9,600 


                      |  LineCode
          Description |         3 |     Total
----------------------+-----------+----------
Per capita personal.. |     3,200 |     3,200 
Personal income (th.. |         0 |     3,200 
Population (persons.. |         0 |     3,200 
----------------------+-----------+----------
                Total |     3,200 |     9,600 

. drop if linecode == 1   
(3,200 observations deleted)

. drop description

.         
. ** Get V* to be in terms of years 
. ** V9 == 1969 
. forvalues i = 9/63 {
  2.         
.         local j = 1960 + `i'
  3.         rename v`i' value`j'
  4.         
. } // END I LOOP 

. 
. ** Reshape 
. reshape long value, i(fips linecode) j(year)
(j = 1969 1970 1971 1972 1973 1974 1975 1976 1977 1978
>  1979 1980 1981 1982 1983 1984 1985 1986 1987 1988 1
> 989 1990 1991 1992 1993 1994 1995 1996 1997 1998 199
> 9 2000 2001 2002 2003 2004 2005 2006 2007 2008 2009 
> 2010 2011 2012 2013 2014 2015 2016 2017 2018 2019 20
> 20 2021 2022 2023)

Data                               Wide   ->   Long
------------------------------------------------------
> -----------------------
Number of observations            6,400   ->   352,000
>      
Number of variables                  57   ->   4      
>      
j variable (55 values)                    ->   year
xij variables:
      value1969 value1970 ... value2023   ->   value
------------------------------------------------------
> -----------------------

. reshape wide value, i(fips year ) j(linecode)
(j = 2 3)

Data                               Long   ->   Wide
------------------------------------------------------
> -----------------------
Number of observations          352,000   ->   176,000
>      
Number of variables                   4   ->   4      
>      
j variable (2 values)          linecode   ->   (droppe
> d)
xij variables:
                                  value   ->   value2 
> value3
------------------------------------------------------
> -----------------------

. 
. ** Keep years 
. keep if inrange(year, 2015, 2023)
(147,200 observations deleted)

. 
. ** Rename values 
. rename value2 population 

. rename value3 per_capita_income

. 
. ** Drop if missing values 
. drop if population == "(NA)"
(239 observations deleted)

. 
. ** Keep only counties with all observations 
. bysort fips: gen ct = _N 

. tab ct

         ct |      Freq.     Percent        Cum.
------------+-----------------------------------
          4 |          8        0.03        0.03
          5 |          5        0.02        0.05
          9 |     28,548       99.95      100.00
------------+-----------------------------------
      Total |     28,561      100.00

. keep if ct == 9
(13 observations deleted)

. drop ct

. 
. ** Destring 
. destring population, replace 
population: all characters numeric; replaced as long

. destring per_capita_income, replace 
per_capita_income: all characters numeric; replaced as
>  long

. 
. ** Save data
. save "${data}working/bea_economics", replace 
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/bea_economics.dta saved

. 
. //--------------------------------------------------
> --
. // STEP 2: Import and Clean NYTimes COVID-19 Data 
. //--------------------------------------------------
> --
.  
. ** Import data 
. import delimited using "${data}covid/covid_nyt.csv",
>  varnames(1) clear case(lower) 
(encoding automatically selected: ISO-8859-1)
(6 vars, 2,502,832 obs)

. 
. ** Describe data 
. des 

Contains data
 Observations:     2,502,832                  
    Variables:             6                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
date            str10   %10s                  
county          str35   %35s                  
state           str24   %24s                  
fips            long    %12.0g                
cases           long    %12.0g                
deaths          long    %8.0g                 
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.

. 
. ** Set up date information 
. generate num_date = date(date, "YMD")

. format num_date %td

. drop date 

. 
. ** Rename 
. rename state state_name 

. rename county county_name 

. rename num_date date 

. 
. ** keep only counties 
. keep if !missing(fips)
(23,678 observations deleted)

. 
. ** Keep in 50 states 
. drop if state_name == "Puerto Rico"
(57,605 observations deleted)

. drop if state_name == "Virgin Islands"
(2,304 observations deleted)

. drop if state_name == "Northern Mariana Islands"
(1,452 observations deleted)

. 
. ** Sort 
. sort date fips 

. 
. ** Create panel 
. xtset fips date

Panel variable: fips (unbalanced)
 Time variable: date, 21jan2020 to 13may2022, but
                with gaps
         Delta: 1 day

. 
. ** Fill in panel 
. tsfill, full 

. 
. ** Fill in missing values 
. replace cases = 0 if missing(cases)
(228,991 real changes made)

. replace deaths = 0 if missing(deaths)
(228,991 real changes made)

. 
. ** Preserve data 
. preserve 

. 
. ** Preserve fips codes and names 
. keep if !missing(state_name)
(228,991 observations deleted)

. keep if !missing(county_name)
(0 observations deleted)

. duplicates drop fips state_name county_name, force 

Duplicates in terms of fips state_name county_name

(2,414,657 observations deleted)

. 
. ** Save as temporary data 
. tempfile state_county_names 

. save `state_county_names'
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000003
    > .tmp saved as .dta format

. clear 

. 
. ** Restore 
. restore 

. 
. ** Drop and merge in names 
. drop state_name county_name

. merge m:1 fips using `state_county_names', keep(mast
> er match) nogen 

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                         2,646,784  
    -----------------------------------------

. 
. ** Get year, month, day 
. gen year = year(date)

. gen month = month(date)

. gen day = day(date)

. 
. ** Order data 
. order date year month day fips state county cases de
> aths 

. 
. ** Calculate cumulative cases and deaths 
. bysort fips (date): gen cases_cum = sum(cases)

. bysort fips (date): gen deaths_cum = sum(deaths)

. 
. ** Merge population data (2020)
. merge m:1 fips using "${data}working/population_2020
> ", keep(match) nogen  
(variable county_name was str35, now str46 to
       accommodate using data's values)
(variable fips was long, now double to accommodate
       using data's values)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                         2,643,408  
    -----------------------------------------

. 
. ** Save file 
. save ${data}working/covid_cleaned.dta, replace 
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/covid_cleaned.dta saved

. 
. ** Generate Clustering Variables 
. 
. ** Keep one observation per month 
. keep year month fips state_name county_name cases_cu
> m deaths_cum population

. collapse (sum) cases deaths population, by(year mont
> h fips state_name county_name) 

. sort year month fips 

. egen date = group(year month)

. drop year month 

. 
. ** Generate per capita figures
. replace cases = 1000 * cases / population
(82,955 real changes made)

. replace deaths = 1000 * deaths / population
(74,723 real changes made)

. drop population 

. 
. ** Reshape wide 
. reshape wide cases deaths, i(fips state_name county_
> name) j(date)
(j = 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 2
> 0 21 22 23 24 25 26 27 28 29)

Data                               Long   ->   Wide
------------------------------------------------------
> -----------------------
Number of observations           90,828   ->   3,132  
>      
Number of variables                   6   ->   61     
>      
j variable (29 values)             date   ->   (droppe
> d)
xij variables:
                              cases_cum   ->   cases_c
> um1 cases_cum2 ... cases_cum29
                             deaths_cum   ->   deaths_
> cum1 deaths_cum2 ... deaths_cum29
------------------------------------------------------
> -----------------------

. 
. ** Save file 
. save ${data}working/covid_cleaned_wide.dta, replace 
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/covid_cleaned_wide.dta saved

. clear

. 
. //--------------------------------------------------
> --
. // STEP 3: Import and Clean ACS Micro Data via IPUMS
>  
. //--------------------------------------------------
> --
. 
. ** Load data 
. forvalues y = 2015(1)2023 {
  2.         
.         ** Import CSV
.         import delimited using "${data}acs/acs_`y'",
>  varnames(1) clear case(lower)
  3.         
.         ** Save as temporary data 
.         tempfile acs_`y'
  4.         save `acs_`y''
  5.         clear 
  6.         
. } // END YEAR LOOP 
(encoding automatically selected: ISO-8859-1)
(57 vars, 2,997,503 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000004
    > .tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(57 vars, 3,007,847 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000005
    > .tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(57 vars, 3,038,696 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000006
    > .tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(57 vars, 3,060,442 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000007
    > .tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(57 vars, 3,087,291 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000008
    > .tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(57 vars, 2,454,160 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000009
    > .tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(57 vars, 3,092,079 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000a
    > .tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(55 vars, 3,190,848 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000b
    > .tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(55 vars, 3,228,659 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000c
    > .tmp saved as .dta format

. 
. ** Append data 
. forvalues y = 2015(1)2023 {
  2.         
.         append using `acs_`y''  
  3.         
. } // END YEAR LOOP 
(variable cbserial was long, now double to
       accommodate using data's values)

. 
. ** Des 
. tab year 

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       2015 |  2,997,503       11.04       11.04
       2016 |  3,007,847       11.08       22.11
       2017 |  3,038,696       11.19       33.30
       2018 |  3,060,442       11.27       44.57
       2019 |  3,087,291       11.37       55.94
       2020 |  2,454,160        9.04       64.98
       2021 |  3,092,079       11.39       76.36
       2022 |  3,190,848       11.75       88.11
       2023 |  3,228,659       11.89      100.00
------------+-----------------------------------
      Total | 27,157,525      100.00

. 
. ** Define # of adults and kids in HHs 
. gen adult = age >= 18 

. gen child = age < 18 

. bysort year serial: gen hh_size = _N 

. bysort year serial: egen hh_adult_ct = total(adult)

. bysort year serial: egen hh_child_ct = total(child)

. 
. ** Sample 18+
. drop if child == 1 
(5,629,869 observations deleted)

. drop child adult 

. 
. ** Sample not living abroad last year 
. drop if migplac1 > 56 
(108,862 observations deleted)

. drop if migrate1 == 4 
(0 observations deleted)

. 
. ** Rename variables 
. rename statefip state_fips_d

. rename countyfip county_fips_d 

. 
. ** Set up origin data 
. fre migrate1

migrate1
------------------------------------------------------
> -----
              |      Freq.    Percent      Valid      
>  Cum.
--------------+---------------------------------------
> -----
Valid   1     |   1.92e+07      89.51      89.51      
> 89.51
        2     |    1809920       8.45       8.45      
> 97.96
        3     |     436745       2.04       2.04     1
> 00.00
        Total |   2.14e+07     100.00     100.00      
>      
------------------------------------------------------
> -----

. drop migrate1d

. tab migplac1

   migplac1 |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 | 19,172,129       89.51       89.51
          1 |     31,329        0.15       89.66
          2 |      5,825        0.03       89.68
          4 |     54,912        0.26       89.94
          5 |     21,714        0.10       90.04
          6 |    260,673        1.22       91.26
          8 |     52,539        0.25       91.50
          9 |     21,577        0.10       91.61
         10 |      5,369        0.03       91.63
         11 |      8,664        0.04       91.67
         12 |    152,989        0.71       92.38
         13 |     71,263        0.33       92.72
         15 |      9,845        0.05       92.76
         16 |     13,536        0.06       92.83
         17 |     86,306        0.40       93.23
         18 |     47,941        0.22       93.45
         19 |     21,469        0.10       93.55
         20 |     22,338        0.10       93.66
         21 |     31,888        0.15       93.81
         22 |     28,776        0.13       93.94
         23 |      7,911        0.04       93.98
         24 |     40,223        0.19       94.17
         25 |     48,684        0.23       94.39
         26 |     65,444        0.31       94.70
         27 |     35,177        0.16       94.86
         28 |     16,994        0.08       94.94
         29 |     45,200        0.21       95.15
         30 |      7,453        0.03       95.19
         31 |     13,567        0.06       95.25
         32 |     24,785        0.12       95.37
         33 |      8,787        0.04       95.41
         34 |     50,561        0.24       95.64
         35 |     12,299        0.06       95.70
         36 |    118,674        0.55       96.26
         37 |     70,555        0.33       96.59
         38 |      5,884        0.03       96.61
         39 |     81,541        0.38       96.99
         40 |     28,921        0.14       97.13
         41 |     36,246        0.17       97.30
         42 |     76,201        0.36       97.65
         44 |      6,551        0.03       97.68
         45 |     33,552        0.16       97.84
         46 |      6,067        0.03       97.87
         47 |     48,061        0.22       98.09
         48 |    197,912        0.92       99.02
         49 |     25,798        0.12       99.14
         50 |      4,106        0.02       99.16
         51 |     64,560        0.30       99.46
         53 |     64,790        0.30       99.76
         54 |     10,532        0.05       99.81
         55 |     35,653        0.17       99.98
         56 |      5,023        0.02      100.00
------------+-----------------------------------
      Total | 21,418,794      100.00

. rename migplac1 state_fips_o

. tab migcounty1

 migcounty1 |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 | 19,952,847       93.16       93.16
          1 |     35,752        0.17       93.32
          3 |     58,525        0.27       93.60
          5 |     21,286        0.10       93.70
          7 |     13,720        0.06       93.76
          9 |     11,958        0.06       93.82
         11 |     23,663        0.11       93.93
         13 |     53,927        0.25       94.18
         15 |      7,126        0.03       94.21
         17 |     21,840        0.10       94.31
         19 |     24,348        0.11       94.43
         20 |      2,061        0.01       94.44
         21 |     12,848        0.06       94.50
         23 |      7,725        0.04       94.53
         25 |     21,090        0.10       94.63
         27 |     15,274        0.07       94.70
         29 |     32,454        0.15       94.85
         31 |     57,529        0.27       95.12
         33 |     33,851        0.16       95.28
         35 |     24,912        0.12       95.40
         37 |     72,280        0.34       95.73
         39 |     10,381        0.05       95.78
         41 |      8,696        0.04       95.82
         43 |      8,893        0.04       95.86
         45 |      5,998        0.03       95.89
         47 |     22,821        0.11       96.00
         49 |     21,522        0.10       96.10
         51 |     17,488        0.08       96.18
         53 |     17,759        0.08       96.26
         55 |     12,676        0.06       96.32
         57 |     18,309        0.09       96.41
         59 |     30,944        0.14       96.55
         61 |     31,725        0.15       96.70
         63 |     12,421        0.06       96.76
         65 |     18,670        0.09       96.85
         67 |     29,982        0.14       96.99
         69 |      4,036        0.02       97.01
         71 |     27,649        0.13       97.13
         73 |     36,959        0.17       97.31
         75 |     11,968        0.06       97.36
         77 |      8,293        0.04       97.40
         79 |      7,681        0.04       97.44
         81 |     30,275        0.14       97.58
         83 |      9,053        0.04       97.62
         85 |     28,918        0.14       97.76
         87 |      6,680        0.03       97.79
         89 |     10,158        0.05       97.83
         91 |     15,565        0.07       97.91
         93 |      4,960        0.02       97.93
         95 |     19,883        0.09       98.02
         97 |     19,460        0.09       98.11
         99 |     19,554        0.09       98.21
        101 |     14,457        0.07       98.27
        103 |     18,351        0.09       98.36
        105 |      7,421        0.03       98.39
        107 |      5,600        0.03       98.42
        109 |     10,761        0.05       98.47
        111 |     14,844        0.07       98.54
        113 |     30,918        0.14       98.68
        115 |      4,818        0.02       98.71
        117 |      7,798        0.04       98.74
        119 |     14,739        0.07       98.81
        121 |     10,181        0.05       98.86
        123 |      3,671        0.02       98.88
        125 |      9,036        0.04       98.92
        127 |      2,348        0.01       98.93
        129 |      1,814        0.01       98.94
        133 |      5,313        0.02       98.96
        135 |      7,844        0.04       99.00
        139 |      5,952        0.03       99.03
        141 |      6,936        0.03       99.06
        143 |      4,286        0.02       99.08
        145 |      1,975        0.01       99.09
        147 |      2,327        0.01       99.10
        149 |      2,146        0.01       99.11
        151 |      1,900        0.01       99.12
        153 |      5,155        0.02       99.14
        157 |     11,532        0.05       99.20
        159 |        751        0.00       99.20
        160 |        149        0.00       99.20
        161 |      4,716        0.02       99.22
        163 |     13,817        0.06       99.29
        165 |      2,418        0.01       99.30
        167 |      5,023        0.02       99.32
        169 |        850        0.00       99.33
        171 |        529        0.00       99.33
        173 |        264        0.00       99.33
        179 |      1,879        0.01       99.34
        183 |     11,521        0.05       99.39
        185 |        871        0.00       99.40
        187 |      2,303        0.01       99.41
        189 |      6,599        0.03       99.44
        191 |        759        0.00       99.44
        197 |      3,401        0.02       99.46
        201 |     29,158        0.14       99.59
        209 |      2,664        0.01       99.60
        215 |      3,046        0.01       99.62
        223 |        758        0.00       99.62
        227 |        946        0.00       99.63
        245 |      3,068        0.01       99.64
        251 |      1,020        0.00       99.65
        257 |        850        0.00       99.65
        303 |      3,247        0.02       99.67
        309 |      2,351        0.01       99.68
        313 |        456        0.00       99.68
        329 |      1,177        0.01       99.68
        339 |      3,176        0.01       99.70
        355 |      2,646        0.01       99.71
        367 |        977        0.00       99.72
        375 |      1,001        0.00       99.72
        381 |      1,199        0.01       99.73
        423 |      1,497        0.01       99.73
        439 |     14,652        0.07       99.80
        441 |      1,419        0.01       99.81
        451 |        952        0.00       99.81
        453 |     12,549        0.06       99.87
        479 |      1,301        0.01       99.88
        485 |      1,288        0.01       99.88
        491 |      4,036        0.02       99.90
        510 |     10,140        0.05       99.95
        550 |      1,187        0.01       99.95
        650 |      1,031        0.00       99.96
        700 |      1,438        0.01       99.97
        710 |        466        0.00       99.97
        760 |      2,799        0.01       99.98
        810 |      3,933        0.02      100.00
------------+-----------------------------------
      Total | 21,418,794      100.00

. rename migcounty1 county_fips_o

. 
. ** Use migrate1 to update values 
. 
. ** Within same house 
. replace state_fips_o = state_fips_d if migrate1 == 1
(19,172,129 real changes made)

. replace county_fips_o = county_fips_d if migrate1 ==
>  1 
(11,640,515 real changes made)

. 
. ** Within same state 
. replace state_fips_o = state_fips_d if migrate1 == 2
(0 real changes made)

. 
. ** Generate county IDS 
. foreach x in "o" "d" {
  2.         
.         make_fips state_fips_`x' county_fips_`x', ge
> n(fips_`x')
  3. 
. }

. 
. ** Check for within-state migration 
. gen same_county = fips_o == fips_d 

. tab year same_county

           |      same_county
      year |         0          1 |     Total
-----------+----------------------+----------
      2015 |    89,492  2,245,481 | 2,334,973 
      2016 |    91,109  2,255,901 | 2,347,010 
      2017 |    93,553  2,278,348 | 2,371,901 
      2018 |    96,080  2,306,022 | 2,402,102 
      2019 |    96,088  2,344,171 | 2,440,259 
      2020 |    71,827  1,877,155 | 1,948,982 
      2021 |    97,600  2,361,518 | 2,459,118 
      2022 |   106,231  2,430,426 | 2,536,657 
      2023 |    98,226  2,479,566 | 2,577,792 
-----------+----------------------+----------
     Total |   840,206 20,578,588 |21,418,794 

. tab year same_county if migrate1 == 2

           |      same_county
      year |         0          1 |     Total
-----------+----------------------+----------
      2015 |    42,597    172,956 |   215,553 
      2016 |    43,823    172,091 |   215,914 
      2017 |    45,058    174,386 |   219,444 
      2018 |    46,477    173,182 |   219,659 
      2019 |    46,329    168,101 |   214,430 
      2020 |    34,625    119,307 |   153,932 
      2021 |    46,470    148,925 |   195,395 
      2022 |    50,584    141,717 |   192,301 
      2023 |    47,498    135,794 |   183,292 
-----------+----------------------+----------
     Total |   403,461  1,406,459 | 1,809,920 

. 
. ** Tag HH head 
. gen byte hh_head = (relate == 1)

. 
. ** Compress file 
. compress 
  variable state_fips_o was int now byte
  variable hh_size was float now byte
  variable hh_adult_ct was float now byte
  variable hh_child_ct was float now byte
  variable same_county was float now byte
  (278,444,322 bytes saved)

. 
. ** Save 
. save "${data}working/acs_migration_file", replace 
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/acs_migration_file.dta saved

. 
. // Keep only observations with valid origin/destinat
> ion counties and YEAR
. drop if missing(year) | missing(fips_o) | missing(fi
> ps_d)
(0 observations deleted)

. 
. // Clean income (treat missing as 0; keep negative v
> alues as reported)
. replace inctot = 0 if missing(inctot)
(0 real changes made)

. gen double income_wt = inctot * perwt

. label var income_wt "Person income (INCTOT) weighted
>  by PERWT"

. 
. // --- Persons + income totals by origin/destination
> /year
. preserve

. keep year fips_o fips_d perwt income_wt

. collapse (sum) persons=perwt income_total=income_wt,
>  by(year fips_o fips_d)

. tempfile acs_pi

. save `acs_pi'
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000e
    > .tmp saved as .dta format

. restore

. 
. // --- Households by origin/destination/year
. // Use HHWT among household heads (RELATE==1) if ava
> ilable; else PERNUM==1 fallback.
. 
. preserve

. keep if hh_head
(10,269,992 observations deleted)

. keep year fips_o fips_d hhwt

. collapse (sum) households=hhwt, by(year fips_o fips_
> d)

. tempfile acs_hh

. save `acs_hh'
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000g
    > .tmp saved as .dta format

. restore

. 
. // --- Merge persons/income with households
. use `acs_pi', clear

. merge 1:1 year fips_o fips_d using `acs_hh', nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                        45,163
        from master                    45,163  
        from using                          0  

    Matched                           162,899  
    -----------------------------------------

. 
. label var persons "Estimated number of persons (sum 
> PERWT)"

. label var households "Estimated number of households
>  (sum HHWT among heads)"

. label var income_total "Estimated total personal inc
> ome (sum INCTOT*PERWT)"

. 
. // --- Derive state/county components for merges wit
> h name crosswalk
. gen int state_fips_o  = floor(fips_o/1000)

. gen int county_fips_o = mod(fips_o,1000)

. gen int state_fips_d  = floor(fips_d/1000)

. gen int county_fips_d = mod(fips_d,1000)

. 
. label var state_fips_o "State FIPS (origin)"

. label var county_fips_o "County FIPS (origin)"

. label var state_fips_d "State FIPS (destination)"

. label var county_fips_d "County FIPS (destination)"

. 
. // --- Merge in names (from NHGIS IDs snapshot)
. preserve

. use "${data}working/ids", clear

. rename (state_fips county_fips state_name county_nam
> e) (state_fips_o county_fips_o state_name_o county_n
> ame_o)

. tempfile ids_o

. save `ids_o'
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000i
    > .tmp saved as .dta format

. keep state_fips_o state_name_o 

. duplicates drop 

Duplicates in terms of all variables

(3,169 observations deleted)

. tempfile state_ids_o

. save `state_ids_o'
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000j
    > .tmp saved as .dta format

. restore

. merge m:1 state_fips_o county_fips_o using `ids_o', 
> keep(master match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                        46,997
        from master                    46,997  
        from using                          0  

    Matched                           161,065  
    -----------------------------------------

. drop state_name_o 

. merge m:1 state_fips_o using `state_ids_o', keep(mas
> ter match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           208,062  
    -----------------------------------------

. 
. preserve

. use "${data}working/ids", clear

. rename (state_fips county_fips state_name county_nam
> e) (state_fips_d county_fips_d state_name_d county_n
> ame_d)

. tempfile ids_d

. save `ids_d'
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000l
    > .tmp saved as .dta format

. keep state_fips_d state_name_d 

. duplicates drop 

Duplicates in terms of all variables

(3,169 observations deleted)

. tempfile state_ids_d

. save `state_ids_d'
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000m
    > .tmp saved as .dta format

. restore

. 
. merge m:1 state_fips_d county_fips_d using `ids_d', 
> keep(master match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                        50,197
        from master                    50,197  
        from using                          0  

    Matched                           157,865  
    -----------------------------------------

. drop state_name_d

. merge m:1 state_fips_d using `state_ids_d', keep(mas
> ter match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           208,062  
    -----------------------------------------

. order year ///
>     state_fips_o county_fips_o state_name_o county_n
> ame_o fips_o ///
>     state_fips_d county_fips_d state_name_d county_n
> ame_d fips_d ///
>     persons households income_total

. 
. sort year state_fips_o county_fips_o state_fips_d co
> unty_fips_d

. 
. replace county_name_o "Other" if county_fips_o == 0 
"Other invalid name
r(198);

end of do-file

r(198);

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_00001n
> .tmp"

. 
. replace county_name_o = "Other" if county_fips_o == 
> 0 
(46,948 real changes made)

. replace county_name_d = "Other" if county_fips_d == 
> 0 
(49,676 real changes made)

. 
. save "${data}working/acs_county_flow", replace
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/acs_county_flow.dta saved

. 
. // Optional: Multnomah-focused flow extract (origin 
> = Multnomah County, OR)
. // Multnomah County, OR = state 41, county 051
. preserve

. keep if state_fips_o == 41 & county_fips_o == 51
(207,316 observations deleted)

. save "${data}working/multnomah_acs_flow", replace
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/multnomah_acs_flow.dta saved

. restore

. 
end of do-file

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_00001o
> .tmp"

. /***************************************************
> **************************
> * Program:                      01_clean_data.do 
> * Author(s):            John Iselin 
> * Date Updated:         October 19, 2025
> 
> *** Demographic data via IPUMS NHGIS 
> ** Via https://www.nhgis.org/
> ** Downloaded on October 19, 2025
> ** EXTRACT DETAILS in "nhgis0031_ts_nominal_county_c
> odebook"
> 
> *** Economic data via BEA Regional Economic Accounts
>  (CAINC1)
> ** Via https://apps.bea.gov/regional/downloadzip.htm
> 
> *** ACS individual data via IPUMS USA 
> ** Via https://usa.ipums.org/usa/index.shtml
> ** Downloaded via R program 
> 
> *** IRS SOI County-Level Migration Files
> ** Via https://www.irs.gov/statistics/soi-tax-stats-
> migration-data
> 
> *** IRS SOI County-Level Files
> ** Via https://www.irs.gov/statistics/soi-tax-stats-
> county-data
> 
> *** NYTimes COVID Cases and Deaths 
> ** Via https://github.com/nytimes/covid-19-data
> 
> ****************************************************
> ***************************/
. 
. ** Start log file 
. capture log close log_01

. log using "${logs}01_log_data_clean_${pr_name}_${dat
> e}", replace text name(log_01)
------------------------------------------------------
      name:  log_01
       log:  C:/Users/ji252/Documents/GitHub/multnomah
> -county-tax/code/logs/01_log_data_clean_multnomah_20
> 25-12-15.log
  log type:  text
 opened on:  15 Dec 2025, 16:42:34

. 
. //--------------------------------------------------
. // STEP 0: Preliminary Set-Up 
. //--------------------------------------------------
. 
. ** Define labels 
. label define lb_move_type       0 "ERROR"           
>                     ///
>                                                     
>     1 "Non-movers"                  ///
>                                                     
>     2 "All movers"                  ///
>                                                     
>     3 "Domestic movers"             ///
>                                                     
>     4 "Within-state movers" ///
>                                                     
>     5 "Inter-state movers"  ///
>                                                     
>     6 "Foreign movers", modify

.                                                     
>     
. label define lb_agi             1 "Under $1"        
>             ///
>                                                     
>     2 "$1 under $10K"               ///
>                                                     
>     3 "$10K under $25K"             ///
>                                                     
>     4 "$25K under $50K"             ///
>                                                     
>     5 "$50K under $75K"             ///
>                                                     
>     6 "$75K under $100K"    ///
>                                                     
>     7 "$100K under $200K"   ///
>                                                     
>     8 "$200K or more", modify                       
>                                 

. 
. 
. ** Define Programs
. 
. ** Make FIPS code from state and county fips codes 
. capture program drop make_fips

. program define make_fips
  1.     syntax varlist(min=2 max=2 numeric), GEN(name
> )
  2. 
.     quietly {
  3.         tempvar s c
  4. 
.         local v1 : word 1 of `varlist'
  5.         local v2 : word 2 of `varlist'
  6. 
.         gen `s' = string(`v1', "%02.0f")
  7.         gen `c' = string(`v2', "%03.0f")
  8. 
.         gen `gen' = real(`s' + `c')
  9.     }
 10. end

. 
. ** Reclassify suppressed values as 0 
. 
. capture program drop unsuppress

. program define unsuppress
  1.     syntax varlist
  2. 
.     foreach v of varlist `varlist' {
  3.         replace `v' = 0 if `v' == -1
  4.     }
  5. end

. 
. //--------------------------------------------------
. // STEP -1: Acquire raw data (automated where possib
> le)
. //--------------------------------------------------
. /*
> This block downloads public-use source data directly
>  from official URLs if not present locally.
> 
> Automated downloads included:
>   - IRS SOI county-to-county migration: countyinflow
> YYZZ.csv / countyoutflowYYZZ.csv
>   - IRS SOI county data: YYincyallagi.csv
>   - BEA Regional Economic Accounts (CAINC1): CAINC1.
> zip (unzips to CAINC1__ALL_AREAS_*.csv and related f
> iles)
> 
> */
. 
. * Ensure expected directory structure exists
. capture mkdir "${data}"

. capture mkdir "${data}working"

. capture mkdir "${data}demographic"

. capture mkdir "${data}demographic/CAINC1"

. capture mkdir "${data}demographic/nhgis0031_csv"

. capture mkdir "${data}irs"

. capture mkdir "${data}covid"

. 
. * ----------------------------
. * IRS SOI: migration files
. * ----------------------------
. local irs_base "https://www.irs.gov/pub/irs-soi"

. 
. forvalues yy = 15/21 {
  2.     local zz = `yy' + 1
  3.     local fn_out "countyoutflow`yy'`zz'.csv"
  4.     local fn_in  "countyinflow`yy'`zz'.csv"
  5. 
.     capture confirm file "${data}irs/`fn_out'"
  6.     if _rc {
  7.         di as txt "Downloading (IRS SOI) `fn_out'
>  ..."
  8.         copy "`irs_base'/`fn_out'" "${data}irs/`f
> n_out'", replace
  9.     }
 10. 
.     capture confirm file "${data}irs/`fn_in'"
 11.     if _rc {
 12.         di as txt "Downloading (IRS SOI) `fn_in' 
> ..."
 13.         copy "`irs_base'/`fn_in'" "${data}irs/`fn
> _in'", replace
 14.     }
 15. }

. 
. * ----------------------------
. * IRS SOI: county income (AGI) files
. * ----------------------------
. forvalues yy = 15/22 {
  2.     local fn_inc "`yy'incyallagi.csv"
  3. 
.     capture confirm file "${data}irs/`fn_inc'"
  4.     if _rc {
  5.         di as txt "Downloading (IRS SOI) `fn_inc'
>  ..."
  6.         copy "`irs_base'/`fn_inc'" "${data}irs/`f
> n_inc'", replace
  7.     }
  8. }

. 
. * ----------------------------
. * BEA Regional: CAINC1.zip
. * ----------------------------
. local bea_dir "${data}demographic/CAINC1"

. local bea_url "https://apps.bea.gov/regional/zip/CAI
> NC1.zip"

. local bea_zip "`bea_dir'/CAINC1.zip"

. 
. * If we don't already have a CAINC1 "_ALL_AREAS" fil
> e, download + unzip the ZIP.
. local bea_files : dir "`bea_dir'" files "CAINC1__ALL
> _AREAS_*.csv"

. if "`bea_files'"=="" {
.     local bea_files : dir "`bea_dir'" files "CAINC1_
> _ALL_STATES_*.csv"
. }

. 
. if "`bea_files'"=="" {
.     di as txt "Downloading (BEA) CAINC1.zip ..."
Downloading (BEA) CAINC1.zip ...
.     copy "`bea_url'" "`bea_zip'", replace
(file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/demographic/CAINC1/CAINC1.zip not
    found)
. 
.     local curdir "`c(pwd)'"
.     cd "`bea_dir'"
C:\Users\ji252\Documents\GitHub\multnomah-county-tax\d
> ata\demographic\CAINC1
.     unzipfile "CAINC1.zip", replace
    inflating: CAINC1__ALL_AREAS_1969_2023.csv
    inflating: CAINC1__definition.xml
    inflating: CAINC1__Footnotes.html
    inflating: CAINC1_AK_1969_2023.csv
    inflating: CAINC1_AL_1969_2023.csv
    inflating: CAINC1_AR_1969_2023.csv
    inflating: CAINC1_AZ_1969_2023.csv
    inflating: CAINC1_CA_1969_2023.csv
    inflating: CAINC1_CO_1969_2023.csv
    inflating: CAINC1_CSA_1969_2023.csv
    inflating: CAINC1_CT_1969_2023.csv
    inflating: CAINC1_DC_1969_2023.csv
    inflating: CAINC1_DE_1969_2023.csv
    inflating: CAINC1_FL_1969_2023.csv
    inflating: CAINC1_GA_1969_2023.csv
    inflating: CAINC1_HI_1969_2023.csv
    inflating: CAINC1_IA_1969_2023.csv
    inflating: CAINC1_ID_1969_2023.csv
    inflating: CAINC1_IL_1969_2023.csv
    inflating: CAINC1_IN_1969_2023.csv
    inflating: CAINC1_KS_1969_2023.csv
    inflating: CAINC1_KY_1969_2023.csv
    inflating: CAINC1_LA_1969_2023.csv
    inflating: CAINC1_MA_1969_2023.csv
    inflating: CAINC1_MD_1969_2023.csv
    inflating: CAINC1_MDIV_1969_2023.csv
    inflating: CAINC1_ME_1969_2023.csv
    inflating: CAINC1_MI_1969_2023.csv
    inflating: CAINC1_MIC_1969_2023.csv
    inflating: CAINC1_MN_1969_2023.csv
    inflating: CAINC1_MO_1969_2023.csv
    inflating: CAINC1_MS_1969_2023.csv
    inflating: CAINC1_MSA_1969_2023.csv
    inflating: CAINC1_MT_1969_2023.csv
    inflating: CAINC1_NC_1969_2023.csv
    inflating: CAINC1_ND_1969_2023.csv
    inflating: CAINC1_NE_1969_2023.csv
    inflating: CAINC1_NH_1969_2023.csv
    inflating: CAINC1_NJ_1969_2023.csv
    inflating: CAINC1_NM_1969_2023.csv
    inflating: CAINC1_NV_1969_2023.csv
    inflating: CAINC1_NY_1969_2023.csv
    inflating: CAINC1_OH_1969_2023.csv
    inflating: CAINC1_OK_1969_2023.csv
    inflating: CAINC1_OR_1969_2023.csv
    inflating: CAINC1_PA_1969_2023.csv
    inflating: CAINC1_PORT_1969_2023.csv
    inflating: CAINC1_RI_1969_2023.csv
    inflating: CAINC1_SC_1969_2023.csv
    inflating: CAINC1_SD_1969_2023.csv
    inflating: CAINC1_TN_1969_2023.csv
    inflating: CAINC1_TX_1969_2023.csv
    inflating: CAINC1_US_1969_2023.csv
    inflating: CAINC1_UT_1969_2023.csv
    inflating: CAINC1_VA_1969_2023.csv
    inflating: CAINC1_VT_1969_2023.csv
    inflating: CAINC1_WA_1969_2023.csv
    inflating: CAINC1_WI_1969_2023.csv
    inflating: CAINC1_WV_1969_2023.csv
    inflating: CAINC1_WY_1969_2023.csv

successfully unzipped CAINC1.zip to current directory
total processed:  60
        skipped:  0
      extracted:  60
.     cd "`curdir'"
C:\Users\ji252\Documents\GitHub\multnomah-county-tax
. 
.     capture erase "`bea_zip'"
. }

. 
. * ----------------------------
. * NYTimes COVID Data 
. * ----------------------------
. local covid_dir "${data}covid"

. local covid_url "https://raw.githubusercontent.com/n
> ytimes/covid-19-data/master/us-counties.csv"

. 
. * If we don't already have a COVID file, download.
. local covid_file : dir "`covid_dir'" files "covid_ny
> t.csv"

. if "`covid_file'"=="" {
.     local covid_file : dir "`covid_dir'" files "covi
> d_nyt.csv"
. }

. 
. if "`covid_file'"=="" {
.     di as txt "Downloading (COVID)  ..."
Downloading (COVID)  ...
.     copy "`covid_url'" "`covid_dir'/covid_nyt.csv", 
> replace
. }

. 
. 
. 
. //--------------------------------------------------
> ---------
. // STEP 1: Import and Clean Demographic Data via IPU
> MS + BEA  
. //--------------------------------------------------
> ---------
. 
. ** Import data 
. import delimited        ///
>         "${data}demographic/nhgis0031_csv/nhgis0031_
> ts_nominal_county.csv", clear 
(encoding automatically selected: ISO-8859-1)
(15 vars, 54,673 obs)

. 
. ** Describe data 
. des 

Contains data
 Observations:        54,673                  
    Variables:            15                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
gisjoin         str8    %9s                   GISJOIN
year            str9    %9s                   YEAR
state           str20   %20s                  STATE
statefp         byte    %8.0g                 STATEFP
statenh         int     %8.0g                 STATENH
county          str46   %46s                  COUNTY
countyfp        int     %8.0g                 COUNTYFP
countynh        int     %8.0g                 COUNTYNH
name            str59   %59s                  NAME
av0aa           long    %12.0g                AV0AA
d15aa           long    %12.0g                D15AA
d15ab           long    %12.0g                D15AB
b79aa           long    %12.0g                B79AA
av0aam          long    %12.0g                AV0AAM
b79aam          long    %8.0g                 B79AAM
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.

. 
. ** Drop unnecc variables 
. drop gisjoin statenh countynh name 

. 
. ** Rename 
. rename state state_name 

. rename statefp state_fips 

. rename county county_name 

. rename countyfp county_fips 

. rename av0aa population 

. rename d15aa pop_urban 

. rename d15ab pop_rural 

. rename b79aa median_income 

. rename av0aam population_margin

. rename b79aam median_income_margin 

. 
. ** Create urban percent 
. gen percent_urban = pop_urban / population
(45,090 missing values generated)

. 
. ** Label variables 
. label var state_name "State name"

. label var state_fips "State FIPS code"

. label var county_name "County name"

. label var county_fips "County FIPS code"

. label var population "Population count"

. label var pop_rural "Rural population count"

. label var pop_urban "Urban population count"

. label var percent_urban "Percent of population in ur
> ban areas"

. label var median_income "Median household income (pr
> ior year)"

. label var population_margin "ACS margin for error: p
> opulation"

. label var median_income_margin "ACS margin for error
> : median income"

. 
. ** Save as temporary file 
. tempfile demo

. save `demo'
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000001
    > .tmp saved as .dta format

. 
. ** Create three datasets 
. 
. ** (1) Basic state and county IDs 
. keep if year == "2020" 
(51,452 observations deleted)

. keep state* county* 

. 
. ** Make FIPS 
. make_fips state_fips county_fips, gen(fips)

. 
. ** Save as state and county Ids 
. save "${data}working/ids", replace 
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/ids.dta saved

. clear  

. 
. ** (2) Population data 
. use `demo'

. keep if !missing(pop_urban) 
(45,090 observations deleted)

. tab year 

       YEAR |      Freq.     Percent        Cum.
------------+-----------------------------------
       2000 |      3,141       32.78       32.78
       2010 |      3,221       33.61       66.39
       2020 |      3,221       33.61      100.00
------------+-----------------------------------
      Total |      9,583      100.00

. 
. ** Keep 2020 
. keep if year == "2020"
(6,362 observations deleted)

. drop year median_income* population_margin

. 
. ** Make FIPS 
. make_fips state_fips county_fips, gen(fips)

. 
. ** Save data
. save "${data}working/population_2020", replace 
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/population_2020.dta saved

. clear  

. 
. ** (3) 2015-2019 ACS data 
. use `demo'

. keep if !missing(median_income) 
(6,447 observations deleted)

. tab year 

       YEAR |      Freq.     Percent        Cum.
------------+-----------------------------------
       2000 |      3,141        6.51        6.51
  2006-2010 |      3,221        6.68       13.19
  2007-2011 |      3,221        6.68       19.87
  2008-2012 |      3,221        6.68       26.55
  2009-2013 |      3,221        6.68       33.23
  2010-2014 |      3,220        6.68       39.91
  2011-2015 |      3,219        6.67       46.58
  2012-2016 |      3,220        6.68       53.26
  2013-2017 |      3,220        6.68       59.93
  2014-2018 |      3,219        6.67       66.61
  2015-2019 |      3,220        6.68       73.29
  2016-2020 |      3,220        6.68       79.96
  2017-2021 |      3,220        6.68       86.64
  2018-2022 |      3,221        6.68       93.32
  2019-2023 |      3,222        6.68      100.00
------------+-----------------------------------
      Total |     48,226      100.00

. 
. ** Keep 2020 
. keep if year == "2015-2019"
(45,006 observations deleted)

. drop year pop_rural pop_urban percent_urban

. 
. ** Make FIPS 
. make_fips state_fips county_fips, gen(fips)

. 
. ** Save data
. save "${data}working/acs_2015_2019_data", replace 
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/acs_2015_2019_data.dta saved

. 
. ** Rename for merge 
. rename population population_acs

. 
. ** Merge with other data 
. merge 1:1 state_fips county_fips using "${data}worki
> ng/population_2020",                ///
>         keep(match) nogen 

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                             3,219  
    -----------------------------------------

. 
. ** Save data
. save "${data}working/demographics_2020", replace 
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/demographics_2020.dta saved

. 
. ** Load BEA Data 
. import delimited "${data}demographic/CAINC1/CAINC1__
> ALL_AREAS_1969_2023.csv",   ///
>         clear 
(encoding automatically selected: ISO-8859-1)
(63 vars, 9,604 obs)

. 
. ** Drop unnecc variables 
. drop region tablename industryclassification unit ge
> oname 

. 
. ** Drop empty cells 
. drop if missing(linecode)
(4 observations deleted)

. 
. ** Update names 
. rename geofips fips 

. replace fips = subinstr(fips, `"""', "", .)
(9,600 real changes made)

. destring fips, replace 
fips: all characters numeric; replaced as long

. 
. ** Keep population and per-capita income, dropping p
> ersonal income (total)
. tab description linecode

                      |  LineCode
          Description |         1 |     Total
----------------------+-----------+----------
Per capita personal.. |         0 |     3,200 
Personal income (th.. |     3,200 |     3,200 
Population (persons.. |         0 |     3,200 
----------------------+-----------+----------
                Total |     3,200 |     9,600 


                      |  LineCode
          Description |         2 |     Total
----------------------+-----------+----------
Per capita personal.. |         0 |     3,200 
Personal income (th.. |         0 |     3,200 
Population (persons.. |     3,200 |     3,200 
----------------------+-----------+----------
                Total |     3,200 |     9,600 


                      |  LineCode
          Description |         3 |     Total
----------------------+-----------+----------
Per capita personal.. |     3,200 |     3,200 
Personal income (th.. |         0 |     3,200 
Population (persons.. |         0 |     3,200 
----------------------+-----------+----------
                Total |     3,200 |     9,600 

. drop if linecode == 1   
(3,200 observations deleted)

. drop description

.         
. ** Get V* to be in terms of years 
. ** V9 == 1969 
. forvalues i = 9/63 {
  2.         
.         local j = 1960 + `i'
  3.         rename v`i' value`j'
  4.         
. } // END I LOOP 

. 
. ** Reshape 
. reshape long value, i(fips linecode) j(year)
(j = 1969 1970 1971 1972 1973 1974 1975 1976 1977 1978
>  1979 1980 1981 1982 1983 1984 1985 1986 1987 1988 1
> 989 1990 1991 1992 1993 1994 1995 1996 1997 1998 199
> 9 2000 2001 2002 2003 2004 2005 2006 2007 2008 2009 
> 2010 2011 2012 2013 2014 2015 2016 2017 2018 2019 20
> 20 2021 2022 2023)

Data                               Wide   ->   Long
------------------------------------------------------
> -----------------------
Number of observations            6,400   ->   352,000
>      
Number of variables                  57   ->   4      
>      
j variable (55 values)                    ->   year
xij variables:
      value1969 value1970 ... value2023   ->   value
------------------------------------------------------
> -----------------------

. reshape wide value, i(fips year ) j(linecode)
(j = 2 3)

Data                               Long   ->   Wide
------------------------------------------------------
> -----------------------
Number of observations          352,000   ->   176,000
>      
Number of variables                   4   ->   4      
>      
j variable (2 values)          linecode   ->   (droppe
> d)
xij variables:
                                  value   ->   value2 
> value3
------------------------------------------------------
> -----------------------

. 
. ** Keep years 
. keep if inrange(year, 2015, 2023)
(147,200 observations deleted)

. 
. ** Rename values 
. rename value2 population 

. rename value3 per_capita_income

. 
. ** Drop if missing values 
. drop if population == "(NA)"
(239 observations deleted)

. 
. ** Keep only counties with all observations 
. bysort fips: gen ct = _N 

. tab ct

         ct |      Freq.     Percent        Cum.
------------+-----------------------------------
          4 |          8        0.03        0.03
          5 |          5        0.02        0.05
          9 |     28,548       99.95      100.00
------------+-----------------------------------
      Total |     28,561      100.00

. keep if ct == 9
(13 observations deleted)

. drop ct

. 
. ** Destring 
. destring population, replace 
population: all characters numeric; replaced as long

. destring per_capita_income, replace 
per_capita_income: all characters numeric; replaced as
>  long

. 
. ** Save data
. save "${data}working/bea_economics", replace 
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/bea_economics.dta saved

. 
. //--------------------------------------------------
> --
. // STEP 2: Import and Clean NYTimes COVID-19 Data 
. //--------------------------------------------------
> --
.  
. ** Import data 
. import delimited using "${data}covid/covid_nyt.csv",
>  varnames(1) clear case(lower) 
(encoding automatically selected: ISO-8859-1)
(6 vars, 2,502,832 obs)

. 
. ** Describe data 
. des 

Contains data
 Observations:     2,502,832                  
    Variables:             6                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
date            str10   %10s                  
county          str35   %35s                  
state           str24   %24s                  
fips            long    %12.0g                
cases           long    %12.0g                
deaths          long    %8.0g                 
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.

. 
. ** Set up date information 
. generate num_date = date(date, "YMD")

. format num_date %td

. drop date 

. 
. ** Rename 
. rename state state_name 

. rename county county_name 

. rename num_date date 

. 
. ** keep only counties 
. keep if !missing(fips)
(23,678 observations deleted)

. 
. ** Keep in 50 states 
. drop if state_name == "Puerto Rico"
(57,605 observations deleted)

. drop if state_name == "Virgin Islands"
(2,304 observations deleted)

. drop if state_name == "Northern Mariana Islands"
(1,452 observations deleted)

. 
. ** Sort 
. sort date fips 

. 
. ** Create panel 
. xtset fips date

Panel variable: fips (unbalanced)
 Time variable: date, 21jan2020 to 13may2022, but
                with gaps
         Delta: 1 day

. 
. ** Fill in panel 
. tsfill, full 

. 
. ** Fill in missing values 
. replace cases = 0 if missing(cases)
(228,991 real changes made)

. replace deaths = 0 if missing(deaths)
(228,991 real changes made)

. 
. ** Preserve data 
. preserve 

. 
. ** Preserve fips codes and names 
. keep if !missing(state_name)
(228,991 observations deleted)

. keep if !missing(county_name)
(0 observations deleted)

. duplicates drop fips state_name county_name, force 

Duplicates in terms of fips state_name county_name

(2,414,657 observations deleted)

. 
. ** Save as temporary data 
. tempfile state_county_names 

. save `state_county_names'
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000003
    > .tmp saved as .dta format

. clear 

. 
. ** Restore 
. restore 

. 
. ** Drop and merge in names 
. drop state_name county_name

. merge m:1 fips using `state_county_names', keep(mast
> er match) nogen 

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                         2,646,784  
    -----------------------------------------

. 
. ** Get year, month, day 
. gen year = year(date)

. gen month = month(date)

. gen day = day(date)

. 
. ** Order data 
. order date year month day fips state county cases de
> aths 

. 
. ** Calculate cumulative cases and deaths 
. bysort fips (date): gen cases_cum = sum(cases)

. bysort fips (date): gen deaths_cum = sum(deaths)

. 
. ** Merge population data (2020)
. merge m:1 fips using "${data}working/population_2020
> ", keep(match) nogen  
(variable county_name was str35, now str46 to
       accommodate using data's values)
(variable fips was long, now double to accommodate
       using data's values)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                         2,643,408  
    -----------------------------------------

. 
. ** Save file 
. save ${data}working/covid_cleaned.dta, replace 
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/covid_cleaned.dta saved

. 
. ** Generate Clustering Variables 
. 
. ** Keep one observation per month 
. keep year month fips state_name county_name cases_cu
> m deaths_cum population

. collapse (sum) cases deaths population, by(year mont
> h fips state_name county_name) 

. sort year month fips 

. egen date = group(year month)

. drop year month 

. 
. ** Generate per capita figures
. replace cases = 1000 * cases / population
(82,955 real changes made)

. replace deaths = 1000 * deaths / population
(74,723 real changes made)

. drop population 

. 
. ** Reshape wide 
. reshape wide cases deaths, i(fips state_name county_
> name) j(date)
(j = 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 2
> 0 21 22 23 24 25 26 27 28 29)

Data                               Long   ->   Wide
------------------------------------------------------
> -----------------------
Number of observations           90,828   ->   3,132  
>      
Number of variables                   6   ->   61     
>      
j variable (29 values)             date   ->   (droppe
> d)
xij variables:
                              cases_cum   ->   cases_c
> um1 cases_cum2 ... cases_cum29
                             deaths_cum   ->   deaths_
> cum1 deaths_cum2 ... deaths_cum29
------------------------------------------------------
> -----------------------

. 
. ** Save file 
. save ${data}working/covid_cleaned_wide.dta, replace 
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/covid_cleaned_wide.dta saved

. clear

. 
. //--------------------------------------------------
> --
. // STEP 3: Import and Clean ACS Micro Data via IPUMS
>  
. //--------------------------------------------------
> --
. 
. ** Load data 
. forvalues y = 2015(1)2023 {
  2.         
.         ** Import CSV
.         import delimited using "${data}acs/acs_`y'",
>  varnames(1) clear case(lower)
  3.         
.         ** Save as temporary data 
.         tempfile acs_`y'
  4.         save `acs_`y''
  5.         clear 
  6.         
. } // END YEAR LOOP 
(encoding automatically selected: ISO-8859-1)
(57 vars, 2,997,503 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000004
    > .tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(57 vars, 3,007,847 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000005
    > .tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(57 vars, 3,038,696 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000006
    > .tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(57 vars, 3,060,442 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000007
    > .tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(57 vars, 3,087,291 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000008
    > .tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(57 vars, 2,454,160 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000009
    > .tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(57 vars, 3,092,079 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000a
    > .tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(55 vars, 3,190,848 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000b
    > .tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(55 vars, 3,228,659 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000c
    > .tmp saved as .dta format

. 
. ** Append data 
. forvalues y = 2015(1)2023 {
  2.         
.         append using `acs_`y''  
  3.         
. } // END YEAR LOOP 
(variable cbserial was long, now double to
       accommodate using data's values)

. 
. ** Des 
. tab year 

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       2015 |  2,997,503       11.04       11.04
       2016 |  3,007,847       11.08       22.11
       2017 |  3,038,696       11.19       33.30
       2018 |  3,060,442       11.27       44.57
       2019 |  3,087,291       11.37       55.94
       2020 |  2,454,160        9.04       64.98
       2021 |  3,092,079       11.39       76.36
       2022 |  3,190,848       11.75       88.11
       2023 |  3,228,659       11.89      100.00
------------+-----------------------------------
      Total | 27,157,525      100.00

. 
. ** Define # of adults and kids in HHs 
. gen adult = age >= 18 

. gen child = age < 18 

. bysort year serial: gen hh_size = _N 

. bysort year serial: egen hh_adult_ct = total(adult)

. bysort year serial: egen hh_child_ct = total(child)

. 
. ** Sample 18+
. drop if child == 1 
(5,629,869 observations deleted)

. drop child adult 

. 
. ** Sample not living abroad last year 
. drop if migplac1 > 56 
(108,862 observations deleted)

. drop if migrate1 == 4 
(0 observations deleted)

. 
. ** Rename variables 
. rename statefip state_fips_d

. rename countyfip county_fips_d 

. 
. ** Set up origin data 
. fre migrate1

migrate1
------------------------------------------------------
> -----
              |      Freq.    Percent      Valid      
>  Cum.
--------------+---------------------------------------
> -----
Valid   1     |   1.92e+07      89.51      89.51      
> 89.51
        2     |    1809920       8.45       8.45      
> 97.96
        3     |     436745       2.04       2.04     1
> 00.00
        Total |   2.14e+07     100.00     100.00      
>      
------------------------------------------------------
> -----

. drop migrate1d

. tab migplac1

   migplac1 |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 | 19,172,129       89.51       89.51
          1 |     31,329        0.15       89.66
          2 |      5,825        0.03       89.68
          4 |     54,912        0.26       89.94
          5 |     21,714        0.10       90.04
          6 |    260,673        1.22       91.26
          8 |     52,539        0.25       91.50
          9 |     21,577        0.10       91.61
         10 |      5,369        0.03       91.63
         11 |      8,664        0.04       91.67
         12 |    152,989        0.71       92.38
         13 |     71,263        0.33       92.72
         15 |      9,845        0.05       92.76
         16 |     13,536        0.06       92.83
         17 |     86,306        0.40       93.23
         18 |     47,941        0.22       93.45
         19 |     21,469        0.10       93.55
         20 |     22,338        0.10       93.66
         21 |     31,888        0.15       93.81
         22 |     28,776        0.13       93.94
         23 |      7,911        0.04       93.98
         24 |     40,223        0.19       94.17
         25 |     48,684        0.23       94.39
         26 |     65,444        0.31       94.70
         27 |     35,177        0.16       94.86
         28 |     16,994        0.08       94.94
         29 |     45,200        0.21       95.15
         30 |      7,453        0.03       95.19
         31 |     13,567        0.06       95.25
         32 |     24,785        0.12       95.37
         33 |      8,787        0.04       95.41
         34 |     50,561        0.24       95.64
         35 |     12,299        0.06       95.70
         36 |    118,674        0.55       96.26
         37 |     70,555        0.33       96.59
         38 |      5,884        0.03       96.61
         39 |     81,541        0.38       96.99
         40 |     28,921        0.14       97.13
         41 |     36,246        0.17       97.30
         42 |     76,201        0.36       97.65
         44 |      6,551        0.03       97.68
         45 |     33,552        0.16       97.84
         46 |      6,067        0.03       97.87
         47 |     48,061        0.22       98.09
         48 |    197,912        0.92       99.02
         49 |     25,798        0.12       99.14
         50 |      4,106        0.02       99.16
         51 |     64,560        0.30       99.46
         53 |     64,790        0.30       99.76
         54 |     10,532        0.05       99.81
         55 |     35,653        0.17       99.98
         56 |      5,023        0.02      100.00
------------+-----------------------------------
      Total | 21,418,794      100.00

. rename migplac1 state_fips_o

. tab migcounty1

 migcounty1 |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 | 19,952,847       93.16       93.16
          1 |     35,752        0.17       93.32
          3 |     58,525        0.27       93.60
          5 |     21,286        0.10       93.70
          7 |     13,720        0.06       93.76
          9 |     11,958        0.06       93.82
         11 |     23,663        0.11       93.93
         13 |     53,927        0.25       94.18
         15 |      7,126        0.03       94.21
         17 |     21,840        0.10       94.31
         19 |     24,348        0.11       94.43
         20 |      2,061        0.01       94.44
         21 |     12,848        0.06       94.50
         23 |      7,725        0.04       94.53
         25 |     21,090        0.10       94.63
         27 |     15,274        0.07       94.70
         29 |     32,454        0.15       94.85
         31 |     57,529        0.27       95.12
         33 |     33,851        0.16       95.28
         35 |     24,912        0.12       95.40
         37 |     72,280        0.34       95.73
         39 |     10,381        0.05       95.78
         41 |      8,696        0.04       95.82
         43 |      8,893        0.04       95.86
         45 |      5,998        0.03       95.89
         47 |     22,821        0.11       96.00
         49 |     21,522        0.10       96.10
         51 |     17,488        0.08       96.18
         53 |     17,759        0.08       96.26
         55 |     12,676        0.06       96.32
         57 |     18,309        0.09       96.41
         59 |     30,944        0.14       96.55
         61 |     31,725        0.15       96.70
         63 |     12,421        0.06       96.76
         65 |     18,670        0.09       96.85
         67 |     29,982        0.14       96.99
         69 |      4,036        0.02       97.01
         71 |     27,649        0.13       97.13
         73 |     36,959        0.17       97.31
         75 |     11,968        0.06       97.36
         77 |      8,293        0.04       97.40
         79 |      7,681        0.04       97.44
         81 |     30,275        0.14       97.58
         83 |      9,053        0.04       97.62
         85 |     28,918        0.14       97.76
         87 |      6,680        0.03       97.79
         89 |     10,158        0.05       97.83
         91 |     15,565        0.07       97.91
         93 |      4,960        0.02       97.93
         95 |     19,883        0.09       98.02
         97 |     19,460        0.09       98.11
         99 |     19,554        0.09       98.21
        101 |     14,457        0.07       98.27
        103 |     18,351        0.09       98.36
        105 |      7,421        0.03       98.39
        107 |      5,600        0.03       98.42
        109 |     10,761        0.05       98.47
        111 |     14,844        0.07       98.54
        113 |     30,918        0.14       98.68
        115 |      4,818        0.02       98.71
        117 |      7,798        0.04       98.74
        119 |     14,739        0.07       98.81
        121 |     10,181        0.05       98.86
        123 |      3,671        0.02       98.88
        125 |      9,036        0.04       98.92
        127 |      2,348        0.01       98.93
        129 |      1,814        0.01       98.94
        133 |      5,313        0.02       98.96
        135 |      7,844        0.04       99.00
        139 |      5,952        0.03       99.03
        141 |      6,936        0.03       99.06
        143 |      4,286        0.02       99.08
        145 |      1,975        0.01       99.09
        147 |      2,327        0.01       99.10
        149 |      2,146        0.01       99.11
        151 |      1,900        0.01       99.12
        153 |      5,155        0.02       99.14
        157 |     11,532        0.05       99.20
        159 |        751        0.00       99.20
        160 |        149        0.00       99.20
        161 |      4,716        0.02       99.22
        163 |     13,817        0.06       99.29
        165 |      2,418        0.01       99.30
        167 |      5,023        0.02       99.32
        169 |        850        0.00       99.33
        171 |        529        0.00       99.33
        173 |        264        0.00       99.33
        179 |      1,879        0.01       99.34
        183 |     11,521        0.05       99.39
        185 |        871        0.00       99.40
        187 |      2,303        0.01       99.41
        189 |      6,599        0.03       99.44
        191 |        759        0.00       99.44
        197 |      3,401        0.02       99.46
        201 |     29,158        0.14       99.59
        209 |      2,664        0.01       99.60
        215 |      3,046        0.01       99.62
        223 |        758        0.00       99.62
        227 |        946        0.00       99.63
        245 |      3,068        0.01       99.64
        251 |      1,020        0.00       99.65
        257 |        850        0.00       99.65
        303 |      3,247        0.02       99.67
        309 |      2,351        0.01       99.68
        313 |        456        0.00       99.68
        329 |      1,177        0.01       99.68
        339 |      3,176        0.01       99.70
        355 |      2,646        0.01       99.71
        367 |        977        0.00       99.72
        375 |      1,001        0.00       99.72
        381 |      1,199        0.01       99.73
        423 |      1,497        0.01       99.73
        439 |     14,652        0.07       99.80
        441 |      1,419        0.01       99.81
        451 |        952        0.00       99.81
        453 |     12,549        0.06       99.87
        479 |      1,301        0.01       99.88
        485 |      1,288        0.01       99.88
        491 |      4,036        0.02       99.90
        510 |     10,140        0.05       99.95
        550 |      1,187        0.01       99.95
        650 |      1,031        0.00       99.96
        700 |      1,438        0.01       99.97
        710 |        466        0.00       99.97
        760 |      2,799        0.01       99.98
        810 |      3,933        0.02      100.00
------------+-----------------------------------
      Total | 21,418,794      100.00

. rename migcounty1 county_fips_o

. 
. ** Use migrate1 to update values 
. 
. ** Within same house 
. replace state_fips_o = state_fips_d if migrate1 == 1
(19,172,129 real changes made)

. replace county_fips_o = county_fips_d if migrate1 ==
>  1 
(11,640,515 real changes made)

. 
. ** Within same state 
. replace state_fips_o = state_fips_d if migrate1 == 2
(0 real changes made)

. 
. ** Generate county IDS 
. foreach x in "o" "d" {
  2.         
.         make_fips state_fips_`x' county_fips_`x', ge
> n(fips_`x')
  3. 
. }

. 
. ** Check for within-state migration 
. gen same_county = fips_o == fips_d 

. tab year same_county

           |      same_county
      year |         0          1 |     Total
-----------+----------------------+----------
      2015 |    89,492  2,245,481 | 2,334,973 
      2016 |    91,109  2,255,901 | 2,347,010 
      2017 |    93,553  2,278,348 | 2,371,901 
      2018 |    96,080  2,306,022 | 2,402,102 
      2019 |    96,088  2,344,171 | 2,440,259 
      2020 |    71,827  1,877,155 | 1,948,982 
      2021 |    97,600  2,361,518 | 2,459,118 
      2022 |   106,231  2,430,426 | 2,536,657 
      2023 |    98,226  2,479,566 | 2,577,792 
-----------+----------------------+----------
     Total |   840,206 20,578,588 |21,418,794 

. tab year same_county if migrate1 == 2

           |      same_county
      year |         0          1 |     Total
-----------+----------------------+----------
      2015 |    42,597    172,956 |   215,553 
      2016 |    43,823    172,091 |   215,914 
      2017 |    45,058    174,386 |   219,444 
      2018 |    46,477    173,182 |   219,659 
      2019 |    46,329    168,101 |   214,430 
      2020 |    34,625    119,307 |   153,932 
      2021 |    46,470    148,925 |   195,395 
      2022 |    50,584    141,717 |   192,301 
      2023 |    47,498    135,794 |   183,292 
-----------+----------------------+----------
     Total |   403,461  1,406,459 | 1,809,920 

. 
. ** Tag HH head 
. gen byte hh_head = (relate == 1)

. 
. ** Compress file 
. compress 
  variable state_fips_o was int now byte
  variable hh_size was float now byte
  variable hh_adult_ct was float now byte
  variable hh_child_ct was float now byte
  variable same_county was float now byte
  (278,444,322 bytes saved)

. 
. ** Save 
. save "${data}working/acs_migration_file", replace 
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/acs_migration_file.dta saved

. 
. // Keep only observations with valid origin/destinat
> ion counties and YEAR
. drop if missing(year) | missing(fips_o) | missing(fi
> ps_d)
(0 observations deleted)

. 
. // Clean income (treat missing as 0; keep negative v
> alues as reported)
. replace inctot = 0 if missing(inctot)
(0 real changes made)

. gen double income_wt = inctot * perwt

. label var income_wt "Person income (INCTOT) weighted
>  by PERWT"

. 
. // --- Persons + income totals by origin/destination
> /year
. preserve

. keep year fips_o fips_d perwt income_wt

. collapse (sum) persons=perwt income_total=income_wt,
>  by(year fips_o fips_d)

. tempfile acs_pi

. save `acs_pi'
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000e
    > .tmp saved as .dta format

. restore

. 
. // --- Households by origin/destination/year
. // Use HHWT among household heads (RELATE==1) if ava
> ilable; else PERNUM==1 fallback.
. 
. preserve

. keep if hh_head
(10,269,992 observations deleted)

. keep year fips_o fips_d hhwt

. collapse (sum) households=hhwt, by(year fips_o fips_
> d)

. tempfile acs_hh

. save `acs_hh'
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000g
    > .tmp saved as .dta format

. restore

. 
. // --- Merge persons/income with households
. use `acs_pi', clear

. merge 1:1 year fips_o fips_d using `acs_hh', nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                        45,163
        from master                    45,163  
        from using                          0  

    Matched                           162,899  
    -----------------------------------------

. 
. label var persons "Estimated number of persons (sum 
> PERWT)"

. label var households "Estimated number of households
>  (sum HHWT among heads)"

. label var income_total "Estimated total personal inc
> ome (sum INCTOT*PERWT)"

. 
. // --- Derive state/county components for merges wit
> h name crosswalk
. gen int state_fips_o  = floor(fips_o/1000)

. gen int county_fips_o = mod(fips_o,1000)

. gen int state_fips_d  = floor(fips_d/1000)

. gen int county_fips_d = mod(fips_d,1000)

. 
. label var state_fips_o "State FIPS (origin)"

. label var county_fips_o "County FIPS (origin)"

. label var state_fips_d "State FIPS (destination)"

. label var county_fips_d "County FIPS (destination)"

. 
. // --- Merge in names (from NHGIS IDs snapshot)
. preserve

. use "${data}working/ids", clear

. rename (state_fips county_fips state_name county_nam
> e) (state_fips_o county_fips_o state_name_o county_n
> ame_o)

. tempfile ids_o

. save `ids_o'
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000i
    > .tmp saved as .dta format

. keep state_fips_o state_name_o 

. duplicates drop 

Duplicates in terms of all variables

(3,169 observations deleted)

. tempfile state_ids_o

. save `state_ids_o'
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000j
    > .tmp saved as .dta format

. restore

. merge m:1 state_fips_o county_fips_o using `ids_o', 
> keep(master match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                        46,997
        from master                    46,997  
        from using                          0  

    Matched                           161,065  
    -----------------------------------------

. drop state_name_o 

. merge m:1 state_fips_o using `state_ids_o', keep(mas
> ter match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           208,062  
    -----------------------------------------

. 
. preserve

. use "${data}working/ids", clear

. rename (state_fips county_fips state_name county_nam
> e) (state_fips_d county_fips_d state_name_d county_n
> ame_d)

. tempfile ids_d

. save `ids_d'
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000l
    > .tmp saved as .dta format

. keep state_fips_d state_name_d 

. duplicates drop 

Duplicates in terms of all variables

(3,169 observations deleted)

. tempfile state_ids_d

. save `state_ids_d'
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000m
    > .tmp saved as .dta format

. restore

. 
. merge m:1 state_fips_d county_fips_d using `ids_d', 
> keep(master match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                        50,197
        from master                    50,197  
        from using                          0  

    Matched                           157,865  
    -----------------------------------------

. drop state_name_d

. merge m:1 state_fips_d using `state_ids_d', keep(mas
> ter match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           208,062  
    -----------------------------------------

. order year ///
>     state_fips_o county_fips_o state_name_o county_n
> ame_o fips_o ///
>     state_fips_d county_fips_d state_name_d county_n
> ame_d fips_d ///
>     persons households income_total

. 
. sort year state_fips_o county_fips_o state_fips_d co
> unty_fips_d

. 
. replace county_name_o = "Other" if county_fips_o == 
> 0 
(46,948 real changes made)

. replace county_name_d = "Other" if county_fips_d == 
> 0 
(49,676 real changes made)

. 
. save "${data}working/acs_county_flow", replace
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/acs_county_flow.dta saved

. 
. // Optional: Multnomah-focused flow extract (origin 
> = Multnomah County, OR)
. // Multnomah County, OR = state 41, county 051
. preserve

. keep if state_fips_o == 41 & county_fips_o == 51
(207,316 observations deleted)

. save "${data}working/multnomah_acs_flow", replace
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/multnomah_acs_flow.dta saved

. clear

. 
. 
. 
. //--------------------------------------------------
> --
. // STEP 4: Import and Clean IRS Migration Data 
. //--------------------------------------------------
> --
. 
. ** Loop over years 
. forvalues y = 15(1)21 {
  2.         
.         local start = `y'
  3.         local end = `y' + 1 
  4.         
.         ** Import data (out)
.         import delimited "${data}irs/countyoutflow`s
> tart'`end'.csv", clear 
  5.         
.         ** Describe data 
.         des 
  6.         
.         ** Generate year 
.         gen year = 2000 + `y' 
  7.         
.         ** Drop Regional Values 
.         drop if y2_state == "DS"
  8.         
.         ** Drop Foreign Migration 
.         drop if y2_state == "FR"
  9.         
.         ** Drop observations without a county
.         drop if y1_countyfips == 0 
 10.         
.         ** Deal with suppressed values 
.         unsuppress n1 n2 agi
 11.         
.         ** Drop unnecc variables 
.         drop y2_state y2_countyname
 12.                 
.         ** Create two versions: gross and net 
.         tempfile tmp
 13.         save `tmp'
 14.         
.         ** Gross first 
.         
.         ** Keep gross categories 
.         keep if ///
>                 (y1_statefips == y2_statefips & y1_c
> ountyfips == y2_countyfips) |       ///
>                 inlist(y2_statefips, 96, 97, 98)
 15. 
.         ** Clean up 
.         gen move_type = 0 
 16.         
.         ** Stayers 
.         replace move_type = 1 if        (y1_statefip
> s == y2_statefips) &        ///
>                                                     
>             (y1_countyfips == y2_countyfips) 
 17.         
.         ** Movers
.         replace move_type = 2 if        y2_statefips
>  == 96              // ALL 
 18.         replace move_type = 3 if        y2_statef
> ips == 97 &    ///
>                                                     
>             y2_countyfips == 0              // Domes
> tic Total
 19.         replace move_type = 4 if        y2_statef
> ips == 97 &    ///
>                                                     
>             y2_countyfips == 1              // Withi
> n-state
 20.         replace move_type = 5 if        y2_statef
> ips == 97 &    ///
>                                                     
>             y2_countyfips == 3              // Betwe
> en-states 
 21.         replace move_type = 6 if        y2_statef
> ips == 98              // Foreign 
 22.         
.         ** Label movers 
.         label values move_type lb_move_type 
 23.         
.         ** Generate total category 
.         foreach var of varlist n1 n2 agi {
 24.                 
.                 gen tmp = `var' if inlist(move_type,
>  1, 2)
 25.                 bysort y1_statefips y1_countyfips
> : egen `var'_total = total(tmp)
 26.                 drop tmp 
 27.                 
.         } // END VAR LOOP 
 28.         
.         ** Drop unnecc variables 
.         drop y2_* 
 29.         
.         ** Sort 
.         sort year y1_statefips y1_countyfips move_ty
> pe 
 30. 
.         ** Order 
.         order year y1_statefips y1_countyfips move_t
> ype 
 31.         
.         ** Rename 
.         rename y1_countyfips county_fips 
 32.         rename y1_statefips state_fips 
 33.         
.         ** Label variables 
.         label var year "Tax year (year before move)"
 34.         label var state_fips "State FIPS code (or
> igin state)"
 35.         label var county_fips "County FIPS code (
> origin county)"
 36.         label var move_type "Mover category"
 37.         label var n1 "Number of returns"
 38.         label var n2 "Number of exemptions"
 39.         label var agi "Adjusted Gross Income"
 40.         label var n1_total "Number of returns, co
> unty total (origin)"
 41.         label var n2_total "Number of exemptions,
>  county total (origin)"
 42.         label var agi_total "Adjusted Gross Incom
> e, county total (origin)"
 43.         
.         ** Save 
.         save "${data}working/irs_county_gross_out_`y
> '", replace 
 44.         
.         ** Create version for merge with net 
.         keep if move_type == 3 
 45.         
.         ** Rename variables 
.         rename n1 n1_mover
 46.         rename n2 n2_mover 
 47.         rename agi agi_mover 
 48.         
.         label var n1_mover "Number of domestic mover
>  returns"
 49.         label var n2_mover "Number of domestic mo
> ver exemptions"
 50.         label var agi_mover "Adjusted Gross Incom
> e, domestic movers"
 51.         
.         ** Save as temp file 
.         tempfile merge 
 52.         save `merge'
 53.         clear 
 54.         
.         ** Next, create flow file 
.         use `tmp', clear 
 55.         
.         ** Drop aggregate values 
.         drop if inlist(y2_statefips, 96, 97, 98)
 56.         drop if (y1_statefips == y2_statefips & y
> 1_countyfips == y2_countyfips) 
 57.         
.         ** Sort 
.         sort year y1_statefips y1_countyfips y2_stat
> efips y2_countyfips 
 58. 
.         ** Order 
.         order year y1_statefips y1_countyfips y2_sta
> tefips y2_countyfips
 59. 
.         
.         ** Rename 
.         rename y1_countyfips county_fips 
 60.         rename y1_statefips state_fips 
 61.         rename y2_countyfips y2_county_fips 
 62.         rename y2_statefips y2_state_fips       
 63.         
.         ** Label variables 
.         label var year "Tax year (year before move)"
 64.         label var state_fips "State FIPS code (or
> igin state)"
 65.         label var county_fips "County FIPS code (
> origin county)"
 66.         label var y2_state_fips "State FIPS code 
> (dest. state)"
 67.         label var y2_county_fips "County FIPS cod
> e (dest. county)"      
 68.         label var n1 "Number of returns"
 69.         label var n2 "Number of exemptions"
 70.         label var agi "Adjusted Gross Income"
 71.         
.         ** Merge with county of origin data 
.         merge m:1 state_fips county_fips using `merg
> e', nogen keep(master match)
 72.         
.         ** Rename 
.         rename state_fips state_fips_o
 73.         rename county_fips county_fips_o
 74.         rename y2_* *_d 
 75.         
.         ** Dropo unnecc variable 
.         drop move_type 
 76.         
.         ** Save 
.         save "${data}working/irs_county_flow_`y'", r
> eplace 
 77.         clear
 78.         
.         ** Import data (in)
.         import delimited "${data}irs/countyinflow`st
> art'`end'.csv", clear 
 79.         
.         ** Describe data 
.         des 
 80. 
.         ** Generate year 
.         gen year = 2000 + `y' 
 81.         
.         ** Drop Regional Values 
.         drop if y1_state == "DS"
 82.         
.         ** Drop Foreign Migration 
.         drop if y1_state == "FR"
 83.         
.         ** Drop observations with no county ID 
.         drop if y2_countyfips == 0 
 84.         
.         ** Keep gross categories 
.         keep if ///
>                 (y1_statefips == y2_statefips & y1_c
> ountyfips == y2_countyfips) |       ///
>                 inlist(y1_statefips, 96, 97, 98)
 85. 
.         ** Clean up 
.         gen move_type = 0 
 86.         
.         ** Deal with suppressed values 
.         unsuppress n1 n2 agi
 87.         
.         ** Stayers 
.         replace move_type = 1 if        (y1_statefip
> s == y2_statefips) &        ///
>                                                     
>             (y1_countyfips == y2_countyfips) 
 88.         
.         ** Movers
.         replace move_type = 2 if        y1_statefips
>  == 96              // ALL 
 89.         replace move_type = 3 if        y1_statef
> ips == 97 &    ///
>                                                     
>             y1_countyfips == 0              // Domes
> tic Total
 90.         replace move_type = 4 if        y1_statef
> ips == 97 &    ///
>                                                     
>             y1_countyfips == 1              // Withi
> n-state
 91.         replace move_type = 5 if        y1_statef
> ips == 97 &    ///
>                                                     
>             y1_countyfips == 3              // Betwe
> en-states 
 92.         replace move_type = 6 if        y1_statef
> ips == 98              // Foreign 
 93.         
.         ** Label move variable  
.         label values move_type lb_move_type 
 94.         
.         ** Generate total category 
.         foreach var of varlist n1 n2 agi {
 95.                 
.                 gen tmp = `var' if inlist(move_type,
>  1, 2)
 96.                 bysort y2_statefips y2_countyfips
> : egen `var'_total = total(tmp)
 97.                 drop tmp 
 98.                 
.         } // END VAR LOOP 
 99.         
.         ** Drop unnecc variables 
.         drop y1_*
100.         
.         ** Sort 
.         sort year y2_statefips y2_countyfips move_ty
> pe 
101. 
.         ** Order 
.         order year y2_statefips y2_countyfips move_t
> ype 
102.         
.         ** Rename 
.         rename y2_countyfips county_fips 
103.         rename y2_statefips state_fips 
104.         
.         ** Label variables 
.         label var year "Tax year (year before move)"
105.         label var state_fips "State FIPS code (de
> st. state)"
106.         label var county_fips "County FIPS code (
> dest. county)"
107.         label var move_type "Mover category"
108.         label var n1 "Number of returns"
109.         label var n2 "Number of exemptions"
110.         label var agi "Adjusted Gross Income"
111.         label var n1_total "Number of returns, co
> unty total (dest.)"
112.         label var n2_total "Number of exemptions,
>  county total (dest.)"
113.         label var agi_total "Adjusted Gross Incom
> e, county total (dest.)"
114.         
.         ** Save 
.         save "${data}working/irs_county_gross_in_`y'
> ", replace 
115.         clear 
116.         
. } // END YEAR LOOP 
(encoding automatically selected: ISO-8859-1)
(9 vars, 86,481 obs)

Contains data
 Observations:        86,481                  
    Variables:             9                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y2_state        str2    %9s                   
y2_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(15,289 observations deleted)
(2,937 observations deleted)
(254 observations deleted)
(2,056 real changes made)
(2,056 real changes made)
(2,056 real changes made)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000o
    > .tmp saved as .dta format
(50,007 observations deleted)
(3,141 real changes made)
(3,141 real changes made)
(3,141 real changes made)
(3,140 real changes made)
(3,140 real changes made)
(2,291 real changes made)
(11,712 missing values generated)
(11,712 missing values generated)
(11,712 missing values generated)
(file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_out_15.dta
    not found)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_out_15.dta
    saved
(14,853 observations deleted)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000p
    > .tmp saved as .dta format
(14,853 observations deleted)
(3,141 observations deleted)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            50,007  
    -----------------------------------------
(file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_flow_15.dta not
    found)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_flow_15.dta saved
(encoding automatically selected: ISO-8859-1)
(9 vars, 86,330 obs)

Contains data
 Observations:        86,330                  
    Variables:             9                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y1_state        str2    %9s                   
y1_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(15,315 observations deleted)
(2,814 observations deleted)
(254 observations deleted)
(50,005 observations deleted)
(2,041 real changes made)
(2,041 real changes made)
(2,041 real changes made)
(3,141 real changes made)
(3,141 real changes made)
(3,141 real changes made)
(3,140 real changes made)
(3,140 real changes made)
(2,239 real changes made)
(11,660 missing values generated)
(11,660 missing values generated)
(11,660 missing values generated)
(file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_in_15.dta
    not found)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_in_15.dta
    saved
(encoding automatically selected: ISO-8859-1)
(9 vars, 98,948 obs)

Contains data
 Observations:        98,948                  
    Variables:             9                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y2_state        str2    %9s                   
y2_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(15,372 observations deleted)
(2,360 observations deleted)
(254 observations deleted)
(1,877 real changes made)
(1,877 real changes made)
(1,877 real changes made)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000q
    > .tmp saved as .dta format
(63,249 observations deleted)
(3,140 real changes made)
(3,141 real changes made)
(3,141 real changes made)
(3,140 real changes made)
(3,141 real changes made)
(2,010 real changes made)
(11,432 missing values generated)
(11,432 missing values generated)
(11,432 missing values generated)
(file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_out_16.dta
    not found)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_out_16.dta
    saved
(14,572 observations deleted)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000r
    > .tmp saved as .dta format
(14,573 observations deleted)
(3,140 observations deleted)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            63,249  
    -----------------------------------------
(file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_flow_16.dta not
    found)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_flow_16.dta saved
(encoding automatically selected: ISO-8859-1)
(9 vars, 98,874 obs)

Contains data
 Observations:        98,874                  
    Variables:             9                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y1_state        str2    %9s                   
y1_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(15,432 observations deleted)
(2,282 observations deleted)
(254 observations deleted)
(63,249 observations deleted)
(1,788 real changes made)
(1,788 real changes made)
(1,788 real changes made)
(3,140 real changes made)
(3,141 real changes made)
(3,141 real changes made)
(3,140 real changes made)
(3,140 real changes made)
(1,955 real changes made)
(11,376 missing values generated)
(11,376 missing values generated)
(11,376 missing values generated)
(file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_in_16.dta
    not found)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_in_16.dta
    saved
(encoding automatically selected: ISO-8859-1)
(9 vars, 87,820 obs)

Contains data
 Observations:        87,820                  
    Variables:             9                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y2_state        str2    %9s                   
y2_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(15,300 observations deleted)
(2,364 observations deleted)
(254 observations deleted)
(1,942 real changes made)
(1,942 real changes made)
(1,942 real changes made)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000s
    > .tmp saved as .dta format
(52,173 observations deleted)
(3,141 real changes made)
(3,141 real changes made)
(3,141 real changes made)
(3,140 real changes made)
(3,140 real changes made)
(2,026 real changes made)
(11,447 missing values generated)
(11,447 missing values generated)
(11,447 missing values generated)
(file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_out_17.dta
    not found)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_out_17.dta
    saved
(14,588 observations deleted)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000t
    > .tmp saved as .dta format
(14,588 observations deleted)
(3,141 observations deleted)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            52,173  
    -----------------------------------------
(file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_flow_17.dta not
    found)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_flow_17.dta saved
(encoding automatically selected: ISO-8859-1)
(9 vars, 87,932 obs)

Contains data
 Observations:        87,932                  
    Variables:             9                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y1_state        str2    %9s                   
y1_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(15,368 observations deleted)
(2,403 observations deleted)
(254 observations deleted)
(52,174 observations deleted)
(1,919 real changes made)
(1,919 real changes made)
(1,919 real changes made)
(3,141 real changes made)
(3,141 real changes made)
(3,141 real changes made)
(3,140 real changes made)
(3,140 real changes made)
(2,030 real changes made)
(11,451 missing values generated)
(11,451 missing values generated)
(11,451 missing values generated)
(file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_in_17.dta
    not found)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_in_17.dta
    saved
(encoding automatically selected: ISO-8859-1)
(9 vars, 83,878 obs)

Contains data
 Observations:        83,878                  
    Variables:             9                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y2_state        str2    %9s                   
y2_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(14,919 observations deleted)
(2,298 observations deleted)
(0 observations deleted)
(53 real changes made)
(53 real changes made)
(53 real changes made)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000u
    > .tmp saved as .dta format
(51,090 observations deleted)
(3,141 real changes made)
(3,107 real changes made)
(3,107 real changes made)
(3,103 real changes made)
(2,778 real changes made)
(335 real changes made)
(9,323 missing values generated)
(9,323 missing values generated)
(9,323 missing values generated)
(file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_out_18.dta
    not found)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_out_18.dta
    saved
(12,464 observations deleted)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000v
    > .tmp saved as .dta format
(12,430 observations deleted)
(3,141 observations deleted)

    Result                      Number of obs
    -----------------------------------------
    Not matched                            34
        from master                        34  
        from using                          0  

    Matched                            51,056  
    -----------------------------------------
(file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_flow_18.dta not
    found)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_flow_18.dta saved
(encoding automatically selected: ISO-8859-1)
(9 vars, 83,762 obs)

Contains data
 Observations:        83,762                  
    Variables:             9                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y1_state        str2    %9s                   
y1_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(14,890 observations deleted)
(2,290 observations deleted)
(0 observations deleted)
(51,090 observations deleted)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(3,141 real changes made)
(3,086 real changes made)
(3,086 real changes made)
(3,082 real changes made)
(2,729 real changes made)
(368 real changes made)
(9,265 missing values generated)
(9,265 missing values generated)
(9,265 missing values generated)
(file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_in_18.dta
    not found)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_in_18.dta
    saved
(encoding automatically selected: ISO-8859-1)
(9 vars, 87,325 obs)

Contains data
 Observations:        87,325                  
    Variables:             9                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y2_state        str2    %9s                   
y2_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(14,937 observations deleted)
(2,272 observations deleted)
(0 observations deleted)
(62 real changes made)
(62 real changes made)
(62 real changes made)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000w
    > .tmp saved as .dta format
(54,560 observations deleted)
(3,142 real changes made)
(3,104 real changes made)
(3,104 real changes made)
(3,101 real changes made)
(2,773 real changes made)
(332 real changes made)
(9,310 missing values generated)
(9,310 missing values generated)
(9,310 missing values generated)
(file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_out_19.dta
    not found)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_out_19.dta
    saved
(12,452 observations deleted)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000x
    > .tmp saved as .dta format
(12,414 observations deleted)
(3,142 observations deleted)

    Result                      Number of obs
    -----------------------------------------
    Not matched                            38
        from master                        38  
        from using                          0  

    Matched                            54,522  
    -----------------------------------------
(file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_flow_19.dta not
    found)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_flow_19.dta saved
(encoding automatically selected: ISO-8859-1)
(9 vars, 87,552 obs)

Contains data
 Observations:        87,552                  
    Variables:             9                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y1_state        str2    %9s                   
y1_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(15,060 observations deleted)
(2,323 observations deleted)
(0 observations deleted)
(54,560 observations deleted)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(3,142 real changes made)
(3,102 real changes made)
(3,102 real changes made)
(3,097 real changes made)
(2,805 real changes made)
(361 real changes made)
(9,365 missing values generated)
(9,365 missing values generated)
(9,365 missing values generated)
(file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_in_19.dta
    not found)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_in_19.dta
    saved
(encoding automatically selected: ISO-8859-1)
(9 vars, 89,511 obs)

Contains data
 Observations:        89,511                  
    Variables:             9                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y2_state        str2    %9s                   
y2_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(14,963 observations deleted)
(2,175 observations deleted)
(0 observations deleted)
(79 real changes made)
(79 real changes made)
(79 real changes made)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000010
    > .tmp saved as .dta format
(56,831 observations deleted)
(3,143 real changes made)
(3,097 real changes made)
(3,097 real changes made)
(3,094 real changes made)
(2,787 real changes made)
(324 real changes made)
(9,302 missing values generated)
(9,302 missing values generated)
(9,302 missing values generated)
(file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_out_20.dta
    not found)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_out_20.dta
    saved
(12,445 observations deleted)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000011
    > .tmp saved as .dta format
(12,399 observations deleted)
(3,143 observations deleted)

    Result                      Number of obs
    -----------------------------------------
    Not matched                            46
        from master                        46  
        from using                          0  

    Matched                            56,785  
    -----------------------------------------
(file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_flow_20.dta not
    found)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_flow_20.dta saved
(encoding automatically selected: ISO-8859-1)
(9 vars, 89,850 obs)

Contains data
 Observations:        89,850                  
    Variables:             9                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y1_state        str2    %9s                   
y1_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(15,132 observations deleted)
(2,263 observations deleted)
(0 observations deleted)
(56,835 observations deleted)
(1 real change made)
(1 real change made)
(1 real change made)
(3,143 real changes made)
(3,101 real changes made)
(3,101 real changes made)
(3,098 real changes made)
(2,838 real changes made)
(339 real changes made)
(9,376 missing values generated)
(9,376 missing values generated)
(9,376 missing values generated)
(file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_in_20.dta
    not found)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_in_20.dta
    saved
(encoding automatically selected: ISO-8859-1)
(9 vars, 90,409 obs)

Contains data
 Observations:        90,409                  
    Variables:             9                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y2_state        str2    %9s                   
y2_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(14,962 observations deleted)
(2,223 observations deleted)
(0 observations deleted)
(64 real changes made)
(64 real changes made)
(64 real changes made)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000012
    > .tmp saved as .dta format
(57,644 observations deleted)
(3,144 real changes made)
(3,107 real changes made)
(3,107 real changes made)
(3,103 real changes made)
(2,790 real changes made)
(329 real changes made)
(9,329 missing values generated)
(9,329 missing values generated)
(9,329 missing values generated)
(file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_out_21.dta
    not found)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_out_21.dta
    saved
(12,473 observations deleted)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000013
    > .tmp saved as .dta format
(12,436 observations deleted)
(3,144 observations deleted)

    Result                      Number of obs
    -----------------------------------------
    Not matched                            37
        from master                        37  
        from using                          0  

    Matched                            57,607  
    -----------------------------------------
(file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_flow_21.dta not
    found)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_flow_21.dta saved
(encoding automatically selected: ISO-8859-1)
(9 vars, 90,498 obs)

Contains data
 Observations:        90,498                  
    Variables:             9                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y1_state        str2    %9s                   
y1_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(15,093 observations deleted)
(2,179 observations deleted)
(0 observations deleted)
(57,640 observations deleted)
(1 real change made)
(1 real change made)
(1 real change made)
(3,144 real changes made)
(3,098 real changes made)
(3,098 real changes made)
(3,094 real changes made)
(2,822 real changes made)
(330 real changes made)
(9,344 missing values generated)
(9,344 missing values generated)
(9,344 missing values generated)
(file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_in_21.dta
    not found)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_in_21.dta
    saved

. 
. ** Append data 
. 
. ** Loop over datasets 
. foreach file in "irs_county_gross_in" "irs_county_gr
> oss_out" "irs_county_flow"{
  2.         
.                 
.         ** Loop over years 
.         forvalues y = 15(1)21 {
  3. 
.                 ** Append 
.                 append using "${data}working/`file'_
> `y'"
  4.                 
.         } // END YEAR LOOP 
  5.         
.         
.         ** Order and sort flow file 
.         if "`file'" == "irs_county_flow" {
  6.                 
.                 ** Loop over orgin and destination s
> tate 
.                 foreach x in "o" "d" {
  7.                         
.                         ** Rename 
.                         rename *_fips_`x' *_fips 
  8.                         
.                         ** Merge with county and sta
> te names 
.                         merge m:1 state_fips county_
> fips using "${data}working/ids",    ///
>                                 keep(match) nogen 
  9.                                 
.                         ** Rename 
.                         rename *_fips *_fips_`x' 
 10.                         rename *_name *_name_`x' 
 11. 
.                         
.                 } // END ORIGIN / DESTINATION LOOP 
 12.                 
.                 ** Order file 
.                 order year state_*_o county_*_o stat
> e_*_d county_*_d  
 13.                 sort year state_*_o county_*_o st
> ate_*_d county_*_d  
 14. 
.         } // END MIGRATION FLOW IF-STATEMENT 
 15.         
.         else {
 16.                 
.                 ** Merge with county and state names
>  
.                 merge m:1 state_fips county_fips usi
> ng "${data}working/ids",    ///
>                                 keep(match) nogen 
 17.                                 
.                 ** Order 
.                 order year state_* county* move_type
 18.                 
.         } 
 19.         
.         ** Save file 
.         save "${data}working/`file'", replace 
 20.         clear 
 21.         
. } // END FILE LOOP 

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           115,567  
    -----------------------------------------
(file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_in.dta not
    found)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_in.dta
    saved

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           115,611  
    -----------------------------------------
(file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_out.dta not
    found)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_out.dta
    saved

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           384,896  
    -----------------------------------------

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           362,678  
    -----------------------------------------
(file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_flow.dta not
    found)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_flow.dta saved

. 
. ** Create gross file with in and out migration 
. use "${data}working/irs_county_gross_in", clear 

. 
. ** Rename 
. rename n1 n1_in_

. rename n2 n2_in_

. rename agi agi_in_

. rename rename *_total *_total_in
syntax error
    Syntax is
        rename  oldname    newname   [, renumber[(#)] 
> addnumber[(#)] sort ...]
        rename (oldnames) (newnames) [, renumber[(#)] 
> addnumber[(#)] sort ...]
        rename  oldnames              , {upper|lower|p
> roper}
r(198);

end of do-file

r(198);

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_00001p
> .tmp"

. /***************************************************
> **************************
> * Program:                      01_clean_data.do 
> * Author(s):            John Iselin 
> * Date Updated:         October 19, 2025
> 
> *** Demographic data via IPUMS NHGIS 
> ** Via https://www.nhgis.org/
> ** Downloaded on October 19, 2025
> ** EXTRACT DETAILS in "nhgis0031_ts_nominal_county_c
> odebook"
> 
> *** Economic data via BEA Regional Economic Accounts
>  (CAINC1)
> ** Via https://apps.bea.gov/regional/downloadzip.htm
> 
> *** ACS individual data via IPUMS USA 
> ** Via https://usa.ipums.org/usa/index.shtml
> ** Downloaded via R program 
> 
> *** IRS SOI County-Level Migration Files
> ** Via https://www.irs.gov/statistics/soi-tax-stats-
> migration-data
> 
> *** IRS SOI County-Level Files
> ** Via https://www.irs.gov/statistics/soi-tax-stats-
> county-data
> 
> *** NYTimes COVID Cases and Deaths 
> ** Via https://github.com/nytimes/covid-19-data
> 
> ****************************************************
> ***************************/
. 
. ** Start log file 
. capture log close log_01

. log using "${logs}01_log_data_clean_${pr_name}_${dat
> e}", replace text name(log_01)
------------------------------------------------------
      name:  log_01
       log:  C:/Users/ji252/Documents/GitHub/multnomah
> -county-tax/code/logs/01_log_data_clean_multnomah_20
> 25-12-15.log
  log type:  text
 opened on:  15 Dec 2025, 16:53:02

. 
. //--------------------------------------------------
. // STEP 0: Preliminary Set-Up 
. //--------------------------------------------------
. 
. ** Define labels 
. label define lb_move_type       0 "ERROR"           
>                     ///
>                                                     
>     1 "Non-movers"                  ///
>                                                     
>     2 "All movers"                  ///
>                                                     
>     3 "Domestic movers"             ///
>                                                     
>     4 "Within-state movers" ///
>                                                     
>     5 "Inter-state movers"  ///
>                                                     
>     6 "Foreign movers", modify

.                                                     
>     
. label define lb_agi             1 "Under $1"        
>             ///
>                                                     
>     2 "$1 under $10K"               ///
>                                                     
>     3 "$10K under $25K"             ///
>                                                     
>     4 "$25K under $50K"             ///
>                                                     
>     5 "$50K under $75K"             ///
>                                                     
>     6 "$75K under $100K"    ///
>                                                     
>     7 "$100K under $200K"   ///
>                                                     
>     8 "$200K or more", modify                       
>                                 

. 
. 
. ** Define Programs
. 
. ** Make FIPS code from state and county fips codes 
. capture program drop make_fips

. program define make_fips
  1.     syntax varlist(min=2 max=2 numeric), GEN(name
> )
  2. 
.     quietly {
  3.         tempvar s c
  4. 
.         local v1 : word 1 of `varlist'
  5.         local v2 : word 2 of `varlist'
  6. 
.         gen `s' = string(`v1', "%02.0f")
  7.         gen `c' = string(`v2', "%03.0f")
  8. 
.         gen `gen' = real(`s' + `c')
  9.     }
 10. end

. 
. ** Reclassify suppressed values as 0 
. 
. capture program drop unsuppress

. program define unsuppress
  1.     syntax varlist
  2. 
.     foreach v of varlist `varlist' {
  3.         replace `v' = 0 if `v' == -1
  4.     }
  5. end

. 
. //--------------------------------------------------
. // STEP -1: Acquire raw data (automated where possib
> le)
. //--------------------------------------------------
. /*
> This block downloads public-use source data directly
>  from official URLs if not present locally.
> 
> Automated downloads included:
>   - IRS SOI county-to-county migration: countyinflow
> YYZZ.csv / countyoutflowYYZZ.csv
>   - IRS SOI county data: YYincyallagi.csv
>   - BEA Regional Economic Accounts (CAINC1): CAINC1.
> zip (unzips to CAINC1__ALL_AREAS_*.csv and related f
> iles)
> 
> */
. 
. * Ensure expected directory structure exists
. capture mkdir "${data}"

. capture mkdir "${data}working"

. capture mkdir "${data}demographic"

. capture mkdir "${data}demographic/CAINC1"

. capture mkdir "${data}demographic/nhgis0031_csv"

. capture mkdir "${data}irs"

. capture mkdir "${data}covid"

. 
. * ----------------------------
. * IRS SOI: migration files
. * ----------------------------
. local irs_base "https://www.irs.gov/pub/irs-soi"

. 
. forvalues yy = 15/21 {
  2.     local zz = `yy' + 1
  3.     local fn_out "countyoutflow`yy'`zz'.csv"
  4.     local fn_in  "countyinflow`yy'`zz'.csv"
  5. 
.     capture confirm file "${data}irs/`fn_out'"
  6.     if _rc {
  7.         di as txt "Downloading (IRS SOI) `fn_out'
>  ..."
  8.         copy "`irs_base'/`fn_out'" "${data}irs/`f
> n_out'", replace
  9.     }
 10. 
.     capture confirm file "${data}irs/`fn_in'"
 11.     if _rc {
 12.         di as txt "Downloading (IRS SOI) `fn_in' 
> ..."
 13.         copy "`irs_base'/`fn_in'" "${data}irs/`fn
> _in'", replace
 14.     }
 15. }

. 
. * ----------------------------
. * IRS SOI: county income (AGI) files
. * ----------------------------
. forvalues yy = 15/22 {
  2.     local fn_inc "`yy'incyallagi.csv"
  3. 
.     capture confirm file "${data}irs/`fn_inc'"
  4.     if _rc {
  5.         di as txt "Downloading (IRS SOI) `fn_inc'
>  ..."
  6.         copy "`irs_base'/`fn_inc'" "${data}irs/`f
> n_inc'", replace
  7.     }
  8. }

. 
. * ----------------------------
. * BEA Regional: CAINC1.zip
. * ----------------------------
. local bea_dir "${data}demographic/CAINC1"

. local bea_url "https://apps.bea.gov/regional/zip/CAI
> NC1.zip"

. local bea_zip "`bea_dir'/CAINC1.zip"

. 
. * If we don't already have a CAINC1 "_ALL_AREAS" fil
> e, download + unzip the ZIP.
. local bea_files : dir "`bea_dir'" files "CAINC1__ALL
> _AREAS_*.csv"

. if "`bea_files'"=="" {
.     local bea_files : dir "`bea_dir'" files "CAINC1_
> _ALL_STATES_*.csv"
. }

. 
. if "`bea_files'"=="" {
.     di as txt "Downloading (BEA) CAINC1.zip ..."
Downloading (BEA) CAINC1.zip ...
.     copy "`bea_url'" "`bea_zip'", replace
(file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/demographic/CAINC1/CAINC1.zip not
    found)
. 
.     local curdir "`c(pwd)'"
.     cd "`bea_dir'"
C:\Users\ji252\Documents\GitHub\multnomah-county-tax\d
> ata\demographic\CAINC1
.     unzipfile "CAINC1.zip", replace
    inflating: CAINC1__ALL_AREAS_1969_2023.csv
    inflating: CAINC1__definition.xml
    inflating: CAINC1__Footnotes.html
    inflating: CAINC1_AK_1969_2023.csv
    inflating: CAINC1_AL_1969_2023.csv
    inflating: CAINC1_AR_1969_2023.csv
    inflating: CAINC1_AZ_1969_2023.csv
    inflating: CAINC1_CA_1969_2023.csv
    inflating: CAINC1_CO_1969_2023.csv
    inflating: CAINC1_CSA_1969_2023.csv
    inflating: CAINC1_CT_1969_2023.csv
    inflating: CAINC1_DC_1969_2023.csv
    inflating: CAINC1_DE_1969_2023.csv
    inflating: CAINC1_FL_1969_2023.csv
    inflating: CAINC1_GA_1969_2023.csv
    inflating: CAINC1_HI_1969_2023.csv
    inflating: CAINC1_IA_1969_2023.csv
    inflating: CAINC1_ID_1969_2023.csv
    inflating: CAINC1_IL_1969_2023.csv
    inflating: CAINC1_IN_1969_2023.csv
    inflating: CAINC1_KS_1969_2023.csv
    inflating: CAINC1_KY_1969_2023.csv
    inflating: CAINC1_LA_1969_2023.csv
    inflating: CAINC1_MA_1969_2023.csv
    inflating: CAINC1_MD_1969_2023.csv
    inflating: CAINC1_MDIV_1969_2023.csv
    inflating: CAINC1_ME_1969_2023.csv
    inflating: CAINC1_MI_1969_2023.csv
    inflating: CAINC1_MIC_1969_2023.csv
    inflating: CAINC1_MN_1969_2023.csv
    inflating: CAINC1_MO_1969_2023.csv
    inflating: CAINC1_MS_1969_2023.csv
    inflating: CAINC1_MSA_1969_2023.csv
    inflating: CAINC1_MT_1969_2023.csv
    inflating: CAINC1_NC_1969_2023.csv
    inflating: CAINC1_ND_1969_2023.csv
    inflating: CAINC1_NE_1969_2023.csv
    inflating: CAINC1_NH_1969_2023.csv
    inflating: CAINC1_NJ_1969_2023.csv
    inflating: CAINC1_NM_1969_2023.csv
    inflating: CAINC1_NV_1969_2023.csv
    inflating: CAINC1_NY_1969_2023.csv
    inflating: CAINC1_OH_1969_2023.csv
    inflating: CAINC1_OK_1969_2023.csv
    inflating: CAINC1_OR_1969_2023.csv
    inflating: CAINC1_PA_1969_2023.csv
    inflating: CAINC1_PORT_1969_2023.csv
    inflating: CAINC1_RI_1969_2023.csv
    inflating: CAINC1_SC_1969_2023.csv
    inflating: CAINC1_SD_1969_2023.csv
    inflating: CAINC1_TN_1969_2023.csv
    inflating: CAINC1_TX_1969_2023.csv
    inflating: CAINC1_US_1969_2023.csv
    inflating: CAINC1_UT_1969_2023.csv
    inflating: CAINC1_VA_1969_2023.csv
    inflating: CAINC1_VT_1969_2023.csv
    inflating: CAINC1_WA_1969_2023.csv
    inflating: CAINC1_WI_1969_2023.csv
    inflating: CAINC1_WV_1969_2023.csv
    inflating: CAINC1_WY_1969_2023.csv

successfully unzipped CAINC1.zip to current directory
total processed:  60
        skipped:  0
      extracted:  60
.     cd "`curdir'"
C:\Users\ji252\Documents\GitHub\multnomah-county-tax
. 
.     capture erase "`bea_zip'"
. }

. 
. * ----------------------------
. * NYTimes COVID Data 
. * ----------------------------
. local covid_dir "${data}covid"

. local covid_url "https://raw.githubusercontent.com/n
> ytimes/covid-19-data/master/us-counties.csv"

. 
. * If we don't already have a COVID file, download.
. local covid_file : dir "`covid_dir'" files "covid_ny
> t.csv"

. if "`covid_file'"=="" {
.     local covid_file : dir "`covid_dir'" files "covi
> d_nyt.csv"
. }

. 
. if "`covid_file'"=="" {
.     di as txt "Downloading (COVID)  ..."
Downloading (COVID)  ...
.     copy "`covid_url'" "`covid_dir'/covid_nyt.csv", 
> replace
. }

. 
. 
. 
. //--------------------------------------------------
> ---------
. // STEP 1: Import and Clean Demographic Data via IPU
> MS + BEA  
. //--------------------------------------------------
> ---------
. 
. ** Import data 
. import delimited        ///
>         "${data}demographic/nhgis0031_csv/nhgis0031_
> ts_nominal_county.csv", clear 
(encoding automatically selected: ISO-8859-1)
(15 vars, 54,673 obs)

. 
. ** Describe data 
. des 

Contains data
 Observations:        54,673                  
    Variables:            15                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
gisjoin         str8    %9s                   GISJOIN
year            str9    %9s                   YEAR
state           str20   %20s                  STATE
statefp         byte    %8.0g                 STATEFP
statenh         int     %8.0g                 STATENH
county          str46   %46s                  COUNTY
countyfp        int     %8.0g                 COUNTYFP
countynh        int     %8.0g                 COUNTYNH
name            str59   %59s                  NAME
av0aa           long    %12.0g                AV0AA
d15aa           long    %12.0g                D15AA
d15ab           long    %12.0g                D15AB
b79aa           long    %12.0g                B79AA
av0aam          long    %12.0g                AV0AAM
b79aam          long    %8.0g                 B79AAM
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.

. 
. ** Drop unnecc variables 
. drop gisjoin statenh countynh name 

. 
. ** Rename 
. rename state state_name 

. rename statefp state_fips 

. rename county county_name 

. rename countyfp county_fips 

. rename av0aa population 

. rename d15aa pop_urban 

. rename d15ab pop_rural 

. rename b79aa median_income 

. rename av0aam population_margin

. rename b79aam median_income_margin 

. 
. ** Create urban percent 
. gen percent_urban = pop_urban / population
(45,090 missing values generated)

. 
. ** Label variables 
. label var state_name "State name"

. label var state_fips "State FIPS code"

. label var county_name "County name"

. label var county_fips "County FIPS code"

. label var population "Population count"

. label var pop_rural "Rural population count"

. label var pop_urban "Urban population count"

. label var percent_urban "Percent of population in ur
> ban areas"

. label var median_income "Median household income (pr
> ior year)"

. label var population_margin "ACS margin for error: p
> opulation"

. label var median_income_margin "ACS margin for error
> : median income"

. 
. ** Save as temporary file 
. tempfile demo

. save `demo'
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000001
    > .tmp saved as .dta format

. 
. ** Create three datasets 
. 
. ** (1) Basic state and county IDs 
. keep if year == "2020" 
(51,452 observations deleted)

. keep state* county* 

. 
. ** Make FIPS 
. make_fips state_fips county_fips, gen(fips)

. 
. ** Save as state and county Ids 
. save "${data}working/ids", replace 
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/ids.dta saved

. clear  

. 
. ** (2) Population data 
. use `demo'

. keep if !missing(pop_urban) 
(45,090 observations deleted)

. tab year 

       YEAR |      Freq.     Percent        Cum.
------------+-----------------------------------
       2000 |      3,141       32.78       32.78
       2010 |      3,221       33.61       66.39
       2020 |      3,221       33.61      100.00
------------+-----------------------------------
      Total |      9,583      100.00

. 
. ** Keep 2020 
. keep if year == "2020"
(6,362 observations deleted)

. drop year median_income* population_margin

. 
. ** Make FIPS 
. make_fips state_fips county_fips, gen(fips)

. 
. ** Save data
. save "${data}working/population_2020", replace 
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/population_2020.dta saved

. clear  

. 
. ** (3) 2015-2019 ACS data 
. use `demo'

. keep if !missing(median_income) 
(6,447 observations deleted)

. tab year 

       YEAR |      Freq.     Percent        Cum.
------------+-----------------------------------
       2000 |      3,141        6.51        6.51
  2006-2010 |      3,221        6.68       13.19
  2007-2011 |      3,221        6.68       19.87
  2008-2012 |      3,221        6.68       26.55
  2009-2013 |      3,221        6.68       33.23
  2010-2014 |      3,220        6.68       39.91
  2011-2015 |      3,219        6.67       46.58
  2012-2016 |      3,220        6.68       53.26
  2013-2017 |      3,220        6.68       59.93
  2014-2018 |      3,219        6.67       66.61
  2015-2019 |      3,220        6.68       73.29
  2016-2020 |      3,220        6.68       79.96
  2017-2021 |      3,220        6.68       86.64
  2018-2022 |      3,221        6.68       93.32
  2019-2023 |      3,222        6.68      100.00
------------+-----------------------------------
      Total |     48,226      100.00

. 
. ** Keep 2020 
. keep if year == "2015-2019"
(45,006 observations deleted)

. drop year pop_rural pop_urban percent_urban

. 
. ** Make FIPS 
. make_fips state_fips county_fips, gen(fips)

. 
. ** Save data
. save "${data}working/acs_2015_2019_data", replace 
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/acs_2015_2019_data.dta saved

. 
. ** Rename for merge 
. rename population population_acs

. 
. ** Merge with other data 
. merge 1:1 state_fips county_fips using "${data}worki
> ng/population_2020",                ///
>         keep(match) nogen 

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                             3,219  
    -----------------------------------------

. 
. ** Save data
. save "${data}working/demographics_2020", replace 
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/demographics_2020.dta saved

. 
. ** Load BEA Data 
. import delimited "${data}demographic/CAINC1/CAINC1__
> ALL_AREAS_1969_2023.csv",   ///
>         clear 
(encoding automatically selected: ISO-8859-1)
(63 vars, 9,604 obs)

. 
. ** Drop unnecc variables 
. drop region tablename industryclassification unit ge
> oname 

. 
. ** Drop empty cells 
. drop if missing(linecode)
(4 observations deleted)

. 
. ** Update names 
. rename geofips fips 

. replace fips = subinstr(fips, `"""', "", .)
(9,600 real changes made)

. destring fips, replace 
fips: all characters numeric; replaced as long

. 
. ** Keep population and per-capita income, dropping p
> ersonal income (total)
. tab description linecode

                      |  LineCode
          Description |         1 |     Total
----------------------+-----------+----------
Per capita personal.. |         0 |     3,200 
Personal income (th.. |     3,200 |     3,200 
Population (persons.. |         0 |     3,200 
----------------------+-----------+----------
                Total |     3,200 |     9,600 


                      |  LineCode
          Description |         2 |     Total
----------------------+-----------+----------
Per capita personal.. |         0 |     3,200 
Personal income (th.. |         0 |     3,200 
Population (persons.. |     3,200 |     3,200 
----------------------+-----------+----------
                Total |     3,200 |     9,600 


                      |  LineCode
          Description |         3 |     Total
----------------------+-----------+----------
Per capita personal.. |     3,200 |     3,200 
Personal income (th.. |         0 |     3,200 
Population (persons.. |         0 |     3,200 
----------------------+-----------+----------
                Total |     3,200 |     9,600 

. drop if linecode == 1   
(3,200 observations deleted)

. drop description

.         
. ** Get V* to be in terms of years 
. ** V9 == 1969 
. forvalues i = 9/63 {
  2.         
.         local j = 1960 + `i'
  3.         rename v`i' value`j'
  4.         
. } // END I LOOP 

. 
. ** Reshape 
. reshape long value, i(fips linecode) j(year)
(j = 1969 1970 1971 1972 1973 1974 1975 1976 1977 1978
>  1979 1980 1981 1982 1983 1984 1985 1986 1987 1988 1
> 989 1990 1991 1992 1993 1994 1995 1996 1997 1998 199
> 9 2000 2001 2002 2003 2004 2005 2006 2007 2008 2009 
> 2010 2011 2012 2013 2014 2015 2016 2017 2018 2019 20
> 20 2021 2022 2023)

Data                               Wide   ->   Long
------------------------------------------------------
> -----------------------
Number of observations            6,400   ->   352,000
>      
Number of variables                  57   ->   4      
>      
j variable (55 values)                    ->   year
xij variables:
      value1969 value1970 ... value2023   ->   value
------------------------------------------------------
> -----------------------

. reshape wide value, i(fips year ) j(linecode)
(j = 2 3)

Data                               Long   ->   Wide
------------------------------------------------------
> -----------------------
Number of observations          352,000   ->   176,000
>      
Number of variables                   4   ->   4      
>      
j variable (2 values)          linecode   ->   (droppe
> d)
xij variables:
                                  value   ->   value2 
> value3
------------------------------------------------------
> -----------------------

. 
. ** Keep years 
. keep if inrange(year, 2015, 2023)
(147,200 observations deleted)

. 
. ** Rename values 
. rename value2 population 

. rename value3 per_capita_income

. 
. ** Drop if missing values 
. drop if population == "(NA)"
(239 observations deleted)

. 
. ** Keep only counties with all observations 
. bysort fips: gen ct = _N 

. tab ct

         ct |      Freq.     Percent        Cum.
------------+-----------------------------------
          4 |          8        0.03        0.03
          5 |          5        0.02        0.05
          9 |     28,548       99.95      100.00
------------+-----------------------------------
      Total |     28,561      100.00

. keep if ct == 9
(13 observations deleted)

. drop ct

. 
. ** Destring 
. destring population, replace 
population: all characters numeric; replaced as long

. destring per_capita_income, replace 
per_capita_income: all characters numeric; replaced as
>  long

. 
. ** Save data
. save "${data}working/bea_economics", replace 
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/bea_economics.dta saved

. 
. //--------------------------------------------------
> --
. // STEP 2: Import and Clean NYTimes COVID-19 Data 
. //--------------------------------------------------
> --
.  
. ** Import data 
. import delimited using "${data}covid/covid_nyt.csv",
>  varnames(1) clear case(lower) 
(encoding automatically selected: ISO-8859-1)
(6 vars, 2,502,832 obs)

. 
. ** Describe data 
. des 

Contains data
 Observations:     2,502,832                  
    Variables:             6                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
date            str10   %10s                  
county          str35   %35s                  
state           str24   %24s                  
fips            long    %12.0g                
cases           long    %12.0g                
deaths          long    %8.0g                 
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.

. 
. ** Set up date information 
. generate num_date = date(date, "YMD")

. format num_date %td

. drop date 

. 
. ** Rename 
. rename state state_name 

. rename county county_name 

. rename num_date date 

. 
. ** keep only counties 
. keep if !missing(fips)
(23,678 observations deleted)

. 
. ** Keep in 50 states 
. drop if state_name == "Puerto Rico"
(57,605 observations deleted)

. drop if state_name == "Virgin Islands"
(2,304 observations deleted)

. drop if state_name == "Northern Mariana Islands"
(1,452 observations deleted)

. 
. ** Sort 
. sort date fips 

. 
. ** Create panel 
. xtset fips date

Panel variable: fips (unbalanced)
 Time variable: date, 21jan2020 to 13may2022, but
                with gaps
         Delta: 1 day

. 
. ** Fill in panel 
. tsfill, full 

. 
. ** Fill in missing values 
. replace cases = 0 if missing(cases)
(228,991 real changes made)

. replace deaths = 0 if missing(deaths)
(228,991 real changes made)

. 
. ** Preserve data 
. preserve 

. 
. ** Preserve fips codes and names 
. keep if !missing(state_name)
(228,991 observations deleted)

. keep if !missing(county_name)
(0 observations deleted)

. duplicates drop fips state_name county_name, force 

Duplicates in terms of fips state_name county_name

(2,414,657 observations deleted)

. 
. ** Save as temporary data 
. tempfile state_county_names 

. save `state_county_names'
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000003
    > .tmp saved as .dta format

. clear 

. 
. ** Restore 
. restore 

. 
. ** Drop and merge in names 
. drop state_name county_name

. merge m:1 fips using `state_county_names', keep(mast
> er match) nogen 

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                         2,646,784  
    -----------------------------------------

. 
. ** Get year, month, day 
. gen year = year(date)

. gen month = month(date)

. gen day = day(date)

. 
. ** Order data 
. order date year month day fips state county cases de
> aths 

. 
. ** Calculate cumulative cases and deaths 
. bysort fips (date): gen cases_cum = sum(cases)

. bysort fips (date): gen deaths_cum = sum(deaths)

. 
. ** Merge population data (2020)
. merge m:1 fips using "${data}working/population_2020
> ", keep(match) nogen  
(variable county_name was str35, now str46 to
       accommodate using data's values)
(variable fips was long, now double to accommodate
       using data's values)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                         2,643,408  
    -----------------------------------------

. 
. ** Save file 
. save ${data}working/covid_cleaned.dta, replace 
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/covid_cleaned.dta saved

. 
. ** Generate Clustering Variables 
. 
. ** Keep one observation per month 
. keep year month fips state_name county_name cases_cu
> m deaths_cum population

. collapse (sum) cases deaths population, by(year mont
> h fips state_name county_name) 

. sort year month fips 

. egen date = group(year month)

. drop year month 

. 
. ** Generate per capita figures
. replace cases = 1000 * cases / population
(82,955 real changes made)

. replace deaths = 1000 * deaths / population
(74,723 real changes made)

. drop population 

. 
. ** Reshape wide 
. reshape wide cases deaths, i(fips state_name county_
> name) j(date)
(j = 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 2
> 0 21 22 23 24 25 26 27 28 29)

Data                               Long   ->   Wide
------------------------------------------------------
> -----------------------
Number of observations           90,828   ->   3,132  
>      
Number of variables                   6   ->   61     
>      
j variable (29 values)             date   ->   (droppe
> d)
xij variables:
                              cases_cum   ->   cases_c
> um1 cases_cum2 ... cases_cum29
                             deaths_cum   ->   deaths_
> cum1 deaths_cum2 ... deaths_cum29
------------------------------------------------------
> -----------------------

. 
. ** Save file 
. save ${data}working/covid_cleaned_wide.dta, replace 
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/covid_cleaned_wide.dta saved

. clear

. 
. //--------------------------------------------------
> --
. // STEP 3: Import and Clean ACS Micro Data via IPUMS
>  
. //--------------------------------------------------
> --
. 
. ** Load data 
. forvalues y = 2015(1)2023 {
  2.         
.         ** Import CSV
.         import delimited using "${data}acs/acs_`y'",
>  varnames(1) clear case(lower)
  3.         
.         ** Save as temporary data 
.         tempfile acs_`y'
  4.         save `acs_`y''
  5.         clear 
  6.         
. } // END YEAR LOOP 
(encoding automatically selected: ISO-8859-1)
(57 vars, 2,997,503 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000004
    > .tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(57 vars, 3,007,847 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000005
    > .tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(57 vars, 3,038,696 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000006
    > .tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(57 vars, 3,060,442 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000007
    > .tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(57 vars, 3,087,291 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000008
    > .tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(57 vars, 2,454,160 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000009
    > .tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(57 vars, 3,092,079 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000a
    > .tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(55 vars, 3,190,848 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000b
    > .tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(55 vars, 3,228,659 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000c
    > .tmp saved as .dta format

. 
. ** Append data 
. forvalues y = 2015(1)2023 {
  2.         
.         append using `acs_`y''  
  3.         
. } // END YEAR LOOP 
(variable cbserial was long, now double to
       accommodate using data's values)

. 
. ** Des 
. tab year 

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       2015 |  2,997,503       11.04       11.04
       2016 |  3,007,847       11.08       22.11
       2017 |  3,038,696       11.19       33.30
       2018 |  3,060,442       11.27       44.57
       2019 |  3,087,291       11.37       55.94
       2020 |  2,454,160        9.04       64.98
       2021 |  3,092,079       11.39       76.36
       2022 |  3,190,848       11.75       88.11
       2023 |  3,228,659       11.89      100.00
------------+-----------------------------------
      Total | 27,157,525      100.00

. 
. ** Define # of adults and kids in HHs 
. gen adult = age >= 18 

. gen child = age < 18 

. bysort year serial: gen hh_size = _N 

. bysort year serial: egen hh_adult_ct = total(adult)

. bysort year serial: egen hh_child_ct = total(child)

. 
. ** Sample 18+
. drop if child == 1 
(5,629,869 observations deleted)

. drop child adult 

. 
. ** Sample not living abroad last year 
. drop if migplac1 > 56 
(108,862 observations deleted)

. drop if migrate1 == 4 
(0 observations deleted)

. 
. ** Rename variables 
. rename statefip state_fips_d

. rename countyfip county_fips_d 

. 
. ** Set up origin data 
. fre migrate1

migrate1
------------------------------------------------------
> -----
              |      Freq.    Percent      Valid      
>  Cum.
--------------+---------------------------------------
> -----
Valid   1     |   1.92e+07      89.51      89.51      
> 89.51
        2     |    1809920       8.45       8.45      
> 97.96
        3     |     436745       2.04       2.04     1
> 00.00
        Total |   2.14e+07     100.00     100.00      
>      
------------------------------------------------------
> -----

. drop migrate1d

. tab migplac1

   migplac1 |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 | 19,172,129       89.51       89.51
          1 |     31,329        0.15       89.66
          2 |      5,825        0.03       89.68
          4 |     54,912        0.26       89.94
          5 |     21,714        0.10       90.04
          6 |    260,673        1.22       91.26
          8 |     52,539        0.25       91.50
          9 |     21,577        0.10       91.61
         10 |      5,369        0.03       91.63
         11 |      8,664        0.04       91.67
         12 |    152,989        0.71       92.38
         13 |     71,263        0.33       92.72
         15 |      9,845        0.05       92.76
         16 |     13,536        0.06       92.83
         17 |     86,306        0.40       93.23
         18 |     47,941        0.22       93.45
         19 |     21,469        0.10       93.55
         20 |     22,338        0.10       93.66
         21 |     31,888        0.15       93.81
         22 |     28,776        0.13       93.94
         23 |      7,911        0.04       93.98
         24 |     40,223        0.19       94.17
         25 |     48,684        0.23       94.39
         26 |     65,444        0.31       94.70
         27 |     35,177        0.16       94.86
         28 |     16,994        0.08       94.94
         29 |     45,200        0.21       95.15
         30 |      7,453        0.03       95.19
         31 |     13,567        0.06       95.25
         32 |     24,785        0.12       95.37
         33 |      8,787        0.04       95.41
         34 |     50,561        0.24       95.64
         35 |     12,299        0.06       95.70
         36 |    118,674        0.55       96.26
         37 |     70,555        0.33       96.59
         38 |      5,884        0.03       96.61
         39 |     81,541        0.38       96.99
         40 |     28,921        0.14       97.13
         41 |     36,246        0.17       97.30
         42 |     76,201        0.36       97.65
         44 |      6,551        0.03       97.68
         45 |     33,552        0.16       97.84
         46 |      6,067        0.03       97.87
         47 |     48,061        0.22       98.09
         48 |    197,912        0.92       99.02
         49 |     25,798        0.12       99.14
         50 |      4,106        0.02       99.16
         51 |     64,560        0.30       99.46
         53 |     64,790        0.30       99.76
         54 |     10,532        0.05       99.81
         55 |     35,653        0.17       99.98
         56 |      5,023        0.02      100.00
------------+-----------------------------------
      Total | 21,418,794      100.00

. rename migplac1 state_fips_o

. tab migcounty1

 migcounty1 |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 | 19,952,847       93.16       93.16
          1 |     35,752        0.17       93.32
          3 |     58,525        0.27       93.60
          5 |     21,286        0.10       93.70
          7 |     13,720        0.06       93.76
          9 |     11,958        0.06       93.82
         11 |     23,663        0.11       93.93
         13 |     53,927        0.25       94.18
         15 |      7,126        0.03       94.21
         17 |     21,840        0.10       94.31
         19 |     24,348        0.11       94.43
         20 |      2,061        0.01       94.44
         21 |     12,848        0.06       94.50
         23 |      7,725        0.04       94.53
         25 |     21,090        0.10       94.63
         27 |     15,274        0.07       94.70
         29 |     32,454        0.15       94.85
         31 |     57,529        0.27       95.12
         33 |     33,851        0.16       95.28
         35 |     24,912        0.12       95.40
         37 |     72,280        0.34       95.73
         39 |     10,381        0.05       95.78
         41 |      8,696        0.04       95.82
         43 |      8,893        0.04       95.86
         45 |      5,998        0.03       95.89
         47 |     22,821        0.11       96.00
         49 |     21,522        0.10       96.10
         51 |     17,488        0.08       96.18
         53 |     17,759        0.08       96.26
         55 |     12,676        0.06       96.32
         57 |     18,309        0.09       96.41
         59 |     30,944        0.14       96.55
         61 |     31,725        0.15       96.70
         63 |     12,421        0.06       96.76
         65 |     18,670        0.09       96.85
         67 |     29,982        0.14       96.99
         69 |      4,036        0.02       97.01
         71 |     27,649        0.13       97.13
         73 |     36,959        0.17       97.31
         75 |     11,968        0.06       97.36
         77 |      8,293        0.04       97.40
         79 |      7,681        0.04       97.44
         81 |     30,275        0.14       97.58
         83 |      9,053        0.04       97.62
         85 |     28,918        0.14       97.76
         87 |      6,680        0.03       97.79
         89 |     10,158        0.05       97.83
         91 |     15,565        0.07       97.91
         93 |      4,960        0.02       97.93
         95 |     19,883        0.09       98.02
         97 |     19,460        0.09       98.11
         99 |     19,554        0.09       98.21
        101 |     14,457        0.07       98.27
        103 |     18,351        0.09       98.36
        105 |      7,421        0.03       98.39
        107 |      5,600        0.03       98.42
        109 |     10,761        0.05       98.47
        111 |     14,844        0.07       98.54
        113 |     30,918        0.14       98.68
        115 |      4,818        0.02       98.71
        117 |      7,798        0.04       98.74
        119 |     14,739        0.07       98.81
        121 |     10,181        0.05       98.86
        123 |      3,671        0.02       98.88
        125 |      9,036        0.04       98.92
        127 |      2,348        0.01       98.93
        129 |      1,814        0.01       98.94
        133 |      5,313        0.02       98.96
        135 |      7,844        0.04       99.00
        139 |      5,952        0.03       99.03
        141 |      6,936        0.03       99.06
        143 |      4,286        0.02       99.08
        145 |      1,975        0.01       99.09
        147 |      2,327        0.01       99.10
        149 |      2,146        0.01       99.11
        151 |      1,900        0.01       99.12
        153 |      5,155        0.02       99.14
        157 |     11,532        0.05       99.20
        159 |        751        0.00       99.20
        160 |        149        0.00       99.20
        161 |      4,716        0.02       99.22
        163 |     13,817        0.06       99.29
        165 |      2,418        0.01       99.30
        167 |      5,023        0.02       99.32
        169 |        850        0.00       99.33
        171 |        529        0.00       99.33
        173 |        264        0.00       99.33
        179 |      1,879        0.01       99.34
        183 |     11,521        0.05       99.39
        185 |        871        0.00       99.40
        187 |      2,303        0.01       99.41
        189 |      6,599        0.03       99.44
        191 |        759        0.00       99.44
        197 |      3,401        0.02       99.46
        201 |     29,158        0.14       99.59
        209 |      2,664        0.01       99.60
        215 |      3,046        0.01       99.62
        223 |        758        0.00       99.62
        227 |        946        0.00       99.63
        245 |      3,068        0.01       99.64
        251 |      1,020        0.00       99.65
        257 |        850        0.00       99.65
        303 |      3,247        0.02       99.67
        309 |      2,351        0.01       99.68
        313 |        456        0.00       99.68
        329 |      1,177        0.01       99.68
        339 |      3,176        0.01       99.70
        355 |      2,646        0.01       99.71
        367 |        977        0.00       99.72
        375 |      1,001        0.00       99.72
        381 |      1,199        0.01       99.73
        423 |      1,497        0.01       99.73
        439 |     14,652        0.07       99.80
        441 |      1,419        0.01       99.81
        451 |        952        0.00       99.81
        453 |     12,549        0.06       99.87
        479 |      1,301        0.01       99.88
        485 |      1,288        0.01       99.88
        491 |      4,036        0.02       99.90
        510 |     10,140        0.05       99.95
        550 |      1,187        0.01       99.95
        650 |      1,031        0.00       99.96
        700 |      1,438        0.01       99.97
        710 |        466        0.00       99.97
        760 |      2,799        0.01       99.98
        810 |      3,933        0.02      100.00
------------+-----------------------------------
      Total | 21,418,794      100.00

. rename migcounty1 county_fips_o

. 
. ** Use migrate1 to update values 
. 
. ** Within same house 
. replace state_fips_o = state_fips_d if migrate1 == 1
(19,172,129 real changes made)

. replace county_fips_o = county_fips_d if migrate1 ==
>  1 
(11,640,515 real changes made)

. 
. ** Within same state 
. replace state_fips_o = state_fips_d if migrate1 == 2
(0 real changes made)

. 
. ** Generate county IDS 
. foreach x in "o" "d" {
  2.         
.         make_fips state_fips_`x' county_fips_`x', ge
> n(fips_`x')
  3. 
. }

. 
. ** Check for within-state migration 
. gen same_county = fips_o == fips_d 

. tab year same_county

           |      same_county
      year |         0          1 |     Total
-----------+----------------------+----------
      2015 |    89,492  2,245,481 | 2,334,973 
      2016 |    91,109  2,255,901 | 2,347,010 
      2017 |    93,553  2,278,348 | 2,371,901 
      2018 |    96,080  2,306,022 | 2,402,102 
      2019 |    96,088  2,344,171 | 2,440,259 
      2020 |    71,827  1,877,155 | 1,948,982 
      2021 |    97,600  2,361,518 | 2,459,118 
      2022 |   106,231  2,430,426 | 2,536,657 
      2023 |    98,226  2,479,566 | 2,577,792 
-----------+----------------------+----------
     Total |   840,206 20,578,588 |21,418,794 

. tab year same_county if migrate1 == 2

           |      same_county
      year |         0          1 |     Total
-----------+----------------------+----------
      2015 |    42,597    172,956 |   215,553 
      2016 |    43,823    172,091 |   215,914 
      2017 |    45,058    174,386 |   219,444 
      2018 |    46,477    173,182 |   219,659 
      2019 |    46,329    168,101 |   214,430 
      2020 |    34,625    119,307 |   153,932 
      2021 |    46,470    148,925 |   195,395 
      2022 |    50,584    141,717 |   192,301 
      2023 |    47,498    135,794 |   183,292 
-----------+----------------------+----------
     Total |   403,461  1,406,459 | 1,809,920 

. 
. ** Tag HH head 
. gen byte hh_head = (relate == 1)

. 
. ** Compress file 
. compress 
  variable state_fips_o was int now byte
  variable hh_size was float now byte
  variable hh_adult_ct was float now byte
  variable hh_child_ct was float now byte
  variable same_county was float now byte
  (278,444,322 bytes saved)

. 
. ** Save 
. save "${data}working/acs_migration_file", replace 
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/acs_migration_file.dta saved

. 
. // Keep only observations with valid origin/destinat
> ion counties and YEAR
. drop if missing(year) | missing(fips_o) | missing(fi
> ps_d)
(0 observations deleted)

. 
. // Clean income (treat missing as 0; keep negative v
> alues as reported)
. replace inctot = 0 if missing(inctot)
(0 real changes made)

. gen double income_wt = inctot * perwt

. label var income_wt "Person income (INCTOT) weighted
>  by PERWT"

. 
. // --- Persons + income totals by origin/destination
> /year
. preserve

. keep year fips_o fips_d perwt income_wt

. collapse (sum) persons=perwt income_total=income_wt,
>  by(year fips_o fips_d)

. tempfile acs_pi

. save `acs_pi'
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000e
    > .tmp saved as .dta format

. restore

. 
. // --- Households by origin/destination/year
. // Use HHWT among household heads (RELATE==1) if ava
> ilable; else PERNUM==1 fallback.
. 
. preserve

. keep if hh_head
(10,269,992 observations deleted)

. keep year fips_o fips_d hhwt

. collapse (sum) households=hhwt, by(year fips_o fips_
> d)

. tempfile acs_hh

. save `acs_hh'
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000g
    > .tmp saved as .dta format

. restore

. 
. // --- Merge persons/income with households
. use `acs_pi', clear

. merge 1:1 year fips_o fips_d using `acs_hh', nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                        45,163
        from master                    45,163  
        from using                          0  

    Matched                           162,899  
    -----------------------------------------

. 
. label var persons "Estimated number of persons (sum 
> PERWT)"

. label var households "Estimated number of households
>  (sum HHWT among heads)"

. label var income_total "Estimated total personal inc
> ome (sum INCTOT*PERWT)"

. 
. // --- Derive state/county components for merges wit
> h name crosswalk
. gen int state_fips_o  = floor(fips_o/1000)

. gen int county_fips_o = mod(fips_o,1000)

. gen int state_fips_d  = floor(fips_d/1000)

. gen int county_fips_d = mod(fips_d,1000)

. 
. label var state_fips_o "State FIPS (origin)"

. label var county_fips_o "County FIPS (origin)"

. label var state_fips_d "State FIPS (destination)"

. label var county_fips_d "County FIPS (destination)"

. 
. // --- Merge in names (from NHGIS IDs snapshot)
. preserve

. use "${data}working/ids", clear

. rename (state_fips county_fips state_name county_nam
> e) (state_fips_o county_fips_o state_name_o county_n
> ame_o)

. tempfile ids_o

. save `ids_o'
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000i
    > .tmp saved as .dta format

. keep state_fips_o state_name_o 

. duplicates drop 

Duplicates in terms of all variables

(3,169 observations deleted)

. tempfile state_ids_o

. save `state_ids_o'
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000j
    > .tmp saved as .dta format

. restore

. merge m:1 state_fips_o county_fips_o using `ids_o', 
> keep(master match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                        46,997
        from master                    46,997  
        from using                          0  

    Matched                           161,065  
    -----------------------------------------

. drop state_name_o 

. merge m:1 state_fips_o using `state_ids_o', keep(mas
> ter match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           208,062  
    -----------------------------------------

. 
. preserve

. use "${data}working/ids", clear

. rename (state_fips county_fips state_name county_nam
> e) (state_fips_d county_fips_d state_name_d county_n
> ame_d)

. tempfile ids_d

. save `ids_d'
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000l
    > .tmp saved as .dta format

. keep state_fips_d state_name_d 

. duplicates drop 

Duplicates in terms of all variables

(3,169 observations deleted)

. tempfile state_ids_d

. save `state_ids_d'
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000m
    > .tmp saved as .dta format

. restore

. 
. merge m:1 state_fips_d county_fips_d using `ids_d', 
> keep(master match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                        50,197
        from master                    50,197  
        from using                          0  

    Matched                           157,865  
    -----------------------------------------

. drop state_name_d

. merge m:1 state_fips_d using `state_ids_d', keep(mas
> ter match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           208,062  
    -----------------------------------------

. order year ///
>     state_fips_o county_fips_o state_name_o county_n
> ame_o fips_o ///
>     state_fips_d county_fips_d state_name_d county_n
> ame_d fips_d ///
>     persons households income_total

. 
. sort year state_fips_o county_fips_o state_fips_d co
> unty_fips_d

. 
. replace county_name_o = "Other" if county_fips_o == 
> 0 
(46,948 real changes made)

. replace county_name_d = "Other" if county_fips_d == 
> 0 
(49,676 real changes made)

. 
. save "${data}working/acs_county_flow", replace
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/acs_county_flow.dta saved

. 
. // Optional: Multnomah-focused flow extract (origin 
> = Multnomah County, OR)
. // Multnomah County, OR = state 41, county 051
. preserve

. keep if state_fips_o == 41 & county_fips_o == 51
(207,316 observations deleted)

. save "${data}working/multnomah_acs_flow", replace
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/multnomah_acs_flow.dta saved

. clear

. 
. 
. 
. //--------------------------------------------------
> --
. // STEP 4: Import and Clean IRS Migration Data 
. //--------------------------------------------------
> --
. 
. ** Loop over years 
. forvalues y = 15(1)21 {
  2.         
.         local start = `y'
  3.         local end = `y' + 1 
  4.         
.         ** Import data (out)
.         import delimited "${data}irs/countyoutflow`s
> tart'`end'.csv", clear 
  5.         
.         ** Describe data 
.         des 
  6.         
.         ** Generate year 
.         gen year = 2000 + `y' 
  7.         
.         ** Drop Regional Values 
.         drop if y2_state == "DS"
  8.         
.         ** Drop Foreign Migration 
.         drop if y2_state == "FR"
  9.         
.         ** Drop observations without a county
.         drop if y1_countyfips == 0 
 10.         
.         ** Deal with suppressed values 
.         unsuppress n1 n2 agi
 11.         
.         ** Drop unnecc variables 
.         drop y2_state y2_countyname
 12.                 
.         ** Create two versions: gross and net 
.         tempfile tmp
 13.         save `tmp'
 14.         
.         ** Gross first 
.         
.         ** Keep gross categories 
.         keep if ///
>                 (y1_statefips == y2_statefips & y1_c
> ountyfips == y2_countyfips) |       ///
>                 inlist(y2_statefips, 96, 97, 98)
 15. 
.         ** Clean up 
.         gen move_type = 0 
 16.         
.         ** Stayers 
.         replace move_type = 1 if        (y1_statefip
> s == y2_statefips) &        ///
>                                                     
>             (y1_countyfips == y2_countyfips) 
 17.         
.         ** Movers
.         replace move_type = 2 if        y2_statefips
>  == 96              // ALL 
 18.         replace move_type = 3 if        y2_statef
> ips == 97 &    ///
>                                                     
>             y2_countyfips == 0              // Domes
> tic Total
 19.         replace move_type = 4 if        y2_statef
> ips == 97 &    ///
>                                                     
>             y2_countyfips == 1              // Withi
> n-state
 20.         replace move_type = 5 if        y2_statef
> ips == 97 &    ///
>                                                     
>             y2_countyfips == 3              // Betwe
> en-states 
 21.         replace move_type = 6 if        y2_statef
> ips == 98              // Foreign 
 22.         
.         ** Label movers 
.         label values move_type lb_move_type 
 23.         
.         ** Generate total category 
.         foreach var of varlist n1 n2 agi {
 24.                 
.                 gen tmp = `var' if inlist(move_type,
>  1, 2)
 25.                 bysort y1_statefips y1_countyfips
> : egen `var'_total = total(tmp)
 26.                 drop tmp 
 27.                 
.         } // END VAR LOOP 
 28.         
.         ** Drop unnecc variables 
.         drop y2_* 
 29.         
.         ** Sort 
.         sort year y1_statefips y1_countyfips move_ty
> pe 
 30. 
.         ** Order 
.         order year y1_statefips y1_countyfips move_t
> ype 
 31.         
.         ** Rename 
.         rename y1_countyfips county_fips 
 32.         rename y1_statefips state_fips 
 33.         
.         ** Label variables 
.         label var year "Tax year (year before move)"
 34.         label var state_fips "State FIPS code (or
> igin state)"
 35.         label var county_fips "County FIPS code (
> origin county)"
 36.         label var move_type "Mover category"
 37.         label var n1 "Number of returns"
 38.         label var n2 "Number of exemptions"
 39.         label var agi "Adjusted Gross Income"
 40.         label var n1_total "Number of returns, co
> unty total (origin)"
 41.         label var n2_total "Number of exemptions,
>  county total (origin)"
 42.         label var agi_total "Adjusted Gross Incom
> e, county total (origin)"
 43.         
.         ** Save 
.         save "${data}working/irs_county_gross_out_`y
> '", replace 
 44.         
.         ** Create version for merge with net 
.         keep if move_type == 3 
 45.         
.         ** Rename variables 
.         rename n1 n1_mover
 46.         rename n2 n2_mover 
 47.         rename agi agi_mover 
 48.         
.         label var n1_mover "Number of domestic mover
>  returns"
 49.         label var n2_mover "Number of domestic mo
> ver exemptions"
 50.         label var agi_mover "Adjusted Gross Incom
> e, domestic movers"
 51.         
.         ** Save as temp file 
.         tempfile merge 
 52.         save `merge'
 53.         clear 
 54.         
.         ** Next, create flow file 
.         use `tmp', clear 
 55.         
.         ** Drop aggregate values 
.         drop if inlist(y2_statefips, 96, 97, 98)
 56.         drop if (y1_statefips == y2_statefips & y
> 1_countyfips == y2_countyfips) 
 57.         
.         ** Sort 
.         sort year y1_statefips y1_countyfips y2_stat
> efips y2_countyfips 
 58. 
.         ** Order 
.         order year y1_statefips y1_countyfips y2_sta
> tefips y2_countyfips
 59. 
.         
.         ** Rename 
.         rename y1_countyfips county_fips 
 60.         rename y1_statefips state_fips 
 61.         rename y2_countyfips y2_county_fips 
 62.         rename y2_statefips y2_state_fips       
 63.         
.         ** Label variables 
.         label var year "Tax year (year before move)"
 64.         label var state_fips "State FIPS code (or
> igin state)"
 65.         label var county_fips "County FIPS code (
> origin county)"
 66.         label var y2_state_fips "State FIPS code 
> (dest. state)"
 67.         label var y2_county_fips "County FIPS cod
> e (dest. county)"      
 68.         label var n1 "Number of returns"
 69.         label var n2 "Number of exemptions"
 70.         label var agi "Adjusted Gross Income"
 71.         
.         ** Merge with county of origin data 
.         merge m:1 state_fips county_fips using `merg
> e', nogen keep(master match)
 72.         
.         ** Rename 
.         rename state_fips state_fips_o
 73.         rename county_fips county_fips_o
 74.         rename y2_* *_d 
 75.         
.         ** Dropo unnecc variable 
.         drop move_type 
 76.         
.         ** Save 
.         save "${data}working/irs_county_flow_`y'", r
> eplace 
 77.         clear
 78.         
.         ** Import data (in)
.         import delimited "${data}irs/countyinflow`st
> art'`end'.csv", clear 
 79.         
.         ** Describe data 
.         des 
 80. 
.         ** Generate year 
.         gen year = 2000 + `y' 
 81.         
.         ** Drop Regional Values 
.         drop if y1_state == "DS"
 82.         
.         ** Drop Foreign Migration 
.         drop if y1_state == "FR"
 83.         
.         ** Drop observations with no county ID 
.         drop if y2_countyfips == 0 
 84.         
.         ** Keep gross categories 
.         keep if ///
>                 (y1_statefips == y2_statefips & y1_c
> ountyfips == y2_countyfips) |       ///
>                 inlist(y1_statefips, 96, 97, 98)
 85. 
.         ** Clean up 
.         gen move_type = 0 
 86.         
.         ** Deal with suppressed values 
.         unsuppress n1 n2 agi
 87.         
.         ** Stayers 
.         replace move_type = 1 if        (y1_statefip
> s == y2_statefips) &        ///
>                                                     
>             (y1_countyfips == y2_countyfips) 
 88.         
.         ** Movers
.         replace move_type = 2 if        y1_statefips
>  == 96              // ALL 
 89.         replace move_type = 3 if        y1_statef
> ips == 97 &    ///
>                                                     
>             y1_countyfips == 0              // Domes
> tic Total
 90.         replace move_type = 4 if        y1_statef
> ips == 97 &    ///
>                                                     
>             y1_countyfips == 1              // Withi
> n-state
 91.         replace move_type = 5 if        y1_statef
> ips == 97 &    ///
>                                                     
>             y1_countyfips == 3              // Betwe
> en-states 
 92.         replace move_type = 6 if        y1_statef
> ips == 98              // Foreign 
 93.         
.         ** Label move variable  
.         label values move_type lb_move_type 
 94.         
.         ** Generate total category 
.         foreach var of varlist n1 n2 agi {
 95.                 
.                 gen tmp = `var' if inlist(move_type,
>  1, 2)
 96.                 bysort y2_statefips y2_countyfips
> : egen `var'_total = total(tmp)
 97.                 drop tmp 
 98.                 
.         } // END VAR LOOP 
 99.         
.         ** Drop unnecc variables 
.         drop y1_*
100.         
.         ** Sort 
.         sort year y2_statefips y2_countyfips move_ty
> pe 
101. 
.         ** Order 
.         order year y2_statefips y2_countyfips move_t
> ype 
102.         
.         ** Rename 
.         rename y2_countyfips county_fips 
103.         rename y2_statefips state_fips 
104.         
.         ** Label variables 
.         label var year "Tax year (year before move)"
105.         label var state_fips "State FIPS code (de
> st. state)"
106.         label var county_fips "County FIPS code (
> dest. county)"
107.         label var move_type "Mover category"
108.         label var n1 "Number of returns"
109.         label var n2 "Number of exemptions"
110.         label var agi "Adjusted Gross Income"
111.         label var n1_total "Number of returns, co
> unty total (dest.)"
112.         label var n2_total "Number of exemptions,
>  county total (dest.)"
113.         label var agi_total "Adjusted Gross Incom
> e, county total (dest.)"
114.         
.         ** Save 
.         save "${data}working/irs_county_gross_in_`y'
> ", replace 
115.         clear 
116.         
. } // END YEAR LOOP 
(encoding automatically selected: ISO-8859-1)
(9 vars, 86,481 obs)

Contains data
 Observations:        86,481                  
    Variables:             9                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y2_state        str2    %9s                   
y2_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(15,289 observations deleted)
(2,937 observations deleted)
(254 observations deleted)
(2,056 real changes made)
(2,056 real changes made)
(2,056 real changes made)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000o
    > .tmp saved as .dta format
(50,007 observations deleted)
(3,141 real changes made)
(3,141 real changes made)
(3,141 real changes made)
(3,140 real changes made)
(3,140 real changes made)
(2,291 real changes made)
(11,712 missing values generated)
(11,712 missing values generated)
(11,712 missing values generated)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_out_15.dta
    saved
(14,853 observations deleted)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000p
    > .tmp saved as .dta format
(14,853 observations deleted)
(3,141 observations deleted)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            50,007  
    -----------------------------------------
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_flow_15.dta saved
(encoding automatically selected: ISO-8859-1)
(9 vars, 86,330 obs)

Contains data
 Observations:        86,330                  
    Variables:             9                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y1_state        str2    %9s                   
y1_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(15,315 observations deleted)
(2,814 observations deleted)
(254 observations deleted)
(50,005 observations deleted)
(2,041 real changes made)
(2,041 real changes made)
(2,041 real changes made)
(3,141 real changes made)
(3,141 real changes made)
(3,141 real changes made)
(3,140 real changes made)
(3,140 real changes made)
(2,239 real changes made)
(11,660 missing values generated)
(11,660 missing values generated)
(11,660 missing values generated)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_in_15.dta
    saved
(encoding automatically selected: ISO-8859-1)
(9 vars, 98,948 obs)

Contains data
 Observations:        98,948                  
    Variables:             9                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y2_state        str2    %9s                   
y2_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(15,372 observations deleted)
(2,360 observations deleted)
(254 observations deleted)
(1,877 real changes made)
(1,877 real changes made)
(1,877 real changes made)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000q
    > .tmp saved as .dta format
(63,249 observations deleted)
(3,140 real changes made)
(3,141 real changes made)
(3,141 real changes made)
(3,140 real changes made)
(3,141 real changes made)
(2,010 real changes made)
(11,432 missing values generated)
(11,432 missing values generated)
(11,432 missing values generated)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_out_16.dta
    saved
(14,572 observations deleted)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000r
    > .tmp saved as .dta format
(14,573 observations deleted)
(3,140 observations deleted)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            63,249  
    -----------------------------------------
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_flow_16.dta saved
(encoding automatically selected: ISO-8859-1)
(9 vars, 98,874 obs)

Contains data
 Observations:        98,874                  
    Variables:             9                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y1_state        str2    %9s                   
y1_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(15,432 observations deleted)
(2,282 observations deleted)
(254 observations deleted)
(63,249 observations deleted)
(1,788 real changes made)
(1,788 real changes made)
(1,788 real changes made)
(3,140 real changes made)
(3,141 real changes made)
(3,141 real changes made)
(3,140 real changes made)
(3,140 real changes made)
(1,955 real changes made)
(11,376 missing values generated)
(11,376 missing values generated)
(11,376 missing values generated)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_in_16.dta
    saved
(encoding automatically selected: ISO-8859-1)
(9 vars, 87,820 obs)

Contains data
 Observations:        87,820                  
    Variables:             9                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y2_state        str2    %9s                   
y2_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(15,300 observations deleted)
(2,364 observations deleted)
(254 observations deleted)
(1,942 real changes made)
(1,942 real changes made)
(1,942 real changes made)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000s
    > .tmp saved as .dta format
(52,173 observations deleted)
(3,141 real changes made)
(3,141 real changes made)
(3,141 real changes made)
(3,140 real changes made)
(3,140 real changes made)
(2,026 real changes made)
(11,447 missing values generated)
(11,447 missing values generated)
(11,447 missing values generated)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_out_17.dta
    saved
(14,588 observations deleted)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000t
    > .tmp saved as .dta format
(14,588 observations deleted)
(3,141 observations deleted)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            52,173  
    -----------------------------------------
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_flow_17.dta saved
(encoding automatically selected: ISO-8859-1)
(9 vars, 87,932 obs)

Contains data
 Observations:        87,932                  
    Variables:             9                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y1_state        str2    %9s                   
y1_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(15,368 observations deleted)
(2,403 observations deleted)
(254 observations deleted)
(52,174 observations deleted)
(1,919 real changes made)
(1,919 real changes made)
(1,919 real changes made)
(3,141 real changes made)
(3,141 real changes made)
(3,141 real changes made)
(3,140 real changes made)
(3,140 real changes made)
(2,030 real changes made)
(11,451 missing values generated)
(11,451 missing values generated)
(11,451 missing values generated)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_in_17.dta
    saved
(encoding automatically selected: ISO-8859-1)
(9 vars, 83,878 obs)

Contains data
 Observations:        83,878                  
    Variables:             9                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y2_state        str2    %9s                   
y2_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(14,919 observations deleted)
(2,298 observations deleted)
(0 observations deleted)
(53 real changes made)
(53 real changes made)
(53 real changes made)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000u
    > .tmp saved as .dta format
(51,090 observations deleted)
(3,141 real changes made)
(3,107 real changes made)
(3,107 real changes made)
(3,103 real changes made)
(2,778 real changes made)
(335 real changes made)
(9,323 missing values generated)
(9,323 missing values generated)
(9,323 missing values generated)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_out_18.dta
    saved
(12,464 observations deleted)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000v
    > .tmp saved as .dta format
(12,430 observations deleted)
(3,141 observations deleted)

    Result                      Number of obs
    -----------------------------------------
    Not matched                            34
        from master                        34  
        from using                          0  

    Matched                            51,056  
    -----------------------------------------
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_flow_18.dta saved
(encoding automatically selected: ISO-8859-1)
(9 vars, 83,762 obs)

Contains data
 Observations:        83,762                  
    Variables:             9                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y1_state        str2    %9s                   
y1_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(14,890 observations deleted)
(2,290 observations deleted)
(0 observations deleted)
(51,090 observations deleted)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(3,141 real changes made)
(3,086 real changes made)
(3,086 real changes made)
(3,082 real changes made)
(2,729 real changes made)
(368 real changes made)
(9,265 missing values generated)
(9,265 missing values generated)
(9,265 missing values generated)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_in_18.dta
    saved
(encoding automatically selected: ISO-8859-1)
(9 vars, 87,325 obs)

Contains data
 Observations:        87,325                  
    Variables:             9                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y2_state        str2    %9s                   
y2_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(14,937 observations deleted)
(2,272 observations deleted)
(0 observations deleted)
(62 real changes made)
(62 real changes made)
(62 real changes made)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000w
    > .tmp saved as .dta format
(54,560 observations deleted)
(3,142 real changes made)
(3,104 real changes made)
(3,104 real changes made)
(3,101 real changes made)
(2,773 real changes made)
(332 real changes made)
(9,310 missing values generated)
(9,310 missing values generated)
(9,310 missing values generated)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_out_19.dta
    saved
(12,452 observations deleted)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000x
    > .tmp saved as .dta format
(12,414 observations deleted)
(3,142 observations deleted)

    Result                      Number of obs
    -----------------------------------------
    Not matched                            38
        from master                        38  
        from using                          0  

    Matched                            54,522  
    -----------------------------------------
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_flow_19.dta saved
(encoding automatically selected: ISO-8859-1)
(9 vars, 87,552 obs)

Contains data
 Observations:        87,552                  
    Variables:             9                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y1_state        str2    %9s                   
y1_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(15,060 observations deleted)
(2,323 observations deleted)
(0 observations deleted)
(54,560 observations deleted)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(3,142 real changes made)
(3,102 real changes made)
(3,102 real changes made)
(3,097 real changes made)
(2,805 real changes made)
(361 real changes made)
(9,365 missing values generated)
(9,365 missing values generated)
(9,365 missing values generated)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_in_19.dta
    saved
(encoding automatically selected: ISO-8859-1)
(9 vars, 89,511 obs)

Contains data
 Observations:        89,511                  
    Variables:             9                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y2_state        str2    %9s                   
y2_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(14,963 observations deleted)
(2,175 observations deleted)
(0 observations deleted)
(79 real changes made)
(79 real changes made)
(79 real changes made)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000010
    > .tmp saved as .dta format
(56,831 observations deleted)
(3,143 real changes made)
(3,097 real changes made)
(3,097 real changes made)
(3,094 real changes made)
(2,787 real changes made)
(324 real changes made)
(9,302 missing values generated)
(9,302 missing values generated)
(9,302 missing values generated)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_out_20.dta
    saved
(12,445 observations deleted)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000011
    > .tmp saved as .dta format
(12,399 observations deleted)
(3,143 observations deleted)

    Result                      Number of obs
    -----------------------------------------
    Not matched                            46
        from master                        46  
        from using                          0  

    Matched                            56,785  
    -----------------------------------------
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_flow_20.dta saved
(encoding automatically selected: ISO-8859-1)
(9 vars, 89,850 obs)

Contains data
 Observations:        89,850                  
    Variables:             9                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y1_state        str2    %9s                   
y1_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(15,132 observations deleted)
(2,263 observations deleted)
(0 observations deleted)
(56,835 observations deleted)
(1 real change made)
(1 real change made)
(1 real change made)
(3,143 real changes made)
(3,101 real changes made)
(3,101 real changes made)
(3,098 real changes made)
(2,838 real changes made)
(339 real changes made)
(9,376 missing values generated)
(9,376 missing values generated)
(9,376 missing values generated)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_in_20.dta
    saved
(encoding automatically selected: ISO-8859-1)
(9 vars, 90,409 obs)

Contains data
 Observations:        90,409                  
    Variables:             9                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y2_state        str2    %9s                   
y2_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(14,962 observations deleted)
(2,223 observations deleted)
(0 observations deleted)
(64 real changes made)
(64 real changes made)
(64 real changes made)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000012
    > .tmp saved as .dta format
(57,644 observations deleted)
(3,144 real changes made)
(3,107 real changes made)
(3,107 real changes made)
(3,103 real changes made)
(2,790 real changes made)
(329 real changes made)
(9,329 missing values generated)
(9,329 missing values generated)
(9,329 missing values generated)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_out_21.dta
    saved
(12,473 observations deleted)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000013
    > .tmp saved as .dta format
(12,436 observations deleted)
(3,144 observations deleted)

    Result                      Number of obs
    -----------------------------------------
    Not matched                            37
        from master                        37  
        from using                          0  

    Matched                            57,607  
    -----------------------------------------
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_flow_21.dta saved
(encoding automatically selected: ISO-8859-1)
(9 vars, 90,498 obs)

Contains data
 Observations:        90,498                  
    Variables:             9                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y1_state        str2    %9s                   
y1_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(15,093 observations deleted)
(2,179 observations deleted)
(0 observations deleted)
(57,640 observations deleted)
(1 real change made)
(1 real change made)
(1 real change made)
(3,144 real changes made)
(3,098 real changes made)
(3,098 real changes made)
(3,094 real changes made)
(2,822 real changes made)
(330 real changes made)
(9,344 missing values generated)
(9,344 missing values generated)
(9,344 missing values generated)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_in_21.dta
    saved

. 
. ** Append data 
. 
. ** Loop over datasets 
. foreach file in "irs_county_gross_in" "irs_county_gr
> oss_out" "irs_county_flow"{
  2.         
.                 
.         ** Loop over years 
.         forvalues y = 15(1)21 {
  3. 
.                 ** Append 
.                 append using "${data}working/`file'_
> `y'"
  4.                 
.         } // END YEAR LOOP 
  5.         
.         
.         ** Order and sort flow file 
.         if "`file'" == "irs_county_flow" {
  6.                 
.                 ** Loop over orgin and destination s
> tate 
.                 foreach x in "o" "d" {
  7.                         
.                         ** Rename 
.                         rename *_fips_`x' *_fips 
  8.                         
.                         ** Merge with county and sta
> te names 
.                         merge m:1 state_fips county_
> fips using "${data}working/ids",    ///
>                                 keep(match) nogen 
  9.                                 
.                         ** Rename 
.                         rename *_fips *_fips_`x' 
 10.                         rename *_name *_name_`x' 
 11. 
.                         
.                 } // END ORIGIN / DESTINATION LOOP 
 12.                 
.                 ** Order file 
.                 order year state_*_o county_*_o stat
> e_*_d county_*_d  
 13.                 sort year state_*_o county_*_o st
> ate_*_d county_*_d  
 14. 
.         } // END MIGRATION FLOW IF-STATEMENT 
 15.         
.         else {
 16.                 
.                 ** Merge with county and state names
>  
.                 merge m:1 state_fips county_fips usi
> ng "${data}working/ids",    ///
>                                 keep(match) nogen 
 17.                                 
.                 ** Order 
.                 order year state_* county* move_type
 18.                 
.         } 
 19.         
.         ** Save file 
.         save "${data}working/`file'", replace 
 20.         clear 
 21.         
. } // END FILE LOOP 

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           115,567  
    -----------------------------------------
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_in.dta
    saved

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           115,611  
    -----------------------------------------
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_out.dta
    saved

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           384,896  
    -----------------------------------------

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           362,678  
    -----------------------------------------
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_flow.dta saved

. 
. ** Create gross file with in and out migration 
. use "${data}working/irs_county_gross_in", clear 

. 
. ** Rename 
. rename n1 n1_in_

. rename n2 n2_in_

. rename agi agi_in_

. rename *_total *_total_in

. 
. ** Reshape 
. reshape wide n1_in_ n2_in_ agi_in_, i(year state_fip
> s county_fips) j(move_type)
(j = 1 2 3 4 5 6)

Data                               Long   ->   Wide
------------------------------------------------------
> -----------------------
Number of observations          115,567   ->   21,980 
>      
Number of variables                  13   ->   27     
>      
j variable (6 values)         move_type   ->   (droppe
> d)
xij variables:
                                 n1_in_   ->   n1_in_1
>  n1_in_2 ... n1_in_6
                                 n2_in_   ->   n2_in_1
>  n2_in_2 ... n2_in_6
                                agi_in_   ->   agi_in_
> 1 agi_in_2 ... agi_in_6
------------------------------------------------------
> -----------------------

. 
. ** Define locals 
. local txt1 "Non-movers"

. local txt2 "All movers"                 

. local txt3 "Domestic movers"            

. local txt4 "Within-state movers"        

. local txt5 "Inter-state movers" 

. local txt6 "Foreign movers"

. 
. ** Label variables, in loop 
. foreach n of numlist 1(1)6 {
  2.         
.         label var n1_in_`n' "Returns, in-migration, 
> `txt`n''"
  3.         label var n2_in_`n' "Exemptions, in-migra
> tion, `txt`n''"
  4.         label var agi_in_`n' "AGI, in-migration, 
> `txt`n''"
  5. 
. } // END NUMLIST LOOP 

. 
. ** Preserve 
. tempfile gross_in

. save `gross_in'
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000014
    > .tmp saved as .dta format

. clear

. 
. ** Create gross file with in and out migration 
. use "${data}working/irs_county_gross_out", clear 

. 
. ** Rename 
. rename n1 n1_out_

. rename n2 n2_out_

. rename agi agi_out_

. rename *_total_out
syntax error
    Syntax is
        rename  oldname    newname   [, renumber[(#)] 
> addnumber[(#)] sort ...]
        rename (oldnames) (newnames) [, renumber[(#)] 
> addnumber[(#)] sort ...]
        rename  oldnames              , {upper|lower|p
> roper}
r(198);

end of do-file

r(198);

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_00001q
> .tmp"

. rename *_total *_total_out

. 
end of do-file

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_00001r
> .tmp"

. /***************************************************
> **************************
> * Program:                      01_clean_data.do 
> * Author(s):            John Iselin 
> * Date Updated:         October 19, 2025
> 
> *** Demographic data via IPUMS NHGIS 
> ** Via https://www.nhgis.org/
> ** Downloaded on October 19, 2025
> ** EXTRACT DETAILS in "nhgis0031_ts_nominal_county_c
> odebook"
> 
> *** Economic data via BEA Regional Economic Accounts
>  (CAINC1)
> ** Via https://apps.bea.gov/regional/downloadzip.htm
> 
> *** ACS individual data via IPUMS USA 
> ** Via https://usa.ipums.org/usa/index.shtml
> ** Downloaded via R program 
> 
> *** IRS SOI County-Level Migration Files
> ** Via https://www.irs.gov/statistics/soi-tax-stats-
> migration-data
> 
> *** IRS SOI County-Level Files
> ** Via https://www.irs.gov/statistics/soi-tax-stats-
> county-data
> 
> *** NYTimes COVID Cases and Deaths 
> ** Via https://github.com/nytimes/covid-19-data
> 
> ****************************************************
> ***************************/
. 
. ** Start log file 
. capture log close log_01

. log using "${logs}01_log_data_clean_${pr_name}_${dat
> e}", replace text name(log_01)
------------------------------------------------------
      name:  log_01
       log:  C:/Users/ji252/Documents/GitHub/multnomah
> -county-tax/code/logs/01_log_data_clean_multnomah_20
> 25-12-15.log
  log type:  text
 opened on:  15 Dec 2025, 17:26:40

. 
. //--------------------------------------------------
. // STEP 0: Preliminary Set-Up 
. //--------------------------------------------------
. 
. ** Define labels 
. label define lb_move_type       0 "ERROR"           
>                     ///
>                                                     
>     1 "Non-movers"                  ///
>                                                     
>     2 "All movers"                  ///
>                                                     
>     3 "Domestic movers"             ///
>                                                     
>     4 "Within-state movers" ///
>                                                     
>     5 "Inter-state movers"  ///
>                                                     
>     6 "Foreign movers", modify

.                                                     
>     
. label define lb_agi             1 "Under $1"        
>             ///
>                                                     
>     2 "$1 under $10K"               ///
>                                                     
>     3 "$10K under $25K"             ///
>                                                     
>     4 "$25K under $50K"             ///
>                                                     
>     5 "$50K under $75K"             ///
>                                                     
>     6 "$75K under $100K"    ///
>                                                     
>     7 "$100K under $200K"   ///
>                                                     
>     8 "$200K or more", modify                       
>                                 

. 
. 
. ** Define Programs
. 
. ** Make FIPS code from state and county fips codes 
. capture program drop make_fips

. program define make_fips
  1.     syntax varlist(min=2 max=2 numeric), GEN(name
> )
  2. 
.     quietly {
  3.         tempvar s c
  4. 
.         local v1 : word 1 of `varlist'
  5.         local v2 : word 2 of `varlist'
  6. 
.         gen `s' = string(`v1', "%02.0f")
  7.         gen `c' = string(`v2', "%03.0f")
  8. 
.         gen `gen' = real(`s' + `c')
  9.     }
 10. end

. 
. ** Reclassify suppressed values as 0 
. 
. capture program drop unsuppress

. program define unsuppress
  1.     syntax varlist
  2. 
.     foreach v of varlist `varlist' {
  3.         replace `v' = 0 if `v' == -1
  4.     }
  5. end

. 
. //--------------------------------------------------
. // STEP -1: Acquire raw data (automated where possib
> le)
. //--------------------------------------------------
. /*
> This block downloads public-use source data directly
>  from official URLs if not present locally.
> 
> Automated downloads included:
>   - IRS SOI county-to-county migration: countyinflow
> YYZZ.csv / countyoutflowYYZZ.csv
>   - IRS SOI county data: YYincyallagi.csv
>   - BEA Regional Economic Accounts (CAINC1): CAINC1.
> zip (unzips to CAINC1__ALL_AREAS_*.csv and related f
> iles)
> 
> */
. 
. * Ensure expected directory structure exists
. capture mkdir "${data}"

. capture mkdir "${data}working"

. capture mkdir "${data}demographic"

. capture mkdir "${data}demographic/CAINC1"

. capture mkdir "${data}demographic/nhgis0031_csv"

. capture mkdir "${data}irs"

. capture mkdir "${data}covid"

. 
. * ----------------------------
. * IRS SOI: migration files
. * ----------------------------
. local irs_base "https://www.irs.gov/pub/irs-soi"

. 
. forvalues yy = 15/21 {
  2.     local zz = `yy' + 1
  3.     local fn_out "countyoutflow`yy'`zz'.csv"
  4.     local fn_in  "countyinflow`yy'`zz'.csv"
  5. 
.     capture confirm file "${data}irs/`fn_out'"
  6.     if _rc {
  7.         di as txt "Downloading (IRS SOI) `fn_out'
>  ..."
  8.         copy "`irs_base'/`fn_out'" "${data}irs/`f
> n_out'", replace
  9.     }
 10. 
.     capture confirm file "${data}irs/`fn_in'"
 11.     if _rc {
 12.         di as txt "Downloading (IRS SOI) `fn_in' 
> ..."
 13.         copy "`irs_base'/`fn_in'" "${data}irs/`fn
> _in'", replace
 14.     }
 15. }

. 
. * ----------------------------
. * IRS SOI: county income (AGI) files
. * ----------------------------
. forvalues yy = 15/22 {
  2.     local fn_inc "`yy'incyallagi.csv"
  3. 
.     capture confirm file "${data}irs/`fn_inc'"
  4.     if _rc {
  5.         di as txt "Downloading (IRS SOI) `fn_inc'
>  ..."
  6.         copy "`irs_base'/`fn_inc'" "${data}irs/`f
> n_inc'", replace
  7.     }
  8. }

. 
. * ----------------------------
. * BEA Regional: CAINC1.zip
. * ----------------------------
. local bea_dir "${data}demographic/CAINC1"

. local bea_url "https://apps.bea.gov/regional/zip/CAI
> NC1.zip"

. local bea_zip "`bea_dir'/CAINC1.zip"

. 
. * If we don't already have a CAINC1 "_ALL_AREAS" fil
> e, download + unzip the ZIP.
. local bea_files : dir "`bea_dir'" files "CAINC1__ALL
> _AREAS_*.csv"

. if "`bea_files'"=="" {
.     local bea_files : dir "`bea_dir'" files "CAINC1_
> _ALL_STATES_*.csv"
. }

. 
. if "`bea_files'"=="" {
.     di as txt "Downloading (BEA) CAINC1.zip ..."
Downloading (BEA) CAINC1.zip ...
.     copy "`bea_url'" "`bea_zip'", replace
(file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/demographic/CAINC1/CAINC1.zip not
    found)
. 
.     local curdir "`c(pwd)'"
.     cd "`bea_dir'"
C:\Users\ji252\Documents\GitHub\multnomah-county-tax\d
> ata\demographic\CAINC1
.     unzipfile "CAINC1.zip", replace
    inflating: CAINC1__ALL_AREAS_1969_2023.csv
    inflating: CAINC1__definition.xml
    inflating: CAINC1__Footnotes.html
    inflating: CAINC1_AK_1969_2023.csv
    inflating: CAINC1_AL_1969_2023.csv
    inflating: CAINC1_AR_1969_2023.csv
    inflating: CAINC1_AZ_1969_2023.csv
    inflating: CAINC1_CA_1969_2023.csv
    inflating: CAINC1_CO_1969_2023.csv
    inflating: CAINC1_CSA_1969_2023.csv
    inflating: CAINC1_CT_1969_2023.csv
    inflating: CAINC1_DC_1969_2023.csv
    inflating: CAINC1_DE_1969_2023.csv
    inflating: CAINC1_FL_1969_2023.csv
    inflating: CAINC1_GA_1969_2023.csv
    inflating: CAINC1_HI_1969_2023.csv
    inflating: CAINC1_IA_1969_2023.csv
    inflating: CAINC1_ID_1969_2023.csv
    inflating: CAINC1_IL_1969_2023.csv
    inflating: CAINC1_IN_1969_2023.csv
    inflating: CAINC1_KS_1969_2023.csv
    inflating: CAINC1_KY_1969_2023.csv
    inflating: CAINC1_LA_1969_2023.csv
    inflating: CAINC1_MA_1969_2023.csv
    inflating: CAINC1_MD_1969_2023.csv
    inflating: CAINC1_MDIV_1969_2023.csv
    inflating: CAINC1_ME_1969_2023.csv
    inflating: CAINC1_MI_1969_2023.csv
    inflating: CAINC1_MIC_1969_2023.csv
    inflating: CAINC1_MN_1969_2023.csv
    inflating: CAINC1_MO_1969_2023.csv
    inflating: CAINC1_MS_1969_2023.csv
    inflating: CAINC1_MSA_1969_2023.csv
    inflating: CAINC1_MT_1969_2023.csv
    inflating: CAINC1_NC_1969_2023.csv
    inflating: CAINC1_ND_1969_2023.csv
    inflating: CAINC1_NE_1969_2023.csv
    inflating: CAINC1_NH_1969_2023.csv
    inflating: CAINC1_NJ_1969_2023.csv
    inflating: CAINC1_NM_1969_2023.csv
    inflating: CAINC1_NV_1969_2023.csv
    inflating: CAINC1_NY_1969_2023.csv
    inflating: CAINC1_OH_1969_2023.csv
    inflating: CAINC1_OK_1969_2023.csv
    inflating: CAINC1_OR_1969_2023.csv
    inflating: CAINC1_PA_1969_2023.csv
    inflating: CAINC1_PORT_1969_2023.csv
    inflating: CAINC1_RI_1969_2023.csv
    inflating: CAINC1_SC_1969_2023.csv
    inflating: CAINC1_SD_1969_2023.csv
    inflating: CAINC1_TN_1969_2023.csv
    inflating: CAINC1_TX_1969_2023.csv
    inflating: CAINC1_US_1969_2023.csv
    inflating: CAINC1_UT_1969_2023.csv
    inflating: CAINC1_VA_1969_2023.csv
    inflating: CAINC1_VT_1969_2023.csv
    inflating: CAINC1_WA_1969_2023.csv
    inflating: CAINC1_WI_1969_2023.csv
    inflating: CAINC1_WV_1969_2023.csv
    inflating: CAINC1_WY_1969_2023.csv

successfully unzipped CAINC1.zip to current directory
total processed:  60
        skipped:  0
      extracted:  60
.     cd "`curdir'"
C:\Users\ji252\Documents\GitHub\multnomah-county-tax
. 
.     capture erase "`bea_zip'"
. }

. 
. * ----------------------------
. * NYTimes COVID Data 
. * ----------------------------
. local covid_dir "${data}covid"

. local covid_url "https://raw.githubusercontent.com/n
> ytimes/covid-19-data/master/us-counties.csv"

. 
. * If we don't already have a COVID file, download.
. local covid_file : dir "`covid_dir'" files "covid_ny
> t.csv"

. if "`covid_file'"=="" {
.     local covid_file : dir "`covid_dir'" files "covi
> d_nyt.csv"
. }

. 
. if "`covid_file'"=="" {
.     di as txt "Downloading (COVID)  ..."
Downloading (COVID)  ...
.     copy "`covid_url'" "`covid_dir'/covid_nyt.csv", 
> replace
. }

. 
. 
. 
. //--------------------------------------------------
> ---------
. // STEP 1: Import and Clean Demographic Data via IPU
> MS + BEA  
. //--------------------------------------------------
> ---------
. 
. ** Import data 
. import delimited        ///
>         "${data}demographic/nhgis0031_csv/nhgis0031_
> ts_nominal_county.csv", clear 
(encoding automatically selected: ISO-8859-1)
(15 vars, 54,673 obs)

. 
. ** Describe data 
. des 

Contains data
 Observations:        54,673                  
    Variables:            15                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
gisjoin         str8    %9s                   GISJOIN
year            str9    %9s                   YEAR
state           str20   %20s                  STATE
statefp         byte    %8.0g                 STATEFP
statenh         int     %8.0g                 STATENH
county          str46   %46s                  COUNTY
countyfp        int     %8.0g                 COUNTYFP
countynh        int     %8.0g                 COUNTYNH
name            str59   %59s                  NAME
av0aa           long    %12.0g                AV0AA
d15aa           long    %12.0g                D15AA
d15ab           long    %12.0g                D15AB
b79aa           long    %12.0g                B79AA
av0aam          long    %12.0g                AV0AAM
b79aam          long    %8.0g                 B79AAM
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.

. 
. ** Drop unnecc variables 
. drop gisjoin statenh countynh name 

. 
. ** Rename 
. rename state state_name 

. rename statefp state_fips 

. rename county county_name 

. rename countyfp county_fips 

. rename av0aa population 

. rename d15aa pop_urban 

. rename d15ab pop_rural 

. rename b79aa median_income 

. rename av0aam population_margin

. rename b79aam median_income_margin 

. 
. ** Create urban percent 
. gen percent_urban = pop_urban / population
(45,090 missing values generated)

. 
. ** Label variables 
. label var state_name "State name"

. label var state_fips "State FIPS code"

. label var county_name "County name"

. label var county_fips "County FIPS code"

. label var population "Population count"

. label var pop_rural "Rural population count"

. label var pop_urban "Urban population count"

. label var percent_urban "Percent of population in ur
> ban areas"

. label var median_income "Median household income (pr
> ior year)"

. label var population_margin "ACS margin for error: p
> opulation"

. label var median_income_margin "ACS margin for error
> : median income"

. 
. ** Save as temporary file 
. tempfile demo

. save `demo'
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000001
    > .tmp saved as .dta format

. 
. ** Create three datasets 
. 
. ** (1) Basic state and county IDs 
. keep if year == "2020" 
(51,452 observations deleted)

. keep state* county* 

. 
. ** Make FIPS 
. make_fips state_fips county_fips, gen(fips)

. 
. ** Save as state and county Ids 
. save "${data}working/ids", replace 
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/ids.dta saved

. clear  

. 
. ** (2) Population data 
. use `demo'

. keep if !missing(pop_urban) 
(45,090 observations deleted)

. tab year 

       YEAR |      Freq.     Percent        Cum.
------------+-----------------------------------
       2000 |      3,141       32.78       32.78
       2010 |      3,221       33.61       66.39
       2020 |      3,221       33.61      100.00
------------+-----------------------------------
      Total |      9,583      100.00

. 
. ** Keep 2020 
. keep if year == "2020"
(6,362 observations deleted)

. drop year median_income* population_margin

. 
. ** Make FIPS 
. make_fips state_fips county_fips, gen(fips)

. 
. ** Save data
. save "${data}working/population_2020", replace 
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/population_2020.dta saved

. clear  

. 
. ** (3) 2015-2019 ACS data 
. use `demo'

. keep if !missing(median_income) 
(6,447 observations deleted)

. tab year 

       YEAR |      Freq.     Percent        Cum.
------------+-----------------------------------
       2000 |      3,141        6.51        6.51
  2006-2010 |      3,221        6.68       13.19
  2007-2011 |      3,221        6.68       19.87
  2008-2012 |      3,221        6.68       26.55
  2009-2013 |      3,221        6.68       33.23
  2010-2014 |      3,220        6.68       39.91
  2011-2015 |      3,219        6.67       46.58
  2012-2016 |      3,220        6.68       53.26
  2013-2017 |      3,220        6.68       59.93
  2014-2018 |      3,219        6.67       66.61
  2015-2019 |      3,220        6.68       73.29
  2016-2020 |      3,220        6.68       79.96
  2017-2021 |      3,220        6.68       86.64
  2018-2022 |      3,221        6.68       93.32
  2019-2023 |      3,222        6.68      100.00
------------+-----------------------------------
      Total |     48,226      100.00

. 
. ** Keep 2020 
. keep if year == "2015-2019"
(45,006 observations deleted)

. drop year pop_rural pop_urban percent_urban

. 
. ** Make FIPS 
. make_fips state_fips county_fips, gen(fips)

. 
. ** Save data
. save "${data}working/acs_2015_2019_data", replace 
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/acs_2015_2019_data.dta saved

. 
. ** Rename for merge 
. rename population population_acs

. 
. ** Merge with other data 
. merge 1:1 state_fips county_fips using "${data}worki
> ng/population_2020",                ///
>         keep(match) nogen 

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                             3,219  
    -----------------------------------------

. 
. ** Save data
. save "${data}working/demographics_2020", replace 
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/demographics_2020.dta saved

. 
. ** Load BEA Data 
. import delimited "${data}demographic/CAINC1/CAINC1__
> ALL_AREAS_1969_2023.csv",   ///
>         clear 
(encoding automatically selected: ISO-8859-1)
(63 vars, 9,604 obs)

. 
. ** Drop unnecc variables 
. drop region tablename industryclassification unit ge
> oname 

. 
. ** Drop empty cells 
. drop if missing(linecode)
(4 observations deleted)

. 
. ** Update names 
. rename geofips fips 

. replace fips = subinstr(fips, `"""', "", .)
(9,600 real changes made)

. destring fips, replace 
fips: all characters numeric; replaced as long

. 
. ** Keep population and per-capita income, dropping p
> ersonal income (total)
. tab description linecode

                      |  LineCode
          Description |         1 |     Total
----------------------+-----------+----------
Per capita personal.. |         0 |     3,200 
Personal income (th.. |     3,200 |     3,200 
Population (persons.. |         0 |     3,200 
----------------------+-----------+----------
                Total |     3,200 |     9,600 


                      |  LineCode
          Description |         2 |     Total
----------------------+-----------+----------
Per capita personal.. |         0 |     3,200 
Personal income (th.. |         0 |     3,200 
Population (persons.. |     3,200 |     3,200 
----------------------+-----------+----------
                Total |     3,200 |     9,600 


                      |  LineCode
          Description |         3 |     Total
----------------------+-----------+----------
Per capita personal.. |     3,200 |     3,200 
Personal income (th.. |         0 |     3,200 
Population (persons.. |         0 |     3,200 
----------------------+-----------+----------
                Total |     3,200 |     9,600 

. drop if linecode == 1   
(3,200 observations deleted)

. drop description

.         
. ** Get V* to be in terms of years 
. ** V9 == 1969 
. forvalues i = 9/63 {
  2.         
.         local j = 1960 + `i'
  3.         rename v`i' value`j'
  4.         
. } // END I LOOP 

. 
. ** Reshape 
. reshape long value, i(fips linecode) j(year)
(j = 1969 1970 1971 1972 1973 1974 1975 1976 1977 1978
>  1979 1980 1981 1982 1983 1984 1985 1986 1987 1988 1
> 989 1990 1991 1992 1993 1994 1995 1996 1997 1998 199
> 9 2000 2001 2002 2003 2004 2005 2006 2007 2008 2009 
> 2010 2011 2012 2013 2014 2015 2016 2017 2018 2019 20
> 20 2021 2022 2023)

Data                               Wide   ->   Long
------------------------------------------------------
> -----------------------
Number of observations            6,400   ->   352,000
>      
Number of variables                  57   ->   4      
>      
j variable (55 values)                    ->   year
xij variables:
      value1969 value1970 ... value2023   ->   value
------------------------------------------------------
> -----------------------

. reshape wide value, i(fips year ) j(linecode)
(j = 2 3)

Data                               Long   ->   Wide
------------------------------------------------------
> -----------------------
Number of observations          352,000   ->   176,000
>      
Number of variables                   4   ->   4      
>      
j variable (2 values)          linecode   ->   (droppe
> d)
xij variables:
                                  value   ->   value2 
> value3
------------------------------------------------------
> -----------------------

. 
. ** Keep years 
. keep if inrange(year, 2015, 2023)
(147,200 observations deleted)

. 
. ** Rename values 
. rename value2 population 

. rename value3 per_capita_income

. 
. ** Drop if missing values 
. drop if population == "(NA)"
(239 observations deleted)

. 
. ** Keep only counties with all observations 
. bysort fips: gen ct = _N 

. tab ct

         ct |      Freq.     Percent        Cum.
------------+-----------------------------------
          4 |          8        0.03        0.03
          5 |          5        0.02        0.05
          9 |     28,548       99.95      100.00
------------+-----------------------------------
      Total |     28,561      100.00

. keep if ct == 9
(13 observations deleted)

. drop ct

. 
. ** Destring 
. destring population, replace 
population: all characters numeric; replaced as long

. destring per_capita_income, replace 
per_capita_income: all characters numeric; replaced as
>  long

. 
. ** Save data
. save "${data}working/bea_economics", replace 
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/bea_economics.dta saved

. 
. //--------------------------------------------------
> --
. // STEP 2: Import and Clean NYTimes COVID-19 Data 
. //--------------------------------------------------
> --
.  
. ** Import data 
. import delimited using "${data}covid/covid_nyt.csv",
>  varnames(1) clear case(lower) 
(encoding automatically selected: ISO-8859-1)
(6 vars, 2,502,832 obs)

. 
. ** Describe data 
. des 

Contains data
 Observations:     2,502,832                  
    Variables:             6                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
date            str10   %10s                  
county          str35   %35s                  
state           str24   %24s                  
fips            long    %12.0g                
cases           long    %12.0g                
deaths          long    %8.0g                 
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.

. 
. ** Set up date information 
. generate num_date = date(date, "YMD")

. format num_date %td

. drop date 

. 
. ** Rename 
. rename state state_name 

. rename county county_name 

. rename num_date date 

. 
. ** keep only counties 
. keep if !missing(fips)
(23,678 observations deleted)

. 
. ** Keep in 50 states 
. drop if state_name == "Puerto Rico"
(57,605 observations deleted)

. drop if state_name == "Virgin Islands"
(2,304 observations deleted)

. drop if state_name == "Northern Mariana Islands"
(1,452 observations deleted)

. 
. ** Sort 
. sort date fips 

. 
. ** Create panel 
. xtset fips date

Panel variable: fips (unbalanced)
 Time variable: date, 21jan2020 to 13may2022, but
                with gaps
         Delta: 1 day

. 
. ** Fill in panel 
. tsfill, full 

. 
. ** Fill in missing values 
. replace cases = 0 if missing(cases)
(228,991 real changes made)

. replace deaths = 0 if missing(deaths)
(228,991 real changes made)

. 
. ** Preserve data 
. preserve 

. 
. ** Preserve fips codes and names 
. keep if !missing(state_name)
(228,991 observations deleted)

. keep if !missing(county_name)
(0 observations deleted)

. duplicates drop fips state_name county_name, force 

Duplicates in terms of fips state_name county_name

(2,414,657 observations deleted)

. 
. ** Save as temporary data 
. tempfile state_county_names 

. save `state_county_names'
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000003
    > .tmp saved as .dta format

. clear 

. 
. ** Restore 
. restore 

. 
. ** Drop and merge in names 
. drop state_name county_name

. merge m:1 fips using `state_county_names', keep(mast
> er match) nogen 

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                         2,646,784  
    -----------------------------------------

. 
. ** Get year, month, day 
. gen year = year(date)

. gen month = month(date)

. gen day = day(date)

. 
. ** Order data 
. order date year month day fips state county cases de
> aths 

. 
. ** Calculate cumulative cases and deaths 
. bysort fips (date): gen cases_cum = sum(cases)

. bysort fips (date): gen deaths_cum = sum(deaths)

. 
. ** Merge population data (2020)
. merge m:1 fips using "${data}working/population_2020
> ", keep(match) nogen  
(variable county_name was str35, now str46 to
       accommodate using data's values)
(variable fips was long, now double to accommodate
       using data's values)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                         2,643,408  
    -----------------------------------------

. 
. ** Save file 
. save ${data}working/covid_cleaned.dta, replace 
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/covid_cleaned.dta saved

. 
. ** Generate Clustering Variables 
. 
. ** Keep one observation per month 
. keep year month fips state_name county_name cases_cu
> m deaths_cum population

. collapse (sum) cases deaths population, by(year mont
> h fips state_name county_name) 

. sort year month fips 

. egen date = group(year month)

. drop year month 

. 
. ** Generate per capita figures
. replace cases = 1000 * cases / population
(82,955 real changes made)

. replace deaths = 1000 * deaths / population
(74,723 real changes made)

. drop population 

. 
. ** Reshape wide 
. reshape wide cases deaths, i(fips state_name county_
> name) j(date)
(j = 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 2
> 0 21 22 23 24 25 26 27 28 29)

Data                               Long   ->   Wide
------------------------------------------------------
> -----------------------
Number of observations           90,828   ->   3,132  
>      
Number of variables                   6   ->   61     
>      
j variable (29 values)             date   ->   (droppe
> d)
xij variables:
                              cases_cum   ->   cases_c
> um1 cases_cum2 ... cases_cum29
                             deaths_cum   ->   deaths_
> cum1 deaths_cum2 ... deaths_cum29
------------------------------------------------------
> -----------------------

. 
. ** Save file 
. save ${data}working/covid_cleaned_wide.dta, replace 
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/covid_cleaned_wide.dta saved

. clear

. 
. //--------------------------------------------------
> --
. // STEP 3: Import and Clean ACS Micro Data via IPUMS
>  
. //--------------------------------------------------
> --
. 
. ** Load data 
. forvalues y = 2015(1)2023 {
  2.         
.         ** Import CSV
.         import delimited using "${data}acs/acs_`y'",
>  varnames(1) clear case(lower)
  3.         
.         ** Save as temporary data 
.         tempfile acs_`y'
  4.         save `acs_`y''
  5.         clear 
  6.         
. } // END YEAR LOOP 
(encoding automatically selected: ISO-8859-1)
(57 vars, 2,997,503 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000004
    > .tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(57 vars, 3,007,847 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000005
    > .tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(57 vars, 3,038,696 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000006
    > .tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(57 vars, 3,060,442 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000007
    > .tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(57 vars, 3,087,291 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000008
    > .tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(57 vars, 2,454,160 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000009
    > .tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(57 vars, 3,092,079 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000a
    > .tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(55 vars, 3,190,848 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000b
    > .tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(55 vars, 3,228,659 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000c
    > .tmp saved as .dta format

. 
. ** Append data 
. forvalues y = 2015(1)2023 {
  2.         
.         append using `acs_`y''  
  3.         
. } // END YEAR LOOP 
(variable cbserial was long, now double to
       accommodate using data's values)

. 
. ** Des 
. tab year 

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       2015 |  2,997,503       11.04       11.04
       2016 |  3,007,847       11.08       22.11
       2017 |  3,038,696       11.19       33.30
       2018 |  3,060,442       11.27       44.57
       2019 |  3,087,291       11.37       55.94
       2020 |  2,454,160        9.04       64.98
       2021 |  3,092,079       11.39       76.36
       2022 |  3,190,848       11.75       88.11
       2023 |  3,228,659       11.89      100.00
------------+-----------------------------------
      Total | 27,157,525      100.00

. 
. ** Define # of adults and kids in HHs 
. gen adult = age >= 18 

. gen child = age < 18 

. bysort year serial: gen hh_size = _N 

. bysort year serial: egen hh_adult_ct = total(adult)

. bysort year serial: egen hh_child_ct = total(child)

. 
. ** Sample 18+
. drop if child == 1 
(5,629,869 observations deleted)

. drop child adult 

. 
. ** Sample not living abroad last year 
. drop if migplac1 > 56 
(108,862 observations deleted)

. drop if migrate1 == 4 
(0 observations deleted)

. 
. ** Rename variables 
. rename statefip state_fips_d

. rename countyfip county_fips_d 

. 
. ** Set up origin data 
. fre migrate1

migrate1
------------------------------------------------------
> -----
              |      Freq.    Percent      Valid      
>  Cum.
--------------+---------------------------------------
> -----
Valid   1     |   1.92e+07      89.51      89.51      
> 89.51
        2     |    1809920       8.45       8.45      
> 97.96
        3     |     436745       2.04       2.04     1
> 00.00
        Total |   2.14e+07     100.00     100.00      
>      
------------------------------------------------------
> -----

. drop migrate1d

. tab migplac1

   migplac1 |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 | 19,172,129       89.51       89.51
          1 |     31,329        0.15       89.66
          2 |      5,825        0.03       89.68
          4 |     54,912        0.26       89.94
          5 |     21,714        0.10       90.04
          6 |    260,673        1.22       91.26
          8 |     52,539        0.25       91.50
          9 |     21,577        0.10       91.61
         10 |      5,369        0.03       91.63
         11 |      8,664        0.04       91.67
         12 |    152,989        0.71       92.38
         13 |     71,263        0.33       92.72
         15 |      9,845        0.05       92.76
         16 |     13,536        0.06       92.83
         17 |     86,306        0.40       93.23
         18 |     47,941        0.22       93.45
         19 |     21,469        0.10       93.55
         20 |     22,338        0.10       93.66
         21 |     31,888        0.15       93.81
         22 |     28,776        0.13       93.94
         23 |      7,911        0.04       93.98
         24 |     40,223        0.19       94.17
         25 |     48,684        0.23       94.39
         26 |     65,444        0.31       94.70
         27 |     35,177        0.16       94.86
         28 |     16,994        0.08       94.94
         29 |     45,200        0.21       95.15
         30 |      7,453        0.03       95.19
         31 |     13,567        0.06       95.25
         32 |     24,785        0.12       95.37
         33 |      8,787        0.04       95.41
         34 |     50,561        0.24       95.64
         35 |     12,299        0.06       95.70
         36 |    118,674        0.55       96.26
         37 |     70,555        0.33       96.59
         38 |      5,884        0.03       96.61
         39 |     81,541        0.38       96.99
         40 |     28,921        0.14       97.13
         41 |     36,246        0.17       97.30
         42 |     76,201        0.36       97.65
         44 |      6,551        0.03       97.68
         45 |     33,552        0.16       97.84
         46 |      6,067        0.03       97.87
         47 |     48,061        0.22       98.09
         48 |    197,912        0.92       99.02
         49 |     25,798        0.12       99.14
         50 |      4,106        0.02       99.16
         51 |     64,560        0.30       99.46
         53 |     64,790        0.30       99.76
         54 |     10,532        0.05       99.81
         55 |     35,653        0.17       99.98
         56 |      5,023        0.02      100.00
------------+-----------------------------------
      Total | 21,418,794      100.00

. rename migplac1 state_fips_o

. tab migcounty1

 migcounty1 |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 | 19,952,847       93.16       93.16
          1 |     35,752        0.17       93.32
          3 |     58,525        0.27       93.60
          5 |     21,286        0.10       93.70
          7 |     13,720        0.06       93.76
          9 |     11,958        0.06       93.82
         11 |     23,663        0.11       93.93
         13 |     53,927        0.25       94.18
         15 |      7,126        0.03       94.21
         17 |     21,840        0.10       94.31
         19 |     24,348        0.11       94.43
         20 |      2,061        0.01       94.44
         21 |     12,848        0.06       94.50
         23 |      7,725        0.04       94.53
         25 |     21,090        0.10       94.63
         27 |     15,274        0.07       94.70
         29 |     32,454        0.15       94.85
         31 |     57,529        0.27       95.12
         33 |     33,851        0.16       95.28
         35 |     24,912        0.12       95.40
         37 |     72,280        0.34       95.73
         39 |     10,381        0.05       95.78
         41 |      8,696        0.04       95.82
         43 |      8,893        0.04       95.86
         45 |      5,998        0.03       95.89
         47 |     22,821        0.11       96.00
         49 |     21,522        0.10       96.10
         51 |     17,488        0.08       96.18
         53 |     17,759        0.08       96.26
         55 |     12,676        0.06       96.32
         57 |     18,309        0.09       96.41
         59 |     30,944        0.14       96.55
         61 |     31,725        0.15       96.70
         63 |     12,421        0.06       96.76
         65 |     18,670        0.09       96.85
         67 |     29,982        0.14       96.99
         69 |      4,036        0.02       97.01
         71 |     27,649        0.13       97.13
         73 |     36,959        0.17       97.31
         75 |     11,968        0.06       97.36
         77 |      8,293        0.04       97.40
         79 |      7,681        0.04       97.44
         81 |     30,275        0.14       97.58
         83 |      9,053        0.04       97.62
         85 |     28,918        0.14       97.76
         87 |      6,680        0.03       97.79
         89 |     10,158        0.05       97.83
         91 |     15,565        0.07       97.91
         93 |      4,960        0.02       97.93
         95 |     19,883        0.09       98.02
         97 |     19,460        0.09       98.11
         99 |     19,554        0.09       98.21
        101 |     14,457        0.07       98.27
        103 |     18,351        0.09       98.36
        105 |      7,421        0.03       98.39
        107 |      5,600        0.03       98.42
        109 |     10,761        0.05       98.47
        111 |     14,844        0.07       98.54
        113 |     30,918        0.14       98.68
        115 |      4,818        0.02       98.71
        117 |      7,798        0.04       98.74
        119 |     14,739        0.07       98.81
        121 |     10,181        0.05       98.86
        123 |      3,671        0.02       98.88
        125 |      9,036        0.04       98.92
        127 |      2,348        0.01       98.93
        129 |      1,814        0.01       98.94
        133 |      5,313        0.02       98.96
        135 |      7,844        0.04       99.00
        139 |      5,952        0.03       99.03
        141 |      6,936        0.03       99.06
        143 |      4,286        0.02       99.08
        145 |      1,975        0.01       99.09
        147 |      2,327        0.01       99.10
        149 |      2,146        0.01       99.11
        151 |      1,900        0.01       99.12
        153 |      5,155        0.02       99.14
        157 |     11,532        0.05       99.20
        159 |        751        0.00       99.20
        160 |        149        0.00       99.20
        161 |      4,716        0.02       99.22
        163 |     13,817        0.06       99.29
        165 |      2,418        0.01       99.30
        167 |      5,023        0.02       99.32
        169 |        850        0.00       99.33
        171 |        529        0.00       99.33
        173 |        264        0.00       99.33
        179 |      1,879        0.01       99.34
        183 |     11,521        0.05       99.39
        185 |        871        0.00       99.40
        187 |      2,303        0.01       99.41
        189 |      6,599        0.03       99.44
        191 |        759        0.00       99.44
        197 |      3,401        0.02       99.46
        201 |     29,158        0.14       99.59
        209 |      2,664        0.01       99.60
        215 |      3,046        0.01       99.62
        223 |        758        0.00       99.62
        227 |        946        0.00       99.63
        245 |      3,068        0.01       99.64
        251 |      1,020        0.00       99.65
        257 |        850        0.00       99.65
        303 |      3,247        0.02       99.67
        309 |      2,351        0.01       99.68
        313 |        456        0.00       99.68
        329 |      1,177        0.01       99.68
        339 |      3,176        0.01       99.70
        355 |      2,646        0.01       99.71
        367 |        977        0.00       99.72
        375 |      1,001        0.00       99.72
        381 |      1,199        0.01       99.73
        423 |      1,497        0.01       99.73
        439 |     14,652        0.07       99.80
        441 |      1,419        0.01       99.81
        451 |        952        0.00       99.81
        453 |     12,549        0.06       99.87
        479 |      1,301        0.01       99.88
        485 |      1,288        0.01       99.88
        491 |      4,036        0.02       99.90
        510 |     10,140        0.05       99.95
        550 |      1,187        0.01       99.95
        650 |      1,031        0.00       99.96
        700 |      1,438        0.01       99.97
        710 |        466        0.00       99.97
        760 |      2,799        0.01       99.98
        810 |      3,933        0.02      100.00
------------+-----------------------------------
      Total | 21,418,794      100.00

. rename migcounty1 county_fips_o

. 
. ** Use migrate1 to update values 
. 
. ** Within same house 
. replace state_fips_o = state_fips_d if migrate1 == 1
(19,172,129 real changes made)

. replace county_fips_o = county_fips_d if migrate1 ==
>  1 
(11,640,515 real changes made)

. 
. ** Within same state 
. replace state_fips_o = state_fips_d if migrate1 == 2
(0 real changes made)

. 
. ** Generate county IDS 
. foreach x in "o" "d" {
  2.         
.         make_fips state_fips_`x' county_fips_`x', ge
> n(fips_`x')
  3. 
. }

. 
. ** Check for within-state migration 
. gen same_county = fips_o == fips_d 

. tab year same_county

           |      same_county
      year |         0          1 |     Total
-----------+----------------------+----------
      2015 |    89,492  2,245,481 | 2,334,973 
      2016 |    91,109  2,255,901 | 2,347,010 
      2017 |    93,553  2,278,348 | 2,371,901 
      2018 |    96,080  2,306,022 | 2,402,102 
      2019 |    96,088  2,344,171 | 2,440,259 
      2020 |    71,827  1,877,155 | 1,948,982 
      2021 |    97,600  2,361,518 | 2,459,118 
      2022 |   106,231  2,430,426 | 2,536,657 
      2023 |    98,226  2,479,566 | 2,577,792 
-----------+----------------------+----------
     Total |   840,206 20,578,588 |21,418,794 

. tab year same_county if migrate1 == 2

           |      same_county
      year |         0          1 |     Total
-----------+----------------------+----------
      2015 |    42,597    172,956 |   215,553 
      2016 |    43,823    172,091 |   215,914 
      2017 |    45,058    174,386 |   219,444 
      2018 |    46,477    173,182 |   219,659 
      2019 |    46,329    168,101 |   214,430 
      2020 |    34,625    119,307 |   153,932 
      2021 |    46,470    148,925 |   195,395 
      2022 |    50,584    141,717 |   192,301 
      2023 |    47,498    135,794 |   183,292 
-----------+----------------------+----------
     Total |   403,461  1,406,459 | 1,809,920 

. 
. ** Tag HH head 
. gen byte hh_head = (relate == 1)

. 
. ** Compress file 
. compress 
  variable state_fips_o was int now byte
  variable hh_size was float now byte
  variable hh_adult_ct was float now byte
  variable hh_child_ct was float now byte
  variable same_county was float now byte
  (278,444,322 bytes saved)

. 
. ** Save 
. save "${data}working/acs_migration_file", replace 
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/acs_migration_file.dta saved

. 
. // Keep only observations with valid origin/destinat
> ion counties and YEAR
. drop if missing(year) | missing(fips_o) | missing(fi
> ps_d)
(0 observations deleted)

. 
. // Clean income (treat missing as 0; keep negative v
> alues as reported)
. replace inctot = 0 if missing(inctot)
(0 real changes made)

. gen double income_wt = inctot * perwt

. label var income_wt "Person income (INCTOT) weighted
>  by PERWT"

. 
. // --- Persons + income totals by origin/destination
> /year
. preserve

. keep year fips_o fips_d perwt income_wt

. collapse (sum) persons=perwt income_total=income_wt,
>  by(year fips_o fips_d)

. tempfile acs_pi

. save `acs_pi'
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000e
    > .tmp saved as .dta format

. restore

. 
. // --- Households by origin/destination/year
. // Use HHWT among household heads (RELATE==1) if ava
> ilable; else PERNUM==1 fallback.
. 
. preserve

. keep if hh_head
(10,269,992 observations deleted)

. keep year fips_o fips_d hhwt

. collapse (sum) households=hhwt, by(year fips_o fips_
> d)

. tempfile acs_hh

. save `acs_hh'
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000g
    > .tmp saved as .dta format

. restore

. 
. // --- Merge persons/income with households
. use `acs_pi', clear

. merge 1:1 year fips_o fips_d using `acs_hh', nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                        45,163
        from master                    45,163  
        from using                          0  

    Matched                           162,899  
    -----------------------------------------

. 
. label var persons "Estimated number of persons (sum 
> PERWT)"

. label var households "Estimated number of households
>  (sum HHWT among heads)"

. label var income_total "Estimated total personal inc
> ome (sum INCTOT*PERWT)"

. 
. // --- Derive state/county components for merges wit
> h name crosswalk
. gen int state_fips_o  = floor(fips_o/1000)

. gen int county_fips_o = mod(fips_o,1000)

. gen int state_fips_d  = floor(fips_d/1000)

. gen int county_fips_d = mod(fips_d,1000)

. 
. label var state_fips_o "State FIPS (origin)"

. label var county_fips_o "County FIPS (origin)"

. label var state_fips_d "State FIPS (destination)"

. label var county_fips_d "County FIPS (destination)"

. 
. // --- Merge in names (from NHGIS IDs snapshot)
. preserve

. use "${data}working/ids", clear

. rename (state_fips county_fips state_name county_nam
> e) (state_fips_o county_fips_o state_name_o county_n
> ame_o)

. tempfile ids_o

. save `ids_o'
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000i
    > .tmp saved as .dta format

. keep state_fips_o state_name_o 

. duplicates drop 

Duplicates in terms of all variables

(3,169 observations deleted)

. tempfile state_ids_o

. save `state_ids_o'
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000j
    > .tmp saved as .dta format

. restore

. merge m:1 state_fips_o county_fips_o using `ids_o', 
> keep(master match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                        46,997
        from master                    46,997  
        from using                          0  

    Matched                           161,065  
    -----------------------------------------

. drop state_name_o 

. merge m:1 state_fips_o using `state_ids_o', keep(mas
> ter match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           208,062  
    -----------------------------------------

. 
. preserve

. use "${data}working/ids", clear

. rename (state_fips county_fips state_name county_nam
> e) (state_fips_d county_fips_d state_name_d county_n
> ame_d)

. tempfile ids_d

. save `ids_d'
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000l
    > .tmp saved as .dta format

. keep state_fips_d state_name_d 

. duplicates drop 

Duplicates in terms of all variables

(3,169 observations deleted)

. tempfile state_ids_d

. save `state_ids_d'
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000m
    > .tmp saved as .dta format

. restore

. 
. merge m:1 state_fips_d county_fips_d using `ids_d', 
> keep(master match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                        50,197
        from master                    50,197  
        from using                          0  

    Matched                           157,865  
    -----------------------------------------

. drop state_name_d

. merge m:1 state_fips_d using `state_ids_d', keep(mas
> ter match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           208,062  
    -----------------------------------------

. order year ///
>     state_fips_o county_fips_o state_name_o county_n
> ame_o fips_o ///
>     state_fips_d county_fips_d state_name_d county_n
> ame_d fips_d ///
>     persons households income_total

. 
. sort year state_fips_o county_fips_o state_fips_d co
> unty_fips_d

. 
. replace county_name_o = "Other" if county_fips_o == 
> 0 
(46,948 real changes made)

. replace county_name_d = "Other" if county_fips_d == 
> 0 
(49,676 real changes made)

. 
. save "${data}working/acs_county_flow", replace
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/acs_county_flow.dta saved

. 
. // Optional: Multnomah-focused flow extract (origin 
> = Multnomah County, OR)
. // Multnomah County, OR = state 41, county 051
. preserve

. keep if state_fips_o == 41 & county_fips_o == 51
(207,316 observations deleted)

. save "${data}working/multnomah_acs_flow", replace
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/multnomah_acs_flow.dta saved

. clear

. 
. 
. 
. //--------------------------------------------------
> --
. // STEP 4: Import and Clean IRS Migration Data 
. //--------------------------------------------------
> --
. 
. ** Loop over years 
. forvalues y = 15(1)21 {
  2.         
.         local start = `y'
  3.         local end = `y' + 1 
  4.         
.         ** Import data (out)
.         import delimited "${data}irs/countyoutflow`s
> tart'`end'.csv", clear 
  5.         
.         ** Describe data 
.         des 
  6.         
.         ** Generate year 
.         gen year = 2000 + `y' 
  7.         
.         ** Drop Regional Values 
.         drop if y2_state == "DS"
  8.         
.         ** Drop Foreign Migration 
.         drop if y2_state == "FR"
  9.         
.         ** Drop observations without a county
.         drop if y1_countyfips == 0 
 10.         
.         ** Deal with suppressed values 
.         unsuppress n1 n2 agi
 11.         
.         ** Drop unnecc variables 
.         drop y2_state y2_countyname
 12.                 
.         ** Create two versions: gross and net 
.         tempfile tmp
 13.         save `tmp'
 14.         
.         ** Gross first 
.         
.         ** Keep gross categories 
.         keep if ///
>                 (y1_statefips == y2_statefips & y1_c
> ountyfips == y2_countyfips) |       ///
>                 inlist(y2_statefips, 96, 97, 98)
 15. 
.         ** Clean up 
.         gen move_type = 0 
 16.         
.         ** Stayers 
.         replace move_type = 1 if        (y1_statefip
> s == y2_statefips) &        ///
>                                                     
>             (y1_countyfips == y2_countyfips) 
 17.         
.         ** Movers
.         replace move_type = 2 if        y2_statefips
>  == 96              // ALL 
 18.         replace move_type = 3 if        y2_statef
> ips == 97 &    ///
>                                                     
>             y2_countyfips == 0              // Domes
> tic Total
 19.         replace move_type = 4 if        y2_statef
> ips == 97 &    ///
>                                                     
>             y2_countyfips == 1              // Withi
> n-state
 20.         replace move_type = 5 if        y2_statef
> ips == 97 &    ///
>                                                     
>             y2_countyfips == 3              // Betwe
> en-states 
 21.         replace move_type = 6 if        y2_statef
> ips == 98              // Foreign 
 22.         
.         ** Label movers 
.         label values move_type lb_move_type 
 23.         
.         ** Generate total category 
.         foreach var of varlist n1 n2 agi {
 24.                 
.                 gen tmp = `var' if inlist(move_type,
>  1, 2)
 25.                 bysort y1_statefips y1_countyfips
> : egen `var'_total = total(tmp)
 26.                 drop tmp 
 27.                 
.         } // END VAR LOOP 
 28.         
.         ** Drop unnecc variables 
.         drop y2_* 
 29.         
.         ** Sort 
.         sort year y1_statefips y1_countyfips move_ty
> pe 
 30. 
.         ** Order 
.         order year y1_statefips y1_countyfips move_t
> ype 
 31.         
.         ** Rename 
.         rename y1_countyfips county_fips 
 32.         rename y1_statefips state_fips 
 33.         
.         ** Label variables 
.         label var year "Tax year (year before move)"
 34.         label var state_fips "State FIPS code (or
> igin state)"
 35.         label var county_fips "County FIPS code (
> origin county)"
 36.         label var move_type "Mover category"
 37.         label var n1 "Number of returns"
 38.         label var n2 "Number of exemptions"
 39.         label var agi "Adjusted Gross Income"
 40.         label var n1_total "Number of returns, co
> unty total (origin)"
 41.         label var n2_total "Number of exemptions,
>  county total (origin)"
 42.         label var agi_total "Adjusted Gross Incom
> e, county total (origin)"
 43.         
.         ** Save 
.         save "${data}working/irs_county_gross_out_`y
> '", replace 
 44.         
.         ** Create version for merge with net 
.         keep if move_type == 3 
 45.         
.         ** Rename variables 
.         rename n1 n1_mover
 46.         rename n2 n2_mover 
 47.         rename agi agi_mover 
 48.         
.         label var n1_mover "Number of domestic mover
>  returns"
 49.         label var n2_mover "Number of domestic mo
> ver exemptions"
 50.         label var agi_mover "Adjusted Gross Incom
> e, domestic movers"
 51.         
.         ** Save as temp file 
.         tempfile merge 
 52.         save `merge'
 53.         clear 
 54.         
.         ** Next, create flow file 
.         use `tmp', clear 
 55.         
.         ** Drop aggregate values 
.         drop if inlist(y2_statefips, 96, 97, 98)
 56.         drop if (y1_statefips == y2_statefips & y
> 1_countyfips == y2_countyfips) 
 57.         
.         ** Sort 
.         sort year y1_statefips y1_countyfips y2_stat
> efips y2_countyfips 
 58. 
.         ** Order 
.         order year y1_statefips y1_countyfips y2_sta
> tefips y2_countyfips
 59. 
.         
.         ** Rename 
.         rename y1_countyfips county_fips 
 60.         rename y1_statefips state_fips 
 61.         rename y2_countyfips y2_county_fips 
 62.         rename y2_statefips y2_state_fips       
 63.         
.         ** Label variables 
.         label var year "Tax year (year before move)"
 64.         label var state_fips "State FIPS code (or
> igin state)"
 65.         label var county_fips "County FIPS code (
> origin county)"
 66.         label var y2_state_fips "State FIPS code 
> (dest. state)"
 67.         label var y2_county_fips "County FIPS cod
> e (dest. county)"      
 68.         label var n1 "Number of returns"
 69.         label var n2 "Number of exemptions"
 70.         label var agi "Adjusted Gross Income"
 71.         
.         ** Merge with county of origin data 
.         merge m:1 state_fips county_fips using `merg
> e', nogen keep(master match)
 72.         
.         ** Rename 
.         rename state_fips state_fips_o
 73.         rename county_fips county_fips_o
 74.         rename y2_* *_d 
 75.         
.         ** Dropo unnecc variable 
.         drop move_type 
 76.         
.         ** Save 
.         save "${data}working/irs_county_flow_`y'", r
> eplace 
 77.         clear
 78.         
.         ** Import data (in)
.         import delimited "${data}irs/countyinflow`st
> art'`end'.csv", clear 
 79.         
.         ** Describe data 
.         des 
 80. 
.         ** Generate year 
.         gen year = 2000 + `y' 
 81.         
.         ** Drop Regional Values 
.         drop if y1_state == "DS"
 82.         
.         ** Drop Foreign Migration 
.         drop if y1_state == "FR"
 83.         
.         ** Drop observations with no county ID 
.         drop if y2_countyfips == 0 
 84.         
.         ** Keep gross categories 
.         keep if ///
>                 (y1_statefips == y2_statefips & y1_c
> ountyfips == y2_countyfips) |       ///
>                 inlist(y1_statefips, 96, 97, 98)
 85. 
.         ** Clean up 
.         gen move_type = 0 
 86.         
.         ** Deal with suppressed values 
.         unsuppress n1 n2 agi
 87.         
.         ** Stayers 
.         replace move_type = 1 if        (y1_statefip
> s == y2_statefips) &        ///
>                                                     
>             (y1_countyfips == y2_countyfips) 
 88.         
.         ** Movers
.         replace move_type = 2 if        y1_statefips
>  == 96              // ALL 
 89.         replace move_type = 3 if        y1_statef
> ips == 97 &    ///
>                                                     
>             y1_countyfips == 0              // Domes
> tic Total
 90.         replace move_type = 4 if        y1_statef
> ips == 97 &    ///
>                                                     
>             y1_countyfips == 1              // Withi
> n-state
 91.         replace move_type = 5 if        y1_statef
> ips == 97 &    ///
>                                                     
>             y1_countyfips == 3              // Betwe
> en-states 
 92.         replace move_type = 6 if        y1_statef
> ips == 98              // Foreign 
 93.         
.         ** Label move variable  
.         label values move_type lb_move_type 
 94.         
.         ** Generate total category 
.         foreach var of varlist n1 n2 agi {
 95.                 
.                 gen tmp = `var' if inlist(move_type,
>  1, 2)
 96.                 bysort y2_statefips y2_countyfips
> : egen `var'_total = total(tmp)
 97.                 drop tmp 
 98.                 
.         } // END VAR LOOP 
 99.         
.         ** Drop unnecc variables 
.         drop y1_*
100.         
.         ** Sort 
.         sort year y2_statefips y2_countyfips move_ty
> pe 
101. 
.         ** Order 
.         order year y2_statefips y2_countyfips move_t
> ype 
102.         
.         ** Rename 
.         rename y2_countyfips county_fips 
103.         rename y2_statefips state_fips 
104.         
.         ** Label variables 
.         label var year "Tax year (year before move)"
105.         label var state_fips "State FIPS code (de
> st. state)"
106.         label var county_fips "County FIPS code (
> dest. county)"
107.         label var move_type "Mover category"
108.         label var n1 "Number of returns"
109.         label var n2 "Number of exemptions"
110.         label var agi "Adjusted Gross Income"
111.         label var n1_total "Number of returns, co
> unty total (dest.)"
112.         label var n2_total "Number of exemptions,
>  county total (dest.)"
113.         label var agi_total "Adjusted Gross Incom
> e, county total (dest.)"
114.         
.         ** Save 
.         save "${data}working/irs_county_gross_in_`y'
> ", replace 
115.         clear 
116.         
. } // END YEAR LOOP 
(encoding automatically selected: ISO-8859-1)
(9 vars, 86,481 obs)

Contains data
 Observations:        86,481                  
    Variables:             9                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y2_state        str2    %9s                   
y2_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(15,289 observations deleted)
(2,937 observations deleted)
(254 observations deleted)
(2,056 real changes made)
(2,056 real changes made)
(2,056 real changes made)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000o
    > .tmp saved as .dta format
(50,007 observations deleted)
(3,141 real changes made)
(3,141 real changes made)
(3,141 real changes made)
(3,140 real changes made)
(3,140 real changes made)
(2,291 real changes made)
(11,712 missing values generated)
(11,712 missing values generated)
(11,712 missing values generated)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_out_15.dta
    saved
(14,853 observations deleted)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000p
    > .tmp saved as .dta format
(14,853 observations deleted)
(3,141 observations deleted)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            50,007  
    -----------------------------------------
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_flow_15.dta saved
(encoding automatically selected: ISO-8859-1)
(9 vars, 86,330 obs)

Contains data
 Observations:        86,330                  
    Variables:             9                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y1_state        str2    %9s                   
y1_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(15,315 observations deleted)
(2,814 observations deleted)
(254 observations deleted)
(50,005 observations deleted)
(2,041 real changes made)
(2,041 real changes made)
(2,041 real changes made)
(3,141 real changes made)
(3,141 real changes made)
(3,141 real changes made)
(3,140 real changes made)
(3,140 real changes made)
(2,239 real changes made)
(11,660 missing values generated)
(11,660 missing values generated)
(11,660 missing values generated)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_in_15.dta
    saved
(encoding automatically selected: ISO-8859-1)
(9 vars, 98,948 obs)

Contains data
 Observations:        98,948                  
    Variables:             9                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y2_state        str2    %9s                   
y2_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(15,372 observations deleted)
(2,360 observations deleted)
(254 observations deleted)
(1,877 real changes made)
(1,877 real changes made)
(1,877 real changes made)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000q
    > .tmp saved as .dta format
(63,249 observations deleted)
(3,140 real changes made)
(3,141 real changes made)
(3,141 real changes made)
(3,140 real changes made)
(3,141 real changes made)
(2,010 real changes made)
(11,432 missing values generated)
(11,432 missing values generated)
(11,432 missing values generated)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_out_16.dta
    saved
(14,572 observations deleted)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000r
    > .tmp saved as .dta format
(14,573 observations deleted)
(3,140 observations deleted)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            63,249  
    -----------------------------------------
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_flow_16.dta saved
(encoding automatically selected: ISO-8859-1)
(9 vars, 98,874 obs)

Contains data
 Observations:        98,874                  
    Variables:             9                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y1_state        str2    %9s                   
y1_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(15,432 observations deleted)
(2,282 observations deleted)
(254 observations deleted)
(63,249 observations deleted)
(1,788 real changes made)
(1,788 real changes made)
(1,788 real changes made)
(3,140 real changes made)
(3,141 real changes made)
(3,141 real changes made)
(3,140 real changes made)
(3,140 real changes made)
(1,955 real changes made)
(11,376 missing values generated)
(11,376 missing values generated)
(11,376 missing values generated)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_in_16.dta
    saved
(encoding automatically selected: ISO-8859-1)
(9 vars, 87,820 obs)

Contains data
 Observations:        87,820                  
    Variables:             9                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y2_state        str2    %9s                   
y2_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(15,300 observations deleted)
(2,364 observations deleted)
(254 observations deleted)
(1,942 real changes made)
(1,942 real changes made)
(1,942 real changes made)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000s
    > .tmp saved as .dta format
(52,173 observations deleted)
(3,141 real changes made)
(3,141 real changes made)
(3,141 real changes made)
(3,140 real changes made)
(3,140 real changes made)
(2,026 real changes made)
(11,447 missing values generated)
(11,447 missing values generated)
(11,447 missing values generated)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_out_17.dta
    saved
(14,588 observations deleted)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000t
    > .tmp saved as .dta format
(14,588 observations deleted)
(3,141 observations deleted)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            52,173  
    -----------------------------------------
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_flow_17.dta saved
(encoding automatically selected: ISO-8859-1)
(9 vars, 87,932 obs)

Contains data
 Observations:        87,932                  
    Variables:             9                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y1_state        str2    %9s                   
y1_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(15,368 observations deleted)
(2,403 observations deleted)
(254 observations deleted)
(52,174 observations deleted)
(1,919 real changes made)
(1,919 real changes made)
(1,919 real changes made)
(3,141 real changes made)
(3,141 real changes made)
(3,141 real changes made)
(3,140 real changes made)
(3,140 real changes made)
(2,030 real changes made)
(11,451 missing values generated)
(11,451 missing values generated)
(11,451 missing values generated)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_in_17.dta
    saved
(encoding automatically selected: ISO-8859-1)
(9 vars, 83,878 obs)

Contains data
 Observations:        83,878                  
    Variables:             9                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y2_state        str2    %9s                   
y2_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(14,919 observations deleted)
(2,298 observations deleted)
(0 observations deleted)
(53 real changes made)
(53 real changes made)
(53 real changes made)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000u
    > .tmp saved as .dta format
(51,090 observations deleted)
(3,141 real changes made)
(3,107 real changes made)
(3,107 real changes made)
(3,103 real changes made)
(2,778 real changes made)
(335 real changes made)
(9,323 missing values generated)
(9,323 missing values generated)
(9,323 missing values generated)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_out_18.dta
    saved
(12,464 observations deleted)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000v
    > .tmp saved as .dta format
(12,430 observations deleted)
(3,141 observations deleted)

    Result                      Number of obs
    -----------------------------------------
    Not matched                            34
        from master                        34  
        from using                          0  

    Matched                            51,056  
    -----------------------------------------
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_flow_18.dta saved
(encoding automatically selected: ISO-8859-1)
(9 vars, 83,762 obs)

Contains data
 Observations:        83,762                  
    Variables:             9                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y1_state        str2    %9s                   
y1_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(14,890 observations deleted)
(2,290 observations deleted)
(0 observations deleted)
(51,090 observations deleted)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(3,141 real changes made)
(3,086 real changes made)
(3,086 real changes made)
(3,082 real changes made)
(2,729 real changes made)
(368 real changes made)
(9,265 missing values generated)
(9,265 missing values generated)
(9,265 missing values generated)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_in_18.dta
    saved
(encoding automatically selected: ISO-8859-1)
(9 vars, 87,325 obs)

Contains data
 Observations:        87,325                  
    Variables:             9                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y2_state        str2    %9s                   
y2_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(14,937 observations deleted)
(2,272 observations deleted)
(0 observations deleted)
(62 real changes made)
(62 real changes made)
(62 real changes made)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000w
    > .tmp saved as .dta format
(54,560 observations deleted)
(3,142 real changes made)
(3,104 real changes made)
(3,104 real changes made)
(3,101 real changes made)
(2,773 real changes made)
(332 real changes made)
(9,310 missing values generated)
(9,310 missing values generated)
(9,310 missing values generated)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_out_19.dta
    saved
(12,452 observations deleted)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000x
    > .tmp saved as .dta format
(12,414 observations deleted)
(3,142 observations deleted)

    Result                      Number of obs
    -----------------------------------------
    Not matched                            38
        from master                        38  
        from using                          0  

    Matched                            54,522  
    -----------------------------------------
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_flow_19.dta saved
(encoding automatically selected: ISO-8859-1)
(9 vars, 87,552 obs)

Contains data
 Observations:        87,552                  
    Variables:             9                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y1_state        str2    %9s                   
y1_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(15,060 observations deleted)
(2,323 observations deleted)
(0 observations deleted)
(54,560 observations deleted)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(3,142 real changes made)
(3,102 real changes made)
(3,102 real changes made)
(3,097 real changes made)
(2,805 real changes made)
(361 real changes made)
(9,365 missing values generated)
(9,365 missing values generated)
(9,365 missing values generated)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_in_19.dta
    saved
(encoding automatically selected: ISO-8859-1)
(9 vars, 89,511 obs)

Contains data
 Observations:        89,511                  
    Variables:             9                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y2_state        str2    %9s                   
y2_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(14,963 observations deleted)
(2,175 observations deleted)
(0 observations deleted)
(79 real changes made)
(79 real changes made)
(79 real changes made)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000010
    > .tmp saved as .dta format
(56,831 observations deleted)
(3,143 real changes made)
(3,097 real changes made)
(3,097 real changes made)
(3,094 real changes made)
(2,787 real changes made)
(324 real changes made)
(9,302 missing values generated)
(9,302 missing values generated)
(9,302 missing values generated)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_out_20.dta
    saved
(12,445 observations deleted)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000011
    > .tmp saved as .dta format
(12,399 observations deleted)
(3,143 observations deleted)

    Result                      Number of obs
    -----------------------------------------
    Not matched                            46
        from master                        46  
        from using                          0  

    Matched                            56,785  
    -----------------------------------------
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_flow_20.dta saved
(encoding automatically selected: ISO-8859-1)
(9 vars, 89,850 obs)

Contains data
 Observations:        89,850                  
    Variables:             9                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y1_state        str2    %9s                   
y1_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(15,132 observations deleted)
(2,263 observations deleted)
(0 observations deleted)
(56,835 observations deleted)
(1 real change made)
(1 real change made)
(1 real change made)
(3,143 real changes made)
(3,101 real changes made)
(3,101 real changes made)
(3,098 real changes made)
(2,838 real changes made)
(339 real changes made)
(9,376 missing values generated)
(9,376 missing values generated)
(9,376 missing values generated)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_in_20.dta
    saved
(encoding automatically selected: ISO-8859-1)
(9 vars, 90,409 obs)

Contains data
 Observations:        90,409                  
    Variables:             9                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y2_state        str2    %9s                   
y2_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(14,962 observations deleted)
(2,223 observations deleted)
(0 observations deleted)
(64 real changes made)
(64 real changes made)
(64 real changes made)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000012
    > .tmp saved as .dta format
(57,644 observations deleted)
(3,144 real changes made)
(3,107 real changes made)
(3,107 real changes made)
(3,103 real changes made)
(2,790 real changes made)
(329 real changes made)
(9,329 missing values generated)
(9,329 missing values generated)
(9,329 missing values generated)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_out_21.dta
    saved
(12,473 observations deleted)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000013
    > .tmp saved as .dta format
(12,436 observations deleted)
(3,144 observations deleted)

    Result                      Number of obs
    -----------------------------------------
    Not matched                            37
        from master                        37  
        from using                          0  

    Matched                            57,607  
    -----------------------------------------
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_flow_21.dta saved
(encoding automatically selected: ISO-8859-1)
(9 vars, 90,498 obs)

Contains data
 Observations:        90,498                  
    Variables:             9                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y1_state        str2    %9s                   
y1_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(15,093 observations deleted)
(2,179 observations deleted)
(0 observations deleted)
(57,640 observations deleted)
(1 real change made)
(1 real change made)
(1 real change made)
(3,144 real changes made)
(3,098 real changes made)
(3,098 real changes made)
(3,094 real changes made)
(2,822 real changes made)
(330 real changes made)
(9,344 missing values generated)
(9,344 missing values generated)
(9,344 missing values generated)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_in_21.dta
    saved

. 
. ** Append data 
. 
. ** Loop over datasets 
. foreach file in "irs_county_gross_in" "irs_county_gr
> oss_out" "irs_county_flow"{
  2.         
.                 
.         ** Loop over years 
.         forvalues y = 15(1)21 {
  3. 
.                 ** Append 
.                 append using "${data}working/`file'_
> `y'"
  4.                 
.         } // END YEAR LOOP 
  5.         
.         
.         ** Order and sort flow file 
.         if "`file'" == "irs_county_flow" {
  6.                 
.                 ** Loop over orgin and destination s
> tate 
.                 foreach x in "o" "d" {
  7.                         
.                         ** Rename 
.                         rename *_fips_`x' *_fips 
  8.                         
.                         ** Merge with county and sta
> te names 
.                         merge m:1 state_fips county_
> fips using "${data}working/ids",    ///
>                                 keep(match) nogen 
  9.                                 
.                         ** Rename 
.                         rename *_fips *_fips_`x' 
 10.                         rename *_name *_name_`x' 
 11. 
.                         
.                 } // END ORIGIN / DESTINATION LOOP 
 12.                 
.                 ** Order file 
.                 order year state_*_o county_*_o stat
> e_*_d county_*_d  
 13.                 sort year state_*_o county_*_o st
> ate_*_d county_*_d  
 14. 
.         } // END MIGRATION FLOW IF-STATEMENT 
 15.         
.         else {
 16.                 
.                 ** Merge with county and state names
>  
.                 merge m:1 state_fips county_fips usi
> ng "${data}working/ids",    ///
>                                 keep(match) nogen 
 17.                                 
.                 ** Order 
.                 order year state_* county* move_type
 18.                 
.         } 
 19.         
.         ** Save file 
.         save "${data}working/`file'", replace 
 20.         clear 
 21.         
. } // END FILE LOOP 

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           115,567  
    -----------------------------------------
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_in.dta
    saved

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           115,611  
    -----------------------------------------
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_out.dta
    saved

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           384,896  
    -----------------------------------------

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           362,678  
    -----------------------------------------
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_flow.dta saved

. 
. ** Create gross file with in and out migration 
. use "${data}working/irs_county_gross_in", clear 

. 
. ** Rename 
. rename n1 n1_in_

. rename n2 n2_in_

. rename agi agi_in_

. rename *_total *_total_in

. 
. ** Reshape 
. reshape wide n1_in_ n2_in_ agi_in_, i(year state_fip
> s county_fips) j(move_type)
(j = 1 2 3 4 5 6)

Data                               Long   ->   Wide
------------------------------------------------------
> -----------------------
Number of observations          115,567   ->   21,980 
>      
Number of variables                  13   ->   27     
>      
j variable (6 values)         move_type   ->   (droppe
> d)
xij variables:
                                 n1_in_   ->   n1_in_1
>  n1_in_2 ... n1_in_6
                                 n2_in_   ->   n2_in_1
>  n2_in_2 ... n2_in_6
                                agi_in_   ->   agi_in_
> 1 agi_in_2 ... agi_in_6
------------------------------------------------------
> -----------------------

. 
. ** Define locals 
. local txt1 "Non-movers"

. local txt2 "All movers"                 

. local txt3 "Domestic movers"            

. local txt4 "Within-state movers"        

. local txt5 "Inter-state movers" 

. local txt6 "Foreign movers"

. 
. ** Label variables, in loop 
. foreach n of numlist 1(1)6 {
  2.         
.         label var n1_in_`n' "Returns, in-migration, 
> `txt`n''"
  3.         label var n2_in_`n' "Exemptions, in-migra
> tion, `txt`n''"
  4.         label var agi_in_`n' "AGI, in-migration, 
> `txt`n''"
  5. 
. } // END NUMLIST LOOP 

. 
. ** Preserve 
. tempfile gross_in

. save `gross_in'
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000014
    > .tmp saved as .dta format

. clear

. 
. ** Create gross file with in and out migration 
. use "${data}working/irs_county_gross_out", clear 

. 
. ** Rename 
. rename n1 n1_out_

. rename n2 n2_out_

. rename agi agi_out_

. rename *_total *_total_out

. 
. ** Reshape 
. reshape wide n1_out_ n2_out_ agi_out_, i(year state_
> fips county_fips) j(move_type)
(j = 1 2 3 4 5 6)

Data                               Long   ->   Wide
------------------------------------------------------
> -----------------------
Number of observations          115,611   ->   21,980 
>      
Number of variables                  13   ->   27     
>      
j variable (6 values)         move_type   ->   (droppe
> d)
xij variables:
                                n1_out_   ->   n1_out_
> 1 n1_out_2 ... n1_out_6
                                n2_out_   ->   n2_out_
> 1 n2_out_2 ... n2_out_6
                               agi_out_   ->   agi_out
> _1 agi_out_2 ... agi_out_6
------------------------------------------------------
> -----------------------

. 
. ** Define locals 
. local txt1 "Non-movers"

. local txt2 "All movers"                 

. local txt3 "Domestic movers"            

. local txt4 "Within-state movers"        

. local txt5 "Inter-state movers" 

. local txt6 "Foreign movers"

. 
. ** Label variables, in loop 
. foreach n of numlist 1(1)6 {
  2.         
.         label var n1_out_`n' "Returns, out-migration
> , `txt`n''"
  3.         label var n2_out_`n' "Exemptions, out-mig
> ration, `txt`n''"
  4.         label var agi_out_`n' "AGI, out-migration
> , `txt`n''"
  5. 
. } // END NUMLIST LOOP 

. 
. ** Merge data 
. merge 1:1 year state_fips county_fips using `gross_i
> n', keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,980  
    -----------------------------------------

. 
. ** Text for correct matching (non-movers should matc
> h perfectly)
. summ n*_*_1 agi_*_1

    Variable |        Obs        Mean    Std. dev.    
>    Min        Max
-------------+----------------------------------------
> -----------------
    n1_out_1 |     21,979    37461.71    123155.4     
>      0    3944880
    n2_out_1 |     21,979    78000.79    252081.2     
>      0    7841705
     n1_in_1 |     21,979    37461.71    123155.4     
>      0    3944880
     n2_in_1 |     21,979    78000.79    252081.2     
>      0    7841705
   agi_out_1 |     21,979     3214755    1.23e+07     
>  -8051   4.30e+08
-------------+----------------------------------------
> -----------------
    agi_in_1 |     21,979     3214755    1.23e+07     
>  -8051   4.30e+08

. 
. ** Define net migration variables 
. 
. ** Loop over variable
. foreach a in "n1" "n2" "agi" {
  2. 
.         if "`a'" == "n1" local txt "Returns"
  3.         else if "`a'" == "n2" local txt "Exemptio
> ns"
  4.         else if "`a'" == "agi" local txt "AGI"
  5. 
.         ** Loop over type of movers 
.         forvalues n = 2/6 {
  6.                 
.                 ** Clean up missing values 
.                 replace `a'_in_`n' = 0 if missing(`a
> '_in_`n')
  7.                 replace `a'_out_`n' = 0 if missin
> g(`a'_out_`n')
  8. 
.                 ** Generate net 
.                 gen `a'_net_`n' = `a'_in_`n' - `a'_o
> ut_`n'
  9.                 label var `a'_net_`n' "`txt', net
> -migration, `txt`n''"
 10. 
.         } // END MOVER TYPE LOOP 
 11. 
. } // END VARIABLE LOOP 
(183 real changes made)
(155 real changes made)
(183 real changes made)
(155 real changes made)
(202 real changes made)
(172 real changes made)
(1,379 real changes made)
(1,444 real changes made)
(14,365 real changes made)
(14,342 real changes made)
(183 real changes made)
(155 real changes made)
(183 real changes made)
(155 real changes made)
(202 real changes made)
(172 real changes made)
(1,379 real changes made)
(1,444 real changes made)
(14,365 real changes made)
(14,342 real changes made)
(183 real changes made)
(155 real changes made)
(183 real changes made)
(155 real changes made)
(202 real changes made)
(172 real changes made)
(1,379 real changes made)
(1,444 real changes made)
(14,365 real changes made)
(14,342 real changes made)

. 
. ** Generate fips variable
. make_fips state_fips county_fips, gen(fips)
variable fips already defined
r(110);

end of do-file

r(110);

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_00001s
> .tmp"

. /***************************************************
> **************************
> * Program:                      01_clean_data.do 
> * Author(s):            John Iselin 
> * Date Updated:         October 19, 2025
> 
> *** Demographic data via IPUMS NHGIS 
> ** Via https://www.nhgis.org/
> ** Downloaded on October 19, 2025
> ** EXTRACT DETAILS in "nhgis0031_ts_nominal_county_c
> odebook"
> 
> *** Economic data via BEA Regional Economic Accounts
>  (CAINC1)
> ** Via https://apps.bea.gov/regional/downloadzip.htm
> 
> *** ACS individual data via IPUMS USA 
> ** Via https://usa.ipums.org/usa/index.shtml
> ** Downloaded via R program 
> 
> *** IRS SOI County-Level Migration Files
> ** Via https://www.irs.gov/statistics/soi-tax-stats-
> migration-data
> 
> *** IRS SOI County-Level Files
> ** Via https://www.irs.gov/statistics/soi-tax-stats-
> county-data
> 
> *** NYTimes COVID Cases and Deaths 
> ** Via https://github.com/nytimes/covid-19-data
> 
> ****************************************************
> ***************************/
. 
. ** Start log file 
. capture log close log_01

. log using "${logs}01_log_data_clean_${pr_name}_${dat
> e}", replace text name(log_01)
------------------------------------------------------
      name:  log_01
       log:  C:/Users/ji252/Documents/GitHub/multnomah
> -county-tax/code/logs/01_log_data_clean_multnomah_20
> 25-12-15.log
  log type:  text
 opened on:  15 Dec 2025, 18:01:00

. 
. //--------------------------------------------------
. // STEP 0: Preliminary Set-Up 
. //--------------------------------------------------
. 
. ** Define labels 
. label define lb_move_type       0 "ERROR"           
>                     ///
>                                                     
>     1 "Non-movers"                  ///
>                                                     
>     2 "All movers"                  ///
>                                                     
>     3 "Domestic movers"             ///
>                                                     
>     4 "Within-state movers" ///
>                                                     
>     5 "Inter-state movers"  ///
>                                                     
>     6 "Foreign movers", modify

.                                                     
>     
. label define lb_agi             1 "Under $1"        
>             ///
>                                                     
>     2 "$1 under $10K"               ///
>                                                     
>     3 "$10K under $25K"             ///
>                                                     
>     4 "$25K under $50K"             ///
>                                                     
>     5 "$50K under $75K"             ///
>                                                     
>     6 "$75K under $100K"    ///
>                                                     
>     7 "$100K under $200K"   ///
>                                                     
>     8 "$200K or more", modify                       
>                                 

. 
. 
. ** Define Programs
. 
. ** Make FIPS code from state and county fips codes 
. capture program drop make_fips

. program define make_fips
  1.     syntax varlist(min=2 max=2 numeric), GEN(name
> )
  2. 
.     quietly {
  3.         tempvar s c
  4. 
.         local v1 : word 1 of `varlist'
  5.         local v2 : word 2 of `varlist'
  6. 
.         gen `s' = string(`v1', "%02.0f")
  7.         gen `c' = string(`v2', "%03.0f")
  8. 
.         gen `gen' = real(`s' + `c')
  9.     }
 10. end

. 
. ** Reclassify suppressed values as 0 
. 
. capture program drop unsuppress

. program define unsuppress
  1.     syntax varlist
  2. 
.     foreach v of varlist `varlist' {
  3.         replace `v' = 0 if `v' == -1
  4.     }
  5. end

. 
. //--------------------------------------------------
. // STEP -1: Acquire raw data (automated where possib
> le)
. //--------------------------------------------------
. /*
> This block downloads public-use source data directly
>  from official URLs if not present locally.
> 
> Automated downloads included:
>   - IRS SOI county-to-county migration: countyinflow
> YYZZ.csv / countyoutflowYYZZ.csv
>   - IRS SOI county data: YYincyallagi.csv
>   - BEA Regional Economic Accounts (CAINC1): CAINC1.
> zip (unzips to CAINC1__ALL_AREAS_*.csv and related f
> iles)
> 
> */
. 
. * Ensure expected directory structure exists
. capture mkdir "${data}"

. capture mkdir "${data}working"

. capture mkdir "${data}demographic"

. capture mkdir "${data}demographic/CAINC1"

. capture mkdir "${data}demographic/nhgis0031_csv"

. capture mkdir "${data}irs"

. capture mkdir "${data}covid"

. 
. * ----------------------------
. * IRS SOI: migration files
. * ----------------------------
. local irs_base "https://www.irs.gov/pub/irs-soi"

. 
. forvalues yy = 15/21 {
  2.     local zz = `yy' + 1
  3.     local fn_out "countyoutflow`yy'`zz'.csv"
  4.     local fn_in  "countyinflow`yy'`zz'.csv"
  5. 
.     capture confirm file "${data}irs/`fn_out'"
  6.     if _rc {
  7.         di as txt "Downloading (IRS SOI) `fn_out'
>  ..."
  8.         copy "`irs_base'/`fn_out'" "${data}irs/`f
> n_out'", replace
  9.     }
 10. 
.     capture confirm file "${data}irs/`fn_in'"
 11.     if _rc {
 12.         di as txt "Downloading (IRS SOI) `fn_in' 
> ..."
 13.         copy "`irs_base'/`fn_in'" "${data}irs/`fn
> _in'", replace
 14.     }
 15. }

. 
. * ----------------------------
. * IRS SOI: county income (AGI) files
. * ----------------------------
. forvalues yy = 15/22 {
  2.     local fn_inc "`yy'incyallagi.csv"
  3. 
.     capture confirm file "${data}irs/`fn_inc'"
  4.     if _rc {
  5.         di as txt "Downloading (IRS SOI) `fn_inc'
>  ..."
  6.         copy "`irs_base'/`fn_inc'" "${data}irs/`f
> n_inc'", replace
  7.     }
  8. }

. 
. * ----------------------------
. * BEA Regional: CAINC1.zip
. * ----------------------------
. local bea_dir "${data}demographic/CAINC1"

. local bea_url "https://apps.bea.gov/regional/zip/CAI
> NC1.zip"

. local bea_zip "`bea_dir'/CAINC1.zip"

. 
. * If we don't already have a CAINC1 "_ALL_AREAS" fil
> e, download + unzip the ZIP.
. local bea_files : dir "`bea_dir'" files "CAINC1__ALL
> _AREAS_*.csv"

. if "`bea_files'"=="" {
.     local bea_files : dir "`bea_dir'" files "CAINC1_
> _ALL_STATES_*.csv"
. }

. 
. if "`bea_files'"=="" {
.     di as txt "Downloading (BEA) CAINC1.zip ..."
Downloading (BEA) CAINC1.zip ...
.     copy "`bea_url'" "`bea_zip'", replace
(file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/demographic/CAINC1/CAINC1.zip not
    found)
. 
.     local curdir "`c(pwd)'"
.     cd "`bea_dir'"
C:\Users\ji252\Documents\GitHub\multnomah-county-tax\d
> ata\demographic\CAINC1
.     unzipfile "CAINC1.zip", replace
    inflating: CAINC1__ALL_AREAS_1969_2023.csv
    inflating: CAINC1__definition.xml
    inflating: CAINC1__Footnotes.html
    inflating: CAINC1_AK_1969_2023.csv
    inflating: CAINC1_AL_1969_2023.csv
    inflating: CAINC1_AR_1969_2023.csv
    inflating: CAINC1_AZ_1969_2023.csv
    inflating: CAINC1_CA_1969_2023.csv
    inflating: CAINC1_CO_1969_2023.csv
    inflating: CAINC1_CSA_1969_2023.csv
    inflating: CAINC1_CT_1969_2023.csv
    inflating: CAINC1_DC_1969_2023.csv
    inflating: CAINC1_DE_1969_2023.csv
    inflating: CAINC1_FL_1969_2023.csv
    inflating: CAINC1_GA_1969_2023.csv
    inflating: CAINC1_HI_1969_2023.csv
    inflating: CAINC1_IA_1969_2023.csv
    inflating: CAINC1_ID_1969_2023.csv
    inflating: CAINC1_IL_1969_2023.csv
    inflating: CAINC1_IN_1969_2023.csv
    inflating: CAINC1_KS_1969_2023.csv
    inflating: CAINC1_KY_1969_2023.csv
    inflating: CAINC1_LA_1969_2023.csv
    inflating: CAINC1_MA_1969_2023.csv
    inflating: CAINC1_MD_1969_2023.csv
    inflating: CAINC1_MDIV_1969_2023.csv
    inflating: CAINC1_ME_1969_2023.csv
    inflating: CAINC1_MI_1969_2023.csv
    inflating: CAINC1_MIC_1969_2023.csv
    inflating: CAINC1_MN_1969_2023.csv
    inflating: CAINC1_MO_1969_2023.csv
    inflating: CAINC1_MS_1969_2023.csv
    inflating: CAINC1_MSA_1969_2023.csv
    inflating: CAINC1_MT_1969_2023.csv
    inflating: CAINC1_NC_1969_2023.csv
    inflating: CAINC1_ND_1969_2023.csv
    inflating: CAINC1_NE_1969_2023.csv
    inflating: CAINC1_NH_1969_2023.csv
    inflating: CAINC1_NJ_1969_2023.csv
    inflating: CAINC1_NM_1969_2023.csv
    inflating: CAINC1_NV_1969_2023.csv
    inflating: CAINC1_NY_1969_2023.csv
    inflating: CAINC1_OH_1969_2023.csv
    inflating: CAINC1_OK_1969_2023.csv
    inflating: CAINC1_OR_1969_2023.csv
    inflating: CAINC1_PA_1969_2023.csv
    inflating: CAINC1_PORT_1969_2023.csv
    inflating: CAINC1_RI_1969_2023.csv
    inflating: CAINC1_SC_1969_2023.csv
    inflating: CAINC1_SD_1969_2023.csv
    inflating: CAINC1_TN_1969_2023.csv
    inflating: CAINC1_TX_1969_2023.csv
    inflating: CAINC1_US_1969_2023.csv
    inflating: CAINC1_UT_1969_2023.csv
    inflating: CAINC1_VA_1969_2023.csv
    inflating: CAINC1_VT_1969_2023.csv
    inflating: CAINC1_WA_1969_2023.csv
    inflating: CAINC1_WI_1969_2023.csv
    inflating: CAINC1_WV_1969_2023.csv
    inflating: CAINC1_WY_1969_2023.csv

successfully unzipped CAINC1.zip to current directory
total processed:  60
        skipped:  0
      extracted:  60
.     cd "`curdir'"
C:\Users\ji252\Documents\GitHub\multnomah-county-tax
. 
.     capture erase "`bea_zip'"
. }

. 
. * ----------------------------
. * NYTimes COVID Data 
. * ----------------------------
. local covid_dir "${data}covid"

. local covid_url "https://raw.githubusercontent.com/n
> ytimes/covid-19-data/master/us-counties.csv"

. 
. * If we don't already have a COVID file, download.
. local covid_file : dir "`covid_dir'" files "covid_ny
> t.csv"

. if "`covid_file'"=="" {
.     local covid_file : dir "`covid_dir'" files "covi
> d_nyt.csv"
. }

. 
. if "`covid_file'"=="" {
.     di as txt "Downloading (COVID)  ..."
Downloading (COVID)  ...
.     copy "`covid_url'" "`covid_dir'/covid_nyt.csv", 
> replace
. }

. 
. 
. 
. //--------------------------------------------------
> ---------
. // STEP 1: Import and Clean Demographic Data via IPU
> MS + BEA  
. //--------------------------------------------------
> ---------
. 
. ** Import data 
. import delimited        ///
>         "${data}demographic/nhgis0031_csv/nhgis0031_
> ts_nominal_county.csv", clear 
(encoding automatically selected: ISO-8859-1)
(15 vars, 54,673 obs)

. 
. ** Describe data 
. des 

Contains data
 Observations:        54,673                  
    Variables:            15                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
gisjoin         str8    %9s                   GISJOIN
year            str9    %9s                   YEAR
state           str20   %20s                  STATE
statefp         byte    %8.0g                 STATEFP
statenh         int     %8.0g                 STATENH
county          str46   %46s                  COUNTY
countyfp        int     %8.0g                 COUNTYFP
countynh        int     %8.0g                 COUNTYNH
name            str59   %59s                  NAME
av0aa           long    %12.0g                AV0AA
d15aa           long    %12.0g                D15AA
d15ab           long    %12.0g                D15AB
b79aa           long    %12.0g                B79AA
av0aam          long    %12.0g                AV0AAM
b79aam          long    %8.0g                 B79AAM
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.

. 
. ** Drop unnecc variables 
. drop gisjoin statenh countynh name 

. 
. ** Rename 
. rename state state_name 

. rename statefp state_fips 

. rename county county_name 

. rename countyfp county_fips 

. rename av0aa population 

. rename d15aa pop_urban 

. rename d15ab pop_rural 

. rename b79aa median_income 

. rename av0aam population_margin

. rename b79aam median_income_margin 

. 
. ** Create urban percent 
. gen percent_urban = pop_urban / population
(45,090 missing values generated)

. 
. ** Label variables 
. label var state_name "State name"

. label var state_fips "State FIPS code"

. label var county_name "County name"

. label var county_fips "County FIPS code"

. label var population "Population count"

. label var pop_rural "Rural population count"

. label var pop_urban "Urban population count"

. label var percent_urban "Percent of population in ur
> ban areas"

. label var median_income "Median household income (pr
> ior year)"

. label var population_margin "ACS margin for error: p
> opulation"

. label var median_income_margin "ACS margin for error
> : median income"

. 
. ** Save as temporary file 
. tempfile demo

. save `demo'
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000001
    > .tmp saved as .dta format

. 
. ** Create three datasets 
. 
. ** (1) Basic state and county IDs 
. keep if year == "2020" 
(51,452 observations deleted)

. keep state* county* 

. 
. ** Make FIPS 
. make_fips state_fips county_fips, gen(fips)

. 
. ** Save as state and county Ids 
. save "${data}working/ids", replace 
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/ids.dta saved

. clear  

. 
. ** (2) Population data 
. use `demo'

. keep if !missing(pop_urban) 
(45,090 observations deleted)

. tab year 

       YEAR |      Freq.     Percent        Cum.
------------+-----------------------------------
       2000 |      3,141       32.78       32.78
       2010 |      3,221       33.61       66.39
       2020 |      3,221       33.61      100.00
------------+-----------------------------------
      Total |      9,583      100.00

. 
. ** Keep 2020 
. keep if year == "2020"
(6,362 observations deleted)

. drop year median_income* population_margin

. 
. ** Make FIPS 
. make_fips state_fips county_fips, gen(fips)

. 
. ** Save data
. save "${data}working/population_2020", replace 
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/population_2020.dta saved

. clear  

. 
. ** (3) 2015-2019 ACS data 
. use `demo'

. keep if !missing(median_income) 
(6,447 observations deleted)

. tab year 

       YEAR |      Freq.     Percent        Cum.
------------+-----------------------------------
       2000 |      3,141        6.51        6.51
  2006-2010 |      3,221        6.68       13.19
  2007-2011 |      3,221        6.68       19.87
  2008-2012 |      3,221        6.68       26.55
  2009-2013 |      3,221        6.68       33.23
  2010-2014 |      3,220        6.68       39.91
  2011-2015 |      3,219        6.67       46.58
  2012-2016 |      3,220        6.68       53.26
  2013-2017 |      3,220        6.68       59.93
  2014-2018 |      3,219        6.67       66.61
  2015-2019 |      3,220        6.68       73.29
  2016-2020 |      3,220        6.68       79.96
  2017-2021 |      3,220        6.68       86.64
  2018-2022 |      3,221        6.68       93.32
  2019-2023 |      3,222        6.68      100.00
------------+-----------------------------------
      Total |     48,226      100.00

. 
. ** Keep 2020 
. keep if year == "2015-2019"
(45,006 observations deleted)

. drop year pop_rural pop_urban percent_urban

. 
. ** Make FIPS 
. make_fips state_fips county_fips, gen(fips)

. 
. ** Save data
. save "${data}working/acs_2015_2019_data", replace 
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/acs_2015_2019_data.dta saved

. 
. ** Rename for merge 
. rename population population_acs

. 
. ** Merge with other data 
. merge 1:1 state_fips county_fips using "${data}worki
> ng/population_2020",                ///
>         keep(match) nogen 

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                             3,219  
    -----------------------------------------

. 
. ** Save data
. save "${data}working/demographics_2020", replace 
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/demographics_2020.dta saved

. 
. ** Load BEA Data 
. import delimited "${data}demographic/CAINC1/CAINC1__
> ALL_AREAS_1969_2023.csv",   ///
>         clear 
(encoding automatically selected: ISO-8859-1)
(63 vars, 9,604 obs)

. 
. ** Drop unnecc variables 
. drop region tablename industryclassification unit ge
> oname 

. 
. ** Drop empty cells 
. drop if missing(linecode)
(4 observations deleted)

. 
. ** Update names 
. rename geofips fips 

. replace fips = subinstr(fips, `"""', "", .)
(9,600 real changes made)

. destring fips, replace 
fips: all characters numeric; replaced as long

. 
. ** Keep population and per-capita income, dropping p
> ersonal income (total)
. tab description linecode

                      |  LineCode
          Description |         1 |     Total
----------------------+-----------+----------
Per capita personal.. |         0 |     3,200 
Personal income (th.. |     3,200 |     3,200 
Population (persons.. |         0 |     3,200 
----------------------+-----------+----------
                Total |     3,200 |     9,600 


                      |  LineCode
          Description |         2 |     Total
----------------------+-----------+----------
Per capita personal.. |         0 |     3,200 
Personal income (th.. |         0 |     3,200 
Population (persons.. |     3,200 |     3,200 
----------------------+-----------+----------
                Total |     3,200 |     9,600 


                      |  LineCode
          Description |         3 |     Total
----------------------+-----------+----------
Per capita personal.. |     3,200 |     3,200 
Personal income (th.. |         0 |     3,200 
Population (persons.. |         0 |     3,200 
----------------------+-----------+----------
                Total |     3,200 |     9,600 

. drop if linecode == 1   
(3,200 observations deleted)

. drop description

.         
. ** Get V* to be in terms of years 
. ** V9 == 1969 
. forvalues i = 9/63 {
  2.         
.         local j = 1960 + `i'
  3.         rename v`i' value`j'
  4.         
. } // END I LOOP 

. 
. ** Reshape 
. reshape long value, i(fips linecode) j(year)
(j = 1969 1970 1971 1972 1973 1974 1975 1976 1977 1978
>  1979 1980 1981 1982 1983 1984 1985 1986 1987 1988 1
> 989 1990 1991 1992 1993 1994 1995 1996 1997 1998 199
> 9 2000 2001 2002 2003 2004 2005 2006 2007 2008 2009 
> 2010 2011 2012 2013 2014 2015 2016 2017 2018 2019 20
> 20 2021 2022 2023)

Data                               Wide   ->   Long
------------------------------------------------------
> -----------------------
Number of observations            6,400   ->   352,000
>      
Number of variables                  57   ->   4      
>      
j variable (55 values)                    ->   year
xij variables:
      value1969 value1970 ... value2023   ->   value
------------------------------------------------------
> -----------------------

. reshape wide value, i(fips year ) j(linecode)
(j = 2 3)

Data                               Long   ->   Wide
------------------------------------------------------
> -----------------------
Number of observations          352,000   ->   176,000
>      
Number of variables                   4   ->   4      
>      
j variable (2 values)          linecode   ->   (droppe
> d)
xij variables:
                                  value   ->   value2 
> value3
------------------------------------------------------
> -----------------------

. 
. ** Keep years 
. keep if inrange(year, 2015, 2023)
(147,200 observations deleted)

. 
. ** Rename values 
. rename value2 population 

. rename value3 per_capita_income

. 
. ** Drop if missing values 
. drop if population == "(NA)"
(239 observations deleted)

. 
. ** Keep only counties with all observations 
. bysort fips: gen ct = _N 

. tab ct

         ct |      Freq.     Percent        Cum.
------------+-----------------------------------
          4 |          8        0.03        0.03
          5 |          5        0.02        0.05
          9 |     28,548       99.95      100.00
------------+-----------------------------------
      Total |     28,561      100.00

. keep if ct == 9
(13 observations deleted)

. drop ct

. 
. ** Destring 
. destring population, replace 
population: all characters numeric; replaced as long

. destring per_capita_income, replace 
per_capita_income: all characters numeric; replaced as
>  long

. 
. ** Save data
. save "${data}working/bea_economics", replace 
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/bea_economics.dta saved

. 
. //--------------------------------------------------
> --
. // STEP 2: Import and Clean NYTimes COVID-19 Data 
. //--------------------------------------------------
> --
.  
. ** Import data 
. import delimited using "${data}covid/covid_nyt.csv",
>  varnames(1) clear case(lower) 
(encoding automatically selected: ISO-8859-1)
(6 vars, 2,502,832 obs)

. 
. ** Describe data 
. des 

Contains data
 Observations:     2,502,832                  
    Variables:             6                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
date            str10   %10s                  
county          str35   %35s                  
state           str24   %24s                  
fips            long    %12.0g                
cases           long    %12.0g                
deaths          long    %8.0g                 
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.

. 
. ** Set up date information 
. generate num_date = date(date, "YMD")

. format num_date %td

. drop date 

. 
. ** Rename 
. rename state state_name 

. rename county county_name 

. rename num_date date 

. 
. ** keep only counties 
. keep if !missing(fips)
(23,678 observations deleted)

. 
. ** Keep in 50 states 
. drop if state_name == "Puerto Rico"
(57,605 observations deleted)

. drop if state_name == "Virgin Islands"
(2,304 observations deleted)

. drop if state_name == "Northern Mariana Islands"
(1,452 observations deleted)

. 
. ** Sort 
. sort date fips 

. 
. ** Create panel 
. xtset fips date

Panel variable: fips (unbalanced)
 Time variable: date, 21jan2020 to 13may2022, but
                with gaps
         Delta: 1 day

. 
. ** Fill in panel 
. tsfill, full 

. 
. ** Fill in missing values 
. replace cases = 0 if missing(cases)
(228,991 real changes made)

. replace deaths = 0 if missing(deaths)
(228,991 real changes made)

. 
. ** Preserve data 
. preserve 

. 
. ** Preserve fips codes and names 
. keep if !missing(state_name)
(228,991 observations deleted)

. keep if !missing(county_name)
(0 observations deleted)

. duplicates drop fips state_name county_name, force 

Duplicates in terms of fips state_name county_name

(2,414,657 observations deleted)

. 
. ** Save as temporary data 
. tempfile state_county_names 

. save `state_county_names'
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000003
    > .tmp saved as .dta format

. clear 

. 
. ** Restore 
. restore 

. 
. ** Drop and merge in names 
. drop state_name county_name

. merge m:1 fips using `state_county_names', keep(mast
> er match) nogen 

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                         2,646,784  
    -----------------------------------------

. 
. ** Get year, month, day 
. gen year = year(date)

. gen month = month(date)

. gen day = day(date)

. 
. ** Order data 
. order date year month day fips state county cases de
> aths 

. 
. ** Calculate cumulative cases and deaths 
. bysort fips (date): gen cases_cum = sum(cases)

. bysort fips (date): gen deaths_cum = sum(deaths)

. 
. ** Merge population data (2020)
. merge m:1 fips using "${data}working/population_2020
> ", keep(match) nogen  
(variable county_name was str35, now str46 to
       accommodate using data's values)
(variable fips was long, now double to accommodate
       using data's values)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                         2,643,408  
    -----------------------------------------

. 
. ** Save file 
. save ${data}working/covid_cleaned.dta, replace 
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/covid_cleaned.dta saved

. 
. ** Generate Clustering Variables 
. 
. ** Keep one observation per month 
. keep year month fips state_name county_name cases_cu
> m deaths_cum population

. collapse (sum) cases deaths population, by(year mont
> h fips state_name county_name) 

. sort year month fips 

. egen date = group(year month)

. drop year month 

. 
. ** Generate per capita figures
. replace cases = 1000 * cases / population
(82,955 real changes made)

. replace deaths = 1000 * deaths / population
(74,723 real changes made)

. drop population 

. 
. ** Reshape wide 
. reshape wide cases deaths, i(fips state_name county_
> name) j(date)
(j = 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 2
> 0 21 22 23 24 25 26 27 28 29)

Data                               Long   ->   Wide
------------------------------------------------------
> -----------------------
Number of observations           90,828   ->   3,132  
>      
Number of variables                   6   ->   61     
>      
j variable (29 values)             date   ->   (droppe
> d)
xij variables:
                              cases_cum   ->   cases_c
> um1 cases_cum2 ... cases_cum29
                             deaths_cum   ->   deaths_
> cum1 deaths_cum2 ... deaths_cum29
------------------------------------------------------
> -----------------------

. 
. ** Save file 
. save ${data}working/covid_cleaned_wide.dta, replace 
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/covid_cleaned_wide.dta saved

. clear

. 
. //--------------------------------------------------
> --
. // STEP 3: Import and Clean ACS Micro Data via IPUMS
>  
. //--------------------------------------------------
> --
. 
. ** Load data 
. forvalues y = 2015(1)2023 {
  2.         
.         ** Import CSV
.         import delimited using "${data}acs/acs_`y'",
>  varnames(1) clear case(lower)
  3.         
.         ** Save as temporary data 
.         tempfile acs_`y'
  4.         save `acs_`y''
  5.         clear 
  6.         
. } // END YEAR LOOP 
(encoding automatically selected: ISO-8859-1)
(57 vars, 2,997,503 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000004
    > .tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(57 vars, 3,007,847 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000005
    > .tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(57 vars, 3,038,696 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000006
    > .tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(57 vars, 3,060,442 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000007
    > .tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(57 vars, 3,087,291 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000008
    > .tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(57 vars, 2,454,160 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000009
    > .tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(57 vars, 3,092,079 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000a
    > .tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(55 vars, 3,190,848 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000b
    > .tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(55 vars, 3,228,659 obs)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000c
    > .tmp saved as .dta format

. 
. ** Append data 
. forvalues y = 2015(1)2023 {
  2.         
.         append using `acs_`y''  
  3.         
. } // END YEAR LOOP 
(variable cbserial was long, now double to
       accommodate using data's values)

. 
. ** Des 
. tab year 

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       2015 |  2,997,503       11.04       11.04
       2016 |  3,007,847       11.08       22.11
       2017 |  3,038,696       11.19       33.30
       2018 |  3,060,442       11.27       44.57
       2019 |  3,087,291       11.37       55.94
       2020 |  2,454,160        9.04       64.98
       2021 |  3,092,079       11.39       76.36
       2022 |  3,190,848       11.75       88.11
       2023 |  3,228,659       11.89      100.00
------------+-----------------------------------
      Total | 27,157,525      100.00

. 
. ** Define # of adults and kids in HHs 
. gen adult = age >= 18 

. gen child = age < 18 

. bysort year serial: gen hh_size = _N 

. bysort year serial: egen hh_adult_ct = total(adult)

. bysort year serial: egen hh_child_ct = total(child)

. 
. ** Sample 18+
. drop if child == 1 
(5,629,869 observations deleted)

. drop child adult 

. 
. ** Sample not living abroad last year 
. drop if migplac1 > 56 
(108,862 observations deleted)

. drop if migrate1 == 4 
(0 observations deleted)

. 
. ** Rename variables 
. rename statefip state_fips_d

. rename countyfip county_fips_d 

. 
. ** Set up origin data 
. fre migrate1

migrate1
------------------------------------------------------
> -----
              |      Freq.    Percent      Valid      
>  Cum.
--------------+---------------------------------------
> -----
Valid   1     |   1.92e+07      89.51      89.51      
> 89.51
        2     |    1809920       8.45       8.45      
> 97.96
        3     |     436745       2.04       2.04     1
> 00.00
        Total |   2.14e+07     100.00     100.00      
>      
------------------------------------------------------
> -----

. drop migrate1d

. tab migplac1

   migplac1 |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 | 19,172,129       89.51       89.51
          1 |     31,329        0.15       89.66
          2 |      5,825        0.03       89.68
          4 |     54,912        0.26       89.94
          5 |     21,714        0.10       90.04
          6 |    260,673        1.22       91.26
          8 |     52,539        0.25       91.50
          9 |     21,577        0.10       91.61
         10 |      5,369        0.03       91.63
         11 |      8,664        0.04       91.67
         12 |    152,989        0.71       92.38
         13 |     71,263        0.33       92.72
         15 |      9,845        0.05       92.76
         16 |     13,536        0.06       92.83
         17 |     86,306        0.40       93.23
         18 |     47,941        0.22       93.45
         19 |     21,469        0.10       93.55
         20 |     22,338        0.10       93.66
         21 |     31,888        0.15       93.81
         22 |     28,776        0.13       93.94
         23 |      7,911        0.04       93.98
         24 |     40,223        0.19       94.17
         25 |     48,684        0.23       94.39
         26 |     65,444        0.31       94.70
         27 |     35,177        0.16       94.86
         28 |     16,994        0.08       94.94
         29 |     45,200        0.21       95.15
         30 |      7,453        0.03       95.19
         31 |     13,567        0.06       95.25
         32 |     24,785        0.12       95.37
         33 |      8,787        0.04       95.41
         34 |     50,561        0.24       95.64
         35 |     12,299        0.06       95.70
         36 |    118,674        0.55       96.26
         37 |     70,555        0.33       96.59
         38 |      5,884        0.03       96.61
         39 |     81,541        0.38       96.99
         40 |     28,921        0.14       97.13
         41 |     36,246        0.17       97.30
         42 |     76,201        0.36       97.65
         44 |      6,551        0.03       97.68
         45 |     33,552        0.16       97.84
         46 |      6,067        0.03       97.87
         47 |     48,061        0.22       98.09
         48 |    197,912        0.92       99.02
         49 |     25,798        0.12       99.14
         50 |      4,106        0.02       99.16
         51 |     64,560        0.30       99.46
         53 |     64,790        0.30       99.76
         54 |     10,532        0.05       99.81
         55 |     35,653        0.17       99.98
         56 |      5,023        0.02      100.00
------------+-----------------------------------
      Total | 21,418,794      100.00

. rename migplac1 state_fips_o

. tab migcounty1

 migcounty1 |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 | 19,952,847       93.16       93.16
          1 |     35,752        0.17       93.32
          3 |     58,525        0.27       93.60
          5 |     21,286        0.10       93.70
          7 |     13,720        0.06       93.76
          9 |     11,958        0.06       93.82
         11 |     23,663        0.11       93.93
         13 |     53,927        0.25       94.18
         15 |      7,126        0.03       94.21
         17 |     21,840        0.10       94.31
         19 |     24,348        0.11       94.43
         20 |      2,061        0.01       94.44
         21 |     12,848        0.06       94.50
         23 |      7,725        0.04       94.53
         25 |     21,090        0.10       94.63
         27 |     15,274        0.07       94.70
         29 |     32,454        0.15       94.85
         31 |     57,529        0.27       95.12
         33 |     33,851        0.16       95.28
         35 |     24,912        0.12       95.40
         37 |     72,280        0.34       95.73
         39 |     10,381        0.05       95.78
         41 |      8,696        0.04       95.82
         43 |      8,893        0.04       95.86
         45 |      5,998        0.03       95.89
         47 |     22,821        0.11       96.00
         49 |     21,522        0.10       96.10
         51 |     17,488        0.08       96.18
         53 |     17,759        0.08       96.26
         55 |     12,676        0.06       96.32
         57 |     18,309        0.09       96.41
         59 |     30,944        0.14       96.55
         61 |     31,725        0.15       96.70
         63 |     12,421        0.06       96.76
         65 |     18,670        0.09       96.85
         67 |     29,982        0.14       96.99
         69 |      4,036        0.02       97.01
         71 |     27,649        0.13       97.13
         73 |     36,959        0.17       97.31
         75 |     11,968        0.06       97.36
         77 |      8,293        0.04       97.40
         79 |      7,681        0.04       97.44
         81 |     30,275        0.14       97.58
         83 |      9,053        0.04       97.62
         85 |     28,918        0.14       97.76
         87 |      6,680        0.03       97.79
         89 |     10,158        0.05       97.83
         91 |     15,565        0.07       97.91
         93 |      4,960        0.02       97.93
         95 |     19,883        0.09       98.02
         97 |     19,460        0.09       98.11
         99 |     19,554        0.09       98.21
        101 |     14,457        0.07       98.27
        103 |     18,351        0.09       98.36
        105 |      7,421        0.03       98.39
        107 |      5,600        0.03       98.42
        109 |     10,761        0.05       98.47
        111 |     14,844        0.07       98.54
        113 |     30,918        0.14       98.68
        115 |      4,818        0.02       98.71
        117 |      7,798        0.04       98.74
        119 |     14,739        0.07       98.81
        121 |     10,181        0.05       98.86
        123 |      3,671        0.02       98.88
        125 |      9,036        0.04       98.92
        127 |      2,348        0.01       98.93
        129 |      1,814        0.01       98.94
        133 |      5,313        0.02       98.96
        135 |      7,844        0.04       99.00
        139 |      5,952        0.03       99.03
        141 |      6,936        0.03       99.06
        143 |      4,286        0.02       99.08
        145 |      1,975        0.01       99.09
        147 |      2,327        0.01       99.10
        149 |      2,146        0.01       99.11
        151 |      1,900        0.01       99.12
        153 |      5,155        0.02       99.14
        157 |     11,532        0.05       99.20
        159 |        751        0.00       99.20
        160 |        149        0.00       99.20
        161 |      4,716        0.02       99.22
        163 |     13,817        0.06       99.29
        165 |      2,418        0.01       99.30
        167 |      5,023        0.02       99.32
        169 |        850        0.00       99.33
        171 |        529        0.00       99.33
        173 |        264        0.00       99.33
        179 |      1,879        0.01       99.34
        183 |     11,521        0.05       99.39
        185 |        871        0.00       99.40
        187 |      2,303        0.01       99.41
        189 |      6,599        0.03       99.44
        191 |        759        0.00       99.44
        197 |      3,401        0.02       99.46
        201 |     29,158        0.14       99.59
        209 |      2,664        0.01       99.60
        215 |      3,046        0.01       99.62
        223 |        758        0.00       99.62
        227 |        946        0.00       99.63
        245 |      3,068        0.01       99.64
        251 |      1,020        0.00       99.65
        257 |        850        0.00       99.65
        303 |      3,247        0.02       99.67
        309 |      2,351        0.01       99.68
        313 |        456        0.00       99.68
        329 |      1,177        0.01       99.68
        339 |      3,176        0.01       99.70
        355 |      2,646        0.01       99.71
        367 |        977        0.00       99.72
        375 |      1,001        0.00       99.72
        381 |      1,199        0.01       99.73
        423 |      1,497        0.01       99.73
        439 |     14,652        0.07       99.80
        441 |      1,419        0.01       99.81
        451 |        952        0.00       99.81
        453 |     12,549        0.06       99.87
        479 |      1,301        0.01       99.88
        485 |      1,288        0.01       99.88
        491 |      4,036        0.02       99.90
        510 |     10,140        0.05       99.95
        550 |      1,187        0.01       99.95
        650 |      1,031        0.00       99.96
        700 |      1,438        0.01       99.97
        710 |        466        0.00       99.97
        760 |      2,799        0.01       99.98
        810 |      3,933        0.02      100.00
------------+-----------------------------------
      Total | 21,418,794      100.00

. rename migcounty1 county_fips_o

. 
. ** Use migrate1 to update values 
. 
. ** Within same house 
. replace state_fips_o = state_fips_d if migrate1 == 1
(19,172,129 real changes made)

. replace county_fips_o = county_fips_d if migrate1 ==
>  1 
(11,640,515 real changes made)

. 
. ** Within same state 
. replace state_fips_o = state_fips_d if migrate1 == 2
(0 real changes made)

. 
. ** Generate county IDS 
. foreach x in "o" "d" {
  2.         
.         make_fips state_fips_`x' county_fips_`x', ge
> n(fips_`x')
  3. 
. }

. 
. ** Check for within-state migration 
. gen same_county = fips_o == fips_d 

. tab year same_county

           |      same_county
      year |         0          1 |     Total
-----------+----------------------+----------
      2015 |    89,492  2,245,481 | 2,334,973 
      2016 |    91,109  2,255,901 | 2,347,010 
      2017 |    93,553  2,278,348 | 2,371,901 
      2018 |    96,080  2,306,022 | 2,402,102 
      2019 |    96,088  2,344,171 | 2,440,259 
      2020 |    71,827  1,877,155 | 1,948,982 
      2021 |    97,600  2,361,518 | 2,459,118 
      2022 |   106,231  2,430,426 | 2,536,657 
      2023 |    98,226  2,479,566 | 2,577,792 
-----------+----------------------+----------
     Total |   840,206 20,578,588 |21,418,794 

. tab year same_county if migrate1 == 2

           |      same_county
      year |         0          1 |     Total
-----------+----------------------+----------
      2015 |    42,597    172,956 |   215,553 
      2016 |    43,823    172,091 |   215,914 
      2017 |    45,058    174,386 |   219,444 
      2018 |    46,477    173,182 |   219,659 
      2019 |    46,329    168,101 |   214,430 
      2020 |    34,625    119,307 |   153,932 
      2021 |    46,470    148,925 |   195,395 
      2022 |    50,584    141,717 |   192,301 
      2023 |    47,498    135,794 |   183,292 
-----------+----------------------+----------
     Total |   403,461  1,406,459 | 1,809,920 

. 
. ** Tag HH head 
. gen byte hh_head = (relate == 1)

. 
. ** Compress file 
. compress 
  variable state_fips_o was int now byte
  variable hh_size was float now byte
  variable hh_adult_ct was float now byte
  variable hh_child_ct was float now byte
  variable same_county was float now byte
  (278,444,322 bytes saved)

. 
. ** Save 
. save "${data}working/acs_migration_file", replace 
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/acs_migration_file.dta saved

. 
. // Keep only observations with valid origin/destinat
> ion counties and YEAR
. drop if missing(year) | missing(fips_o) | missing(fi
> ps_d)
(0 observations deleted)

. 
. // Clean income (treat missing as 0; keep negative v
> alues as reported)
. replace inctot = 0 if missing(inctot)
(0 real changes made)

. gen double income_wt = inctot * perwt

. label var income_wt "Person income (INCTOT) weighted
>  by PERWT"

. 
. // --- Persons + income totals by origin/destination
> /year
. preserve

. keep year fips_o fips_d perwt income_wt

. collapse (sum) persons=perwt income_total=income_wt,
>  by(year fips_o fips_d)

. tempfile acs_pi

. save `acs_pi'
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000e
    > .tmp saved as .dta format

. restore

. 
. // --- Households by origin/destination/year
. // Use HHWT among household heads (RELATE==1) if ava
> ilable; else PERNUM==1 fallback.
. 
. preserve

. keep if hh_head
(10,269,992 observations deleted)

. keep year fips_o fips_d hhwt

. collapse (sum) households=hhwt, by(year fips_o fips_
> d)

. tempfile acs_hh

. save `acs_hh'
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000g
    > .tmp saved as .dta format

. restore

. 
. // --- Merge persons/income with households
. use `acs_pi', clear

. merge 1:1 year fips_o fips_d using `acs_hh', nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                        45,163
        from master                    45,163  
        from using                          0  

    Matched                           162,899  
    -----------------------------------------

. 
. label var persons "Estimated number of persons (sum 
> PERWT)"

. label var households "Estimated number of households
>  (sum HHWT among heads)"

. label var income_total "Estimated total personal inc
> ome (sum INCTOT*PERWT)"

. 
. // --- Derive state/county components for merges wit
> h name crosswalk
. gen int state_fips_o  = floor(fips_o/1000)

. gen int county_fips_o = mod(fips_o,1000)

. gen int state_fips_d  = floor(fips_d/1000)

. gen int county_fips_d = mod(fips_d,1000)

. 
. label var state_fips_o "State FIPS (origin)"

. label var county_fips_o "County FIPS (origin)"

. label var state_fips_d "State FIPS (destination)"

. label var county_fips_d "County FIPS (destination)"

. 
. // --- Merge in names (from NHGIS IDs snapshot)
. preserve

. use "${data}working/ids", clear

. rename (state_fips county_fips state_name county_nam
> e) (state_fips_o county_fips_o state_name_o county_n
> ame_o)

. tempfile ids_o

. save `ids_o'
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000i
    > .tmp saved as .dta format

. keep state_fips_o state_name_o 

. duplicates drop 

Duplicates in terms of all variables

(3,169 observations deleted)

. tempfile state_ids_o

. save `state_ids_o'
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000j
    > .tmp saved as .dta format

. restore

. merge m:1 state_fips_o county_fips_o using `ids_o', 
> keep(master match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                        46,997
        from master                    46,997  
        from using                          0  

    Matched                           161,065  
    -----------------------------------------

. drop state_name_o 

. merge m:1 state_fips_o using `state_ids_o', keep(mas
> ter match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           208,062  
    -----------------------------------------

. 
. preserve

. use "${data}working/ids", clear

. rename (state_fips county_fips state_name county_nam
> e) (state_fips_d county_fips_d state_name_d county_n
> ame_d)

. tempfile ids_d

. save `ids_d'
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000l
    > .tmp saved as .dta format

. keep state_fips_d state_name_d 

. duplicates drop 

Duplicates in terms of all variables

(3,169 observations deleted)

. tempfile state_ids_d

. save `state_ids_d'
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000m
    > .tmp saved as .dta format

. restore

. 
. merge m:1 state_fips_d county_fips_d using `ids_d', 
> keep(master match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                        50,197
        from master                    50,197  
        from using                          0  

    Matched                           157,865  
    -----------------------------------------

. drop state_name_d

. merge m:1 state_fips_d using `state_ids_d', keep(mas
> ter match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           208,062  
    -----------------------------------------

. order year ///
>     state_fips_o county_fips_o state_name_o county_n
> ame_o fips_o ///
>     state_fips_d county_fips_d state_name_d county_n
> ame_d fips_d ///
>     persons households income_total

. 
. sort year state_fips_o county_fips_o state_fips_d co
> unty_fips_d

. 
. replace county_name_o = "Other" if county_fips_o == 
> 0 
(46,948 real changes made)

. replace county_name_d = "Other" if county_fips_d == 
> 0 
(49,676 real changes made)

. 
. save "${data}working/acs_county_flow", replace
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/acs_county_flow.dta saved

. 
. // Optional: Multnomah-focused flow extract (origin 
> = Multnomah County, OR)
. // Multnomah County, OR = state 41, county 051
. preserve

. keep if state_fips_o == 41 & county_fips_o == 51
(207,316 observations deleted)

. save "${data}working/multnomah_acs_flow", replace
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/multnomah_acs_flow.dta saved

. clear

. 
. 
. 
. //--------------------------------------------------
> --
. // STEP 4: Import and Clean IRS Migration Data 
. //--------------------------------------------------
> --
. 
. ** Loop over years 
. forvalues y = 15(1)21 {
  2.         
.         local start = `y'
  3.         local end = `y' + 1 
  4.         
.         ** Import data (out)
.         import delimited "${data}irs/countyoutflow`s
> tart'`end'.csv", clear 
  5.         
.         ** Describe data 
.         des 
  6.         
.         ** Generate year 
.         gen year = 2000 + `y' 
  7.         
.         ** Drop Regional Values 
.         drop if y2_state == "DS"
  8.         
.         ** Drop Foreign Migration 
.         drop if y2_state == "FR"
  9.         
.         ** Drop observations without a county
.         drop if y1_countyfips == 0 
 10.         
.         ** Deal with suppressed values 
.         unsuppress n1 n2 agi
 11.         
.         ** Drop unnecc variables 
.         drop y2_state y2_countyname
 12.                 
.         ** Create two versions: gross and net 
.         tempfile tmp
 13.         save `tmp'
 14.         
.         ** Gross first 
.         
.         ** Keep gross categories 
.         keep if ///
>                 (y1_statefips == y2_statefips & y1_c
> ountyfips == y2_countyfips) |       ///
>                 inlist(y2_statefips, 96, 97, 98)
 15. 
.         ** Clean up 
.         gen move_type = 0 
 16.         
.         ** Stayers 
.         replace move_type = 1 if        (y1_statefip
> s == y2_statefips) &        ///
>                                                     
>             (y1_countyfips == y2_countyfips) 
 17.         
.         ** Movers
.         replace move_type = 2 if        y2_statefips
>  == 96              // ALL 
 18.         replace move_type = 3 if        y2_statef
> ips == 97 &    ///
>                                                     
>             y2_countyfips == 0              // Domes
> tic Total
 19.         replace move_type = 4 if        y2_statef
> ips == 97 &    ///
>                                                     
>             y2_countyfips == 1              // Withi
> n-state
 20.         replace move_type = 5 if        y2_statef
> ips == 97 &    ///
>                                                     
>             y2_countyfips == 3              // Betwe
> en-states 
 21.         replace move_type = 6 if        y2_statef
> ips == 98              // Foreign 
 22.         
.         ** Label movers 
.         label values move_type lb_move_type 
 23.         
.         ** Generate total category 
.         foreach var of varlist n1 n2 agi {
 24.                 
.                 gen tmp = `var' if inlist(move_type,
>  1, 2)
 25.                 bysort y1_statefips y1_countyfips
> : egen `var'_total = total(tmp)
 26.                 drop tmp 
 27.                 
.         } // END VAR LOOP 
 28.         
.         ** Drop unnecc variables 
.         drop y2_* 
 29.         
.         ** Sort 
.         sort year y1_statefips y1_countyfips move_ty
> pe 
 30. 
.         ** Order 
.         order year y1_statefips y1_countyfips move_t
> ype 
 31.         
.         ** Rename 
.         rename y1_countyfips county_fips 
 32.         rename y1_statefips state_fips 
 33.         
.         ** Label variables 
.         label var year "Tax year (year before move)"
 34.         label var state_fips "State FIPS code (or
> igin state)"
 35.         label var county_fips "County FIPS code (
> origin county)"
 36.         label var move_type "Mover category"
 37.         label var n1 "Number of returns"
 38.         label var n2 "Number of exemptions"
 39.         label var agi "Adjusted Gross Income"
 40.         label var n1_total "Number of returns, co
> unty total (origin)"
 41.         label var n2_total "Number of exemptions,
>  county total (origin)"
 42.         label var agi_total "Adjusted Gross Incom
> e, county total (origin)"
 43.         
.         ** Save 
.         save "${data}working/irs_county_gross_out_`y
> '", replace 
 44.         
.         ** Create version for merge with net 
.         keep if move_type == 3 
 45.         
.         ** Rename variables 
.         rename n1 n1_mover
 46.         rename n2 n2_mover 
 47.         rename agi agi_mover 
 48.         
.         label var n1_mover "Number of domestic mover
>  returns"
 49.         label var n2_mover "Number of domestic mo
> ver exemptions"
 50.         label var agi_mover "Adjusted Gross Incom
> e, domestic movers"
 51.         
.         ** Save as temp file 
.         tempfile merge 
 52.         save `merge'
 53.         clear 
 54.         
.         ** Next, create flow file 
.         use `tmp', clear 
 55.         
.         ** Drop aggregate values 
.         drop if inlist(y2_statefips, 96, 97, 98)
 56.         drop if (y1_statefips == y2_statefips & y
> 1_countyfips == y2_countyfips) 
 57.         
.         ** Sort 
.         sort year y1_statefips y1_countyfips y2_stat
> efips y2_countyfips 
 58. 
.         ** Order 
.         order year y1_statefips y1_countyfips y2_sta
> tefips y2_countyfips
 59. 
.         
.         ** Rename 
.         rename y1_countyfips county_fips 
 60.         rename y1_statefips state_fips 
 61.         rename y2_countyfips y2_county_fips 
 62.         rename y2_statefips y2_state_fips       
 63.         
.         ** Label variables 
.         label var year "Tax year (year before move)"
 64.         label var state_fips "State FIPS code (or
> igin state)"
 65.         label var county_fips "County FIPS code (
> origin county)"
 66.         label var y2_state_fips "State FIPS code 
> (dest. state)"
 67.         label var y2_county_fips "County FIPS cod
> e (dest. county)"      
 68.         label var n1 "Number of returns"
 69.         label var n2 "Number of exemptions"
 70.         label var agi "Adjusted Gross Income"
 71.         
.         ** Merge with county of origin data 
.         merge m:1 state_fips county_fips using `merg
> e', nogen keep(master match)
 72.         
.         ** Rename 
.         rename state_fips state_fips_o
 73.         rename county_fips county_fips_o
 74.         rename y2_* *_d 
 75.         
.         ** Dropo unnecc variable 
.         drop move_type 
 76.         
.         ** Save 
.         save "${data}working/irs_county_flow_`y'", r
> eplace 
 77.         clear
 78.         
.         ** Import data (in)
.         import delimited "${data}irs/countyinflow`st
> art'`end'.csv", clear 
 79.         
.         ** Describe data 
.         des 
 80. 
.         ** Generate year 
.         gen year = 2000 + `y' 
 81.         
.         ** Drop Regional Values 
.         drop if y1_state == "DS"
 82.         
.         ** Drop Foreign Migration 
.         drop if y1_state == "FR"
 83.         
.         ** Drop observations with no county ID 
.         drop if y2_countyfips == 0 
 84.         
.         ** Keep gross categories 
.         keep if ///
>                 (y1_statefips == y2_statefips & y1_c
> ountyfips == y2_countyfips) |       ///
>                 inlist(y1_statefips, 96, 97, 98)
 85. 
.         ** Clean up 
.         gen move_type = 0 
 86.         
.         ** Deal with suppressed values 
.         unsuppress n1 n2 agi
 87.         
.         ** Stayers 
.         replace move_type = 1 if        (y1_statefip
> s == y2_statefips) &        ///
>                                                     
>             (y1_countyfips == y2_countyfips) 
 88.         
.         ** Movers
.         replace move_type = 2 if        y1_statefips
>  == 96              // ALL 
 89.         replace move_type = 3 if        y1_statef
> ips == 97 &    ///
>                                                     
>             y1_countyfips == 0              // Domes
> tic Total
 90.         replace move_type = 4 if        y1_statef
> ips == 97 &    ///
>                                                     
>             y1_countyfips == 1              // Withi
> n-state
 91.         replace move_type = 5 if        y1_statef
> ips == 97 &    ///
>                                                     
>             y1_countyfips == 3              // Betwe
> en-states 
 92.         replace move_type = 6 if        y1_statef
> ips == 98              // Foreign 
 93.         
.         ** Label move variable  
.         label values move_type lb_move_type 
 94.         
.         ** Generate total category 
.         foreach var of varlist n1 n2 agi {
 95.                 
.                 gen tmp = `var' if inlist(move_type,
>  1, 2)
 96.                 bysort y2_statefips y2_countyfips
> : egen `var'_total = total(tmp)
 97.                 drop tmp 
 98.                 
.         } // END VAR LOOP 
 99.         
.         ** Drop unnecc variables 
.         drop y1_*
100.         
.         ** Sort 
.         sort year y2_statefips y2_countyfips move_ty
> pe 
101. 
.         ** Order 
.         order year y2_statefips y2_countyfips move_t
> ype 
102.         
.         ** Rename 
.         rename y2_countyfips county_fips 
103.         rename y2_statefips state_fips 
104.         
.         ** Label variables 
.         label var year "Tax year (year before move)"
105.         label var state_fips "State FIPS code (de
> st. state)"
106.         label var county_fips "County FIPS code (
> dest. county)"
107.         label var move_type "Mover category"
108.         label var n1 "Number of returns"
109.         label var n2 "Number of exemptions"
110.         label var agi "Adjusted Gross Income"
111.         label var n1_total "Number of returns, co
> unty total (dest.)"
112.         label var n2_total "Number of exemptions,
>  county total (dest.)"
113.         label var agi_total "Adjusted Gross Incom
> e, county total (dest.)"
114.         
.         ** Save 
.         save "${data}working/irs_county_gross_in_`y'
> ", replace 
115.         clear 
116.         
. } // END YEAR LOOP 
(encoding automatically selected: ISO-8859-1)
(9 vars, 86,481 obs)

Contains data
 Observations:        86,481                  
    Variables:             9                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y2_state        str2    %9s                   
y2_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(15,289 observations deleted)
(2,937 observations deleted)
(254 observations deleted)
(2,056 real changes made)
(2,056 real changes made)
(2,056 real changes made)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000o
    > .tmp saved as .dta format
(50,007 observations deleted)
(3,141 real changes made)
(3,141 real changes made)
(3,141 real changes made)
(3,140 real changes made)
(3,140 real changes made)
(2,291 real changes made)
(11,712 missing values generated)
(11,712 missing values generated)
(11,712 missing values generated)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_out_15.dta
    saved
(14,853 observations deleted)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000p
    > .tmp saved as .dta format
(14,853 observations deleted)
(3,141 observations deleted)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            50,007  
    -----------------------------------------
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_flow_15.dta saved
(encoding automatically selected: ISO-8859-1)
(9 vars, 86,330 obs)

Contains data
 Observations:        86,330                  
    Variables:             9                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y1_state        str2    %9s                   
y1_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(15,315 observations deleted)
(2,814 observations deleted)
(254 observations deleted)
(50,005 observations deleted)
(2,041 real changes made)
(2,041 real changes made)
(2,041 real changes made)
(3,141 real changes made)
(3,141 real changes made)
(3,141 real changes made)
(3,140 real changes made)
(3,140 real changes made)
(2,239 real changes made)
(11,660 missing values generated)
(11,660 missing values generated)
(11,660 missing values generated)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_in_15.dta
    saved
(encoding automatically selected: ISO-8859-1)
(9 vars, 98,948 obs)

Contains data
 Observations:        98,948                  
    Variables:             9                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y2_state        str2    %9s                   
y2_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(15,372 observations deleted)
(2,360 observations deleted)
(254 observations deleted)
(1,877 real changes made)
(1,877 real changes made)
(1,877 real changes made)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000q
    > .tmp saved as .dta format
(63,249 observations deleted)
(3,140 real changes made)
(3,141 real changes made)
(3,141 real changes made)
(3,140 real changes made)
(3,141 real changes made)
(2,010 real changes made)
(11,432 missing values generated)
(11,432 missing values generated)
(11,432 missing values generated)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_out_16.dta
    saved
(14,572 observations deleted)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000r
    > .tmp saved as .dta format
(14,573 observations deleted)
(3,140 observations deleted)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            63,249  
    -----------------------------------------
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_flow_16.dta saved
(encoding automatically selected: ISO-8859-1)
(9 vars, 98,874 obs)

Contains data
 Observations:        98,874                  
    Variables:             9                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y1_state        str2    %9s                   
y1_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(15,432 observations deleted)
(2,282 observations deleted)
(254 observations deleted)
(63,249 observations deleted)
(1,788 real changes made)
(1,788 real changes made)
(1,788 real changes made)
(3,140 real changes made)
(3,141 real changes made)
(3,141 real changes made)
(3,140 real changes made)
(3,140 real changes made)
(1,955 real changes made)
(11,376 missing values generated)
(11,376 missing values generated)
(11,376 missing values generated)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_in_16.dta
    saved
(encoding automatically selected: ISO-8859-1)
(9 vars, 87,820 obs)

Contains data
 Observations:        87,820                  
    Variables:             9                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y2_state        str2    %9s                   
y2_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(15,300 observations deleted)
(2,364 observations deleted)
(254 observations deleted)
(1,942 real changes made)
(1,942 real changes made)
(1,942 real changes made)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000s
    > .tmp saved as .dta format
(52,173 observations deleted)
(3,141 real changes made)
(3,141 real changes made)
(3,141 real changes made)
(3,140 real changes made)
(3,140 real changes made)
(2,026 real changes made)
(11,447 missing values generated)
(11,447 missing values generated)
(11,447 missing values generated)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_out_17.dta
    saved
(14,588 observations deleted)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000t
    > .tmp saved as .dta format
(14,588 observations deleted)
(3,141 observations deleted)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            52,173  
    -----------------------------------------
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_flow_17.dta saved
(encoding automatically selected: ISO-8859-1)
(9 vars, 87,932 obs)

Contains data
 Observations:        87,932                  
    Variables:             9                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y1_state        str2    %9s                   
y1_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(15,368 observations deleted)
(2,403 observations deleted)
(254 observations deleted)
(52,174 observations deleted)
(1,919 real changes made)
(1,919 real changes made)
(1,919 real changes made)
(3,141 real changes made)
(3,141 real changes made)
(3,141 real changes made)
(3,140 real changes made)
(3,140 real changes made)
(2,030 real changes made)
(11,451 missing values generated)
(11,451 missing values generated)
(11,451 missing values generated)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_in_17.dta
    saved
(encoding automatically selected: ISO-8859-1)
(9 vars, 83,878 obs)

Contains data
 Observations:        83,878                  
    Variables:             9                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y2_state        str2    %9s                   
y2_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(14,919 observations deleted)
(2,298 observations deleted)
(0 observations deleted)
(53 real changes made)
(53 real changes made)
(53 real changes made)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000u
    > .tmp saved as .dta format
(51,090 observations deleted)
(3,141 real changes made)
(3,107 real changes made)
(3,107 real changes made)
(3,103 real changes made)
(2,778 real changes made)
(335 real changes made)
(9,323 missing values generated)
(9,323 missing values generated)
(9,323 missing values generated)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_out_18.dta
    saved
(12,464 observations deleted)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000v
    > .tmp saved as .dta format
(12,430 observations deleted)
(3,141 observations deleted)

    Result                      Number of obs
    -----------------------------------------
    Not matched                            34
        from master                        34  
        from using                          0  

    Matched                            51,056  
    -----------------------------------------
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_flow_18.dta saved
(encoding automatically selected: ISO-8859-1)
(9 vars, 83,762 obs)

Contains data
 Observations:        83,762                  
    Variables:             9                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y1_state        str2    %9s                   
y1_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(14,890 observations deleted)
(2,290 observations deleted)
(0 observations deleted)
(51,090 observations deleted)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(3,141 real changes made)
(3,086 real changes made)
(3,086 real changes made)
(3,082 real changes made)
(2,729 real changes made)
(368 real changes made)
(9,265 missing values generated)
(9,265 missing values generated)
(9,265 missing values generated)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_in_18.dta
    saved
(encoding automatically selected: ISO-8859-1)
(9 vars, 87,325 obs)

Contains data
 Observations:        87,325                  
    Variables:             9                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y2_state        str2    %9s                   
y2_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(14,937 observations deleted)
(2,272 observations deleted)
(0 observations deleted)
(62 real changes made)
(62 real changes made)
(62 real changes made)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000w
    > .tmp saved as .dta format
(54,560 observations deleted)
(3,142 real changes made)
(3,104 real changes made)
(3,104 real changes made)
(3,101 real changes made)
(2,773 real changes made)
(332 real changes made)
(9,310 missing values generated)
(9,310 missing values generated)
(9,310 missing values generated)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_out_19.dta
    saved
(12,452 observations deleted)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_00000x
    > .tmp saved as .dta format
(12,414 observations deleted)
(3,142 observations deleted)

    Result                      Number of obs
    -----------------------------------------
    Not matched                            38
        from master                        38  
        from using                          0  

    Matched                            54,522  
    -----------------------------------------
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_flow_19.dta saved
(encoding automatically selected: ISO-8859-1)
(9 vars, 87,552 obs)

Contains data
 Observations:        87,552                  
    Variables:             9                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y1_state        str2    %9s                   
y1_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(15,060 observations deleted)
(2,323 observations deleted)
(0 observations deleted)
(54,560 observations deleted)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(3,142 real changes made)
(3,102 real changes made)
(3,102 real changes made)
(3,097 real changes made)
(2,805 real changes made)
(361 real changes made)
(9,365 missing values generated)
(9,365 missing values generated)
(9,365 missing values generated)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_in_19.dta
    saved
(encoding automatically selected: ISO-8859-1)
(9 vars, 89,511 obs)

Contains data
 Observations:        89,511                  
    Variables:             9                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y2_state        str2    %9s                   
y2_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(14,963 observations deleted)
(2,175 observations deleted)
(0 observations deleted)
(79 real changes made)
(79 real changes made)
(79 real changes made)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000010
    > .tmp saved as .dta format
(56,831 observations deleted)
(3,143 real changes made)
(3,097 real changes made)
(3,097 real changes made)
(3,094 real changes made)
(2,787 real changes made)
(324 real changes made)
(9,302 missing values generated)
(9,302 missing values generated)
(9,302 missing values generated)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_out_20.dta
    saved
(12,445 observations deleted)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000011
    > .tmp saved as .dta format
(12,399 observations deleted)
(3,143 observations deleted)

    Result                      Number of obs
    -----------------------------------------
    Not matched                            46
        from master                        46  
        from using                          0  

    Matched                            56,785  
    -----------------------------------------
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_flow_20.dta saved
(encoding automatically selected: ISO-8859-1)
(9 vars, 89,850 obs)

Contains data
 Observations:        89,850                  
    Variables:             9                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y1_state        str2    %9s                   
y1_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(15,132 observations deleted)
(2,263 observations deleted)
(0 observations deleted)
(56,835 observations deleted)
(1 real change made)
(1 real change made)
(1 real change made)
(3,143 real changes made)
(3,101 real changes made)
(3,101 real changes made)
(3,098 real changes made)
(2,838 real changes made)
(339 real changes made)
(9,376 missing values generated)
(9,376 missing values generated)
(9,376 missing values generated)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_in_20.dta
    saved
(encoding automatically selected: ISO-8859-1)
(9 vars, 90,409 obs)

Contains data
 Observations:        90,409                  
    Variables:             9                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y2_state        str2    %9s                   
y2_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(14,962 observations deleted)
(2,223 observations deleted)
(0 observations deleted)
(64 real changes made)
(64 real changes made)
(64 real changes made)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000012
    > .tmp saved as .dta format
(57,644 observations deleted)
(3,144 real changes made)
(3,107 real changes made)
(3,107 real changes made)
(3,103 real changes made)
(2,790 real changes made)
(329 real changes made)
(9,329 missing values generated)
(9,329 missing values generated)
(9,329 missing values generated)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_out_21.dta
    saved
(12,473 observations deleted)
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000013
    > .tmp saved as .dta format
(12,436 observations deleted)
(3,144 observations deleted)

    Result                      Number of obs
    -----------------------------------------
    Not matched                            37
        from master                        37  
        from using                          0  

    Matched                            57,607  
    -----------------------------------------
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_flow_21.dta saved
(encoding automatically selected: ISO-8859-1)
(9 vars, 90,498 obs)

Contains data
 Observations:        90,498                  
    Variables:             9                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y1_state        str2    %9s                   
y1_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(15,093 observations deleted)
(2,179 observations deleted)
(0 observations deleted)
(57,640 observations deleted)
(1 real change made)
(1 real change made)
(1 real change made)
(3,144 real changes made)
(3,098 real changes made)
(3,098 real changes made)
(3,094 real changes made)
(2,822 real changes made)
(330 real changes made)
(9,344 missing values generated)
(9,344 missing values generated)
(9,344 missing values generated)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_in_21.dta
    saved

. 
. ** Append data 
. 
. ** Loop over datasets 
. foreach file in "irs_county_gross_in" "irs_county_gr
> oss_out" "irs_county_flow"{
  2.         
.                 
.         ** Loop over years 
.         forvalues y = 15(1)21 {
  3. 
.                 ** Append 
.                 append using "${data}working/`file'_
> `y'"
  4.                 
.         } // END YEAR LOOP 
  5.         
.         
.         ** Order and sort flow file 
.         if "`file'" == "irs_county_flow" {
  6.                 
.                 ** Loop over orgin and destination s
> tate 
.                 foreach x in "o" "d" {
  7.                         
.                         ** Rename 
.                         rename *_fips_`x' *_fips 
  8.                         
.                         ** Merge with county and sta
> te names 
.                         merge m:1 state_fips county_
> fips using "${data}working/ids",    ///
>                                 keep(match) nogen 
  9.                                 
.                         ** Rename 
.                         rename *_fips *_fips_`x' 
 10.                         rename *_name *_name_`x' 
 11. 
.                         
.                 } // END ORIGIN / DESTINATION LOOP 
 12.                 
.                 ** Order file 
.                 order year state_*_o county_*_o stat
> e_*_d county_*_d  
 13.                 sort year state_*_o county_*_o st
> ate_*_d county_*_d  
 14. 
.         } // END MIGRATION FLOW IF-STATEMENT 
 15.         
.         else {
 16.                 
.                 ** Merge with county and state names
>  
.                 merge m:1 state_fips county_fips usi
> ng "${data}working/ids",    ///
>                                 keep(match) nogen 
 17.                                 
.                 ** Order 
.                 order year state_* county* move_type
 18.                 
.         } 
 19.         
.         ** Save file 
.         save "${data}working/`file'", replace 
 20.         clear 
 21.         
. } // END FILE LOOP 

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           115,567  
    -----------------------------------------
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_in.dta
    saved

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           115,611  
    -----------------------------------------
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross_out.dta
    saved

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           384,896  
    -----------------------------------------

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           362,678  
    -----------------------------------------
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_flow.dta saved

. 
. ** Create gross file with in and out migration 
. use "${data}working/irs_county_gross_in", clear 

. 
. ** Rename 
. rename n1 n1_in_

. rename n2 n2_in_

. rename agi agi_in_

. rename *_total *_total_in

. 
. ** Reshape 
. reshape wide n1_in_ n2_in_ agi_in_, i(year state_fip
> s county_fips) j(move_type)
(j = 1 2 3 4 5 6)

Data                               Long   ->   Wide
------------------------------------------------------
> -----------------------
Number of observations          115,567   ->   21,980 
>      
Number of variables                  13   ->   27     
>      
j variable (6 values)         move_type   ->   (droppe
> d)
xij variables:
                                 n1_in_   ->   n1_in_1
>  n1_in_2 ... n1_in_6
                                 n2_in_   ->   n2_in_1
>  n2_in_2 ... n2_in_6
                                agi_in_   ->   agi_in_
> 1 agi_in_2 ... agi_in_6
------------------------------------------------------
> -----------------------

. 
. ** Define locals 
. local txt1 "Non-movers"

. local txt2 "All movers"                 

. local txt3 "Domestic movers"            

. local txt4 "Within-state movers"        

. local txt5 "Inter-state movers" 

. local txt6 "Foreign movers"

. 
. ** Label variables, in loop 
. foreach n of numlist 1(1)6 {
  2.         
.         label var n1_in_`n' "Returns, in-migration, 
> `txt`n''"
  3.         label var n2_in_`n' "Exemptions, in-migra
> tion, `txt`n''"
  4.         label var agi_in_`n' "AGI, in-migration, 
> `txt`n''"
  5. 
. } // END NUMLIST LOOP 

. 
. ** Preserve 
. tempfile gross_in

. save `gross_in'
file
    C:\Users\ji252\AppData\Local\Temp\ST_67b0_000014
    > .tmp saved as .dta format

. clear

. 
. ** Create gross file with in and out migration 
. use "${data}working/irs_county_gross_out", clear 

. 
. ** Rename 
. rename n1 n1_out_

. rename n2 n2_out_

. rename agi agi_out_

. rename *_total *_total_out

. 
. ** Reshape 
. reshape wide n1_out_ n2_out_ agi_out_, i(year state_
> fips county_fips) j(move_type)
(j = 1 2 3 4 5 6)

Data                               Long   ->   Wide
------------------------------------------------------
> -----------------------
Number of observations          115,611   ->   21,980 
>      
Number of variables                  13   ->   27     
>      
j variable (6 values)         move_type   ->   (droppe
> d)
xij variables:
                                n1_out_   ->   n1_out_
> 1 n1_out_2 ... n1_out_6
                                n2_out_   ->   n2_out_
> 1 n2_out_2 ... n2_out_6
                               agi_out_   ->   agi_out
> _1 agi_out_2 ... agi_out_6
------------------------------------------------------
> -----------------------

. 
. ** Define locals 
. local txt1 "Non-movers"

. local txt2 "All movers"                 

. local txt3 "Domestic movers"            

. local txt4 "Within-state movers"        

. local txt5 "Inter-state movers" 

. local txt6 "Foreign movers"

. 
. ** Label variables, in loop 
. foreach n of numlist 1(1)6 {
  2.         
.         label var n1_out_`n' "Returns, out-migration
> , `txt`n''"
  3.         label var n2_out_`n' "Exemptions, out-mig
> ration, `txt`n''"
  4.         label var agi_out_`n' "AGI, out-migration
> , `txt`n''"
  5. 
. } // END NUMLIST LOOP 

. 
. ** Merge data 
. merge 1:1 year state_fips county_fips using `gross_i
> n', keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,980  
    -----------------------------------------

. 
. ** Text for correct matching (non-movers should matc
> h perfectly)
. summ n*_*_1 agi_*_1

    Variable |        Obs        Mean    Std. dev.    
>    Min        Max
-------------+----------------------------------------
> -----------------
    n1_out_1 |     21,979    37461.71    123155.4     
>      0    3944880
    n2_out_1 |     21,979    78000.79    252081.2     
>      0    7841705
     n1_in_1 |     21,979    37461.71    123155.4     
>      0    3944880
     n2_in_1 |     21,979    78000.79    252081.2     
>      0    7841705
   agi_out_1 |     21,979     3214755    1.23e+07     
>  -8051   4.30e+08
-------------+----------------------------------------
> -----------------
    agi_in_1 |     21,979     3214755    1.23e+07     
>  -8051   4.30e+08

. 
. ** Define net migration variables 
. 
. ** Loop over variable
. foreach a in "n1" "n2" "agi" {
  2. 
.         if "`a'" == "n1" local txt "Returns"
  3.         else if "`a'" == "n2" local txt "Exemptio
> ns"
  4.         else if "`a'" == "agi" local txt "AGI"
  5. 
.         ** Loop over type of movers 
.         forvalues n = 2/6 {
  6.                 
.                 ** Clean up missing values 
.                 replace `a'_in_`n' = 0 if missing(`a
> '_in_`n')
  7.                 replace `a'_out_`n' = 0 if missin
> g(`a'_out_`n')
  8. 
.                 ** Generate net 
.                 gen `a'_net_`n' = `a'_in_`n' - `a'_o
> ut_`n'
  9.                 label var `a'_net_`n' "`txt', net
> -migration, `txt`n''"
 10. 
.         } // END MOVER TYPE LOOP 
 11. 
. } // END VARIABLE LOOP 
(183 real changes made)
(155 real changes made)
(183 real changes made)
(155 real changes made)
(202 real changes made)
(172 real changes made)
(1,379 real changes made)
(1,444 real changes made)
(14,365 real changes made)
(14,342 real changes made)
(183 real changes made)
(155 real changes made)
(183 real changes made)
(155 real changes made)
(202 real changes made)
(172 real changes made)
(1,379 real changes made)
(1,444 real changes made)
(14,365 real changes made)
(14,342 real changes made)
(183 real changes made)
(155 real changes made)
(183 real changes made)
(155 real changes made)
(202 real changes made)
(172 real changes made)
(1,379 real changes made)
(1,444 real changes made)
(14,365 real changes made)
(14,342 real changes made)

. 
. ** Generate fips variable
. *make_fips state_fips county_fips, gen(fips)
. 
. ** Save file 
. save "${data}working/irs_county_gross", replace 
(file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross.dta not
    found)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_gross.dta saved

. clear

. 
. //--------------------------------------------------
> ---
. // STEP 4: Import and Clean IRS County-Level Aggr. D
> ata 
. //--------------------------------------------------
> ---
. 
. ** Loop over years 
. forvalues y = 15(1)22 {
  2.         
.         
.         ** Import data (out)
.         import delimited "${data}irs/`y'incyallagi.c
> sv", clear 
  3. 
.         ** Describe data 
.         des 
  4.         
.         ** Generate year 
.         gen year = 2000 + `y' 
  5.         
.         ** Define AGI groups 
.         label var agi_stub "AGI Brackets"
  6.         label values agi_stub lb_agi 
  7.         
.         ** Define set of variables to keep 
.         keep state* county* agi_stub year n1 mars1 m
> ars2 mars4 n2 elderly       ///
>                 a00100 n02650 a02650 n00200 a00200 
  8.                 
.         ** Rename variables 
.         rename a00100 agi 
  9.         rename n02650 n_total_inc
 10.         rename a02650 a_total_inc
 11.         rename n00200 n_wage
 12.         rename a00200 a_wage 
 13.         rename statefips state_fips
 14.         rename state state_abb 
 15.         rename countyfips county_fips 
 16.         rename countyname county_name 
 17.         
.         ** Rescale 
.         replace agi = 1000 * agi 
 18.         replace a_total_inc = 1000 * a_total_inc
 19.         replace a_wage = 1000 * a_wage 
 20.         
.         ** Label 
.         label var n1 "Number of returns"
 21.         label var mars1 "Number of single returns
> "
 22.         label var mars1 "Number of MFJ returns"
 23.         label var mars1 "Number of HoH returns"
 24.         label var n2 "Number of individuals"
 25.         label var elderly "Number of returns with
>  one individual over 60"
 26.         label var agi "Adjusted Gross Income (AGI
> )"
 27.         label var n_total_inc "Number of returns 
> with total income"
 28.         label var a_total_inc "Total income amoun
> t"
 29.         label var n_wage "Number of returns with 
> wage income"
 30.         label var a_wage "Wage income amount"
 31.         
.         ** Sort 
.         sort year state_fips county_fips agi_stub 
 32.         
.         ** Order 
.         order year state* county* agi_stub 
 33.         
.         ** Save 
.         save "${data}working/irs_county_all_`y'", re
> place 
 34.         
.         clear 
 35.         
. } // END YEAR LOOP 
(encoding automatically selected: ISO-8859-1)
(132 vars, 25,536 obs)

Contains data
 Observations:        25,536                  
    Variables:           132                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
statefips       byte    %8.0g                 STATEFIP
                                  > S
state           str2    %9s                   STATE
countyfips      int     %8.0g                 COUNTYFI
                                  > PS
countyname      str20   %20s                  COUNTYNA
                                  > ME
agi_stub        byte    %8.0g                 
n1              long    %12.0g                N1
mars1           long    %12.0g                
mars2           long    %12.0g                MARS2
mars4           long    %12.0g                MARS4
prep            long    %12.0g                PREP
n2              long    %12.0g                N2
numdep          long    %12.0g                NUMDEP
total_vita      long    %12.0g                TOTAL_VI
                                  > TA
vita            long    %12.0g                VITA
tce             long    %12.0g                TCE
vita_eic        int     %8.0g                 VITA_EIC
ral             long    %8.0g                 RAL
rac             long    %12.0g                RAC
elderly         long    %12.0g                ELDERLY
a00100          long    %12.0g                A00100
n02650          long    %12.0g                N02650
a02650          long    %12.0g                A02650
n00200          long    %12.0g                N00200
a00200          long    %12.0g                A00200
n00300          long    %12.0g                N00300
a00300          long    %12.0g                A00300
n00600          long    %12.0g                N00600
a00600          long    %12.0g                A00600
n00650          long    %12.0g                N00650
a00650          long    %12.0g                A00650
n00700          long    %12.0g                N00700
a00700          long    %12.0g                A00700
n00900          long    %12.0g                N00900
a00900          long    %12.0g                A00900
n01000          long    %12.0g                N01000
a01000          long    %12.0g                A01000
n01400          long    %12.0g                N01400
a01400          long    %12.0g                A01400
n01700          long    %12.0g                N01700
a01700          long    %12.0g                A01700
schf            long    %8.0g                 SCHF
n02300          long    %12.0g                N02300
a02300          long    %12.0g                A02300
n02500          long    %12.0g                N02500
a02500          long    %12.0g                A02500
n26270          long    %12.0g                N26270
a26270          long    %12.0g                A26270
n02900          long    %12.0g                N02900
a02900          long    %12.0g                A02900
n03220          long    %12.0g                N03220
a03220          long    %12.0g                A03220
n03300          long    %12.0g                N03300
a03300          long    %12.0g                A03300
n03270          long    %12.0g                N03270
a03270          long    %12.0g                A03270
n03150          long    %12.0g                N03150
a03150          long    %12.0g                A03150
n03210          long    %12.0g                N03210
a03210          long    %12.0g                A03210
n03230          long    %12.0g                N03230
a03230          long    %12.0g                A03230
n03240          int     %8.0g                 N03240
a03240          long    %12.0g                A03240
n04470          long    %12.0g                N04470
a04470          long    %12.0g                A04470
a00101          long    %12.0g                A00101
n18425          long    %12.0g                N18425
a18425          long    %12.0g                A18425
n18450          long    %12.0g                N18450
a18450          long    %12.0g                A18450
n18500          long    %12.0g                N18500
a18500          long    %12.0g                A18500
n18300          long    %12.0g                N18300
a18300          long    %12.0g                A18300
n19300          long    %12.0g                N19300
a19300          long    %12.0g                A19300
n19700          long    %12.0g                N19700
a19700          long    %12.0g                A19700
n04800          long    %12.0g                N04800
a04800          long    %12.0g                A04800
n05800          long    %12.0g                N05800
a05800          long    %12.0g                A05800
n09600          long    %12.0g                N09600
a09600          long    %12.0g                A09600
n05780          long    %12.0g                N05780
a05780          long    %12.0g                A05780
n07100          long    %12.0g                N07100
a07100          long    %12.0g                A07100
n07300          long    %12.0g                N07300
a07300          long    %12.0g                A07300
n07180          long    %12.0g                N07180
a07180          long    %12.0g                A07180
n07230          long    %12.0g                N07230
a07230          long    %12.0g                A07230
n07240          long    %12.0g                N07240
a07240          long    %12.0g                A07240
n07220          long    %12.0g                N07220
a07220          long    %12.0g                A07220
n07260          long    %12.0g                N07260
a07260          long    %12.0g                A07260
n09400          long    %12.0g                N09400
a09400          long    %12.0g                A09400
n85770          long    %12.0g                N85770
a85770          long    %12.0g                A85770
n85775          long    %12.0g                N85775
a85775          long    %12.0g                A85775
n09750          long    %12.0g                N09750
a09750          long    %12.0g                A09750
n10600          long    %12.0g                N10600
a10600          long    %12.0g                A10600
n59660          long    %12.0g                N59660
a59660          long    %12.0g                A59660
n59720          long    %12.0g                N59720
a59720          long    %12.0g                A59720
n11070          long    %12.0g                N11070
a11070          long    %12.0g                A11070
n10960          long    %12.0g                N10960
a10960          long    %12.0g                A10960
n11560          long    %12.0g                N11560
a11560          long    %12.0g                A11560
n06500          long    %12.0g                N06500
a06500          long    %12.0g                A06500
n10300          long    %12.0g                N10300
a10300          long    %12.0g                A10300
n85530          long    %12.0g                N85530
a85530          long    %12.0g                A85530
n85300          long    %12.0g                N85300
a85300          long    %12.0g                A85300
n11901          long    %12.0g                N11901
a11901          long    %12.0g                A11901
n11902          long    %12.0g                N11902
a11902          long    %12.0g                A11902
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
variable agi was long now double
(25,283 real changes made)
variable a_total_inc was long now double
(25,283 real changes made)
variable a_wage was long now double
(24,576 real changes made)
(file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_all_15.dta not
    found)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_all_15.dta saved
(encoding automatically selected: ISO-8859-1)
(148 vars, 25,536 obs)

Contains data
 Observations:        25,536                  
    Variables:           148                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
statefips       byte    %8.0g                 STATEFIP
                                  > S
state           str2    %9s                   STATE
countyfips      int     %8.0g                 COUNTYFI
                                  > PS
countyname      str20   %20s                  COUNTYNA
                                  > ME
agi_stub        byte    %8.0g                 
n1              long    %12.0g                N1
mars1           long    %12.0g                
mars2           long    %12.0g                MARS2
mars4           long    %12.0g                MARS4
prep            long    %12.0g                PREP
n2              long    %12.0g                N2
numdep          long    %12.0g                NUMDEP
total_vita      long    %12.0g                TOTAL_VI
                                  > TA
vita            long    %12.0g                VITA
tce             long    %12.0g                TCE
vita_eic        int     %8.0g                 VITA_EIC
ral             long    %12.0g                RAL
rac             long    %12.0g                RAC
elderly         long    %12.0g                ELDERLY
a00100          long    %12.0g                A00100
n02650          long    %12.0g                N02650
a02650          long    %12.0g                A02650
n00200          long    %12.0g                N00200
a00200          long    %12.0g                A00200
n00300          long    %12.0g                N00300
a00300          long    %12.0g                A00300
n00600          long    %12.0g                N00600
a00600          long    %12.0g                A00600
n00650          long    %12.0g                N00650
a00650          long    %12.0g                A00650
n00700          long    %12.0g                N00700
a00700          long    %12.0g                A00700
n00900          long    %12.0g                N00900
a00900          long    %12.0g                A00900
n01000          long    %12.0g                N01000
a01000          long    %12.0g                A01000
n01400          long    %12.0g                N01400
a01400          long    %12.0g                A01400
n01700          long    %12.0g                N01700
a01700          long    %12.0g                A01700
schf            long    %8.0g                 SCHF
n02300          long    %12.0g                N02300
a02300          long    %12.0g                A02300
n02500          long    %12.0g                N02500
a02500          long    %12.0g                A02500
n26270          long    %12.0g                N26270
a26270          long    %12.0g                A26270
n02900          long    %12.0g                N02900
a02900          long    %12.0g                A02900
n03220          long    %12.0g                N03220
a03220          long    %12.0g                A03220
n03300          long    %12.0g                N03300
a03300          long    %12.0g                A03300
n03270          long    %12.0g                N03270
a03270          long    %12.0g                A03270
n03150          long    %12.0g                N03150
a03150          long    %12.0g                A03150
n03210          long    %12.0g                N03210
a03210          long    %12.0g                A03210
n03230          long    %12.0g                N03230
a03230          long    %12.0g                A03230
n03240          int     %8.0g                 N03240
a03240          long    %12.0g                A03240
n04470          long    %12.0g                N04470
a04470          long    %12.0g                A04470
a00101          long    %12.0g                A00101
n17000          long    %12.0g                N17000
a17000          long    %12.0g                A17000
n18425          long    %12.0g                N18425
a18425          long    %12.0g                A18425
n18450          long    %12.0g                N18450
a18450          long    %12.0g                A18450
n18500          long    %12.0g                N18500
a18500          long    %12.0g                A18500
n18800          long    %12.0g                N18800
a18800          long    %12.0g                A18800
n18300          long    %12.0g                N18300
a18300          long    %12.0g                A18300
n19300          long    %12.0g                N19300
a19300          long    %12.0g                A19300
n19500          long    %12.0g                N19500
a19500          long    %12.0g                A19500
n19530          long    %12.0g                N19530
a19530          long    %12.0g                A19530
n19550          long    %12.0g                N19550
a19550          long    %12.0g                A19550
n19570          long    %12.0g                N19570
a19570          long    %12.0g                A19570
n19700          long    %12.0g                N19700
a19700          long    %12.0g                A19700
n20800          long    %12.0g                N20800
a20800          long    %12.0g                A20800
n21020          long    %12.0g                N21020
a21020          long    %12.0g                A21020
n04800          long    %12.0g                N04800
a04800          long    %12.0g                A04800
n05800          long    %12.0g                N05800
a05800          long    %12.0g                A05800
n09600          long    %12.0g                N09600
a09600          long    %12.0g                A09600
n05780          long    %12.0g                N05780
a05780          long    %12.0g                A05780
n07100          long    %12.0g                N07100
a07100          long    %12.0g                A07100
n07300          long    %12.0g                N07300
a07300          long    %12.0g                A07300
n07180          long    %12.0g                N07180
a07180          long    %12.0g                A07180
n07230          long    %12.0g                N07230
a07230          long    %12.0g                A07230
n07240          long    %12.0g                N07240
a07240          long    %12.0g                A07240
n07220          long    %12.0g                N07220
a07220          long    %12.0g                A07220
n07260          long    %12.0g                N07260
a07260          long    %12.0g                A07260
n09400          long    %12.0g                N09400
a09400          long    %12.0g                A09400
n85770          long    %12.0g                N85770
a85770          long    %12.0g                A85770
n85775          long    %12.0g                N85775
a85775          long    %12.0g                A85775
n09750          long    %12.0g                N09750
a09750          long    %12.0g                A09750
n10600          long    %12.0g                N10600
a10600          long    %12.0g                A10600
n59660          long    %12.0g                N59660
a59660          long    %12.0g                A59660
n59720          long    %12.0g                N59720
a59720          long    %12.0g                A59720
n11070          long    %12.0g                N11070
a11070          long    %12.0g                A11070
n10960          long    %12.0g                N10960
a10960          long    %12.0g                A10960
n11560          long    %12.0g                N11560
a11560          long    %12.0g                A11560
n06500          long    %12.0g                N06500
a06500          long    %12.0g                A06500
n10300          long    %12.0g                N10300
a10300          long    %12.0g                A10300
n85530          long    %12.0g                N85530
a85530          long    %12.0g                A85530
n85300          long    %12.0g                N85300
a85300          long    %12.0g                A85300
n11901          long    %12.0g                N11901
a11901          long    %12.0g                A11901
n11902          long    %12.0g                N11902
a11902          long    %12.0g                A11902
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
variable agi was long now double
(25,267 real changes made)
variable a_total_inc was long now double
(25,267 real changes made)
variable a_wage was long now double
(24,662 real changes made)
(file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_all_16.dta not
    found)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_all_16.dta saved
(encoding automatically selected: ISO-8859-1)
(154 vars, 25,536 obs)

Contains data
 Observations:        25,536                  
    Variables:           154                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
statefips       byte    %8.0g                 STATEFIP
                                  > S
state           str2    %9s                   STATE
countyfips      int     %8.0g                 COUNTYFI
                                  > PS
countyname      str20   %20s                  COUNTYNA
                                  > ME
agi_stub        byte    %8.0g                 
n1              long    %12.0g                N1
mars1           long    %12.0g                
mars2           long    %12.0g                MARS2
mars4           long    %12.0g                MARS4
elf             long    %12.0g                ELF
cprep           long    %12.0g                CPREP
prep            long    %12.0g                PREP
dir_dep         long    %12.0g                DIR_DEP
n2              long    %12.0g                N2
numdep          long    %12.0g                NUMDEP
total_vita      long    %12.0g                TOTAL_VI
                                  > TA
vita            long    %12.0g                VITA
tce             long    %12.0g                TCE
vita_eic        int     %8.0g                 VITA_EIC
rac             long    %12.0g                RAC
elderly         long    %12.0g                ELDERLY
a00100          long    %12.0g                A00100
n02650          long    %12.0g                N02650
a02650          long    %12.0g                A02650
n00200          long    %12.0g                N00200
a00200          long    %12.0g                A00200
n00300          long    %12.0g                N00300
a00300          long    %12.0g                A00300
n00600          long    %12.0g                N00600
a00600          long    %12.0g                A00600
n00650          long    %12.0g                N00650
a00650          long    %12.0g                A00650
n00700          long    %12.0g                N00700
a00700          long    %12.0g                A00700
n00900          long    %12.0g                N00900
a00900          long    %12.0g                A00900
n01000          long    %12.0g                N01000
a01000          long    %12.0g                A01000
n01400          long    %12.0g                N01400
a01400          long    %12.0g                A01400
n01700          long    %12.0g                N01700
a01700          long    %12.0g                A01700
schf            long    %8.0g                 SCHF
n02300          long    %12.0g                N02300
a02300          long    %12.0g                A02300
n02500          long    %12.0g                N02500
a02500          long    %12.0g                A02500
n26270          long    %12.0g                N26270
a26270          long    %12.0g                A26270
n02900          long    %12.0g                N02900
a02900          long    %12.0g                A02900
n03220          long    %12.0g                N03220
a03220          long    %12.0g                A03220
n03300          long    %12.0g                N03300
a03300          long    %12.0g                A03300
n03270          long    %12.0g                N03270
a03270          long    %12.0g                A03270
n03150          long    %12.0g                N03150
a03150          long    %12.0g                A03150
n03210          long    %12.0g                N03210
a03210          long    %12.0g                A03210
n03230          long    %12.0g                N03230
a03230          long    %12.0g                A03230
n03240          long    %12.0g                N03240
a03240          long    %12.0g                A03240
n04470          long    %12.0g                N04470
a04470          long    %12.0g                A04470
a00101          long    %12.0g                A00101
n17000          long    %12.0g                N17000
a17000          long    %12.0g                A17000
n18425          long    %12.0g                N18425
a18425          long    %12.0g                A18425
n18450          long    %12.0g                N18450
a18450          long    %12.0g                A18450
n18500          long    %12.0g                N18500
a18500          long    %12.0g                A18500
n18800          long    %12.0g                N18800
a18800          long    %12.0g                A18800
n18300          long    %12.0g                N18300
a18300          long    %12.0g                A18300
n19300          long    %12.0g                N19300
a19300          long    %12.0g                A19300
n19500          long    %12.0g                N19500
a19500          long    %12.0g                A19500
n19530          long    %12.0g                N19530
a19530          long    %12.0g                A19530
n19550          long    %12.0g                N19550
a19550          long    %12.0g                A19550
n19570          long    %12.0g                N19570
a19570          long    %12.0g                A19570
n19700          long    %12.0g                N19700
a19700          long    %12.0g                A19700
n20800          long    %12.0g                N20800
a20800          long    %12.0g                A20800
n20950          long    %12.0g                N20950
a20950          long    %12.0g                A20950
n04800          long    %12.0g                N04800
a04800          long    %12.0g                A04800
n05800          long    %12.0g                N05800
a05800          long    %12.0g                A05800
n09600          long    %12.0g                N09600
a09600          long    %12.0g                A09600
n05780          long    %12.0g                N05780
a05780          long    %12.0g                A05780
n07100          long    %12.0g                N07100
a07100          long    %12.0g                A07100
n07300          long    %12.0g                N07300
a07300          long    %12.0g                A07300
n07180          long    %12.0g                N07180
a07180          long    %12.0g                A07180
n07230          long    %12.0g                N07230
a07230          long    %12.0g                A07230
n07240          long    %12.0g                N07240
a07240          long    %12.0g                A07240
n07220          long    %12.0g                N07220
a07220          long    %12.0g                A07220
n07260          long    %12.0g                N07260
a07260          long    %12.0g                A07260
n09400          long    %12.0g                N09400
a09400          long    %12.0g                A09400
n85770          long    %12.0g                N85770
a85770          long    %12.0g                A85770
n85775          long    %12.0g                N85775
a85775          long    %12.0g                A85775
n09750          long    %12.0g                N09750
a09750          long    %12.0g                A09750
n10600          long    %12.0g                N10600
a10600          long    %12.0g                A10600
n59660          long    %12.0g                N59660
a59660          long    %12.0g                A59660
n59720          long    %12.0g                N59720
a59720          long    %12.0g                A59720
n11070          long    %12.0g                N11070
a11070          long    %12.0g                A11070
n10960          long    %12.0g                N10960
a10960          long    %12.0g                A10960
n11560          long    %12.0g                N11560
a11560          long    %12.0g                A11560
n06500          long    %12.0g                N06500
a06500          long    %12.0g                A06500
n10300          long    %12.0g                N10300
a10300          long    %12.0g                A10300
n85530          long    %12.0g                N85530
a85530          long    %12.0g                A85530
n85300          long    %12.0g                N85300
a85300          long    %12.0g                A85300
n11901          long    %12.0g                N11901
a11901          long    %12.0g                A11901
n11900          long    %12.0g                N11900
a11900          long    %12.0g                A11900
n11902          long    %12.0g                N11902
a11902          long    %12.0g                A11902
n12000          long    %12.0g                N12000
a12000          long    %12.0g                A12000
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
variable agi was long now double
(25,280 real changes made)
variable a_total_inc was long now double
(25,280 real changes made)
variable a_wage was long now double
(24,634 real changes made)
(file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_all_17.dta not
    found)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_all_17.dta saved
(encoding automatically selected: ISO-8859-1)
(154 vars, 25,536 obs)

Contains data
 Observations:        25,536                  
    Variables:           154                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
statefips       byte    %8.0g                 STATEFIP
                                  > S
state           str2    %9s                   STATE
countyfips      int     %8.0g                 COUNTYFI
                                  > PS
countyname      str20   %20s                  COUNTYNA
                                  > ME
agi_stub        byte    %8.0g                 
n1              long    %12.0g                N1
mars1           long    %12.0g                
mars2           long    %12.0g                MARS2
mars4           long    %12.0g                MARS4
elf             long    %12.0g                ELF
cprep           long    %12.0g                CPREP
prep            long    %12.0g                PREP
dir_dep         long    %12.0g                DIR_DEP
n2              long    %12.0g                N2
numdep          long    %12.0g                NUMDEP
total_vita      long    %12.0g                TOTAL_VI
                                  > TA
vita            long    %8.0g                 VITA
tce             long    %8.0g                 TCE
vita_eic        int     %8.0g                 VITA_EIC
rac             long    %12.0g                RAC
elderly         long    %12.0g                ELDERLY
a00100          long    %12.0g                A00100
n02650          long    %12.0g                N02650
a02650          long    %12.0g                A02650
n00200          long    %12.0g                N00200
a00200          long    %12.0g                A00200
n00300          long    %12.0g                N00300
a00300          long    %12.0g                A00300
n00600          long    %12.0g                N00600
a00600          long    %12.0g                A00600
n00650          long    %12.0g                N00650
a00650          long    %12.0g                A00650
n00700          long    %12.0g                N00700
a00700          long    %12.0g                A00700
n00900          long    %12.0g                N00900
a00900          long    %12.0g                A00900
n01000          long    %12.0g                N01000
a01000          long    %12.0g                A01000
n01750          long    %12.0g                N01750
a01750          long    %12.0g                A01750
schf            long    %8.0g                 SCHF
n02300          long    %12.0g                N02300
a02300          long    %12.0g                A02300
n02500          long    %12.0g                N02500
a02500          long    %12.0g                A02500
n26270          long    %12.0g                N26270
a26270          long    %12.0g                A26270
n02900          long    %12.0g                N02900
a02900          long    %12.0g                A02900
n03220          long    %12.0g                N03220
a03220          long    %8.0g                 A03220
n03300          long    %8.0g                 N03300
a03300          long    %12.0g                A03300
n03270          long    %8.0g                 N03270
a03270          long    %12.0g                A03270
n03150          long    %8.0g                 N03150
a03150          long    %12.0g                A03150
n03210          long    %12.0g                N03210
a03210          long    %12.0g                A03210
n04450          long    %12.0g                N04450
a04450          long    %12.0g                A04450
n04100          long    %12.0g                N04100
a04100          long    %12.0g                A04100
n04200          long    %12.0g                N04200
a04200          long    %12.0g                A04200
n04470          long    %12.0g                N04470
a04470          long    %12.0g                A04470
a00101          long    %12.0g                A00101
n17000          long    %8.0g                 N17000
a17000          long    %12.0g                A17000
n18425          long    %12.0g                N18425
a18425          long    %12.0g                A18425
n18450          long    %8.0g                 N18450
a18450          long    %8.0g                 A18450
n18500          long    %12.0g                N18500
a18500          long    %12.0g                A18500
n18800          long    %12.0g                N18800
a18800          long    %8.0g                 A18800
n18460          long    %12.0g                N18460
a18460          long    %12.0g                A18460
n18300          long    %12.0g                N18300
a18300          long    %12.0g                A18300
n19300          long    %12.0g                N19300
a19300          long    %12.0g                A19300
n19500          long    %8.0g                 N19500
a19500          long    %8.0g                 A19500
n19530          long    %8.0g                 N19530
a19530          long    %8.0g                 A19530
n19570          long    %8.0g                 N19570
a19570          long    %12.0g                A19570
n19700          long    %12.0g                N19700
a19700          long    %12.0g                A19700
n20950          long    %8.0g                 N20950
a20950          long    %12.0g                A20950
n04475          long    %12.0g                N04475
a04475          long    %12.0g                A04475
n04800          long    %12.0g                N04800
a04800          long    %12.0g                A04800
n05800          long    %12.0g                N05800
a05800          long    %12.0g                A05800
n09600          long    %8.0g                 N09600
a09600          long    %12.0g                A09600
n05780          long    %8.0g                 N05780
a05780          long    %8.0g                 A05780
n07100          long    %12.0g                N07100
a07100          long    %12.0g                A07100
n07300          long    %12.0g                N07300
a07300          long    %12.0g                A07300
n07180          long    %12.0g                N07180
a07180          long    %12.0g                A07180
n07230          long    %12.0g                N07230
a07230          long    %12.0g                A07230
n07240          long    %12.0g                N07240
a07240          long    %12.0g                A07240
n07225          long    %12.0g                N07225
a07225          long    %12.0g                A07225
n07260          long    %8.0g                 N07260
a07260          long    %8.0g                 A07260
n09400          long    %12.0g                N09400
a09400          long    %12.0g                A09400
n85770          long    %12.0g                N85770
a85770          long    %12.0g                A85770
n85775          long    %12.0g                N85775
a85775          long    %12.0g                A85775
n09750          long    %12.0g                N09750
a09750          long    %8.0g                 A09750
n10600          long    %12.0g                N10600
a10600          long    %12.0g                A10600
n59660          long    %12.0g                N59660
a59660          long    %12.0g                A59660
n59720          long    %12.0g                N59720
a59720          long    %12.0g                A59720
n11070          long    %12.0g                N11070
a11070          long    %12.0g                A11070
n10960          long    %12.0g                N10960
a10960          long    %12.0g                A10960
n11560          long    %8.0g                 N11560
a11560          long    %8.0g                 A11560
n06500          long    %12.0g                N06500
a06500          long    %12.0g                A06500
n10300          long    %12.0g                N10300
a10300          long    %12.0g                A10300
n85530          long    %12.0g                N85530
a85530          long    %12.0g                A85530
n85300          long    %12.0g                N85300
a85300          long    %12.0g                A85300
n11901          long    %12.0g                N11901
a11901          long    %12.0g                A11901
n11900          long    %12.0g                N11900
a11900          long    %12.0g                A11900
n11902          long    %12.0g                N11902
a11902          long    %12.0g                A11902
n12000          long    %12.0g                N12000
a12000          long    %12.0g                A12000
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
variable agi was long now double
(25,325 real changes made)
variable a_total_inc was long now double
(25,325 real changes made)
variable a_wage was long now double
(24,672 real changes made)
(file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_all_18.dta not
    found)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_all_18.dta saved
(encoding automatically selected: ISO-8859-1)
(153 vars, 25,544 obs)

Contains data
 Observations:        25,544                  
    Variables:           153                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
statefips       byte    %8.0g                 STATEFIP
                                  > S
state           str2    %9s                   STATE
countyfips      int     %8.0g                 COUNTYFI
                                  > PS
countyname      str24   %24s                  COUNTYNA
                                  > ME
agi_stub        byte    %8.0g                 
n1              long    %12.0g                N1
mars1           long    %12.0g                
mars2           long    %12.0g                MARS2
mars4           long    %12.0g                MARS4
elf             long    %12.0g                ELF
cprep           long    %12.0g                CPREP
prep            long    %12.0g                PREP
dir_dep         long    %12.0g                DIR_DEP
n2              long    %12.0g                N2
total_vita      long    %12.0g                TOTAL_VI
                                  > TA
vita            long    %12.0g                VITA
tce             int     %8.0g                 TCE
vita_eic        int     %8.0g                 VITA_EIC
rac             long    %12.0g                RAC
elderly         long    %12.0g                ELDERLY
a00100          long    %12.0g                A00100
n02650          long    %12.0g                N02650
a02650          float   %9.0g                 A02650
n00200          long    %12.0g                N00200
a00200          long    %12.0g                A00200
n00300          long    %12.0g                N00300
a00300          long    %12.0g                A00300
n00600          long    %12.0g                N00600
a00600          long    %12.0g                A00600
n00650          long    %12.0g                N00650
a00650          long    %12.0g                A00650
n00700          long    %12.0g                N00700
a00700          long    %12.0g                A00700
n00900          long    %12.0g                N00900
a00900          long    %12.0g                A00900
n01000          long    %12.0g                N01000
a01000          long    %12.0g                A01000
n01400          long    %12.0g                N01400
a01400          long    %12.0g                A01400
n01700          long    %12.0g                N01700
a01700          long    %12.0g                A01700
schf            long    %8.0g                 SCHF
n02300          long    %12.0g                N02300
a02300          long    %12.0g                A02300
n02500          long    %12.0g                N02500
a02500          long    %12.0g                A02500
n26270          long    %12.0g                N26270
a26270          long    %12.0g                A26270
n02900          long    %12.0g                N02900
a02900          long    %12.0g                A02900
n03220          long    %12.0g                N03220
a03220          long    %12.0g                A03220
n03300          long    %12.0g                N03300
a03300          long    %12.0g                A03300
n03270          long    %12.0g                N03270
a03270          long    %12.0g                A03270
n03150          long    %12.0g                N03150
a03150          long    %12.0g                A03150
n03210          long    %12.0g                N03210
a03210          long    %12.0g                A03210
n04450          long    %12.0g                N04450
a04450          long    %12.0g                A04450
n04100          long    %12.0g                N04100
a04100          long    %12.0g                A04100
n04200          long    %12.0g                N04200
a04200          long    %12.0g                A04200
n04470          long    %12.0g                N04470
a04470          long    %12.0g                A04470
a00101          long    %12.0g                A00101
n17000          long    %12.0g                N17000
a17000          long    %12.0g                A17000
n18425          long    %12.0g                N18425
a18425          long    %12.0g                A18425
n18450          long    %12.0g                N18450
a18450          long    %12.0g                A18450
n18500          long    %12.0g                N18500
a18500          long    %12.0g                A18500
n18800          long    %12.0g                N18800
a18800          long    %12.0g                A18800
n18460          long    %12.0g                N18460
a18460          long    %12.0g                A18460
n18300          long    %12.0g                N18300
a18300          long    %12.0g                A18300
n19300          long    %12.0g                N19300
a19300          long    %12.0g                A19300
n19500          long    %12.0g                N19500
a19500          long    %12.0g                A19500
n19530          long    %12.0g                N19530
a19530          long    %12.0g                A19530
n19570          long    %12.0g                N19570
a19570          long    %12.0g                A19570
n19700          long    %12.0g                N19700
a19700          long    %12.0g                A19700
n20950          long    %12.0g                N20950
a20950          long    %12.0g                A20950
n04475          long    %12.0g                N04475
a04475          long    %12.0g                A04475
n04800          long    %12.0g                N04800
a04800          long    %12.0g                A04800
n05800          long    %12.0g                N05800
a05800          long    %12.0g                A05800
n09600          int     %8.0g                 N09600
a09600          long    %12.0g                A09600
n05780          long    %12.0g                N05780
a05780          long    %12.0g                A05780
n07100          long    %12.0g                N07100
a07100          long    %12.0g                A07100
n07300          long    %12.0g                N07300
a07300          long    %12.0g                A07300
n07180          long    %12.0g                N07180
a07180          long    %12.0g                A07180
n07230          long    %12.0g                N07230
a07230          long    %12.0g                A07230
n07240          long    %12.0g                N07240
a07240          long    %12.0g                A07240
n07225          long    %12.0g                N07225
a07225          long    %12.0g                A07225
n07260          long    %12.0g                N07260
a07260          long    %12.0g                A07260
n09400          long    %12.0g                N09400
a09400          long    %12.0g                A09400
n85770          long    %12.0g                N85770
a85770          long    %12.0g                A85770
n85775          long    %12.0g                N85775
a85775          long    %12.0g                A85775
n10600          long    %12.0g                N10600
a10600          long    %12.0g                A10600
n59660          long    %12.0g                N59660
a59660          long    %12.0g                A59660
n59720          long    %12.0g                N59720
a59720          long    %12.0g                A59720
n11070          long    %12.0g                N11070
a11070          long    %12.0g                A11070
n10960          long    %12.0g                N10960
a10960          long    %12.0g                A10960
n11560          long    %12.0g                N11560
a11560          long    %12.0g                A11560
n06500          long    %12.0g                N06500
a06500          long    %12.0g                A06500
n10300          long    %12.0g                N10300
a10300          long    %12.0g                A10300
n85530          long    %12.0g                N85530
a85530          long    %12.0g                A85530
n85300          long    %12.0g                N85300
a85300          long    %12.0g                A85300
n11901          long    %12.0g                N11901
a11901          long    %12.0g                A11901
n11900          long    %12.0g                N11900
a11900          long    %12.0g                A11900
n11902          long    %12.0g                N11902
a11902          long    %12.0g                A11902
n12000          long    %12.0g                N12000
a12000          long    %12.0g                A12000
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
variable agi was long now double
(25,363 real changes made)
(25,363 real changes made)
variable a_wage was long now double
(24,724 real changes made)
(file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_all_19.dta not
    found)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_all_19.dta saved
(encoding automatically selected: ISO-8859-1)
(166 vars, 25,545 obs)

Contains data
 Observations:        25,545                  
    Variables:           166                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
statefips       byte    %8.0g                 STATEFIP
                                  > S
state           str2    %9s                   STATE
countyfips      int     %8.0g                 COUNTYFI
                                  > PS
countyname      str20   %20s                  COUNTYNA
                                  > ME
agi_stub        byte    %8.0g                 
n1              long    %12.0g                N1
mars1           long    %12.0g                
mars2           long    %12.0g                MARS2
mars4           long    %12.0g                MARS4
elf             long    %12.0g                ELF
cprep           long    %8.0g                 CPREP
prep            long    %12.0g                PREP
dir_dep         long    %12.0g                DIR_DEP
vrtcrind        long    %8.0g                 VRTCRIND
n2              long    %12.0g                N2
total_vita      long    %8.0g                 TOTAL_VI
                                  > TA
vita            long    %8.0g                 VITA
tce             int     %8.0g                 TCE
vita_eic        int     %8.0g                 VITA_EIC
rac             long    %12.0g                RAC
elderly         long    %12.0g                ELDERLY
a00100          long    %12.0g                A00100
n02650          long    %12.0g                N02650
a02650          float   %9.0g                 A02650
n00200          long    %12.0g                N00200
a00200          long    %12.0g                A00200
n00300          long    %12.0g                N00300
a00300          long    %12.0g                A00300
n00600          long    %12.0g                N00600
a00600          long    %12.0g                A00600
n00650          long    %12.0g                N00650
a00650          long    %12.0g                A00650
n00700          long    %12.0g                N00700
a00700          long    %12.0g                A00700
n00900          long    %12.0g                N00900
a00900          long    %12.0g                A00900
n01000          long    %12.0g                N01000
a01000          long    %12.0g                A01000
n01400          long    %12.0g                N01400
a01400          long    %12.0g                A01400
n01700          long    %12.0g                N01700
a01700          long    %12.0g                A01700
schf            float   %9.0g                 SCHF
n02300          long    %12.0g                N02300
a02300          long    %12.0g                A02300
n02500          long    %12.0g                N02500
a02500          long    %12.0g                A02500
n26270          long    %12.0g                N26270
a26270          long    %12.0g                A26270
n02900          long    %12.0g                N02900
a02900          long    %12.0g                A02900
n03220          long    %12.0g                N03220
a03220          long    %8.0g                 A03220
n03300          long    %8.0g                 N03300
a03300          long    %12.0g                A03300
n03270          long    %8.0g                 N03270
a03270          long    %12.0g                A03270
n03150          long    %8.0g                 N03150
a03150          long    %12.0g                A03150
n03210          long    %12.0g                N03210
a03210          long    %12.0g                A03210
n02910          long    %12.0g                N02910
a02910          long    %12.0g                A02910
n04450          long    %12.0g                N04450
a04450          long    %12.0g                A04450
n04100          long    %12.0g                N04100
a04100          long    %12.0g                A04100
n04200          long    %12.0g                N04200
a04200          long    %12.0g                A04200
n04470          long    %12.0g                N04470
a04470          long    %12.0g                A04470
a00101          long    %12.0g                A00101
n17000          long    %8.0g                 N17000
a17000          long    %12.0g                A17000
n18425          long    %12.0g                N18425
a18425          long    %12.0g                A18425
n18450          long    %8.0g                 N18450
a18450          long    %8.0g                 A18450
n18500          long    %12.0g                N18500
a18500          long    %12.0g                A18500
n18800          long    %12.0g                N18800
a18800          long    %8.0g                 A18800
n18460          long    %12.0g                N18460
a18460          long    %12.0g                A18460
n18300          long    %12.0g                N18300
a18300          long    %12.0g                A18300
n19300          long    %12.0g                N19300
a19300          long    %12.0g                A19300
n19500          int     %8.0g                 N19500
a19500          long    %8.0g                 A19500
n19530          long    %8.0g                 N19530
a19530          long    %8.0g                 A19530
n19550          long    %8.0g                 N19550
a19550          long    %8.0g                 A19550
n19570          long    %8.0g                 N19570
a19570          long    %12.0g                A19570
n19700          long    %12.0g                N19700
a19700          long    %12.0g                A19700
n20950          long    %8.0g                 N20950
a20950          long    %12.0g                A20950
n04475          long    %12.0g                N04475
a04475          long    %12.0g                A04475
n04800          long    %12.0g                N04800
a04800          long    %12.0g                A04800
n05800          long    %12.0g                N05800
a05800          long    %12.0g                A05800
n09600          int     %8.0g                 N09600
a09600          long    %8.0g                 A09600
n05780          long    %8.0g                 N05780
a05780          long    %8.0g                 A05780
n07100          long    %12.0g                N07100
a07100          long    %12.0g                A07100
n07300          long    %12.0g                N07300
a07300          long    %12.0g                A07300
n07180          long    %12.0g                N07180
a07180          long    %8.0g                 A07180
n07230          long    %12.0g                N07230
a07230          long    %12.0g                A07230
n07240          long    %12.0g                N07240
a07240          long    %12.0g                A07240
n07225          long    %12.0g                N07225
a07225          long    %12.0g                A07225
n07260          long    %8.0g                 N07260
a07260          long    %8.0g                 A07260
n09400          long    %12.0g                N09400
a09400          long    %12.0g                A09400
n85770          long    %8.0g                 N85770
a85770          long    %12.0g                A85770
n85775          long    %8.0g                 N85775
a85775          long    %12.0g                A85775
n10600          long    %12.0g                N10600
a10600          long    %12.0g                A10600
n59660          long    %12.0g                N59660
a59660          long    %12.0g                A59660
n59720          long    %12.0g                N59720
a59720          long    %12.0g                A59720
n11070          long    %12.0g                N11070
a11070          long    %12.0g                A11070
n10960          long    %12.0g                N10960
a10960          long    %12.0g                A10960
n11560          long    %8.0g                 N11560
a11560          long    %8.0g                 A11560
n11450          long    %8.0g                 N11450
a11450          long    %8.0g                 A11450
n10970          long    %12.0g                N10970
a10970          long    %12.0g                A10970
n10971          long    %12.0g                N10971
a10971          long    %12.0g                A10971
n10973          long    %12.0g                N10973
a10973          long    %12.0g                A10973
n06500          long    %12.0g                N06500
a06500          long    %12.0g                A06500
n10300          long    %12.0g                N10300
a10300          long    %12.0g                A10300
n85530          long    %12.0g                N85530
a85530          long    %12.0g                A85530
n85300          long    %12.0g                N85300
a85300          long    %12.0g                A85300
n11901          long    %12.0g                N11901
a11901          long    %12.0g                A11901
n11900          long    %12.0g                N11900
a11900          long    %12.0g                A11900
n11902          long    %12.0g                N11902
a11902          long    %12.0g                A11902
n12000          long    %12.0g                N12000
a12000          long    %12.0g                A12000
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
variable agi was long now double
(25,410 real changes made)
(25,410 real changes made)
variable a_wage was long now double
(24,896 real changes made)
(file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_all_20.dta not
    found)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_all_20.dta saved
(encoding automatically selected: ISO-8859-1)
(168 vars, 25,552 obs)

Contains data
 Observations:        25,552                  
    Variables:           168                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
statefips       byte    %8.0g                 STATEFIP
                                  > S
state           str2    %9s                   STATE
countyfips      int     %8.0g                 COUNTYFI
                                  > PS
countyname      str20   %20s                  COUNTYNA
                                  > ME
agi_stub        byte    %8.0g                 
n1              long    %12.0g                N1
mars1           long    %12.0g                
mars2           long    %12.0g                MARS2
mars4           long    %12.0g                MARS4
elf             long    %12.0g                ELF
cprep           long    %8.0g                 CPREP
prep            long    %12.0g                PREP
dir_dep         long    %12.0g                DIR_DEP
vrtcrind        long    %8.0g                 VRTCRIND
n2              long    %12.0g                N2
total_vita      long    %8.0g                 TOTAL_VI
                                  > TA
vita            long    %8.0g                 VITA
tce             int     %8.0g                 TCE
vita_eic        int     %8.0g                 VITA_EIC
rac             long    %12.0g                RAC
elderly         long    %12.0g                ELDERLY
a00100          long    %12.0g                A00100
n02650          long    %12.0g                N02650
a02650          float   %9.0g                 A02650
n00200          long    %12.0g                N00200
a00200          long    %12.0g                A00200
n00300          long    %12.0g                N00300
a00300          long    %12.0g                A00300
n00600          long    %12.0g                N00600
a00600          long    %12.0g                A00600
n00650          long    %12.0g                N00650
a00650          long    %12.0g                A00650
n00700          long    %8.0g                 N00700
a00700          long    %12.0g                A00700
n00900          long    %12.0g                N00900
a00900          long    %12.0g                A00900
n01000          long    %12.0g                N01000
a01000          long    %12.0g                A01000
n01400          long    %12.0g                N01400
a01400          long    %12.0g                A01400
n01700          long    %12.0g                N01700
a01700          long    %12.0g                A01700
schf            float   %9.0g                 SCHF
n02300          long    %12.0g                N02300
a02300          long    %12.0g                A02300
n02500          long    %12.0g                N02500
a02500          long    %12.0g                A02500
n26270          long    %12.0g                N26270
a26270          long    %12.0g                A26270
n02900          long    %12.0g                N02900
a02900          long    %12.0g                A02900
n03220          long    %8.0g                 N03220
a03220          long    %8.0g                 A03220
n03300          long    %8.0g                 N03300
a03300          long    %12.0g                A03300
n03270          long    %8.0g                 N03270
a03270          long    %12.0g                A03270
n03150          long    %8.0g                 N03150
a03150          long    %12.0g                A03150
n03210          long    %8.0g                 N03210
a03210          long    %8.0g                 A03210
n02910          long    %12.0g                N02910
a02910          long    %12.0g                A02910
n04450          long    %12.0g                N04450
a04450          long    %12.0g                A04450
n04100          long    %12.0g                N04100
a04100          long    %12.0g                A04100
n04200          long    %12.0g                N04200
a04200          long    %12.0g                A04200
n04470          long    %12.0g                N04470
a04470          long    %12.0g                A04470
a00101          long    %12.0g                A00101
n17000          long    %8.0g                 N17000
a17000          long    %12.0g                A17000
n18425          long    %12.0g                N18425
a18425          long    %12.0g                A18425
n18450          long    %8.0g                 N18450
a18450          long    %8.0g                 A18450
n18500          long    %12.0g                N18500
a18500          long    %12.0g                A18500
n18800          long    %8.0g                 N18800
a18800          long    %8.0g                 A18800
n18460          long    %12.0g                N18460
a18460          long    %12.0g                A18460
n18300          long    %12.0g                N18300
a18300          long    %12.0g                A18300
n19300          long    %12.0g                N19300
a19300          long    %12.0g                A19300
n19500          int     %8.0g                 N19500
a19500          long    %8.0g                 A19500
n19530          long    %8.0g                 N19530
a19530          long    %8.0g                 A19530
n19550          long    %8.0g                 N19550
a19550          long    %8.0g                 A19550
n19570          long    %8.0g                 N19570
a19570          long    %12.0g                A19570
n19700          long    %12.0g                N19700
a19700          long    %12.0g                A19700
n20950          long    %8.0g                 N20950
a20950          long    %12.0g                A20950
n04475          long    %12.0g                N04475
a04475          long    %12.0g                A04475
n04800          long    %12.0g                N04800
a04800          long    %12.0g                A04800
n05800          long    %12.0g                N05800
a05800          long    %12.0g                A05800
n09600          long    %8.0g                 N09600
a09600          long    %8.0g                 A09600
n05780          long    %8.0g                 N05780
a05780          long    %8.0g                 A05780
n07100          long    %12.0g                N07100
a07100          long    %12.0g                A07100
n07300          long    %8.0g                 N07300
a07300          long    %12.0g                A07300
n07180          int     %8.0g                 N07180
a07180          long    %8.0g                 A07180
n07230          long    %12.0g                N07230
a07230          long    %12.0g                A07230
n07240          long    %12.0g                N07240
a07240          long    %8.0g                 A07240
n07225          long    %12.0g                N07225
a07225          long    %8.0g                 A07225
n07260          long    %8.0g                 N07260
a07260          long    %8.0g                 A07260
n09400          long    %12.0g                N09400
a09400          long    %12.0g                A09400
n85770          long    %12.0g                N85770
a85770          long    %12.0g                A85770
n85775          long    %12.0g                N85775
a85775          long    %12.0g                A85775
n10600          long    %12.0g                N10600
a10600          long    %12.0g                A10600
n59660          long    %12.0g                N59660
a59660          long    %12.0g                A59660
n59720          long    %12.0g                N59720
a59720          long    %12.0g                A59720
n11070          long    %12.0g                N11070
a11070          long    %12.0g                A11070
n10960          long    %8.0g                 N10960
a10960          long    %8.0g                 A10960
n11560          long    %8.0g                 N11560
a11560          long    %8.0g                 A11560
n11450          long    %8.0g                 N11450
a11450          long    %12.0g                A11450
n11520          long    %8.0g                 N11520
a11520          long    %12.0g                A11520
n11530          long    %8.0g                 N11530
a11530          long    %12.0g                A11530
n10970          long    %12.0g                N10970
a10970          long    %12.0g                A10970
n10971          long    %12.0g                N10971
a10971          long    %12.0g                A10971
n06500          long    %12.0g                N06500
a06500          long    %12.0g                A06500
n10300          long    %12.0g                N10300
a10300          long    %12.0g                A10300
n85530          long    %12.0g                N85530
a85530          long    %12.0g                A85530
n85300          long    %12.0g                N85300
a85300          long    %12.0g                A85300
n11901          long    %12.0g                N11901
a11901          long    %12.0g                A11901
n11900          long    %12.0g                N11900
a11900          long    %12.0g                A11900
n11902          long    %12.0g                N11902
a11902          long    %12.0g                A11902
n12000          long    %8.0g                 N12000
a12000          long    %12.0g                A12000
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
variable agi was long now double
(25,456 real changes made)
(25,456 real changes made)
variable a_wage was long now double
(24,659 real changes made)
(file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_all_21.dta not
    found)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_all_21.dta saved
(encoding automatically selected: ISO-8859-1)
(166 vars, 25,552 obs)

Contains data
 Observations:        25,552                  
    Variables:           166                  
------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable
>  label
------------------------------------------------------
statefips       byte    %8.0g                 STATEFIP
                                  > S
state           str2    %9s                   STATE
countyfips      int     %8.0g                 COUNTYFI
                                  > PS
countyname      str20   %20s                  COUNTYNA
                                  > ME
agi_stub        byte    %8.0g                 
n1              long    %12.0g                N1
mars1           long    %12.0g                
mars2           long    %12.0g                MARS2
mars4           long    %12.0g                MARS4
elf             long    %12.0g                ELF
cprep           long    %8.0g                 CPREP
prep            long    %12.0g                PREP
dir_dep         long    %12.0g                DIR_DEP
vrtcrind        long    %8.0g                 VRTCRIND
n2              long    %12.0g                N2
total_vita      long    %8.0g                 TOTAL_VI
                                  > TA
vita            long    %8.0g                 VITA
tce             int     %8.0g                 TCE
vita_eic        int     %8.0g                 VITA_EIC
rac             long    %12.0g                RAC
elderly         long    %12.0g                ELDERLY
a00100          long    %12.0g                A00100
n02650          long    %12.0g                N02650
a02650          long    %12.0g                A02650
n00200          long    %12.0g                N00200
a00200          long    %12.0g                A00200
n00300          long    %12.0g                N00300
a00300          long    %12.0g                A00300
n00400          long    %8.0g                 N00400
a00400          long    %12.0g                A00400
n00600          long    %12.0g                N00600
a00600          long    %12.0g                A00600
n00650          long    %12.0g                N00650
a00650          long    %12.0g                A00650
n00700          long    %8.0g                 N00700
a00700          long    %8.0g                 A00700
n00900          long    %12.0g                N00900
a00900          long    %12.0g                A00900
n01000          long    %12.0g                N01000
a01000          long    %12.0g                A01000
n01400          long    %12.0g                N01400
a01400          long    %12.0g                A01400
n01700          long    %12.0g                N01700
a01700          long    %12.0g                A01700
schf            long    %8.0g                 SCHF
n02300          long    %8.0g                 N02300
a02300          long    %12.0g                A02300
n02500          long    %12.0g                N02500
a02500          long    %12.0g                A02500
n26270          long    %12.0g                N26270
a26270          long    %12.0g                A26270
n25870          long    %8.0g                 N25870
a25870          long    %12.0g                A25870
n02900          long    %12.0g                N02900
a02900          long    %12.0g                A02900
n03220          long    %8.0g                 N03220
a03220          long    %8.0g                 A03220
n03300          long    %8.0g                 N03300
a03300          long    %12.0g                A03300
n03270          long    %8.0g                 N03270
a03270          long    %12.0g                A03270
n03150          long    %8.0g                 N03150
a03150          long    %12.0g                A03150
n03210          long    %8.0g                 N03210
a03210          long    %8.0g                 A03210
n04450          long    %12.0g                N04450
a04450          long    %12.0g                A04450
n04100          long    %12.0g                N04100
a04100          long    %12.0g                A04100
n04200          long    %12.0g                N04200
a04200          long    %12.0g                A04200
n04470          long    %12.0g                N04470
a04470          long    %12.0g                A04470
a00101          long    %12.0g                A00101
n17000          long    %8.0g                 N17000
a17000          long    %12.0g                A17000
n18425          long    %12.0g                N18425
a18425          long    %12.0g                A18425
n18450          long    %8.0g                 N18450
a18450          long    %8.0g                 A18450
n18500          long    %12.0g                N18500
a18500          long    %12.0g                A18500
n18800          long    %12.0g                N18800
a18800          long    %8.0g                 A18800
n18460          long    %12.0g                N18460
a18460          long    %12.0g                A18460
n18300          long    %12.0g                N18300
a18300          long    %12.0g                A18300
n19300          long    %12.0g                N19300
a19300          long    %12.0g                A19300
n19500          int     %8.0g                 N19500
a19500          long    %8.0g                 A19500
n19530          long    %8.0g                 N19530
a19530          long    %8.0g                 A19530
n19570          long    %8.0g                 N19570
a19570          long    %12.0g                A19570
n19700          long    %12.0g                N19700
a19700          long    %12.0g                A19700
n20950          long    %8.0g                 N20950
a20950          long    %12.0g                A20950
n04475          long    %12.0g                N04475
a04475          long    %12.0g                A04475
n04800          long    %12.0g                N04800
a04800          long    %12.0g                A04800
n05800          long    %12.0g                N05800
a05800          long    %12.0g                A05800
n09600          int     %8.0g                 N09600
a09600          long    %8.0g                 A09600
n05780          long    %8.0g                 N05780
a05780          long    %8.0g                 A05780
n07100          long    %12.0g                N07100
a07100          long    %12.0g                A07100
n07300          long    %8.0g                 N07300
a07300          long    %12.0g                A07300
n07180          long    %8.0g                 N07180
a07180          long    %8.0g                 A07180
n07230          long    %12.0g                N07230
a07230          long    %12.0g                A07230
n07240          long    %12.0g                N07240
a07240          long    %8.0g                 A07240
n07225          long    %12.0g                N07225
a07225          long    %12.0g                A07225
n07260          long    %8.0g                 N07260
a07260          long    %8.0g                 A07260
n09400          long    %12.0g                N09400
a09400          long    %12.0g                A09400
n85770          long    %12.0g                N85770
a85770          long    %12.0g                A85770
n85775          long    %12.0g                N85775
a85775          long    %12.0g                A85775
n10600          long    %12.0g                N10600
a10600          long    %12.0g                A10600
n59660          long    %12.0g                N59660
a59660          long    %12.0g                A59660
n59661          long    %12.0g                N59661
a59661          long    %8.0g                 A59661
n59662          long    %12.0g                N59662
a59662          long    %12.0g                A59662
n59663          long    %12.0g                N59663
a59663          long    %12.0g                A59663
n59664          long    %8.0g                 N59664
a59664          long    %12.0g                A59664
n59720          long    %12.0g                N59720
a59720          long    %12.0g                A59720
n11070          long    %12.0g                N11070
a11070          long    %12.0g                A11070
n10960          long    %8.0g                 N10960
a10960          long    %8.0g                 A10960
n11560          long    %8.0g                 N11560
a11560          long    %8.0g                 A11560
n06500          long    %12.0g                N06500
a06500          long    %12.0g                A06500
n10300          long    %12.0g                N10300
a10300          long    %12.0g                A10300
n85530          long    %12.0g                N85530
a85530          long    %12.0g                A85530
n85300          long    %12.0g                N85300
a85300          long    %12.0g                A85300
n11901          long    %12.0g                N11901
a11901          long    %12.0g                A11901
n11900          long    %12.0g                N11900
a11900          long    %12.0g                A11900
n11902          long    %12.0g                N11902
a11902          long    %12.0g                A11902
n12000          long    %8.0g                 N12000
a12000          long    %12.0g                A12000
------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
variable agi was long now double
(25,400 real changes made)
variable a_total_inc was long now double
(25,400 real changes made)
variable a_wage was long now double
(24,693 real changes made)
(file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_all_22.dta not
    found)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_all_22.dta saved

. 
. ** Append data 
. 
. ** Loop over years 
. forvalues y = 15(1)22 {
  2. 
.         ** Append 
.         append using "${data}working/irs_county_all_
> `y'"
  3.                 
.         } // END YEAR LOOP 
(variable county_name was str20, now str24 to
       accommodate using data's values)

.         
. ** Save file 
. save "${data}working/irs_county_all", replace 
(file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_all.dta not
    found)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_all.dta saved

.         
. ** Generate fips variable
. make_fips state_fips county_fips, gen(fips)

. 
. ** Save file 
. save "${data}working/irs_county_all", replace 
file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/data/working/irs_county_all.dta saved

. 
. ** Close log
. log close log_01
      name:  log_01
       log:  C:/Users/ji252/Documents/GitHub/multnomah
> -county-tax/code/logs/01_log_data_clean_multnomah_20
> 25-12-15.log
  log type:  text
 closed on:  15 Dec 2025, 18:08:04
------------------------------------------------------

. 
end of do-file

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_00001t
> .tmp"

. 
. ** Start log file 
. capture log close log_02

. log using "${logs}02_log_individual_${date}", replac
> e text name(log_02)
(file
    C:/Users/ji252/Documents/GitHub/multnomah-county
    > -tax/code/logs/02_log_individual_2025-12-15.lo
    > g not found)
------------------------------------------------------
      name:  log_02
       log:  C:/Users/ji252/Documents/GitHub/multnomah
> -county-tax/code/logs/02_log_individual_2025-12-15.l
> og
  log type:  text
 opened on:  15 Dec 2025, 20:50:45

. 
. ** Define regression + plotting function 
. capture program drop hdfe_catyear_plot

. program define hdfe_catyear_plot
  1.     version 16.0
  2.     syntax varname(numeric) [if] [in] [fw aw pw i
> w] , ///
>         CAT(varname) YEAR(varname) ABSORB(string) //
> /
>         [ SAMPLE(varname) SVAL(real 1) ///
>           WVAR(varname) WTYPE(string) ///
>           VCE(string) ///
>           TITLE(string asis) XTITLE(string asis) YTI
> TLE(string asis) ///
>           NOCI ///
>           SAVING(string asis) REPLACE ]
  3. 
.     // ---------------------------------------------
> ------------------------
.     // Requirements
.     // ---------------------------------------------
> ------------------------
.     capture which reghdfe
  4.     if _rc {
  5.         di as error "reghdfe not found. Install w
> ith: ssc install reghdfe, replace"
  6.         exit 198
  7.     }
  8.     capture which coefplot
  9.     if _rc {
 10.         di as error "coefplot not found. Install 
> with: ssc install coefplot, replace"
 11.         exit 198
 12.     }
 13. 
.     // ---------------------------------------------
> ------------------------
.     // Mark sample
.     // ---------------------------------------------
> ------------------------
.     marksample touse, strok
 14.     quietly replace `touse' = `touse' & !missing(
> `varlist', `cat', `year')
 15. 
.     if "`sample'" != "" {
 16.         quietly replace `touse' = `touse' & (`sam
> ple' == `sval')
 17.     }
 18. 
.     // ---------------------------------------------
> ------------------------
.     // Handle weights: if user didn't pass [pw/fw/..
> .], default to fw=perwt
.     // ---------------------------------------------
> ------------------------
.     local wgt ""
 19.     if "`weight'" != "" {
 20.         local wgt "[`weight'=`exp']"
 21.     }
 22.     else {
 23.         if "`wvar'" == "" local wvar "perwt"
 24.         if "`wtype'" == "" local wtype "fw"
 25.         capture confirm variable `wvar'
 26.         if _rc {
 27.             di as error "Default weight variable 
> `wvar' not found. Either create it or pass weights e
> xplicitly."
 28.             exit 111
 29.         }
 30.         local wgt "[`wtype'=`wvar']"
 31.     }
 32. 
.     // ---------------------------------------------
> ------------------------
.     // Ensure cat/year are numeric factor-friendly. 
> Encode/destring if needed.
.     // ---------------------------------------------
> ------------------------
.     tempvar __cat __year
 33. 
.     local cattype : type `cat'
 34.     if substr("`cattype'",1,3) == "str" {
 35.         quietly encode `cat' if `touse', gen(`__c
> at')
 36.         local catv `__cat'
 37.     }
 38.     else {
 39.         local catv `cat'
 40.     }
 41. 
.     local yeartype : type `year'
 42.     if substr("`yeartype'",1,3) == "str" {
 43.         // attempt to destring; if it fails, we e
> xit
.         quietly destring `year' if `touse', gen(`__y
> ear') force
 44.         capture assert !missing(`__year') if `tou
> se'
 45.         if _rc {
 46.             di as error "Year variable is string 
> and could not be cleanly converted to numeric."
 47.             exit 459
 48.         }
 49.         local yearv `__year'
 50.     }
 51.     else {
 52.         local yearv `year'
 53.     }
 54. 
.     // ---------------------------------------------
> ------------------------
.     // Levels for plotting
.     // ---------------------------------------------
> ------------------------
.     quietly levelsof `yearv' if `touse', local(yrs)
 55.     quietly levelsof `catv'  if `touse', local(ca
> ts)
 56. 
.     if "`yrs'" == "" | "`cats'" == "" {
 57.         di as error "No observations available af
> ter applying if/in/sample filters."
 58.         exit 2000
 59.     }
 60. 
.     // Build x-axis positions and labels
.     local poslist ""
 61.     local xlabel  ""
 62.     local k = 0
 63.     foreach y of local yrs {
 64.         local ++k
 65.         local poslist `poslist' `k'
 66.         local xlabel  `xlabel'  `k' "`y'"
 67.     }
 68. 
.     // ---------------------------------------------
> ------------------------
.     // Regression: fully interacted cells (cat#year)
>  + absorbed FEs, no constant
.     // Coefficients are adjusted means for each (cat
> ,year) cell conditional on FEs
.     // ---------------------------------------------
> ------------------------
.     quietly reghdfe `varlist' i.`catv'#i.`yearv' if 
> `touse' `wgt', ///
>         absorb(`absorb') vce(`=cond("`vce'"=="","rob
> ust","`vce'")') nocons
 69. 
.     estimates store __hdfe_catyear_plot
 70. 
.     // ---------------------------------------------
> ------------------------
.     // Build coefplot specs: one line per category l
> evel, aligned by year
.     // ---------------------------------------------
> ------------------------
.     local plotspecs ""
 71.     local vlab : value label `catv'
 72. 
.     foreach c of local cats {
 73.         // series label: value label if it exists
> , else cat=value
.         local serieslab "`cat'=`c'"
 74.         if "`vlab'" != "" {
 75.             local tmp : label `vlab' `c'
 76.             if "`tmp'" != "" local serieslab "`tm
> p'"
 77.         }
 78. 
.         // Coefs in year order for this category lev
> el
.         local keepc ""
 79.         foreach y of local yrs {
 80.             // coefficient name format: <c>.<catv
> >#<y>.<yearv>
.             local keepc `keepc' `c'.`catv'#`y'.`year
> v'
 81.         }
 82. 
.         // CI display control
.         local ciopt ""
 83.         if "`noci'" != "" local ciopt "noci"
 84. 
.         local plotspecs `plotspecs' ///
>             (., keep(`keepc') order(`keepc') at(`pos
> list') label("`serieslab'") `ciopt')
 85.     }
 86. 
.     // ---------------------------------------------
> ------------------------
.     // Plot
.     // ---------------------------------------------
> ------------------------
.     if "`xtitle'" == "" local xtitle "Year"
 87.     if "`ytitle'" == "" local ytitle "`varlist' (
> adjusted mean)"
 88.     if "`title'"  == "" local title  "`varlist' b
> y `cat' over `year'"
 89. 
.     coefplot `plotspecs', ///
>         vertical ///
>         xlabel(`xlabel', angle(45)) ///
>         xtitle("`xtitle'") ///
>         ytitle("`ytitle'") ///
>         title("`title'") ///
>         legend(cols(1) position(3) ring(0))
 90. 
.     // Save graph if requested (expects a .gph path)
.     if "`saving'" != "" {
 91.         graph save "`saving'" , `replace'
 92.     }
 93. end

. 
. 
. ** Load ACS Data 
. use "${data}working/acs_migration_file", replace 

. 
end of do-file

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_00001u
> .tmp"

. 
. ** Define sample 
. drop if qmigplc1 == 4                               
>     // FAILED EDIT OF MIGPLACE 
(388,364 observations deleted)

. drop if inlist(state_fips_o, 2, 15)     // ALASKA AN
> D HAWAII 
(136,571 observations deleted)

. 
end of do-file

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_00001v
> .tmp"

. 
. ** Define indicator for being in Multnomah County in
>  origin/destination year
. gen multnomah_o = state_fips_o == 41 & county_fips_o
>  == 51

. gen multnomah_d = state_fips_d == 41 & county_fips_d
>  == 51

. 
. ** Define samples 
. gen sample_1 = multnomah_o == 1                     
>             // Multnomah in origin-year 

. gen sample_2 = multnomah_o != 1                     
>             // Not in Multnomah

. label var sample_1 "Out-migration Sample"

. label var sample_1 "In-migration Sample"

. 
. ** Define moving indicator 
. gen out_1 = same_county == 0 

. label var mover "Moved out of Multnomah"
variable mover not found
r(111);

end of do-file

r(111);

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_00001w
> .tmp"

. label var out_1 "Moved out of Multnomah"

. 
end of do-file

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_00001x
> .tmp"

. label var out_2 "Moved to Multnomah"
variable out_2 not found
r(111);

end of do-file

r(111);

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_000020
> .tmp"

. gen out_2 = multnomah_d == 1 

. label var out_2 "Moved to Multnomah"

. 
end of do-file

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_000021
> .tmp"

. 
. ** Age 
. recode age      (18/24 = 1 "18-24")     ///
>                         (25/44 = 2 "25-44")         
>     ///
>                         (45/64 = 3 "45-64")     ///
>                         (65/max = 4 "65+"),     ///
>         gen(cat_age)
(20,893,859 differences between age and cat_age)

. 
end of do-file

. tab nchild

     nchild |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 | 13,403,951       64.15       64.15
          1 |  3,599,170       17.23       81.38
          2 |  2,521,868       12.07       93.45
          3 |    955,950        4.58       98.02
          4 |    290,314        1.39       99.41
          5 |     78,840        0.38       99.79
          6 |     25,815        0.12       99.91
          7 |      9,584        0.05       99.96
          8 |      4,571        0.02       99.98
          9 |      3,796        0.02      100.00
------------+-----------------------------------
      Total | 20,893,859      100.00

. fre educ

educ
------------------------------------------------------
> -----
              |      Freq.    Percent      Valid      
>  Cum.
--------------+---------------------------------------
> -----
Valid   0     |     313383       1.50       1.50      
>  1.50
        1     |      92645       0.44       0.44      
>  1.94
        2     |     424739       2.03       2.03      
>  3.98
        3     |     216851       1.04       1.04      
>  5.01
        4     |     281709       1.35       1.35      
>  6.36
        5     |     402154       1.92       1.92      
>  8.29
        6     |    7509366      35.94      35.94      
> 44.23
        7     |    2896522      13.86      13.86      
> 58.09
        8     |    1810664       8.67       8.67      
> 66.76
        10    |    4229990      20.25      20.25      
> 87.00
        11    |    2715836      13.00      13.00     1
> 00.00
        Total |   2.09e+07     100.00     100.00      
>      
------------------------------------------------------
> -----

. fre educ

educ
------------------------------------------------------
> -----
              |      Freq.    Percent      Valid      
>  Cum.
--------------+---------------------------------------
> -----
Valid   0     |     313383       1.50       1.50      
>  1.50
        1     |      92645       0.44       0.44      
>  1.94
        2     |     424739       2.03       2.03      
>  3.98
        3     |     216851       1.04       1.04      
>  5.01
        4     |     281709       1.35       1.35      
>  6.36
        5     |     402154       1.92       1.92      
>  8.29
        6     |    7509366      35.94      35.94      
> 44.23
        7     |    2896522      13.86      13.86      
> 58.09
        8     |    1810664       8.67       8.67      
> 66.76
        10    |    4229990      20.25      20.25      
> 87.00
        11    |    2715836      13.00      13.00     1
> 00.00
        Total |   2.09e+07     100.00     100.00      
>      
------------------------------------------------------
> -----

. fre educd

educd
-----------------------------------------------------------
              |      Freq.    Percent      Valid       Cum.
--------------+--------------------------------------------
Valid   2     |     313383       1.50       1.50       1.50
        11    |       4546       0.02       0.02       1.52
        12    |       4601       0.02       0.02       1.54
        14    |       7602       0.04       0.04       1.58
        15    |      15386       0.07       0.07       1.65
        16    |      34436       0.16       0.16       1.82
        17    |      26074       0.12       0.12       1.94
        22    |      39865       0.19       0.19       2.13
        23    |     143780       0.69       0.69       2.82
        25    |      55981       0.27       0.27       3.09
        26    |     185113       0.89       0.89       3.98
        30    |     216851       1.04       1.04       5.01
        40    |     281709       1.35       1.35       6.36
        50    |     402154       1.92       1.92       8.29
        61    |     409986       1.96       1.96      10.25
        63    |    4845113      23.19      23.19      33.44
        64    |     785936       3.76       3.76      37.20
        65    |    1468331       7.03       7.03      44.23
        71    |    2896522      13.86      13.86      58.09
        81    |    1810664       8.67       8.67      66.76
        101   |    4229990      20.25      20.25      87.00
        114   |    1926918       9.22       9.22      96.22
        115   |     465449       2.23       2.23      98.45
        116   |     323469       1.55       1.55     100.00
        Total |   2.09e+07     100.00     100.00           
-----------------------------------------------------------

. tab educ

       educ |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |    313,383        1.50        1.50
          1 |     92,645        0.44        1.94
          2 |    424,739        2.03        3.98
          3 |    216,851        1.04        5.01
          4 |    281,709        1.35        6.36
          5 |    402,154        1.92        8.29
          6 |  7,509,366       35.94       44.23
          7 |  2,896,522       13.86       58.09
          8 |  1,810,664        8.67       66.76
         10 |  4,229,990       20.25       87.00
         11 |  2,715,836       13.00      100.00
------------+-----------------------------------
      Total | 20,893,859      100.00

. 
. tab pwstate2

   pwstate2 |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |  8,667,511       41.48       41.48
          1 |    166,095        0.79       42.28
          2 |      1,438        0.01       42.29
          4 |    242,659        1.16       43.45
          5 |    104,035        0.50       43.94
          6 |  1,449,455        6.94       50.88
          8 |    234,375        1.12       52.00
          9 |    141,545        0.68       52.68
         10 |     35,355        0.17       52.85
         11 |     64,271        0.31       53.16
         12 |    723,920        3.46       56.62
         13 |    371,335        1.78       58.40
         15 |      1,916        0.01       58.41
         16 |     61,759        0.30       58.70
         17 |    502,955        2.41       61.11
         18 |    256,278        1.23       62.34
         19 |    133,931        0.64       62.98
         20 |    119,106        0.57       63.55
         21 |    162,601        0.78       64.33
         22 |    153,357        0.73       65.06
         23 |     50,331        0.24       65.30
         24 |    231,172        1.11       66.41
         25 |    296,267        1.42       67.83
         26 |    369,250        1.77       69.59
         27 |    235,456        1.13       70.72
         28 |     92,389        0.44       71.16
         29 |    239,557        1.15       72.31
         30 |     39,901        0.19       72.50
         31 |     83,663        0.40       72.90
         32 |    109,737        0.53       73.43
         33 |     55,991        0.27       73.69
         34 |    334,178        1.60       75.29
         35 |     65,802        0.31       75.61
         36 |    797,058        3.81       79.42
         37 |    377,499        1.81       81.23
         38 |     36,281        0.17       81.40
         39 |    460,412        2.20       83.61
         40 |    132,302        0.63       84.24
         41 |    161,209        0.77       85.01
         42 |    504,642        2.42       87.43
         44 |     39,333        0.19       87.62
         45 |    177,613        0.85       88.47
         46 |     37,167        0.18       88.64
         47 |    255,109        1.22       89.86
         48 |  1,011,245        4.84       94.70
         49 |    124,314        0.59       95.30
         50 |     27,200        0.13       95.43
         51 |    334,155        1.60       97.03
         53 |    289,762        1.39       98.42
         54 |     59,021        0.28       98.70
         55 |    242,588        1.16       99.86
         56 |     23,426        0.11       99.97
         72 |        117        0.00       99.97
         81 |        942        0.00       99.98
         82 |        609        0.00       99.98
         83 |      1,160        0.01       99.99
         84 |        946        0.00       99.99
         85 |        772        0.00       99.99
         86 |        860        0.00      100.00
         88 |        526        0.00      100.00
------------+-----------------------------------
      Total | 20,893,859      100.00

. make_fips pwstate2 pwcounty, gen(pwfips)

. gen test = pwfips == fips_d

. tab test same_county

           |      same_county
      test |         0          1 |     Total
-----------+----------------------+----------
         0 |   377,963 10,859,142 |11,237,105 
         1 |   296,576  9,360,178 | 9,656,754 
-----------+----------------------+----------
     Total |   674,539 20,219,320 |20,893,859 

. tab year, sum(cpi99
) required
r(100);

. tab year, sum(cpi99)

            |          Summary of cpi99
       year |        Mean   Std. dev.       Freq.
------------+------------------------------------
       2015 |   .70300001           0   2,284,532
       2016 |   .69400001           0   2,293,631
       2017 |   .67900002           0   2,315,657
       2018 |   .66299999           0   2,339,567
       2019 |   .65200001           0   2,381,167
       2020 |   .64399999           0   1,900,150
       2021 |   .61500001           0   2,395,057
       2022 |   .56900001           0   2,470,858
       2023 |   .54699999           0   2,513,240
------------+------------------------------------
      Total |   .63899675   .05202764  20,893,859

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_000022.tmp"

. gen tmp1 = cpi99 if year == 2023
(18,380,619 missing values generated)

. egen tmp2 = mean(tmp1)

. gen cpi = tmp2 / cpi99

. 
end of do-file

. tab year, sum(cpi)

            |           Summary of cpi
       year |        Mean   Std. dev.       Freq.
------------+------------------------------------
       2015 |   .77809387           0   2,284,532
       2016 |    .7881844           0   2,293,631
       2017 |   .80559641           0   2,315,657
       2018 |   .82503772           0   2,339,567
       2019 |   .83895701           0   2,381,167
       2020 |   .84937888           0   1,900,150
       2021 |   .88943088           0   2,395,057
       2022 |   .96133566           0   2,470,858
       2023 |           1           0   2,513,240
------------+------------------------------------
      Total |   .86204976   .07411059  20,893,859

. drop tmp1 tmp2

. drop cpi

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_000023.tmp"

. gen tmp1 = cpi99 if year == 2023
(18,380,619 missing values generated)

. egen tmp2 = mean(tmp1)

. gen cpi =  cpi99 / tmp2 

. 
end of do-file

. tab year, sum(cpi)

            |           Summary of cpi
       year |        Mean   Std. dev.       Freq.
------------+------------------------------------
       2015 |    1.285192           0   2,284,532
       2016 |   1.2687386           0   2,293,631
       2017 |   1.2413163           0   2,315,657
       2018 |   1.2120658           0   2,339,567
       2019 |   1.1919562           0   2,381,167
       2020 |   1.1773309           0   1,900,150
       2021 |   1.1243144           0   2,395,057
       2022 |   1.0402194           0   2,470,858
       2023 |           1           0   2,513,240
------------+------------------------------------
      Total |   1.1681842   .09511452  20,893,859

. summ inc* ftotinc

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
      inctot | 20,893,859    49180.26    69841.96     -12800    1686200
     incwage | 20,893,859    34827.49    61204.31          0     870000
     incearn | 20,893,859    37212.16    64562.68      -9999    1279000
     ftotinc | 20,893,859    103442.1    109052.7     -21500    3164000

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_000024.tmp"

. ** Loop over income variables 
. foreach var of varlist inctot incwage incearn ftotinc {
  2.         
.         ** Update CPI 
.         gen real_`var' = `var' * cpi 
  3.         
.         ** Categorical variables 
.         recode real_`var'       (min/-1 = 1 "Negative income")        
>   ///
>                                                 (0 = 2 "$0")          
>                                   ///
>                                                 (1/24999 = 3 "$1-$25K"
> )                         ///
>                                                 (25000/49999 = 4 "$25K
> -$50K")           ///
>                                                 (50000/99999 = 5 "$50K
> -$100K")          ///
>                                                 (100000/199999 = 6 "$1
> 00K-$200K")       ///
>                                                 (200000/max = 7 "$200K
> +") ,             ///
>                         gen(cat_`var')
  4. }
(20,893,851 differences between real_inctot and cat_inctot)
(20,893,859 differences between real_incwage and cat_incwage)
(20,893,859 differences between real_incearn and cat_incearn)
(20,893,848 differences between real_ftotinc and cat_ftotinc)

. 
end of do-file

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_000025.tmp"

. ** Label variable 
. label var cat_inctot "Total personal income categories (real 2023 USD)
> "

. label var cat_incwage "Total wage income categories (real 2023 USD)"

. label var cat_incearn "Total earned income categories (real 2023 USD)"

. label var cat_ftotinc "Total family income categories (real 2023 USD)"

. 
end of do-file

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_000026.tmp"

. 
. ** Load ACS Data 
. use "${data}working/acs_migration_file", replace 

. 
. ** Define sample 
. drop if qmigplc1 == 4                                   // FAILED EDIT
>  OF MIGPLACE 
(388,364 observations deleted)

. drop if inlist(state_fips_o, 2, 15)     // ALASKA AND HAWAII 
(136,571 observations deleted)

. 
. ** Define indicator for being in Multnomah County in origin/destinatio
> n year
. gen multnomah_o = state_fips_o == 41 & county_fips_o == 51

. gen multnomah_d = state_fips_d == 41 & county_fips_d == 51

. 
. ** Define samples 
. gen sample_1 = multnomah_o == 1                                 // Mul
> tnomah in origin-year 

. gen sample_2 = multnomah_o != 1                                 // Not
>  in Multnomah

. label var sample_1 "Out-migration Sample"

. label var sample_1 "In-migration Sample"

. 
. ** Define moving indicator 
. gen out_1 = same_county == 0 

. label var out_1 "Moved out of Multnomah"

. gen out_2 = multnomah_d == 1 

. label var out_2 "Moved to Multnomah"

. 
. ** Define variables of interest
. 
. ** Age 
. recode age      (18/24 = 1 "18-24")     ///
>                         (25/44 = 2 "25-44")             ///
>                         (45/64 = 3 "45-64")     ///
>                         (65/max = 4 "65+"),     ///
>         gen(cat_age)
(20,893,859 differences between age and cat_age)

. label var cat_age "Age categories"

. 
. ** Sex  
. gen female = sex == 2 

. label var female "Female indicator"

. label define lb_female 0 "Male" 1 "Female"

. label values female lb_female 

. 
. ** Marital Status               
. recode marst    (1 = 1 "Married")                               ///
>                                 (2/3 = 2 "Seperated")                 
>   ///
>                                 (4/5 = 3 "Divourced / Widowed") ///
>                                 (6 = 4 "Single"),                     
>           ///
>         gen(cat_married)
(9,061,905 differences between marst and cat_married)

. label var cat_married "Marriage categories"

. 
. ** Kids at home 
. recode nchild   (0 = 0 "0 Children")                                  
>   ///
>                                 (1 = 1 "1 Child")                     
>                           ///
>                                 (2 = 2 "2 Children")                  
>                   ///
>                                 (3/max = 3 "3+ Children"),            
>                   ///
>         gen(cat_child)
(412,920 differences between nchild and cat_child)

. label var cat_child "Number of Children"

. 
. ** Education 
. recode educd    (min/61 = 1 "Less than HS")     ///
>                                 (62/71 = 2 "HS Diploma")              
>   ///
>                                 (80/100 = 3 "Some College")     ///
>                                 (101/max = 4 "College Degree"), ///
>         gen(cat_educ)
(20,893,859 differences between educd and cat_educ)

. label var cat_educ "Education categories"

. 
. ** Earnings / Income 
. gen tmp1 = cpi99 if year == 2023
(18,380,619 missing values generated)

. egen tmp2 = mean(tmp1)

. gen cpi =  cpi99 / tmp2 

. drop tmp1 tmp2 

. 
. ** Loop over income variables 
. foreach var of varlist inctot incwage incearn ftotinc {
  2.         
.         ** Update CPI 
.         gen real_`var' = `var' * cpi 
  3.         
.         ** Categorical variables 
.         recode real_`var'       (min/-1 = 1 "Negative income")        
>   ///
>                                                 (0 = 2 "$0")          
>                                   ///
>                                                 (1/24999 = 3 "$1-$25K"
> )                         ///
>                                                 (25000/49999 = 4 "$25K
> -$50K")           ///
>                                                 (50000/99999 = 5 "$50K
> -$100K")          ///
>                                                 (100000/199999 = 6 "$1
> 00K-$200K")       ///
>                                                 (200000/max = 7 "$200K
> +") ,             ///
>                         gen(cat_`var')
  4.                         
.         ** Tab
.         tab cat_`var', m 
  5.         
. }
(20,893,851 differences between real_inctot and cat_inctot)

      RECODE of |
    real_inctot |      Freq.     Percent        Cum.
----------------+-----------------------------------
Negative income |     20,759        0.10        0.10
             $0 |  1,748,089        8.37        8.47
        $1-$25K |  6,204,375       29.69       38.16
      $25K-$50K |  4,981,108       23.84       62.00
     $50K-$100K |  4,947,578       23.68       85.68
    $100K-$200K |  2,211,136       10.58       96.26
         $200K+ |    780,806        3.74      100.00
       24999.23 |          3        0.00      100.00
       49999.11 |          5        0.00      100.00
----------------+-----------------------------------
          Total | 20,893,859      100.00
(20,893,859 differences between real_incwage and cat_incwage)

      RECODE of |
   real_incwage |      Freq.     Percent        Cum.
----------------+-----------------------------------
             $0 |  8,182,418       39.16       39.16
        $1-$25K |  3,428,895       16.41       55.57
      $25K-$50K |  3,290,630       15.75       71.32
     $50K-$100K |  3,729,590       17.85       89.17
    $100K-$200K |  1,743,819        8.35       97.52
         $200K+ |    518,507        2.48      100.00
----------------+-----------------------------------
          Total | 20,893,859      100.00
(20,893,859 differences between real_incearn and cat_incearn)

      RECODE of |
   real_incearn |      Freq.     Percent        Cum.
----------------+-----------------------------------
Negative income |     16,135        0.08        0.08
             $0 |  7,365,326       35.25       35.33
        $1-$25K |  3,756,344       17.98       53.31
      $25K-$50K |  3,476,928       16.64       69.95
     $50K-$100K |  3,876,560       18.55       88.50
    $100K-$200K |  1,823,201        8.73       97.23
         $200K+ |    579,365        2.77      100.00
----------------+-----------------------------------
          Total | 20,893,859      100.00
(20,893,848 differences between real_ftotinc and cat_ftotinc)

      RECODE of |
   real_ftotinc |      Freq.     Percent        Cum.
----------------+-----------------------------------
Negative income |      7,238        0.03        0.03
             $0 |    226,387        1.08        1.12
        $1-$25K |  2,249,306       10.77       11.88
      $25K-$50K |  3,258,505       15.60       27.48
     $50K-$100K |  5,975,505       28.60       56.08
    $100K-$200K |  6,147,777       29.42       85.50
         $200K+ |  3,029,130       14.50      100.00
       24999.23 |          3        0.00      100.00
       49999.11 |          8        0.00      100.00
----------------+-----------------------------------
          Total | 20,893,859      100.00

. 
. ** Label variable 
. label var cat_inctot "Total personal income categories (real 2023 USD)
> "

. label var cat_incwage "Total wage income categories (real 2023 USD)"

. label var cat_incearn "Total earned income categories (real 2023 USD)"

. label var cat_ftotinc "Total family income categories (real 2023 USD)"

. 
end of do-file

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_000027.tmp"

. 
. ** Start log file 
. capture log close log_02

. log using "${logs}02_log_individual_${date}", replace text name(log_02
> )
------------------------------------------------------------------------
      name:  log_02
       log:  C:/Users/ji252/Documents/GitHub/multnomah-county-tax/code/l
> ogs/02_log_individual_2025-12-15.log
  log type:  text
 opened on:  15 Dec 2025, 21:12:56

. 
. ** Define regression + plotting function 
. capture program drop hdfe_catyear_plot

. program define hdfe_catyear_plot
  1.     version 16.0
  2.     syntax varname(numeric) [if] [in] [fw aw pw iw] , ///
>         CAT(varname) YEAR(varname) ABSORB(string) ///
>         [ SAMPLE(varname) SVAL(real 1) ///
>           WVAR(varname) WTYPE(string) ///
>           VCE(string) ///
>           TITLE(string asis) XTITLE(string asis) YTITLE(string asis) /
> //
>           NOCI ///
>           SAVING(string asis) REPLACE ]
  3. 
.     // ---------------------------------------------------------------
> ------
.     // Requirements
.     // ---------------------------------------------------------------
> ------
.     capture which reghdfe
  4.     if _rc {
  5.         di as error "reghdfe not found. Install with: ssc install r
> eghdfe, replace"
  6.         exit 198
  7.     }
  8.     capture which coefplot
  9.     if _rc {
 10.         di as error "coefplot not found. Install with: ssc install 
> coefplot, replace"
 11.         exit 198
 12.     }
 13. 
.     // ---------------------------------------------------------------
> ------
.     // Mark sample
.     // ---------------------------------------------------------------
> ------
.     marksample touse, strok
 14.     quietly replace `touse' = `touse' & !missing(`varlist', `cat', 
> `year')
 15. 
.     if "`sample'" != "" {
 16.         quietly replace `touse' = `touse' & (`sample' == `sval')
 17.     }
 18. 
.     // ---------------------------------------------------------------
> ------
.     // Handle weights: if user didn't pass [pw/fw/...], default to fw=
> perwt
.     // ---------------------------------------------------------------
> ------
.     local wgt ""
 19.     if "`weight'" != "" {
 20.         local wgt "[`weight'=`exp']"
 21.     }
 22.     else {
 23.         if "`wvar'" == "" local wvar "perwt"
 24.         if "`wtype'" == "" local wtype "fw"
 25.         capture confirm variable `wvar'
 26.         if _rc {
 27.             di as error "Default weight variable `wvar' not found. 
> Either create it or pass weights explicitly."
 28.             exit 111
 29.         }
 30.         local wgt "[`wtype'=`wvar']"
 31.     }
 32. 
.     // ---------------------------------------------------------------
> ------
.     // Ensure cat/year are numeric factor-friendly. Encode/destring if
>  needed.
.     // ---------------------------------------------------------------
> ------
.     tempvar __cat __year
 33. 
.     local cattype : type `cat'
 34.     if substr("`cattype'",1,3) == "str" {
 35.         quietly encode `cat' if `touse', gen(`__cat')
 36.         local catv `__cat'
 37.     }
 38.     else {
 39.         local catv `cat'
 40.     }
 41. 
.     local yeartype : type `year'
 42.     if substr("`yeartype'",1,3) == "str" {
 43.         // attempt to destring; if it fails, we exit
.         quietly destring `year' if `touse', gen(`__year') force
 44.         capture assert !missing(`__year') if `touse'
 45.         if _rc {
 46.             di as error "Year variable is string and could not be c
> leanly converted to numeric."
 47.             exit 459
 48.         }
 49.         local yearv `__year'
 50.     }
 51.     else {
 52.         local yearv `year'
 53.     }
 54. 
.     // ---------------------------------------------------------------
> ------
.     // Levels for plotting
.     // ---------------------------------------------------------------
> ------
.     quietly levelsof `yearv' if `touse', local(yrs)
 55.     quietly levelsof `catv'  if `touse', local(cats)
 56. 
.     if "`yrs'" == "" | "`cats'" == "" {
 57.         di as error "No observations available after applying if/in
> /sample filters."
 58.         exit 2000
 59.     }
 60. 
.     // Build x-axis positions and labels
.     local poslist ""
 61.     local xlabel  ""
 62.     local k = 0
 63.     foreach y of local yrs {
 64.         local ++k
 65.         local poslist `poslist' `k'
 66.         local xlabel  `xlabel'  `k' "`y'"
 67.     }
 68. 
.     // ---------------------------------------------------------------
> ------
.     // Regression: fully interacted cells (cat#year) + absorbed FEs, n
> o constant
.     // Coefficients are adjusted means for each (cat,year) cell condit
> ional on FEs
.     // ---------------------------------------------------------------
> ------
.     quietly reghdfe `varlist' i.`catv'#i.`yearv' if `touse' `wgt', ///
>         absorb(`absorb') vce(`=cond("`vce'"=="","robust","`vce'")') no
> cons
 69. 
.     estimates store __hdfe_catyear_plot
 70. 
.     // ---------------------------------------------------------------
> ------
.     // Build coefplot specs: one line per category level, aligned by y
> ear
.     // ---------------------------------------------------------------
> ------
.     local plotspecs ""
 71.     local vlab : value label `catv'
 72. 
.     foreach c of local cats {
 73.         // series label: value label if it exists, else cat=value
.         local serieslab "`cat'=`c'"
 74.         if "`vlab'" != "" {
 75.             local tmp : label `vlab' `c'
 76.             if "`tmp'" != "" local serieslab "`tmp'"
 77.         }
 78. 
.         // Coefs in year order for this category level
.         local keepc ""
 79.         foreach y of local yrs {
 80.             // coefficient name format: <c>.<catv>#<y>.<yearv>
.             local keepc `keepc' `c'.`catv'#`y'.`yearv'
 81.         }
 82. 
.         // CI display control
.         local ciopt ""
 83.         if "`noci'" != "" local ciopt "noci"
 84. 
.         local plotspecs `plotspecs' ///
>             (., keep(`keepc') order(`keepc') at(`poslist') label("`ser
> ieslab'") `ciopt')
 85.     }
 86. 
.     // ---------------------------------------------------------------
> ------
.     // Plot
.     // ---------------------------------------------------------------
> ------
.     if "`xtitle'" == "" local xtitle "Year"
 87.     if "`ytitle'" == "" local ytitle "`varlist' (adjusted mean)"
 88.     if "`title'"  == "" local title  "`varlist' by `cat' over `year
> '"
 89. 
.     coefplot `plotspecs', ///
>         vertical ///
>         xlabel(`xlabel', angle(45)) ///
>         xtitle("`xtitle'") ///
>         ytitle("`ytitle'") ///
>         legend(cols(1) position(6) )
 90. 
.     // Save graph if requested (expects a .gph path)
.     if "`saving'" != "" {
 91.         graph save "`saving'" , `replace'
 92.     }
 93. end

. 
. 
. ** Load ACS Data 
. use "${data}working/acs_migration_file", replace 

. 
. ** Define sample 
. drop if qmigplc1 == 4                                   // FAILED EDIT
>  OF MIGPLACE 
(388,364 observations deleted)

. drop if inlist(state_fips_o, 2, 15)     // ALASKA AND HAWAII 
(136,571 observations deleted)

. 
. ** Define indicator for being in Multnomah County in origin/destinatio
> n year
. gen multnomah_o = state_fips_o == 41 & county_fips_o == 51

. gen multnomah_d = state_fips_d == 41 & county_fips_d == 51

. 
. ** Define samples 
. gen sample_1 = multnomah_o == 1                                 // Mul
> tnomah in origin-year 

. gen sample_2 = multnomah_o != 1                                 // Not
>  in Multnomah

. label var sample_1 "Out-migration Sample"

. label var sample_1 "In-migration Sample"

. 
. ** Define moving indicator 
. gen out_1 = same_county == 0 

. label var out_1 "Moved out of Multnomah"

. gen out_2 = multnomah_d == 1 

. label var out_2 "Moved to Multnomah"

. 
. ** Define variables of interest
. 
. ** Age 
. recode age      (18/24 = 1 "18-24")     ///
>                         (25/44 = 2 "25-44")             ///
>                         (45/64 = 3 "45-64")     ///
>                         (65/max = 4 "65+"),     ///
>         gen(cat_age)
(20,893,859 differences between age and cat_age)

. label var cat_age "Age categories"

. 
. ** Sex  
. gen female = sex == 2 

. label var female "Female indicator"

. label define lb_female 0 "Male" 1 "Female"

. label values female lb_female 

. 
. ** Marital Status               
. recode marst    (1 = 1 "Married")                               ///
>                                 (2/3 = 2 "Seperated")                 
>   ///
>                                 (4/5 = 3 "Divourced / Widowed") ///
>                                 (6 = 4 "Single"),                     
>           ///
>         gen(cat_married)
(9,061,905 differences between marst and cat_married)

. label var cat_married "Marriage categories"

. 
. ** Kids at home 
. recode nchild   (0 = 0 "0 Children")                                  
>   ///
>                                 (1 = 1 "1 Child")                     
>                           ///
>                                 (2 = 2 "2 Children")                  
>                   ///
>                                 (3/max = 3 "3+ Children"),            
>                   ///
>         gen(cat_child)
(412,920 differences between nchild and cat_child)

. label var cat_child "Number of Children"

. 
. ** Education 
. recode educd    (min/61 = 1 "Less than HS")     ///
>                                 (62/71 = 2 "HS Diploma")              
>   ///
>                                 (80/100 = 3 "Some College")     ///
>                                 (101/max = 4 "College Degree"), ///
>         gen(cat_educ)
(20,893,859 differences between educd and cat_educ)

. label var cat_educ "Education categories"

. 
. ** Earnings / Income 
. gen tmp1 = cpi99 if year == 2023
(18,380,619 missing values generated)

. egen tmp2 = mean(tmp1)

. gen cpi =  cpi99 / tmp2 

. drop tmp1 tmp2 

. 
. ** Loop over income variables 
. foreach var of varlist inctot incwage incearn ftotinc {
  2.         
.         ** Update CPI 
.         gen real_`var' = `var' * cpi 
  3.         
.         ** Categorical variables 
.         recode real_`var'       (min/-1 = 1 "Negative income")        
>   ///
>                                                 (0 = 2 "$0")          
>                                   ///
>                                                 (1/24999 = 3 "$1-$25K"
> )                         ///
>                                                 (25000/49999 = 4 "$25K
> -$50K")           ///
>                                                 (50000/99999 = 5 "$50K
> -$100K")          ///
>                                                 (100000/199999 = 6 "$1
> 00K-$200K")       ///
>                                                 (200000/max = 7 "$200K
> +") ,             ///
>                         gen(cat_`var')
  4.                         
.         ** Tab
.         tab cat_`var', m 
  5.         
. }
(20,893,851 differences between real_inctot and cat_inctot)

      RECODE of |
    real_inctot |      Freq.     Percent        Cum.
----------------+-----------------------------------
Negative income |     20,759        0.10        0.10
             $0 |  1,748,089        8.37        8.47
        $1-$25K |  6,204,375       29.69       38.16
      $25K-$50K |  4,981,108       23.84       62.00
     $50K-$100K |  4,947,578       23.68       85.68
    $100K-$200K |  2,211,136       10.58       96.26
         $200K+ |    780,806        3.74      100.00
       24999.23 |          3        0.00      100.00
       49999.11 |          5        0.00      100.00
----------------+-----------------------------------
          Total | 20,893,859      100.00
--Break--
r(1);

end of do-file

--Break--
r(1);

. do "C:\Users\ji252\Documents\GitHub\multnomah-county-tax\code\02_indiv
> _analysis.do"

. /*********************************************************************
> **********
> File Name:              02_indiv_analysis.do
> Creator:                John Iselin
> Date Update:    November 29, 2025
> 
> Called by: 00_multnomah.do
> 
> Purpose: Preform individual-level migration analysis. 
> 
> Authors: John Iselin 
> 
> For more information, contact john.iselin@yale.edu
> 
> **********************************************************************
> *********/
. 
. ** Start log file 
. capture log close log_02

. log using "${logs}02_log_individual_${date}", replace text name(log_02
> )
------------------------------------------------------------------------
      name:  log_02
       log:  C:/Users/ji252/Documents/GitHub/multnomah-county-tax/code/l
> ogs/02_log_individual_2025-12-15.log
  log type:  text
 opened on:  15 Dec 2025, 21:14:51

. 
. ** Define regression + plotting function 
. capture program drop hdfe_catyear_plot

. program define hdfe_catyear_plot
  1.     version 16.0
  2.     syntax varname(numeric) [if] [in] [fw aw pw iw] , ///
>         CAT(varname) YEAR(varname) ABSORB(string) ///
>         [ SAMPLE(varname) SVAL(real 1) ///
>           WVAR(varname) WTYPE(string) ///
>           VCE(string) ///
>           TITLE(string asis) XTITLE(string asis) YTITLE(string asis) /
> //
>           NOCI ///
>           SAVING(string asis) REPLACE ]
  3. 
.     // ---------------------------------------------------------------
> ------
.     // Requirements
.     // ---------------------------------------------------------------
> ------
.     capture which reghdfe
  4.     if _rc {
  5.         di as error "reghdfe not found. Install with: ssc install r
> eghdfe, replace"
  6.         exit 198
  7.     }
  8.     capture which coefplot
  9.     if _rc {
 10.         di as error "coefplot not found. Install with: ssc install 
> coefplot, replace"
 11.         exit 198
 12.     }
 13. 
.     // ---------------------------------------------------------------
> ------
.     // Mark sample
.     // ---------------------------------------------------------------
> ------
.     marksample touse, strok
 14.     quietly replace `touse' = `touse' & !missing(`varlist', `cat', 
> `year')
 15. 
.     if "`sample'" != "" {
 16.         quietly replace `touse' = `touse' & (`sample' == `sval')
 17.     }
 18. 
.     // ---------------------------------------------------------------
> ------
.     // Handle weights: if user didn't pass [pw/fw/...], default to fw=
> perwt
.     // ---------------------------------------------------------------
> ------
.     local wgt ""
 19.     if "`weight'" != "" {
 20.         local wgt "[`weight'=`exp']"
 21.     }
 22.     else {
 23.         if "`wvar'" == "" local wvar "perwt"
 24.         if "`wtype'" == "" local wtype "fw"
 25.         capture confirm variable `wvar'
 26.         if _rc {
 27.             di as error "Default weight variable `wvar' not found. 
> Either create it or pass weights explicitly."
 28.             exit 111
 29.         }
 30.         local wgt "[`wtype'=`wvar']"
 31.     }
 32. 
.     // ---------------------------------------------------------------
> ------
.     // Ensure cat/year are numeric factor-friendly. Encode/destring if
>  needed.
.     // ---------------------------------------------------------------
> ------
.     tempvar __cat __year
 33. 
.     local cattype : type `cat'
 34.     if substr("`cattype'",1,3) == "str" {
 35.         quietly encode `cat' if `touse', gen(`__cat')
 36.         local catv `__cat'
 37.     }
 38.     else {
 39.         local catv `cat'
 40.     }
 41. 
.     local yeartype : type `year'
 42.     if substr("`yeartype'",1,3) == "str" {
 43.         // attempt to destring; if it fails, we exit
.         quietly destring `year' if `touse', gen(`__year') force
 44.         capture assert !missing(`__year') if `touse'
 45.         if _rc {
 46.             di as error "Year variable is string and could not be c
> leanly converted to numeric."
 47.             exit 459
 48.         }
 49.         local yearv `__year'
 50.     }
 51.     else {
 52.         local yearv `year'
 53.     }
 54. 
.     // ---------------------------------------------------------------
> ------
.     // Levels for plotting
.     // ---------------------------------------------------------------
> ------
.     quietly levelsof `yearv' if `touse', local(yrs)
 55.     quietly levelsof `catv'  if `touse', local(cats)
 56. 
.     if "`yrs'" == "" | "`cats'" == "" {
 57.         di as error "No observations available after applying if/in
> /sample filters."
 58.         exit 2000
 59.     }
 60. 
.     // Build x-axis positions and labels
.     local poslist ""
 61.     local xlabel  ""
 62.     local k = 0
 63.     foreach y of local yrs {
 64.         local ++k
 65.         local poslist `poslist' `k'
 66.         local xlabel  `xlabel'  `k' "`y'"
 67.     }
 68. 
.     // ---------------------------------------------------------------
> ------
.     // Regression: fully interacted cells (cat#year) + absorbed FEs, n
> o constant
.     // Coefficients are adjusted means for each (cat,year) cell condit
> ional on FEs
.     // ---------------------------------------------------------------
> ------
.     quietly reghdfe `varlist' i.`catv'#i.`yearv' if `touse' `wgt', ///
>         absorb(`absorb') vce(`=cond("`vce'"=="","robust","`vce'")') no
> cons
 69. 
.     estimates store __hdfe_catyear_plot
 70. 
.     // ---------------------------------------------------------------
> ------
.     // Build coefplot specs: one line per category level, aligned by y
> ear
.     // ---------------------------------------------------------------
> ------
.     local plotspecs ""
 71.     local vlab : value label `catv'
 72. 
.     foreach c of local cats {
 73.         // series label: value label if it exists, else cat=value
.         local serieslab "`cat'=`c'"
 74.         if "`vlab'" != "" {
 75.             local tmp : label `vlab' `c'
 76.             if "`tmp'" != "" local serieslab "`tmp'"
 77.         }
 78. 
.         // Coefs in year order for this category level
.         local keepc ""
 79.         foreach y of local yrs {
 80.             // coefficient name format: <c>.<catv>#<y>.<yearv>
.             local keepc `keepc' `c'.`catv'#`y'.`yearv'
 81.         }
 82. 
.         // CI display control
.         local ciopt ""
 83.         if "`noci'" != "" local ciopt "noci"
 84. 
.         local plotspecs `plotspecs' ///
>             (., keep(`keepc') order(`keepc') at(`poslist') label("`ser
> ieslab'") `ciopt')
 85.     }
 86. 
.     // ---------------------------------------------------------------
> ------
.     // Plot
.     // ---------------------------------------------------------------
> ------
.     if "`xtitle'" == "" local xtitle "Year"
 87.     if "`ytitle'" == "" local ytitle "`varlist' (adjusted mean)"
 88.     if "`title'"  == "" local title  "`varlist' by `cat' over `year
> '"
 89. 
.     coefplot `plotspecs', ///
>         vertical ///
>         xlabel(`xlabel', angle(45)) ///
>         xtitle("`xtitle'") ///
>         ytitle("`ytitle'") ///
>         legend(cols(1) position(6) )
 90. 
.     // Save graph if requested (expects a .gph path)
.     if "`saving'" != "" {
 91.         graph save "`saving'" , `replace'
 92.     }
 93. end

. 
. 
. ** Load ACS Data 
. use "${data}working/acs_migration_file", replace 

. 
. ** Define sample 
. drop if qmigplc1 == 4                                   // FAILED EDIT
>  OF MIGPLACE 
(388,364 observations deleted)

. drop if inlist(state_fips_o, 2, 15)     // ALASKA AND HAWAII 
(136,571 observations deleted)

. 
. ** Define indicator for being in Multnomah County in origin/destinatio
> n year
. gen multnomah_o = state_fips_o == 41 & county_fips_o == 51

. gen multnomah_d = state_fips_d == 41 & county_fips_d == 51

. 
. ** Define samples 
. gen sample_1 = multnomah_o == 1                                 // Mul
> tnomah in origin-year 

. gen sample_2 = multnomah_o != 1                                 // Not
>  in Multnomah

. label var sample_1 "Out-migration Sample"

. label var sample_1 "In-migration Sample"

. 
. ** Define moving indicator 
. gen out_1 = same_county == 0 

. label var out_1 "Moved out of Multnomah"

. gen out_2 = multnomah_d == 1 

. label var out_2 "Moved to Multnomah"

. 
. ** Define variables of interest
. 
. ** Age 
. recode age      (18/24 = 1 "18-24")     ///
>                         (25/44 = 2 "25-44")             ///
>                         (45/64 = 3 "45-64")     ///
>                         (65/max = 4 "65+"),     ///
>         gen(cat_age)
(20,893,859 differences between age and cat_age)

. label var cat_age "Age categories"

. 
. ** Sex  
. gen female = sex == 2 

. label var female "Female indicator"

. label define lb_female 0 "Male" 1 "Female"

. label values female lb_female 

. 
. ** Marital Status               
. recode marst    (1 = 1 "Married")                               ///
>                                 (2/3 = 2 "Seperated")                 
>   ///
>                                 (4/5 = 3 "Divourced / Widowed") ///
>                                 (6 = 4 "Single"),                     
>           ///
>         gen(cat_married)
(9,061,905 differences between marst and cat_married)

. label var cat_married "Marriage categories"

. 
. ** Kids at home 
. recode nchild   (0 = 0 "0 Children")                                  
>   ///
>                                 (1 = 1 "1 Child")                     
>                           ///
>                                 (2 = 2 "2 Children")                  
>                   ///
>                                 (3/max = 3 "3+ Children"),            
>                   ///
>         gen(cat_child)
(412,920 differences between nchild and cat_child)

. label var cat_child "Number of Children"

. 
. ** Education 
. recode educd    (min/61 = 1 "Less than HS")     ///
>                                 (62/71 = 2 "HS Diploma")              
>   ///
>                                 (80/100 = 3 "Some College")     ///
>                                 (101/max = 4 "College Degree"), ///
>         gen(cat_educ)
(20,893,859 differences between educd and cat_educ)

. label var cat_educ "Education categories"

. 
. ** Earnings / Income 
. gen tmp1 = cpi99 if year == 2023
(18,380,619 missing values generated)

. egen tmp2 = mean(tmp1)

. gen cpi =  cpi99 / tmp2 

. drop tmp1 tmp2 

. 
. ** Loop over income variables 
. foreach var of varlist inctot incwage incearn ftotinc {
  2.         
.         ** Update CPI 
.         gen real_`var' = round(`var' * cpi) 
  3.         
.         ** Categorical variables 
.         recode real_`var'       (min/-1 = 1 "Negative income")        
>   ///
>                                                 (0 = 2 "$0")          
>                                   ///
>                                                 (1/24999 = 3 "$1-$25K"
> )                         ///
>                                                 (25000/49999 = 4 "$25K
> -$50K")           ///
>                                                 (50000/99999 = 5 "$50K
> -$100K")          ///
>                                                 (100000/199999 = 6 "$1
> 00K-$200K")       ///
>                                                 (200000/max = 7 "$200K
> +") ,             ///
>                         gen(cat_`var')
  4.                         
.         ** Tab
.         tab cat_`var', m 
  5.         
. }
(20,893,859 differences between real_inctot and cat_inctot)

      RECODE of |
    real_inctot |      Freq.     Percent        Cum.
----------------+-----------------------------------
Negative income |     20,759        0.10        0.10
             $0 |  1,748,089        8.37        8.47
        $1-$25K |  6,204,378       29.69       38.16
      $25K-$50K |  4,981,113       23.84       62.00
     $50K-$100K |  4,947,578       23.68       85.68
    $100K-$200K |  2,211,136       10.58       96.26
         $200K+ |    780,806        3.74      100.00
----------------+-----------------------------------
          Total | 20,893,859      100.00
(20,893,859 differences between real_incwage and cat_incwage)

      RECODE of |
   real_incwage |      Freq.     Percent        Cum.
----------------+-----------------------------------
             $0 |  8,182,418       39.16       39.16
        $1-$25K |  3,428,895       16.41       55.57
      $25K-$50K |  3,290,630       15.75       71.32
     $50K-$100K |  3,729,590       17.85       89.17
    $100K-$200K |  1,743,819        8.35       97.52
         $200K+ |    518,507        2.48      100.00
----------------+-----------------------------------
          Total | 20,893,859      100.00
(20,893,859 differences between real_incearn and cat_incearn)

      RECODE of |
   real_incearn |      Freq.     Percent        Cum.
----------------+-----------------------------------
Negative income |     16,135        0.08        0.08
             $0 |  7,365,326       35.25       35.33
        $1-$25K |  3,756,344       17.98       53.31
      $25K-$50K |  3,476,928       16.64       69.95
     $50K-$100K |  3,876,560       18.55       88.50
    $100K-$200K |  1,823,201        8.73       97.23
         $200K+ |    579,365        2.77      100.00
----------------+-----------------------------------
          Total | 20,893,859      100.00
(20,893,767 differences between real_ftotinc and cat_ftotinc)

      RECODE of |
   real_ftotinc |      Freq.     Percent        Cum.
----------------+-----------------------------------
Negative income |      7,238        0.03        0.03
             $0 |    226,387        1.08        1.12
        $1-$25K |  2,249,309       10.77       11.88
      $25K-$50K |  3,258,513       15.60       27.48
     $50K-$100K |  5,975,505       28.60       56.08
    $100K-$200K |  6,147,777       29.42       85.50
         $200K+ |  3,029,130       14.50      100.00
----------------+-----------------------------------
          Total | 20,893,859      100.00

. 
. ** Label variable 
. label var cat_inctot "Total personal income categories (real 2023 USD)
> "

. label var cat_incwage "Total wage income categories (real 2023 USD)"

. label var cat_incearn "Total earned income categories (real 2023 USD)"

. label var cat_ftotinc "Total family income categories (real 2023 USD)"

. 
. ** Loop over out- and in-migration 
. forvalues i = 1/2 {
  2.         
.         if `i' == 1 local ytitle "Out-migration rate (%)"
  3.         if `i' == 2 local ytitle "In-migration rate (%)"
  4. 
.         ** Loop over categories
.         foreach cat of varlist cat_* {
  5.                 
.                 ** Get label 
.                 local mylabel : variable label `cat'
  6.                 
.                 ** Run Regressions
.                 hdfe_catyear_plot out_`i' if sample_`i' == 1,         
>   ///
>                         cat(`cat') year(year)                         
>                           ///
>                         absorb(state_fips_o county_fips_o cat_*)      
>           ///
>                         wvar(perwt) wtype(fw)                         
>                           ///
>                         ytitle("`ytitle'")                            
>                                   ///
>                         saving("${results}fig_`cat'_`i'")
  7.                 
. 
.         } // END CAT LOOP
  8.         
. } // END SAMPLE LOOP 
reghdfe not found. Install with: ssc install reghdfe, replace
r(198);

end of do-file

r(198);

. ssc install reghdfe
checking reghdfe consistency and verifying not already installed...
installing into C:\Users\ji252\ado\plus\...
installation complete.

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_000028.tmp"

. 
. ** Loop over out- and in-migration 
. forvalues i = 1/2 {
  2.         
.         if `i' == 1 local ytitle "Out-migration rate (%)"
  3.         if `i' == 2 local ytitle "In-migration rate (%)"
  4. 
.         ** Loop over categories
.         foreach cat of varlist cat_* {
  5.                 
.                 ** Get label 
.                 local mylabel : variable label `cat'
  6.                 
.                 ** Run Regressions
.                 hdfe_catyear_plot out_`i' if sample_`i' == 1,         
>   ///
>                         cat(`cat') year(year)                         
>                           ///
>                         absorb(state_fips_o county_fips_o cat_*)      
>           ///
>                         wvar(perwt) wtype(fw)                         
>                           ///
>                         ytitle("`ytitle'")                            
>                                   ///
>                         saving("${results}fig_`cat'_`i'")
  7.                 
. 
.         } // END CAT LOOP
  8.         
. } // END SAMPLE LOOP 
coefplot not found. Install with: ssc install coefplot, replace
r(198);

end of do-file

r(198);

. ssc install coefplot
checking coefplot consistency and verifying not already installed...
installing into C:\Users\ji252\ado\plus\...
installation complete.

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_000029.tmp"

. ** Loop over out- and in-migration 
. forvalues i = 1/2 {
  2.         
.         if `i' == 1 local ytitle "Out-migration rate (%)"
  3.         if `i' == 2 local ytitle "In-migration rate (%)"
  4. 
.         ** Loop over categories
.         foreach cat of varlist cat_* {
  5.                 
.                 ** Get label 
.                 local mylabel : variable label `cat'
  6.                 
.                 ** Run Regressions
.                 hdfe_catyear_plot out_`i' if sample_`i' == 1,         
>   ///
>                         cat(`cat') year(year)                         
>                           ///
>                         absorb(state_fips_o county_fips_o cat_*)      
>           ///
>                         wvar(perwt) wtype(fw)                         
>                           ///
>                         ytitle("`ytitle'")                            
>                                   ///
>                         saving("${results}fig_`cat'_`i'")
  7.                 
. 
.         } // END CAT LOOP
  8.         
. } // END SAMPLE LOOP 
reghdfe requires the ftools package, which is not installed
    - install from SSC
    - install from Github
(error occurred while loading reghdfe.ado)
r(9);

end of do-file

r(9);

. ssc install ftools
checking ftools consistency and verifying not already installed...
installing into C:\Users\ji252\ado\plus\...
installation complete.

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_00002a.tmp"

. ** Label variable 
. label var cat_inctot "Total personal income categories (real 2023 USD)
> "

. label var cat_incwage "Total wage income categories (real 2023 USD)"

. label var cat_incearn "Total earned income categories (real 2023 USD)"

. label var cat_ftotinc "Total family income categories (real 2023 USD)"

. 
. ** Loop over out- and in-migration 
. forvalues i = 1/2 {
  2.         
.         if `i' == 1 local ytitle "Out-migration rate (%)"
  3.         if `i' == 2 local ytitle "In-migration rate (%)"
  4. 
.         ** Loop over categories
.         foreach cat of varlist cat_* {
  5.                 
.                 ** Get label 
.                 local mylabel : variable label `cat'
  6.                 
.                 ** Run Regressions
.                 hdfe_catyear_plot out_`i' if sample_`i' == 1,         
>   ///
>                         cat(`cat') year(year)                         
>                           ///
>                         absorb(state_fips_o county_fips_o cat_*)      
>           ///
>                         wvar(perwt) wtype(fw)                         
>                           ///
>                         ytitle("`ytitle'")                            
>                                   ///
>                         saving("${results}fig_`cat'_`i'")
  7.                 
. 
.         } // END CAT LOOP
  8.         
. } // END SAMPLE LOOP 
migration not found
r(111);

end of do-file

r(111);

. summ cat_*

    Variable |        Obs        Mean   
>  Std. dev.       Min        Max
-------------+--------------------------
> -------------------------------
     cat_age | 20,893,859    2.792895   
>  .9303382          1          4
 cat_married | 20,893,859     2.10782   
>  1.292539          1          4
   cat_child | 20,893,859     .610204   
>  .9339945          0          3
    cat_educ | 20,893,859    2.649035   
>  1.047684          1          4
  cat_inctot | 20,893,859    4.093302   
>  1.276041          1          7
-------------+--------------------------
> -------------------------------
 cat_incwage | 20,893,859    3.472525   
>  1.479204          2          7
 cat_incearn | 20,893,859    3.556121   
>  1.477798          1          7
 cat_ftotinc | 20,893,859    5.179038   
>  1.237628          1          7

. tab _est___hdfe_catyear_plot

  esample() |
       from |
  estimates |
      store |      Freq.     Percent    
>     Cum.
------------+---------------------------
> --------
          0 | 20,842,246       99.75    
>    99.75
          1 |     51,613        0.25    
>   100.00
------------+---------------------------
> --------
      Total | 20,893,859      100.00

. do "C:\Users\ji252\AppData\Local\Temp\
> STD67b0_00002b.tmp"

. /*************************************
> **************************************
> ****
> File Name:              02_indiv_analy
> sis.do
> Creator:                John Iselin
> Date Update:    November 29, 2025
> 
> Called by: 00_multnomah.do
> 
> Purpose: Preform individual-level migr
> ation analysis. 
> 
> Authors: John Iselin 
> 
> For more information, contact john.ise
> lin@yale.edu
> 
> **************************************
> **************************************
> ***/
. 
. ** Start log file 
. capture log close log_02

. log using "${logs}02_log_individual_${
> date}", replace text name(log_02)
----------------------------------------
      name:  log_02
       log:  C:/Users/ji252/Documents/Gi
> tHub/multnomah-county-tax/code/logs/02
> _log_individual_2025-12-15.log
  log type:  text
 opened on:  15 Dec 2025, 21:20:56

. 
. ** Define regression + plotting functi
> on 
. capture program drop hdfe_catyear_plot

. program define hdfe_catyear_plot
  1.     version 16.0
  2.     syntax varname(numeric) [if] [i
> n] [fw aw pw iw] , ///
>         CAT(varname) YEAR(varname) ABS
> ORB(string) ///
>         [ SAMPLE(varname) SVAL(real 1)
>  ///
>           WVAR(varname) WTYPE(string) 
> ///
>           VCE(string) ///
>           TITLE(string asis) XTITLE(st
> ring asis) YTITLE(string asis) ///
>           NOCI ///
>           SAVING(string asis) REPLACE 
> ]
  3. 
.     // -------------------------------
> --------------------------------------
.     // Requirements
.     // -------------------------------
> --------------------------------------
.     capture which reghdfe
  4.     if _rc {
  5.         di as error "reghdfe not fo
> und. Install with: ssc install reghdfe
> , replace"
  6.         exit 198
  7.     }
  8.     capture which coefplot
  9.     if _rc {
 10.         di as error "coefplot not f
> ound. Install with: ssc install coefpl
> ot, replace"
 11.         exit 198
 12.     }
 13. 
.     // -------------------------------
> --------------------------------------
.     // Mark sample
.     // -------------------------------
> --------------------------------------
.     marksample touse, strok
 14.     quietly replace `touse' = `tous
> e' & !missing(`varlist', `cat', `year'
> )
 15. 
.     if "`sample'" != "" {
 16.         quietly replace `touse' = `
> touse' & (`sample' == `sval')
 17.     }
 18. 
.     // -------------------------------
> --------------------------------------
.     // Handle weights: if user didn't 
> pass [pw/fw/...], default to fw=perwt
.     // -------------------------------
> --------------------------------------
.     local wgt ""
 19.     if "`weight'" != "" {
 20.         local wgt "[`weight'=`exp']
> "
 21.     }
 22.     else {
 23.         if "`wvar'" == "" local wva
> r "perwt"
 24.         if "`wtype'" == "" local wt
> ype "fw"
 25.         capture confirm variable `w
> var'
 26.         if _rc {
 27.             di as error "Default we
> ight variable `wvar' not found. Either
>  create it or pass weights explicitly.
> "
 28.             exit 111
 29.         }
 30.         local wgt "[`wtype'=`wvar']
> "
 31.     }
 32. 
.     // -------------------------------
> --------------------------------------
.     // Ensure cat/year are numeric fac
> tor-friendly. Encode/destring if neede
> d.
.     // -------------------------------
> --------------------------------------
.     tempvar __cat __year
 33. 
.     local cattype : type `cat'
 34.     if substr("`cattype'",1,3) == "
> str" {
 35.         quietly encode `cat' if `to
> use', gen(`__cat')
 36.         local catv `__cat'
 37.     }
 38.     else {
 39.         local catv `cat'
 40.     }
 41. 
.     local yeartype : type `year'
 42.     if substr("`yeartype'",1,3) == 
> "str" {
 43.         // attempt to destring; if 
> it fails, we exit
.         quietly destring `year' if `to
> use', gen(`__year') force
 44.         capture assert !missing(`__
> year') if `touse'
 45.         if _rc {
 46.             di as error "Year varia
> ble is string and could not be cleanly
>  converted to numeric."
 47.             exit 459
 48.         }
 49.         local yearv `__year'
 50.     }
 51.     else {
 52.         local yearv `year'
 53.     }
 54. 
.     // -------------------------------
> --------------------------------------
.     // Levels for plotting
.     // -------------------------------
> --------------------------------------
.     quietly levelsof `yearv' if `touse
> ', local(yrs)
 55.     quietly levelsof `catv'  if `to
> use', local(cats)
 56. 
.     if "`yrs'" == "" | "`cats'" == "" 
> {
 57.         di as error "No observation
> s available after applying if/in/sampl
> e filters."
 58.         exit 2000
 59.     }
 60. 
.     // Build x-axis positions and labe
> ls
.     local poslist ""
 61.     local xlabel  ""
 62.     local k = 0
 63.     foreach y of local yrs {
 64.         local ++k
 65.         local poslist `poslist' `k'
 66.         local xlabel  `xlabel'  `k'
>  "`y'"
 67.     }
 68. 
.     // -------------------------------
> --------------------------------------
.     // Regression: fully interacted ce
> lls (cat#year) + absorbed FEs, no cons
> tant
.     // Coefficients are adjusted means
>  for each (cat,year) cell conditional 
> on FEs
.     // -------------------------------
> --------------------------------------
.     quietly reghdfe `varlist' i.`catv'
> #i.`yearv' if `touse' `wgt', ///
>         absorb(`absorb') vce(`=cond("`
> vce'"=="","robust","`vce'")') nocons
 69. 
.     estimates store __hdfe_catyear_plo
> t
 70. 
.     // -------------------------------
> --------------------------------------
.     // Build coefplot specs: one line 
> per category level, aligned by year
.     // -------------------------------
> --------------------------------------
.     local plotspecs ""
 71.     local vlab : value label `catv'
 72.         dis "`vlab'"
 73.         
.     foreach c of local cats {
 74.         // series label: value labe
> l if it exists, else cat=value
.         local serieslab "`cat'=`c'"
 75.         if "`vlab'" != "" {
 76.             local tmp : label `vlab
> ' `c'
 77.             if "`tmp'" != "" local 
> serieslab "`tmp'"
 78.         }
 79. 
.         // Coefs in year order for thi
> s category level
.         local keepc ""
 80.         foreach y of local yrs {
 81.             // coefficient name for
> mat: <c>.<catv>#<y>.<yearv>
.             local keepc `keepc' `c'.`c
> atv'#`y'.`yearv'
 82.         }
 83. 
.         // CI display control
.         local ciopt ""
 84.         if "`noci'" != "" local cio
> pt "noci"
 85. 
.         local plotspecs `plotspecs' //
> /
>             (., keep(`keepc') order(`k
> eepc') at(`poslist') label("`serieslab
> '") `ciopt')
 86.     }
 87. 
.     // -------------------------------
> --------------------------------------
.     // Plot
.     // -------------------------------
> --------------------------------------
.     if "`xtitle'" == "" local xtitle "
> Year"
 88.     if "`ytitle'" == "" local ytitl
> e "`varlist' (adjusted mean)"
 89. 
.         dis "`ytitle'"
 90.         
.     coefplot `plotspecs', ///
>         vertical ///
>         xlabel(`xlabel', angle(45)) //
> /
>         xtitle("`xtitle'") ///
>         ytitle("`ytitle'") ///
>         legend(cols(1) position(6) )
 91. 
.     // Save graph if requested (expect
> s a .gph path)
.     if "`saving'" != "" {
 92.         graph save "`saving'" , `re
> place'
 93.     }
 94. end

. 
. 
. ** Load ACS Data 
. use "${data}working/acs_migration_file
> ", replace 

. 
. ** Define sample 
. drop if qmigplc1 == 4                 
>                   // FAILED EDIT OF MI
> GPLACE 
(388,364 observations deleted)

. drop if inlist(state_fips_o, 2, 15)   
>   // ALASKA AND HAWAII 
(136,571 observations deleted)

. 
. ** Define indicator for being in Multn
> omah County in origin/destination year
. gen multnomah_o = state_fips_o == 41 &
>  county_fips_o == 51

. gen multnomah_d = state_fips_d == 41 &
>  county_fips_d == 51

. 
. ** Define samples 
. gen sample_1 = multnomah_o == 1       
>                           // Multnomah
>  in origin-year 

. gen sample_2 = multnomah_o != 1       
>                           // Not in Mu
> ltnomah

. label var sample_1 "Out-migration Samp
> le"

. label var sample_1 "In-migration Sampl
> e"

. 
. ** Define moving indicator 
. gen out_1 = same_county == 0 

. label var out_1 "Moved out of Multnoma
> h"

. gen out_2 = multnomah_d == 1 

. label var out_2 "Moved to Multnomah"

. 
. ** Define variables of interest
. 
. ** Age 
. recode age      (18/24 = 1 "18-24")   
>   ///
>                         (25/44 = 2 "25
> -44")             ///
>                         (45/64 = 3 "45
> -64")     ///
>                         (65/max = 4 "6
> 5+"),     ///
>         gen(cat_age)
(20,893,859 differences between age and 
> cat_age)

. label var cat_age "Age categories"

. 
. ** Sex  
. gen female = sex == 2 

. label var female "Female indicator"

. label define lb_female 0 "Male" 1 "Fem
> ale"

. label values female lb_female 

. 
. ** Marital Status               
. recode marst    (1 = 1 "Married")     
>                           ///
>                                 (2/3 =
>  2 "Seperated")                   ///
>                                 (4/5 =
>  3 "Divourced / Widowed") ///
>                                 (6 = 4
>  "Single"),                           
>     ///
>         gen(cat_married)
(9,061,905 differences between marst and
>  cat_married)

. label var cat_married "Marriage catego
> ries"

. 
. ** Kids at home 
. recode nchild   (0 = 0 "0 Children")  
>                                   ///
>                                 (1 = 1
>  "1 Child")                           
>                     ///
>                                 (2 = 2
>  "2 Children")                        
>             ///
>                                 (3/max
>  = 3 "3+ Children"),                  
>             ///
>         gen(cat_child)
(412,920 differences between nchild and 
> cat_child)

. label var cat_child "Number of Childre
> n"

. 
. ** Education 
. recode educd    (min/61 = 1 "Less than
>  HS")     ///
>                                 (62/71
>  = 2 "HS Diploma")                ///
>                                 (80/10
> 0 = 3 "Some College")     ///
>                                 (101/m
> ax = 4 "College Degree"), ///
>         gen(cat_educ)
(20,893,859 differences between educd an
> d cat_educ)

. label var cat_educ "Education categori
> es"

. 
. ** Earnings / Income 
. gen tmp1 = cpi99 if year == 2023
(18,380,619 missing values generated)

. egen tmp2 = mean(tmp1)

. gen cpi =  cpi99 / tmp2 

. drop tmp1 tmp2 

. 
. ** Loop over income variables 
. foreach var of varlist inctot incwage 
> incearn ftotinc {
  2.         
.         ** Update CPI 
.         gen real_`var' = round(`var' *
>  cpi) 
  3.         
.         ** Categorical variables 
.         recode real_`var'       (min/-
> 1 = 1 "Negative income")          ///
>                                       
>           (0 = 2 "$0")                
>                             ///
>                                       
>           (1/24999 = 3 "$1-$25K")     
>                     ///
>                                       
>           (25000/49999 = 4 "$25K-$50K"
> )           ///
>                                       
>           (50000/99999 = 5 "$50K-$100K
> ")          ///
>                                       
>           (100000/199999 = 6 "$100K-$2
> 00K")       ///
>                                       
>           (200000/max = 7 "$200K+") , 
>             ///
>                         gen(cat_`var')
  4.                         
.         ** Tab
.         tab cat_`var', m 
  5.         
. }
(20,893,859 differences between real_inc
> tot and cat_inctot)

      RECODE of |
    real_inctot |      Freq.     Percent
>         Cum.
----------------+-----------------------
> ------------
Negative income |     20,759        0.10
>         0.10
             $0 |  1,748,089        8.37
>         8.47
        $1-$25K |  6,204,378       29.69
>        38.16
      $25K-$50K |  4,981,113       23.84
>        62.00
     $50K-$100K |  4,947,578       23.68
>        85.68
    $100K-$200K |  2,211,136       10.58
>        96.26
         $200K+ |    780,806        3.74
>       100.00
----------------+-----------------------
> ------------
          Total | 20,893,859      100.00
(20,893,859 differences between real_inc
> wage and cat_incwage)

      RECODE of |
   real_incwage |      Freq.     Percent
>         Cum.
----------------+-----------------------
> ------------
             $0 |  8,182,418       39.16
>        39.16
        $1-$25K |  3,428,895       16.41
>        55.57
      $25K-$50K |  3,290,630       15.75
>        71.32
     $50K-$100K |  3,729,590       17.85
>        89.17
    $100K-$200K |  1,743,819        8.35
>        97.52
         $200K+ |    518,507        2.48
>       100.00
----------------+-----------------------
> ------------
          Total | 20,893,859      100.00
(20,893,859 differences between real_inc
> earn and cat_incearn)

      RECODE of |
   real_incearn |      Freq.     Percent
>         Cum.
----------------+-----------------------
> ------------
Negative income |     16,135        0.08
>         0.08
             $0 |  7,365,326       35.25
>        35.33
        $1-$25K |  3,756,344       17.98
>        53.31
      $25K-$50K |  3,476,928       16.64
>        69.95
     $50K-$100K |  3,876,560       18.55
>        88.50
    $100K-$200K |  1,823,201        8.73
>        97.23
         $200K+ |    579,365        2.77
>       100.00
----------------+-----------------------
> ------------
          Total | 20,893,859      100.00
(20,893,767 differences between real_fto
> tinc and cat_ftotinc)

      RECODE of |
   real_ftotinc |      Freq.     Percent
>         Cum.
----------------+-----------------------
> ------------
Negative income |      7,238        0.03
>         0.03
             $0 |    226,387        1.08
>         1.12
        $1-$25K |  2,249,309       10.77
>        11.88
      $25K-$50K |  3,258,513       15.60
>        27.48
     $50K-$100K |  5,975,505       28.60
>        56.08
    $100K-$200K |  6,147,777       29.42
>        85.50
         $200K+ |  3,029,130       14.50
>       100.00
----------------+-----------------------
> ------------
          Total | 20,893,859      100.00

. 
. ** Label variable 
. label var cat_inctot "Total personal i
> ncome categories (real 2023 USD)"

. label var cat_incwage "Total wage inco
> me categories (real 2023 USD)"

. label var cat_incearn "Total earned in
> come categories (real 2023 USD)"

. label var cat_ftotinc "Total family in
> come categories (real 2023 USD)"

. 
. ** Loop over out- and in-migration 
. forvalues i = 1/2 {
  2.         
.         if `i' == 1 local ytitle "Out-
> migration rate (%)"
  3.         if `i' == 2 local ytitle "I
> n-migration rate (%)"
  4. 
.         ** Loop over categories
.         foreach cat of varlist cat_* {
  5.                 
.                 ** Get label 
.                 local mylabel : variab
> le label `cat'
  6.                 
.                 ** Run Regressions
.                 hdfe_catyear_plot out_
> `i' if sample_`i' == 1,           ///
>                         cat(`cat') yea
> r(year)                               
>                     ///
>                         absorb(state_f
> ips_o county_fips_o cat_*)            
>     ///
>                         wvar(perwt) wt
> ype(fw)                               
>                     ///
>                         ytitle("`ytitl
> e'")                                  
>                             ///
>                         saving("${resu
> lts}fig_`cat'_`i'")
  7.                 
. 
.         } // END CAT LOOP
  8.         
. } // END SAMPLE LOOP 
cat_age
migration not found
r(111);

end of do-file

r(111);

. des cat_age

Variable      Storage   Display    Value
    name         type    format    label
>       Variable label
----------------------------------------
cat_age         byte    %9.0g      cat_a
                    > ge    Age
                    categories

. do "C:\Users\ji252\AppData\Local\Temp\
> STD67b0_00002c.tmp"

. /*************************************
> **************************************
> ****
> File Name:              02_indiv_analy
> sis.do
> Creator:                John Iselin
> Date Update:    November 29, 2025
> 
> Called by: 00_multnomah.do
> 
> Purpose: Preform individual-level migr
> ation analysis. 
> 
> Authors: John Iselin 
> 
> For more information, contact john.ise
> lin@yale.edu
> 
> **************************************
> **************************************
> ***/
. 
. ** Start log file 
. capture log close log_02

. log using "${logs}02_log_individual_${
> date}", replace text name(log_02)
----------------------------------------
      name:  log_02
       log:  C:/Users/ji252/Documents/Gi
> tHub/multnomah-county-tax/code/logs/02
> _log_individual_2025-12-15.log
  log type:  text
 opened on:  15 Dec 2025, 21:24:46

. 
. ** Define regression + plotting functi
> on 
. capture program drop hdfe_catyear_plot

. program define hdfe_catyear_plot
  1.     version 16.0
  2.     syntax varname(numeric) [if] [i
> n] [fw aw pw iw] , ///
>         CAT(varname) YEAR(varname) ABS
> ORB(string) ///
>         [ SAMPLE(varname) SVAL(real 1)
>  ///
>           WVAR(varname) WTYPE(string) 
> ///
>           VCE(string) ///
>           TITLE(string asis) XTITLE(st
> ring asis) YTITLE(string asis) ///
>           NOCI ///
>           SAVING(string asis) REPLACE 
> ]
  3. 
.     // -------------------------------
> --------------------------------------
.     // Requirements
.     // -------------------------------
> --------------------------------------
.     capture which reghdfe
  4.     if _rc {
  5.         di as error "reghdfe not fo
> und. Install with: ssc install reghdfe
> , replace"
  6.         exit 198
  7.     }
  8.     capture which coefplot
  9.     if _rc {
 10.         di as error "coefplot not f
> ound. Install with: ssc install coefpl
> ot, replace"
 11.         exit 198
 12.     }
 13. 
.     // -------------------------------
> --------------------------------------
.     // Mark sample
.     // -------------------------------
> --------------------------------------
.     marksample touse, strok
 14.     quietly replace `touse' = `tous
> e' & !missing(`varlist', `cat', `year'
> )
 15. 
.     if "`sample'" != "" {
 16.         quietly replace `touse' = `
> touse' & (`sample' == `sval')
 17.     }
 18. 
.     // -------------------------------
> --------------------------------------
.     // Handle weights: if user didn't 
> pass [pw/fw/...], default to fw=perwt
.     // -------------------------------
> --------------------------------------
.     local wgt ""
 19.     if "`weight'" != "" {
 20.         local wgt "[`weight'=`exp']
> "
 21.     }
 22.     else {
 23.         if "`wvar'" == "" local wva
> r "perwt"
 24.         if "`wtype'" == "" local wt
> ype "fw"
 25.         capture confirm variable `w
> var'
 26.         if _rc {
 27.             di as error "Default we
> ight variable `wvar' not found. Either
>  create it or pass weights explicitly.
> "
 28.             exit 111
 29.         }
 30.         local wgt "[`wtype'=`wvar']
> "
 31.     }
 32. 
.     // -------------------------------
> --------------------------------------
.     // Ensure cat/year are numeric fac
> tor-friendly. Encode/destring if neede
> d.
.     // -------------------------------
> --------------------------------------
.     tempvar __cat __year
 33. 
.     local cattype : type `cat'
 34.     if substr("`cattype'",1,3) == "
> str" {
 35.         quietly encode `cat' if `to
> use', gen(`__cat')
 36.         local catv `__cat'
 37.     }
 38.     else {
 39.         local catv `cat'
 40.     }
 41. 
.     local yeartype : type `year'
 42.     if substr("`yeartype'",1,3) == 
> "str" {
 43.         // attempt to destring; if 
> it fails, we exit
.         quietly destring `year' if `to
> use', gen(`__year') force
 44.         capture assert !missing(`__
> year') if `touse'
 45.         if _rc {
 46.             di as error "Year varia
> ble is string and could not be cleanly
>  converted to numeric."
 47.             exit 459
 48.         }
 49.         local yearv `__year'
 50.     }
 51.     else {
 52.         local yearv `year'
 53.     }
 54. 
.     // -------------------------------
> --------------------------------------
.     // Levels for plotting
.     // -------------------------------
> --------------------------------------
.     quietly levelsof `yearv' if `touse
> ', local(yrs)
 55.     quietly levelsof `catv'  if `to
> use', local(cats)
 56. 
.     if "`yrs'" == "" | "`cats'" == "" 
> {
 57.         di as error "No observation
> s available after applying if/in/sampl
> e filters."
 58.         exit 2000
 59.     }
 60. 
.     // Build x-axis positions and labe
> ls
.     local poslist ""
 61.     local xlabel  ""
 62.     local k = 0
 63.     foreach y of local yrs {
 64.         local ++k
 65.         local poslist `poslist' `k'
 66.         local xlabel  `xlabel'  `k'
>  "`y'"
 67.     }
 68. 
.     // -------------------------------
> --------------------------------------
.     // Regression: fully interacted ce
> lls (cat#year) + absorbed FEs, no cons
> tant
.     // Coefficients are adjusted means
>  for each (cat,year) cell conditional 
> on FEs
.     // -------------------------------
> --------------------------------------
.     quietly reghdfe `varlist' i.`catv'
> #i.`yearv' if `touse' `wgt', ///
>         absorb(`absorb') vce(`=cond("`
> vce'"=="","robust","`vce'")') nocons
 69. 
.     estimates store __hdfe_catyear_plo
> t
 70. 
.     // -------------------------------
> --------------------------------------
.     // Build coefplot specs: one line 
> per category level, aligned by year
.     // -------------------------------
> --------------------------------------
.     local plotspecs ""
 71.     local vlab : value label `catv'
 72.         dis "`vlab'"
 73.         
.     foreach c of local cats {
 74.         // series label: value labe
> l if it exists, else cat=value
.         local serieslab "`cat'=`c'"
 75.         if "`vlab'" != "" {
 76.             local tmp : label `vlab
> ' `c'
 77.                         dis "`tmp'"
 78.             if "`tmp'" != "" local 
> serieslab "`tmp'"
 79.         }
 80. 
.         // Coefs in year order for thi
> s category level
.         local keepc ""
 81.         foreach y of local yrs {
 82.             // coefficient name for
> mat: <c>.<catv>#<y>.<yearv>
.             local keepc `keepc' `c'.`c
> atv'#`y'.`yearv'
 83.         }
 84. 
.         // CI display control
.         local ciopt ""
 85.         if "`noci'" != "" local cio
> pt "noci"
 86. 
.         local plotspecs `plotspecs' //
> /
>             (., keep(`keepc') order(`k
> eepc') at(`poslist') label("`serieslab
> '") `ciopt')
 87.     }
 88. 
.     // -------------------------------
> --------------------------------------
.     // Plot
.     // -------------------------------
> --------------------------------------
.     if "`xtitle'" == "" local xtitle "
> Year"
 89.     if "`ytitle'" == "" local ytitl
> e "`varlist' (adjusted mean)"
 90. 
.         dis "`ytitle'"
 91.         
.     coefplot `plotspecs', ///
>         vertical ///
>         xlabel(`xlabel', angle(45)) //
> /
>         xtitle("`xtitle'") ///
>         ytitle("`ytitle'") ///
>         legend(cols(1) position(6) )
 92. 
.     // Save graph if requested (expect
> s a .gph path)
.     if "`saving'" != "" {
 93.         graph save "`saving'" , `re
> place'
 94.     }
 95. end

. 
. 
. ** Load ACS Data 
. use "${data}working/acs_migration_file
> ", replace 

. 
. ** Define sample 
. drop if qmigplc1 == 4                 
>                   // FAILED EDIT OF MI
> GPLACE 
(388,364 observations deleted)

. drop if inlist(state_fips_o, 2, 15)   
>   // ALASKA AND HAWAII 
(136,571 observations deleted)

. 
. ** Define indicator for being in Multn
> omah County in origin/destination year
. gen multnomah_o = state_fips_o == 41 &
>  county_fips_o == 51

. gen multnomah_d = state_fips_d == 41 &
>  county_fips_d == 51

. 
. ** Define samples 
. gen sample_1 = multnomah_o == 1       
>                           // Multnomah
>  in origin-year 

. gen sample_2 = multnomah_o != 1       
>                           // Not in Mu
> ltnomah

. label var sample_1 "Out-migration Samp
> le"

. label var sample_1 "In-migration Sampl
> e"

. 
. ** Define moving indicator 
. gen out_1 = same_county == 0 

. label var out_1 "Moved out of Multnoma
> h"

. gen out_2 = multnomah_d == 1 

. label var out_2 "Moved to Multnomah"

. 
. ** Define variables of interest
. 
. ** Age 
. recode age      (18/24 = 1 "18-24")   
>   ///
>                         (25/44 = 2 "25
> -44")             ///
>                         (45/64 = 3 "45
> -64")     ///
>                         (65/max = 4 "6
> 5+"),     ///
>         gen(cat_age)
(20,893,859 differences between age and 
> cat_age)

. label var cat_age "Age categories"

. 
. ** Sex  
. gen female = sex == 2 

. label var female "Female indicator"

. label define lb_female 0 "Male" 1 "Fem
> ale"

. label values female lb_female 

. 
. ** Marital Status               
. recode marst    (1 = 1 "Married")     
>                           ///
>                                 (2/3 =
>  2 "Seperated")                   ///
>                                 (4/5 =
>  3 "Divourced / Widowed") ///
>                                 (6 = 4
>  "Single"),                           
>     ///
>         gen(cat_married)
(9,061,905 differences between marst and
>  cat_married)

. label var cat_married "Marriage catego
> ries"

. 
. ** Kids at home 
. recode nchild   (0 = 0 "0 Children")  
>                                   ///
>                                 (1 = 1
>  "1 Child")                           
>                     ///
>                                 (2 = 2
>  "2 Children")                        
>             ///
>                                 (3/max
>  = 3 "3+ Children"),                  
>             ///
>         gen(cat_child)
(412,920 differences between nchild and 
> cat_child)

. label var cat_child "Number of Childre
> n"

. 
. ** Education 
. recode educd    (min/61 = 1 "Less than
>  HS")     ///
>                                 (62/71
>  = 2 "HS Diploma")                ///
>                                 (80/10
> 0 = 3 "Some College")     ///
>                                 (101/m
> ax = 4 "College Degree"), ///
>         gen(cat_educ)
(20,893,859 differences between educd an
> d cat_educ)

. label var cat_educ "Education categori
> es"

. 
. ** Earnings / Income 
. gen tmp1 = cpi99 if year == 2023
(18,380,619 missing values generated)

. egen tmp2 = mean(tmp1)

. gen cpi =  cpi99 / tmp2 

. drop tmp1 tmp2 

. 
. ** Loop over income variables 
. foreach var of varlist inctot incwage 
> incearn ftotinc {
  2.         
.         ** Update CPI 
.         gen real_`var' = round(`var' *
>  cpi) 
  3.         
.         ** Categorical variables 
.         recode real_`var'       (min/-
> 1 = 1 "Negative income")          ///
>                                       
>           (0 = 2 "$0")                
>                             ///
>                                       
>           (1/24999 = 3 "$1-$25K")     
>                     ///
>                                       
>           (25000/49999 = 4 "$25K-$50K"
> )           ///
>                                       
>           (50000/99999 = 5 "$50K-$100K
> ")          ///
>                                       
>           (100000/199999 = 6 "$100K-$2
> 00K")       ///
>                                       
>           (200000/max = 7 "$200K+") , 
>             ///
>                         gen(cat_`var')
  4.                         
.         ** Tab
.         tab cat_`var', m 
  5.         
. }
(20,893,859 differences between real_inc
> tot and cat_inctot)

      RECODE of |
    real_inctot |      Freq.     Percent
>         Cum.
----------------+-----------------------
> ------------
Negative income |     20,759        0.10
>         0.10
             $0 |  1,748,089        8.37
>         8.47
        $1-$25K |  6,204,378       29.69
>        38.16
      $25K-$50K |  4,981,113       23.84
>        62.00
     $50K-$100K |  4,947,578       23.68
>        85.68
    $100K-$200K |  2,211,136       10.58
>        96.26
         $200K+ |    780,806        3.74
>       100.00
----------------+-----------------------
> ------------
          Total | 20,893,859      100.00
(20,893,859 differences between real_inc
> wage and cat_incwage)

      RECODE of |
   real_incwage |      Freq.     Percent
>         Cum.
----------------+-----------------------
> ------------
             $0 |  8,182,418       39.16
>        39.16
        $1-$25K |  3,428,895       16.41
>        55.57
      $25K-$50K |  3,290,630       15.75
>        71.32
     $50K-$100K |  3,729,590       17.85
>        89.17
    $100K-$200K |  1,743,819        8.35
>        97.52
         $200K+ |    518,507        2.48
>       100.00
----------------+-----------------------
> ------------
          Total | 20,893,859      100.00
(20,893,859 differences between real_inc
> earn and cat_incearn)

      RECODE of |
   real_incearn |      Freq.     Percent
>         Cum.
----------------+-----------------------
> ------------
Negative income |     16,135        0.08
>         0.08
             $0 |  7,365,326       35.25
>        35.33
        $1-$25K |  3,756,344       17.98
>        53.31
      $25K-$50K |  3,476,928       16.64
>        69.95
     $50K-$100K |  3,876,560       18.55
>        88.50
    $100K-$200K |  1,823,201        8.73
>        97.23
         $200K+ |    579,365        2.77
>       100.00
----------------+-----------------------
> ------------
          Total | 20,893,859      100.00
(20,893,767 differences between real_fto
> tinc and cat_ftotinc)

      RECODE of |
   real_ftotinc |      Freq.     Percent
>         Cum.
----------------+-----------------------
> ------------
Negative income |      7,238        0.03
>         0.03
             $0 |    226,387        1.08
>         1.12
        $1-$25K |  2,249,309       10.77
>        11.88
      $25K-$50K |  3,258,513       15.60
>        27.48
     $50K-$100K |  5,975,505       28.60
>        56.08
    $100K-$200K |  6,147,777       29.42
>        85.50
         $200K+ |  3,029,130       14.50
>       100.00
----------------+-----------------------
> ------------
          Total | 20,893,859      100.00

. 
. ** Label variable 
. label var cat_inctot "Total personal i
> ncome categories (real 2023 USD)"

. label var cat_incwage "Total wage inco
> me categories (real 2023 USD)"

. label var cat_incearn "Total earned in
> come categories (real 2023 USD)"

. label var cat_ftotinc "Total family in
> come categories (real 2023 USD)"

. 
. ** Loop over out- and in-migration 
. forvalues i = 1/2 {
  2.         
.         if `i' == 1 local ytitle "Out-
> migration rate (%)"
  3.         if `i' == 2 local ytitle "I
> n-migration rate (%)"
  4. 
.         ** Loop over categories
.         foreach cat of varlist cat_* {
  5.                 
.                 ** Get label 
.                 local mylabel : variab
> le label `cat'
  6.                 
.                 ** Run Regressions
.                 hdfe_catyear_plot out_
> `i' if sample_`i' == 1,           ///
>                         cat(`cat') yea
> r(year)                               
>                     ///
>                         absorb(state_f
> ips_o county_fips_o cat_*)            
>     ///
>                         wvar(perwt) wt
> ype(fw)                               
>                     ///
>                         ytitle("`ytitl
> e'")                                  
>                             ///
>                         saving("${resu
> lts}fig_`cat'_`i'")
  7.                 
. 
.         } // END CAT LOOP
  8.         
. } // END SAMPLE LOOP 
cat_age
18-24
25-44
45-64
65+
migration not found
r(111);

end of do-file

r(111);

. do "C:\Users\ji252\Documents\GitHub\mu
> ltnomah-county-tax\code\02_indiv_analy
> sis.do"

. /*************************************
> **************************************
> ****
> File Name:              02_indiv_analy
> sis.do
> Creator:                John Iselin
> Date Update:    November 29, 2025
> 
> Called by: 00_multnomah.do
> 
> Purpose: Preform individual-level migr
> ation analysis. 
> 
> Authors: John Iselin 
> 
> For more information, contact john.ise
> lin@yale.edu
> 
> **************************************
> **************************************
> ***/
. 
. ** Start log file 
. capture log close log_02

. log using "${logs}02_log_individual_${
> date}", replace text name(log_02)
----------------------------------------
      name:  log_02
       log:  C:/Users/ji252/Documents/Gi
> tHub/multnomah-county-tax/code/logs/02
> _log_individual_2025-12-15.log
  log type:  text
 opened on:  15 Dec 2025, 21:27:05

. 
. ** Define regression + plotting functi
> on 
. capture program drop hdfe_catyear_plot

. program define hdfe_catyear_plot
  1.     version 16.0
  2.     syntax varname(numeric) [if] [i
> n] [fw aw pw iw] , ///
>         CAT(varname) YEAR(varname) ABS
> ORB(string) ///
>         [ SAMPLE(varname) SVAL(real 1)
>  ///
>           WVAR(varname) WTYPE(string) 
> ///
>           VCE(string) ///
>           TITLE(string asis) XTITLE(st
> ring asis) YTITLE(string asis) ///
>           NOCI ///
>           SAVING(string asis) REPLACE 
> ]
  3. 
.     // -------------------------------
> --------------------------------------
.     // Requirements
.     // -------------------------------
> --------------------------------------
.     capture which reghdfe
  4.     if _rc {
  5.         di as error "reghdfe not fo
> und. Install with: ssc install reghdfe
> , replace"
  6.         exit 198
  7.     }
  8.     capture which coefplot
  9.     if _rc {
 10.         di as error "coefplot not f
> ound. Install with: ssc install coefpl
> ot, replace"
 11.         exit 198
 12.     }
 13. 
.     // -------------------------------
> --------------------------------------
.     // Mark sample
.     // -------------------------------
> --------------------------------------
.     marksample touse, strok
 14.     quietly replace `touse' = `tous
> e' & !missing(`varlist', `cat', `year'
> )
 15. 
.     if "`sample'" != "" {
 16.         quietly replace `touse' = `
> touse' & (`sample' == `sval')
 17.     }
 18. 
.     // -------------------------------
> --------------------------------------
.     // Handle weights: if user didn't 
> pass [pw/fw/...], default to fw=perwt
.     // -------------------------------
> --------------------------------------
.     local wgt ""
 19.     if "`weight'" != "" {
 20.         local wgt "[`weight'=`exp']
> "
 21.     }
 22.     else {
 23.         if "`wvar'" == "" local wva
> r "perwt"
 24.         if "`wtype'" == "" local wt
> ype "fw"
 25.         capture confirm variable `w
> var'
 26.         if _rc {
 27.             di as error "Default we
> ight variable `wvar' not found. Either
>  create it or pass weights explicitly.
> "
 28.             exit 111
 29.         }
 30.         local wgt "[`wtype'=`wvar']
> "
 31.     }
 32. 
.     // -------------------------------
> --------------------------------------
.     // Ensure cat/year are numeric fac
> tor-friendly. Encode/destring if neede
> d.
.     // -------------------------------
> --------------------------------------
.     tempvar __cat __year
 33. 
.     local cattype : type `cat'
 34.     if substr("`cattype'",1,3) == "
> str" {
 35.         quietly encode `cat' if `to
> use', gen(`__cat')
 36.         local catv `__cat'
 37.     }
 38.     else {
 39.         local catv `cat'
 40.     }
 41. 
.     local yeartype : type `year'
 42.     if substr("`yeartype'",1,3) == 
> "str" {
 43.         // attempt to destring; if 
> it fails, we exit
.         quietly destring `year' if `to
> use', gen(`__year') force
 44.         capture assert !missing(`__
> year') if `touse'
 45.         if _rc {
 46.             di as error "Year varia
> ble is string and could not be cleanly
>  converted to numeric."
 47.             exit 459
 48.         }
 49.         local yearv `__year'
 50.     }
 51.     else {
 52.         local yearv `year'
 53.     }
 54. 
.     // -------------------------------
> --------------------------------------
.     // Levels for plotting
.     // -------------------------------
> --------------------------------------
.     quietly levelsof `yearv' if `touse
> ', local(yrs)
 55.     quietly levelsof `catv'  if `to
> use', local(cats)
 56. 
.     if "`yrs'" == "" | "`cats'" == "" 
> {
 57.         di as error "No observation
> s available after applying if/in/sampl
> e filters."
 58.         exit 2000
 59.     }
 60. 
.     // Build x-axis positions and labe
> ls
.     local poslist ""
 61.     local xlabel  ""
 62.     local k = 0
 63.     foreach y of local yrs {
 64.         local ++k
 65.         local poslist `poslist' `k'
 66.         local xlabel  `xlabel'  `k'
>  "`y'"
 67.     }
 68. 
.     // -------------------------------
> --------------------------------------
.     // Regression: fully interacted ce
> lls (cat#year) + absorbed FEs, no cons
> tant
.     // Coefficients are adjusted means
>  for each (cat,year) cell conditional 
> on FEs
.     // -------------------------------
> --------------------------------------
.     quietly reghdfe `varlist' i.`catv'
> #i.`yearv' if `touse' `wgt', ///
>         absorb(`absorb') vce(`=cond("`
> vce'"=="","robust","`vce'")') nocons
 69. 
.     estimates store __hdfe_catyear_plo
> t
 70. 
.     // -------------------------------
> --------------------------------------
.     // Build coefplot specs: one line 
> per category level, aligned by year
.     // -------------------------------
> --------------------------------------
.     local plotspecs ""
 71.     local vlab : value label `catv'
 72.         dis "`vlab'"
 73.         
.     foreach c of local cats {
 74.         // series label: value labe
> l if it exists, else cat=value
.         local serieslab "`cat'=`c'"
 75.         if "`vlab'" != "" {
 76.             local tmp : label `vlab
> ' `c'
 77.             if "`tmp'" != "" local 
> serieslab "`tmp'"
 78.         }
 79. 
.         // Coefs in year order for thi
> s category level
.         local keepc ""
 80.         foreach y of local yrs {
 81.             // coefficient name for
> mat: <c>.<catv>#<y>.<yearv>
.             local keepc `keepc' `c'.`c
> atv'#`y'.`yearv'
 82.                         dis "`keepc
> '"
 83. 
.         }
 84. 
.         // CI display control
.         local ciopt ""
 85.         if "`noci'" != "" local cio
> pt "noci"
 86. 
.         local plotspecs `plotspecs' //
> /
>             (., keep(`keepc') order(`k
> eepc') at(`poslist') label("`serieslab
> '") `ciopt')
 87.                         
.                 dis "`plotspecs'"     
>   
 88.     }
 89. 
.     // -------------------------------
> --------------------------------------
.     // Plot
.     // -------------------------------
> --------------------------------------
.     if "`xtitle'" == "" local xtitle "
> Year"
 90.     if "`ytitle'" == "" local ytitl
> e "`varlist' (adjusted mean)"
 91. 
.         dis "`ytitle'"
 92.         
.     coefplot `plotspecs', ///
>         vertical ///
>         xlabel(`xlabel', angle(45)) //
> /
>         xtitle("`xtitle'") ///
>         ytitle("`ytitle'") ///
>         legend(cols(1) position(6) )
 93. 
.     // Save graph if requested (expect
> s a .gph path)
.     if "`saving'" != "" {
 94.         graph save "`saving'" , `re
> place'
 95.     }
 96. end

. 
. 
. ** Load ACS Data 
. use "${data}working/acs_migration_file
> ", replace 

. 
. ** Define sample 
. drop if qmigplc1 == 4                 
>                   // FAILED EDIT OF MI
> GPLACE 
(388,364 observations deleted)

. drop if inlist(state_fips_o, 2, 15)   
>   // ALASKA AND HAWAII 
(136,571 observations deleted)

. 
. ** Define indicator for being in Multn
> omah County in origin/destination year
. gen multnomah_o = state_fips_o == 41 &
>  county_fips_o == 51

. gen multnomah_d = state_fips_d == 41 &
>  county_fips_d == 51

. 
. ** Define samples 
. gen sample_1 = multnomah_o == 1       
>                           // Multnomah
>  in origin-year 

. gen sample_2 = multnomah_o != 1       
>                           // Not in Mu
> ltnomah

. label var sample_1 "Out-migration Samp
> le"

. label var sample_1 "In-migration Sampl
> e"

. 
. ** Define moving indicator 
. gen out_1 = same_county == 0 

. label var out_1 "Moved out of Multnoma
> h"

. gen out_2 = multnomah_d == 1 

. label var out_2 "Moved to Multnomah"

. 
. ** Define variables of interest
. 
. ** Age 
. recode age      (18/24 = 1 "18-24")   
>   ///
>                         (25/44 = 2 "25
> -44")             ///
>                         (45/64 = 3 "45
> -64")     ///
>                         (65/max = 4 "6
> 5+"),     ///
>         gen(cat_age)
(20,893,859 differences between age and 
> cat_age)

. label var cat_age "Age categories"

. 
. ** Sex  
. gen female = sex == 2 

. label var female "Female indicator"

. label define lb_female 0 "Male" 1 "Fem
> ale"

. label values female lb_female 

. 
. ** Marital Status               
. recode marst    (1 = 1 "Married")     
>                           ///
>                                 (2/3 =
>  2 "Seperated")                   ///
>                                 (4/5 =
>  3 "Divourced / Widowed") ///
>                                 (6 = 4
>  "Single"),                           
>     ///
>         gen(cat_married)
(9,061,905 differences between marst and
>  cat_married)

. label var cat_married "Marriage catego
> ries"

. 
. ** Kids at home 
. recode nchild   (0 = 0 "0 Children")  
>                                   ///
>                                 (1 = 1
>  "1 Child")                           
>                     ///
>                                 (2 = 2
>  "2 Children")                        
>             ///
>                                 (3/max
>  = 3 "3+ Children"),                  
>             ///
>         gen(cat_child)
(412,920 differences between nchild and 
> cat_child)

. label var cat_child "Number of Childre
> n"

. 
. ** Education 
. recode educd    (min/61 = 1 "Less than
>  HS")     ///
>                                 (62/71
>  = 2 "HS Diploma")                ///
>                                 (80/10
> 0 = 3 "Some College")     ///
>                                 (101/m
> ax = 4 "College Degree"), ///
>         gen(cat_educ)
(20,893,859 differences between educd an
> d cat_educ)

. label var cat_educ "Education categori
> es"

. 
. ** Earnings / Income 
. gen tmp1 = cpi99 if year == 2023
(18,380,619 missing values generated)

. egen tmp2 = mean(tmp1)

. gen cpi =  cpi99 / tmp2 

. drop tmp1 tmp2 

. 
. ** Loop over income variables 
. foreach var of varlist inctot incwage 
> incearn ftotinc {
  2.         
.         ** Update CPI 
.         gen real_`var' = round(`var' *
>  cpi) 
  3.         
.         ** Categorical variables 
.         recode real_`var'       (min/-
> 1 = 1 "Negative income")          ///
>                                       
>           (0 = 2 "$0")                
>                             ///
>                                       
>           (1/24999 = 3 "$1-$25K")     
>                     ///
>                                       
>           (25000/49999 = 4 "$25K-$50K"
> )           ///
>                                       
>           (50000/99999 = 5 "$50K-$100K
> ")          ///
>                                       
>           (100000/199999 = 6 "$100K-$2
> 00K")       ///
>                                       
>           (200000/max = 7 "$200K+") , 
>             ///
>                         gen(cat_`var')
  4.                         
.         ** Tab
.         tab cat_`var', m 
  5.         
. }
(20,893,859 differences between real_inc
> tot and cat_inctot)

      RECODE of |
    real_inctot |      Freq.     Percent
>         Cum.
----------------+-----------------------
> ------------
Negative income |     20,759        0.10
>         0.10
             $0 |  1,748,089        8.37
>         8.47
        $1-$25K |  6,204,378       29.69
>        38.16
      $25K-$50K |  4,981,113       23.84
>        62.00
     $50K-$100K |  4,947,578       23.68
>        85.68
    $100K-$200K |  2,211,136       10.58
>        96.26
         $200K+ |    780,806        3.74
>       100.00
----------------+-----------------------
> ------------
          Total | 20,893,859      100.00
(20,893,859 differences between real_inc
> wage and cat_incwage)

      RECODE of |
   real_incwage |      Freq.     Percent
>         Cum.
----------------+-----------------------
> ------------
             $0 |  8,182,418       39.16
>        39.16
        $1-$25K |  3,428,895       16.41
>        55.57
      $25K-$50K |  3,290,630       15.75
>        71.32
     $50K-$100K |  3,729,590       17.85
>        89.17
    $100K-$200K |  1,743,819        8.35
>        97.52
         $200K+ |    518,507        2.48
>       100.00
----------------+-----------------------
> ------------
          Total | 20,893,859      100.00
(20,893,859 differences between real_inc
> earn and cat_incearn)

      RECODE of |
   real_incearn |      Freq.     Percent
>         Cum.
----------------+-----------------------
> ------------
Negative income |     16,135        0.08
>         0.08
             $0 |  7,365,326       35.25
>        35.33
        $1-$25K |  3,756,344       17.98
>        53.31
      $25K-$50K |  3,476,928       16.64
>        69.95
     $50K-$100K |  3,876,560       18.55
>        88.50
    $100K-$200K |  1,823,201        8.73
>        97.23
         $200K+ |    579,365        2.77
>       100.00
----------------+-----------------------
> ------------
          Total | 20,893,859      100.00
(20,893,767 differences between real_fto
> tinc and cat_ftotinc)

      RECODE of |
   real_ftotinc |      Freq.     Percent
>         Cum.
----------------+-----------------------
> ------------
Negative income |      7,238        0.03
>         0.03
             $0 |    226,387        1.08
>         1.12
        $1-$25K |  2,249,309       10.77
>        11.88
      $25K-$50K |  3,258,513       15.60
>        27.48
     $50K-$100K |  5,975,505       28.60
>        56.08
    $100K-$200K |  6,147,777       29.42
>        85.50
         $200K+ |  3,029,130       14.50
>       100.00
----------------+-----------------------
> ------------
          Total | 20,893,859      100.00

. 
. ** Label variable 
. label var cat_inctot "Total personal i
> ncome categories (real 2023 USD)"

. label var cat_incwage "Total wage inco
> me categories (real 2023 USD)"

. label var cat_incearn "Total earned in
> come categories (real 2023 USD)"

. label var cat_ftotinc "Total family in
> come categories (real 2023 USD)"

. 
. ** Loop over out- and in-migration 
. forvalues i = 1/2 {
  2.         
.         if `i' == 1 local ytitle "Out-
> migration rate (%)"
  3.         if `i' == 2 local ytitle "I
> n-migration rate (%)"
  4. 
.         ** Loop over categories
.         foreach cat of varlist cat_* {
  5.                 
.                 ** Get label 
.                 local mylabel : variab
> le label `cat'
  6.                 
.                 ** Run Regressions
.                 hdfe_catyear_plot out_
> `i' if sample_`i' == 1,           ///
>                         cat(`cat') yea
> r(year)                               
>                     ///
>                         absorb(state_f
> ips_o county_fips_o cat_*)            
>     ///
>                         wvar(perwt) wt
> ype(fw)                               
>                     ///
>                         ytitle("`ytitl
> e'")                                  
>                             ///
>                         saving("${resu
> lts}fig_`cat'_`i'")
  7.                 
. 
.         } // END CAT LOOP
  8.         
. } // END SAMPLE LOOP 
cat_age
1.cat_age#2015.year
1.cat_age#2015.year 1.cat_age#2016.year
1.cat_age#2015.year 1.cat_age#2016.year 
> 1.cat_age#2017.year
1.cat_age#2015.year 1.cat_age#2016.year 
> 1.cat_age#2017.year 1.cat_age#2018.yea
> r
1.cat_age#2015.year 1.cat_age#2016.year 
> 1.cat_age#2017.year 1.cat_age#2018.yea
> r 1.cat_age#2019.year
1.cat_age#2015.year 1.cat_age#2016.year 
> 1.cat_age#2017.year 1.cat_age#2018.yea
> r 1.cat_age#2019.year 1.cat_age#2020.y
> ear
1.cat_age#2015.year 1.cat_age#2016.year 
> 1.cat_age#2017.year 1.cat_age#2018.yea
> r 1.cat_age#2019.year 1.cat_age#2020.y
> ear 1.cat_age#2021.year
1.cat_age#2015.year 1.cat_age#2016.year 
> 1.cat_age#2017.year 1.cat_age#2018.yea
> r 1.cat_age#2019.year 1.cat_age#2020.y
> ear 1.cat_age#2021.year 1.cat_age#2022
> .year
1.cat_age#2015.year 1.cat_age#2016.year 
> 1.cat_age#2017.year 1.cat_age#2018.yea
> r 1.cat_age#2019.year 1.cat_age#2020.y
> ear 1.cat_age#2021.year 1.cat_age#2022
> .year 1.cat_age#2023.year
(., keep(1.cat_age#2015.year 1.cat_age#2
> 016.year 1.cat_age#2017.year 1.cat_age
> #2018.year 1.cat_age#2019.year 1.cat_a
> ge#2020.year 1.cat_age#2021.year 1.cat
> _age#2022.year 1.cat_age#2023.year) or
> der(1.cat_age#2015.year 1.cat_age#2016
> .year 1.cat_age#2017.year 1.cat_age#20
> 18.year 1.cat_age#2019.year 1.cat_age#
> 2020.year 1.cat_age#2021.year 1.cat_ag
> e#2022.year 1.cat_age#2023.year) at(1 
> 2 3 4 5 6 7 8 9) label(24") )" invalid
>  name
r(198);

end of do-file

r(198);

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_00002d.tmp"

. 
. ** Define regression + plotting function 
. capture program drop hdfe_catyear_plot

. program define hdfe_catyear_plot
  1.     version 16.0
  2.     syntax varname(numeric) [if] [in] [fw aw pw iw] , ///
>         CAT(varname) YEAR(varname) ABSORB(string) ///
>         [ SAMPLE(varname) SVAL(real 1) ///
>           WVAR(varname) WTYPE(string) ///
>           VCE(string) ///
>           TITLE(string asis) XTITLE(string asis) YTITLE(string asi
> s) ///
>           NOCI ///
>           SAVING(string asis) REPLACE ]
  3. 
.     // -----------------------------------------------------------
> ----------
.     // Requirements
.     // -----------------------------------------------------------
> ----------
.     capture which reghdfe
  4.     if _rc {
  5.         di as error "reghdfe not found. Install with: ssc insta
> ll reghdfe, replace"
  6.         exit 198
  7.     }
  8.     capture which coefplot
  9.     if _rc {
 10.         di as error "coefplot not found. Install with: ssc inst
> all coefplot, replace"
 11.         exit 198
 12.     }
 13. 
.     // -----------------------------------------------------------
> ----------
.     // Mark sample
.     // -----------------------------------------------------------
> ----------
.     marksample touse, strok
 14.     quietly replace `touse' = `touse' & !missing(`varlist', `ca
> t', `year')
 15. 
.     if "`sample'" != "" {
 16.         quietly replace `touse' = `touse' & (`sample' == `sval'
> )
 17.     }
 18. 
.     // -----------------------------------------------------------
> ----------
.     // Handle weights: if user didn't pass [pw/fw/...], default to
>  fw=perwt
.     // -----------------------------------------------------------
> ----------
.     local wgt ""
 19.     if "`weight'" != "" {
 20.         local wgt "[`weight'=`exp']"
 21.     }
 22.     else {
 23.         if "`wvar'" == "" local wvar "perwt"
 24.         if "`wtype'" == "" local wtype "fw"
 25.         capture confirm variable `wvar'
 26.         if _rc {
 27.             di as error "Default weight variable `wvar' not fou
> nd. Either create it or pass weights explicitly."
 28.             exit 111
 29.         }
 30.         local wgt "[`wtype'=`wvar']"
 31.     }
 32. 
.     // -----------------------------------------------------------
> ----------
.     // Ensure cat/year are numeric factor-friendly. Encode/destrin
> g if needed.
.     // -----------------------------------------------------------
> ----------
.     tempvar __cat __year
 33. 
.     local cattype : type `cat'
 34.     if substr("`cattype'",1,3) == "str" {
 35.         quietly encode `cat' if `touse', gen(`__cat')
 36.         local catv `__cat'
 37.     }
 38.     else {
 39.         local catv `cat'
 40.     }
 41. 
.     local yeartype : type `year'
 42.     if substr("`yeartype'",1,3) == "str" {
 43.         // attempt to destring; if it fails, we exit
.         quietly destring `year' if `touse', gen(`__year') force
 44.         capture assert !missing(`__year') if `touse'
 45.         if _rc {
 46.             di as error "Year variable is string and could not 
> be cleanly converted to numeric."
 47.             exit 459
 48.         }
 49.         local yearv `__year'
 50.     }
 51.     else {
 52.         local yearv `year'
 53.     }
 54. 
.     // -----------------------------------------------------------
> ----------
.     // Levels for plotting
.     // -----------------------------------------------------------
> ----------
.     quietly levelsof `yearv' if `touse', local(yrs)
 55.     quietly levelsof `catv'  if `touse', local(cats)
 56. 
.     if "`yrs'" == "" | "`cats'" == "" {
 57.         di as error "No observations available after applying i
> f/in/sample filters."
 58.         exit 2000
 59.     }
 60. 
.     // Build x-axis positions and labels
.     local poslist ""
 61.     local xlabel  ""
 62.     local k = 0
 63.     foreach y of local yrs {
 64.         local ++k
 65.         local poslist `poslist' `k'
 66.         local xlabel  `xlabel'  `k' "`y'"
 67.     }
 68. 
.     // -----------------------------------------------------------
> ----------
.     // Regression: fully interacted cells (cat#year) + absorbed FE
> s, no constant
.     // Coefficients are adjusted means for each (cat,year) cell co
> nditional on FEs
.     // -----------------------------------------------------------
> ----------
.     quietly reghdfe `varlist' i.`catv'#i.`yearv' if `touse' `wgt',
>  ///
>         absorb(`absorb') vce(`=cond("`vce'"=="","robust","`vce'")'
> ) nocons
 69. 
.     estimates store __hdfe_catyear_plot
 70. 
.     // -----------------------------------------------------------
> ----------
.     // Build coefplot specs: one line per category level, aligned 
> by year
.     // -----------------------------------------------------------
> ----------
.     local plotspecs ""
 71.     local vlab : value label `catv'
 72.         
.         dis "`cats'"
 73.         
.     foreach c of local cats {
 74.         // series label: value label if it exists, else cat=val
> ue
.         local serieslab "`cat'=`c'"
 75.         if "`vlab'" != "" {
 76.             local tmp : label `vlab' `c'
 77.             if "`tmp'" != "" local serieslab "`tmp'"
 78.         }
 79. 
.         // Coefs in year order for this category level
.         local keepc ""
 80.         foreach y of local yrs {
 81.             // coefficient name format: <c>.<catv>#<y>.<yearv>
.             local keepc `keepc' `c'.`catv'#`y'.`yearv'
 82. 
.         }
 83. 
.         // CI display control
.         local ciopt ""
 84.         if "`noci'" != "" local ciopt "noci"
 85. 
.         local plotspecs `plotspecs' ///
>             (., keep(`keepc') order(`keepc') at(`poslist') label("
> `serieslab'") `ciopt')
 86.                         
.     }
 87. 
.     // -----------------------------------------------------------
> ----------
.     // Plot
.     // -----------------------------------------------------------
> ----------
.     if "`xtitle'" == "" local xtitle "Year"
 88.     if "`ytitle'" == "" local ytitle "`varlist' (adjusted mean)
> "
 89. 
.         dis "`ytitle'"
 90.         
.     coefplot `plotspecs', ///
>         vertical ///
>         xlabel(`xlabel', angle(45)) ///
>         xtitle("`xtitle'") ///
>         ytitle("`ytitle'") ///
>         legend(cols(1) position(6) )
 91. 
.     // Save graph if requested (expects a .gph path)
.     if "`saving'" != "" {
 92.         graph save "`saving'" , `replace'
 93.     }
 94. end

. 
end of do-file

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_00002e.tmp"

. 
. ** Loop over out- and in-migration 
. forvalues i = 1/2 {
  2.         
.         if `i' == 1 local ytitle "Out-migration rate (%)"
  3.         if `i' == 2 local ytitle "In-migration rate (%)"
  4. 
.         ** Loop over categories
.         foreach cat of varlist cat_* {
  5.                 
.                 ** Get label 
.                 local mylabel : variable label `cat'
  6.                 
.                 ** Run Regressions
.                 hdfe_catyear_plot out_`i' if sample_`i' == 1,     
>       ///
>                         cat(`cat') year(year)                     
>                               ///
>                         absorb(state_fips_o county_fips_o cat_*)  
>               ///
>                         wvar(perwt) wtype(fw)                     
>                               ///
>                         ytitle("`ytitle'")                        
>                                       ///
>                         saving("${results}fig_`cat'_`i'") replace 
  7.                 
. 
.         } // END CAT LOOP
  8.         
. } // END SAMPLE LOOP 
1 2 3 4
migration not found
r(111);

end of do-file

r(111);

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_00002f.tmp"

. 
. ** Define regression + plotting function 
. capture program drop hdfe_catyear_plot

. program define hdfe_catyear_plot
  1.     version 16.0
  2.     syntax varname(numeric) [if] [in] [fw aw pw iw] , ///
>         CAT(varname) YEAR(varname) ABSORB(string) ///
>         [ SAMPLE(varname) SVAL(real 1) ///
>           WVAR(varname) WTYPE(string) ///
>           VCE(string) ///
>           TITLE(string asis) XTITLE(string asis) YTITLE(string asi
> s) ///
>           NOCI ///
>           SAVING(string asis) REPLACE ]
  3. 
.     // -----------------------------------------------------------
> ----------
.     // Requirements
.     // -----------------------------------------------------------
> ----------
.     capture which reghdfe
  4.     if _rc {
  5.         di as error "reghdfe not found. Install with: ssc insta
> ll reghdfe, replace"
  6.         exit 198
  7.     }
  8.     capture which coefplot
  9.     if _rc {
 10.         di as error "coefplot not found. Install with: ssc inst
> all coefplot, replace"
 11.         exit 198
 12.     }
 13. 
.     // -----------------------------------------------------------
> ----------
.     // Mark sample
.     // -----------------------------------------------------------
> ----------
.     marksample touse, strok
 14.     quietly replace `touse' = `touse' & !missing(`varlist', `ca
> t', `year')
 15. 
.     if "`sample'" != "" {
 16.         quietly replace `touse' = `touse' & (`sample' == `sval'
> )
 17.     }
 18. 
.     // -----------------------------------------------------------
> ----------
.     // Handle weights: if user didn't pass [pw/fw/...], default to
>  fw=perwt
.     // -----------------------------------------------------------
> ----------
.     local wgt ""
 19.     if "`weight'" != "" {
 20.         local wgt "[`weight'=`exp']"
 21.     }
 22.     else {
 23.         if "`wvar'" == "" local wvar "perwt"
 24.         if "`wtype'" == "" local wtype "fw"
 25.         capture confirm variable `wvar'
 26.         if _rc {
 27.             di as error "Default weight variable `wvar' not fou
> nd. Either create it or pass weights explicitly."
 28.             exit 111
 29.         }
 30.         local wgt "[`wtype'=`wvar']"
 31.     }
 32. 
.     // -----------------------------------------------------------
> ----------
.     // Ensure cat/year are numeric factor-friendly. Encode/destrin
> g if needed.
.     // -----------------------------------------------------------
> ----------
.     tempvar __cat __year
 33. 
.     local cattype : type `cat'
 34.     if substr("`cattype'",1,3) == "str" {
 35.         quietly encode `cat' if `touse', gen(`__cat')
 36.         local catv `__cat'
 37.     }
 38.     else {
 39.         local catv `cat'
 40.     }
 41. 
.     local yeartype : type `year'
 42.     if substr("`yeartype'",1,3) == "str" {
 43.         // attempt to destring; if it fails, we exit
.         quietly destring `year' if `touse', gen(`__year') force
 44.         capture assert !missing(`__year') if `touse'
 45.         if _rc {
 46.             di as error "Year variable is string and could not 
> be cleanly converted to numeric."
 47.             exit 459
 48.         }
 49.         local yearv `__year'
 50.     }
 51.     else {
 52.         local yearv `year'
 53.     }
 54. 
.     // -----------------------------------------------------------
> ----------
.     // Levels for plotting
.     // -----------------------------------------------------------
> ----------
.     quietly levelsof `yearv' if `touse', local(yrs)
 55.     quietly levelsof `catv'  if `touse', local(cats)
 56. 
.     if "`yrs'" == "" | "`cats'" == "" {
 57.         di as error "No observations available after applying i
> f/in/sample filters."
 58.         exit 2000
 59.     }
 60. 
.     // Build x-axis positions and labels
.     local poslist ""
 61.     local xlabel  ""
 62.     local k = 0
 63.     foreach y of local yrs {
 64.         local ++k
 65.         local poslist `poslist' `k'
 66.         local xlabel  `xlabel'  `k' "`y'"
 67.     }
 68. 
.     // -----------------------------------------------------------
> ----------
.     // Regression: fully interacted cells (cat#year) + absorbed FE
> s, no constant
.     // Coefficients are adjusted means for each (cat,year) cell co
> nditional on FEs
.     // -----------------------------------------------------------
> ----------
.     quietly reghdfe `varlist' i.`catv'#i.`yearv' if `touse' `wgt',
>  ///
>         absorb(`absorb') vce(`=cond("`vce'"=="","robust","`vce'")'
> ) nocons
 69. 
.     estimates store __hdfe_catyear_plot
 70. 
.     // -----------------------------------------------------------
> ----------
.     // Build coefplot specs: one line per category level, aligned 
> by year
.     // -----------------------------------------------------------
> ----------
.     local plotspecs ""
 71.     local vlab : value label `catv'
 72.         
.         dis "`cats'"
 73.         
.     foreach c of local cats {
 74.         // series label: value label if it exists, else cat=val
> ue
.         local serieslab "`cat'=`c'"
 75.         if "`vlab'" != "" {
 76.             local tmp : label `vlab' `c'
 77.             if "`tmp'" != "" local serieslab "`tmp'"
 78.         }
 79. 
.         // Coefs in year order for this category level
.         local keepc ""
 80.         foreach y of local yrs {
 81.             // coefficient name format: <c>.<catv>#<y>.<yearv>
.             local keepc `keepc' `c'.`catv'#`y'.`yearv'
 82. 
.         }
 83. 
.         // CI display control
.         local ciopt ""
 84.         if "`noci'" != "" local ciopt "noci"
 85. 
.         local plotspecs `plotspecs' ///
>             (., keep(`keepc') order(`keepc') at(`poslist') label("
> `serieslab'") `ciopt')
 86.                         
.                 dis "test "     
 87.                         
.     }
 88. 
.     // -----------------------------------------------------------
> ----------
.     // Plot
.     // -----------------------------------------------------------
> ----------
.     if "`xtitle'" == "" local xtitle "Year"
 89.         dis "`xtitle'"
 90.     if "`ytitle'" == "" local ytitle "`varlist' (adjusted mean)
> "
 91. 
.         dis "`ytitle'"
 92.         
.     coefplot `plotspecs', ///
>         vertical ///
>         xlabel(`xlabel', angle(45)) ///
>         xtitle("`xtitle'") ///
>         ytitle("`ytitle'") ///
>         legend(cols(1) position(6) )
 93. 
.     // Save graph if requested (expects a .gph path)
.     if "`saving'" != "" {
 94.         graph save "`saving'" , `replace'
 95.     }
 96. end

. 
. 
end of do-file

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_00002g.tmp"

. ** Loop over out- and in-migration 
. forvalues i = 1/2 {
  2.         
.         if `i' == 1 local ytitle "Out-migration rate (%)"
  3.         if `i' == 2 local ytitle "In-migration rate (%)"
  4. 
.         ** Loop over categories
.         foreach cat of varlist cat_* {
  5.                 
.                 ** Get label 
.                 local mylabel : variable label `cat'
  6.                 
.                 ** Run Regressions
.                 hdfe_catyear_plot out_`i' if sample_`i' == 1,     
>       ///
>                         cat(`cat') year(year)                     
>                               ///
>                         absorb(state_fips_o county_fips_o cat_*)  
>               ///
>                         wvar(perwt) wtype(fw)                     
>                               ///
>                         ytitle("`ytitle'")                        
>                                       ///
>                         saving("${results}fig_`cat'_`i'") replace 
  7.                 
. 
.         } // END CAT LOOP
  8.         
. } // END SAMPLE LOOP 
1 2 3 4
test 
test 
test 
test 
Year
migration not found
r(111);

end of do-file

r(111);

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_00002h.tmp"

. ** Loop over out- and in-migration 
. forvalues i = 1/2 {
  2.         
.         if `i' == 1 local ytitle_txt "Out-migration rate (%)"
  3.         if `i' == 2 local ytitle_txt "In-migration rate (%)"
  4. 
.         ** Loop over categories
.         foreach cat of varlist cat_* {
  5.                 
.                 ** Get label 
.                 local mylabel : variable label `cat'
  6.                 
.                 ** Run Regressions
.                 hdfe_catyear_plot out_`i' if sample_`i' == 1,     
>       ///
>                         cat(`cat') year(year)                     
>                               ///
>                         absorb(state_fips_o county_fips_o cat_*)  
>               ///
>                         wvar(perwt) wtype(fw)                     
>                               ///
>                         ytitle("`ytitle_txt'")                    
>                                       ///
>                         saving("${results}fig_`cat'_`i'") replace 
  7.                 
. 
.         } // END CAT LOOP
  8.         
. } // END SAMPLE LOOP 
1 2 3 4
test 
test 
test 
test 
Year
migration not found
r(111);

end of do-file

r(111);

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_00002i.tmp"

. 
. ** Define regression + plotting function 
. capture program drop hdfe_catyear_plot

. program define hdfe_catyear_plot
  1.     version 16.0
  2.     syntax varname(numeric) [if] [in] [fw aw pw iw] , ///
>         CAT(varname) YEAR(varname) ABSORB(string) ///
>         [ SAMPLE(varname) SVAL(real 1) ///
>           WVAR(varname) WTYPE(string) ///
>           VCE(string) ///
>           TITLE(string asis) XTITLE(string asis) YTITLE(string asi
> s) ///
>           NOCI ///
>           SAVING(string asis) REPLACE ]
  3. 
.     // -----------------------------------------------------------
> ----------
.     // Requirements
.     // -----------------------------------------------------------
> ----------
.     capture which reghdfe
  4.     if _rc {
  5.         di as error "reghdfe not found. Install with: ssc insta
> ll reghdfe, replace"
  6.         exit 198
  7.     }
  8.     capture which coefplot
  9.     if _rc {
 10.         di as error "coefplot not found. Install with: ssc inst
> all coefplot, replace"
 11.         exit 198
 12.     }
 13. 
.     // -----------------------------------------------------------
> ----------
.     // Mark sample
.     // -----------------------------------------------------------
> ----------
.     marksample touse, strok
 14.     quietly replace `touse' = `touse' & !missing(`varlist', `ca
> t', `year')
 15. 
.     if "`sample'" != "" {
 16.         quietly replace `touse' = `touse' & (`sample' == `sval'
> )
 17.     }
 18. 
.     // -----------------------------------------------------------
> ----------
.     // Handle weights: if user didn't pass [pw/fw/...], default to
>  fw=perwt
.     // -----------------------------------------------------------
> ----------
.     local wgt ""
 19.     if "`weight'" != "" {
 20.         local wgt "[`weight'=`exp']"
 21.     }
 22.     else {
 23.         if "`wvar'" == "" local wvar "perwt"
 24.         if "`wtype'" == "" local wtype "fw"
 25.         capture confirm variable `wvar'
 26.         if _rc {
 27.             di as error "Default weight variable `wvar' not fou
> nd. Either create it or pass weights explicitly."
 28.             exit 111
 29.         }
 30.         local wgt "[`wtype'=`wvar']"
 31.     }
 32. 
.     // -----------------------------------------------------------
> ----------
.     // Ensure cat/year are numeric factor-friendly. Encode/destrin
> g if needed.
.     // -----------------------------------------------------------
> ----------
.     tempvar __cat __year
 33. 
.     local cattype : type `cat'
 34.     if substr("`cattype'",1,3) == "str" {
 35.         quietly encode `cat' if `touse', gen(`__cat')
 36.         local catv `__cat'
 37.     }
 38.     else {
 39.         local catv `cat'
 40.     }
 41. 
.     local yeartype : type `year'
 42.     if substr("`yeartype'",1,3) == "str" {
 43.         // attempt to destring; if it fails, we exit
.         quietly destring `year' if `touse', gen(`__year') force
 44.         capture assert !missing(`__year') if `touse'
 45.         if _rc {
 46.             di as error "Year variable is string and could not 
> be cleanly converted to numeric."
 47.             exit 459
 48.         }
 49.         local yearv `__year'
 50.     }
 51.     else {
 52.         local yearv `year'
 53.     }
 54. 
.     // -----------------------------------------------------------
> ----------
.     // Levels for plotting
.     // -----------------------------------------------------------
> ----------
.     quietly levelsof `yearv' if `touse', local(yrs)
 55.     quietly levelsof `catv'  if `touse', local(cats)
 56. 
.     if "`yrs'" == "" | "`cats'" == "" {
 57.         di as error "No observations available after applying i
> f/in/sample filters."
 58.         exit 2000
 59.     }
 60. 
.     // Build x-axis positions and labels
.     local poslist ""
 61.     local xlabel  ""
 62.     local k = 0
 63.     foreach y of local yrs {
 64.         local ++k
 65.         local poslist `poslist' `k'
 66.         local xlabel  `xlabel'  `k' "`y'"
 67.     }
 68. 
.     // -----------------------------------------------------------
> ----------
.     // Regression: fully interacted cells (cat#year) + absorbed FE
> s, no constant
.     // Coefficients are adjusted means for each (cat,year) cell co
> nditional on FEs
.     // -----------------------------------------------------------
> ----------
.     quietly reghdfe `varlist' i.`catv'#i.`yearv' if `touse' `wgt',
>  ///
>         absorb(`absorb') vce(`=cond("`vce'"=="","robust","`vce'")'
> ) nocons
 69. 
.     estimates store __hdfe_catyear_plot
 70. 
.     // -----------------------------------------------------------
> ----------
.     // Build coefplot specs: one line per category level, aligned 
> by year
.     // -----------------------------------------------------------
> ----------
.     local plotspecs ""
 71.     local vlab : value label `catv'
 72. 
.         
.     foreach c of local cats {
 73.         // series label: value label if it exists, else cat=val
> ue
.         local serieslab "`cat'=`c'"
 74.         if "`vlab'" != "" {
 75.             local tmp : label `vlab' `c'
 76.             if "`tmp'" != "" local serieslab "`tmp'"
 77.         }
 78. 
.         // Coefs in year order for this category level
.         local keepc ""
 79.         foreach y of local yrs {
 80.             // coefficient name format: <c>.<catv>#<y>.<yearv>
.             local keepc `keepc' `c'.`catv'#`y'.`yearv'
 81. 
.         }
 82. 
.         // CI display control
.         local ciopt ""
 83.         if "`noci'" != "" local ciopt "noci"
 84. 
.         local plotspecs `plotspecs' ///
>             (., keep(`keepc') order(`keepc') at(`poslist') label("
> `serieslab'") `ciopt')
 85.                                                 
.     }
 86. 
.     // -----------------------------------------------------------
> ----------
.     // Plot
.     // -----------------------------------------------------------
> ----------
.     if "`xtitle'" == "" local xtitle "Year"
 87.         dis "`xtitle'"
 88.     *if "`ytitle'" == "" local ytitle "`varlist' (adjusted mean
> )"
. 
.         dis "`ytitle'"
 89.         
.     coefplot `plotspecs', ///
>         vertical ///
>         xlabel(`xlabel', angle(45)) ///
>         xtitle("`xtitle'") ///
>         ytitle("`ytitle'") ///
>         legend(cols(1) position(6) )
 90. 
.     // Save graph if requested (expects a .gph path)
.     if "`saving'" != "" {
 91.         graph save "`saving'" , `replace'
 92.     }
 93. end

. 
end of do-file

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_00002j.tmp"

. ** Loop over out- and in-migration 
. forvalues i = 1/2 {
  2.         
.         if `i' == 1 local ytitle_txt "Out-migration rate (%)"
  3.         if `i' == 2 local ytitle_txt "In-migration rate (%)"
  4. 
.         ** Loop over categories
.         foreach cat of varlist cat_* {
  5.                 
.                 ** Get label 
.                 local mylabel : variable label `cat'
  6.                 
.                 ** Run Regressions
.                 hdfe_catyear_plot out_`i' if sample_`i' == 1,     
>       ///
>                         cat(`cat') year(year)                     
>                               ///
>                         absorb(state_fips_o county_fips_o cat_*)  
>               ///
>                         wvar(perwt) wtype(fw)                     
>                               ///
>                         ytitle("`ytitle_txt'")                    
>                                       ///
>                         saving("${results}fig_`cat'_`i'") replace 
  7.                 
. 
.         } // END CAT LOOP
  8.         
. } // END SAMPLE LOOP 
Year
Out not found
r(111);

end of do-file

r(111);

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_00002k.tmp"

. ** Define regression + plotting function 
. capture program drop hdfe_catyear_plot

. program define hdfe_catyear_plot
  1.     version 16.0
  2.     syntax varname(numeric) [if] [in] [fw aw pw iw] , ///
>         CAT(varname) YEAR(varname) ABSORB(string) ///
>         [ SAMPLE(varname) SVAL(real 1) ///
>           WVAR(varname) WTYPE(string) ///
>           VCE(string) ///
>           TITLE(string asis) XTITLE(string asis) YTITLE(string asi
> s) ///
>           NOCI ///
>           SAVING(string asis) REPLACE ]
  3. 
.     // -----------------------------------------------------------
> ----------
.     // Requirements
.     // -----------------------------------------------------------
> ----------
.     capture which reghdfe
  4.     if _rc {
  5.         di as error "reghdfe not found. Install with: ssc insta
> ll reghdfe, replace"
  6.         exit 198
  7.     }
  8.     capture which coefplot
  9.     if _rc {
 10.         di as error "coefplot not found. Install with: ssc inst
> all coefplot, replace"
 11.         exit 198
 12.     }
 13. 
.     // -----------------------------------------------------------
> ----------
.     // Mark sample
.     // -----------------------------------------------------------
> ----------
.     marksample touse, strok
 14.     quietly replace `touse' = `touse' & !missing(`varlist', `ca
> t', `year')
 15. 
.     if "`sample'" != "" {
 16.         quietly replace `touse' = `touse' & (`sample' == `sval'
> )
 17.     }
 18. 
.     // -----------------------------------------------------------
> ----------
.     // Handle weights: if user didn't pass [pw/fw/...], default to
>  fw=perwt
.     // -----------------------------------------------------------
> ----------
.     local wgt ""
 19.     if "`weight'" != "" {
 20.         local wgt "[`weight'=`exp']"
 21.     }
 22.     else {
 23.         if "`wvar'" == "" local wvar "perwt"
 24.         if "`wtype'" == "" local wtype "fw"
 25.         capture confirm variable `wvar'
 26.         if _rc {
 27.             di as error "Default weight variable `wvar' not fou
> nd. Either create it or pass weights explicitly."
 28.             exit 111
 29.         }
 30.         local wgt "[`wtype'=`wvar']"
 31.     }
 32. 
.     // -----------------------------------------------------------
> ----------
.     // Ensure cat/year are numeric factor-friendly. Encode/destrin
> g if needed.
.     // -----------------------------------------------------------
> ----------
.     tempvar __cat __year
 33. 
.     local cattype : type `cat'
 34.     if substr("`cattype'",1,3) == "str" {
 35.         quietly encode `cat' if `touse', gen(`__cat')
 36.         local catv `__cat'
 37.     }
 38.     else {
 39.         local catv `cat'
 40.     }
 41. 
.     local yeartype : type `year'
 42.     if substr("`yeartype'",1,3) == "str" {
 43.         // attempt to destring; if it fails, we exit
.         quietly destring `year' if `touse', gen(`__year') force
 44.         capture assert !missing(`__year') if `touse'
 45.         if _rc {
 46.             di as error "Year variable is string and could not 
> be cleanly converted to numeric."
 47.             exit 459
 48.         }
 49.         local yearv `__year'
 50.     }
 51.     else {
 52.         local yearv `year'
 53.     }
 54. 
.     // -----------------------------------------------------------
> ----------
.     // Levels for plotting
.     // -----------------------------------------------------------
> ----------
.     quietly levelsof `yearv' if `touse', local(yrs)
 55.     quietly levelsof `catv'  if `touse', local(cats)
 56. 
.     if "`yrs'" == "" | "`cats'" == "" {
 57.         di as error "No observations available after applying i
> f/in/sample filters."
 58.         exit 2000
 59.     }
 60. 
.     // Build x-axis positions and labels
.     local poslist ""
 61.     local xlabel  ""
 62.     local k = 0
 63.     foreach y of local yrs {
 64.         local ++k
 65.         local poslist `poslist' `k'
 66.         local xlabel  `xlabel'  `k' "`y'"
 67.     }
 68. 
.     // -----------------------------------------------------------
> ----------
.     // Regression: fully interacted cells (cat#year) + absorbed FE
> s, no constant
.     // Coefficients are adjusted means for each (cat,year) cell co
> nditional on FEs
.     // -----------------------------------------------------------
> ----------
.     quietly reghdfe `varlist' i.`catv'#i.`yearv' if `touse' `wgt',
>  ///
>         absorb(`absorb') vce(`=cond("`vce'"=="","robust","`vce'")'
> ) nocons
 69. 
.     estimates store __hdfe_catyear_plot
 70. 
.     // -----------------------------------------------------------
> ----------
.     // Build coefplot specs: one line per category level, aligned 
> by year
.     // -----------------------------------------------------------
> ----------
.     local plotspecs ""
 71.     local vlab : value label `catv'
 72. 
.         
.     foreach c of local cats {
 73.         // series label: value label if it exists, else cat=val
> ue
.         local serieslab "`cat'=`c'"
 74.         if "`vlab'" != "" {
 75.             local tmp : label `vlab' `c'
 76.             if "`tmp'" != "" local serieslab "`tmp'"
 77.         }
 78. 
.         // Coefs in year order for this category level
.         local keepc ""
 79.         foreach y of local yrs {
 80.             // coefficient name format: <c>.<catv>#<y>.<yearv>
.             local keepc `keepc' `c'.`catv'#`y'.`yearv'
 81. 
.         }
 82. 
.         // CI display control
.         local ciopt ""
 83.         if "`noci'" != "" local ciopt "noci"
 84. 
.         local plotspecs `plotspecs' ///
>             (., keep(`keepc') order(`keepc') at(`poslist') label("
> `serieslab'") `ciopt')
 85.                                                 
.     }
 86. 
.     // -----------------------------------------------------------
> ----------
.     // Plot
.     // -----------------------------------------------------------
> ----------
.     if "`xtitle'" == "" local xtitle "Year"
 87.         dis "`xtitle'"
 88.     *if "`ytitle'" == "" local ytitle "`varlist' (adjusted mean
> )"
. 
.         dis `ytitle'
 89.         
.     coefplot `plotspecs', ///
>         vertical ///
>         xlabel(`xlabel', angle(45)) ///
>         xtitle(`xtitle') ///
>         ytitle(`ytitle') ///
>         legend(cols(1) position(6) )
 90. 
.     // Save graph if requested (expects a .gph path)
.     if "`saving'" != "" {
 91.         graph save "`saving'" , `replace'
 92.     }
 93. end

. 
end of do-file

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_00002l.tmp"

. 
. ** Loop over out- and in-migration 
. forvalues i = 1/2 {
  2.         
.         if `i' == 1 local ytitle_txt "Out-migration rate (%)"
  3.         if `i' == 2 local ytitle_txt "In-migration rate (%)"
  4. 
.         ** Loop over categories
.         foreach cat of varlist cat_* {
  5.                 
.                 ** Get label 
.                 local mylabel : variable label `cat'
  6.                 
.                 ** Run Regressions
.                 hdfe_catyear_plot out_`i' if sample_`i' == 1,     
>       ///
>                         cat(`cat') year(year)                     
>                               ///
>                         absorb(state_fips_o county_fips_o cat_*)  
>               ///
>                         wvar(perwt) wtype(fw)                     
>                               ///
>                         ytitle("`ytitle_txt'")                    
>                                       ///
>                         saving("${results}fig_`cat'_`i'") replace 
  7.                 
. 
.         } // END CAT LOOP
  8.         
. } // END SAMPLE LOOP 
Year
Out-migration rate (%)
.: invalid syntax in at()
r(198);

end of do-file

r(198);

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_00002m.tmp"

. 
. ** Define regression + plotting function 
. capture program drop hdfe_catyear_plot

. program define hdfe_catyear_plot
  1.     version 16.0
  2.     syntax varname(numeric) [if] [in] [fw aw pw iw] , ///
>         CAT(varname) YEAR(varname) ABSORB(string) ///
>         [ SAMPLE(varname) SVAL(real 1) ///
>           WVAR(varname) WTYPE(string) ///
>           VCE(string) ///
>           TITLE(string asis) XTITLE(string asis) YTITLE(string asi
> s) ///
>           NOCI ///
>           SAVING(string asis) REPLACE ]
  3. 
.     // -----------------------------------------------------------
> ----------
.     // Requirements
.     // -----------------------------------------------------------
> ----------
.     capture which reghdfe
  4.     if _rc {
  5.         di as error "reghdfe not found. Install with: ssc insta
> ll reghdfe, replace"
  6.         exit 198
  7.     }
  8.     capture which coefplot
  9.     if _rc {
 10.         di as error "coefplot not found. Install with: ssc inst
> all coefplot, replace"
 11.         exit 198
 12.     }
 13. 
.     // -----------------------------------------------------------
> ----------
.     // Mark sample
.     // -----------------------------------------------------------
> ----------
.     marksample touse, strok
 14.     quietly replace `touse' = `touse' & !missing(`varlist', `ca
> t', `year')
 15. 
.     if "`sample'" != "" {
 16.         quietly replace `touse' = `touse' & (`sample' == `sval'
> )
 17.     }
 18. 
.     // -----------------------------------------------------------
> ----------
.     // Handle weights: if user didn't pass [pw/fw/...], default to
>  fw=perwt
.     // -----------------------------------------------------------
> ----------
.     local wgt ""
 19.     if "`weight'" != "" {
 20.         local wgt "[`weight'=`exp']"
 21.     }
 22.     else {
 23.         if "`wvar'" == "" local wvar "perwt"
 24.         if "`wtype'" == "" local wtype "fw"
 25.         capture confirm variable `wvar'
 26.         if _rc {
 27.             di as error "Default weight variable `wvar' not fou
> nd. Either create it or pass weights explicitly."
 28.             exit 111
 29.         }
 30.         local wgt "[`wtype'=`wvar']"
 31.     }
 32. 
.     // -----------------------------------------------------------
> ----------
.     // Ensure cat/year are numeric factor-friendly. Encode/destrin
> g if needed.
.     // -----------------------------------------------------------
> ----------
.     tempvar __cat __year
 33. 
.     local cattype : type `cat'
 34.     if substr("`cattype'",1,3) == "str" {
 35.         quietly encode `cat' if `touse', gen(`__cat')
 36.         local catv `__cat'
 37.     }
 38.     else {
 39.         local catv `cat'
 40.     }
 41. 
.     local yeartype : type `year'
 42.     if substr("`yeartype'",1,3) == "str" {
 43.         // attempt to destring; if it fails, we exit
.         quietly destring `year' if `touse', gen(`__year') force
 44.         capture assert !missing(`__year') if `touse'
 45.         if _rc {
 46.             di as error "Year variable is string and could not 
> be cleanly converted to numeric."
 47.             exit 459
 48.         }
 49.         local yearv `__year'
 50.     }
 51.     else {
 52.         local yearv `year'
 53.     }
 54. 
.     // -----------------------------------------------------------
> ----------
.     // Levels for plotting
.     // -----------------------------------------------------------
> ----------
.     quietly levelsof `yearv' if `touse', local(yrs)
 55.     quietly levelsof `catv'  if `touse', local(cats)
 56. 
.     if "`yrs'" == "" | "`cats'" == "" {
 57.         di as error "No observations available after applying i
> f/in/sample filters."
 58.         exit 2000
 59.     }
 60. 
.     // Build x-axis positions and labels
.     local poslist ""
 61.     local xlabel  ""
 62.     local k = 0
 63.     foreach y of local yrs {
 64.         local ++k
 65.         local poslist `poslist' `k'
 66.         local xlabel  `xlabel'  `k' "`y'"
 67.     }
 68. 
.     // -----------------------------------------------------------
> ----------
.     // Regression: fully interacted cells (cat#year) + absorbed FE
> s, no constant
.     // Coefficients are adjusted means for each (cat,year) cell co
> nditional on FEs
.     // -----------------------------------------------------------
> ----------
.     reghdfe `varlist' i.`catv'#i.`yearv' if `touse' `wgt', ///
>         absorb(`absorb') vce(`=cond("`vce'"=="","robust","`vce'")'
> ) nocons
 69. 
.     estimates store __hdfe_catyear_plot
 70. 
.     // -----------------------------------------------------------
> ----------
.     // Build coefplot specs: one line per category level, aligned 
> by year
.     // -----------------------------------------------------------
> ----------
.     local plotspecs ""
 71.     local vlab : value label `catv'
 72. 
.         
.     foreach c of local cats {
 73.         // series label: value label if it exists, else cat=val
> ue
.         local serieslab "`cat'=`c'"
 74.         if "`vlab'" != "" {
 75.             local tmp : label `vlab' `c'
 76.             if "`tmp'" != "" local serieslab "`tmp'"
 77.         }
 78. 
.         // Coefs in year order for this category level
.         local keepc ""
 79.         foreach y of local yrs {
 80.             // coefficient name format: <c>.<catv>#<y>.<yearv>
.             local keepc `keepc' `c'.`catv'#`y'.`yearv'
 81. 
.         }
 82. 
.         // CI display control
.         local ciopt ""
 83.         if "`noci'" != "" local ciopt "noci"
 84. 
.         local plotspecs `plotspecs' ///
>             (., keep(`keepc') order(`keepc') at(`poslist') label("
> `serieslab'") `ciopt')
 85.                                                 
.     }
 86. 
.     // -----------------------------------------------------------
> ----------
.     // Plot
.     // -----------------------------------------------------------
> ----------
.     if "`xtitle'" == "" local xtitle "Year"
 87.     if "`ytitle'" == "" local ytitle "`varlist' (adjusted mean)
> "
 88. 
.     coefplot `plotspecs', ///
>         vertical ///
>         xlabel(`xlabel', angle(45)) ///
>         xtitle(`xtitle') ///
>         ytitle(`ytitle') ///
>         legend(cols(1) position(6) )
 89. 
.     // Save graph if requested (expects a .gph path)
.     if "`saving'" != "" {
 90.         graph save "`saving'" , `replace'
 91.     }
 92. end

. 
. 
end of do-file

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_00002n.tmp"

. 
. ** Loop over out- and in-migration 
. forvalues i = 1/2 {
  2.         
.         if `i' == 1 local ytitle_txt "Out-migration rate (%)"
  3.         if `i' == 2 local ytitle_txt "In-migration rate (%)"
  4. 
.         ** Loop over categories
.         foreach cat of varlist cat_* {
  5.                 
.                 ** Get label 
.                 local mylabel : variable label `cat'
  6.                 
.                 ** Run Regressions
.                 hdfe_catyear_plot out_`i' if sample_`i' == 1,     
>       ///
>                         cat(`cat') year(year)                     
>                               ///
>                         absorb(state_fips_o county_fips_o cat_*)  
>               ///
>                         wvar(perwt) wtype(fw)                     
>                               ///
>                         ytitle("`ytitle_txt'")                    
>                                       ///
>                         saving("${results}fig_`cat'_`i'") replace 
  7.                 
. 
.         } // END CAT LOOP
  8.         
. 
unexpected end of file
r(612);

end of do-file

r(612);
. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_00002o.tmp"

. ** Loop over out- and in-migration 
. forvalues i = 1/2 {
  2.         
.         if `i' == 1 local ytitle_txt "Out-migration rate (%)"
  3.         if `i' == 2 local ytitle_txt "In-migration rate (%)"
  4. 
.         ** Loop over categories
.         foreach cat of varlist cat_* {
  5.                 
.                 ** Get label 
.                 local mylabel : variable label `cat'
  6.                 
.                 ** Run Regressions
.                 hdfe_catyear_plot out_`i' if sample_`i' == 1,     
>       ///
>                         cat(`cat') year(year)                     
>                               ///
>                         absorb(state_fips_o county_fips_o cat_*)  
>               ///
>                         wvar(perwt) wtype(fw)                     
>                               ///
>                         ytitle("`ytitle_txt'")                    
>                                       ///
>                         saving("${results}fig_`cat'_`i'") replace 
  7.                 
. 
.         } // END CAT LOOP
  8.         
. } // END SAMPLE LOOP 
(MWFE estimator converged in 24 iterations)
note: 2.cat_age#2023.year omitted because of collinearity
note: 3.cat_age#2023.year omitted because of collinearity
note: 4.cat_age#2023.year omitted because of collinearity

HDFE Linear regression                            Number of obs   = 
>  5,546,937
Absorbing 10 HDFE groups                          F(  32,5546869) = 
>     389.42
                                                  Prob > F        = 
>     0.0000
                                                  R-squared       = 
>     0.0218
                                                  Adj R-squared   = 
>     0.0218
                                                  Within R-sq.    = 
>     0.0024
                                                  Root MSE        = 
>     0.2406

--------------------------------------------------------------------
> ----------
             |               Robust
       out_1 | Coefficient  std. err.      t    P>|t|     [95% conf.
>  interval]
-------------+------------------------------------------------------
> ----------
cat_age#year |
 18-24#2016  |  -.0473005   .0020783   -22.76   0.000    -.0513739  
>   -.043227
 18-24#2017  |  -.0678857   .0020233   -33.55   0.000    -.0718514  
>  -.0639201
 18-24#2018  |  -.0557237   .0021052   -26.47   0.000    -.0598497  
>  -.0515976
 18-24#2019  |  -.0102157   .0022076    -4.63   0.000    -.0145424  
>  -.0058889
 18-24#2020  |  -.0479487   .0021029   -22.80   0.000    -.0520704  
>   -.043827
 18-24#2021  |  -.0401765   .0021442   -18.74   0.000    -.0443791  
>   -.035974
 18-24#2022  |  -.0067688   .0022127    -3.06   0.002    -.0111056  
>  -.0024319
 18-24#2023  |  -.0278455   .0021887   -12.72   0.000    -.0321353  
>  -.0235557
 25-44#2015  |   .0130377   .0007424    17.56   0.000     .0115827  
>   .0144928
 25-44#2016  |   .0181928   .0007543    24.12   0.000     .0167143  
>   .0196713
 25-44#2017  |   .0000723   .0007141     0.10   0.919    -.0013273  
>   .0014718
 25-44#2018  |   .0136701   .0007388    18.50   0.000      .012222  
>   .0151181
 25-44#2019  |  -.0071594   .0006954   -10.29   0.000    -.0085224  
>  -.0057963
 25-44#2020  |   .0123283   .0007348    16.78   0.000     .0108882  
>   .0137685
 25-44#2021  |   .0200195   .0007528    26.60   0.000     .0185441  
>   .0214949
 25-44#2022  |   .0359765   .0007844    45.86   0.000     .0344391  
>   .0375139
 25-44#2023  |          0  (omitted)
 45-64#2015  |   .0054491    .000707     7.71   0.000     .0040633  
>   .0068349
 45-64#2016  |  -.0091413   .0006596   -13.86   0.000    -.0104342  
>  -.0078485
 45-64#2017  |   -.012084   .0006518   -18.54   0.000    -.0133615  
>  -.0108065
 45-64#2018  |  -.0117278   .0006495   -18.06   0.000    -.0130008  
>  -.0104548
 45-64#2019  |   -.021281   .0006167   -34.51   0.000    -.0224897  
>  -.0200722
 45-64#2020  |  -.0223935   .0006201   -36.11   0.000    -.0236089  
>  -.0211782
 45-64#2021  |  -.0005476   .0006845    -0.80   0.424    -.0018892  
>    .000794
 45-64#2022  |  -.0048641   .0006788    -7.17   0.000    -.0061944  
>  -.0035337
 45-64#2023  |          0  (omitted)
   65+#2015  |   .0032657   .0006341     5.15   0.000     .0020229  
>   .0045085
   65+#2016  |   .0160243    .000707    22.67   0.000     .0146386  
>   .0174099
   65+#2017  |   .0197035   .0007348    26.81   0.000     .0182632  
>   .0211437
   65+#2018  |    .004263   .0006229     6.84   0.000     .0030422  
>   .0054838
   65+#2019  |   .0063698   .0006314    10.09   0.000     .0051323  
>   .0076073
   65+#2020  |   .0092347   .0006406    14.41   0.000      .007979  
>   .0104903
   65+#2021  |   .0057409   .0006193     9.27   0.000      .004527  
>   .0069547
   65+#2022  |   .0219188   .0007151    30.65   0.000     .0205173  
>   .0233204
   65+#2023  |          0  (omitted)
--------------------------------------------------------------------
> ----------

Absorbed degrees of freedom:
-------------------------------------------------------+
   Absorbed FE | Categories  - Redundant  = Num. Coefs |
---------------+---------------------------------------|
  state_fips_o |         1           0           1     |
 county_fips_o |         1           1           0     |
       cat_age |         4           1           3    ?|
   cat_married |         4           1           3    ?|
     cat_child |         4           1           3    ?|
      cat_educ |         4           1           3    ?|
    cat_inctot |         7           1           6    ?|
   cat_incwage |         6           1           5    ?|
   cat_incearn |         7           1           6    ?|
   cat_ftotinc |         7           1           6    ?|
-------------------------------------------------------+
? = number of redundant parameters may be higher
migration not found
r(111);

end of do-file

r(111);

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_00002p.tmp"

. gen cat_sex = sex == 2 

. label var cat_sex "Female indicator"

. label define lb_cat_sex 0 "Male" 1 "Female"

. label values cat_sex cat_sex 

. 
end of do-file

. reghdfe out_1 i.year#i.cat_sex if sample_1 == 1 [fw =perwt ] , abs
> orb(cat_married cat_child )
(MWFE estimator converged in 4 iterations)

HDFE Linear regression                            Number of obs   = 
>  5,546,937
Absorbing 2 HDFE groups                           F(  17,5546913) = 
>     376.53
                                                  Prob > F        = 
>     0.0000
                                                  R-squared       = 
>     0.0059
                                                  Adj R-squared   = 
>     0.0059
                                                  Within R-sq.    = 
>     0.0012
                                                  Root MSE        = 
>     0.2425

--------------------------------------------------------------------
> ----------
       out_1 | Coefficient  Std. err.      t    P>|t|     [95% conf.
>  interval]
-------------+------------------------------------------------------
> ----------
year#cat_sex |
     2015 1  |   .0006494   .0006242     1.04   0.298    -.0005741  
>   .0018728
     2016 0  |  -.0032184   .0006316    -5.10   0.000    -.0044564  
>  -.0019805
     2016 1  |  -.0050455   .0006263    -8.06   0.000    -.0062731  
>   -.003818
     2017 0  |  -.0169687   .0006314   -26.88   0.000    -.0182061  
>  -.0157313
     2017 1  |  -.0110756    .000627   -17.67   0.000    -.0123044  
>  -.0098468
     2018 0  |  -.0051017   .0006305    -8.09   0.000    -.0063374  
>   -.003866
     2018 1  |  -.0142614   .0006236   -22.87   0.000    -.0154836  
>  -.0130391
     2019 0  |  -.0159571   .0006284   -25.39   0.000    -.0171888  
>  -.0147253
     2019 1  |  -.0199452    .000623   -32.01   0.000    -.0211664  
>  -.0187241
     2020 0  |  -.0167423    .000627   -26.70   0.000    -.0179713  
>  -.0155133
     2020 1  |  -.0061692   .0006217    -9.92   0.000    -.0073878  
>  -.0049507
     2021 0  |  -.0022255    .000625    -3.56   0.000    -.0034504  
>  -.0010006
     2021 1  |  -.0022862   .0006223    -3.67   0.000     -.003506  
>  -.0010665
     2022 0  |   .0097661   .0006241    15.65   0.000     .0085429  
>   .0109892
     2022 1  |   .0073121   .0006235    11.73   0.000     .0060901  
>   .0085342
     2023 0  |  -.0097351   .0006295   -15.47   0.000    -.0109688  
>  -.0085013
     2023 1  |  -.0128132   .0006289   -20.37   0.000    -.0140459  
>  -.0115805
             |
       _cons |   .0700081   .0004492   155.86   0.000     .0691278  
>   .0708885
--------------------------------------------------------------------
> ----------

Absorbed degrees of freedom:
-----------------------------------------------------+
 Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------+---------------------------------------|
 cat_married |         4           0           4     |
   cat_child |         4           1           3     |
-----------------------------------------------------+

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_00002q.tmp"

. ** Loop over out- and in-migration 
. forvalues i = 1/2 {
  2.         
.         if `i' == 1 local ytitle_txt "Out-migration rate (%)"
  3.         if `i' == 2 local ytitle_txt "In-migration rate (%)"
  4. 
.         ** Loop over categories
.         foreach cat of varlist cat_* {
  5.                 
.                 ** Get label 
.                 local mylabel : variable label `cat'
  6.                 
.                 ** Run Regressions
.                 hdfe_catyear_plot out_`i' if sample_`i' == 1,     
>       ///
>                         cat(`cat') year(year)                     
>                               ///
>                         absorb(state_fips_o county_fips_o cat_marr
> ied)          ///
>                         wvar(perwt) wtype(fw)                     
>                               ///
>                         ytitle("`ytitle_txt'")                    
>                                       ///
>                         saving("${results}fig_`cat'_`i'") replace 
  7.                 
. sdf
  8.         } // END CAT LOOP
  9.         
. } // END SAMPLE LOOP 
(MWFE estimator converged in 2 iterations)

HDFE Linear regression                            Number of obs   = 
>  5,546,937
Absorbing 3 HDFE groups                           F(  35,5546898) = 
>    2228.40
                                                  Prob > F        = 
>     0.0000
                                                  R-squared       = 
>     0.0171
                                                  Adj R-squared   = 
>     0.0171
                                                  Within R-sq.    = 
>     0.0131
                                                  Root MSE        = 
>     0.2412

--------------------------------------------------------------------
> ----------
             |               Robust
       out_1 | Coefficient  std. err.      t    P>|t|     [95% conf.
>  interval]
-------------+------------------------------------------------------
> ----------
cat_age#year |
 18-24#2016  |  -.0463757   .0020777   -22.32   0.000    -.0504479  
>  -.0423035
 18-24#2017  |  -.0684601    .002023   -33.84   0.000    -.0724251  
>  -.0644952
 18-24#2018  |  -.0554329    .002109   -26.28   0.000    -.0595665  
>  -.0512993
 18-24#2019  |   -.009515   .0022099    -4.31   0.000    -.0138464  
>  -.0051836
 18-24#2020  |  -.0467404   .0021045   -22.21   0.000     -.050865  
>  -.0426157
 18-24#2021  |   -.040116   .0021434   -18.72   0.000    -.0443169  
>   -.035915
 18-24#2022  |  -.0068847   .0022127    -3.11   0.002    -.0112215  
>  -.0025479
 18-24#2023  |  -.0283308    .002188   -12.95   0.000    -.0326192  
>  -.0240424
 25-44#2015  |  -.0716562   .0016816   -42.61   0.000    -.0749521  
>  -.0683603
 25-44#2016  |   -.066591   .0016859   -39.50   0.000    -.0698953  
>  -.0632867
 25-44#2017  |  -.0840984   .0016698   -50.36   0.000    -.0873713  
>  -.0808256
 25-44#2018  |  -.0702567   .0016806   -41.81   0.000    -.0735505  
>  -.0669628
 25-44#2019  |  -.0906352    .001661   -54.57   0.000    -.0938907  
>  -.0873798
 25-44#2020  |     -.0703   .0016794   -41.86   0.000    -.0735916  
>  -.0670085
 25-44#2021  |  -.0621904   .0016857   -36.89   0.000    -.0654944  
>  -.0588864
 25-44#2022  |  -.0469358   .0016993   -27.62   0.000    -.0502665  
>  -.0436052
 25-44#2023  |  -.0816658   .0016731   -48.81   0.000    -.0849451  
>  -.0783866
 45-64#2015  |  -.1005275   .0016783   -59.90   0.000    -.1038168  
>  -.0972381
 45-64#2016  |  -.1155962   .0016579   -69.72   0.000    -.1188456  
>  -.1123467
 45-64#2017  |  -.1172928   .0016558   -70.84   0.000    -.1205381  
>  -.1140475
 45-64#2018  |  -.1180491   .0016533   -71.40   0.000    -.1212895  
>  -.1148087
 45-64#2019  |  -.1272698   .0016422   -77.50   0.000    -.1304884  
>  -.1240512
 45-64#2020  |  -.1277156   .0016424   -77.76   0.000    -.1309346  
>  -.1244966
 45-64#2021  |  -.1064926   .0016686   -63.82   0.000    -.1097631  
>  -.1032221
 45-64#2022  |  -.1105685   .0016654   -66.39   0.000    -.1138326  
>  -.1073044
 45-64#2023  |  -.1056485   .0016722   -63.18   0.000    -.1089259  
>   -.102371
   65+#2015  |  -.1363638    .001677   -81.31   0.000    -.1396507  
>  -.1330769
   65+#2016  |  -.1237178   .0017042   -72.60   0.000     -.127058  
>  -.1203776
   65+#2017  |  -.1189338    .001715   -69.35   0.000    -.1222952  
>  -.1155724
   65+#2018  |   -.134183   .0016708   -80.31   0.000    -.1374577  
>  -.1309082
   65+#2019  |  -.1320583    .001673   -78.94   0.000    -.1353373  
>  -.1287793
   65+#2020  |  -.1283872   .0016778   -76.52   0.000    -.1316757  
>  -.1250988
   65+#2021  |  -.1328422   .0016684   -79.62   0.000    -.1361122  
>  -.1295722
   65+#2022  |  -.1165876   .0017093   -68.21   0.000    -.1199377  
>  -.1132375
   65+#2023  |  -.1375909   .0016528   -83.25   0.000    -.1408302  
>  -.1343515
--------------------------------------------------------------------
> ----------

Absorbed degrees of freedom:
-------------------------------------------------------+
   Absorbed FE | Categories  - Redundant  = Num. Coefs |
---------------+---------------------------------------|
  state_fips_o |         1           0           1     |
 county_fips_o |         1           1           0     |
   cat_married |         4           1           3    ?|
-------------------------------------------------------+
? = number of redundant parameters may be higher
migration not found
r(111);

end of do-file

r(111);

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_00002r.tmp"

. 
. ** Define regression + plotting function 
. capture program drop hdfe_catyear_plot

. program define hdfe_catyear_plot
  1.     version 16.0
  2.     syntax varname(numeric) [if] [in] [fw aw pw iw] , ///
>         CAT(varname) YEAR(varname) ABSORB(string) ///
>         [ SAMPLE(varname) SVAL(real 1) ///
>           WVAR(varname) WTYPE(string) ///
>           VCE(string) ///
>           TITLE(string asis) XTITLE(string asis) YTITLE(string asi
> s) ///
>           NOCI ///
>           SAVING(string asis) REPLACE ]
  3. 
.     // -----------------------------------------------------------
> ----------
.     // Requirements
.     // -----------------------------------------------------------
> ----------
.     capture which reghdfe
  4.     if _rc {
  5.         di as error "reghdfe not found. Install with: ssc insta
> ll reghdfe, replace"
  6.         exit 198
  7.     }
  8.     capture which coefplot
  9.     if _rc {
 10.         di as error "coefplot not found. Install with: ssc inst
> all coefplot, replace"
 11.         exit 198
 12.     }
 13. 
.     // -----------------------------------------------------------
> ----------
.     // Mark sample
.     // -----------------------------------------------------------
> ----------
.     marksample touse, strok
 14.     quietly replace `touse' = `touse' & !missing(`varlist', `ca
> t', `year')
 15. 
.     if "`sample'" != "" {
 16.         quietly replace `touse' = `touse' & (`sample' == `sval'
> )
 17.     }
 18. 
.     // -----------------------------------------------------------
> ----------
.     // Handle weights: if user didn't pass [pw/fw/...], default to
>  fw=perwt
.     // -----------------------------------------------------------
> ----------
.     local wgt ""
 19.     if "`weight'" != "" {
 20.         local wgt "[`weight'=`exp']"
 21.     }
 22.     else {
 23.         if "`wvar'" == "" local wvar "perwt"
 24.         if "`wtype'" == "" local wtype "fw"
 25.         capture confirm variable `wvar'
 26.         if _rc {
 27.             di as error "Default weight variable `wvar' not fou
> nd. Either create it or pass weights explicitly."
 28.             exit 111
 29.         }
 30.         local wgt "[`wtype'=`wvar']"
 31.     }
 32. 
.     // -----------------------------------------------------------
> ----------
.     // Ensure cat/year are numeric factor-friendly. Encode/destrin
> g if needed.
.     // -----------------------------------------------------------
> ----------
.     tempvar __cat __year
 33. 
.     local cattype : type `cat'
 34.     if substr("`cattype'",1,3) == "str" {
 35.         quietly encode `cat' if `touse', gen(`__cat')
 36.         local catv `__cat'
 37.     }
 38.     else {
 39.         local catv `cat'
 40.     }
 41. 
.     local yeartype : type `year'
 42.     if substr("`yeartype'",1,3) == "str" {
 43.         // attempt to destring; if it fails, we exit
.         quietly destring `year' if `touse', gen(`__year') force
 44.         capture assert !missing(`__year') if `touse'
 45.         if _rc {
 46.             di as error "Year variable is string and could not 
> be cleanly converted to numeric."
 47.             exit 459
 48.         }
 49.         local yearv `__year'
 50.     }
 51.     else {
 52.         local yearv `year'
 53.     }
 54. 
.     // -----------------------------------------------------------
> ----------
.     // Levels for plotting
.     // -----------------------------------------------------------
> ----------
.     quietly levelsof `yearv' if `touse', local(yrs)
 55.     quietly levelsof `catv'  if `touse', local(cats)
 56. 
.     if "`yrs'" == "" | "`cats'" == "" {
 57.         di as error "No observations available after applying i
> f/in/sample filters."
 58.         exit 2000
 59.     }
 60. 
.     // Build x-axis positions and labels
.     local poslist ""
 61.     local xlabel  ""
 62.     local k = 0
 63.     foreach y of local yrs {
 64.         local ++k
 65.         local poslist `poslist' `k'
 66.         local xlabel  `xlabel'  `k' "`y'"
 67.     }
 68. 
.     // -----------------------------------------------------------
> ----------
.     // Regression: fully interacted cells (cat#year) + absorbed FE
> s, no constant
.     // Coefficients are adjusted means for each (cat,year) cell co
> nditional on FEs
.     // -----------------------------------------------------------
> ----------
.     reghdfe `varlist' i.`catv'#i.`yearv' if `touse' `wgt', ///
>         absorb(`absorb') vce(`=cond("`vce'"=="","robust","`vce'")'
> ) nocons
 69. 
.     estimates store __hdfe_catyear_plot
 70. 
.     // -----------------------------------------------------------
> ----------
.     // Build coefplot specs: one line per category level, aligned 
> by year
.     // -----------------------------------------------------------
> ----------
.     local plotspecs ""
 71.     local vlab : value label `catv'
 72. 
.         
.     foreach c of local cats {
 73.         // series label: value label if it exists, else cat=val
> ue
.         local serieslab "`cat'=`c'"
 74.         if "`vlab'" != "" {
 75.             local tmp : label `vlab' `c'
 76.             if "`tmp'" != "" local serieslab "`tmp'"
 77.         }
 78. 
.         // Coefs in year order for this category level
.         local keepc ""
 79.         foreach y of local yrs {
 80.             // coefficient name format: <c>.<catv>#<y>.<yearv>
.             local keepc `keepc' `c'.`catv'#`y'.`yearv'
 81. 
.         }
 82. 
.         // CI display control
.         local ciopt ""
 83.         if "`noci'" != "" local ciopt "noci"
 84. 
.         local plotspecs `plotspecs' ///
>             (., keep(`keepc') order(`keepc') at(`poslist') label("
> `serieslab'") `ciopt')
 85.                                                 
.     }
 86. 
.     // -----------------------------------------------------------
> ----------
.     // Plot
.     // -----------------------------------------------------------
> ----------
.     if "`xtitle'" == "" local xtitle "Year"
 87.     if "`ytitle'" == "" local ytitle "`varlist' (adjusted mean)
> "
 88. 
.     coefplot `plotspecs', ///
>         vertical ///
>         xlabel(`xlabel', angle(45)) ///
>         xtitle(`xtitle') ///
>         ytitle(`ytitle') ///
>         legend(cols(1) position(6) )
 89. 
.     // Save graph if requested (expects a .gph path)
.     if "`saving'" != "" {
 90.         graph save "`saving'" , `replace'
 91.     }
 92. end

. 
. 
end of do-file

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_00002s.tmp"

. 
. ** Loop over out- and in-migration 
. forvalues i = 1/2 {
  2.         
.         if `i' == 1 local ytitle_txt "Out-migration rate (%)"
  3.         if `i' == 2 local ytitle_txt "In-migration rate (%)"
  4. 
.         ** Loop over categories
.         foreach cat of varlist cat_* {
  5.                 
.                 ** Get label 
.                 local mylabel : variable label `cat'
  6.                 
.                 ** Run Regressions
.                 hdfe_catyear_plot out_`i' if sample_`i' == 1,     
>       ///
>                         cat(`cat') year(year)                     
>                               ///
>                         absorb(state_fips_o county_fips_o cat_marr
> ied)          ///
>                         wvar(perwt) wtype(fw)                     
>                               ///
>                         ytitle("`ytitle_txt'")                    
>                                       ///
>                         saving("${results}fig_`cat'_`i'") replace 
  7.                 
. sdf
  8.         } // END CAT LOOP
  9.         
. } // END SAMPLE LOOP 
(MWFE estimator converged in 2 iterations)

HDFE Linear regression                            Number of obs   = 
>  5,546,937
Absorbing 3 HDFE groups                           F(  35,5546898) = 
>    2228.40
                                                  Prob > F        = 
>     0.0000
                                                  R-squared       = 
>     0.0171
                                                  Adj R-squared   = 
>     0.0171
                                                  Within R-sq.    = 
>     0.0131
                                                  Root MSE        = 
>     0.2412

--------------------------------------------------------------------
> ----------
             |               Robust
       out_1 | Coefficient  std. err.      t    P>|t|     [95% conf.
>  interval]
-------------+------------------------------------------------------
> ----------
cat_age#year |
 18-24#2016  |  -.0463757   .0020777   -22.32   0.000    -.0504479  
>  -.0423035
 18-24#2017  |  -.0684601    .002023   -33.84   0.000    -.0724251  
>  -.0644952
 18-24#2018  |  -.0554329    .002109   -26.28   0.000    -.0595665  
>  -.0512993
 18-24#2019  |   -.009515   .0022099    -4.31   0.000    -.0138464  
>  -.0051836
 18-24#2020  |  -.0467404   .0021045   -22.21   0.000     -.050865  
>  -.0426157
 18-24#2021  |   -.040116   .0021434   -18.72   0.000    -.0443169  
>   -.035915
 18-24#2022  |  -.0068847   .0022127    -3.11   0.002    -.0112215  
>  -.0025479
 18-24#2023  |  -.0283308    .002188   -12.95   0.000    -.0326192  
>  -.0240424
 25-44#2015  |  -.0716562   .0016816   -42.61   0.000    -.0749521  
>  -.0683603
 25-44#2016  |   -.066591   .0016859   -39.50   0.000    -.0698953  
>  -.0632867
 25-44#2017  |  -.0840984   .0016698   -50.36   0.000    -.0873713  
>  -.0808256
 25-44#2018  |  -.0702567   .0016806   -41.81   0.000    -.0735505  
>  -.0669628
 25-44#2019  |  -.0906352    .001661   -54.57   0.000    -.0938907  
>  -.0873798
 25-44#2020  |     -.0703   .0016794   -41.86   0.000    -.0735916  
>  -.0670085
 25-44#2021  |  -.0621904   .0016857   -36.89   0.000    -.0654944  
>  -.0588864
 25-44#2022  |  -.0469358   .0016993   -27.62   0.000    -.0502665  
>  -.0436052
 25-44#2023  |  -.0816658   .0016731   -48.81   0.000    -.0849451  
>  -.0783866
 45-64#2015  |  -.1005275   .0016783   -59.90   0.000    -.1038168  
>  -.0972381
 45-64#2016  |  -.1155962   .0016579   -69.72   0.000    -.1188456  
>  -.1123467
 45-64#2017  |  -.1172928   .0016558   -70.84   0.000    -.1205381  
>  -.1140475
 45-64#2018  |  -.1180491   .0016533   -71.40   0.000    -.1212895  
>  -.1148087
 45-64#2019  |  -.1272698   .0016422   -77.50   0.000    -.1304884  
>  -.1240512
 45-64#2020  |  -.1277156   .0016424   -77.76   0.000    -.1309346  
>  -.1244966
 45-64#2021  |  -.1064926   .0016686   -63.82   0.000    -.1097631  
>  -.1032221
 45-64#2022  |  -.1105685   .0016654   -66.39   0.000    -.1138326  
>  -.1073044
 45-64#2023  |  -.1056485   .0016722   -63.18   0.000    -.1089259  
>   -.102371
   65+#2015  |  -.1363638    .001677   -81.31   0.000    -.1396507  
>  -.1330769
   65+#2016  |  -.1237178   .0017042   -72.60   0.000     -.127058  
>  -.1203776
   65+#2017  |  -.1189338    .001715   -69.35   0.000    -.1222952  
>  -.1155724
   65+#2018  |   -.134183   .0016708   -80.31   0.000    -.1374577  
>  -.1309082
   65+#2019  |  -.1320583    .001673   -78.94   0.000    -.1353373  
>  -.1287793
   65+#2020  |  -.1283872   .0016778   -76.52   0.000    -.1316757  
>  -.1250988
   65+#2021  |  -.1328422   .0016684   -79.62   0.000    -.1361122  
>  -.1295722
   65+#2022  |  -.1165876   .0017093   -68.21   0.000    -.1199377  
>  -.1132375
   65+#2023  |  -.1375909   .0016528   -83.25   0.000    -.1408302  
>  -.1343515
--------------------------------------------------------------------
> ----------

Absorbed degrees of freedom:
-------------------------------------------------------+
   Absorbed FE | Categories  - Redundant  = Num. Coefs |
---------------+---------------------------------------|
  state_fips_o |         1           0           1     |
 county_fips_o |         1           1           0     |
   cat_married |         4           1           3    ?|
-------------------------------------------------------+
? = number of redundant parameters may be higher
migration not found
r(111);

end of do-file

r(111);

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_00002t.tmp"

. ** Define regression + plotting function 
. capture program drop hdfe_catyear_plot

. program define hdfe_catyear_plot
  1.     version 16.0
  2.     syntax varname(numeric) [if] [in] [fw aw pw iw] , ///
>         CAT(varname) YEAR(varname) ABSORB(string) ///
>         [ SAMPLE(varname) SVAL(real 1) ///
>           WVAR(varname) WTYPE(string) ///
>           VCE(string) ///
>           TITLE(string asis) XTITLE(string asis) YTITLE(string asi
> s) ///
>           NOCI ///
>           SAVING(string asis) REPLACE ]
  3. 
.     // -----------------------------------------------------------
> ----------
.     // Requirements
.     // -----------------------------------------------------------
> ----------
.     capture which reghdfe
  4.     if _rc {
  5.         di as error "reghdfe not found. Install with: ssc insta
> ll reghdfe, replace"
  6.         exit 198
  7.     }
  8.     capture which coefplot
  9.     if _rc {
 10.         di as error "coefplot not found. Install with: ssc inst
> all coefplot, replace"
 11.         exit 198
 12.     }
 13. 
.     // -----------------------------------------------------------
> ----------
.     // Mark sample
.     // -----------------------------------------------------------
> ----------
.     marksample touse, strok
 14.     quietly replace `touse' = `touse' & !missing(`varlist', `ca
> t', `year')
 15. 
.     if "`sample'" != "" {
 16.         quietly replace `touse' = `touse' & (`sample' == `sval'
> )
 17.     }
 18. 
.     // -----------------------------------------------------------
> ----------
.     // Handle weights: if user didn't pass [pw/fw/...], default to
>  fw=perwt
.     // -----------------------------------------------------------
> ----------
.     local wgt ""
 19.     if "`weight'" != "" {
 20.         local wgt "[`weight'=`exp']"
 21.     }
 22.     else {
 23.         if "`wvar'" == "" local wvar "perwt"
 24.         if "`wtype'" == "" local wtype "fw"
 25.         capture confirm variable `wvar'
 26.         if _rc {
 27.             di as error "Default weight variable `wvar' not fou
> nd. Either create it or pass weights explicitly."
 28.             exit 111
 29.         }
 30.         local wgt "[`wtype'=`wvar']"
 31.     }
 32. 
.     // -----------------------------------------------------------
> ----------
.     // Ensure cat/year are numeric factor-friendly. Encode/destrin
> g if needed.
.     // -----------------------------------------------------------
> ----------
.     tempvar __cat __year
 33. 
.     local cattype : type `cat'
 34.     if substr("`cattype'",1,3) == "str" {
 35.         quietly encode `cat' if `touse', gen(`__cat')
 36.         local catv `__cat'
 37.     }
 38.     else {
 39.         local catv `cat'
 40.     }
 41. 
.     local yeartype : type `year'
 42.     if substr("`yeartype'",1,3) == "str" {
 43.         // attempt to destring; if it fails, we exit
.         quietly destring `year' if `touse', gen(`__year') force
 44.         capture assert !missing(`__year') if `touse'
 45.         if _rc {
 46.             di as error "Year variable is string and could not 
> be cleanly converted to numeric."
 47.             exit 459
 48.         }
 49.         local yearv `__year'
 50.     }
 51.     else {
 52.         local yearv `year'
 53.     }
 54. 
.     // -----------------------------------------------------------
> ----------
.     // Levels for plotting
.     // -----------------------------------------------------------
> ----------
.     quietly levelsof `yearv' if `touse', local(yrs)
 55.     quietly levelsof `catv'  if `touse', local(cats)
 56. 
.     if "`yrs'" == "" | "`cats'" == "" {
 57.         di as error "No observations available after applying i
> f/in/sample filters."
 58.         exit 2000
 59.     }
 60. 
.     // Build x-axis positions and labels
.     local poslist ""
 61.     local xlabel  ""
 62.     local k = 0
 63.     foreach y of local yrs {
 64.         local ++k
 65.         local poslist `poslist' `k'
 66.         local xlabel  `xlabel'  `k' "`y'"
 67.     }
 68. 
.     // -----------------------------------------------------------
> ----------
.     // Regression: fully interacted cells (cat#year) + absorbed FE
> s, no constant
.     // Coefficients are adjusted means for each (cat,year) cell co
> nditional on FEs
.     // -----------------------------------------------------------
> ----------
.     reghdfe `varlist' i.`catv'#i.`yearv' if `touse' `wgt', ///
>         absorb(`absorb') vce(`=cond("`vce'"=="","robust","`vce'")'
> ) nocons
 69. 
.     estimates store __hdfe_catyear_plot
 70. 
.     // -----------------------------------------------------------
> ----------
.     // Build coefplot specs: one line per category level, aligned 
> by year
.     // -----------------------------------------------------------
> ----------
.     local plotspecs ""
 71.     local vlab : value label `catv'
 72. 
.         
.     foreach c of local cats {
 73.         // series label: value label if it exists, else cat=val
> ue
.         local serieslab "`cat'=`c'"
 74.         if "`vlab'" != "" {
 75.             local tmp : label `vlab' `c'
 76.             if "`tmp'" != "" local serieslab "`tmp'"
 77.         }
 78. 
.         // Coefs in year order for this category level
.         local keepc ""
 79.         foreach y of local yrs {
 80.             // coefficient name format: <c>.<catv>#<y>.<yearv>
.             local keepc `keepc' `c'.`catv'#`y'.`yearv'
 81. 
.         }
 82. 
.         // CI display control
.         local ciopt ""
 83.         if "`noci'" != "" local ciopt "noci"
 84. 
.         local plotspecs `plotspecs' ///
>             (., keep(`keepc') order(`keepc') at(`poslist') label("
> `serieslab'") `ciopt')
 85.                                                 
.     }
 86. 
.     // -----------------------------------------------------------
> ----------
.     // Plot
.     // -----------------------------------------------------------
> ----------
.     if "`xtitle'" == "" local xtitle "Year"
 87.     if "`ytitle'" == "" local ytitle "`varlist' (adjusted mean)
> "
 88. 
.     coefplot `plotspecs', ///
>         vertical ///
>         xlabel(`xlabel', angle(45)) ///
>         xtitle(`xtitle') ///
>         ytitle("`ytitle'") ///
>         legend(cols(1) position(6) )
 89. 
.     // Save graph if requested (expects a .gph path)
.     if "`saving'" != "" {
 90.         graph save "`saving'" , `replace'
 91.     }
 92. end

. 
end of do-file

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_00002u.tmp"

. ** Loop over out- and in-migration 
. forvalues i = 1/2 {
  2.         
.         if `i' == 1 local ytitle_txt "Out-migration rate (%)"
  3.         if `i' == 2 local ytitle_txt "In-migration rate (%)"
  4. 
.         ** Loop over categories
.         foreach cat of varlist cat_* {
  5.                 
.                 ** Get label 
.                 local mylabel : variable label `cat'
  6.                 
.                 ** Run Regressions
.                 hdfe_catyear_plot out_`i' if sample_`i' == 1,     
>       ///
>                         cat(`cat') year(year)                     
>                               ///
>                         absorb(state_fips_o county_fips_o cat_marr
> ied)          ///
>                         wvar(perwt) wtype(fw)                     
>                               ///
>                         ytitle("`ytitle_txt'")                    
>                                       ///
>                         saving("${results}fig_`cat'_`i'") replace 
  7.                 
. sdf
  8.         } // END CAT LOOP
  9.         
. } // END SAMPLE LOOP 
(MWFE estimator converged in 2 iterations)

HDFE Linear regression                            Number of obs   = 
>  5,546,937
Absorbing 3 HDFE groups                           F(  35,5546898) = 
>    2228.40
                                                  Prob > F        = 
>     0.0000
                                                  R-squared       = 
>     0.0171
                                                  Adj R-squared   = 
>     0.0171
                                                  Within R-sq.    = 
>     0.0131
                                                  Root MSE        = 
>     0.2412

--------------------------------------------------------------------
> ----------
             |               Robust
       out_1 | Coefficient  std. err.      t    P>|t|     [95% conf.
>  interval]
-------------+------------------------------------------------------
> ----------
cat_age#year |
 18-24#2016  |  -.0463757   .0020777   -22.32   0.000    -.0504479  
>  -.0423035
 18-24#2017  |  -.0684601    .002023   -33.84   0.000    -.0724251  
>  -.0644952
 18-24#2018  |  -.0554329    .002109   -26.28   0.000    -.0595665  
>  -.0512993
 18-24#2019  |   -.009515   .0022099    -4.31   0.000    -.0138464  
>  -.0051836
 18-24#2020  |  -.0467404   .0021045   -22.21   0.000     -.050865  
>  -.0426157
 18-24#2021  |   -.040116   .0021434   -18.72   0.000    -.0443169  
>   -.035915
 18-24#2022  |  -.0068847   .0022127    -3.11   0.002    -.0112215  
>  -.0025479
 18-24#2023  |  -.0283308    .002188   -12.95   0.000    -.0326192  
>  -.0240424
 25-44#2015  |  -.0716562   .0016816   -42.61   0.000    -.0749521  
>  -.0683603
 25-44#2016  |   -.066591   .0016859   -39.50   0.000    -.0698953  
>  -.0632867
 25-44#2017  |  -.0840984   .0016698   -50.36   0.000    -.0873713  
>  -.0808256
 25-44#2018  |  -.0702567   .0016806   -41.81   0.000    -.0735505  
>  -.0669628
 25-44#2019  |  -.0906352    .001661   -54.57   0.000    -.0938907  
>  -.0873798
 25-44#2020  |     -.0703   .0016794   -41.86   0.000    -.0735916  
>  -.0670085
 25-44#2021  |  -.0621904   .0016857   -36.89   0.000    -.0654944  
>  -.0588864
 25-44#2022  |  -.0469358   .0016993   -27.62   0.000    -.0502665  
>  -.0436052
 25-44#2023  |  -.0816658   .0016731   -48.81   0.000    -.0849451  
>  -.0783866
 45-64#2015  |  -.1005275   .0016783   -59.90   0.000    -.1038168  
>  -.0972381
 45-64#2016  |  -.1155962   .0016579   -69.72   0.000    -.1188456  
>  -.1123467
 45-64#2017  |  -.1172928   .0016558   -70.84   0.000    -.1205381  
>  -.1140475
 45-64#2018  |  -.1180491   .0016533   -71.40   0.000    -.1212895  
>  -.1148087
 45-64#2019  |  -.1272698   .0016422   -77.50   0.000    -.1304884  
>  -.1240512
 45-64#2020  |  -.1277156   .0016424   -77.76   0.000    -.1309346  
>  -.1244966
 45-64#2021  |  -.1064926   .0016686   -63.82   0.000    -.1097631  
>  -.1032221
 45-64#2022  |  -.1105685   .0016654   -66.39   0.000    -.1138326  
>  -.1073044
 45-64#2023  |  -.1056485   .0016722   -63.18   0.000    -.1089259  
>   -.102371
   65+#2015  |  -.1363638    .001677   -81.31   0.000    -.1396507  
>  -.1330769
   65+#2016  |  -.1237178   .0017042   -72.60   0.000     -.127058  
>  -.1203776
   65+#2017  |  -.1189338    .001715   -69.35   0.000    -.1222952  
>  -.1155724
   65+#2018  |   -.134183   .0016708   -80.31   0.000    -.1374577  
>  -.1309082
   65+#2019  |  -.1320583    .001673   -78.94   0.000    -.1353373  
>  -.1287793
   65+#2020  |  -.1283872   .0016778   -76.52   0.000    -.1316757  
>  -.1250988
   65+#2021  |  -.1328422   .0016684   -79.62   0.000    -.1361122  
>  -.1295722
   65+#2022  |  -.1165876   .0017093   -68.21   0.000    -.1199377  
>  -.1132375
   65+#2023  |  -.1375909   .0016528   -83.25   0.000    -.1408302  
>  -.1343515
--------------------------------------------------------------------
> ----------

Absorbed degrees of freedom:
-------------------------------------------------------+
   Absorbed FE | Categories  - Redundant  = Num. Coefs |
---------------+---------------------------------------|
  state_fips_o |         1           0           1     |
 county_fips_o |         1           1           0     |
   cat_married |         4           1           3    ?|
-------------------------------------------------------+
? = number of redundant parameters may be higher
migration not found
r(111);

end of do-file

r(111);

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_00002v.tmp"

. 
. ** Loop over out- and in-migration 
. forvalues i = 1/2 {
  2.         
.         if `i' == 1 local ytitle_txt = "Out-migration rate (%)"
  3.         if `i' == 2 local ytitle_txt = "In-migration rate (%)"
  4. 
.         ** Loop over categories
.         foreach cat of varlist cat_* {
  5.                 
.                 ** Get label 
.                 local mylabel : variable label `cat'
  6.                 
.                 ** Run Regressions
.                 hdfe_catyear_plot out_`i' if sample_`i' == 1,     
>       ///
>                         cat(`cat') year(year)                     
>                               ///
>                         absorb(state_fips_o county_fips_o cat_marr
> ied)          ///
>                         wvar(perwt) wtype(fw)                     
>                               ///
>                         ytitle("`ytitle_txt'")                    
>                                       ///
>                         saving("${results}fig_`cat'_`i'") replace 
  7.                 
. sdf
  8.         } // END CAT LOOP
  9.         
. } // END SAMPLE LOOP 
(MWFE estimator converged in 2 iterations)

HDFE Linear regression                            Number of obs   = 
>  5,546,937
Absorbing 3 HDFE groups                           F(  35,5546898) = 
>    2228.40
                                                  Prob > F        = 
>     0.0000
                                                  R-squared       = 
>     0.0171
                                                  Adj R-squared   = 
>     0.0171
                                                  Within R-sq.    = 
>     0.0131
                                                  Root MSE        = 
>     0.2412

--------------------------------------------------------------------
> ----------
             |               Robust
       out_1 | Coefficient  std. err.      t    P>|t|     [95% conf.
>  interval]
-------------+------------------------------------------------------
> ----------
cat_age#year |
 18-24#2016  |  -.0463757   .0020777   -22.32   0.000    -.0504479  
>  -.0423035
 18-24#2017  |  -.0684601    .002023   -33.84   0.000    -.0724251  
>  -.0644952
 18-24#2018  |  -.0554329    .002109   -26.28   0.000    -.0595665  
>  -.0512993
 18-24#2019  |   -.009515   .0022099    -4.31   0.000    -.0138464  
>  -.0051836
 18-24#2020  |  -.0467404   .0021045   -22.21   0.000     -.050865  
>  -.0426157
 18-24#2021  |   -.040116   .0021434   -18.72   0.000    -.0443169  
>   -.035915
 18-24#2022  |  -.0068847   .0022127    -3.11   0.002    -.0112215  
>  -.0025479
 18-24#2023  |  -.0283308    .002188   -12.95   0.000    -.0326192  
>  -.0240424
 25-44#2015  |  -.0716562   .0016816   -42.61   0.000    -.0749521  
>  -.0683603
 25-44#2016  |   -.066591   .0016859   -39.50   0.000    -.0698953  
>  -.0632867
 25-44#2017  |  -.0840984   .0016698   -50.36   0.000    -.0873713  
>  -.0808256
 25-44#2018  |  -.0702567   .0016806   -41.81   0.000    -.0735505  
>  -.0669628
 25-44#2019  |  -.0906352    .001661   -54.57   0.000    -.0938907  
>  -.0873798
 25-44#2020  |     -.0703   .0016794   -41.86   0.000    -.0735916  
>  -.0670085
 25-44#2021  |  -.0621904   .0016857   -36.89   0.000    -.0654944  
>  -.0588864
 25-44#2022  |  -.0469358   .0016993   -27.62   0.000    -.0502665  
>  -.0436052
 25-44#2023  |  -.0816658   .0016731   -48.81   0.000    -.0849451  
>  -.0783866
 45-64#2015  |  -.1005275   .0016783   -59.90   0.000    -.1038168  
>  -.0972381
 45-64#2016  |  -.1155962   .0016579   -69.72   0.000    -.1188456  
>  -.1123467
 45-64#2017  |  -.1172928   .0016558   -70.84   0.000    -.1205381  
>  -.1140475
 45-64#2018  |  -.1180491   .0016533   -71.40   0.000    -.1212895  
>  -.1148087
 45-64#2019  |  -.1272698   .0016422   -77.50   0.000    -.1304884  
>  -.1240512
 45-64#2020  |  -.1277156   .0016424   -77.76   0.000    -.1309346  
>  -.1244966
 45-64#2021  |  -.1064926   .0016686   -63.82   0.000    -.1097631  
>  -.1032221
 45-64#2022  |  -.1105685   .0016654   -66.39   0.000    -.1138326  
>  -.1073044
 45-64#2023  |  -.1056485   .0016722   -63.18   0.000    -.1089259  
>   -.102371
   65+#2015  |  -.1363638    .001677   -81.31   0.000    -.1396507  
>  -.1330769
   65+#2016  |  -.1237178   .0017042   -72.60   0.000     -.127058  
>  -.1203776
   65+#2017  |  -.1189338    .001715   -69.35   0.000    -.1222952  
>  -.1155724
   65+#2018  |   -.134183   .0016708   -80.31   0.000    -.1374577  
>  -.1309082
   65+#2019  |  -.1320583    .001673   -78.94   0.000    -.1353373  
>  -.1287793
   65+#2020  |  -.1283872   .0016778   -76.52   0.000    -.1316757  
>  -.1250988
   65+#2021  |  -.1328422   .0016684   -79.62   0.000    -.1361122  
>  -.1295722
   65+#2022  |  -.1165876   .0017093   -68.21   0.000    -.1199377  
>  -.1132375
   65+#2023  |  -.1375909   .0016528   -83.25   0.000    -.1408302  
>  -.1343515
--------------------------------------------------------------------
> ----------

Absorbed degrees of freedom:
-------------------------------------------------------+
   Absorbed FE | Categories  - Redundant  = Num. Coefs |
---------------+---------------------------------------|
  state_fips_o |         1           0           1     |
 county_fips_o |         1           1           0     |
   cat_married |         4           1           3    ?|
-------------------------------------------------------+
? = number of redundant parameters may be higher
migration not found
r(111);

end of do-file

r(111);

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_00002w.tmp"

. 
. ** Define regression + plotting function 
. capture program drop hdfe_catyear_plot

. program define hdfe_catyear_plot
  1.     version 16.0
  2.     syntax varname(numeric) [if] [in] [fw aw pw iw] , ///
>         CAT(varname) YEAR(varname) ABSORB(string) ///
>         [ SAMPLE(varname) SVAL(real 1) ///
>           WVAR(varname) WTYPE(string) ///
>           VCE(string) ///
>           TITLE(string asis) XTITLE(string asis) YTITLE(string asi
> s) ///
>           NOCI ///
>           SAVING(string asis) REPLACE ]
  3. 
.     // -----------------------------------------------------------
> ----------
.     // Requirements
.     // -----------------------------------------------------------
> ----------
.     capture which reghdfe
  4.     if _rc {
  5.         di as error "reghdfe not found. Install with: ssc insta
> ll reghdfe, replace"
  6.         exit 198
  7.     }
  8.     capture which coefplot
  9.     if _rc {
 10.         di as error "coefplot not found. Install with: ssc inst
> all coefplot, replace"
 11.         exit 198
 12.     }
 13. 
.     // -----------------------------------------------------------
> ----------
.     // Mark sample
.     // -----------------------------------------------------------
> ----------
.     marksample touse, strok
 14.     quietly replace `touse' = `touse' & !missing(`varlist', `ca
> t', `year')
 15. 
.     if "`sample'" != "" {
 16.         quietly replace `touse' = `touse' & (`sample' == `sval'
> )
 17.     }
 18. 
.     // -----------------------------------------------------------
> ----------
.     // Handle weights: if user didn't pass [pw/fw/...], default to
>  fw=perwt
.     // -----------------------------------------------------------
> ----------
.     local wgt ""
 19.     if "`weight'" != "" {
 20.         local wgt "[`weight'=`exp']"
 21.     }
 22.     else {
 23.         if "`wvar'" == "" local wvar "perwt"
 24.         if "`wtype'" == "" local wtype "fw"
 25.         capture confirm variable `wvar'
 26.         if _rc {
 27.             di as error "Default weight variable `wvar' not fou
> nd. Either create it or pass weights explicitly."
 28.             exit 111
 29.         }
 30.         local wgt "[`wtype'=`wvar']"
 31.     }
 32. 
.     // -----------------------------------------------------------
> ----------
.     // Ensure cat/year are numeric factor-friendly. Encode/destrin
> g if needed.
.     // -----------------------------------------------------------
> ----------
.     tempvar __cat __year
 33. 
.     local cattype : type `cat'
 34.     if substr("`cattype'",1,3) == "str" {
 35.         quietly encode `cat' if `touse', gen(`__cat')
 36.         local catv `__cat'
 37.     }
 38.     else {
 39.         local catv `cat'
 40.     }
 41. 
.     local yeartype : type `year'
 42.     if substr("`yeartype'",1,3) == "str" {
 43.         // attempt to destring; if it fails, we exit
.         quietly destring `year' if `touse', gen(`__year') force
 44.         capture assert !missing(`__year') if `touse'
 45.         if _rc {
 46.             di as error "Year variable is string and could not 
> be cleanly converted to numeric."
 47.             exit 459
 48.         }
 49.         local yearv `__year'
 50.     }
 51.     else {
 52.         local yearv `year'
 53.     }
 54. 
.     // -----------------------------------------------------------
> ----------
.     // Levels for plotting
.     // -----------------------------------------------------------
> ----------
.     quietly levelsof `yearv' if `touse', local(yrs)
 55.     quietly levelsof `catv'  if `touse', local(cats)
 56. 
.     if "`yrs'" == "" | "`cats'" == "" {
 57.         di as error "No observations available after applying i
> f/in/sample filters."
 58.         exit 2000
 59.     }
 60. 
.     // Build x-axis positions and labels
.     local poslist ""
 61.     local xlabel  ""
 62.     local k = 0
 63.     foreach y of local yrs {
 64.         local ++k
 65.         local poslist `poslist' `k'
 66.         local xlabel  `xlabel'  `k' "`y'"
 67.     }
 68. 
.     // -----------------------------------------------------------
> ----------
.     // Regression: fully interacted cells (cat#year) + absorbed FE
> s, no constant
.     // Coefficients are adjusted means for each (cat,year) cell co
> nditional on FEs
.     // -----------------------------------------------------------
> ----------
.     reghdfe `varlist' i.`catv'#i.`yearv' if `touse' `wgt', ///
>         absorb(`absorb') vce(`=cond("`vce'"=="","robust","`vce'")'
> ) nocons
 69. 
.     estimates store __hdfe_catyear_plot
 70. 
.     // -----------------------------------------------------------
> ----------
.     // Build coefplot specs: one line per category level, aligned 
> by year
.     // -----------------------------------------------------------
> ----------
.     local plotspecs ""
 71.     local vlab : value label `catv'
 72. 
.         
.     foreach c of local cats {
 73.         // series label: value label if it exists, else cat=val
> ue
.         local serieslab "`cat'=`c'"
 74.         if "`vlab'" != "" {
 75.             local tmp : label `vlab' `c'
 76.             if "`tmp'" != "" local serieslab "`tmp'"
 77.         }
 78. 
.         // Coefs in year order for this category level
.         local keepc ""
 79.         foreach y of local yrs {
 80.             // coefficient name format: <c>.<catv>#<y>.<yearv>
.             local keepc `keepc' `c'.`catv'#`y'.`yearv'
 81. 
.         }
 82. 
.         // CI display control
.         local ciopt ""
 83.         if "`noci'" != "" local ciopt "noci"
 84. 
.         local plotspecs `plotspecs' ///
>             (., keep(`keepc') order(`keepc') at(`poslist') label("
> `serieslab'") `ciopt')
 85.                                                 
.     }
 86. 
.     // -----------------------------------------------------------
> ----------
.     // Plot
.     // -----------------------------------------------------------
> ----------
.     if "`xtitle'" == "" local xtitle "Year"
 87.     if "`ytitle'" == "" local ytitle "`varlist' (adjusted mean)
> "
 88. 
.     coefplot `plotspecs', ///
>         vertical ///
>         xlabel(`xlabel', angle(45)) ///
>         xtitle(`xtitle') ///
>         ytitle(`ytitle') ///
>         legend(cols(1) position(6) )
 89. 
.     // Save graph if requested (expects a .gph path)
.     if "`saving'" != "" {
 90.         graph save "`saving'" , `replace'
 91.     }
 92. end

. 
end of do-file

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_00002x.tmp"

. ** Loop over out- and in-migration 
. forvalues i = 1/2 {
  2.         
.         if `i' == 1 local ytitle_txt "Out-migration rate (%)"
  3.         if `i' == 2 local ytitle_txt "In-migration rate (%)"
  4. 
.         ** Loop over categories
.         foreach cat of varlist cat_* {
  5.                 
.                 ** Get label 
.                 local mylabel : variable label `cat'
  6.                 
.                 ** Run Regressions
.                 hdfe_catyear_plot out_`i' if sample_`i' == 1,     
>       ///
>                         cat(`cat') year(year)                     
>                               ///
>                         absorb(state_fips_o county_fips_o cat_marr
> ied)          ///
>                         wvar(perwt) wtype(fw)                     
>                               ///
>                         ytitle("`ytitle_txt'")                    
>                                       ///
>                         saving("${results}fig_`cat'_`i'") replace 
  7.                 
. sdf
  8.         } // END CAT LOOP
  9.         
. } // END SAMPLE LOOP 
(MWFE estimator converged in 2 iterations)

HDFE Linear regression                            Number of obs   = 
>  5,546,937
Absorbing 3 HDFE groups                           F(  35,5546898) = 
>    2228.40
                                                  Prob > F        = 
>     0.0000
                                                  R-squared       = 
>     0.0171
                                                  Adj R-squared   = 
>     0.0171
                                                  Within R-sq.    = 
>     0.0131
                                                  Root MSE        = 
>     0.2412

--------------------------------------------------------------------
> ----------
             |               Robust
       out_1 | Coefficient  std. err.      t    P>|t|     [95% conf.
>  interval]
-------------+------------------------------------------------------
> ----------
cat_age#year |
 18-24#2016  |  -.0463757   .0020777   -22.32   0.000    -.0504479  
>  -.0423035
 18-24#2017  |  -.0684601    .002023   -33.84   0.000    -.0724251  
>  -.0644952
 18-24#2018  |  -.0554329    .002109   -26.28   0.000    -.0595665  
>  -.0512993
 18-24#2019  |   -.009515   .0022099    -4.31   0.000    -.0138464  
>  -.0051836
 18-24#2020  |  -.0467404   .0021045   -22.21   0.000     -.050865  
>  -.0426157
 18-24#2021  |   -.040116   .0021434   -18.72   0.000    -.0443169  
>   -.035915
 18-24#2022  |  -.0068847   .0022127    -3.11   0.002    -.0112215  
>  -.0025479
 18-24#2023  |  -.0283308    .002188   -12.95   0.000    -.0326192  
>  -.0240424
 25-44#2015  |  -.0716562   .0016816   -42.61   0.000    -.0749521  
>  -.0683603
 25-44#2016  |   -.066591   .0016859   -39.50   0.000    -.0698953  
>  -.0632867
 25-44#2017  |  -.0840984   .0016698   -50.36   0.000    -.0873713  
>  -.0808256
 25-44#2018  |  -.0702567   .0016806   -41.81   0.000    -.0735505  
>  -.0669628
 25-44#2019  |  -.0906352    .001661   -54.57   0.000    -.0938907  
>  -.0873798
 25-44#2020  |     -.0703   .0016794   -41.86   0.000    -.0735916  
>  -.0670085
 25-44#2021  |  -.0621904   .0016857   -36.89   0.000    -.0654944  
>  -.0588864
 25-44#2022  |  -.0469358   .0016993   -27.62   0.000    -.0502665  
>  -.0436052
 25-44#2023  |  -.0816658   .0016731   -48.81   0.000    -.0849451  
>  -.0783866
 45-64#2015  |  -.1005275   .0016783   -59.90   0.000    -.1038168  
>  -.0972381
 45-64#2016  |  -.1155962   .0016579   -69.72   0.000    -.1188456  
>  -.1123467
 45-64#2017  |  -.1172928   .0016558   -70.84   0.000    -.1205381  
>  -.1140475
 45-64#2018  |  -.1180491   .0016533   -71.40   0.000    -.1212895  
>  -.1148087
 45-64#2019  |  -.1272698   .0016422   -77.50   0.000    -.1304884  
>  -.1240512
 45-64#2020  |  -.1277156   .0016424   -77.76   0.000    -.1309346  
>  -.1244966
 45-64#2021  |  -.1064926   .0016686   -63.82   0.000    -.1097631  
>  -.1032221
 45-64#2022  |  -.1105685   .0016654   -66.39   0.000    -.1138326  
>  -.1073044
 45-64#2023  |  -.1056485   .0016722   -63.18   0.000    -.1089259  
>   -.102371
   65+#2015  |  -.1363638    .001677   -81.31   0.000    -.1396507  
>  -.1330769
   65+#2016  |  -.1237178   .0017042   -72.60   0.000     -.127058  
>  -.1203776
   65+#2017  |  -.1189338    .001715   -69.35   0.000    -.1222952  
>  -.1155724
   65+#2018  |   -.134183   .0016708   -80.31   0.000    -.1374577  
>  -.1309082
   65+#2019  |  -.1320583    .001673   -78.94   0.000    -.1353373  
>  -.1287793
   65+#2020  |  -.1283872   .0016778   -76.52   0.000    -.1316757  
>  -.1250988
   65+#2021  |  -.1328422   .0016684   -79.62   0.000    -.1361122  
>  -.1295722
   65+#2022  |  -.1165876   .0017093   -68.21   0.000    -.1199377  
>  -.1132375
   65+#2023  |  -.1375909   .0016528   -83.25   0.000    -.1408302  
>  -.1343515
--------------------------------------------------------------------
> ----------

Absorbed degrees of freedom:
-------------------------------------------------------+
   Absorbed FE | Categories  - Redundant  = Num. Coefs |
---------------+---------------------------------------|
  state_fips_o |         1           0           1     |
 county_fips_o |         1           1           0     |
   cat_married |         4           1           3    ?|
-------------------------------------------------------+
? = number of redundant parameters may be higher
migration not found
r(111);

end of do-file

r(111);

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_000030.tmp"

. 
. ** Loop over out- and in-migration 
. forvalues i = 1/2 {
  2.         
.         if `i' == 1 local ytitle_txt "Out-migration rate (%)"
  3.         if `i' == 2 local ytitle_txt "In-migration rate (%)"
  4. 
.         ** Loop over categories
.         foreach cat of varlist cat_* {
  5.                 
.                 ** Get label 
.                 local mylabel : variable label `cat'
  6.                 
.                 ** Run Regressions
.                 hdfe_catyear_plot out_`i' if sample_`i' == 1,     
>       ///
>                         cat(`cat') year(year)                     
>                               ///
>                         absorb(state_fips_o county_fips_o cat_marr
> ied)          ///
>                         wvar(perwt) wtype(fw)                     
>                               ///
>                         ytitle(`ytitle_txt')                      
>                                       ///
>                         saving("${results}fig_`cat'_`i'") replace 
  7.                 
. sdf
  8.         } // END CAT LOOP
  9.         
. } // END SAMPLE LOOP 
(MWFE estimator converged in 2 iterations)

HDFE Linear regression                            Number of obs   = 
>  5,546,937
Absorbing 3 HDFE groups                           F(  35,5546898) = 
>    2228.40
                                                  Prob > F        = 
>     0.0000
                                                  R-squared       = 
>     0.0171
                                                  Adj R-squared   = 
>     0.0171
                                                  Within R-sq.    = 
>     0.0131
                                                  Root MSE        = 
>     0.2412

--------------------------------------------------------------------
> ----------
             |               Robust
       out_1 | Coefficient  std. err.      t    P>|t|     [95% conf.
>  interval]
-------------+------------------------------------------------------
> ----------
cat_age#year |
 18-24#2016  |  -.0463757   .0020777   -22.32   0.000    -.0504479  
>  -.0423035
 18-24#2017  |  -.0684601    .002023   -33.84   0.000    -.0724251  
>  -.0644952
 18-24#2018  |  -.0554329    .002109   -26.28   0.000    -.0595665  
>  -.0512993
 18-24#2019  |   -.009515   .0022099    -4.31   0.000    -.0138464  
>  -.0051836
 18-24#2020  |  -.0467404   .0021045   -22.21   0.000     -.050865  
>  -.0426157
 18-24#2021  |   -.040116   .0021434   -18.72   0.000    -.0443169  
>   -.035915
 18-24#2022  |  -.0068847   .0022127    -3.11   0.002    -.0112215  
>  -.0025479
 18-24#2023  |  -.0283308    .002188   -12.95   0.000    -.0326192  
>  -.0240424
 25-44#2015  |  -.0716562   .0016816   -42.61   0.000    -.0749521  
>  -.0683603
 25-44#2016  |   -.066591   .0016859   -39.50   0.000    -.0698953  
>  -.0632867
 25-44#2017  |  -.0840984   .0016698   -50.36   0.000    -.0873713  
>  -.0808256
 25-44#2018  |  -.0702567   .0016806   -41.81   0.000    -.0735505  
>  -.0669628
 25-44#2019  |  -.0906352    .001661   -54.57   0.000    -.0938907  
>  -.0873798
 25-44#2020  |     -.0703   .0016794   -41.86   0.000    -.0735916  
>  -.0670085
 25-44#2021  |  -.0621904   .0016857   -36.89   0.000    -.0654944  
>  -.0588864
 25-44#2022  |  -.0469358   .0016993   -27.62   0.000    -.0502665  
>  -.0436052
 25-44#2023  |  -.0816658   .0016731   -48.81   0.000    -.0849451  
>  -.0783866
 45-64#2015  |  -.1005275   .0016783   -59.90   0.000    -.1038168  
>  -.0972381
 45-64#2016  |  -.1155962   .0016579   -69.72   0.000    -.1188456  
>  -.1123467
 45-64#2017  |  -.1172928   .0016558   -70.84   0.000    -.1205381  
>  -.1140475
 45-64#2018  |  -.1180491   .0016533   -71.40   0.000    -.1212895  
>  -.1148087
 45-64#2019  |  -.1272698   .0016422   -77.50   0.000    -.1304884  
>  -.1240512
 45-64#2020  |  -.1277156   .0016424   -77.76   0.000    -.1309346  
>  -.1244966
 45-64#2021  |  -.1064926   .0016686   -63.82   0.000    -.1097631  
>  -.1032221
 45-64#2022  |  -.1105685   .0016654   -66.39   0.000    -.1138326  
>  -.1073044
 45-64#2023  |  -.1056485   .0016722   -63.18   0.000    -.1089259  
>   -.102371
   65+#2015  |  -.1363638    .001677   -81.31   0.000    -.1396507  
>  -.1330769
   65+#2016  |  -.1237178   .0017042   -72.60   0.000     -.127058  
>  -.1203776
   65+#2017  |  -.1189338    .001715   -69.35   0.000    -.1222952  
>  -.1155724
   65+#2018  |   -.134183   .0016708   -80.31   0.000    -.1374577  
>  -.1309082
   65+#2019  |  -.1320583    .001673   -78.94   0.000    -.1353373  
>  -.1287793
   65+#2020  |  -.1283872   .0016778   -76.52   0.000    -.1316757  
>  -.1250988
   65+#2021  |  -.1328422   .0016684   -79.62   0.000    -.1361122  
>  -.1295722
   65+#2022  |  -.1165876   .0017093   -68.21   0.000    -.1199377  
>  -.1132375
   65+#2023  |  -.1375909   .0016528   -83.25   0.000    -.1408302  
>  -.1343515
--------------------------------------------------------------------
> ----------

Absorbed degrees of freedom:
-------------------------------------------------------+
   Absorbed FE | Categories  - Redundant  = Num. Coefs |
---------------+---------------------------------------|
  state_fips_o |         1           0           1     |
 county_fips_o |         1           1           0     |
   cat_married |         4           1           3    ?|
-------------------------------------------------------+
? = number of redundant parameters may be higher
.: invalid syntax in at()
r(198);

end of do-file

r(198);

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_000031.tmp"

. /*******************************************************************************
> File Name:              02_indiv_analysis.do
> Creator:                John Iselin
> Date Update:    November 29, 2025
> 
> Called by: 00_multnomah.do
> 
> Purpose: Preform individual-level migration analysis. 
> 
> Authors: John Iselin 
> 
> For more information, contact john.iselin@yale.edu
> 
> *******************************************************************************/
. 
. ** Start log file 
. capture log close log_02

. log using "${logs}02_log_individual_${date}", replace text name(log_02)
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
      name:  log_02
       log:  C:/Users/ji252/Documents/GitHub/multnomah-county-tax/code/logs/02_log_individual_2025-12-15.log
  log type:  text
 opened on:  16 Dec 2025, 09:15:12

. 
. ** Define regression + plotting function 
. capture program drop hdfe_catyear_plot

. program define hdfe_catyear_plot
  1.     version 16.0
  2.     syntax varname(numeric) [if] [in] [fw aw pw iw] , ///
>         CAT(varname) YEAR(varname) ABSORB(string) ///
>         [ SAMPLE(varname) SVAL(real 1) ///
>           WVAR(varname) WTYPE(string) ///
>           VCE(string) ///
>           TITLE(string asis) XTITLE(string asis) YTITLE(string asis) ///
>           NOCI ///
>           SAVING(string asis) REPLACE ]
  3. 
.     // Requirements
.     capture which reghdfe
  4.     if _rc {
  5.         di as error "reghdfe not found. Install with: ssc install reghdfe, replace"
  6.         exit 198
  7.     }
  8.     capture which coefplot
  9.     if _rc {
 10.         di as error "coefplot not found. Install with: ssc install coefplot, replace"
 11.         exit 198
 12.     }
 13. 
.     // Mark sample
.     marksample touse, strok
 14.     quietly replace `touse' = `touse' & !missing(`varlist', `cat', `year')
 15.     if "`sample'" != "" quietly replace `touse' = `touse' & (`sample' == `sval')
 16. 
.     // Weights (default fw=perwt unless user passed weights)
.     local wgt ""
 17.     if "`weight'" != "" {
 18.         local wgt "[`weight'=`exp']"
 19.     }
 20.     else {
 21.         if "`wvar'" == "" local wvar "perwt"
 22.         if "`wtype'" == "" local wtype "fw"
 23.         capture confirm variable `wvar'
 24.         if _rc {
 25.             di as error "Default weight variable `wvar' not found. Either create it or pass weights explicitly."
 26.             exit 111
 27.         }
 28.         local wgt "[`wtype'=`wvar']"
 29.     }
 30. 
.     // Ensure cat/year numeric for factor vars
.     tempvar __cat __year
 31.     local cattype : type `cat'
 32.     if substr("`cattype'",1,3) == "str" {
 33.         quietly encode `cat' if `touse', gen(`__cat')
 34.         local catv `__cat'
 35.     }
 36.     else local catv `cat'
 37. 
.     local yeartype : type `year'
 38.     if substr("`yeartype'",1,3) == "str" {
 39.         quietly destring `year' if `touse', gen(`__year') force
 40.         capture assert !missing(`__year') if `touse'
 41.         if _rc {
 42.             di as error "Year variable is string and could not be cleanly converted to numeric."
 43.             exit 459
 44.         }
 45.         local yearv `__year'
 46.     }
 47.     else local yearv `year'
 48. 
.     // Guard: category variable should not also be absorbed
.     // (Your loop hits this when cat==cat_married and absorb(... cat_married))
.     if regexm(" `absorb' ", " `catv' ") {
 49.         di as error "Category variable `catv' appears in absorb(): `absorb'. Remove it from absorb() for this run."
 50.         exit 198
 51.     }
 52. 
.     // Levels
.     quietly levelsof `yearv' if `touse', local(yrs)
 53.     quietly levelsof `catv'  if `touse', local(cats)
 54.     if "`yrs'" == "" | "`cats'" == "" {
 55.         di as error "No observations available after applying if/in/sample filters."
 56.         exit 2000
 57.     }
 58. 
.     // X-axis positions and labels (positions are 1..K in year order)
.     local xlabel ""
 59.     local k = 0
 60.     foreach y of local yrs {
 61.         local ++k
 62.         local xlabel `xlabel' `k' "`y'"
 63.     }
 64. 
.     // Regression
.     quietly reghdfe `varlist' i.`catv'#i.`yearv' if `touse' `wgt', ///
>         absorb(`absorb') vce(`=cond("`vce'"=="","robust","`vce'")') nocons
 65. 
.     // Existing coefficient names (for robust plotting)
.     local bnames : colnames e(b)
 66. 
.     // Build coefplot specs: one series per category; include only existing coefs
.     local plotspecs ""
 67.     local vlab : value label `catv'
 68. 
.     foreach c of local cats {
 69. 
.         // series label
.         local serieslab "`cat'=`c'"
 70.         if "`vlab'" != "" {
 71.             local tmp : label `vlab' `c'
 72.             if "`tmp'" != "" local serieslab "`tmp'"
 73.         }
 74. 
.         local keepc  ""
 75.         local orderc ""
 76.         local atc    ""
 77. 
.         local k = 0
 78.         foreach y of local yrs {
 79.             local ++k
 80.             local coefname "`c'.`catv'#`y'.`yearv'"
 81. 
.             if strpos(" `bnames' ", " `coefname' ") {
 82.                 local keepc  `keepc'  `coefname'
 83.                 local orderc `orderc' `coefname'
 84.                 local atc    `atc'    `k'
 85.             }
 86.         }
 87. 
.         // Skip this category level if nothing survived estimation
.         if "`keepc'" == "" continue
 88. 
.         local ciopt ""
 89.         if "`noci'" != "" local ciopt "noci"
 90. 
.         local plotspecs `plotspecs' ///
>             (., keep(`keepc') order(`orderc') at(`atc') label("`serieslab'") `ciopt')
 91.     }
 92. 
.     if "`plotspecs'" == "" {
 93.         di as error "No coefficients available to plot (all catyear cells were dropped). Check empty cells/collinearity."
 94.         exit 2001
 95.     }
 96. 
.     // Defaults with safe quoting
.     if "`xtitle'" == "" local xtitle `"`year'"'
 97.     if "`ytitle'" == "" local ytitle `"`varlist' (adjusted mean)"'
 98.     if "`title'"  == "" local title  `"`varlist' by `cat' over `year'"'
 99. 
.     coefplot `plotspecs', ///
>         vertical ///
>         xlabel(`xlabel', angle(45)) ///
>         xtitle(`xtitle') ///
>         ytitle(`ytitle') ///
>         title(`title') ///
>         legend(cols(1) position(6))
100. 
.     // Save graph (ensure .gph extension if user omitted)
.     if "`saving'" != "" {
101.         local savepath `"`saving'"'
102.         if !regexm(`"`savepath'"', "\.gph$") local savepath `"`savepath'.gph"'
103.         graph save `"`savepath'"', `replace'
104.     }
105. end

. 
. 
. 
. ** Load ACS Data 
. use "${data}working/acs_migration_file", replace 

. 
. ** Define sample 
. drop if qmigplc1 == 4                                   // FAILED EDIT OF MIGPLACE 
(388,364 observations deleted)

. drop if inlist(state_fips_o, 2, 15)     // ALASKA AND HAWAII 
(136,571 observations deleted)

. 
. ** Define indicator for being in Multnomah County in origin/destination year
. gen multnomah_o = state_fips_o == 41 & county_fips_o == 51

. gen multnomah_d = state_fips_d == 41 & county_fips_d == 51

. 
. ** Define samples 
. gen sample_1 = multnomah_o == 1                                 // Multnomah in origin-year 

. gen sample_2 = multnomah_o != 1                                 // Not in Multnomah

. label var sample_1 "Out-migration Sample"

. label var sample_1 "In-migration Sample"

. 
. ** Define moving indicator 
. gen out_1 = same_county == 0 

. label var out_1 "Moved out of Multnomah"

. gen out_2 = multnomah_d == 1 

. label var out_2 "Moved to Multnomah"

. 
. ** Define variables of interest
. 
. ** Age 
. recode age      (18/24 = 1 "18-24")     ///
>                         (25/44 = 2 "25-44")             ///
>                         (45/64 = 3 "45-64")     ///
>                         (65/max = 4 "65+"),     ///
>         gen(cat_age)
(20,893,859 differences between age and cat_age)

. label var cat_age "Age categories"

. 
. ** Sex  
. gen cat_sex = sex == 2 

. label var cat_sex "Female indicator"

. label define lb_cat_sex 0 "Male" 1 "Female"

. label values cat_sex cat_sex 

. 
. ** Marital Status               
. recode marst    (1 = 1 "Married")                               ///
>                                 (2/3 = 2 "Seperated")                   ///
>                                 (4/5 = 3 "Divourced / Widowed") ///
>                                 (6 = 4 "Single"),                               ///
>         gen(cat_married)
(9,061,905 differences between marst and cat_married)

. label var cat_married "Marriage categories"

. 
. ** Kids at home 
. recode nchild   (0 = 0 "0 Children")                                    ///
>                                 (1 = 1 "1 Child")                                               ///
>                                 (2 = 2 "2 Children")                                    ///
>                                 (3/max = 3 "3+ Children"),                              ///
>         gen(cat_child)
(412,920 differences between nchild and cat_child)

. label var cat_child "Number of Children"

. 
. ** Education 
. recode educd    (min/61 = 1 "Less than HS")     ///
>                                 (62/71 = 2 "HS Diploma")                ///
>                                 (80/100 = 3 "Some College")     ///
>                                 (101/max = 4 "College Degree"), ///
>         gen(cat_educ)
(20,893,859 differences between educd and cat_educ)

. label var cat_educ "Education categories"

. 
. ** Earnings / Income 
. gen tmp1 = cpi99 if year == 2023
(18,380,619 missing values generated)

. egen tmp2 = mean(tmp1)

. gen cpi =  cpi99 / tmp2 

. drop tmp1 tmp2 

. 
. ** Loop over income variables 
. foreach var of varlist inctot incwage incearn ftotinc {
  2.         
.         ** Update CPI 
.         gen real_`var' = round(`var' * cpi) 
  3.         
.         ** Categorical variables 
.         recode real_`var'       (min/-1 = 1 "Negative income")          ///
>                                                 (0 = 2 "$0")                                            ///
>                                                 (1/24999 = 3 "$1-$25K")                         ///
>                                                 (25000/49999 = 4 "$25K-$50K")           ///
>                                                 (50000/99999 = 5 "$50K-$100K")          ///
>                                                 (100000/199999 = 6 "$100K-$200K")       ///
>                                                 (200000/max = 7 "$200K+") ,             ///
>                         gen(cat_`var')
  4.                         
.         ** Tab
.         tab cat_`var', m 
  5.         
. }
(20,893,859 differences between real_inctot and cat_inctot)

      RECODE of |
    real_inctot |      Freq.     Percent        Cum.
----------------+-----------------------------------
Negative income |     20,759        0.10        0.10
             $0 |  1,748,089        8.37        8.47
        $1-$25K |  6,204,378       29.69       38.16
      $25K-$50K |  4,981,113       23.84       62.00
     $50K-$100K |  4,947,578       23.68       85.68
    $100K-$200K |  2,211,136       10.58       96.26
         $200K+ |    780,806        3.74      100.00
----------------+-----------------------------------
          Total | 20,893,859      100.00
(20,893,859 differences between real_incwage and cat_incwage)

      RECODE of |
   real_incwage |      Freq.     Percent        Cum.
----------------+-----------------------------------
             $0 |  8,182,418       39.16       39.16
        $1-$25K |  3,428,895       16.41       55.57
      $25K-$50K |  3,290,630       15.75       71.32
     $50K-$100K |  3,729,590       17.85       89.17
    $100K-$200K |  1,743,819        8.35       97.52
         $200K+ |    518,507        2.48      100.00
----------------+-----------------------------------
          Total | 20,893,859      100.00
(20,893,859 differences between real_incearn and cat_incearn)

      RECODE of |
   real_incearn |      Freq.     Percent        Cum.
----------------+-----------------------------------
Negative income |     16,135        0.08        0.08
             $0 |  7,365,326       35.25       35.33
        $1-$25K |  3,756,344       17.98       53.31
      $25K-$50K |  3,476,928       16.64       69.95
     $50K-$100K |  3,876,560       18.55       88.50
    $100K-$200K |  1,823,201        8.73       97.23
         $200K+ |    579,365        2.77      100.00
----------------+-----------------------------------
          Total | 20,893,859      100.00
(20,893,767 differences between real_ftotinc and cat_ftotinc)

      RECODE of |
   real_ftotinc |      Freq.     Percent        Cum.
----------------+-----------------------------------
Negative income |      7,238        0.03        0.03
             $0 |    226,387        1.08        1.12
        $1-$25K |  2,249,309       10.77       11.88
      $25K-$50K |  3,258,513       15.60       27.48
     $50K-$100K |  5,975,505       28.60       56.08
    $100K-$200K |  6,147,777       29.42       85.50
         $200K+ |  3,029,130       14.50      100.00
----------------+-----------------------------------
          Total | 20,893,859      100.00

. 
. ** Label variable 
. label var cat_inctot "Total personal income categories (real 2023 USD)"

. label var cat_incwage "Total wage income categories (real 2023 USD)"

. label var cat_incearn "Total earned income categories (real 2023 USD)"

. label var cat_ftotinc "Total family income categories (real 2023 USD)"

. 
. ** Loop over out- and in-migration 
. forvalues i = 1/2 {
  2.         
.         if `i' == 1 local ytitle_txt "Out-migration rate (%)"
  3.         if `i' == 2 local ytitle_txt "In-migration rate (%)"
  4. 
.         ** Loop over categories
.         foreach cat of varlist cat_* {
  5.                 
.                 ** Get label 
.                 local mylabel : variable label `cat'
  6.                 
.                 ** Run Regressions
.                 hdfe_catyear_plot out_`i' if sample_`i' == 1,           ///
>                         cat(`cat') year(year)                                                   ///
>                         absorb(state_fips_o county_fips_o cat_married)          ///
>                         wvar(perwt) wtype(fw)                                                   ///
>                         ytitle(`ytitle_txt')                                                            ///
>                         saving("${results}fig_`cat'_`i'") replace 
  7.                 
. 
.         } // END CAT LOOP
  8.         
. } // END SAMPLE LOOP 
unknown function 44") ) ()
r(133);

end of do-file

r(133);

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_000032
> .tmp"

. /***************************************************
> ****************************
> File Name:              02_indiv_analysis.do
> Creator:                John Iselin
> Date Update:    November 29, 2025
> 
> Called by: 00_multnomah.do
> 
> Purpose: Preform individual-level migration analysis
> . 
> 
> Authors: John Iselin 
> 
> For more information, contact john.iselin@yale.edu
> 
> ****************************************************
> ***************************/
. 
. ** Start log file 
. capture log close log_02

. log using "${logs}02_log_individual_${date}", replac
> e text name(log_02)
------------------------------------------------------
      name:  log_02
       log:  C:/Users/ji252/Documents/GitHub/multnomah
> -county-tax/code/logs/02_log_individual_2025-12-15.l
> og
  log type:  text
 opened on:  16 Dec 2025, 09:21:22

. 
. ** Define regression + plotting function 
. capture program drop hdfe_catyear_plot

. program define hdfe_catyear_plot
  1.     version 16.0
  2.     syntax varname(numeric) [if] [in] [fw aw pw i
> w] , ///
>         CAT(varname) YEAR(varname) ABSORB(string) //
> /
>         [ SAMPLE(varname) SVAL(real 1) ///
>           WVAR(varname) WTYPE(string) ///
>           VCE(string) ///
>           TITLE(string asis) XTITLE(string asis) YTI
> TLE(string asis) ///
>           NOCI ///
>           SAVING(string asis) REPLACE ]
  3. 
.     // ---------------------------------------------
> ------------------------
.     // Requirements
.     // ---------------------------------------------
> ------------------------
.     capture which reghdfe
  4.     if _rc {
  5.         di as error "reghdfe not found. Install w
> ith: ssc install reghdfe, replace"
  6.         exit 198
  7.     }
  8.     capture which coefplot
  9.     if _rc {
 10.         di as error "coefplot not found. Install 
> with: ssc install coefplot, replace"
 11.         exit 198
 12.     }
 13. 
.     // ---------------------------------------------
> ------------------------
.     // Mark sample
.     // ---------------------------------------------
> ------------------------
.     marksample touse, strok
 14.     quietly replace `touse' = `touse' & !missing(
> `varlist', `cat', `year')
 15. 
.     if "`sample'" != "" {
 16.         quietly replace `touse' = `touse' & (`sam
> ple' == `sval')
 17.     }
 18. 
.     // ---------------------------------------------
> ------------------------
.     // Handle weights: if user didn't pass [pw/fw/..
> .], default to fw=perwt
.     // ---------------------------------------------
> ------------------------
.     local wgt ""
 19.     if "`weight'" != "" {
 20.         local wgt "[`weight'=`exp']"
 21.     }
 22.     else {
 23.         if "`wvar'" == "" local wvar "perwt"
 24.         if "`wtype'" == "" local wtype "fw"
 25.         capture confirm variable `wvar'
 26.         if _rc {
 27.             di as error "Default weight variable 
> `wvar' not found. Either create it or pass weights e
> xplicitly."
 28.             exit 111
 29.         }
 30.         local wgt "[`wtype'=`wvar']"
 31.     }
 32. 
.     // ---------------------------------------------
> ------------------------
.     // Ensure cat/year are numeric factor-friendly. 
> Encode/destring if needed.
.     // ---------------------------------------------
> ------------------------
.     tempvar __cat __year
 33. 
.     local cattype : type `cat'
 34.     if substr("`cattype'",1,3) == "str" {
 35.         quietly encode `cat' if `touse', gen(`__c
> at')
 36.         local catv `__cat'
 37.     }
 38.     else {
 39.         local catv `cat'
 40.     }
 41. 
.     local yeartype : type `year'
 42.     if substr("`yeartype'",1,3) == "str" {
 43.         // attempt to destring; if it fails, we e
> xit
.         quietly destring `year' if `touse', gen(`__y
> ear') force
 44.         capture assert !missing(`__year') if `tou
> se'
 45.         if _rc {
 46.             di as error "Year variable is string 
> and could not be cleanly converted to numeric."
 47.             exit 459
 48.         }
 49.         local yearv `__year'
 50.     }
 51.     else {
 52.         local yearv `year'
 53.     }
 54. 
.     // ---------------------------------------------
> ------------------------
.     // Levels for plotting
.     // ---------------------------------------------
> ------------------------
.     quietly levelsof `yearv' if `touse', local(yrs)
 55.     quietly levelsof `catv'  if `touse', local(ca
> ts)
 56. 
.     if "`yrs'" == "" | "`cats'" == "" {
 57.         di as error "No observations available af
> ter applying if/in/sample filters."
 58.         exit 2000
 59.     }
 60. 
.     // Build x-axis positions and labels
.     local poslist ""
 61.     local xlabel  ""
 62.     local k = 0
 63.     foreach y of local yrs {
 64.         local ++k
 65.         local poslist `poslist' `k'
 66.         local xlabel  `xlabel'  `k' "`y'"
 67.     }
 68. 
.     // ---------------------------------------------
> ------------------------
.     // Regression: fully interacted cells (cat#year)
>  + absorbed FEs, no constant
.     // Coefficients are adjusted means for each (cat
> ,year) cell conditional on FEs
.     // ---------------------------------------------
> ------------------------
.     reghdfe `varlist' i.`catv'#i.`yearv' if `touse' 
> `wgt', ///
>         absorb(`absorb') vce(`=cond("`vce'"=="","rob
> ust","`vce'")') nocons
 69. 
.     estimates store __hdfe_catyear_plot
 70. 
.     // ---------------------------------------------
> ------------------------
.     // Build coefplot specs: one line per category l
> evel, aligned by year
.     // ---------------------------------------------
> ------------------------
.     local plotspecs ""
 71.     local vlab : value label `catv'
 72. 
.         
.     foreach c of local cats {
 73.         // series label: value label if it exists
> , else cat=value
.         local serieslab "`cat'=`c'"
 74.         if "`vlab'" != "" {
 75.             local tmp : label `vlab' `c'
 76.             if "`tmp'" != "" local serieslab "`tm
> p'"
 77.         }
 78. 
.         // Coefs in year order for this category lev
> el
.         local keepc ""
 79.         foreach y of local yrs {
 80.             // coefficient name format: <c>.<catv
> >#<y>.<yearv>
.             local keepc `keepc' `c'.`catv'#`y'.`year
> v'
 81. 
.         }
 82. 
.         // CI display control
.         local ciopt ""
 83.         if "`noci'" != "" local ciopt "noci"
 84. 
.         local plotspecs `plotspecs' ///
>             (., keep(`keepc') order(`keepc') at(`pos
> list') label("`serieslab'") `ciopt')
 85.                                                 
.     }
 86. 
.     // ---------------------------------------------
> ------------------------
.     // Plot
.     // ---------------------------------------------
> ------------------------
.     if "`xtitle'" == "" local xtitle "Year"
 87.     if "`ytitle'" == "" local ytitle "`varlist' (
> adjusted mean)"
 88. 
.     coefplot `plotspecs', ///
>         vertical ///
>         xlabel(`xlabel', angle(45)) ///
>         xtitle(`xtitle') ///
>         ytitle(`ytitle') ///
>         legend(cols(1) position(6) )
 89. 
.     // Save graph if requested (expects a .gph path)
.     if "`saving'" != "" {
 90.         graph save "`saving'" , `replace'
 91.     }
 92. end

. 
. 
. ** Load ACS Data 
. use "${data}working/acs_migration_file", replace 

. 
. ** Define sample 
. drop if qmigplc1 == 4                               
>     // FAILED EDIT OF MIGPLACE 
(388,364 observations deleted)

. drop if inlist(state_fips_o, 2, 15)     // ALASKA AN
> D HAWAII 
(136,571 observations deleted)

. 
. ** Define indicator for being in Multnomah County in
>  origin/destination year
. gen multnomah_o = state_fips_o == 41 & county_fips_o
>  == 51

. gen multnomah_d = state_fips_d == 41 & county_fips_d
>  == 51

. 
. ** Define samples 
. gen sample_1 = multnomah_o == 1                     
>             // Multnomah in origin-year 

. gen sample_2 = multnomah_o != 1                     
>             // Not in Multnomah

. label var sample_1 "Out-migration Sample"

. label var sample_1 "In-migration Sample"

. 
. ** Define moving indicator 
. gen out_1 = same_county == 0 

. label var out_1 "Moved out of Multnomah"

. gen out_2 = multnomah_d == 1 

. label var out_2 "Moved to Multnomah"

. 
. ** Define variables of interest
. 
. ** Age 
. recode age      (18/24 = 1 "18-24")     ///
>                         (25/44 = 2 "25-44")         
>     ///
>                         (45/64 = 3 "45-64")     ///
>                         (65/max = 4 "65+"),     ///
>         gen(cat_age)
(20,893,859 differences between age and cat_age)

. label var cat_age "Age categories"

. 
. ** Sex  
. gen cat_sex = sex == 2 

. label var cat_sex "Female indicator"

. label define lb_cat_sex 0 "Male" 1 "Female"

. label values cat_sex cat_sex 

. 
. ** Marital Status               
. recode marst    (1 = 1 "Married")                   
>             ///
>                                 (2/3 = 2 "Seperated"
> )                   ///
>                                 (4/5 = 3 "Divourced 
> / Widowed") ///
>                                 (6 = 4 "Single"),   
>                             ///
>         gen(cat_married)
(9,061,905 differences between marst and cat_married)

. label var cat_married "Marriage categories"

. 
. ** Kids at home 
. recode nchild   (0 = 0 "0 Children")                
>                     ///
>                                 (1 = 1 "1 Child")   
>                                             ///
>                                 (2 = 2 "2 Children")
>                                     ///
>                                 (3/max = 3 "3+ Child
> ren"),                              ///
>         gen(cat_child)
(412,920 differences between nchild and cat_child)

. label var cat_child "Number of Children"

. 
. ** Education 
. recode educd    (min/61 = 1 "Less than HS")     ///
>                                 (62/71 = 2 "HS Diplo
> ma")                ///
>                                 (80/100 = 3 "Some Co
> llege")     ///
>                                 (101/max = 4 "Colleg
> e Degree"), ///
>         gen(cat_educ)
(20,893,859 differences between educd and cat_educ)

. label var cat_educ "Education categories"

. 
. ** Earnings / Income 
. gen tmp1 = cpi99 if year == 2023
(18,380,619 missing values generated)

. egen tmp2 = mean(tmp1)

. gen cpi =  cpi99 / tmp2 

. drop tmp1 tmp2 

. 
. ** Loop over income variables 
. foreach var of varlist inctot incwage incearn ftotin
> c {
  2.         
.         ** Update CPI 
.         gen real_`var' = round(`var' * cpi) 
  3.         
.         ** Categorical variables 
.         recode real_`var'       (min/-1 = 1 "Negativ
> e income")          ///
>                                                 (0 =
>  2 "$0")                                            
> ///
>                                                 (1/2
> 4999 = 3 "$1-$25K")                         ///
>                                                 (250
> 00/49999 = 4 "$25K-$50K")           ///
>                                                 (500
> 00/99999 = 5 "$50K-$100K")          ///
>                                                 (100
> 000/199999 = 6 "$100K-$200K")       ///
>                                                 (200
> 000/max = 7 "$200K+") ,             ///
>                         gen(cat_`var')
  4.                         
.         ** Tab
.         tab cat_`var', m 
  5.         
. }
(20,893,859 differences between real_inctot and cat_in
> ctot)

      RECODE of |
    real_inctot |      Freq.     Percent        Cum.
----------------+-----------------------------------
Negative income |     20,759        0.10        0.10
             $0 |  1,748,089        8.37        8.47
        $1-$25K |  6,204,378       29.69       38.16
      $25K-$50K |  4,981,113       23.84       62.00
     $50K-$100K |  4,947,578       23.68       85.68
    $100K-$200K |  2,211,136       10.58       96.26
         $200K+ |    780,806        3.74      100.00
----------------+-----------------------------------
          Total | 20,893,859      100.00
(20,893,859 differences between real_incwage and cat_i
> ncwage)

      RECODE of |
   real_incwage |      Freq.     Percent        Cum.
----------------+-----------------------------------
             $0 |  8,182,418       39.16       39.16
        $1-$25K |  3,428,895       16.41       55.57
      $25K-$50K |  3,290,630       15.75       71.32
     $50K-$100K |  3,729,590       17.85       89.17
    $100K-$200K |  1,743,819        8.35       97.52
         $200K+ |    518,507        2.48      100.00
----------------+-----------------------------------
          Total | 20,893,859      100.00
(20,893,859 differences between real_incearn and cat_i
> ncearn)

      RECODE of |
   real_incearn |      Freq.     Percent        Cum.
----------------+-----------------------------------
Negative income |     16,135        0.08        0.08
             $0 |  7,365,326       35.25       35.33
        $1-$25K |  3,756,344       17.98       53.31
      $25K-$50K |  3,476,928       16.64       69.95
     $50K-$100K |  3,876,560       18.55       88.50
    $100K-$200K |  1,823,201        8.73       97.23
         $200K+ |    579,365        2.77      100.00
----------------+-----------------------------------
          Total | 20,893,859      100.00
(20,893,767 differences between real_ftotinc and cat_f
> totinc)

      RECODE of |
   real_ftotinc |      Freq.     Percent        Cum.
----------------+-----------------------------------
Negative income |      7,238        0.03        0.03
             $0 |    226,387        1.08        1.12
        $1-$25K |  2,249,309       10.77       11.88
      $25K-$50K |  3,258,513       15.60       27.48
     $50K-$100K |  5,975,505       28.60       56.08
    $100K-$200K |  6,147,777       29.42       85.50
         $200K+ |  3,029,130       14.50      100.00
----------------+-----------------------------------
          Total | 20,893,859      100.00

. 
. ** Label variable 
. label var cat_inctot "Total personal income categori
> es (real 2023 USD)"

. label var cat_incwage "Total wage income categories 
> (real 2023 USD)"

. label var cat_incearn "Total earned income categorie
> s (real 2023 USD)"

. label var cat_ftotinc "Total family income categorie
> s (real 2023 USD)"

. 
. ** Loop over out- and in-migration 
. forvalues i = 1/2 {
  2.         
.         if `i' == 1 local ytitle_txt "Out-migration 
> rate (%)"
  3.         if `i' == 2 local ytitle_txt "In-migratio
> n rate (%)"
  4. 
.         ** Loop over categories
.         foreach cat of varlist cat_* {
  5.                 
.                 ** FEs 
.                 unab catvars : cat_*
  6.                 local othercats : list catvars - 
> cat
  7.                 
.                 ** Run Regressions
.                 hdfe_catyear_plot out_`i' if sample_
> `i' == 1,                   ///
>                         cat(`cat') year(year)       
>                                                     
> ///
>                         absorb(state_fips_o county_f
> ips_o `othercats')          ///
>                         wvar(perwt) wtype(fw)       
>                                                     
> ///
>                         ytitle("`ytitle_txt'")      
>                                                     
> ///
>                         saving("${results}fig_`cat'_
> `i'") replace 
  8.                 
.         } // END CAT LOOP
  9.         
. } // END SAMPLE LOOP 
(MWFE estimator converged in 23 iterations)

HDFE Linear regression                            Numb
> er of obs                                           
>             =  5,546,937
Absorbing 10 HDFE groups                          F(  
> 35,5546868)                                         
>             =    1865.44
                                                  Prob
>  > F                                                
>             =     0.0000
                                                  R-sq
> uared                                               
>             =     0.0219
                                                  Adj 
> R-squared                                           
>             =     0.0219
                                                  With
> in R-sq.                                            
>             =     0.0114
                                                  Root
>  MSE                                                
>             =     0.2406

------------------------------------------------------
> ------------------------
             |               Robust
       out_1 | Coefficient  std. err.      t    P>|t| 
>     [95% con                                        
>             f. interval]
-------------+----------------------------------------
> ------------------------
cat_age#year |
 18-24#2016  |  -.0474553   .0020787   -22.83   0.000 
>    -.0515296                                        
>                 -.043381
 18-24#2017  |  -.0680769   .0020241   -33.63   0.000 
>    -.0720439                                        
>                -.0641098
 18-24#2018  |  -.0558421   .0021058   -26.52   0.000 
>    -.0599695                                        
>                -.0517148
 18-24#2019  |  -.0102891   .0022083    -4.66   0.000 
>    -.0146173                                        
>                -.0059609
 18-24#2020  |  -.0479785   .0021038   -22.81   0.000 
>    -.0521018                                        
>                -.0438552
 18-24#2021  |  -.0403349   .0021451   -18.80   0.000 
>    -.0445393                                        
>                -.0361306
 18-24#2022  |  -.0068887   .0022134    -3.11   0.002 
>    -.0112269                                        
>                -.0025504
 18-24#2023  |  -.0280554   .0021894   -12.81   0.000 
>    -.0323465                                        
>                -.0237643
 25-44#2015  |  -.0699782   .0016918   -41.36   0.000 
>     -.073294                                        
>                -.0666624
 25-44#2016  |   -.064872   .0016972   -38.22   0.000 
>    -.0681986                                        
>                -.0615455
 25-44#2017  |   -.082989   .0016796   -49.41   0.000 
>    -.0862809                                        
>                -.0796971
 25-44#2018  |  -.0693565   .0016897   -41.05   0.000 
>    -.0726682                                        
>                -.0660448
 25-44#2019  |  -.0901518   .0016725   -53.90   0.000 
>    -.0934298                                        
>                -.0868737
 25-44#2020  |  -.0707105   .0016904   -41.83   0.000 
>    -.0740236                                        
>                -.0673973
 25-44#2021  |  -.0629801    .001695   -37.16   0.000 
>    -.0663022                                        
>                -.0596579
 25-44#2022  |  -.0470361   .0017091   -27.52   0.000 
>    -.0503858                                        
>                -.0436863
 25-44#2023  |  -.0829885   .0016828   -49.32   0.000 
>    -.0862867                                        
>                -.0796903
 45-64#2015  |  -.1010046   .0016899   -59.77   0.000 
>    -.1043167                                        
>                -.0976925
 45-64#2016  |  -.1156011   .0016679   -69.31   0.000 
>    -.1188701                                        
>                -.1123321
 45-64#2017  |  -.1185417   .0016627   -71.30   0.000 
>    -.1218005                                        
>                -.1152829
 45-64#2018  |  -.1181703   .0016633   -71.04   0.000 
>    -.1214304                                        
>                -.1149102
 45-64#2019  |  -.1277697   .0016528   -77.30   0.000 
>    -.1310091                                        
>                -.1245302
 45-64#2020  |   -.128852   .0016548   -77.87   0.000 
>    -.1320954                                        
>                -.1256087
 45-64#2021  |  -.1070474    .001679   -63.76   0.000 
>    -.1103382                                        
>                -.1037565
 45-64#2022  |  -.1113757   .0016746   -66.51   0.000 
>     -.114658                                        
>                -.1080935
 45-64#2023  |  -.1065285   .0016822   -63.33   0.000 
>    -.1098255                                        
>                -.1032315
   65+#2015  |  -.1398259   .0017033   -82.09   0.000 
>    -.1431644                                        
>                -.1364874
   65+#2016  |  -.1270692   .0017288   -73.50   0.000 
>    -.1304576                                        
>                -.1236808
   65+#2017  |  -.1234184   .0017489   -70.57   0.000 
>    -.1268462                                        
>                -.1199905
   65+#2018  |  -.1388349   .0016939   -81.96   0.000 
>     -.142155                                        
>                -.1355149
   65+#2019  |  -.1367418   .0016999   -80.44   0.000 
>    -.1400735                                        
>                  -.13341
   65+#2020  |  -.1338641   .0017046   -78.53   0.000 
>    -.1372052                                        
>                -.1305231
   65+#2021  |  -.1373984   .0016941   -81.10   0.000 
>    -.1407188                                        
>                 -.134078
   65+#2022  |  -.1212097   .0017303   -70.05   0.000 
>    -.1246011                                        
>                -.1178184
   65+#2023  |  -.1431372   .0016786   -85.27   0.000 
>    -.1464273                                        
>                -.1398471
------------------------------------------------------
> ------------------------

Absorbed degrees of freedom:
------------------------------------------------------
> -+
   Absorbed FE | Categories  - Redundant  = Num. Coefs
>  |
---------------+--------------------------------------
> -|
  state_fips_o |         1           0           1    
>                                                     
>  |
 county_fips_o |         1           1           0    
>                                                     
>  |
       cat_sex |         2           1           1    
> ?                                                   
>  |
   cat_married |         4           1           3    
> ?                                                   
>  |
     cat_child |         4           1           3    
> ?                                                   
>  |
      cat_educ |         4           1           3    
> ?                                                   
>  |
    cat_inctot |         7           1           6    
> ?                                                   
>  |
   cat_incwage |         6           1           5    
> ?                                                   
>  |
   cat_incearn |         7           1           6    
> ?                                                   
>  |
   cat_ftotinc |         7           1           6    
> ?                                                   
>  |
------------------------------------------------------
> -+
? = number of redundant parameters may be higher
migration not found
r(111);

end of do-file

r(111);

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_000033
> .tmp"

. ** Local categorical variables
. local catvar "cat_sex cat_married cat_age cat_child 
> cat_educ cat_ftotinc"

. 
. ** Loop over out- and in-migration 
. forvalues i = 1/2 {
  2.         
.         if `i' == 1 local ytitle_txt "Out-migration 
> rate (%)"
  3.         if `i' == 2 local ytitle_txt "In-migratio
> n rate (%)"
  4. 
.         ** Loop over categories
.         foreach cat of local catvar {
  5.                 
.                 ** FEs 
.                 local othercats : list catvars - cat
  6.                 
.                 ** Run Regressions
.                 hdfe_catyear_plot out_`i' if sample_
> `i' == 1,                   ///
>                         cat(`cat') year(year)       
>                                                     
> ///
>                         absorb(state_fips_o county_f
> ips_o `othercats')          ///
>                         wvar(perwt) wtype(fw)       
>                                                     
> ///
>                         ytitle(`ytitle_txt')        
>                                                     
> ///
>                         saving("${results}fig_`cat'_
> `i'") replace 
  7.                 
.         } // END CAT LOOP
  8.         
. } // END SAMPLE LOOP 
(MWFE estimator converged in 2 iterations)

HDFE Linear regression                            Numb
> er of obs                                           
>             =  5,546,937
Absorbing 2 HDFE groups                           F(  
> 17,5546919)                                         
>             =     385.12
                                                  Prob
>  > F                                                
>             =     0.0000
                                                  R-sq
> uared                                               
>             =     0.0012
                                                  Adj 
> R-squared                                           
>             =     0.0012
                                                  With
> in R-sq.                                            
>             =     0.0012
                                                  Root
>  MSE                                                
>             =     0.2431

------------------------------------------------------
> ------------------------
             |               Robust
       out_1 | Coefficient  std. err.      t    P>|t| 
>     [95% con                                        
>             f. interval]
-------------+----------------------------------------
> ------------------------
cat_sex#year |
     0 2016  |  -.0042477   .0006599    -6.44   0.000 
>    -.0055411                                        
>                -.0029542
     0 2017  |  -.0173665   .0006297   -27.58   0.000 
>    -.0186007                                        
>                -.0161323
     0 2018  |   -.005938    .000655    -9.07   0.000 
>    -.0072218                                        
>                -.0046542
     0 2019  |  -.0157131    .000631   -24.90   0.000 
>    -.0169499                                        
>                -.0144764
     0 2020  |  -.0172763   .0006261   -27.59   0.000 
>    -.0185035                                        
>                -.0160492
     0 2021  |  -.0020566   .0006579    -3.13   0.002 
>     -.003346                                        
>                -.0007672
     0 2022  |   .0106315   .0006825    15.58   0.000 
>     .0092939                                        
>                 .0119692
     0 2023  |  -.0090805    .000647   -14.03   0.000 
>    -.0103487                                        
>                -.0078124
     1 2015  |  -.0015981   .0006576    -2.43   0.015 
>    -.0028869                                        
>                -.0003092
     1 2016  |  -.0076855   .0006466   -11.89   0.000 
>    -.0089528                                        
>                -.0064182
     1 2017  |  -.0136364   .0006341   -21.50   0.000 
>    -.0148793                                        
>                -.0123935
     1 2018  |  -.0169529   .0006236   -27.19   0.000 
>    -.0181751                                        
>                -.0157307
     1 2019  |   -.021578   .0006127   -35.22   0.000 
>    -.0227789                                        
>                -.0203772
     1 2020  |  -.0084356   .0006408   -13.16   0.000 
>    -.0096915                                        
>                -.0071797
     1 2021  |  -.0041172   .0006505    -6.33   0.000 
>    -.0053922                                        
>                -.0028422
     1 2022  |   .0059537   .0006723     8.86   0.000 
>      .004636                                        
>                 .0072715
     1 2023  |  -.0140174   .0006352   -22.07   0.000 
>    -.0152623                                        
>                -.0127724
------------------------------------------------------
> ------------------------

Absorbed degrees of freedom:
------------------------------------------------------
> -+
   Absorbed FE | Categories  - Redundant  = Num. Coefs
>  |
---------------+--------------------------------------
> -|
  state_fips_o |         1           0           1    
>                                                     
>  |
 county_fips_o |         1           1           0    
>                                                     
>  |
------------------------------------------------------
> -+
.: invalid syntax in at()
r(198);

end of do-file

r(198);

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       2015 |  2,284,532       10.93       10.93
       2016 |  2,293,631       10.98       21.91
       2017 |  2,315,657       11.08       32.99
       2018 |  2,339,567       11.20       44.19
       2019 |  2,381,167       11.40       55.59
       2020 |  1,900,150        9.09       64.68
       2021 |  2,395,057       11.46       76.15
       2022 |  2,470,858       11.83       87.97
       2023 |  2,513,240       12.03      100.00
------------+-----------------------------------
      Total | 20,893,859      100.00

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_000034
> .tmp"

. ** Local categorical variables
. local catvar "cat_sex cat_married cat_age cat_child 
> cat_educ cat_ftotinc"

. 
. ** Loop over out- and in-migration 
. forvalues i = 1/2 {
  2.         
.         if `i' == 1 local ytitle_txt "Out-migration 
> rate (%)"
  3.         if `i' == 2 local ytitle_txt "In-migratio
> n rate (%)"
  4. 
.         ** Loop over categories
.         foreach cat of local catvar {
  5.                 
.                 ** FEs 
.                 local othercats : list catvars - cat
  6.                 dis "`othercats'"
  7.                 dffd
  8.                 ** Run Regressions
.                 hdfe_catyear_plot out_`i' if sample_
> `i' == 1,                   ///
>                         cat(`cat') year(year)       
>                                                     
> ///
>                         absorb(state_fips_o county_f
> ips_o `othercats')          ///
>                         wvar(perwt) wtype(fw)       
>                                                     
> ///
>                         ytitle(`ytitle_txt')        
>                                                     
> ///
>                         saving("${results}fig_`cat'_
> `i'") replace 
  9.                 
.         } // END CAT LOOP
 10.         
. } // END SAMPLE LOOP 

command dffd is unrecognized
r(199);

end of do-file

r(199);

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_000035
> .tmp"

. ** Loop over out- and in-migration 
. forvalues i = 1/2 {
  2.         
.         if `i' == 1 local ytitle_txt "Out-migration 
> rate (%)"
  3.         if `i' == 2 local ytitle_txt "In-migratio
> n rate (%)"
  4. 
.         ** Loop over categories
.         foreach cat of local catvar {
  5.                 
.                 ** FEs 
.                 local othercats : list catvars - `ca
> t'
  6.                 dis "`othercats'"
  7.                 dffd
  8.                 ** Run Regressions
.                 hdfe_catyear_plot out_`i' if sample_
> `i' == 1,                   ///
>                         cat(`cat') year(year)       
>                                                     
> ///
>                         absorb(state_fips_o county_f
> ips_o `othercats')          ///
>                         wvar(perwt) wtype(fw)       
>                                                     
> ///
>                         ytitle(`ytitle_txt')        
>                                                     
> ///
>                         saving("${results}fig_`cat'_
> `i'") replace 
  9.                 
.         } // END CAT LOOP
 10.         
. } // END SAMPLE LOOP 

.         
. 
end of do-file

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_000036
> .tmp"

. 
. ** Local categorical variables
. local catvar "cat_sex cat_married cat_age cat_child 
> cat_educ cat_ftotinc"

. 
. ** Loop over out- and in-migration 
. forvalues i = 1/2 {
  2.         
.         if `i' == 1 local ytitle_txt "Out-migration 
> rate (%)"
  3.         if `i' == 2 local ytitle_txt "In-migratio
> n rate (%)"
  4. 
.         ** Loop over categories
.         foreach cat of local catvar {
  5.                 
.                 ** FEs 
.                 local othercats : list catvars - `ca
> t'
  6.                 dis "`othercats'"
  7.                 dffd
  8.                 
.                 ** Run Regressions
.                 hdfe_catyear_plot out_`i' if sample_
> `i' == 1,                   ///
>                         cat(`cat') year(year)       
>                                                     
> ///
>                         absorb(state_fips_o county_f
> ips_o `othercats')          ///
>                         wvar(perwt) wtype(fw)       
>                                                     
> ///
>                         ytitle(`ytitle_txt')        
>                                                     
> ///
>                         saving("${results}fig_`cat'_
> `i'") replace 
  9.                 
.         } // END CAT LOOP
 10.         
. } // END SAMPLE LOOP 

command dffd is unrecognized
r(199);

end of do-file

r(199);

. local list

. help local

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_000037
> .tmp"

. 
. ** Local categorical variables
. local catvar "cat_sex cat_married cat_age cat_child 
> cat_educ cat_ftotinc"

. 
. ** Loop over out- and in-migration 
. forvalues i = 1/2 {
  2.         
.         if `i' == 1 local ytitle_txt "Out-migration 
> rate (%)"
  3.         if `i' == 2 local ytitle_txt "In-migratio
> n rate (%)"
  4. 
.         ** Loop over categories
.         foreach cat of local catvar {
  5.                 
.                 ** FEs 
.                 local othercats : catvars - `cat'
  6.                 dis "`othercats'"
  7.                 dffd
  8.                 
.                 ** Run Regressions
.                 hdfe_catyear_plot out_`i' if sample_
> `i' == 1,                   ///
>                         cat(`cat') year(year)       
>                                                     
> ///
>                         absorb(state_fips_o county_f
> ips_o `othercats')          ///
>                         wvar(perwt) wtype(fw)       
>                                                     
> ///
>                         ytitle(`ytitle_txt')        
>                                                     
> ///
>                         saving("${results}fig_`cat'_
> `i'") replace 
  9.                 
.         } // END CAT LOOP
 10.         
. } // END SAMPLE LOOP 
catvars not allowed
r(101);

end of do-file

r(101);

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_000038
> .tmp"

. ** Local categorical variables
. local catvar "cat_sex cat_married cat_age cat_child 
> cat_educ cat_ftotinc"

. 
. ** Loop over out- and in-migration 
. forvalues i = 1/2 {
  2.         
.         if `i' == 1 local ytitle_txt "Out-migration 
> rate (%)"
  3.         if `i' == 2 local ytitle_txt "In-migratio
> n rate (%)"
  4. 
.         ** Loop over categories
.         foreach cat of local catvar {
  5.                 
.                 ** FEs 
.                 local othercats : `catvars' - `cat'
  6.                 dis "`othercats'"
  7.                 dffd
  8.                 
.                 ** Run Regressions
.                 hdfe_catyear_plot out_`i' if sample_
> `i' == 1,                   ///
>                         cat(`cat') year(year)       
>                                                     
> ///
>                         absorb(state_fips_o county_f
> ips_o `othercats')          ///
>                         wvar(perwt) wtype(fw)       
>                                                     
> ///
>                         ytitle(`ytitle_txt')        
>                                                     
> ///
>                         saving("${results}fig_`cat'_
> `i'") replace 
  9.                 
.         } // END CAT LOOP
 10.         
. } // END SAMPLE LOOP 
- not allowed
r(101);

end of do-file

r(101);

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_000039
> .tmp"

. 
. ** Local categorical variables
. local catvar "cat_sex cat_married cat_age cat_child 
> cat_educ cat_ftotinc"

. 
. ** Loop over out- and in-migration 
. forvalues i = 1/2 {
  2.         
.         if `i' == 1 local ytitle_txt "Out-migration 
> rate (%)"
  3.         if `i' == 2 local ytitle_txt "In-migratio
> n rate (%)"
  4. 
.         ** Loop over categories
.         foreach cat of local catvar {
  5.                 
.                 ** FEs 
.                 local othercats = subinstr("`catvars
> '",  "`cat'", "", .)
  6.                 dis "`othercats'"
  7.                 dffd
  8.                 
.                 ** Run Regressions
.                 hdfe_catyear_plot out_`i' if sample_
> `i' == 1,                   ///
>                         cat(`cat') year(year)       
>                                                     
> ///
>                         absorb(state_fips_o county_f
> ips_o `othercats')          ///
>                         wvar(perwt) wtype(fw)       
>                                                     
> ///
>                         ytitle(`ytitle_txt')        
>                                                     
> ///
>                         saving("${results}fig_`cat'_
> `i'") replace 
  9.                 
.         } // END CAT LOOP
 10.         
. } // END SAMPLE LOOP 

command dffd is unrecognized
r(199);

end of do-file

r(199);

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_00003a
> .tmp"

. ** Local categorical variables
. local catvars "cat_sex cat_married cat_age cat_child
>  cat_educ cat_ftotinc"

. 
. ** Loop over out- and in-migration 
. forvalues i = 1/2 {
  2.         
.         if `i' == 1 local ytitle_txt "Out-migration 
> rate (%)"
  3.         if `i' == 2 local ytitle_txt "In-migratio
> n rate (%)"
  4. 
.         ** Loop over categories
.         foreach cat of local catvar {
  5.                 
.                 ** FEs 
.                 local othercats = subinstr("`catvars
> '",  "`cat'", "", .)
  6.                 dis "`othercats'"
  7.                 dffd
  8.                 
.                 ** Run Regressions
.                 hdfe_catyear_plot out_`i' if sample_
> `i' == 1,                   ///
>                         cat(`cat') year(year)       
>                                                     
> ///
>                         absorb(state_fips_o county_f
> ips_o `othercats')          ///
>                         wvar(perwt) wtype(fw)       
>                                                     
> ///
>                         ytitle(`ytitle_txt')        
>                                                     
> ///
>                         saving("${results}fig_`cat'_
> `i'") replace 
  9.                 
.         } // END CAT LOOP
 10.         
. } // END SAMPLE LOOP 

. 
end of do-file

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_00003b
> .tmp"

. 
. ** Local categorical variables
. local catvars "cat_sex cat_married cat_age cat_child
>  cat_educ cat_ftotinc"

. 
. ** Loop over out- and in-migration 
. forvalues i = 1/2 {
  2.         
.         if `i' == 1 local ytitle_txt "Out-migration 
> rate (%)"
  3.         if `i' == 2 local ytitle_txt "In-migratio
> n rate (%)"
  4. 
.         ** Loop over categories
.         foreach cat of local catvar {
  5.                 
.                 ** FEs 
.                 local othercats = subinstr("`catvars
> '",  "`cat'", "", .)
  6.                 dis "`othercats'"
  7.                 dffd
  8.                 
.                 ** Run Regressions
.                 hdfe_catyear_plot out_`i' if sample_
> `i' == 1,                   ///
>                         cat(`cat') year(year)       
>                                                     
> ///
>                         absorb(state_fips_o county_f
> ips_o `othercats')          ///
>                         wvar(perwt) wtype(fw)       
>                                                     
> ///
>                         ytitle(`ytitle_txt')        
>                                                     
> ///
>                         saving("${results}fig_`cat'_
> `i'") replace 
  9.                 
.         } // END CAT LOOP
 10.         
. } // END SAMPLE LOOP 

.         
. 
end of do-file

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_00003c
> .tmp"

. 
. ** Local categorical variables
. local catvars "cat_sex cat_married cat_age cat_child
>  cat_educ cat_ftotinc"

. 
. ** Loop over out- and in-migration 
. forvalues i = 1/2 {
  2.         
.         if `i' == 1 local ytitle_txt "Out-migration 
> rate (%)"
  3.         if `i' == 2 local ytitle_txt "In-migratio
> n rate (%)"
  4. 
.         ** Loop over categories
.         foreach cat of local catvars {
  5.                 
.                 ** FEs 
.                 local othercats = subinstr("`catvars
> '",  "`cat'", "", .)
  6.                 dis "`othercats'"
  7.                 dffd
  8.                 
.                 ** Run Regressions
.                 hdfe_catyear_plot out_`i' if sample_
> `i' == 1,                   ///
>                         cat(`cat') year(year)       
>                                                     
> ///
>                         absorb(state_fips_o county_f
> ips_o `othercats')          ///
>                         wvar(perwt) wtype(fw)       
>                                                     
> ///
>                         ytitle(`ytitle_txt')        
>                                                     
> ///
>                         saving("${results}fig_`cat'_
> `i'") replace 
  9.                 
.         } // END CAT LOOP
 10.         
. } // END SAMPLE LOOP 
 cat_married cat_age cat_child cat_educ cat_ftotinc
command dffd is unrecognized
r(199);

end of do-file

r(199);

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_00003d
> .tmp"

. ** Local categorical variables
. local catvars "cat_sex cat_married cat_age cat_child
>  cat_educ cat_ftotinc"

. 
. ** Loop over out- and in-migration 
. forvalues i = 1/2 {
  2.         
.         if `i' == 1 local ytitle_txt "Out-migration 
> rate (%)"
  3.         if `i' == 2 local ytitle_txt "In-migratio
> n rate (%)"
  4. 
.         ** Loop over categories
.         foreach cat of local catvars {
  5.                 
.                 ** FEs 
.                 local othercats = subinstr("`catvars
> '",  "`cat'", "", .)
  6.                 
.                 ** Run Regressions
.                 hdfe_catyear_plot out_`i' if sample_
> `i' == 1,                   ///
>                         cat(`cat') year(year)       
>                                                     
> ///
>                         absorb(state_fips_o county_f
> ips_o `othercats')          ///
>                         wvar(perwt) wtype(fw)       
>                                                     
> ///
>                         ytitle(`ytitle_txt')        
>                                                     
> ///
>                         saving("${results}fig_`cat'_
> `i'") replace 
  7.                 
.         } // END CAT LOOP
  8.         
. } // END SAMPLE LOOP 
(MWFE estimator converged in 7 iterations)

HDFE Linear regression                            Numb
> er of obs                                           
>             =  5,546,937
Absorbing 7 HDFE groups                           F(  
> 17,5546901)                                         
>             =     389.82
                                                  Prob
>  > F                                                
>             =     0.0000
                                                  R-sq
> uared                                               
>             =     0.0200
                                                  Adj 
> R-squared                                           
>             =     0.0200
                                                  With
> in R-sq.                                            
>             =     0.0012
                                                  Root
>  MSE                                                
>             =     0.2408

------------------------------------------------------
> ------------------------
             |               Robust
       out_1 | Coefficient  std. err.      t    P>|t| 
>     [95% con                                        
>             f. interval]
-------------+----------------------------------------
> ------------------------
cat_sex#year |
     0 2016  |  -.0035815   .0006551    -5.47   0.000 
>    -.0048654                                        
>                -.0022975
     0 2017  |  -.0171841   .0006244   -27.52   0.000 
>     -.018408                                        
>                -.0159603
     0 2018  |  -.0052804   .0006493    -8.13   0.000 
>     -.006553                                        
>                -.0040077
     0 2019  |  -.0155849   .0006253   -24.92   0.000 
>    -.0168105                                        
>                -.0143594
     0 2020  |  -.0175746    .000622   -28.26   0.000 
>    -.0187937                                        
>                -.0163556
     0 2021  |  -.0017244   .0006522    -2.64   0.008 
>    -.0030027                                        
>                 -.000446
     0 2022  |   .0106732   .0006762    15.78   0.000 
>     .0093478                                        
>                 .0119985
     0 2023  |  -.0093503   .0006418   -14.57   0.000 
>    -.0106082                                        
>                -.0080925
     1 2015  |   -.001292   .0006508    -1.99   0.047 
>    -.0025676                                        
>                -.0000164
     1 2016  |  -.0074902   .0006427   -11.65   0.000 
>    -.0087499                                        
>                -.0062306
     1 2017  |  -.0131904   .0006309   -20.91   0.000 
>    -.0144269                                        
>                -.0119539
     1 2018  |  -.0158032   .0006189   -25.53   0.000 
>    -.0170163                                        
>                -.0145901
     1 2019  |  -.0218172   .0006068   -35.96   0.000 
>    -.0230064                                        
>                 -.020628
     1 2020  |    -.00892   .0006354   -14.04   0.000 
>    -.0101653                                        
>                -.0076747
     1 2021  |  -.0043521   .0006449    -6.75   0.000 
>    -.0056162                                        
>                -.0030881
     1 2022  |   .0052999   .0006668     7.95   0.000 
>     .0039929                                        
>                 .0066069
     1 2023  |  -.0144994   .0006305   -23.00   0.000 
>    -.0157352                                        
>                -.0132636
------------------------------------------------------
> ------------------------

Absorbed degrees of freedom:
------------------------------------------------------
> -+
   Absorbed FE | Categories  - Redundant  = Num. Coefs
>  |
---------------+--------------------------------------
> -|
  state_fips_o |         1           0           1    
>                                                     
>  |
 county_fips_o |         1           1           0    
>                                                     
>  |
   cat_married |         4           1           3    
> ?                                                   
>  |
       cat_age |         4           1           3    
> ?                                                   
>  |
     cat_child |         4           1           3    
> ?                                                   
>  |
      cat_educ |         4           1           3    
> ?                                                   
>  |
   cat_ftotinc |         7           1           6    
> ?                                                   
>  |
------------------------------------------------------
> -+
? = number of redundant parameters may be higher
.: invalid syntax in at()
r(198);

end of do-file

r(198);

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_00003e
> .tmp"

. /***************************************************
> ****************************
> File Name:              02_indiv_analysis.do
> Creator:                John Iselin
> Date Update:    November 29, 2025
> 
> Called by: 00_multnomah.do
> 
> Purpose: Preform individual-level migration analysis
> . 
> 
> Authors: John Iselin 
> 
> For more information, contact john.iselin@yale.edu
> 
> ****************************************************
> ***************************/
. 
. ** Start log file 
. capture log close log_02

. log using "${logs}02_log_individual_${date}", replac
> e text name(log_02)
------------------------------------------------------
      name:  log_02
       log:  C:/Users/ji252/Documents/GitHub/multnomah
> -county-tax/code/logs/02_log_individual_2025-12-15.l
> og
  log type:  text
 opened on:  16 Dec 2025, 09:29:00

. capture program drop hdfe_catyear_plot

. program define hdfe_catyear_plot
  1.     version 16.0
  2.     syntax varname(numeric) [if] [in] [fw aw pw i
> w] , ///
>         CAT(varname) YEAR(varname) ABSORB(string) //
> /
>         [ SAMPLE(varname) SVAL(real 1) ///
>           WVAR(varname) WTYPE(string) ///
>           VCE(string) ///
>           TITLE(string asis) XTITLE(string asis) YTI
> TLE(string asis) ///
>           NOCI ///
>           SAVING(string asis) REPLACE ]
  3. 
.     // Requirements
.     capture which reghdfe
  4.     if _rc {
  5.         di as error "reghdfe not found. Install w
> ith: ssc install reghdfe, replace"
  6.         exit 198
  7.     }
  8.     capture which coefplot
  9.     if _rc {
 10.         di as error "coefplot not found. Install 
> with: ssc install coefplot, replace"
 11.         exit 198
 12.     }
 13. 
.     // Mark sample
.     marksample touse, strok
 14.     quietly replace `touse' = `touse' & !missing(
> `varlist', `cat', `year')
 15.     if "`sample'" != "" quietly replace `touse' =
>  `touse' & (`sample' == `sval')
 16. 
.     // Weights (default fw=perwt unless user passed 
> weights)
.     local wgt ""
 17.     if "`weight'" != "" {
 18.         local wgt "[`weight'=`exp']"
 19.     }
 20.     else {
 21.         if "`wvar'" == "" local wvar "perwt"
 22.         if "`wtype'" == "" local wtype "fw"
 23.         capture confirm variable `wvar'
 24.         if _rc {
 25.             di as error "Default weight variable 
> `wvar' not found. Either create it or pass weights e
> xplicitly."
 26.             exit 111
 27.         }
 28.         local wgt "[`wtype'=`wvar']"
 29.     }
 30. 
.     // Ensure cat/year numeric for factor vars
.     tempvar __cat __year
 31.     local cattype : type `cat'
 32.     if substr("`cattype'",1,3) == "str" {
 33.         quietly encode `cat' if `touse', gen(`__c
> at')
 34.         local catv `__cat'
 35.     }
 36.     else local catv `cat'
 37. 
.     local yeartype : type `year'
 38.     if substr("`yeartype'",1,3) == "str" {
 39.         quietly destring `year' if `touse', gen(`
> __year') force
 40.         capture assert !missing(`__year') if `tou
> se'
 41.         if _rc {
 42.             di as error "Year variable is string 
> and could not be cleanly converted to numeric."
 43.             exit 459
 44.         }
 45.         local yearv `__year'
 46.     }
 47.     else local yearv `year'
 48. 
.     // Guard: category variable should not also be a
> bsorbed
.     // (Your loop hits this when cat==cat_married an
> d absorb(... cat_married))
.     if regexm(" `absorb' ", " `catv' ") {
 49.         di as error "Category variable `catv' app
> ears in absorb(): `absorb'. Remove it from absorb() 
> for this run."
 50.         exit 198
 51.     }
 52. 
.     // Levels
.     quietly levelsof `yearv' if `touse', local(yrs)
 53.     quietly levelsof `catv'  if `touse', local(ca
> ts)
 54.     if "`yrs'" == "" | "`cats'" == "" {
 55.         di as error "No observations available af
> ter applying if/in/sample filters."
 56.         exit 2000
 57.     }
 58. 
.     // X-axis positions and labels (positions are 1.
> .K in year order)
.     local xlabel ""
 59.     local k = 0
 60.     foreach y of local yrs {
 61.         local ++k
 62.         local xlabel `xlabel' `k' "`y'"
 63.     }
 64. 
.     // Regression
.     quietly reghdfe `varlist' i.`catv'#i.`yearv' if 
> `touse' `wgt', ///
>         absorb(`absorb') vce(`=cond("`vce'"=="","rob
> ust","`vce'")') nocons
 65. 
.     // Existing coefficient names (for robust plotti
> ng)
.     local bnames : colnames e(b)
 66. 
.     // Build coefplot specs: one series per category
> ; include only existing coefs
.     local plotspecs ""
 67.     local vlab : value label `catv'
 68. 
.     foreach c of local cats {
 69. 
.         // series label
.         local serieslab "`cat'=`c'"
 70.         if "`vlab'" != "" {
 71.             local tmp : label `vlab' `c'
 72.             if "`tmp'" != "" local serieslab "`tm
> p'"
 73.         }
 74. 
.         local keepc  ""
 75.         local orderc ""
 76.         local atc    ""
 77. 
.         local k = 0
 78.         foreach y of local yrs {
 79.             local ++k
 80.             local coefname "`c'.`catv'#`y'.`yearv
> '"
 81. 
.             if strpos(" `bnames' ", " `coefname' ") 
> {
 82.                 local keepc  `keepc'  `coefname'
 83.                 local orderc `orderc' `coefname'
 84.                 local atc    `atc'    `k'
 85.             }
 86.         }
 87. 
.         // Skip this category level if nothing survi
> ved estimation
.         if "`keepc'" == "" continue
 88. 
.         local ciopt ""
 89.         if "`noci'" != "" local ciopt "noci"
 90. 
.         local plotspecs `plotspecs' ///
>             (., keep(`keepc') order(`orderc') at(`at
> c') label("`serieslab'") `ciopt')
 91.     }
 92. 
.     if "`plotspecs'" == "" {
 93.         di as error "No coefficients available to
>  plot (all catyear cells were dropped). Check empty
>  cells/collinearity."
 94.         exit 2001
 95.     }
 96. 
.     // Defaults with safe quoting
.     if "`xtitle'" == "" local xtitle `"`year'"'
 97.     if "`ytitle'" == "" local ytitle `"`varlist' 
> (adjusted mean)"'
 98.     if "`title'"  == "" local title  `"`varlist' 
> by `cat' over `year'"'
 99. 
.     coefplot `plotspecs', ///
>         vertical ///
>         xlabel(`xlabel', angle(45)) ///
>         xtitle(`xtitle') ///
>         ytitle(`ytitle') ///
>         title(`title') ///
>         legend(cols(1) position(6))
100. 
.     // Save graph (ensure .gph extension if user omi
> tted)
.     if "`saving'" != "" {
101.         local savepath `"`saving'"'
102.         if !regexm(`"`savepath'"', "\.gph$") loca
> l savepath `"`savepath'.gph"'
103.         graph save `"`savepath'"', `replace'
104.     }
105. end

. 
. 
. ** Load ACS Data 
. use "${data}working/acs_migration_file", replace 

. 
. ** Define sample 
. drop if qmigplc1 == 4                               
>     // FAILED EDIT OF MIGPLACE 
(388,364 observations deleted)

. drop if inlist(state_fips_o, 2, 15)     // ALASKA AN
> D HAWAII 
(136,571 observations deleted)

. 
. ** Define indicator for being in Multnomah County in
>  origin/destination year
. gen multnomah_o = state_fips_o == 41 & county_fips_o
>  == 51

. gen multnomah_d = state_fips_d == 41 & county_fips_d
>  == 51

. 
. ** Define samples 
. gen sample_1 = multnomah_o == 1                     
>             // Multnomah in origin-year 

. gen sample_2 = multnomah_o != 1                     
>             // Not in Multnomah

. label var sample_1 "Out-migration Sample"

. label var sample_1 "In-migration Sample"

. 
. ** Define moving indicator 
. gen out_1 = same_county == 0 

. label var out_1 "Moved out of Multnomah"

. gen out_2 = multnomah_d == 1 

. label var out_2 "Moved to Multnomah"

. 
. ** Define variables of interest
. 
. ** Age 
. recode age      (18/24 = 1 "18-24")     ///
>                         (25/44 = 2 "25-44")         
>     ///
>                         (45/64 = 3 "45-64")     ///
>                         (65/max = 4 "65+"),     ///
>         gen(cat_age)
(20,893,859 differences between age and cat_age)

. label var cat_age "Age categories"

. 
. ** Sex  
. gen cat_sex = sex == 2 

. label var cat_sex "Female indicator"

. label define lb_cat_sex 0 "Male" 1 "Female"

. label values cat_sex cat_sex 

. 
. ** Marital Status               
. recode marst    (1 = 1 "Married")                   
>             ///
>                                 (2/3 = 2 "Seperated"
> )                   ///
>                                 (4/5 = 3 "Divourced 
> / Widowed") ///
>                                 (6 = 4 "Single"),   
>                             ///
>         gen(cat_married)
(9,061,905 differences between marst and cat_married)

. label var cat_married "Marriage categories"

. 
. ** Kids at home 
. recode nchild   (0 = 0 "0 Children")                
>                     ///
>                                 (1 = 1 "1 Child")   
>                                             ///
>                                 (2 = 2 "2 Children")
>                                     ///
>                                 (3/max = 3 "3+ Child
> ren"),                              ///
>         gen(cat_child)
(412,920 differences between nchild and cat_child)

. label var cat_child "Number of Children"

. 
. ** Education 
. recode educd    (min/61 = 1 "Less than HS")     ///
>                                 (62/71 = 2 "HS Diplo
> ma")                ///
>                                 (80/100 = 3 "Some Co
> llege")     ///
>                                 (101/max = 4 "Colleg
> e Degree"), ///
>         gen(cat_educ)
(20,893,859 differences between educd and cat_educ)

. label var cat_educ "Education categories"

. 
. ** Earnings / Income 
. gen tmp1 = cpi99 if year == 2023
(18,380,619 missing values generated)

. egen tmp2 = mean(tmp1)

. gen cpi =  cpi99 / tmp2 

. drop tmp1 tmp2 

. 
. ** Loop over income variables 
. foreach var of varlist inctot incwage incearn ftotin
> c {
  2.         
.         ** Update CPI 
.         gen real_`var' = round(`var' * cpi) 
  3.         
.         ** Categorical variables 
.         recode real_`var'       (min/-1 = 1 "Negativ
> e income")          ///
>                                                 (0 =
>  2 "$0")                                            
> ///
>                                                 (1/2
> 4999 = 3 "$1-$25K")                         ///
>                                                 (250
> 00/49999 = 4 "$25K-$50K")           ///
>                                                 (500
> 00/99999 = 5 "$50K-$100K")          ///
>                                                 (100
> 000/199999 = 6 "$100K-$200K")       ///
>                                                 (200
> 000/max = 7 "$200K+") ,             ///
>                         gen(cat_`var')
  4.                         
.         ** Tab
.         tab cat_`var', m 
  5.         
. }
(20,893,859 differences between real_inctot and cat_in
> ctot)

      RECODE of |
    real_inctot |      Freq.     Percent        Cum.
----------------+-----------------------------------
Negative income |     20,759        0.10        0.10
             $0 |  1,748,089        8.37        8.47
        $1-$25K |  6,204,378       29.69       38.16
      $25K-$50K |  4,981,113       23.84       62.00
     $50K-$100K |  4,947,578       23.68       85.68
    $100K-$200K |  2,211,136       10.58       96.26
         $200K+ |    780,806        3.74      100.00
----------------+-----------------------------------
          Total | 20,893,859      100.00
(20,893,859 differences between real_incwage and cat_i
> ncwage)

      RECODE of |
   real_incwage |      Freq.     Percent        Cum.
----------------+-----------------------------------
             $0 |  8,182,418       39.16       39.16
        $1-$25K |  3,428,895       16.41       55.57
      $25K-$50K |  3,290,630       15.75       71.32
     $50K-$100K |  3,729,590       17.85       89.17
    $100K-$200K |  1,743,819        8.35       97.52
         $200K+ |    518,507        2.48      100.00
----------------+-----------------------------------
          Total | 20,893,859      100.00
(20,893,859 differences between real_incearn and cat_i
> ncearn)

      RECODE of |
   real_incearn |      Freq.     Percent        Cum.
----------------+-----------------------------------
Negative income |     16,135        0.08        0.08
             $0 |  7,365,326       35.25       35.33
        $1-$25K |  3,756,344       17.98       53.31
      $25K-$50K |  3,476,928       16.64       69.95
     $50K-$100K |  3,876,560       18.55       88.50
    $100K-$200K |  1,823,201        8.73       97.23
         $200K+ |    579,365        2.77      100.00
----------------+-----------------------------------
          Total | 20,893,859      100.00
(20,893,767 differences between real_ftotinc and cat_f
> totinc)

      RECODE of |
   real_ftotinc |      Freq.     Percent        Cum.
----------------+-----------------------------------
Negative income |      7,238        0.03        0.03
             $0 |    226,387        1.08        1.12
        $1-$25K |  2,249,309       10.77       11.88
      $25K-$50K |  3,258,513       15.60       27.48
     $50K-$100K |  5,975,505       28.60       56.08
    $100K-$200K |  6,147,777       29.42       85.50
         $200K+ |  3,029,130       14.50      100.00
----------------+-----------------------------------
          Total | 20,893,859      100.00

. 
. ** Label variable 
. label var cat_inctot "Total personal income categori
> es (real 2023 USD)"

. label var cat_incwage "Total wage income categories 
> (real 2023 USD)"

. label var cat_incearn "Total earned income categorie
> s (real 2023 USD)"

. label var cat_ftotinc "Total family income categorie
> s (real 2023 USD)"

. 
. ** Local categorical variables
. local catvars "cat_sex cat_married cat_age cat_child
>  cat_educ cat_ftotinc"

. 
. ** Loop over out- and in-migration 
. forvalues i = 1/2 {
  2.         
.         if `i' == 1 local ytitle_txt "Out-migration 
> rate (%)"
  3.         if `i' == 2 local ytitle_txt "In-migratio
> n rate (%)"
  4. 
.         ** Loop over categories
.         foreach cat of local catvars {
  5.                 
.                 ** FEs 
.                 local othercats = subinstr("`catvars
> '",  "`cat'", "", .)
  6.                 
.                 ** Run Regressions
.                 hdfe_catyear_plot out_`i' if sample_
> `i' == 1,                   ///
>                         cat(`cat') year(year)       
>                                                     
> ///
>                         absorb(state_fips_o county_f
> ips_o `othercats')          ///
>                         wvar(perwt) wtype(fw)       
>                                                     
> ///
>                         ytitle(`ytitle_txt')        
>                                                     
> ///
>                         saving("${results}fig_`cat'_
> `i'") replace 
  7.                 
.         } // END CAT LOOP
  8.         
. } // END SAMPLE LOOP 
.: invalid syntax in at()
r(198);

end of do-file

r(198);

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_00003f
> .tmp"

. 
. ** Local categorical variables
. local catvars "cat_sex cat_married cat_age cat_child
>  cat_educ cat_ftotinc"

. 
. ** Loop over out- and in-migration 
. forvalues i = 1/2 {
  2.         
.         if `i' == 1 local ytitle_txt "Out-migration 
> rate (%)"
  3.         if `i' == 2 local ytitle_txt "In-migratio
> n rate (%)"
  4. 
.         ** Loop over categories
.         foreach cat of local catvars {
  5.                 
.                 ** FEs 
.                 local othercats : list catvars - cat
>             
  6.                 
.                 ** Run Regressions
.                 hdfe_catyear_plot out_`i' if sample_
> `i' == 1,                   ///
>                         cat(`cat') year(year)       
>                                                     
> ///
>                         absorb(state_fips_o county_f
> ips_o `othercats')          ///
>                         wvar(perwt) wtype(fw)       
>                                                     
> ///
>                         ytitle(`ytitle_txt')        
>                                                     
> ///
>                         saving("${results}fig_`cat'_
> `i'") replace 
  7.                 
.         } // END CAT LOOP
  8.         
. } // END SAMPLE LOOP 
.: invalid syntax in at()
r(198);

end of do-file

r(198);

. do "C:\Users\ji252\Documents\GitHub\multnomah-county
> -tax\code\02_indiv_analysis.do"

. /***************************************************
> ****************************
> File Name:              02_indiv_analysis.do
> Creator:                John Iselin
> Date Update:    November 29, 2025
> 
> Called by: 00_multnomah.do
> 
> Purpose: Preform individual-level migration analysis
> . 
> 
> Authors: John Iselin 
> 
> For more information, contact john.iselin@yale.edu
> 
> ****************************************************
> ***************************/
. 
. ** Start log file 
. capture log close log_02

. log using "${logs}02_log_individual_${date}", replac
> e text name(log_02)
------------------------------------------------------
      name:  log_02
       log:  C:/Users/ji252/Documents/GitHub/multnomah
> -county-tax/code/logs/02_log_individual_2025-12-15.l
> og
  log type:  text
 opened on:  16 Dec 2025, 09:41:48

. 
. 
. capture program drop hdfe_catyear_plot

. program define hdfe_catyear_plot
  1.     version 16.0
  2.     syntax varname(numeric) [if] [in] [fw aw pw i
> w] , ///
>         CAT(varname) YEAR(varname) ABSORB(string) //
> /
>         [ SAMPLE(varname) SVAL(real 1) ///
>           WVAR(varname) WTYPE(string) ///
>           VCE(string) ///
>           TITLE(string asis) XTITLE(string asis) YTI
> TLE(string asis) ///
>           NOCI ///
>           BASEYEAR(integer) ///
>           SAVING(string asis) REPLACE ]
  3. 
.     // Requirements
.     capture which reghdfe
  4.     if _rc {
  5.         di as error "reghdfe not found. Install w
> ith: ssc install reghdfe, replace"
  6.         exit 198
  7.     }
  8. 
.     // Mark sample
.     marksample touse, strok
  9.     quietly replace `touse' = `touse' & !missing(
> `varlist', `cat', `year')
 10.     if "`sample'" != "" quietly replace `touse' =
>  `touse' & (`sample' == `sval')
 11. 
.     // Weights (default fw=perwt unless user passed 
> weights)
.     local wgt ""
 12.     if "`weight'" != "" {
 13.         local wgt "[`weight'=`exp']"
 14.     }
 15.     else {
 16.         if "`wvar'" == "" local wvar "perwt"
 17.         if "`wtype'" == "" local wtype "fw"
 18.         capture confirm variable `wvar'
 19.         if _rc {
 20.             di as error "Default weight variable 
> `wvar' not found. Either create it or pass weights e
> xplicitly."
 21.             exit 111
 22.         }
 23.         local wgt "[`wtype'=`wvar']"
 24.     }
 25. 
.     // Ensure cat/year numeric for factor vars
.     tempvar __cat __year
 26.     local cattype : type `cat'
 27.     if substr("`cattype'",1,3) == "str" {
 28.         quietly encode `cat' if `touse', gen(`__c
> at')
 29.         local catv `__cat'
 30.     }
 31.     else local catv `cat'
 32. 
.     local yeartype : type `year'
 33.     if substr("`yeartype'",1,3) == "str" {
 34.         quietly destring `year' if `touse', gen(`
> __year') force
 35.         capture assert !missing(`__year') if `tou
> se'
 36.         if _rc {
 37.             di as error "Year variable is string 
> and could not be cleanly converted to numeric."
 38.             exit 459
 39.         }
 40.         local yearv `__year'
 41.     }
 42.     else local yearv `year'
 43. 
.     // Guard: category variable should not also be a
> bsorbed
.     if regexm(" `absorb' ", " `catv' ") {
 44.         di as error "Category variable `catv' app
> ears in absorb(): `absorb'. Remove it from absorb() 
> for this run."
 45.         exit 198
 46.     }
 47. 
.     // Levels (sorted)
.     quietly levelsof `yearv' if `touse', local(yrs)
 48.     quietly levelsof `catv'  if `touse', local(ca
> ts)
 49.     if "`yrs'" == "" | "`cats'" == "" {
 50.         di as error "No observations available af
> ter applying if/in/sample filters."
 51.         exit 2000
 52.     }
 53. 
.     // Regression: cell means for each catyear cond
> itional on absorbed FEs
.     quietly reghdfe `varlist' i.`catv'#i.`yearv' if 
> `touse' `wgt', ///
>         absorb(`absorb') vce(`=cond("`vce'"=="","rob
> ust","`vce'")') nocons
 54. 
.     // Pull coefficient names
.     local bnames : colnames e(b)
 55. 
.     // Critical value for CI (fallback to normal if 
> df_r missing)
.     tempname crit
 56.     capture scalar `crit' = invttail(e(df_r), 0.0
> 25)
 57.     if _rc scalar `crit' = invnormal(0.975)
 58. 
.     // Post to temp dataset
.     tempfile coefdata
 59.     tempname posth
 60.     postfile `posth' int cat_level int year doubl
> e b se ll ul using `coefdata', replace
 61. 
.     foreach bn of local bnames {
 62.         // Match: <c>.<catv>#<y>.<yearv>
.         // Example: 1.cat_sex#2021.year
.         if regexm("`bn'", "^([0-9]+)\.`catv'#([0-9]+
> )\.`yearv'$") {
 63.             local c = real(regexs(1))
 64.             local y = real(regexs(2))
 65. 
.             scalar __b  = _b[`bn']
 66.             scalar __se = _se[`bn']
 67.             scalar __ll = __b - `crit'*__se
 68.             scalar __ul = __b + `crit'*__se
 69. 
.             post `posth' (`c') (`y') (scalar(__b)) (
> scalar(__se)) (scalar(__ll)) (scalar(__ul))
 70.         }
 71.     }
 72.     postclose `posth'
 73. 
.     preserve
 74.         use `coefdata', clear
 75. 
.         // Attach original value label (for legend) 
> if it exists
.         local vlab : value label `catv'
 76.         if "`vlab'" != "" label values cat_level 
> `vlab'
 77. 
.         // Optional normalization to baseyear (withi
> n-category)
.         if "`baseyear'" != "" {
 78.             quietly count if year == `baseyear'
 79.             if r(N) == 0 {
 80.                 di as error "baseyear(`baseyear')
>  not found in the estimation sample."
 81.                 exit 459
 82.             }
 83. 
.             bysort cat_level: egen base_b = max(cond
> (year==`baseyear', b, .))
 84.             replace b  = b  - base_b
 85.             replace ll = ll - base_b
 86.             replace ul = ul - base_b
 87.             drop base_b
 88.         }
 89. 
.         // Build twoway spec: one connected line (+ 
> CI) per category
.         local plots ""
 90.         local legorder ""
 91.         local j = 0
 92.         foreach c of local cats {
 93.             quietly count if cat_level == `c'
 94.             if r(N) == 0 continue
 95.             local ++j
 96.             if "`noci'" == "" {
 97.                 local plots `plots' (rcap ll ul y
> ear if cat_level==`c', sort)
 98.             }
 99.             local plots `plots' (connected b year
>  if cat_level==`c', sort)
100.             local legorder `legorder' `j'
101.         }
102. 
.         if "`xtitle'" == "" local xtitle `"`year'"'
103.         if "`ytitle'" == "" {
104.             if "`baseyear'" != "" local ytitle `"
> `varlist' (relative to `baseyear')"'
105.             else                 local ytitle `"`
> varlist' (adjusted mean)"'
106.         }
107.         if "`title'"  == "" local title  `"`varli
> st' by `cat' over `year'"'
108. 
.         twoway `plots', ///
>             xtitle(`xtitle') ytitle(`ytitle') title(
> `title') ///
>             xlabel(`yrs', angle(45)) ///
>             legend(position(6) cols(1))
109. 
.         if "`saving'" != "" {
110.             local savepath `"`saving'"'
111.             if !regexm(`"`savepath'"', "\.gph$") 
> local savepath `"`savepath'.gph"'
112.             graph save `"`savepath'"', `replace'
113.         }
114.     restore
115. end

. 
. 
. ** Load ACS Data 
. use "${data}working/acs_migration_file", replace 

. 
. ** Define sample 
. drop if qmigplc1 == 4                               
>     // FAILED EDIT OF MIGPLACE 
(388,364 observations deleted)

. drop if inlist(state_fips_o, 2, 15)     // ALASKA AN
> D HAWAII 
(136,571 observations deleted)

. 
. ** Define indicator for being in Multnomah County in
>  origin/destination year
. gen multnomah_o = state_fips_o == 41 & county_fips_o
>  == 51

. gen multnomah_d = state_fips_d == 41 & county_fips_d
>  == 51

. 
. ** Define samples 
. gen sample_1 = multnomah_o == 1                     
>             // Multnomah in origin-year 

. gen sample_2 = multnomah_o != 1                     
>             // Not in Multnomah

. label var sample_1 "Out-migration Sample"

. label var sample_1 "In-migration Sample"

. 
. ** Define moving indicator 
. gen out_1 = same_county == 0 

. label var out_1 "Moved out of Multnomah"

. gen out_2 = multnomah_d == 1 

. label var out_2 "Moved to Multnomah"

. 
. ** Define variables of interest
. 
. ** Age 
. recode age      (18/24 = 1 "18-24")     ///
>                         (25/44 = 2 "25-44")         
>     ///
>                         (45/64 = 3 "45-64")     ///
>                         (65/max = 4 "65+"),     ///
>         gen(cat_age)
(20,893,859 differences between age and cat_age)

. label var cat_age "Age categories"

. 
. ** Sex  
. gen cat_sex = sex == 2 

. label var cat_sex "Female indicator"

. label define lb_cat_sex 0 "Male" 1 "Female"

. label values cat_sex cat_sex 

. 
. ** Marital Status               
. recode marst    (1 = 1 "Married")                   
>             ///
>                                 (2/3 = 2 "Seperated"
> )                   ///
>                                 (4/5 = 3 "Divourced 
> / Widowed") ///
>                                 (6 = 4 "Single"),   
>                             ///
>         gen(cat_married)
(9,061,905 differences between marst and cat_married)

. label var cat_married "Marriage categories"

. 
. ** Kids at home 
. recode nchild   (0 = 0 "0 Children")                
>                     ///
>                                 (1 = 1 "1 Child")   
>                                             ///
>                                 (2 = 2 "2 Children")
>                                     ///
>                                 (3/max = 3 "3+ Child
> ren"),                              ///
>         gen(cat_child)
(412,920 differences between nchild and cat_child)

. label var cat_child "Number of Children"

. 
. ** Education 
. recode educd    (min/61 = 1 "Less than HS")     ///
>                                 (62/71 = 2 "HS Diplo
> ma")                ///
>                                 (80/100 = 3 "Some Co
> llege")     ///
>                                 (101/max = 4 "Colleg
> e Degree"), ///
>         gen(cat_educ)
(20,893,859 differences between educd and cat_educ)

. label var cat_educ "Education categories"

. 
. ** Earnings / Income 
. gen tmp1 = cpi99 if year == 2023
(18,380,619 missing values generated)

. egen tmp2 = mean(tmp1)

. gen cpi =  cpi99 / tmp2 

. drop tmp1 tmp2 

. 
. ** Loop over income variables 
. foreach var of varlist inctot incwage incearn ftotin
> c {
  2.         
.         ** Update CPI 
.         gen real_`var' = round(`var' * cpi) 
  3.         
.         ** Categorical variables 
.         recode real_`var'       (min/-1 = 1 "Negativ
> e income")          ///
>                                                 (0 =
>  2 "$0")                                            
> ///
>                                                 (1/2
> 4999 = 3 "$1-$25K")                         ///
>                                                 (250
> 00/49999 = 4 "$25K-$50K")           ///
>                                                 (500
> 00/99999 = 5 "$50K-$100K")          ///
>                                                 (100
> 000/199999 = 6 "$100K-$200K")       ///
>                                                 (200
> 000/max = 7 "$200K+") ,             ///
>                         gen(cat_`var')
  4.                         
.         ** Tab
.         tab cat_`var', m 
  5.         
. }
(20,893,859 differences between real_inctot and cat_in
> ctot)

      RECODE of |
    real_inctot |      Freq.     Percent        Cum.
----------------+-----------------------------------
Negative income |     20,759        0.10        0.10
             $0 |  1,748,089        8.37        8.47
        $1-$25K |  6,204,378       29.69       38.16
      $25K-$50K |  4,981,113       23.84       62.00
     $50K-$100K |  4,947,578       23.68       85.68
    $100K-$200K |  2,211,136       10.58       96.26
         $200K+ |    780,806        3.74      100.00
----------------+-----------------------------------
          Total | 20,893,859      100.00
(20,893,859 differences between real_incwage and cat_i
> ncwage)

      RECODE of |
   real_incwage |      Freq.     Percent        Cum.
----------------+-----------------------------------
             $0 |  8,182,418       39.16       39.16
        $1-$25K |  3,428,895       16.41       55.57
      $25K-$50K |  3,290,630       15.75       71.32
     $50K-$100K |  3,729,590       17.85       89.17
    $100K-$200K |  1,743,819        8.35       97.52
         $200K+ |    518,507        2.48      100.00
----------------+-----------------------------------
          Total | 20,893,859      100.00
(20,893,859 differences between real_incearn and cat_i
> ncearn)

      RECODE of |
   real_incearn |      Freq.     Percent        Cum.
----------------+-----------------------------------
Negative income |     16,135        0.08        0.08
             $0 |  7,365,326       35.25       35.33
        $1-$25K |  3,756,344       17.98       53.31
      $25K-$50K |  3,476,928       16.64       69.95
     $50K-$100K |  3,876,560       18.55       88.50
    $100K-$200K |  1,823,201        8.73       97.23
         $200K+ |    579,365        2.77      100.00
----------------+-----------------------------------
          Total | 20,893,859      100.00
(20,893,767 differences between real_ftotinc and cat_f
> totinc)

      RECODE of |
   real_ftotinc |      Freq.     Percent        Cum.
----------------+-----------------------------------
Negative income |      7,238        0.03        0.03
             $0 |    226,387        1.08        1.12
        $1-$25K |  2,249,309       10.77       11.88
      $25K-$50K |  3,258,513       15.60       27.48
     $50K-$100K |  5,975,505       28.60       56.08
    $100K-$200K |  6,147,777       29.42       85.50
         $200K+ |  3,029,130       14.50      100.00
----------------+-----------------------------------
          Total | 20,893,859      100.00

. 
. ** Label variable 
. label var cat_inctot "Total personal income categori
> es (real 2023 USD)"

. label var cat_incwage "Total wage income categories 
> (real 2023 USD)"

. label var cat_incearn "Total earned income categorie
> s (real 2023 USD)"

. label var cat_ftotinc "Total family income categorie
> s (real 2023 USD)"

. 
. ** Local categorical variables
. local catvars "cat_sex cat_married cat_age cat_child
>  cat_educ cat_ftotinc"

. 
. ** Loop over out- and in-migration 
. forvalues i = 1/2 {
  2.         
.         if `i' == 1 local ytitle_txt "Out-migration 
> rate (%)"
  3.         if `i' == 2 local ytitle_txt "In-migratio
> n rate (%)"
  4. 
.         ** Loop over categories
.         foreach cat of local catvars {
  5.                 
.                 ** FEs 
.                 local othercats : list catvars - cat
>             
  6.                 
.                 ** Run Regressions
.                 hdfe_catyear_plot out_`i' if sample_
> `i' == 1,                   ///
>                         cat(`cat') year(year)       
>                                                     
> ///
>                         absorb(state_fips_o county_f
> ips_o `othercats')          ///
>                         wvar(perwt) wtype(fw)       
>                                                     
> ///
>                         ytitle(`ytitle_txt')        
>                                                     
> ///
>                         saving("${results}fig_`cat'_
> `i'") replace 
  7.                 
.         } // END CAT LOOP
  8.         
. } // END SAMPLE LOOP 
invalid syntax
r(197);

end of do-file

r(197);

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_00003g
> .tmp"

. /***************************************************
> ****************************
> File Name:              02_indiv_analysis.do
> Creator:                John Iselin
> Date Update:    November 29, 2025
> 
> Called by: 00_multnomah.do
> 
> Purpose: Preform individual-level migration analysis
> . 
> 
> Authors: John Iselin 
> 
> For more information, contact john.iselin@yale.edu
> 
> ****************************************************
> ***************************/
. 
. ** Start log file 
. capture log close log_02

. log using "${logs}02_log_individual_${date}", replac
> e text name(log_02)
------------------------------------------------------
      name:  log_02
       log:  C:/Users/ji252/Documents/GitHub/multnomah
> -county-tax/code/logs/02_log_individual_2025-12-15.l
> og
  log type:  text
 opened on:  16 Dec 2025, 09:54:22

. 
. 
. capture program drop hdfe_catyear_plot

. program define hdfe_catyear_plot
  1.     version 16.0
  2.     syntax varname(numeric) [if] [in] [fw aw pw i
> w] , ///
>         CAT(varname) YEAR(varname) ABSORB(string) //
> /
>         [ SAMPLE(varname) SVAL(real 1) ///
>           WVAR(varname) WTYPE(string) ///
>           VCE(string) ///
>           TITLE(string asis) XTITLE(string asis) YTI
> TLE(string asis) ///
>           NOCI ///
>           BASEYEAR(integer) ///
>           SAVING(string asis) REPLACE ]
  3. 
.     // Requirements
.     capture which reghdfe
  4.     if _rc {
  5.         di as error "reghdfe not found. Install w
> ith: ssc install reghdfe, replace"
  6.         exit 198
  7.     }
  8. 
.     // Mark sample
.     marksample touse, strok
  9.     quietly replace `touse' = `touse' & !missing(
> `varlist', `cat', `year')
 10.     if "`sample'" != "" quietly replace `touse' =
>  `touse' & (`sample' == `sval')
 11. 
.     // Weights (default fw=perwt unless user passed 
> weights)
.     local wgt ""
 12.     if "`weight'" != "" {
 13.         local wgt "[`weight'=`exp']"
 14.     }
 15.     else {
 16.         if "`wvar'" == "" local wvar "perwt"
 17.         if "`wtype'" == "" local wtype "fw"
 18.         capture confirm variable `wvar'
 19.         if _rc {
 20.             di as error "Default weight variable 
> `wvar' not found. Either create it or pass weights e
> xplicitly."
 21.             exit 111
 22.         }
 23.         local wgt "[`wtype'=`wvar']"
 24.     }
 25. 
.     // Ensure cat/year numeric for factor vars
.     tempvar __cat __year
 26.     local cattype : type `cat'
 27.     if substr("`cattype'",1,3) == "str" {
 28.         quietly encode `cat' if `touse', gen(`__c
> at')
 29.         local catv `__cat'
 30.     }
 31.     else local catv `cat'
 32. 
.     local yeartype : type `year'
 33.     if substr("`yeartype'",1,3) == "str" {
 34.         quietly destring `year' if `touse', gen(`
> __year') force
 35.         capture assert !missing(`__year') if `tou
> se'
 36.         if _rc {
 37.             di as error "Year variable is string 
> and could not be cleanly converted to numeric."
 38.             exit 459
 39.         }
 40.         local yearv `__year'
 41.     }
 42.     else local yearv `year'
 43. 
.     // Guard: category variable should not also be a
> bsorbed
.     if regexm(" `absorb' ", " `catv' ") {
 44.         di as error "Category variable `catv' app
> ears in absorb(): `absorb'. Remove it from absorb() 
> for this run."
 45.         exit 198
 46.     }
 47. 
.     // Levels (sorted)
.     quietly levelsof `yearv' if `touse', local(yrs)
 48.     quietly levelsof `catv'  if `touse', local(ca
> ts)
 49.     if "`yrs'" == "" | "`cats'" == "" {
 50.         di as error "No observations available af
> ter applying if/in/sample filters."
 51.         exit 2000
 52.     }
 53. 
.     // Regression: cell means for each catyear cond
> itional on absorbed FEs
.     reghdfe `varlist' i.`catv'#i.`yearv' if `touse' 
> `wgt', ///
>         absorb(`absorb') vce(`=cond("`vce'"=="","rob
> ust","`vce'")') nocons
 54. 
.     // Pull coefficient names
.     local bnames : colnames e(b)
 55. 
.     // Critical value for CI (fallback to normal if 
> df_r missing)
.     tempname crit
 56.     capture scalar `crit' = invttail(e(df_r), 0.0
> 25)
 57.     if _rc scalar `crit' = invnormal(0.975)
 58. 
.     // Post to temp dataset
.     tempfile coefdata
 59.     tempname posth
 60.     postfile `posth' int cat_level int year doubl
> e b se ll ul using `coefdata', replace
 61.         
.     foreach bn of local bnames {
 62.         // Match: <c>.<catv>#<y>.<yearv>
.         // Example: 1.cat_sex#2021.year
.         if regexm("`bn'", "^([0-9]+)\.`catv'#([0-9]+
> )\.`yearv'$") {
 63.             local c = real(regexs(1))
 64.             local y = real(regexs(2))
 65. 
.             scalar __b  = _b[`bn']
 66.             scalar __se = _se[`bn']
 67.             scalar __ll = __b - `crit'*__se
 68.             scalar __ul = __b + `crit'*__se
 69. 
.             post `posth' (`c') (`y') (scalar(__b)) (
> scalar(__se)) (scalar(__ll)) (scalar(__ul))
 70.         }
 71.     }
 72.     postclose `posth'
 73. 
.     preserve
 74.         use `coefdata', clear
 75. 
.         // Attach original value label (for legend) 
> if it exists
.         local vlab : value label `catv'
 76.         if "`vlab'" != "" label values cat_level 
> `vlab'
 77. 
.         // Optional normalization to baseyear (withi
> n-category)
.         if "`baseyear'" != "" {
 78.             quietly count if year == `baseyear'
 79.             if r(N) == 0 {
 80.                 di as error "baseyear(`baseyear')
>  not found in the estimation sample."
 81.                 exit 459
 82.             }
 83. 
.             bysort cat_level: egen base_b = max(cond
> (year==`baseyear', b, .))
 84.             replace b  = b  - base_b
 85.             replace ll = ll - base_b
 86.             replace ul = ul - base_b
 87.             drop base_b
 88.         }
 89. 
.         // Build twoway spec: one connected line (+ 
> CI) per category
.         local plots ""
 90.         local legorder ""
 91.         local j = 0
 92.         foreach c of local cats {
 93.             quietly count if cat_level == `c'
 94.             if r(N) == 0 continue
 95.             local ++j
 96.             if "`noci'" == "" {
 97.                 local plots `plots' (rcap ll ul y
> ear if cat_level==`c', sort)
 98.             }
 99.             local plots `plots' (connected b year
>  if cat_level==`c', sort)
100.             local legorder `legorder' `j'
101.         }
102. 
.         if "`xtitle'" == "" local xtitle `"`year'"'
103.         if "`ytitle'" == "" {
104.             if "`baseyear'" != "" local ytitle `"
> `varlist' (relative to `baseyear')"'
105.             else                 local ytitle `"`
> varlist' (adjusted mean)"'
106.         }
107.         if "`title'"  == "" local title  `"`varli
> st' by `cat' over `year'"'
108. 
.         twoway `plots', ///
>             xtitle(`xtitle') ytitle(`ytitle') title(
> `title') ///
>             xlabel(`yrs', angle(45)) ///
>             legend(position(6) cols(1))
109. 
.         if "`saving'" != "" {
110.             local savepath `"`saving'"'
111.             if !regexm(`"`savepath'"', "\.gph$") 
> local savepath `"`savepath'.gph"'
112.             graph save `"`savepath'"', `replace'
113.         }
114.     restore
115. end

. 
. 
. ** Load ACS Data 
. use "${data}working/acs_migration_file", replace 

. 
. ** Define sample 
. drop if qmigplc1 == 4                               
>     // FAILED EDIT OF MIGPLACE 
(388,364 observations deleted)

. drop if inlist(state_fips_o, 2, 15)     // ALASKA AN
> D HAWAII 
(136,571 observations deleted)

. 
. ** Define indicator for being in Multnomah County in
>  origin/destination year
. gen multnomah_o = state_fips_o == 41 & county_fips_o
>  == 51

. gen multnomah_d = state_fips_d == 41 & county_fips_d
>  == 51

. 
. ** Define samples 
. gen sample_1 = multnomah_o == 1                     
>             // Multnomah in origin-year 

. gen sample_2 = multnomah_o != 1                     
>             // Not in Multnomah

. label var sample_1 "Out-migration Sample"

. label var sample_1 "In-migration Sample"

. 
. ** Define moving indicator 
. gen out_1 = same_county == 0 

. label var out_1 "Moved out of Multnomah"

. gen out_2 = multnomah_d == 1 

. label var out_2 "Moved to Multnomah"

. 
. ** Define variables of interest
. 
. ** Age 
. recode age      (18/24 = 1 "18-24")     ///
>                         (25/44 = 2 "25-44")         
>     ///
>                         (45/64 = 3 "45-64")     ///
>                         (65/max = 4 "65+"),     ///
>         gen(cat_age)
(20,893,859 differences between age and cat_age)

. label var cat_age "Age categories"

. 
. ** Sex  
. gen cat_sex = sex == 2 

. label var cat_sex "Female indicator"

. label define lb_cat_sex 0 "Male" 1 "Female"

. label values cat_sex cat_sex 

. 
. ** Marital Status               
. recode marst    (1 = 1 "Married")                   
>             ///
>                                 (2/3 = 2 "Seperated"
> )                   ///
>                                 (4/5 = 3 "Divourced 
> / Widowed") ///
>                                 (6 = 4 "Single"),   
>                             ///
>         gen(cat_married)
(9,061,905 differences between marst and cat_married)

. label var cat_married "Marriage categories"

. 
. ** Kids at home 
. recode nchild   (0 = 0 "0 Children")                
>                     ///
>                                 (1 = 1 "1 Child")   
>                                             ///
>                                 (2 = 2 "2 Children")
>                                     ///
>                                 (3/max = 3 "3+ Child
> ren"),                              ///
>         gen(cat_child)
(412,920 differences between nchild and cat_child)

. label var cat_child "Number of Children"

. 
. ** Education 
. recode educd    (min/61 = 1 "Less than HS")     ///
>                                 (62/71 = 2 "HS Diplo
> ma")                ///
>                                 (80/100 = 3 "Some Co
> llege")     ///
>                                 (101/max = 4 "Colleg
> e Degree"), ///
>         gen(cat_educ)
(20,893,859 differences between educd and cat_educ)

. label var cat_educ "Education categories"

. 
. ** Earnings / Income 
. gen tmp1 = cpi99 if year == 2023
(18,380,619 missing values generated)

. egen tmp2 = mean(tmp1)

. gen cpi =  cpi99 / tmp2 

. drop tmp1 tmp2 

. 
. ** Loop over income variables 
. foreach var of varlist inctot incwage incearn ftotin
> c {
  2.         
.         ** Update CPI 
.         gen real_`var' = round(`var' * cpi) 
  3.         
.         ** Categorical variables 
.         recode real_`var'       (min/-1 = 1 "Negativ
> e income")          ///
>                                                 (0 =
>  2 "$0")                                            
> ///
>                                                 (1/2
> 4999 = 3 "$1-$25K")                         ///
>                                                 (250
> 00/49999 = 4 "$25K-$50K")           ///
>                                                 (500
> 00/99999 = 5 "$50K-$100K")          ///
>                                                 (100
> 000/199999 = 6 "$100K-$200K")       ///
>                                                 (200
> 000/max = 7 "$200K+") ,             ///
>                         gen(cat_`var')
  4.                         
.         ** Tab
.         tab cat_`var', m 
  5.         
. }
(20,893,859 differences between real_inctot and cat_in
> ctot)

      RECODE of |
    real_inctot |      Freq.     Percent        Cum.
----------------+-----------------------------------
Negative income |     20,759        0.10        0.10
             $0 |  1,748,089        8.37        8.47
        $1-$25K |  6,204,378       29.69       38.16
      $25K-$50K |  4,981,113       23.84       62.00
     $50K-$100K |  4,947,578       23.68       85.68
    $100K-$200K |  2,211,136       10.58       96.26
         $200K+ |    780,806        3.74      100.00
----------------+-----------------------------------
          Total | 20,893,859      100.00
(20,893,859 differences between real_incwage and cat_i
> ncwage)

      RECODE of |
   real_incwage |      Freq.     Percent        Cum.
----------------+-----------------------------------
             $0 |  8,182,418       39.16       39.16
        $1-$25K |  3,428,895       16.41       55.57
      $25K-$50K |  3,290,630       15.75       71.32
     $50K-$100K |  3,729,590       17.85       89.17
    $100K-$200K |  1,743,819        8.35       97.52
         $200K+ |    518,507        2.48      100.00
----------------+-----------------------------------
          Total | 20,893,859      100.00
(20,893,859 differences between real_incearn and cat_i
> ncearn)

      RECODE of |
   real_incearn |      Freq.     Percent        Cum.
----------------+-----------------------------------
Negative income |     16,135        0.08        0.08
             $0 |  7,365,326       35.25       35.33
        $1-$25K |  3,756,344       17.98       53.31
      $25K-$50K |  3,476,928       16.64       69.95
     $50K-$100K |  3,876,560       18.55       88.50
    $100K-$200K |  1,823,201        8.73       97.23
         $200K+ |    579,365        2.77      100.00
----------------+-----------------------------------
          Total | 20,893,859      100.00
(20,893,767 differences between real_ftotinc and cat_f
> totinc)

      RECODE of |
   real_ftotinc |      Freq.     Percent        Cum.
----------------+-----------------------------------
Negative income |      7,238        0.03        0.03
             $0 |    226,387        1.08        1.12
        $1-$25K |  2,249,309       10.77       11.88
      $25K-$50K |  3,258,513       15.60       27.48
     $50K-$100K |  5,975,505       28.60       56.08
    $100K-$200K |  6,147,777       29.42       85.50
         $200K+ |  3,029,130       14.50      100.00
----------------+-----------------------------------
          Total | 20,893,859      100.00

. 
. ** Label variable 
. label var cat_inctot "Total personal income categori
> es (real 2023 USD)"

. label var cat_incwage "Total wage income categories 
> (real 2023 USD)"

. label var cat_incearn "Total earned income categorie
> s (real 2023 USD)"

. label var cat_ftotinc "Total family income categorie
> s (real 2023 USD)"

. 
. ** Local categorical variables
. local catvars "cat_sex cat_married cat_age cat_child
>  cat_educ cat_ftotinc"

. 
. ** Loop over out- and in-migration 
. forvalues i = 1/2 {
  2.         
.         if `i' == 1 local ytitle_txt "Out-migration 
> rate (%)"
  3.         if `i' == 2 local ytitle_txt "In-migratio
> n rate (%)"
  4. 
.         ** Loop over categories
.         foreach cat of local catvars {
  5.                 
.                 ** FEs 
.                 local othercats : list catvars - cat
>             
  6.                 
.                 ** Run Regressions
.                 hdfe_catyear_plot out_`i' if sample_
> `i' == 1,                   ///
>                         cat(`cat') year(year)       
>                                                     
> ///
>                         absorb(state_fips_o county_f
> ips_o `othercats')          ///
>                         wvar(perwt) wtype(fw)       
>                                                     
> ///
>                         ytitle(`ytitle_txt')        
>                                                     
> ///
>                         saving("${results}fig_`cat'_
> `i'") replace 
  7.                 
.         } // END CAT LOOP
  8.         
. } // END SAMPLE LOOP 
invalid syntax
r(197);

end of do-file

r(197);

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_00003h
> .tmp"

. /***************************************************
> ****************************
> File Name:              02_indiv_analysis.do
> Creator:                John Iselin
> Date Update:    November 29, 2025
> 
> Called by: 00_multnomah.do
> 
> Purpose: Preform individual-level migration analysis
> . 
> 
> Authors: John Iselin 
> 
> For more information, contact john.iselin@yale.edu
> 
> ****************************************************
> ***************************/
. 
. ** Start log file 
. capture log close log_02

. log using "${logs}02_log_individual_${date}", replac
> e text name(log_02)
------------------------------------------------------
      name:  log_02
       log:  C:/Users/ji252/Documents/GitHub/multnomah
> -county-tax/code/logs/02_log_individual_2025-12-15.l
> og
  log type:  text
 opened on:  16 Dec 2025, 09:59:25

. 
. capture program drop hdfe_catyear_plot

. program define hdfe_catyear_plot
  1.     version 16.0
  2.     syntax varname(numeric) [if] [in] [fw aw pw i
> w] , ///
>         CAT(varname) YEAR(varname) ABSORB(string) //
> /
>         [ SAMPLE(varname) SVAL(real 1) ///
>           WVAR(varname) WTYPE(string) ///
>           VCE(string) ///
>           TITLE(string asis) XTITLE(string asis) YTI
> TLE(string asis) ///
>           NOCI ///
>           BASEYEAR(integer) ///
>           SAVING(string asis) REPLACE ///
>           DEBUG DEBUGDETAIL ]
  3. 
.     // ---------------------------
.     // Debug helpers
.     // ---------------------------
.     local __dbg = ("`debug'" != "" | "`debugdetail'"
>  != "")
  4.     local __dbgdetail = ("`debugdetail'" != "")
  5. 
.     if `__dbg' {
  6.         di as txt "------------------------------
> ------------------------------"
  7.         di as txt "hdfe_catyear_plot DEBUG START"
  8.         di as txt "Outcome   : `varlist'"
  9.         di as txt "CAT()     : `cat'"
 10.         di as txt "YEAR()    : `year'"
 11.         di as txt "ABSORB()  : `absorb'"
 12.         di as txt "SAMPLE()  : `sample'   SVAL():
>  `sval'"
 13.         di as txt "Weights   : weight=`weight' ex
> p=`exp' wvar=`wvar' wtype=`wtype'"
 14.         di as txt "VCE()     : `vce'"
 15.         di as txt "BASEYEAR(): `baseyear'   NOCI:
>  `noci'"
 16.         di as txt "SAVING()  : `saving'   REPLACE
> : `replace'"
 17.         di as txt "IF/IN     : `if' `in'"
 18.         di as txt "------------------------------
> ------------------------------"
 19.     }
 20. 
.     // Requirements
.     capture which reghdfe
 21.     if _rc {
 22.         di as error "reghdfe not found. Install w
> ith: ssc install reghdfe, replace"
 23.         exit 198
 24.     }
 25. 
.     // Mark sample
.     if `__dbg' di as txt "[Step 1] Marking estimatio
> n sample..."
 26.     marksample touse, strok
 27.     quietly replace `touse' = `touse' & !missing(
> `varlist', `cat', `year')
 28.     if "`sample'" != "" quietly replace `touse' =
>  `touse' & (`sample' == `sval')
 29. 
.     quietly count if `touse'
 30.     if `__dbg' di as txt "  N (after filters): " 
> %12.0gc r(N)
 31.     if r(N) == 0 {
 32.         di as error "No observations available af
> ter applying if/in/sample filters."
 33.         exit 2000
 34.     }
 35. 
.     // Weights (default fw=perwt unless user passed 
> weights)
.     if `__dbg' di as txt "[Step 2] Resolving weights
> ..."
 36.     local wgt ""
 37.     if "`weight'" != "" {
 38.         local wgt "[`weight'=`exp']"
 39.         if `__dbg' di as txt "  Using caller-prov
> ided weights: `wgt'"
 40.     }
 41.     else {
 42.         if "`wvar'" == "" local wvar "perwt"
 43.         if "`wtype'" == "" local wtype "fw"
 44.         capture confirm variable `wvar'
 45.         if _rc {
 46.             di as error "Default weight variable 
> `wvar' not found. Either create it or pass weights e
> xplicitly."
 47.             exit 111
 48.         }
 49.         local wgt "[`wtype'=`wvar']"
 50.         if `__dbg' di as txt "  Using default wei
> ghts: `wgt'"
 51.     }
 52. 
.     // Ensure cat/year numeric for factor vars
.     if `__dbg' di as txt "[Step 3] Harmonizing CAT/Y
> EAR types..."
 53.     tempvar __cat __year
 54.     local cattype : type `cat'
 55.     if substr("`cattype'",1,3) == "str" {
 56.         quietly encode `cat' if `touse', gen(`__c
> at')
 57.         local catv `__cat'
 58.         if `__dbg' di as txt "  Encoded string CA
> T -> `catv'"
 59.     }
 60.     else {
 61.         local catv `cat'
 62.         if `__dbg' di as txt "  CAT already numer
> ic -> `catv'"
 63.     }
 64. 
.     local yeartype : type `year'
 65.     if substr("`yeartype'",1,3) == "str" {
 66.         quietly destring `year' if `touse', gen(`
> __year') force
 67.         capture assert !missing(`__year') if `tou
> se'
 68.         if _rc {
 69.             di as error "Year variable is string 
> and could not be cleanly converted to numeric."
 70.             exit 459
 71.         }
 72.         local yearv `__year'
 73.         if `__dbg' di as txt "  Destring YEAR -> 
> `yearv'"
 74.     }
 75.     else {
 76.         local yearv `year'
 77.         if `__dbg' di as txt "  YEAR already nume
> ric -> `yearv'"
 78.     }
 79. 
.     // Guard: category variable should not also be a
> bsorbed
.     if `__dbg' di as txt "[Step 4] Validating absorb
> ()..."
 80.     if regexm(" `absorb' ", " `catv' ") {
 81.         di as error "Category variable `catv' app
> ears in absorb(): `absorb'. Remove it from absorb() 
> for this run."
 82.         exit 198
 83.     }
 84. 
.     // Levels
.     if `__dbg' di as txt "[Step 5] Collecting year a
> nd category levels..."
 85.     quietly levelsof `yearv' if `touse', local(yr
> s)
 86.     quietly levelsof `catv'  if `touse', local(ca
> ts)
 87. 
.     if `__dbg' {
 88.         di as txt "  Years: `yrs'"
 89.         di as txt "  Cats : `cats'"
 90.     }
 91. 
.     if "`yrs'" == "" | "`cats'" == "" {
 92.         di as error "No year or category levels f
> ound in estimation sample."
 93.         exit 2000
 94.     }
 95. 
.     // Base year sanity check (optional)
.     if "`baseyear'" != "" {
 96.         if `__dbg' di as txt "[Step 5b] Checking 
> baseyear()..."
 97.         local found = 0
 98.         foreach y of local yrs {
 99.             if `y' == `baseyear' local found = 1
100.         }
101.         if `found' == 0 {
102.             di as error "baseyear(`baseyear') not
>  found in estimation sample years: `yrs'"
103.             exit 459
104.         }
105.         if `__dbg' di as txt "  baseyear OK: `bas
> eyear'"
106.     }
107. 
.     // Regression
.     if `__dbg' di as txt "[Step 6] Running reghdfe..
> ."
108.     if "`vce'" == "" local vce "robust"
109.     if `__dbg' {
110.         di as txt "  Command:"
111.         di as txt "    reghdfe `varlist' i.`catv'
> #i.`yearv' if `touse' `wgt', absorb(`absorb') vce(`v
> ce') nocons"
112.     }
113. 
.     quietly reghdfe `varlist' i.`catv'#i.`yearv' if 
> `touse' `wgt', ///
>         absorb(`absorb') vce(`vce') nocons
114. 
.     // Existing coefficient names
.     if `__dbg' di as txt "[Step 7] Extracting coeffi
> cients..."
115.     local bnames : colnames e(b)
116.     if `__dbg' {
117.         local nb : word count `bnames'
118.         di as txt "  # coefficients in e(b): `nb'
> "
119.     }
120.     if `__dbgdetail' {
121.         di as txt "  First up to 30 coef names:"
122.         local shown = 0
123.         foreach bn of local bnames {
124.             local ++shown
125.             di as txt "    `bn'"
126.             if `shown' >= 30 continue, break
127.         }
128.     }
129. 
.     // Critical value for CI (fallback to normal if 
> df_r missing)
.     tempname crit
130.     capture scalar `crit' = invttail(e(df_r), 0.0
> 25)
131.     if _rc scalar `crit' = invnormal(0.975)
132.     if `__dbg' di as txt "  CI critical value use
> d: " %9.4f scalar(`crit')
133. 
.     // Post to temp dataset
.     if `__dbg' di as txt "[Step 8] Posting catyear 
> coefficients to a temp dataset..."
134.     tempfile coefdata
135.     tempname posth
136.     postfile `posth' int cat_level int year doubl
> e b se ll ul using `coefdata', replace
137. 
.     local posted = 0
138.     foreach bn of local bnames {
139.         // Match: <c>.<catv>#<y>.<yearv>
.         if regexm("`bn'", "^([0-9]+)\.`catv'#([0-9]+
> )\.`yearv'$") {
140.             local c = real(regexs(1))
141.             local y = real(regexs(2))
142. 
.             scalar __b  = _b[`bn']
143.             scalar __se = _se[`bn']
144.             scalar __ll = __b - scalar(`crit')*__
> se
145.             scalar __ul = __b + scalar(`crit')*__
> se
146. 
.             post `posth' (`c') (`y') (scalar(__b)) (
> scalar(__se)) (scalar(__ll)) (scalar(__ul))
147.             local ++posted
148.         }
149.     }
150.     postclose `posth'
151. 
.     if `__dbg' di as txt "  Rows posted: `posted'"
152.     if `posted' == 0 {
153.         di as error "No catyear coefficients mat
> ched the expected naming pattern. Plot cannot be pro
> duced."
154.         exit 459
155.     }
156. 
.     preserve
157.         use `coefdata', clear
158. 
.         if `__dbgdetail' {
159.             di as txt "[DebugDetail] First 20 row
> s of coefficient dataset:"
160.             list in 1/20, abbrev(24)
161.         }
162. 
.         // Attach value label if exists
.         local vlab : value label `catv'
163.         if "`vlab'" != "" {
164.             label values cat_level `vlab'
165.             if `__dbg' di as txt "  Applied value
>  label to cat_level: `vlab'"
166.         }
167. 
.         // Optional normalization to baseyear (withi
> n-category)
.         if "`baseyear'" != "" {
168.             if `__dbg' di as txt "[Step 9] Normal
> izing to baseyear(`baseyear')..."
169.             bysort cat_level: egen base_b = max(c
> ond(year==`baseyear', b, .))
170.             quietly count if missing(base_b)
171.             if r(N) > 0 {
172.                 di as error "Some categories have
>  no observations in baseyear(`baseyear'). Cannot nor
> malize."
173.                 if `__dbgdetail' {
174.                     di as txt "Categories missing
>  baseyear:"
175.                     bysort cat_level: gen __hasba
> se = !missing(base_b)
176.                     tab cat_level if __hasbase==0
177.                     drop __hasbase
178.                 }
179.                 exit 459
180.             }
181.             replace b  = b  - base_b
182.             replace ll = ll - base_b
183.             replace ul = ul - base_b
184.             drop base_b
185.         }
186. 
.         // Build twoway spec
.         if `__dbg' di as txt "[Step 10] Building plo
> t command..."
187.         local plots ""
188.         local k = 0
189.         foreach c of local cats {
190.             quietly count if cat_level == `c'
191.             if r(N) == 0 continue
192. 
.             if "`noci'" == "" {
193.                 local plots `plots' (rcap ll ul y
> ear if cat_level==`c', sort)
194.                 local ++k
195.             }
196.             local plots `plots' (connected b year
>  if cat_level==`c', sort)
197.             local ++k
198.         }
199. 
.         if `__dbgdetail' {
200.             di as txt "  twoway plot spec (trunca
> ted to 200 chars):"
201.             local tmp = substr("`plots'", 1, 200)
202.             di as txt "    `tmp'..."
203.         }
204. 
.         // Titles
.         if "`xtitle'" == "" local xtitle `"`year'"'
205.         if "`ytitle'" == "" {
206.             if "`baseyear'" != "" local ytitle `"
> `varlist' (relative to `baseyear')"'
207.             else                 local ytitle `"`
> varlist' (adjusted mean)"'
208.         }
209.         if "`title'"  == "" local title  `"`varli
> st' by `cat' over `year'"'
210. 
.         if `__dbg' {
211.             di as txt "  xtitle: `xtitle'"
212.             di as txt "  ytitle: `ytitle'"
213.             di as txt "  title : `title'"
214.         }
215. 
.         // X axis labels: use actual year values pre
> sent in the coef dataset
.         levelsof year, local(xyrs)
216.         if `__dbg' di as txt "  X-axis years used
> : `xyrs'"
217. 
.         twoway `plots', ///
>             xtitle(`xtitle') ytitle(`ytitle') title(
> `title') ///
>             xlabel(`xyrs', angle(45)) ///
>             legend(position(6) cols(1))
218. 
.         // Save graph
.         if "`saving'" != "" {
219.             local savepath `"`saving'"'
220.             if !regexm(`"`savepath'"', "\.gph$") 
> local savepath `"`savepath'.gph"'
221.             if `__dbg' di as txt "[Step 11] Savin
> g graph to: `savepath'"
222.             graph save `"`savepath'"', `replace'
223.         }
224. 
.     restore
225. 
.     if `__dbg' {
226.         di as txt "hdfe_catyear_plot DEBUG END"
227.         di as txt "------------------------------
> ------------------------------"
228.     }
229. end

. 
. 
. ** Load ACS Data 
. use "${data}working/acs_migration_file", replace 

. 
. ** Define sample 
. drop if qmigplc1 == 4                               
>     // FAILED EDIT OF MIGPLACE 
(388,364 observations deleted)

. drop if inlist(state_fips_o, 2, 15)     // ALASKA AN
> D HAWAII 
(136,571 observations deleted)

. 
. ** Define indicator for being in Multnomah County in
>  origin/destination year
. gen multnomah_o = state_fips_o == 41 & county_fips_o
>  == 51

. gen multnomah_d = state_fips_d == 41 & county_fips_d
>  == 51

. 
. ** Define samples 
. gen sample_1 = multnomah_o == 1                     
>             // Multnomah in origin-year 

. gen sample_2 = multnomah_o != 1                     
>             // Not in Multnomah

. label var sample_1 "Out-migration Sample"

. label var sample_1 "In-migration Sample"

. 
. ** Define moving indicator 
. gen out_1 = same_county == 0 

. label var out_1 "Moved out of Multnomah"

. gen out_2 = multnomah_d == 1 

. label var out_2 "Moved to Multnomah"

. 
. ** Define variables of interest
. 
. ** Age 
. recode age      (18/24 = 1 "18-24")     ///
>                         (25/44 = 2 "25-44")         
>     ///
>                         (45/64 = 3 "45-64")     ///
>                         (65/max = 4 "65+"),     ///
>         gen(cat_age)
(20,893,859 differences between age and cat_age)

. label var cat_age "Age categories"

. 
. ** Sex  
. gen cat_sex = sex == 2 

. label var cat_sex "Female indicator"

. label define lb_cat_sex 0 "Male" 1 "Female"

. label values cat_sex cat_sex 

. 
. ** Marital Status               
. recode marst    (1 = 1 "Married")                   
>             ///
>                                 (2/3 = 2 "Seperated"
> )                   ///
>                                 (4/5 = 3 "Divourced 
> / Widowed") ///
>                                 (6 = 4 "Single"),   
>                             ///
>         gen(cat_married)
(9,061,905 differences between marst and cat_married)

. label var cat_married "Marriage categories"

. 
. ** Kids at home 
. recode nchild   (0 = 0 "0 Children")                              
>       ///
>                                 (1 = 1 "1 Child")                 
>                               ///
>                                 (2 = 2 "2 Children")              
>                       ///
>                                 (3/max = 3 "3+ Children"),        
>                       ///
>         gen(cat_child)
(412,920 differences between nchild and cat_child)

. label var cat_child "Number of Children"

. 
. ** Education 
. recode educd    (min/61 = 1 "Less than HS")     ///
>                                 (62/71 = 2 "HS Diploma")          
>       ///
>                                 (80/100 = 3 "Some College")     //
> /
>                                 (101/max = 4 "College Degree"), //
> /
>         gen(cat_educ)
(20,893,859 differences between educd and cat_educ)

. label var cat_educ "Education categories"

. 
. ** Earnings / Income 
. gen tmp1 = cpi99 if year == 2023
(18,380,619 missing values generated)

. egen tmp2 = mean(tmp1)

. gen cpi =  cpi99 / tmp2 

. drop tmp1 tmp2 

. 
. ** Loop over income variables 
. foreach var of varlist inctot incwage incearn ftotinc {
  2.         
.         ** Update CPI 
.         gen real_`var' = round(`var' * cpi) 
  3.         
.         ** Categorical variables 
.         recode real_`var'       (min/-1 = 1 "Negative income")    
>       ///
>                                                 (0 = 2 "$0")      
>                                       ///
>                                                 (1/24999 = 3 "$1-$
> 25K")                         ///
>                                                 (25000/49999 = 4 "
> $25K-$50K")           ///
>                                                 (50000/99999 = 5 "
> $50K-$100K")          ///
>                                                 (100000/199999 = 6
>  "$100K-$200K")       ///
>                                                 (200000/max = 7 "$
> 200K+") ,             ///
>                         gen(cat_`var')
  4.                         
.         ** Tab
.         tab cat_`var', m 
  5.         
. }
(20,893,859 differences between real_inctot and cat_inctot)

      RECODE of |
    real_inctot |      Freq.     Percent        Cum.
----------------+-----------------------------------
Negative income |     20,759        0.10        0.10
             $0 |  1,748,089        8.37        8.47
        $1-$25K |  6,204,378       29.69       38.16
      $25K-$50K |  4,981,113       23.84       62.00
     $50K-$100K |  4,947,578       23.68       85.68
    $100K-$200K |  2,211,136       10.58       96.26
         $200K+ |    780,806        3.74      100.00
----------------+-----------------------------------
          Total | 20,893,859      100.00
(20,893,859 differences between real_incwage and cat_incwage)

      RECODE of |
   real_incwage |      Freq.     Percent        Cum.
----------------+-----------------------------------
             $0 |  8,182,418       39.16       39.16
        $1-$25K |  3,428,895       16.41       55.57
      $25K-$50K |  3,290,630       15.75       71.32
     $50K-$100K |  3,729,590       17.85       89.17
    $100K-$200K |  1,743,819        8.35       97.52
         $200K+ |    518,507        2.48      100.00
----------------+-----------------------------------
          Total | 20,893,859      100.00
(20,893,859 differences between real_incearn and cat_incearn)

      RECODE of |
   real_incearn |      Freq.     Percent        Cum.
----------------+-----------------------------------
Negative income |     16,135        0.08        0.08
             $0 |  7,365,326       35.25       35.33
        $1-$25K |  3,756,344       17.98       53.31
      $25K-$50K |  3,476,928       16.64       69.95
     $50K-$100K |  3,876,560       18.55       88.50
    $100K-$200K |  1,823,201        8.73       97.23
         $200K+ |    579,365        2.77      100.00
----------------+-----------------------------------
          Total | 20,893,859      100.00
(20,893,767 differences between real_ftotinc and cat_ftotinc)

      RECODE of |
   real_ftotinc |      Freq.     Percent        Cum.
----------------+-----------------------------------
Negative income |      7,238        0.03        0.03
             $0 |    226,387        1.08        1.12
        $1-$25K |  2,249,309       10.77       11.88
      $25K-$50K |  3,258,513       15.60       27.48
     $50K-$100K |  5,975,505       28.60       56.08
    $100K-$200K |  6,147,777       29.42       85.50
         $200K+ |  3,029,130       14.50      100.00
----------------+-----------------------------------
          Total | 20,893,859      100.00

. 
. ** Label variable 
. label var cat_inctot "Total personal income categories (real 2023 
> USD)"

. label var cat_incwage "Total wage income categories (real 2023 USD
> )"

. label var cat_incearn "Total earned income categories (real 2023 U
> SD)"

. label var cat_ftotinc "Total family income categories (real 2023 U
> SD)"

. 
. ** Local categorical variables
. local catvars "cat_sex cat_married cat_age cat_child cat_educ cat_
> ftotinc"

. 
. ** Loop over out- and in-migration 
. forvalues i = 1/2 {
  2.         
.         if `i' == 1 local ytitle_txt "Out-migration rate (%)"
  3.         if `i' == 2 local ytitle_txt "In-migration rate (%)"
  4. 
.         ** Loop over categories
.         foreach cat of local catvars {
  5.                 
.                 ** FEs 
.                 local othercats : list catvars - cat            
  6.                 
.                 ** Run Regressions
.                 hdfe_catyear_plot out_`i' if sample_`i' == 1,     
>               ///
>                         cat(`cat') year(year)                     
>                                       ///
>                         absorb(state_fips_o county_fips_o `otherca
> ts')          ///
>                         wvar(perwt) wtype(fw)                     
>                                       ///
>                         ytitle("`ytitle_txt'")                    
>                                       ///
>                         saving("${results}fig_`cat'_`i'") replace 
> debug debugdetail
  7.                 
.         } // END CAT LOOP
  8.         
. } // END SAMPLE LOOP 
invalid syntax
r(197);

end of do-file

r(197);

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_00003i.tmp"

. ** Local categorical variables
. local catvars "cat_sex cat_married cat_age cat_child cat_educ cat_
> ftotinc"

. 
. ** Loop over out- and in-migration 
. forvalues i = 1/2 {
  2.         
.         if `i' == 1 local ytitle_txt "Out-migration rate (%)"
  3.         if `i' == 2 local ytitle_txt "In-migration rate (%)"
  4. 
.         ** Loop over categories
.         foreach cat of local catvars {
  5.                 
.                 ** FEs 
.                 local othercats : list catvars - cat            
  6.                 
.                 ** Run Regressions
.                 hdfe_catyear_plot out_`i' if sample_`i' == 1,     
>               ///
>                         cat(`cat') year(year)                     
>                                       ///
>                         absorb(state_fips_o county_fips_o `otherca
> ts')          ///
>                         wvar(perwt) wtype(fw)                     
>                                       ///
>                         ytitle("`ytitle_txt'")                    
>                                       ///
>                         saving("${results}fig_`cat'_`i'") replace 
> debug 
  7.                 
.         } // END CAT LOOP
  8.         
. } // END SAMPLE LOOP 
invalid syntax
r(197);

end of do-file

r(197);

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_00003j.tmp"

. /*****************************************************************
> **************
> File Name:              02_indiv_analysis.do
> Creator:                John Iselin
> Date Update:    November 29, 2025
> 
> Called by: 00_multnomah.do
> 
> Purpose: Preform individual-level migration analysis. 
> 
> Authors: John Iselin 
> 
> For more information, contact john.iselin@yale.edu
> 
> ******************************************************************
> *************/
. 
. ** Start log file 
. capture log close log_02

. log using "${logs}02_log_individual_${date}", replace text name(lo
> g_02)
--------------------------------------------------------------------
      name:  log_02
       log:  C:/Users/ji252/Documents/GitHub/multnomah-county-tax/co
> de/logs/02_log_individual_2025-12-15.log
  log type:  text
 opened on:  16 Dec 2025, 10:05:13

. 
. ** Run Program 
. capture program drop hdfe_catyear_plot

. program define hdfe_catyear_plot
  1.     version 16.0
  2.     syntax varname(numeric) [if] [in] [fw aw pw iw] , ///
>         CAT(varname) YEAR(varname) ABSORB(string) ///
>         [ SAMPLE(varname) SVAL(real 1) ///
>           WVAR(varname) WTYPE(string) ///
>           VCE(string) ///
>           TITLE(string asis) XTITLE(string asis) YTITLE(string asi
> s) ///
>           NOCI ///
>           SAVING(string asis) REPLACE ]
  3. 
.     // Requirements
.     capture which reghdfe
  4.     if _rc {
  5.         di as error "reghdfe not found. Install with: ssc insta
> ll reghdfe, replace"
  6.         exit 198
  7.     }
  8.     capture which coefplot
  9.     if _rc {
 10.         di as error "coefplot not found. Install with: ssc inst
> all coefplot, replace"
 11.         exit 198
 12.     }
 13. 
.     // Mark sample
.     marksample touse, strok
 14.     quietly replace `touse' = `touse' & !missing(`varlist', `ca
> t', `year')
 15.     if "`sample'" != "" quietly replace `touse' = `touse' & (`s
> ample' == `sval')
 16. 
.     // Weights (default fw=perwt unless user passed weights)
.     local wgt ""
 17.     if "`weight'" != "" {
 18.         local wgt "[`weight'=`exp']"
 19.     }
 20.     else {
 21.         if "`wvar'" == "" local wvar "perwt"
 22.         if "`wtype'" == "" local wtype "fw"
 23.         capture confirm variable `wvar'
 24.         if _rc {
 25.             di as error "Default weight variable `wvar' not fou
> nd. Either create it or pass weights explicitly."
 26.             exit 111
 27.         }
 28.         local wgt "[`wtype'=`wvar']"
 29.     }
 30. 
.     // Ensure cat/year numeric for factor vars
.     tempvar __cat __year
 31.     local cattype : type `cat'
 32.     if substr("`cattype'",1,3) == "str" {
 33.         quietly encode `cat' if `touse', gen(`__cat')
 34.         local catv `__cat'
 35.     }
 36.     else local catv `cat'
 37. 
.     local yeartype : type `year'
 38.     if substr("`yeartype'",1,3) == "str" {
 39.         quietly destring `year' if `touse', gen(`__year') force
 40.         capture assert !missing(`__year') if `touse'
 41.         if _rc {
 42.             di as error "Year variable is string and could not 
> be cleanly converted to numeric."
 43.             exit 459
 44.         }
 45.         local yearv `__year'
 46.     }
 47.     else local yearv `year'
 48. 
.     // Guard: category variable should not also be absorbed
.     // (Your loop hits this when cat==cat_married and absorb(... c
> at_married))
.     if regexm(" `absorb' ", " `catv' ") {
 49.         di as error "Category variable `catv' appears in absorb
> (): `absorb'. Remove it from absorb() for this run."
 50.         exit 198
 51.     }
 52. 
.     // Levels
.     quietly levelsof `yearv' if `touse', local(yrs)
 53.     quietly levelsof `catv'  if `touse', local(cats)
 54.     if "`yrs'" == "" | "`cats'" == "" {
 55.         di as error "No observations available after applying i
> f/in/sample filters."
 56.         exit 2000
 57.     }
 58. 
.     // X-axis positions and labels (positions are 1..K in year ord
> er)
.     local xlabel ""
 59.     local k = 0
 60.     foreach y of local yrs {
 61.         local ++k
 62.         local xlabel `xlabel' `k' "`y'"
 63.     }
 64. 
.     // Regression
.     quietly reghdfe `varlist' i.`catv'#i.`yearv' if `touse' `wgt',
>  ///
>         absorb(`absorb') vce(`=cond("`vce'"=="","robust","`vce'")'
> ) nocons
 65. 
.     // Existing coefficient names (for robust plotting)
.     local bnames : colnames e(b)
 66. 
.     // Build coefplot specs: one series per category; include only
>  existing coefs
.     local plotspecs ""
 67.     local vlab : value label `catv'
 68. 
.     foreach c of local cats {
 69. 
.         // series label
.         local serieslab "`cat'=`c'"
 70.         if "`vlab'" != "" {
 71.             local tmp : label `vlab' `c'
 72.             if "`tmp'" != "" local serieslab "`tmp'"
 73.         }
 74. 
.         local keepc  ""
 75.         local orderc ""
 76.         local atc    ""
 77. 
.         local k = 0
 78.         foreach y of local yrs {
 79.             local ++k
 80.             local coefname "`c'.`catv'#`y'.`yearv'"
 81. 
.             if strpos(" `bnames' ", " `coefname' ") {
 82.                 local keepc  `keepc'  `coefname'
 83.                 local orderc `orderc' `coefname'
 84.                 local atc    `atc'    `k'
 85.             }
 86.         }
 87. 
.         // Skip this category level if nothing survived estimation
.         if "`keepc'" == "" continue
 88. 
.         local ciopt ""
 89.         if "`noci'" != "" local ciopt "noci"
 90. 
.         local plotspecs `plotspecs' ///
>             (., keep(`keepc') order(`orderc') at(`atc') label("`se
> rieslab'") `ciopt')
 91.     }
 92. 
.     if "`plotspecs'" == "" {
 93.         di as error "No coefficients available to plot (all cat
> year cells were dropped). Check empty cells/collinearity."
 94.         exit 2001
 95.     }
 96. 
.     // Defaults with safe quoting
.     if "`xtitle'" == "" local xtitle `"`year'"'
 97.     if "`ytitle'" == "" local ytitle `"`varlist' (adjusted mean
> )"'
 98.     if "`title'"  == "" local title  `"`varlist' by `cat' over 
> `year'"'
 99. 
.     coefplot `plotspecs', ///
>         vertical ///
>         xlabel(`xlabel', angle(45)) ///
>         xtitle(`xtitle') ///
>         ytitle(`ytitle') ///
>         title(`title') ///
>         legend(cols(1) position(6))
100. 
.     // Save graph (ensure .gph extension if user omitted)
.     if "`saving'" != "" {
101.         local savepath `"`saving'"'
102.         if !regexm(`"`savepath'"', "\.gph$") local savepath `"`
> savepath'.gph"'
103.         graph save `"`savepath'"', `replace'
104.     }
105. end

. 
. 
. ** Load ACS Data 
. use "${data}working/acs_migration_file", replace 

. 
. ** Define sample 
. drop if qmigplc1 == 4                                   // FAILED 
> EDIT OF MIGPLACE 
(388,364 observations deleted)

. drop if inlist(state_fips_o, 2, 15)     // ALASKA AND HAWAII 
(136,571 observations deleted)

. 
. ** Define indicator for being in Multnomah County in origin/destin
> ation year
. gen multnomah_o = state_fips_o == 41 & county_fips_o == 51

. gen multnomah_d = state_fips_d == 41 & county_fips_d == 51

. 
. ** Define samples 
. gen sample_1 = multnomah_o == 1                                 //
>  Multnomah in origin-year 

. gen sample_2 = multnomah_o != 1                                 //
>  Not in Multnomah

. label var sample_1 "Out-migration Sample"

. label var sample_1 "In-migration Sample"

. 
. ** Define moving indicator 
. gen out_1 = same_county == 0 

. label var out_1 "Moved out of Multnomah"

. gen out_2 = multnomah_d == 1 

. label var out_2 "Moved to Multnomah"

. 
. ** Define variables of interest
. 
. ** Age 
. recode age      (18/24 = 1 "18-24")     ///
>                         (25/44 = 2 "25-44")             ///
>                         (45/64 = 3 "45-64")     ///
>                         (65/max = 4 "65+"),     ///
>         gen(cat_age)
(20,893,859 differences between age and cat_age)

. label var cat_age "Age categories"

. 
. ** Sex  
. gen cat_sex = sex == 2 

. label var cat_sex "Female indicator"

. label define lb_cat_sex 0 "Male" 1 "Female"

. label values cat_sex cat_sex 

. 
. ** Marital Status               
. recode marst    (1 = 1 "Married")                               //
> /
>                                 (2/3 = 2 "Seperated")             
>       ///
>                                 (4/5 = 3 "Divourced / Widowed") //
> /
>                                 (6 = 4 "Single"),                 
>               ///
>         gen(cat_married)
(9,061,905 differences between marst and cat_married)

. label var cat_married "Marriage categories"

. 
. ** Kids at home 
. recode nchild   (0 = 0 "0 Children")                              
>       ///
>                                 (1 = 1 "1 Child")                 
>                               ///
>                                 (2 = 2 "2 Children")              
>                       ///
>                                 (3/max = 3 "3+ Children"),        
>                       ///
>         gen(cat_child)
(412,920 differences between nchild and cat_child)

. label var cat_child "Number of Children"

. 
. ** Education 
. recode educd    (min/61 = 1 "Less than HS")     ///
>                                 (62/71 = 2 "HS Diploma")          
>       ///
>                                 (80/100 = 3 "Some College")     //
> /
>                                 (101/max = 4 "College Degree"), //
> /
>         gen(cat_educ)
(20,893,859 differences between educd and cat_educ)

. label var cat_educ "Education categories"

. 
. ** Earnings / Income 
. gen tmp1 = cpi99 if year == 2023
(18,380,619 missing values generated)

. egen tmp2 = mean(tmp1)

. gen cpi =  cpi99 / tmp2 

. drop tmp1 tmp2 

. 
. ** Loop over income variables 
. foreach var of varlist inctot incwage incearn ftotinc {
  2.         
.         ** Update CPI 
.         gen real_`var' = round(`var' * cpi) 
  3.         
.         ** Categorical variables 
.         recode real_`var'       (min/-1 = 1 "Negative income")    
>       ///
>                                                 (0 = 2 "$0")      
>                                       ///
>                                                 (1/24999 = 3 "$1-$
> 25K")                         ///
>                                                 (25000/49999 = 4 "
> $25K-$50K")           ///
>                                                 (50000/99999 = 5 "
> $50K-$100K")          ///
>                                                 (100000/199999 = 6
>  "$100K-$200K")       ///
>                                                 (200000/max = 7 "$
> 200K+") ,             ///
>                         gen(cat_`var')
  4.                         
.         ** Tab
.         tab cat_`var', m 
  5.         
. }
(20,893,859 differences between real_inctot and cat_inctot)

      RECODE of |
    real_inctot |      Freq.     Percent        Cum.
----------------+-----------------------------------
Negative income |     20,759        0.10        0.10
             $0 |  1,748,089        8.37        8.47
        $1-$25K |  6,204,378       29.69       38.16
      $25K-$50K |  4,981,113       23.84       62.00
     $50K-$100K |  4,947,578       23.68       85.68
    $100K-$200K |  2,211,136       10.58       96.26
         $200K+ |    780,806        3.74      100.00
----------------+-----------------------------------
          Total | 20,893,859      100.00
(20,893,859 differences between real_incwage and cat_incwage)

      RECODE of |
   real_incwage |      Freq.     Percent        Cum.
----------------+-----------------------------------
             $0 |  8,182,418       39.16       39.16
        $1-$25K |  3,428,895       16.41       55.57
      $25K-$50K |  3,290,630       15.75       71.32
     $50K-$100K |  3,729,590       17.85       89.17
    $100K-$200K |  1,743,819        8.35       97.52
         $200K+ |    518,507        2.48      100.00
----------------+-----------------------------------
          Total | 20,893,859      100.00
(20,893,859 differences between real_incearn and cat_incearn)

      RECODE of |
   real_incearn |      Freq.     Percent        Cum.
----------------+-----------------------------------
Negative income |     16,135        0.08        0.08
             $0 |  7,365,326       35.25       35.33
        $1-$25K |  3,756,344       17.98       53.31
      $25K-$50K |  3,476,928       16.64       69.95
     $50K-$100K |  3,876,560       18.55       88.50
    $100K-$200K |  1,823,201        8.73       97.23
         $200K+ |    579,365        2.77      100.00
----------------+-----------------------------------
          Total | 20,893,859      100.00
(20,893,767 differences between real_ftotinc and cat_ftotinc)

      RECODE of |
   real_ftotinc |      Freq.     Percent        Cum.
----------------+-----------------------------------
Negative income |      7,238        0.03        0.03
             $0 |    226,387        1.08        1.12
        $1-$25K |  2,249,309       10.77       11.88
      $25K-$50K |  3,258,513       15.60       27.48
     $50K-$100K |  5,975,505       28.60       56.08
    $100K-$200K |  6,147,777       29.42       85.50
         $200K+ |  3,029,130       14.50      100.00
----------------+-----------------------------------
          Total | 20,893,859      100.00

. 
. ** Label variable 
. label var cat_inctot "Total personal income categories (real 2023 
> USD)"

. label var cat_incwage "Total wage income categories (real 2023 USD
> )"

. label var cat_incearn "Total earned income categories (real 2023 U
> SD)"

. label var cat_ftotinc "Total family income categories (real 2023 U
> SD)"

. 
. ** Local categorical variables
. local catvars "cat_sex cat_married cat_age cat_child cat_educ cat_
> ftotinc"

. 
. ** Loop over out- and in-migration 
. forvalues i = 1/2 {
  2.         
.         if `i' == 1 local ytitle_txt "Out-migration rate (%)"
  3.         if `i' == 2 local ytitle_txt "In-migration rate (%)"
  4. 
.         ** Loop over categories
.         foreach cat of local catvars {
  5.                 
.                 ** FEs 
.                 local othercats : list catvars - cat            
  6. 
.                 ** Run Regressions
.                 hdfe_catyear_plot out_`i' if sample_`i' == 1,     
>               ///
>                         cat(`cat') year(year)                     
>                                       ///
>                         absorb(state_fips_o county_fips_o `otherca
> ts')          ///
>                         wvar(perwt) wtype(fw)                     
>                                       ///
>                         ytitle(`ytitle_txt')                      
>                                       ///
>                         saving("${results}fig_`cat'_`i'") replace 
  7.                 
.         } // END CAT LOOP
  8.         
. } // END SAMPLE LOOP 
.: invalid syntax in at()
r(198);

end of do-file

r(198);

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_00003k.tmp"

. /*****************************************************************
> **************
> File Name:              02_indiv_analysis.do
> Creator:                John Iselin
> Date Update:    November 29, 2025
> 
> Called by: 00_multnomah.do
> 
> Purpose: Preform individual-level migration analysis. 
> 
> Authors: John Iselin 
> 
> For more information, contact john.iselin@yale.edu
> 
> ******************************************************************
> *************/
. 
. ** Start log file 
. capture log close log_02

. log using "${logs}02_log_individual_${date}", replace text name(lo
> g_02)
--------------------------------------------------------------------
      name:  log_02
       log:  C:/Users/ji252/Documents/GitHub/multnomah-county-tax/co
> de/logs/02_log_individual_2025-12-15.log
  log type:  text
 opened on:  16 Dec 2025, 10:09:50

. 
. ** Run Program 
. capture program drop hdfe_catyear_plot

. program define hdfe_catyear_plot
  1.     version 16.0
  2.     syntax varname(numeric) [if] [in] [fw aw pw iw] , ///
>         CAT(varname) YEAR(varname) ABSORB(string) ///
>         [ SAMPLE(varname) SVAL(real 1) ///
>           WVAR(varname) WTYPE(string) ///
>           VCE(string) ///
>           TITLE(string asis) XTITLE(string asis) YTITLE(string asi
> s) ///
>           NOCI ///
>           BASEYEAR(integer) ///
>           SAVING(string asis) REPLACE ///
>           DEBUG DEBUGDETAIL ]
  3. 
.     // ---------------------------
.     // Debug helpers
.     // ---------------------------
.     local __dbg = ("`debug'" != "" | "`debugdetail'" != "")
  4.     local __dbgdetail = ("`debugdetail'" != "")
  5. 
.     if `__dbg' {
  6.         di as txt "--------------------------------------------
> ----------------"
  7.         di as txt "hdfe_catyear_plot DEBUG START"
  8.         di as txt "Outcome   : `varlist'"
  9.         di as txt "CAT()     : `cat'"
 10.         di as txt "YEAR()    : `year'"
 11.         di as txt "ABSORB()  : `absorb'"
 12.         di as txt "SAMPLE()  : `sample'   SVAL(): `sval'"
 13.         di as txt "Weights   : weight=`weight' exp=`exp' wvar=`
> wvar' wtype=`wtype'"
 14.         di as txt "VCE()     : `vce'"
 15.         di as txt "BASEYEAR(): `baseyear'   NOCI: `noci'"
 16.         di as txt "SAVING()  : `saving'   REPLACE: `replace'"
 17.         di as txt "IF/IN     : `if' `in'"
 18.         di as txt "--------------------------------------------
> ----------------"
 19.     }
 20. 
.     // Requirements
.     capture which reghdfe
 21.     if _rc {
 22.         di as error "reghdfe not found. Install with: ssc insta
> ll reghdfe, replace"
 23.         exit 198
 24.     }
 25. 
.     // Mark sample
.     if `__dbg' di as txt "[Step 1] Marking estimation sample..."
 26.     marksample touse, strok
 27.     quietly replace `touse' = `touse' & !missing(`varlist', `ca
> t', `year')
 28.     if "`sample'" != "" quietly replace `touse' = `touse' & (`s
> ample' == `sval')
 29. 
.     quietly count if `touse'
 30.     if `__dbg' di as txt "  N (after filters): " %12.0gc r(N)
 31.     if r(N) == 0 {
 32.         di as error "No observations available after applying i
> f/in/sample filters."
 33.         exit 2000
 34.     }
 35. 
.     // Weights (default fw=perwt unless user passed weights)
.     if `__dbg' di as txt "[Step 2] Resolving weights..."
 36.     local wgt ""
 37.     if "`weight'" != "" {
 38.         local wgt "[`weight'=`exp']"
 39.         if `__dbg' di as txt "  Using caller-provided weights: 
> `wgt'"
 40.     }
 41.     else {
 42.         if "`wvar'" == "" local wvar "perwt"
 43.         if "`wtype'" == "" local wtype "fw"
 44.         capture confirm variable `wvar'
 45.         if _rc {
 46.             di as error "Default weight variable `wvar' not fou
> nd. Either create it or pass weights explicitly."
 47.             exit 111
 48.         }
 49.         local wgt "[`wtype'=`wvar']"
 50.         if `__dbg' di as txt "  Using default weights: `wgt'"
 51.     }
 52. 
.     // Ensure cat/year numeric for factor vars
.     if `__dbg' di as txt "[Step 3] Harmonizing CAT/YEAR types..."
 53.     tempvar __cat __year
 54.     local cattype : type `cat'
 55.     if substr("`cattype'",1,3) == "str" {
 56.         quietly encode `cat' if `touse', gen(`__cat')
 57.         local catv `__cat'
 58.         if `__dbg' di as txt "  Encoded string CAT -> `catv'"
 59.     }
 60.     else {
 61.         local catv `cat'
 62.         if `__dbg' di as txt "  CAT already numeric -> `catv'"
 63.     }
 64. 
.     local yeartype : type `year'
 65.     if substr("`yeartype'",1,3) == "str" {
 66.         quietly destring `year' if `touse', gen(`__year') force
 67.         capture assert !missing(`__year') if `touse'
 68.         if _rc {
 69.             di as error "Year variable is string and could not 
> be cleanly converted to numeric."
 70.             exit 459
 71.         }
 72.         local yearv `__year'
 73.         if `__dbg' di as txt "  Destring YEAR -> `yearv'"
 74.     }
 75.     else {
 76.         local yearv `year'
 77.         if `__dbg' di as txt "  YEAR already numeric -> `yearv'
> "
 78.     }
 79. 
.     // Guard: category variable should not also be absorbed
.     if `__dbg' di as txt "[Step 4] Validating absorb()..."
 80.     if regexm(" `absorb' ", " `catv' ") {
 81.         di as error "Category variable `catv' appears in absorb
> (): `absorb'. Remove it from absorb() for this run."
 82.         exit 198
 83.     }
 84. 
.     // Levels
.     if `__dbg' di as txt "[Step 5] Collecting year and category le
> vels..."
 85.     quietly levelsof `yearv' if `touse', local(yrs)
 86.     quietly levelsof `catv'  if `touse', local(cats)
 87. 
.     if `__dbg' {
 88.         di as txt "  Years: `yrs'"
 89.         di as txt "  Cats : `cats'"
 90.     }
 91. 
.     if "`yrs'" == "" | "`cats'" == "" {
 92.         di as error "No year or category levels found in estima
> tion sample."
 93.         exit 2000
 94.     }
 95. 
.     // Base year sanity check (optional)
.     if "`baseyear'" != "" {
 96.         if `__dbg' di as txt "[Step 5b] Checking baseyear()..."
 97.         local found = 0
 98.         foreach y of local yrs {
 99.             if `y' == `baseyear' local found = 1
100.         }
101.         if `found' == 0 {
102.             di as error "baseyear(`baseyear') not found in esti
> mation sample years: `yrs'"
103.             exit 459
104.         }
105.         if `__dbg' di as txt "  baseyear OK: `baseyear'"
106.     }
107. 
.     // Regression
.     if `__dbg' di as txt "[Step 6] Running reghdfe..."
108.     if "`vce'" == "" local vce "robust"
109.     if `__dbg' {
110.         di as txt "  Command:"
111.         di as txt "    reghdfe `varlist' i.`catv'#i.`yearv' if 
> `touse' `wgt', absorb(`absorb') vce(`vce') nocons"
112.     }
113. 
.     quietly reghdfe `varlist' i.`catv'#i.`yearv' if `touse' `wgt',
>  ///
>         absorb(`absorb') vce(`vce') nocons
114. 
.     // Existing coefficient names
.     if `__dbg' di as txt "[Step 7] Extracting coefficients..."
115.     local bnames : colnames e(b)
116.     if `__dbg' {
117.         local nb : word count `bnames'
118.         di as txt "  # coefficients in e(b): `nb'"
119.     }
120.     if `__dbgdetail' {
121.         di as txt "  First up to 30 coef names:"
122.         local shown = 0
123.         foreach bn of local bnames {
124.             local ++shown
125.             di as txt "    `bn'"
126.             if `shown' >= 30 continue, break
127.         }
128.     }
129. 
.     // Critical value for CI (fallback to normal if df_r missing)
.     tempname crit
130.     capture scalar `crit' = invttail(e(df_r), 0.025)
131.     if _rc scalar `crit' = invnormal(0.975)
132.     if `__dbg' di as txt "  CI critical value used: " %9.4f sca
> lar(`crit')
133. 
.     // Post to temp dataset
.     if `__dbg' di as txt "[Step 8] Posting catyear coefficients t
> o a temp dataset..."
134.     tempfile coefdata
135.     tempname posth
136.     postfile `posth' int cat_level int year double b se ll ul u
> sing `coefdata', replace
137. 
.     local posted = 0
138.     foreach bn of local bnames {
139.         // Match: <c>.<catv>#<y>.<yearv>
.         if regexm("`bn'", "^([0-9]+)\.`catv'#([0-9]+)\.`yearv'$") 
> {
140.             local c = real(regexs(1))
141.             local y = real(regexs(2))
142. 
.             scalar __b  = _b[`bn']
143.             scalar __se = _se[`bn']
144.             scalar __ll = __b - scalar(`crit')*__se
145.             scalar __ul = __b + scalar(`crit')*__se
146. 
.             post `posth' (`c') (`y') (scalar(__b)) (scalar(__se)) 
> (scalar(__ll)) (scalar(__ul))
147.             local ++posted
148.         }
149.     }
150.     postclose `posth'
151. 
.     if `__dbg' di as txt "  Rows posted: `posted'"
152.     if `posted' == 0 {
153.         di as error "No catyear coefficients matched the expec
> ted naming pattern. Plot cannot be produced."
154.         exit 459
155.     }
156. 
.     preserve
157.         use `coefdata', clear
158. 
.         if `__dbgdetail' {
159.             di as txt "[DebugDetail] First 20 rows of coefficie
> nt dataset:"
160.             list in 1/20, abbrev(24)
161.         }
162. 
.         // Attach value label if exists
.         local vlab : value label `catv'
163.         if "`vlab'" != "" {
164.             label values cat_level `vlab'
165.             if `__dbg' di as txt "  Applied value label to cat_
> level: `vlab'"
166.         }
167. 
.         // Optional normalization to baseyear (within-category)
.         if "`baseyear'" != "" {
168.             if `__dbg' di as txt "[Step 9] Normalizing to basey
> ear(`baseyear')..."
169.             bysort cat_level: egen base_b = max(cond(year==`bas
> eyear', b, .))
170.             quietly count if missing(base_b)
171.             if r(N) > 0 {
172.                 di as error "Some categories have no observatio
> ns in baseyear(`baseyear'). Cannot normalize."
173.                 if `__dbgdetail' {
174.                     di as txt "Categories missing baseyear:"
175.                     bysort cat_level: gen __hasbase = !missing(
> base_b)
176.                     tab cat_level if __hasbase==0
177.                     drop __hasbase
178.                 }
179.                 exit 459
180.             }
181.             replace b  = b  - base_b
182.             replace ll = ll - base_b
183.             replace ul = ul - base_b
184.             drop base_b
185.         }
186. 
.         // Build twoway spec
.         if `__dbg' di as txt "[Step 10] Building plot command..."
187.         local plots ""
188.         local k = 0
189.         foreach c of local cats {
190.             quietly count if cat_level == `c'
191.             if r(N) == 0 continue
192. 
.             if "`noci'" == "" {
193.                 local plots `plots' (rcap ll ul year if cat_lev
> el==`c', sort)
194.                 local ++k
195.             }
196.             local plots `plots' (connected b year if cat_level=
> =`c', sort)
197.             local ++k
198.         }
199. 
.         if `__dbgdetail' {
200.             di as txt "  twoway plot spec (truncated to 200 cha
> rs):"
201.             local tmp = substr("`plots'", 1, 200)
202.             di as txt "    `tmp'..."
203.         }
204. 
.         // Titles
.         if "`xtitle'" == "" local xtitle `"`year'"'
205.         if "`ytitle'" == "" {
206.             if "`baseyear'" != "" local ytitle `"`varlist' (rel
> ative to `baseyear')"'
207.             else                 local ytitle `"`varlist' (adju
> sted mean)"'
208.         }
209.         if "`title'"  == "" local title  `"`varlist' by `cat' o
> ver `year'"'
210. 
.         if `__dbg' {
211.             di as txt "  xtitle: `xtitle'"
212.             di as txt "  ytitle: `ytitle'"
213.             di as txt "  title : `title'"
214.         }
215. 
.         // X axis labels: use actual year values present in the co
> ef dataset
.         levelsof year, local(xyrs)
216.         if `__dbg' di as txt "  X-axis years used: `xyrs'"
217. 
.         twoway `plots', ///
>             xtitle(`xtitle') ytitle(`ytitle') title(`title') ///
>             xlabel(`xyrs', angle(45)) ///
>             legend(position(6) cols(1))
218. 
.         // Save graph
.         if "`saving'" != "" {
219.             local savepath `"`saving'"'
220.             if !regexm(`"`savepath'"', "\.gph$") local savepath
>  `"`savepath'.gph"'
221.             if `__dbg' di as txt "[Step 11] Saving graph to: `s
> avepath'"
222.             graph save `"`savepath'"', `replace'
223.         }
224. 
.     restore
225. 
.     if `__dbg' {
226.         di as txt "hdfe_catyear_plot DEBUG END"
227.         di as txt "--------------------------------------------
> ----------------"
228.     }
229. end

. 
. 
. ** Load ACS Data 
. use "${data}working/acs_migration_file", replace 

. 
. ** Define sample 
. drop if qmigplc1 == 4                                   // FAILED 
> EDIT OF MIGPLACE 
(388,364 observations deleted)

. drop if inlist(state_fips_o, 2, 15)     // ALASKA AND HAWAII 
(136,571 observations deleted)

. 
. ** Define indicator for being in Multnomah County in origin/destin
> ation year
. gen multnomah_o = state_fips_o == 41 & county_fips_o == 51

. gen multnomah_d = state_fips_d == 41 & county_fips_d == 51

. 
. ** Define samples 
. gen sample_1 = multnomah_o == 1                                 //
>  Multnomah in origin-year 

. gen sample_2 = multnomah_o != 1                                 //
>  Not in Multnomah

. label var sample_1 "Out-migration Sample"

. label var sample_1 "In-migration Sample"

. 
. ** Define moving indicator 
. gen out_1 = same_county == 0 

. label var out_1 "Moved out of Multnomah"

. gen out_2 = multnomah_d == 1 

. label var out_2 "Moved to Multnomah"

. 
. ** Define variables of interest
. 
. ** Age 
. recode age      (18/24 = 1 "18-24")     ///
>                         (25/44 = 2 "25-44")             ///
>                         (45/64 = 3 "45-64")     ///
>                         (65/max = 4 "65+"),     ///
>         gen(cat_age)
(20,893,859 differences between age and cat_age)

. label var cat_age "Age categories"

. 
. ** Sex  
. gen cat_sex = sex == 2 

. label var cat_sex "Female indicator"

. label define lb_cat_sex 0 "Male" 1 "Female"

. label values cat_sex cat_sex 

. 
. ** Marital Status               
. recode marst    (1 = 1 "Married")                               //
> /
>                                 (2/3 = 2 "Seperated")             
>       ///
>                                 (4/5 = 3 "Divourced / Widowed") //
> /
>                                 (6 = 4 "Single"),                 
>               ///
>         gen(cat_married)
(9,061,905 differences between marst and cat_married)

. label var cat_married "Marriage categories"

. 
. ** Kids at home 
. recode nchild   (0 = 0 "0 Children")                              
>       ///
>                                 (1 = 1 "1 Child")                 
>                               ///
>                                 (2 = 2 "2 Children")              
>                       ///
>                                 (3/max = 3 "3+ Children"),        
>                       ///
>         gen(cat_child)
(412,920 differences between nchild and cat_child)

. label var cat_child "Number of Children"

. 
. ** Education 
. recode educd    (min/61 = 1 "Less than HS")     ///
>                                 (62/71 = 2 "HS Diploma")          
>       ///
>                                 (80/100 = 3 "Some College")     //
> /
>                                 (101/max = 4 "College Degree"), //
> /
>         gen(cat_educ)
(20,893,859 differences between educd and cat_educ)

. label var cat_educ "Education categories"

. 
. ** Earnings / Income 
. gen tmp1 = cpi99 if year == 2023
(18,380,619 missing values generated)

. egen tmp2 = mean(tmp1)

. gen cpi =  cpi99 / tmp2 

. drop tmp1 tmp2 

. 
. ** Loop over income variables 
. foreach var of varlist inctot incwage incearn ftotinc {
  2.         
.         ** Update CPI 
.         gen real_`var' = round(`var' * cpi) 
  3.         
.         ** Categorical variables 
.         recode real_`var'       (min/-1 = 1 "Negative income")    
>       ///
>                                                 (0 = 2 "$0")      
>                                       ///
>                                                 (1/24999 = 3 "$1-$
> 25K")                         ///
>                                                 (25000/49999 = 4 "
> $25K-$50K")           ///
>                                                 (50000/99999 = 5 "
> $50K-$100K")          ///
>                                                 (100000/199999 = 6
>  "$100K-$200K")       ///
>                                                 (200000/max = 7 "$
> 200K+") ,             ///
>                         gen(cat_`var')
  4.                         
.         ** Tab
.         tab cat_`var', m 
  5.         
. }
(20,893,859 differences between real_inctot and cat_inctot)

      RECODE of |
    real_inctot |      Freq.     Percent        Cum.
----------------+-----------------------------------
Negative income |     20,759        0.10        0.10
             $0 |  1,748,089        8.37        8.47
        $1-$25K |  6,204,378       29.69       38.16
      $25K-$50K |  4,981,113       23.84       62.00
     $50K-$100K |  4,947,578       23.68       85.68
    $100K-$200K |  2,211,136       10.58       96.26
         $200K+ |    780,806        3.74      100.00
----------------+-----------------------------------
          Total | 20,893,859      100.00
(20,893,859 differences between real_incwage and cat_incwage)

      RECODE of |
   real_incwage |      Freq.     Percent        Cum.
----------------+-----------------------------------
             $0 |  8,182,418       39.16       39.16
        $1-$25K |  3,428,895       16.41       55.57
      $25K-$50K |  3,290,630       15.75       71.32
     $50K-$100K |  3,729,590       17.85       89.17
    $100K-$200K |  1,743,819        8.35       97.52
         $200K+ |    518,507        2.48      100.00
----------------+-----------------------------------
          Total | 20,893,859      100.00
(20,893,859 differences between real_incearn and cat_incearn)

      RECODE of |
   real_incearn |      Freq.     Percent        Cum.
----------------+-----------------------------------
Negative income |     16,135        0.08        0.08
             $0 |  7,365,326       35.25       35.33
        $1-$25K |  3,756,344       17.98       53.31
      $25K-$50K |  3,476,928       16.64       69.95
     $50K-$100K |  3,876,560       18.55       88.50
    $100K-$200K |  1,823,201        8.73       97.23
         $200K+ |    579,365        2.77      100.00
----------------+-----------------------------------
          Total | 20,893,859      100.00
(20,893,767 differences between real_ftotinc and cat_ftotinc)

      RECODE of |
   real_ftotinc |      Freq.     Percent        Cum.
----------------+-----------------------------------
Negative income |      7,238        0.03        0.03
             $0 |    226,387        1.08        1.12
        $1-$25K |  2,249,309       10.77       11.88
      $25K-$50K |  3,258,513       15.60       27.48
     $50K-$100K |  5,975,505       28.60       56.08
    $100K-$200K |  6,147,777       29.42       85.50
         $200K+ |  3,029,130       14.50      100.00
----------------+-----------------------------------
          Total | 20,893,859      100.00

. 
. ** Label variable 
. label var cat_inctot "Total personal income categories (real 2023 
> USD)"

. label var cat_incwage "Total wage income categories (real 2023 USD
> )"

. label var cat_incearn "Total earned income categories (real 2023 U
> SD)"

. label var cat_ftotinc "Total family income categories (real 2023 U
> SD)"

. 
. ** Local categorical variables
. local catvars "cat_sex cat_married cat_age cat_child cat_educ cat_
> ftotinc"

. 
. ** Loop over out- and in-migration 
. forvalues i = 1/2 {
  2.         
.         if `i' == 1 local ytitle_txt "Out-migration rate (%)"
  3.         if `i' == 2 local ytitle_txt "In-migration rate (%)"
  4. 
.         ** Loop over categories
.         foreach cat of local catvars {
  5.                 
.                 ** FEs 
.                 local othercats : list catvars - cat            
  6. 
.                 ** Run Regressions
.                 hdfe_catyear_plot out_`i' if sample_`i' == 1,     
>               ///
>                         cat(`cat') year(year)                     
>                                       ///
>                         absorb(state_fips_o county_fips_o `otherca
> ts')          ///
>                         wvar(perwt) wtype(fw)                     
>                                       ///
>                         ytitle(`ytitle_txt')                      
>                                       ///
>                         saving("${results}fig_`cat'_`i'") replace 
  7.                 
.         } // END CAT LOOP
  8.         
. } // END SAMPLE LOOP 
invalid syntax
r(197);

end of do-file

r(197);

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_00003l.tmp"

. ** Local categorical variables
. local catvars "cat_sex cat_married cat_age cat_child cat_educ cat_
> ftotinc"

. 
. ** Loop over out- and in-migration 
. forvalues i = 1/2 {
  2.         
.         if `i' == 1 local ytitle_txt "Out-migration rate (%)"
  3.         if `i' == 2 local ytitle_txt "In-migration rate (%)"
  4. 
.         ** Loop over categories
.         foreach cat of local catvars {
  5.                 
.                 ** FEs 
.                 local othercats : list catvars - cat            
  6. dis "test "
  7.                 ** Run Regressions
.                 hdfe_catyear_plot out_`i' if sample_`i' == 1,     
>               ///
>                         cat(`cat') year(year)                     
>                                       ///
>                         absorb(state_fips_o county_fips_o `otherca
> ts')          ///
>                         wvar(perwt) wtype(fw)                     
>                                       ///
>                         ytitle(`ytitle_txt')                      
>                                       ///
>                         saving("${results}fig_`cat'_`i'") replace 
> debug 
  8.                 
.         } // END CAT LOOP
  9.         
. } // END SAMPLE LOOP 
test 
invalid syntax
r(197);

end of do-file

r(197);

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_00003m.tmp"

. ** Local categorical variables
. local catvars "cat_sex cat_married cat_age cat_child cat_educ cat_
> ftotinc"

. 
. ** Loop over out- and in-migration 
. forvalues i = 1/2 {
  2.         
.         if `i' == 1 local ytitle_txt "Out-migration rate (%)"
  3.         if `i' == 2 local ytitle_txt "In-migration rate (%)"
  4. 
.         ** Loop over categories
.         foreach cat of local catvars {
  5.                 
.                 ** FEs 
.                 local othercats : list catvars - cat            
  6. 
.                 ** Run Regressions
.                 hdfe_catyear_plot out_`i' if sample_`i' == 1,     
>               ///
>                         cat(`cat')                                
>                                                       ///
>                         year(year)                                
>                                                       ///
>                         absorb(state_fips_o county_fips_o `otherca
> ts')          ///
>                         wvar(perwt) wtype(fw)                     
>                                       ///
>                         ytitle("`ytitle_txt'")                    
>                                       ///
>                         saving("${results}fig_`cat'_`i'") replace 
> debug 
  7.                 
.         } // END CAT LOOP
  8.         
. } // END SAMPLE LOOP 
invalid syntax
r(197);

end of do-file

r(197);

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_00003n.tmp"

. ** Local categorical variables
. local catvars "cat_sex cat_married cat_age cat_child cat_educ cat_
> ftotinc"

. 
. ** Loop over out- and in-migration 
. forvalues i = 1/2 {
  2.         
.         if `i' == 1 local ytitle_txt "Out-migration rate (%)"
  3.         if `i' == 2 local ytitle_txt "In-migration rate (%)"
  4. 
.         ** Loop over categories
.         foreach cat of local catvars {
  5.                 
.                 ** FEs 
.                 local othercats : list catvars - cat            
  6. 
.                 ** Run Regressions
.                 hdfe_catyear_plot out_`i' if sample_`i' == 1,     
>               ///
>                         cat(`cat')                                
>                                                       ///
>                         year(year)                                
>                                                       ///
>                         absorb(state_fips_o county_fips_o `otherca
> ts')          ///
>                         wvar(perwt) wtype(fw)                     
>                                       ///
>                         ytitle("`ytitle_txt'")                    
>                                       ///
>                         saving("${results}fig_`cat'_`i'") replace 
> debug 
  7.                 
.         } // END CAT LOOP
  8.         
. } // END SAMPLE LOOP 
invalid syntax
r(197);

end of do-file

r(197);

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_00003o.tmp"

. label var cat_sex "Female indicator"

. label define lb_cat_sex 0 "Male" 1 "Female"
label lb_cat_sex already defined
r(110);

end of do-file

r(110);

.  do "C:\Users\ji252\AppData\Local\Temp\STD67b0_00003p.tmp"

. ** Local categorical variables
. local catvars "cat_sex cat_married cat_age cat_child cat_educ cat_
> ftotinc"

. 
. ** Loop over out- and in-migration 
. forvalues i = 1/2 {
  2.         
.         if `i' == 1 local ytitle_txt "Out-migration rate (%)"
  3.         if `i' == 2 local ytitle_txt "In-migration rate (%)"
  4. 
.         ** Loop over categories
.         foreach cat of local catvars {
  5.                 
.                 ** FEs 
.                 local othercats : list catvars - cat            
  6. 
.                 ** Run Regressions
.                 hdfe_catyear_plot out_`i' if sample_`i' == 1,     
>               ///
>                         cat(`cat')                                
>                                                       ///
>                         year(year)                                
>                                                       ///
>                         absorb(state_fips_o county_fips_o `otherca
> ts')          ///
>                         wvar(perwt) wtype(fw)                     
>                                       ///
>                         ytitle("`ytitle_txt'")                    
>                                       ///
>                         saving("${results}fig_`cat'_`i'") replace 
> debug 
  7.                 
.         } // END CAT LOOP
  8.         
. } // END SAMPLE LOOP 
invalid syntax
r(197);

end of do-file

r(197);

.  do "C:\Users\ji252\AppData\Local\Temp\STD67b0_00003q.tmp"

. /*****************************************************************
> **************
> File Name:              02_indiv_analysis.do
> Creator:                John Iselin
> Date Update:    November 29, 2025
> 
> Called by: 00_multnomah.do
> 
> Purpose: Preform individual-level migration analysis. 
> 
> Authors: John Iselin 
> 
> For more information, contact john.iselin@yale.edu
> 
> ******************************************************************
> *************/
. 
. ** Start log file 
. capture log close log_02

. log using "${logs}02_log_individual_${date}", replace text name(lo
> g_02)
--------------------------------------------------------------------
      name:  log_02
       log:  C:/Users/ji252/Documents/GitHub/multnomah-county-tax/co
> de/logs/02_log_individual_2025-12-15.log
  log type:  text
 opened on:  16 Dec 2025, 10:21:23

. 
. ** Run Program 
. capture program drop hdfe_catyear_plot

. program define hdfe_catyear_plot
  1.     version 16.0
  2.     syntax varname(numeric) [if] [in] [fw aw pw iw] , ///
>         CAT(varname) YEAR(varname) ABSORB(string) ///
>         [ SAMPLE(varname) SVAL(real 1) ///
>           WVAR(varname) WTYPE(string) ///
>           VCE(string) ///
>           TITLE(string asis) XTITLE(string asis) YTITLE(string asi
> s) ///
>           NOCI ///
>           BASEYEAR(integer) ///
>           SAVING(string asis) REPLACE ///
>           DEBUG DEBUGDETAIL ]
  3. 
.     // ---------------------------
.     // Debug helpers
.     // ---------------------------
.         dis "test"
  4.     local __dbg = ("`debug'" != "" | "`debugdetail'" != "")
  5.     local __dbgdetail = ("`debugdetail'" != "")
  6. 
.     if `__dbg' {
  7.         di as txt "--------------------------------------------
> ----------------"
  8.         di as txt "hdfe_catyear_plot DEBUG START"
  9.         di as txt "Outcome   : `varlist'"
 10.         di as txt "CAT()     : `cat'"
 11.         di as txt "YEAR()    : `year'"
 12.         di as txt "ABSORB()  : `absorb'"
 13.         di as txt "SAMPLE()  : `sample'   SVAL(): `sval'"
 14.         di as txt "Weights   : weight=`weight' exp=`exp' wvar=`
> wvar' wtype=`wtype'"
 15.         di as txt "VCE()     : `vce'"
 16.         di as txt "BASEYEAR(): `baseyear'   NOCI: `noci'"
 17.         di as txt "SAVING()  : `saving'   REPLACE: `replace'"
 18.         di as txt "IF/IN     : `if' `in'"
 19.         di as txt "--------------------------------------------
> ----------------"
 20.     }
 21. 
.     // Requirements
.     capture which reghdfe
 22.     if _rc {
 23.         di as error "reghdfe not found. Install with: ssc insta
> ll reghdfe, replace"
 24.         exit 198
 25.     }
 26. 
.     // Mark sample
.     if `__dbg' di as txt "[Step 1] Marking estimation sample..."
 27.     marksample touse, strok
 28.     quietly replace `touse' = `touse' & !missing(`varlist', `ca
> t', `year')
 29.     if "`sample'" != "" quietly replace `touse' = `touse' & (`s
> ample' == `sval')
 30. 
.     quietly count if `touse'
 31.     if `__dbg' di as txt "  N (after filters): " %12.0gc r(N)
 32.     if r(N) == 0 {
 33.         di as error "No observations available after applying i
> f/in/sample filters."
 34.         exit 2000
 35.     }
 36. 
.     // Weights (default fw=perwt unless user passed weights)
.     if `__dbg' di as txt "[Step 2] Resolving weights..."
 37.     local wgt ""
 38.     if "`weight'" != "" {
 39.         local wgt "[`weight'=`exp']"
 40.         if `__dbg' di as txt "  Using caller-provided weights: 
> `wgt'"
 41.     }
 42.     else {
 43.         if "`wvar'" == "" local wvar "perwt"
 44.         if "`wtype'" == "" local wtype "fw"
 45.         capture confirm variable `wvar'
 46.         if _rc {
 47.             di as error "Default weight variable `wvar' not fou
> nd. Either create it or pass weights explicitly."
 48.             exit 111
 49.         }
 50.         local wgt "[`wtype'=`wvar']"
 51.         if `__dbg' di as txt "  Using default weights: `wgt'"
 52.     }
 53. 
.     // Ensure cat/year numeric for factor vars
.     if `__dbg' di as txt "[Step 3] Harmonizing CAT/YEAR types..."
 54.     tempvar __cat __year
 55.     local cattype : type `cat'
 56.     if substr("`cattype'",1,3) == "str" {
 57.         quietly encode `cat' if `touse', gen(`__cat')
 58.         local catv `__cat'
 59.         if `__dbg' di as txt "  Encoded string CAT -> `catv'"
 60.     }
 61.     else {
 62.         local catv `cat'
 63.         if `__dbg' di as txt "  CAT already numeric -> `catv'"
 64.     }
 65. 
.     local yeartype : type `year'
 66.     if substr("`yeartype'",1,3) == "str" {
 67.         quietly destring `year' if `touse', gen(`__year') force
 68.         capture assert !missing(`__year') if `touse'
 69.         if _rc {
 70.             di as error "Year variable is string and could not 
> be cleanly converted to numeric."
 71.             exit 459
 72.         }
 73.         local yearv `__year'
 74.         if `__dbg' di as txt "  Destring YEAR -> `yearv'"
 75.     }
 76.     else {
 77.         local yearv `year'
 78.         if `__dbg' di as txt "  YEAR already numeric -> `yearv'
> "
 79.     }
 80. 
.     // Guard: category variable should not also be absorbed
.     if `__dbg' di as txt "[Step 4] Validating absorb()..."
 81.     if regexm(" `absorb' ", " `catv' ") {
 82.         di as error "Category variable `catv' appears in absorb
> (): `absorb'. Remove it from absorb() for this run."
 83.         exit 198
 84.     }
 85. 
.     // Levels
.     if `__dbg' di as txt "[Step 5] Collecting year and category le
> vels..."
 86.     quietly levelsof `yearv' if `touse', local(yrs)
 87.     quietly levelsof `catv'  if `touse', local(cats)
 88. 
.     if `__dbg' {
 89.         di as txt "  Years: `yrs'"
 90.         di as txt "  Cats : `cats'"
 91.     }
 92. 
.     if "`yrs'" == "" | "`cats'" == "" {
 93.         di as error "No year or category levels found in estima
> tion sample."
 94.         exit 2000
 95.     }
 96. 
.     // Base year sanity check (optional)
.     if "`baseyear'" != "" {
 97.         if `__dbg' di as txt "[Step 5b] Checking baseyear()..."
 98.         local found = 0
 99.         foreach y of local yrs {
100.             if `y' == `baseyear' local found = 1
101.         }
102.         if `found' == 0 {
103.             di as error "baseyear(`baseyear') not found in esti
> mation sample years: `yrs'"
104.             exit 459
105.         }
106.         if `__dbg' di as txt "  baseyear OK: `baseyear'"
107.     }
108. 
.     // Regression
.     if `__dbg' di as txt "[Step 6] Running reghdfe..."
109.     if "`vce'" == "" local vce "robust"
110.     if `__dbg' {
111.         di as txt "  Command:"
112.         di as txt "    reghdfe `varlist' i.`catv'#i.`yearv' if 
> `touse' `wgt', absorb(`absorb') vce(`vce') nocons"
113.     }
114. 
.     quietly reghdfe `varlist' i.`catv'#i.`yearv' if `touse' `wgt',
>  ///
>         absorb(`absorb') vce(`vce') nocons
115. 
.     // Existing coefficient names
.     if `__dbg' di as txt "[Step 7] Extracting coefficients..."
116.     local bnames : colnames e(b)
117.     if `__dbg' {
118.         local nb : word count `bnames'
119.         di as txt "  # coefficients in e(b): `nb'"
120.     }
121.     if `__dbgdetail' {
122.         di as txt "  First up to 30 coef names:"
123.         local shown = 0
124.         foreach bn of local bnames {
125.             local ++shown
126.             di as txt "    `bn'"
127.             if `shown' >= 30 continue, break
128.         }
129.     }
130. 
.     // Critical value for CI (fallback to normal if df_r missing)
.     tempname crit
131.     capture scalar `crit' = invttail(e(df_r), 0.025)
132.     if _rc scalar `crit' = invnormal(0.975)
133.     if `__dbg' di as txt "  CI critical value used: " %9.4f sca
> lar(`crit')
134. 
.     // Post to temp dataset
.     if `__dbg' di as txt "[Step 8] Posting catyear coefficients t
> o a temp dataset..."
135.     tempfile coefdata
136.     tempname posth
137.     postfile `posth' int cat_level int year double b se ll ul u
> sing `coefdata', replace
138. 
.     local posted = 0
139.     foreach bn of local bnames {
140.         // Match: <c>.<catv>#<y>.<yearv>
.         if regexm("`bn'", "^([0-9]+)\.`catv'#([0-9]+)\.`yearv'$") 
> {
141.             local c = real(regexs(1))
142.             local y = real(regexs(2))
143. 
.             scalar __b  = _b[`bn']
144.             scalar __se = _se[`bn']
145.             scalar __ll = __b - scalar(`crit')*__se
146.             scalar __ul = __b + scalar(`crit')*__se
147. 
.             post `posth' (`c') (`y') (scalar(__b)) (scalar(__se)) 
> (scalar(__ll)) (scalar(__ul))
148.             local ++posted
149.         }
150.     }
151.     postclose `posth'
152. 
.     if `__dbg' di as txt "  Rows posted: `posted'"
153.     if `posted' == 0 {
154.         di as error "No catyear coefficients matched the expec
> ted naming pattern. Plot cannot be produced."
155.         exit 459
156.     }
157. 
.     preserve
158.         use `coefdata', clear
159. 
.         if `__dbgdetail' {
160.             di as txt "[DebugDetail] First 20 rows of coefficie
> nt dataset:"
161.             list in 1/20, abbrev(24)
162.         }
163. 
.         // Attach value label if exists
.         local vlab : value label `catv'
164.         if "`vlab'" != "" {
165.             label values cat_level `vlab'
166.             if `__dbg' di as txt "  Applied value label to cat_
> level: `vlab'"
167.         }
168. 
.         // Optional normalization to baseyear (within-category)
.         if "`baseyear'" != "" {
169.             if `__dbg' di as txt "[Step 9] Normalizing to basey
> ear(`baseyear')..."
170.             bysort cat_level: egen base_b = max(cond(year==`bas
> eyear', b, .))
171.             quietly count if missing(base_b)
172.             if r(N) > 0 {
173.                 di as error "Some categories have no observatio
> ns in baseyear(`baseyear'). Cannot normalize."
174.                 if `__dbgdetail' {
175.                     di as txt "Categories missing baseyear:"
176.                     bysort cat_level: gen __hasbase = !missing(
> base_b)
177.                     tab cat_level if __hasbase==0
178.                     drop __hasbase
179.                 }
180.                 exit 459
181.             }
182.             replace b  = b  - base_b
183.             replace ll = ll - base_b
184.             replace ul = ul - base_b
185.             drop base_b
186.         }
187. 
.         // Build twoway spec
.         if `__dbg' di as txt "[Step 10] Building plot command..."
188.         local plots ""
189.         local k = 0
190.         foreach c of local cats {
191.             quietly count if cat_level == `c'
192.             if r(N) == 0 continue
193. 
.             if "`noci'" == "" {
194.                 local plots `plots' (rcap ll ul year if cat_lev
> el==`c', sort)
195.                 local ++k
196.             }
197.             local plots `plots' (connected b year if cat_level=
> =`c', sort)
198.             local ++k
199.         }
200. 
.         if `__dbgdetail' {
201.             di as txt "  twoway plot spec (truncated to 200 cha
> rs):"
202.             local tmp = substr("`plots'", 1, 200)
203.             di as txt "    `tmp'..."
204.         }
205. 
.         // Titles
.         if "`xtitle'" == "" local xtitle `"`year'"'
206.         if "`ytitle'" == "" {
207.             if "`baseyear'" != "" local ytitle `"`varlist' (rel
> ative to `baseyear')"'
208.             else                 local ytitle `"`varlist' (adju
> sted mean)"'
209.         }
210.         if "`title'"  == "" local title  `"`varlist' by `cat' o
> ver `year'"'
211. 
.         if `__dbg' {
212.             di as txt "  xtitle: `xtitle'"
213.             di as txt "  ytitle: `ytitle'"
214.             di as txt "  title : `title'"
215.         }
216. 
.         // X axis labels: use actual year values present in the co
> ef dataset
.         levelsof year, local(xyrs)
217.         if `__dbg' di as txt "  X-axis years used: `xyrs'"
218. 
.         twoway `plots', ///
>             xtitle(`xtitle') ytitle(`ytitle') title(`title') ///
>             xlabel(`xyrs', angle(45)) ///
>             legend(position(6) cols(1))
219. 
.         // Save graph
.         if "`saving'" != "" {
220.             local savepath `"`saving'"'
221.             if !regexm(`"`savepath'"', "\.gph$") local savepath
>  `"`savepath'.gph"'
222.             if `__dbg' di as txt "[Step 11] Saving graph to: `s
> avepath'"
223.             graph save `"`savepath'"', `replace'
224.         }
225. 
.     restore
226. 
.     if `__dbg' {
227.         di as txt "hdfe_catyear_plot DEBUG END"
228.         di as txt "--------------------------------------------
> ----------------"
229.     }
230. end

. 
. 
. ** Load ACS Data 
. use "${data}working/acs_migration_file", replace 

. 
. ** Define sample 
. drop if qmigplc1 == 4                                   // FAILED 
> EDIT OF MIGPLACE 
(388,364 observations deleted)

. drop if inlist(state_fips_o, 2, 15)     // ALASKA AND HAWAII 
(136,571 observations deleted)

. 
. ** Define indicator for being in Multnomah County in origin/destin
> ation year
. gen multnomah_o = state_fips_o == 41 & county_fips_o == 51

. gen multnomah_d = state_fips_d == 41 & county_fips_d == 51

. 
. ** Define samples 
. gen sample_1 = multnomah_o == 1                                 //
>  Multnomah in origin-year 

. gen sample_2 = multnomah_o != 1                                 //
>  Not in Multnomah

. label var sample_1 "Out-migration Sample"

. label var sample_1 "In-migration Sample"

. 
. ** Define moving indicator 
. gen out_1 = same_county == 0 

. label var out_1 "Moved out of Multnomah"

. gen out_2 = multnomah_d == 1 

. label var out_2 "Moved to Multnomah"

. 
. ** Define variables of interest
. 
. ** Age 
. recode age      (18/24 = 1 "18-24")     ///
>                         (25/44 = 2 "25-44")             ///
>                         (45/64 = 3 "45-64")     ///
>                         (65/max = 4 "65+"),     ///
>         gen(cat_age)
(20,893,859 differences between age and cat_age)

. label var cat_age "Age categories"

. 
. ** Sex  
. gen cat_sex = sex == 2 

. label var cat_sex "Female indicator"

. label define lb_cat_sex 0 "Male" 1 "Female"

. label values cat_sex lb_cat_sex 

. 
. ** Marital Status               
. recode marst    (1 = 1 "Married")                               //
> /
>                                 (2/3 = 2 "Seperated")             
>       ///
>                                 (4/5 = 3 "Divourced / Widowed") //
> /
>                                 (6 = 4 "Single"),                 
>               ///
>         gen(cat_married)
(9,061,905 differences between marst and cat_married)

. label var cat_married "Marriage categories"

. 
. ** Kids at home 
. recode nchild   (0 = 0 "0 Children")                              
>       ///
>                                 (1 = 1 "1 Child")                 
>                               ///
>                                 (2 = 2 "2 Children")              
>                       ///
>                                 (3/max = 3 "3+ Children"),        
>                       ///
>         gen(cat_child)
(412,920 differences between nchild and cat_child)

. label var cat_child "Number of Children"

. 
. ** Education 
. recode educd    (min/61 = 1 "Less than HS")     ///
>                                 (62/71 = 2 "HS Diploma")          
>       ///
>                                 (80/100 = 3 "Some College")     //
> /
>                                 (101/max = 4 "College Degree"), //
> /
>         gen(cat_educ)
(20,893,859 differences between educd and cat_educ)

. label var cat_educ "Education categories"

. 
. ** Earnings / Income 
. gen tmp1 = cpi99 if year == 2023
(18,380,619 missing values generated)

. egen tmp2 = mean(tmp1)

. gen cpi =  cpi99 / tmp2 

. drop tmp1 tmp2 

. 
. ** Loop over income variables 
. foreach var of varlist inctot incwage incearn ftotinc {
  2.         
.         ** Update CPI 
.         gen real_`var' = round(`var' * cpi) 
  3.         
.         ** Categorical variables 
.         recode real_`var'       (min/-1 = 1 "Negative income")    
>       ///
>                                                 (0 = 2 "$0")      
>                                       ///
>                                                 (1/24999 = 3 "$1-$
> 25K")                         ///
>                                                 (25000/49999 = 4 "
> $25K-$50K")           ///
>                                                 (50000/99999 = 5 "
> $50K-$100K")          ///
>                                                 (100000/199999 = 6
>  "$100K-$200K")       ///
>                                                 (200000/max = 7 "$
> 200K+") ,             ///
>                         gen(cat_`var')
  4.                         
.         ** Tab
.         tab cat_`var', m 
  5.         
. }
(20,893,859 differences between real_inctot and cat_inctot)

      RECODE of |
    real_inctot |      Freq.     Percent        Cum.
----------------+-----------------------------------
Negative income |     20,759        0.10        0.10
             $0 |  1,748,089        8.37        8.47
        $1-$25K |  6,204,378       29.69       38.16
      $25K-$50K |  4,981,113       23.84       62.00
     $50K-$100K |  4,947,578       23.68       85.68
    $100K-$200K |  2,211,136       10.58       96.26
         $200K+ |    780,806        3.74      100.00
----------------+-----------------------------------
          Total | 20,893,859      100.00
(20,893,859 differences between real_incwage and cat_incwage)

      RECODE of |
   real_incwage |      Freq.     Percent        Cum.
----------------+-----------------------------------
             $0 |  8,182,418       39.16       39.16
        $1-$25K |  3,428,895       16.41       55.57
      $25K-$50K |  3,290,630       15.75       71.32
     $50K-$100K |  3,729,590       17.85       89.17
    $100K-$200K |  1,743,819        8.35       97.52
         $200K+ |    518,507        2.48      100.00
----------------+-----------------------------------
          Total | 20,893,859      100.00
(20,893,859 differences between real_incearn and cat_incearn)

      RECODE of |
   real_incearn |      Freq.     Percent        Cum.
----------------+-----------------------------------
Negative income |     16,135        0.08        0.08
             $0 |  7,365,326       35.25       35.33
        $1-$25K |  3,756,344       17.98       53.31
      $25K-$50K |  3,476,928       16.64       69.95
     $50K-$100K |  3,876,560       18.55       88.50
    $100K-$200K |  1,823,201        8.73       97.23
         $200K+ |    579,365        2.77      100.00
----------------+-----------------------------------
          Total | 20,893,859      100.00
(20,893,767 differences between real_ftotinc and cat_ftotinc)

      RECODE of |
   real_ftotinc |      Freq.     Percent        Cum.
----------------+-----------------------------------
Negative income |      7,238        0.03        0.03
             $0 |    226,387        1.08        1.12
        $1-$25K |  2,249,309       10.77       11.88
      $25K-$50K |  3,258,513       15.60       27.48
     $50K-$100K |  5,975,505       28.60       56.08
    $100K-$200K |  6,147,777       29.42       85.50
         $200K+ |  3,029,130       14.50      100.00
----------------+-----------------------------------
          Total | 20,893,859      100.00

. 
. ** Label variable 
. label var cat_inctot "Total personal income categories (real 2023 
> USD)"

. label var cat_incwage "Total wage income categories (real 2023 USD
> )"

. label var cat_incearn "Total earned income categories (real 2023 U
> SD)"

. label var cat_ftotinc "Total family income categories (real 2023 U
> SD)"

. 
. ** Local categorical variables
. local catvars "cat_sex cat_married cat_age cat_child cat_educ cat_
> ftotinc"

. 
. ** Loop over out- and in-migration 
. forvalues i = 1/2 {
  2.         
.         if `i' == 1 local ytitle_txt "Out-migration rate (%)"
  3.         if `i' == 2 local ytitle_txt "In-migration rate (%)"
  4. 
.         ** Loop over categories
.         foreach cat of local catvars {
  5.                 
.                 ** FEs 
.                 local othercats : list catvars - cat            
  6. 
.                 ** Run Regressions
.                 hdfe_catyear_plot out_`i' if sample_`i' == 1,     
>               ///
>                         cat(`cat')                                
>                                                       ///
>                         year(year)                                
>                                                       ///
>                         absorb(state_fips_o county_fips_o `otherca
> ts')          ///
>                         wvar(perwt) wtype(fw)                     
>                                       ///
>                         ytitle("`ytitle_txt'")                    
>                                       ///
>                         saving("${results}fig_`cat'_`i'") replace 
> debug 
  7.                 
.         } // END CAT LOOP
  8.         
. } // END SAMPLE LOOP 
invalid syntax
r(197);

end of do-file

r(197);

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_00003r.tmp"

. /*****************************************************************
> **************
> File Name:              02_indiv_analysis.do
> Creator:                John Iselin
> Date Update:    November 29, 2025
> 
> Called by: 00_multnomah.do
> 
> Purpose: Preform individual-level migration analysis. 
> 
> Authors: John Iselin 
> 
> For more information, contact john.iselin@yale.edu
> 
> ******************************************************************
> *************/
. 
. ** Start log file 
. capture log close log_02

. log using "${logs}02_log_individual_${date}", replace text name(lo
> g_02)
--------------------------------------------------------------------
      name:  log_02
       log:  C:/Users/ji252/Documents/GitHub/multnomah-county-tax/co
> de/logs/02_log_individual_2025-12-15.log
  log type:  text
 opened on:  16 Dec 2025, 10:32:06

. 
. ** Run Program 
. capture program drop hdfe_catyear_plot

. program define hdfe_catyear_plot
  1.     version 16.0
  2.     syntax varname(numeric) [if] [in] [fw aw pw iw] , ///
>         CAT(varname) YEAR(varname) ABSORB(string) ///
>         [ SAMPLE(varname) SVAL(real 1) ///
>           WVAR(varname) WTYPE(string) ///
>           VCE(string) ///
>           TITLE(string asis) XTITLE(string asis) YTITLE(string asi
> s) ///
>           NOCI ///
>           BASEYEAR(integer 0) ///
>           SAVING(string asis) REPLACE ///
>           DEBUG DEBUGDETAIL ]
  3. 
.                   
.     // ---------------------------
.     // Debug helpers
.     // ---------------------------
.         dis "test"
  4.     local __dbg = ("`debug'" != "" | "`debugdetail'" != "")
  5.     local __dbgdetail = ("`debugdetail'" != "")
  6. 
.     if `__dbg' {
  7.         di as txt "--------------------------------------------
> ----------------"
  8.         di as txt "hdfe_catyear_plot DEBUG START"
  9.         di as txt "Outcome   : `varlist'"
 10.         di as txt "CAT()     : `cat'"
 11.         di as txt "YEAR()    : `year'"
 12.         di as txt "ABSORB()  : `absorb'"
 13.         di as txt "SAMPLE()  : `sample'   SVAL(): `sval'"
 14.         di as txt "Weights   : weight=`weight' exp=`exp' wvar=`
> wvar' wtype=`wtype'"
 15.         di as txt "VCE()     : `vce'"
 16.         di as txt "BASEYEAR(): `baseyear'   NOCI: `noci'"
 17.         di as txt "SAVING()  : `saving'   REPLACE: `replace'"
 18.         di as txt "IF/IN     : `if' `in'"
 19.         di as txt "--------------------------------------------
> ----------------"
 20.     }
 21. 
.     // Requirements
.     capture which reghdfe
 22.     if _rc {
 23.         di as error "reghdfe not found. Install with: ssc insta
> ll reghdfe, replace"
 24.         exit 198
 25.     }
 26. 
.     // Mark sample
.     if `__dbg' di as txt "[Step 1] Marking estimation sample..."
 27.     marksample touse, strok
 28.     quietly replace `touse' = `touse' & !missing(`varlist', `ca
> t', `year')
 29.     if "`sample'" != "" quietly replace `touse' = `touse' & (`s
> ample' == `sval')
 30. 
.     quietly count if `touse'
 31.     if `__dbg' di as txt "  N (after filters): " %12.0gc r(N)
 32.     if r(N) == 0 {
 33.         di as error "No observations available after applying i
> f/in/sample filters."
 34.         exit 2000
 35.     }
 36. 
.     // Weights (default fw=perwt unless user passed weights)
.     if `__dbg' di as txt "[Step 2] Resolving weights..."
 37.     local wgt ""
 38.     if "`weight'" != "" {
 39.         local wgt "[`weight'=`exp']"
 40.         if `__dbg' di as txt "  Using caller-provided weights: 
> `wgt'"
 41.     }
 42.     else {
 43.         if "`wvar'" == "" local wvar "perwt"
 44.         if "`wtype'" == "" local wtype "fw"
 45.         capture confirm variable `wvar'
 46.         if _rc {
 47.             di as error "Default weight variable `wvar' not fou
> nd. Either create it or pass weights explicitly."
 48.             exit 111
 49.         }
 50.         local wgt "[`wtype'=`wvar']"
 51.         if `__dbg' di as txt "  Using default weights: `wgt'"
 52.     }
 53. 
.     // Ensure cat/year numeric for factor vars
.     if `__dbg' di as txt "[Step 3] Harmonizing CAT/YEAR types..."
 54.     tempvar __cat __year
 55.     local cattype : type `cat'
 56.     if substr("`cattype'",1,3) == "str" {
 57.         quietly encode `cat' if `touse', gen(`__cat')
 58.         local catv `__cat'
 59.         if `__dbg' di as txt "  Encoded string CAT -> `catv'"
 60.     }
 61.     else {
 62.         local catv `cat'
 63.         if `__dbg' di as txt "  CAT already numeric -> `catv'"
 64.     }
 65. 
.     local yeartype : type `year'
 66.     if substr("`yeartype'",1,3) == "str" {
 67.         quietly destring `year' if `touse', gen(`__year') force
 68.         capture assert !missing(`__year') if `touse'
 69.         if _rc {
 70.             di as error "Year variable is string and could not 
> be cleanly converted to numeric."
 71.             exit 459
 72.         }
 73.         local yearv `__year'
 74.         if `__dbg' di as txt "  Destring YEAR -> `yearv'"
 75.     }
 76.     else {
 77.         local yearv `year'
 78.         if `__dbg' di as txt "  YEAR already numeric -> `yearv'
> "
 79.     }
 80. 
.     // Guard: category variable should not also be absorbed
.     if `__dbg' di as txt "[Step 4] Validating absorb()..."
 81.     if regexm(" `absorb' ", " `catv' ") {
 82.         di as error "Category variable `catv' appears in absorb
> (): `absorb'. Remove it from absorb() for this run."
 83.         exit 198
 84.     }
 85. 
.     // Levels
.     if `__dbg' di as txt "[Step 5] Collecting year and category le
> vels..."
 86.     quietly levelsof `yearv' if `touse', local(yrs)
 87.     quietly levelsof `catv'  if `touse', local(cats)
 88. 
.     if `__dbg' {
 89.         di as txt "  Years: `yrs'"
 90.         di as txt "  Cats : `cats'"
 91.     }
 92. 
.     if "`yrs'" == "" | "`cats'" == "" {
 93.         di as error "No year or category levels found in estima
> tion sample."
 94.         exit 2000
 95.     }
 96. 
.     // Base year sanity check (optional)
.     if "`baseyear'" != "" {
 97.         if `__dbg' di as txt "[Step 5b] Checking baseyear()..."
 98.         local found = 0
 99.         foreach y of local yrs {
100.             if `y' == `baseyear' local found = 1
101.         }
102.         if `found' == 0 {
103.             di as error "baseyear(`baseyear') not found in esti
> mation sample years: `yrs'"
104.             exit 459
105.         }
106.         if `__dbg' di as txt "  baseyear OK: `baseyear'"
107.     }
108. 
.     // Regression
.     if `__dbg' di as txt "[Step 6] Running reghdfe..."
109.     if "`vce'" == "" local vce "robust"
110.     if `__dbg' {
111.         di as txt "  Command:"
112.         di as txt "    reghdfe `varlist' i.`catv'#i.`yearv' if 
> `touse' `wgt', absorb(`absorb') vce(`vce') nocons"
113.     }
114. 
.     quietly reghdfe `varlist' i.`catv'#i.`yearv' if `touse' `wgt',
>  ///
>         absorb(`absorb') vce(`vce') nocons
115. 
.     // Existing coefficient names
.     if `__dbg' di as txt "[Step 7] Extracting coefficients..."
116.     local bnames : colnames e(b)
117.     if `__dbg' {
118.         local nb : word count `bnames'
119.         di as txt "  # coefficients in e(b): `nb'"
120.     }
121.     if `__dbgdetail' {
122.         di as txt "  First up to 30 coef names:"
123.         local shown = 0
124.         foreach bn of local bnames {
125.             local ++shown
126.             di as txt "    `bn'"
127.             if `shown' >= 30 continue, break
128.         }
129.     }
130. 
.     // Critical value for CI (fallback to normal if df_r missing)
.     tempname crit
131.     capture scalar `crit' = invttail(e(df_r), 0.025)
132.     if _rc scalar `crit' = invnormal(0.975)
133.     if `__dbg' di as txt "  CI critical value used: " %9.4f sca
> lar(`crit')
134. 
.     // Post to temp dataset
.     if `__dbg' di as txt "[Step 8] Posting catyear coefficients t
> o a temp dataset..."
135.     tempfile coefdata
136.     tempname posth
137.     postfile `posth' int cat_level int year double b se ll ul u
> sing `coefdata', replace
138. 
.     local posted = 0
139.     foreach bn of local bnames {
140.         // Match: <c>.<catv>#<y>.<yearv>
.         if regexm("`bn'", "^([0-9]+)\.`catv'#([0-9]+)\.`yearv'$") 
> {
141.             local c = real(regexs(1))
142.             local y = real(regexs(2))
143. 
.             scalar __b  = _b[`bn']
144.             scalar __se = _se[`bn']
145.             scalar __ll = __b - scalar(`crit')*__se
146.             scalar __ul = __b + scalar(`crit')*__se
147. 
.             post `posth' (`c') (`y') (scalar(__b)) (scalar(__se)) 
> (scalar(__ll)) (scalar(__ul))
148.             local ++posted
149.         }
150.     }
151.     postclose `posth'
152. 
.     if `__dbg' di as txt "  Rows posted: `posted'"
153.     if `posted' == 0 {
154.         di as error "No catyear coefficients matched the expec
> ted naming pattern. Plot cannot be produced."
155.         exit 459
156.     }
157. 
.     preserve
158.         use `coefdata', clear
159. 
.         if `__dbgdetail' {
160.             di as txt "[DebugDetail] First 20 rows of coefficie
> nt dataset:"
161.             list in 1/20, abbrev(24)
162.         }
163. 
.         // Attach value label if exists
.         local vlab : value label `catv'
164.         if "`vlab'" != "" {
165.             label values cat_level `vlab'
166.             if `__dbg' di as txt "  Applied value label to cat_
> level: `vlab'"
167.         }
168. 
.         // Optional normalization to baseyear (within-category)
.         if `baseyear' != 0 {
169.             if `__dbg' di as txt "[Step 9] Normalizing to basey
> ear(`baseyear')..."
170.             bysort cat_level: egen base_b = max(cond(year==`bas
> eyear', b, .))
171.             quietly count if missing(base_b)
172.             if r(N) > 0 {
173.                 di as error "Some categories have no observatio
> ns in baseyear(`baseyear'). Cannot normalize."
174.                 if `__dbgdetail' {
175.                     di as txt "Categories missing baseyear:"
176.                     bysort cat_level: gen __hasbase = !missing(
> base_b)
177.                     tab cat_level if __hasbase==0
178.                     drop __hasbase
179.                 }
180.                 exit 459
181.             }
182.             replace b  = b  - base_b
183.             replace ll = ll - base_b
184.             replace ul = ul - base_b
185.             drop base_b
186.         }
187. 
.         // Build twoway spec
.         if `__dbg' di as txt "[Step 10] Building plot command..."
188.         local plots ""
189.         local k = 0
190.         foreach c of local cats {
191.             quietly count if cat_level == `c'
192.             if r(N) == 0 continue
193. 
.             if "`noci'" == "" {
194.                 local plots `plots' (rcap ll ul year if cat_lev
> el==`c', sort)
195.                 local ++k
196.             }
197.             local plots `plots' (connected b year if cat_level=
> =`c', sort)
198.             local ++k
199.         }
200. 
.         if `__dbgdetail' {
201.             di as txt "  twoway plot spec (truncated to 200 cha
> rs):"
202.             local tmp = substr("`plots'", 1, 200)
203.             di as txt "    `tmp'..."
204.         }
205. 
.         // Titles
.         if "`xtitle'" == "" local xtitle `"`year'"'
206.         if "`ytitle'" == "" {
207.             if `baseyear' != 0 local ytitle `"`varlist' (relati
> ve to `baseyear')"'
208.             else                 local ytitle `"`varlist' (adju
> sted mean)"'
209.         }
210.         if "`title'"  == "" local title  `"`varlist' by `cat' o
> ver `year'"'
211. 
.         if `__dbg' {
212.             di as txt "  xtitle: `xtitle'"
213.             di as txt "  ytitle: `ytitle'"
214.             di as txt "  title : `title'"
215.         }
216. 
.         // X axis labels: use actual year values present in the co
> ef dataset
.         levelsof year, local(xyrs)
217.         if `__dbg' di as txt "  X-axis years used: `xyrs'"
218. 
.         twoway `plots', ///
>             xtitle(`xtitle') ytitle(`ytitle') title(`title') ///
>             xlabel(`xyrs', angle(45)) ///
>             legend(position(6) cols(1))
219. 
.         // Save graph
.         if "`saving'" != "" {
220.             local savepath `"`saving'"'
221.             if !regexm(`"`savepath'"', "\.gph$") local savepath
>  `"`savepath'.gph"'
222.             if `__dbg' di as txt "[Step 11] Saving graph to: `s
> avepath'"
223.             graph save `"`savepath'"', `replace'
224.         }
225. 
.     restore
226. 
.     if `__dbg' {
227.         di as txt "hdfe_catyear_plot DEBUG END"
228.         di as txt "--------------------------------------------
> ----------------"
229.     }
230. end

. 
. 
. ** Load ACS Data 
. use "${data}working/acs_migration_file", replace 

. 
. ** Define sample 
. drop if qmigplc1 == 4                                   // FAILED 
> EDIT OF MIGPLACE 
(388,364 observations deleted)

. drop if inlist(state_fips_o, 2, 15)     // ALASKA AND HAWAII 
(136,571 observations deleted)

. 
. ** Define indicator for being in Multnomah County in origin/destin
> ation year
. gen multnomah_o = state_fips_o == 41 & county_fips_o == 51

. gen multnomah_d = state_fips_d == 41 & county_fips_d == 51

. 
. ** Define samples 
. gen sample_1 = multnomah_o == 1                                 //
>  Multnomah in origin-year 

. gen sample_2 = multnomah_o != 1                                 //
>  Not in Multnomah

. label var sample_1 "Out-migration Sample"

. label var sample_1 "In-migration Sample"

. 
. ** Define moving indicator 
. gen out_1 = same_county == 0 

. label var out_1 "Moved out of Multnomah"

. gen out_2 = multnomah_d == 1 

. label var out_2 "Moved to Multnomah"

. 
. ** Define variables of interest
. 
. ** Age 
. recode age      (18/24 = 1 "18-24")     ///
>                         (25/44 = 2 "25-44")             ///
>                         (45/64 = 3 "45-64")     ///
>                         (65/max = 4 "65+"),     ///
>         gen(cat_age)
(20,893,859 differences between age and cat_age)

. label var cat_age "Age categories"

. 
. ** Sex  
. gen cat_sex = sex == 2 

. label var cat_sex "Female indicator"

. label define lb_cat_sex 0 "Male" 1 "Female"

. label values cat_sex lb_cat_sex 

. 
. ** Marital Status               
. recode marst    (1 = 1 "Married")                               //
> /
>                                 (2/3 = 2 "Seperated")             
>       ///
>                                 (4/5 = 3 "Divourced / Widowed") //
> /
>                                 (6 = 4 "Single"),                 
>               ///
>         gen(cat_married)
(9,061,905 differences between marst and cat_married)

. label var cat_married "Marriage categories"

. 
. ** Kids at home 
. recode nchild   (0 = 0 "0 Children")                              
>       ///
>                                 (1 = 1 "1 Child")                 
>                               ///
>                                 (2 = 2 "2 Children")              
>                       ///
>                                 (3/max = 3 "3+ Children"),        
>                       ///
>         gen(cat_child)
(412,920 differences between nchild and cat_child)

. label var cat_child "Number of Children"

. 
. ** Education 
. recode educd    (min/61 = 1 "Less than HS")     ///
>                                 (62/71 = 2 "HS Diploma")          
>       ///
>                                 (80/100 = 3 "Some College")     //
> /
>                                 (101/max = 4 "College Degree"), //
> /
>         gen(cat_educ)
(20,893,859 differences between educd and cat_educ)

. label var cat_educ "Education categories"

. 
. ** Earnings / Income 
. gen tmp1 = cpi99 if year == 2023
(18,380,619 missing values generated)

. egen tmp2 = mean(tmp1)

. gen cpi =  cpi99 / tmp2 

. drop tmp1 tmp2 

. 
. ** Loop over income variables 
. foreach var of varlist inctot incwage incearn ftotinc {
  2.         
.         ** Update CPI 
.         gen real_`var' = round(`var' * cpi) 
  3.         
.         ** Categorical variables 
.         recode real_`var'       (min/-1 = 1 "Negative income")    
>       ///
>                                                 (0 = 2 "$0")      
>                                       ///
>                                                 (1/24999 = 3 "$1-$
> 25K")                         ///
>                                                 (25000/49999 = 4 "
> $25K-$50K")           ///
>                                                 (50000/99999 = 5 "
> $50K-$100K")          ///
>                                                 (100000/199999 = 6
>  "$100K-$200K")       ///
>                                                 (200000/max = 7 "$
> 200K+") ,             ///
>                         gen(cat_`var')
  4.                         
.         ** Tab
.         tab cat_`var', m 
  5.         
. }
(20,893,859 differences between real_inctot and cat_inctot)

      RECODE of |
    real_inctot |      Freq.     Percent        Cum.
----------------+-----------------------------------
Negative income |     20,759        0.10        0.10
             $0 |  1,748,089        8.37        8.47
        $1-$25K |  6,204,378       29.69       38.16
      $25K-$50K |  4,981,113       23.84       62.00
     $50K-$100K |  4,947,578       23.68       85.68
    $100K-$200K |  2,211,136       10.58       96.26
         $200K+ |    780,806        3.74      100.00
----------------+-----------------------------------
          Total | 20,893,859      100.00
(20,893,859 differences between real_incwage and cat_incwage)

      RECODE of |
   real_incwage |      Freq.     Percent        Cum.
----------------+-----------------------------------
             $0 |  8,182,418       39.16       39.16
        $1-$25K |  3,428,895       16.41       55.57
      $25K-$50K |  3,290,630       15.75       71.32
     $50K-$100K |  3,729,590       17.85       89.17
    $100K-$200K |  1,743,819        8.35       97.52
         $200K+ |    518,507        2.48      100.00
----------------+-----------------------------------
          Total | 20,893,859      100.00
(20,893,859 differences between real_incearn and cat_incearn)

      RECODE of |
   real_incearn |      Freq.     Percent        Cum.
----------------+-----------------------------------
Negative income |     16,135        0.08        0.08
             $0 |  7,365,326       35.25       35.33
        $1-$25K |  3,756,344       17.98       53.31
      $25K-$50K |  3,476,928       16.64       69.95
     $50K-$100K |  3,876,560       18.55       88.50
    $100K-$200K |  1,823,201        8.73       97.23
         $200K+ |    579,365        2.77      100.00
----------------+-----------------------------------
          Total | 20,893,859      100.00
(20,893,767 differences between real_ftotinc and cat_ftotinc)

      RECODE of |
   real_ftotinc |      Freq.     Percent        Cum.
----------------+-----------------------------------
Negative income |      7,238        0.03        0.03
             $0 |    226,387        1.08        1.12
        $1-$25K |  2,249,309       10.77       11.88
      $25K-$50K |  3,258,513       15.60       27.48
     $50K-$100K |  5,975,505       28.60       56.08
    $100K-$200K |  6,147,777       29.42       85.50
         $200K+ |  3,029,130       14.50      100.00
----------------+-----------------------------------
          Total | 20,893,859      100.00

. 
. ** Label variable 
. label var cat_inctot "Total personal income categories (real 2023 
> USD)"

. label var cat_incwage "Total wage income categories (real 2023 USD
> )"

. label var cat_incearn "Total earned income categories (real 2023 U
> SD)"

. label var cat_ftotinc "Total family income categories (real 2023 U
> SD)"

. 
. ** Local categorical variables
. local catvars "cat_sex cat_married cat_age cat_child cat_educ cat_
> ftotinc"

. 
. ** Loop over out- and in-migration 
. forvalues i = 1/2 {
  2.         
.         if `i' == 1 local ytitle_txt "Out-migration rate (%)"
  3.         if `i' == 2 local ytitle_txt "In-migration rate (%)"
  4. 
.         ** Loop over categories
.         foreach cat of local catvars {
  5.                 
.                 ** FEs 
.                 local othercats : list catvars - cat            
  6. 
.                 ** Run Regressions
.                 hdfe_catyear_plot out_`i' if sample_`i' == 1,     
>               ///
>                         cat(`cat')                                
>                                                       ///
>                         year(year)                                
>                                                       ///
>                         absorb(state_fips_o county_fips_o `otherca
> ts')          ///
>                         wvar(perwt) wtype(fw)                     
>                                       ///
>                         ytitle("`ytitle_txt'")                    
>                                       ///
>                         saving("${results}fig_`cat'_`i'") replace 
> debug 
  7.                 
.         } // END CAT LOOP
  8.         
. } // END SAMPLE LOOP 
test
------------------------------------------------------------
hdfe_catyear_plot DEBUG START
Outcome   : out_1
CAT()     : cat_sex
YEAR()    : year
ABSORB()  : state_fips_o county_fips_o cat_married cat_age cat_child
>  cat_educ cat_ftotinc
SAMPLE()  :    SVAL(): 1
Weights   : weight= exp= wvar=perwt wtype=fw
VCE()     : 
BASEYEAR(): 0   NOCI: 
SAVING()  : C: invalid name
r(198);

end of do-file

r(198);

. clear

. clear all

. do "C:\Users\ji252\AppData\Local\Temp\STD67b0_00003s.tmp"

. 
. ** Preliminaries 
. capture log close 
