-----------------------------------------------------------------------------------------------------------
      name:  log_02
       log:  C:/Users/ji252/Documents/GitHub/multnomah-county-tax/code/logs/02_log_individual_2026-02-06.lo
> g
  log type:  text
 opened on:   6 Feb 2026, 12:32:32

. 
. 
. ** ---------------------------------------------------------------------------
. ** Program: hdfe_catyear_plot
. **
. ** - Runs:      reghdfe y i.cat#i.year, absorb(...) nocons
. ** - Posts:     cell means and CIs for each cat×year coefficient
. ** - Plots:     one connected series per category + optional CI caps
. ** - Exports:   PDF via graph export
. **
. ** Notes:
. ** - Legend uses category VALUE LABELS. We store those labels immediately after
. **   levelsof (before moving into the posted coefficient dataset) to avoid any
. **   issues from dataset swaps.
. ** - CI and line use the same color; CI uses 50% opacity.
. ** ---------------------------------------------------------------------------
. ** ---------------------------------------------------------------------------
. ** Program: hdfe_catyear_plot
. **
. ** Purpose:
. **   1) Run reghdfe with a CAT × YEAR interaction and absorbed fixed effects.
. **   2) Use margins (rather than reghdfe coefficients) to compute conditional means:
. **        margins i.CAT, over(YEAR)
. **   3) Plot margins by YEAR with one series per CAT (CI optional).
. **
. ** Notes:
. **   - baseyear(0) => plot levels (conditional means).
. **   - baseyear(#) => plot within-CAT differences relative to that year.
. ** ---------------------------------------------------------------------------
. capture program drop hdfe_catyear_plot

. program define hdfe_catyear_plot
  1.     version 16.0
  2. 
.     syntax varname(numeric) [if] [in] [fw aw pw iw] , ///
>         CAT(varname) YEAR(varname) ABSORB(string) ///
>         [ WVAR(varname) WTYPE(string) ///
>           VCE(string) ///
>           TITLE(string) XTITLE(string) YTITLE(string) ///
>           NOCI ///
>           BASEYEAR(integer 0) ///
>           SAVING(string) REPLACE ///
>           DEBUG DEBUGDETAIL ]
  3. 
.     ** -----------------------------------------------------------------------
.     ** Configuration: project root for relative paths
.     ** -----------------------------------------------------------------------
.     local __project_root "C:/Users/ji252/Documents/GitHub/multnomah-county-tax/"
  4. 
.     ** -----------------------------------------------------------------------
.     ** Debug flags
.     ** -----------------------------------------------------------------------
.     local __dbg 0
  5.     local __dbgdetail 0
  6.     if "`debug'" != "" local __dbg 1
  7.     if "`debugdetail'" != "" {
  8.         local __dbg 1
  9.         local __dbgdetail 1
 10.     }
 11. 
.     if `__dbg' {
 12.         di as txt "------------------------------------------------------------"
 13.         di as txt "hdfe_catyear_plot DEBUG START"
 14.         di as txt "Outcome   : `varlist'"
 15.         di as txt "CAT()     : `cat'"
 16.         di as txt "YEAR()    : `year'"
 17.         di as txt "ABSORB()  : `absorb'"
 18.         di as txt "Weights   : weight=`weight' exp=`exp' wvar=`wvar' wtype=`wtype'"
 19.         di as txt "VCE()     : `vce'"
 20.         di as txt "BASEYEAR(): `baseyear'   NOCI: `noci'"
 21.         di as txt "SAVING()  : `saving'   REPLACE: `replace'"
 22.         di as txt "IF/IN     : `if' `in'"
 23.         di as txt "------------------------------------------------------------"
 24.     }
 25. 
.     ** -----------------------------------------------------------------------
.     ** Requirements
.     ** -----------------------------------------------------------------------
.     capture which reghdfe
 26.     if _rc {
 27.         di as error "reghdfe not found. Install with: ssc install reghdfe, replace"
 28.         exit 198
 29.     }
 30. 
.     ** -----------------------------------------------------------------------
.     ** Mark sample
.     ** -----------------------------------------------------------------------
.     if `__dbg' di as txt "[Step 1] Marking estimation sample..."
 31.     marksample touse, strok
 32.     quietly replace `touse' = `touse' & !missing(`varlist', `cat', `year')
 33. 
.     quietly count if `touse'
 34.     if `__dbg' di as txt "  N (after filters): " %12.0gc r(N)
 35.     if r(N) == 0 {
 36.         di as error "No observations available after applying if/in filters."
 37.         exit 2000
 38.     }
 39. 
.     ** -----------------------------------------------------------------------
.     ** Weights (default fw=perwt unless caller provided weights)
.     ** -----------------------------------------------------------------------
.     if `__dbg' di as txt "[Step 2] Resolving weights..."
 40.     local wgt ""
 41.     if "`weight'" != "" {
 42.         local wgt "[`weight'=`exp']"
 43.         if `__dbg' di as txt "  Using caller-provided weights: `wgt'"
 44.     }
 45.     else {
 46.         if "`wvar'"  == "" local wvar  "perwt"
 47.         if "`wtype'" == "" local wtype "fw"
 48.         capture confirm variable `wvar'
 49.         if _rc {
 50.             di as error "Default weight variable `wvar' not found. Either create it or pass weights ex
> plicitly."
 51.             exit 111
 52.         }
 53.         local wgt "[`wtype'=`wvar']"
 54.         if `__dbg' di as txt "  Using default weights: `wgt'"
 55.     }
 56. 
.     ** -----------------------------------------------------------------------
.     ** Ensure CAT/YEAR numeric for factor variables
.     ** -----------------------------------------------------------------------
.     if `__dbg' di as txt "[Step 3] Harmonizing CAT/YEAR types..."
 57.     tempvar __cat __year
 58. 
.     local cattype : type `cat'
 59.     if substr("`cattype'", 1, 3) == "str" {
 60.         quietly encode `cat' if `touse', gen(`__cat')
 61.         local catv `__cat'
 62.         if `__dbg' di as txt "  Encoded string CAT -> `catv'"
 63.     }
 64.     else {
 65.         local catv `cat'
 66.         if `__dbg' di as txt "  CAT already numeric -> `catv'"
 67.     }
 68. 
.     local yeartype : type `year'
 69.     if substr("`yeartype'", 1, 3) == "str" {
 70.         quietly destring `year' if `touse', gen(`__year') force
 71.         capture assert !missing(`__year') if `touse'
 72.         if _rc {
 73.             di as error "Year variable is string and could not be cleanly converted to numeric."
 74.             exit 459
 75.         }
 76.         local yearv `__year'
 77.         if `__dbg' di as txt "  Destring YEAR -> `yearv'"
 78.     }
 79.     else {
 80.         local yearv `year'
 81.         if `__dbg' di as txt "  YEAR already numeric -> `yearv'"
 82.     }
 83. 
.     ** -----------------------------------------------------------------------
.     ** Guard: CAT should not also be absorbed
.     ** -----------------------------------------------------------------------
.     if `__dbg' di as txt "[Step 4] Validating absorb()..."
 84.     if regexm(" `absorb' ", " `catv' ") {
 85.         di as error "Category variable `catv' appears in absorb(): `absorb'. Remove it from absorb() f
> or this run."
 86.         exit 198
 87.     }
 88. 
.     ** -----------------------------------------------------------------------
.     ** Levels and labels (save labels NOW, before switching datasets)
.     ** -----------------------------------------------------------------------
.     if `__dbg' di as txt "[Step 5] Collecting year and category levels..."
 89.     quietly levelsof `yearv' if `touse', local(yrs)
 90.     quietly levelsof `catv'  if `touse', local(cats)
 91.     local vlab : value label `catv'
 92. 
.     if "`yrs'" == "" | "`cats'" == "" {
 93.         di as error "No year or category levels found in estimation sample."
 94.         exit 2000
 95.     }
 96. 
.     if `__dbg' {
 97.         di as txt "  Years: `yrs'"
 98.         di as txt "  Cats : `cats'"
 99.         di as txt "  CAT value label: `vlab'"
100.     }
101. 
.     ** Save category label text into locals (avoids label-loss during preserve/use)
.     foreach c of local cats {
102.         local __key "`c'"
103.         local __key : subinstr local __key "-" "m", all
104. 
.         local __lab "`c'"
105.         if "`vlab'" != "" {
106.             local __tmp : label `vlab' `c'
107.             if "`__tmp'" != "" local __lab "`__tmp'"
108.         }
109.         local __lab : subinstr local __lab `"""' "", all
110.         local __lab_`__key' "`__lab'"
111.     }   // END CAT LABEL SAVE LOOP
112. 
.     ** -----------------------------------------------------------------------
.     ** Base year sanity check (only if baseyear != 0)
.     ** -----------------------------------------------------------------------
.     if `baseyear' != 0 {
113.         if `__dbg' di as txt "[Step 5b] Checking baseyear()..."
114.         local found 0
115.         foreach y of local yrs {
116.             if `y' == `baseyear' local found 1
117.         }
118.         if `found' == 0 {
119.             di as error "baseyear(`baseyear') not found in estimation sample years: `yrs'"
120.             exit 459
121.         }
122.         if `__dbg' di as txt "  baseyear OK: `baseyear'"
123.     }   // END BASEYEAR CHECK
124. 
.     ** -----------------------------------------------------------------------
.     ** Regression (supports margins over CAT × YEAR)
.     ** -----------------------------------------------------------------------
.     if `__dbg' di as txt "[Step 6] Running reghdfe..."
125.     if "`vce'" == "" local vce "robust"
126.     if `__dbg' {
127.         di as txt "  Command:"
128.         di as txt "    reghdfe `varlist' i.`catv'##i.`yearv' if `touse' `wgt', absorb(`absorb') vce(`v
> ce')"
129.     }
130. 
.     quietly reghdfe `varlist' i.`catv'##i.`yearv' if `touse' `wgt', ///
>         absorb(`absorb') vce(`vce')
131. 
.     ** -----------------------------------------------------------------------
.     ** Margins: conditional means by CAT over YEAR (save to dataset)
.     ** -----------------------------------------------------------------------
.     if `__dbg' di as txt "[Step 7] Computing margins and saving results..."
132.     tempfile __margdata
133.     quietly margins, at(`catv'=(`cats') `yearv'=(`yrs')) saving(`__margdata', replace) post
134. 
.     ** -----------------------------------------------------------------------
.     ** Plot using the saved margins dataset
.     ** -----------------------------------------------------------------------
.     preserve
135. 
.         use `__margdata', clear
136. 
.         ** Identify CAT and YEAR columns in margins output
.         ** We compute margins using at(): at(cat levels × year levels). The saved dataset
.         ** therefore stores the grid in _at1 (cat) and _at2 (year) in the order supplied.
.         capture confirm variable _at1
137.         if _rc {
138.             di as error "margins output missing _at1. Ensure margins is called with: margins, at(`catv
> '=(`cats') `yearv'=(`yrs')) saving(...)"
139.             exit 459
140.         }
141.         capture confirm variable _at2
142.         if _rc {
143.             di as error "margins output missing _at2. Ensure margins is called with: margins, at(`catv
> '=(`cats') `yearv'=(`yrs')) saving(...)"
144.             exit 459
145.         }
146. 
.         ** Standardize variable names
.         rename _at1 cat_level
147.         rename _at2 year
148. 
.         capture confirm variable _margin
149.         if _rc {
150.             di as error "margins output missing _margin. Cannot proceed."
151.             exit 459
152.         }
153.         rename _margin b
154. 
.         capture confirm variable _se_margin
155.         if !_rc rename _se_margin se
156.         else {
157.             capture confirm variable _se
158.             if !_rc rename _se se
159.         }
160. 
.         capture confirm variable _ci_lb
161.         if !_rc rename _ci_lb ll
162.         capture confirm variable _ci_ub
163.         if !_rc rename _ci_ub ul
164. if `__dbgdetail' {
165.             di as txt "[DebugDetail] First 8 rows of margins dataset:"
166.             list in 1/8, abbrev(24)
167.         }
168. 
.         ** Ensure year is numeric and sorted
.         capture confirm numeric variable year
169.         if _rc {
170.             di as error "Year in margins dataset is not numeric; cannot plot on x-axis."
171.             exit 459
172.         }
173. 
.         ** Optional normalization to baseyear (within-category)
.         if `baseyear' != 0 {
174.             if `__dbg' di as txt "[Step 8] Normalizing margins to baseyear(`baseyear')..."
175.             bysort cat_level: egen base_b = max(cond(year==`baseyear', b, .))
176.             quietly count if missing(base_b)
177.             if r(N) > 0 {
178.                 di as error "Some categories have no observations in baseyear(`baseyear'). Cannot norm
> alize."
179.                 exit 459
180.             }
181.             replace b  = b  - base_b
182.             capture confirm variable ll
183.             if !_rc replace ll = ll - base_b
184.             capture confirm variable ul
185.             if !_rc replace ul = ul - base_b
186.             drop base_b
187.         }   // END BASEYEAR NORMALIZATION
188. 
.         ** X axis labels (years present in margins results)
.         levelsof year, local(xyrs)
189.         if `__dbg' di as txt "  X-axis years used: `xyrs'"
190. 
.         ** -------------------------------------------------------------------
.         ** Plot styling: use plotplainblind palette if available (scheme-level)
.         ** -------------------------------------------------------------------
.         local __oldscheme "`c(scheme)'"
191.         capture set scheme plotplainblind
192.         if _rc {
193.             if `__dbg' di as txt "  plotplainblind scheme not available; using current scheme: `__olds
> cheme'"
194.         }
195.         else {
196.             if `__dbg' di as txt "  Using scheme: plotplainblind (was `__oldscheme')"
197.         }
198. 
.         ** -------------------------------------------------------------------
.         ** Build twoway spec + legend mapping (one label per series)
.         **   - CI and line share the same pstyle; CI uses 50% opacity.
.         ** -------------------------------------------------------------------
.         if `__dbg' di as txt "[Step 9] Building plot command..."
199.         local plots ""
200.         local leg_order ""
201.         local leg_labels ""
202.         local pnum 0
203. 
.         local cats_n : word count `cats'
204.         local legrows 1
205.         if `cats_n' > 4 local legrows 2
206. 
.         local i 0
207.         foreach c of local cats {
208.             quietly count if cat_level == `c'
209.             if r(N) == 0 continue
210. 
.             local ++i
211.             local pstyle "p`i'"
212. 
.             ** Retrieve pre-saved label text (safe key)
.             local __key "`c'"
213.             local __key : subinstr local __key "-" "m", all
214.             local serieslab "`__lab_`__key''"
215. 
.             ** CI (excluded from legend)
.             if "`noci'" == "" {
216.                 local ++pnum
217.                 local plots `plots' ///
>                     (rcap ll ul year if cat_level==`c', sort ///
>                         pstyle(`pstyle') lcolor(%50))
218.             }
219. 
.             ** Line (in legend)
.             local ++pnum
220.             local plots `plots' ///
>                 (connected b year if cat_level==`c', sort ///
>                     pstyle(`pstyle') lp(solid) msym(O) )
221. 
.             local leg_order  `leg_order' `pnum'
222.             local leg_labels `leg_labels' label(`pnum' `serieslab')
223.         }   // END CATEGORY PLOT LOOP
224. 
.         if `"`plots'"' == `""' {
225.             di as error "No series were built for plotting (plotspec empty)."
226.             exit 2000
227.         }
228. 
.         if `__dbgdetail' {
229.             di as txt "  legend order: `leg_order'"
230.             di as txt "  legend labels: `leg_labels'"
231.             di as txt "  legend rows: `legrows'"
232.         }
233. 
.         ** -------------------------------------------------------------------
.         ** Titles (safe quoting)
.         ** -------------------------------------------------------------------
.         local xtitle_input ""
234.         local ytitle_input ""
235.         local title_input  ""
236. 
.         if `"`xtitle'"' == `""' local xtitle_input "xtitle(Year)"
237.         else                    local xtitle_input `"xtitle(`"`xtitle'"')"'
238. 
.         if `"`ytitle'"' == `""' {
239.             if `baseyear' != 0 local ytitle_input `"ytitle(`"`varlist' (relative to `baseyear')"')"'
240.             else              local ytitle_input `"ytitle(`"`varlist' (adjusted mean)"')"'
241.         }
242.         else {
243.             local ytitle_input `"ytitle(`"`ytitle'"')"'
244.         }
245. 
.         if `"`title'"' != `""' local title_input `"title(`"`title'"')"'
246. 
.                 ** ------------------------------------------------------------
.                 ** Y-axis: round "nice" ticks (e.g., 0,2,4,6,8,10)
.                 ** Uses CI bounds to set max, then rounds to a nice step.
.                 ** ------------------------------------------------------------
. 
.                 quietly summarize ll, meanonly
247.                 local __ymin = r(min)
248. 
.                 quietly summarize ul, meanonly
249.                 local __ymax = r(max)
250. 
.                 ** Always include 0 on axis
.                 if `__ymin' > 0 local __ymin = 0
251.                 if `__ymax' < 0 local __ymax = 0
252. 
.                 ** If plotting levels (baseyear==0), anchor at 0
.                 if `baseyear' == 0 local __ymin = 0
253. 
.                 ** Add a little headroom (5%)
.                 local __ymax = `__ymax' * 1.05
254. 
.                 ** Decide on a "nice" step aiming for ~5 intervals
.                 local __span = `__ymax' - `__ymin'
255.                 if `__span' <= 0 local __span = 1
256. 
.                 local __rawstep = `__span'/5
257. 
.                 ** Snap step to {1,2,5} * 10^k
.                 local __k = floor(log10(`__rawstep'))
258.                 local __base = 10^`__k'
259.                 local __mant = `__rawstep'/`__base'
260. 
.                 local __m = 1
261.                 if `__mant' > 1  local __m = 2
262.                 if `__mant' > 2  local __m = 5
263.                 if `__mant' > 5  local __m = 10
264. 
.                 local __ystep = `__m' * `__base'
265. 
.                 ** Round max up to nearest multiple of step; min down similarly
.                 local __yhigh = ceil(`__ymax'/`__ystep') * `__ystep'
266.                 local __ylow  = floor(`__ymin'/`__ystep') * `__ystep'
267. 
.                 ** For levels, ensure bottom is exactly 0
.                 if `baseyear' == 0 local __ylow = 0
268. 
.                 local __yaxis_opts `"yscale(range(`__ylow' `__yhigh')) ylabel(`__ylow'(`__ystep')`__yhigh
> ')"'
269. 
.         twoway `plots', ///
>             `xtitle_input' ///
>             `ytitle_input' ///
>             `title_input' ///
>             xlabel(`xyrs', angle(45)) ///
>                         `__yaxis_opts' ///           
>                         legend(order(`leg_order') `leg_labels' rows(`legrows') position(6)) 
270. 
.         ** Restore scheme (if we successfully switched)
.         capture set scheme `__oldscheme'
271. 
.         ** -------------------------------------------------------------------
.         ** Export figure (PDF) - robust path handling
.         ** -------------------------------------------------------------------
.         if "`saving'" != "" {
272. 
.             local outpath `"`saving'"'
273.             local outpath : subinstr local outpath `"""' "", all
274.             local outpath : subinstr local outpath "\" "/" , all
275. 
.             ** Prepend project root if relative
.             if !regexm("`outpath'", "^[A-Za-z]:/") & substr("`outpath'", 1, 1) != "/" {
276.                 local outpath "`__project_root'`outpath'"
277.             }
278. 
.             ** Ensure .pdf extension
.             if !regexm("`outpath'", "\.pdf$") local outpath "`outpath'.pdf"
279. 
.             ** Ensure output directory exists
.             local p = strrpos("`outpath'", "/")
280.             if `p' > 0 {
281.                 local outdir = substr("`outpath'", 1, `p' - 1)
282.                 if !direxists("`outdir'") {
283.                     if `__dbg' di as txt "  Creating output directory: `outdir'"
284.                     capture mkdir "`outdir'"
285.                     if _rc & !direxists("`outdir'") {
286.                         di as error "Output directory does not exist and could not be created: `outdir
> '"
287.                         exit 601
288.                     }
289.                 }
290.             }
291. 
.             if `__dbg' di as txt "[Step 10] Exporting graph to: `outpath'"
292. 
.             if "`replace'" != "" graph export "`outpath'", as(pdf) replace
293.             else                graph export "`outpath'", as(pdf)
294. 
.         }   // END PDF EXPORT
295. 
.     restore    // END PRESERVE BLOCK
296. 
.     if `__dbg' {
297.         di as txt "hdfe_catyear_plot DEBUG END"
298.         di as txt "------------------------------------------------------------"
299.     }
300. 
. end

. 
. ** ---------------------------------------------------------------------------
. ** Load ACS migration data
. ** ---------------------------------------------------------------------------
. use "${data}working/acs_migration_file", replace

. 
. ** Sample restrictions
. drop if year == 2015                                    // Sample: 2016-2024
(2,334,973 observations deleted)

. drop if qmigplc1 == 4                                   // Error in migration place 
(401,283 observations deleted)

. drop if inlist(state_fips_o, 2, 15)     // Alaska and Hawaii
(137,699 observations deleted)

. drop if inlist(state_fips_d, 2, 15)     // Alaska and Hawaii
(3,633 observations deleted)

. drop if ftotinc < 0                                     // Negative Family Income       
(7,571 observations deleted)

. drop if age < 25                                                // Dropping under 25
(1,813,595 observations deleted)

. 
. ** ---------------------------------------------------------------------------
. ** Multnomah indicators and samples
. ** ---------------------------------------------------------------------------
. gen multnomah_o = (state_fips_o == 41 & county_fips_o == 51)

. gen multnomah_d = (state_fips_d == 41 & county_fips_d == 51)

. 
. gen sample_1 = (multnomah_o == 1)      // Multnomah in origin-year

. gen sample_2 = (multnomah_o != 1)      // Not Multnomah in origin-year

. label var sample_1 "Out-migration Sample"

. label var sample_2 "In-migration Sample"

. 
. gen out_1 = (same_county == 0)

. replace out_1 = out_1 * 100
(538,681 real changes made)

. label var out_1 "Moved out of Multnomah"

. 
. gen out_2 = (multnomah_d == 1)

. replace out_2 = out_2 * 100 
(47,795 real changes made)

. label var out_2 "Moved to Multnomah"

. 
. 
. ** ---------------------------------------------------------------------------
. ** Covariate categories
. ** ---------------------------------------------------------------------------
. 
. ** Age
. recode age ///
>     (25/44   = 1 "25-44") ///
>     (45/64   = 2 "45-64") ///
>     (65/max  = 3 "65+"), ///
>     gen(cat_age)
(19,316,283 differences between age and cat_age)

. label var cat_age "Age categories"

. tab year cat_age, m 

           |          Age categories
      year |     25-44      45-64        65+ |     Total
-----------+---------------------------------+----------
      2016 |   681,232    846,523    558,580 | 2,086,335 
      2017 |   696,216    844,761    566,503 | 2,107,480 
      2018 |   699,682    839,747    593,206 | 2,132,635 
      2019 |   701,941    842,626    631,905 | 2,176,472 
      2020 |   561,063    658,321    517,867 | 1,737,251 
      2021 |   709,754    814,479    666,776 | 2,191,009 
      2022 |   733,853    829,567    699,446 | 2,262,866 
      2023 |   742,050    827,783    732,956 | 2,302,789 
      2024 |   747,111    818,947    753,388 | 2,319,446 
-----------+---------------------------------+----------
     Total | 6,272,902  7,322,754  5,720,627 |19,316,283 

. 
. ** Sex
. gen cat_sex = (sex == 2)

. label var cat_sex "Female indicator"

. label define lb_cat_sex 0 "Male" 1 "Female", replace

. label values cat_sex lb_cat_sex

. tab year cat_sex, m 

           |   Female indicator
      year |      Male     Female |     Total
-----------+----------------------+----------
      2016 |   985,296  1,101,039 | 2,086,335 
      2017 |   997,918  1,109,562 | 2,107,480 
      2018 | 1,011,314  1,121,321 | 2,132,635 
      2019 | 1,033,269  1,143,203 | 2,176,472 
      2020 |   827,083    910,168 | 1,737,251 
      2021 | 1,040,856  1,150,153 | 2,191,009 
      2022 | 1,074,312  1,188,554 | 2,262,866 
      2023 | 1,093,921  1,208,868 | 2,302,789 
      2024 | 1,101,922  1,217,524 | 2,319,446 
-----------+----------------------+----------
     Total | 9,165,891 10,150,392 |19,316,283 

. 
. ** Marital status
. recode marst ///
>     (1       = 1 "Married") ///
>     (2/3     = 2 "Separated") ///
>     (4/5     = 3 "Divorced / Widowed") ///
>     (6       = 4 "Single"), ///
>     gen(cat_married)
(7,510,801 differences between marst and cat_married)

. label var cat_married "Marriage categories"

. tab year cat_married, m 

           |             Marriage categories
      year |   Married  Separated  Divorced      Single |     Total
-----------+--------------------------------------------+----------
      2016 | 1,246,569     76,410    412,097    351,259 | 2,086,335 
      2017 | 1,258,859     77,348    411,969    359,304 | 2,107,480 
      2018 | 1,270,842     77,788    417,512    366,493 | 2,132,635 
      2019 | 1,296,192     76,315    428,592    375,373 | 2,176,472 
      2020 | 1,036,515     58,080    334,135    308,521 | 1,737,251 
      2021 | 1,286,638     75,252    428,008    401,111 | 2,191,009 
      2022 | 1,337,299     76,534    438,082    410,951 | 2,262,866 
      2023 | 1,357,438     78,034    446,635    420,682 | 2,302,789 
      2024 | 1,362,975     80,186    447,137    429,148 | 2,319,446 
-----------+--------------------------------------------+----------
     Total |11,453,327    675,947  3,764,167  3,422,842 |19,316,283 

. 
. ** Kids at home
. recode nchild ///
>     (0       = 0 "0 Children") ///
>     (1       = 1 "1 Child") ///
>     (2       = 2 "2 Children") ///
>     (3/max   = 3 "3+ Children"), ///
>     gen(cat_child)
(410,461 differences between nchild and cat_child)

. label var cat_child "Number of Children"

. tab year cat_child, m 

           |             Number of Children
      year | 0 Childre    1 Child  2 Childre  3+ Childr |     Total
-----------+--------------------------------------------+----------
      2016 | 1,265,045    387,964    278,328    154,998 | 2,086,335 
      2017 | 1,278,151    391,173    282,188    155,968 | 2,107,480 
      2018 | 1,303,016    393,135    282,176    154,308 | 2,132,635 
      2019 | 1,347,631    397,666    278,666    152,509 | 2,176,472 
      2020 | 1,071,806    317,831    225,864    121,750 | 1,737,251 
      2021 | 1,357,620    399,889    280,928    152,572 | 2,191,009 
      2022 | 1,406,651    412,943    287,656    155,616 | 2,262,866 
      2023 | 1,439,922    417,603    289,925    155,339 | 2,302,789 
      2024 | 1,452,178    422,685    290,790    153,793 | 2,319,446 
-----------+--------------------------------------------+----------
     Total |11,922,020  3,540,889  2,496,521  1,356,853 |19,316,283 

.  
. ** Age of youngest kid at home
. recode yngch ///
>     (99      = 0 "0 Children") ///
>     (0/4     = 1 "0-4") ///
>     (5/12    = 2 "5-12") ///
>     (13/17   = 3 "13-17")       ///
>         (18/max   = 4 "18+"), ///
>     gen(cat_yngch)
(18,931,365 differences between yngch and cat_yngch)

. label var cat_yngch "Age of youngest child"

. tab year cat_yngch, m 

           |                 Age of youngest child
      year | 0 Childre        0-4       5-12      13-17        18+ |     Total
-----------+-------------------------------------------------------+----------
      2016 | 1,265,045    190,397    226,565    133,962    270,366 | 2,086,335 
      2017 | 1,278,151    194,111    228,166    134,815    272,237 | 2,107,480 
      2018 | 1,303,016    193,389    224,601    134,371    277,258 | 2,132,635 
      2019 | 1,347,631    190,799    221,910    133,393    282,739 | 2,176,472 
      2020 | 1,071,806    149,566    175,026    106,686    234,167 | 1,737,251 
      2021 | 1,357,620    185,632    219,365    135,593    292,799 | 2,191,009 
      2022 | 1,406,651    190,603    227,079    140,003    298,530 | 2,262,866 
      2023 | 1,439,922    189,377    226,827    138,903    307,760 | 2,302,789 
      2024 | 1,452,178    187,207    226,289    137,754    316,018 | 2,319,446 
-----------+-------------------------------------------------------+----------
     Total |11,922,020  1,671,081  1,975,828  1,195,480  2,551,874 |19,316,283 

. 
. ** Education
. recode educd ///
>     (min/61  = 1 "Less than HS") ///
>     (62/71   = 2 "HS Diploma") ///
>     (80/100  = 3 "Some College") ///
>     (101/max = 4 "College Degree"), ///
>     gen(cat_educ)
(19,316,283 differences between educd and cat_educ)

. label var cat_educ "Education categories"

. tab year cat_educ, m 

           |            Education categories
      year | Less than  HS Diplom  Some Coll  College D |     Total
-----------+--------------------------------------------+----------
      2016 |   233,839    988,472    180,050    683,974 | 2,086,335 
      2017 |   223,022    989,424    185,574    709,460 | 2,107,480 
      2018 |   217,254    995,303    190,159    729,919 | 2,132,635 
      2019 |   211,611  1,005,357    194,842    764,662 | 2,176,472 
      2020 |   159,539    788,718    157,250    631,744 | 1,737,251 
      2021 |   206,721    987,206    196,644    800,438 | 2,191,009 
      2022 |   203,911  1,010,494    205,172    843,289 | 2,262,866 
      2023 |   204,039  1,023,290    209,472    865,988 | 2,302,789 
      2024 |   199,902  1,019,323    212,409    887,812 | 2,319,446 
-----------+--------------------------------------------+----------
     Total | 1,859,838  8,807,587  1,731,572  6,917,286 |19,316,283 

. 
. 
. ** ---------------------------------------------------------------------------
. ** Real income (2024 USD) and income categories
. ** ---------------------------------------------------------------------------
. gen tmp1 = cpi99 if year == ${end_year_acs}
(16,996,837 missing values generated)

. egen tmp2 = mean(tmp1)

. gen cpi = cpi99 / tmp2

. drop tmp1 tmp2

. 
. foreach var of varlist inctot incwage incearn ftotinc {
  2. 
.     gen real_`var' = round(`var' * cpi)
  3. 
.     recode real_`var' ///
>         (min/-1        = 1 "Negative income") ///
>         (0             = 2 "$0") ///
>         (1/24999       = 3 "$1-$25K") ///
>         (25000/49999   = 4 "$25K-$50K") ///
>         (50000/99999   = 5 "$50K-$100K") ///
>         (100000/199999 = 6 "$100K-$200K") ///
>         (200000/max    = 7 "$200K+"), ///
>         gen(cat_`var')
  4. 
.     tab cat_`var', missing
  5. 
. } // END INCOME LOOP
(19,316,283 differences between real_inctot and cat_inctot)

      RECODE of |
    real_inctot |      Freq.     Percent        Cum.
----------------+-----------------------------------
Negative income |     14,536        0.08        0.08
             $0 |  1,394,134        7.22        7.29
        $1-$25K |  5,046,142       26.12       33.42
      $25K-$50K |  4,656,072       24.10       57.52
     $50K-$100K |  5,013,759       25.96       83.48
    $100K-$200K |  2,340,127       12.11       95.59
         $200K+ |    851,513        4.41      100.00
----------------+-----------------------------------
          Total | 19,316,283      100.00
(19,316,283 differences between real_incwage and cat_incwage)

      RECODE of |
   real_incwage |      Freq.     Percent        Cum.
----------------+-----------------------------------
             $0 |  7,842,382       40.60       40.60
        $1-$25K |  2,396,723       12.41       53.01
      $25K-$50K |  2,939,183       15.22       68.22
     $50K-$100K |  3,736,966       19.35       87.57
    $100K-$200K |  1,833,197        9.49       97.06
         $200K+ |    567,832        2.94      100.00
----------------+-----------------------------------
          Total | 19,316,283      100.00
(19,316,283 differences between real_incearn and cat_incearn)

      RECODE of |
   real_incearn |      Freq.     Percent        Cum.
----------------+-----------------------------------
Negative income |     13,485        0.07        0.07
             $0 |  7,054,924       36.52       36.59
        $1-$25K |  2,695,453       13.95       50.55
      $25K-$50K |  3,120,356       16.15       66.70
     $50K-$100K |  3,885,631       20.12       86.82
    $100K-$200K |  1,915,292        9.92       96.73
         $200K+ |    631,142        3.27      100.00
----------------+-----------------------------------
          Total | 19,316,283      100.00
(19,316,243 differences between real_ftotinc and cat_ftotinc)

      RECODE of |
   real_ftotinc |      Freq.     Percent        Cum.
----------------+-----------------------------------
             $0 |    187,497        0.97        0.97
        $1-$25K |  1,906,940        9.87       10.84
      $25K-$50K |  2,863,409       14.82       25.67
     $50K-$100K |  5,444,886       28.19       53.85
    $100K-$200K |  5,836,643       30.22       84.07
         $200K+ |  3,076,908       15.93      100.00
----------------+-----------------------------------
          Total | 19,316,283      100.00

. 
. label var cat_inctot  "Total personal income categories (real ${end_year_acs} USD)"

. label var cat_incwage "Total wage income categories (real ${end_year_acs} USD)"

. label var cat_incearn "Total earned income categories (real ${end_year_acs} USD)"

. label var cat_ftotinc "Total family income categories (real ${end_year_acs} USD)"

. 
. 
. ** ---------------------------------------------------------------------------
. ** Analysis loops
. ** ---------------------------------------------------------------------------
. 
. ** Categorical variables to iterate over
. local catvars "cat_yngch cat_sex cat_married cat_age cat_child cat_educ cat_ftotinc"

. 
. forvalues i = 1/2 {
  2. 
.     if `i' == 1 local ytitle_txt "Out-migration rate (%)"
  3.     if `i' == 2 local ytitle_txt "In-migration rate (%)"
  4. 
.     foreach cat of local catvars {
  5. 
.         ** Absorb all other categories (but not the focal one)
.         local othercats : list catvars - cat
  6. 
.         ** Run regression and plot
.         hdfe_catyear_plot out_`i' if sample_`i' == 1, ///
>             cat(`cat') ///
>             year(year) ///
>             absorb(state_fips_o county_fips_o `othercats') ///
>             wvar(perwt) wtype(fw) ///
>                         xtitle("ACS Survey Year (t=2)") ///
>             ytitle("`ytitle_txt'") ///
>             saving("${results}individual/fig_`cat'_`i'") ///
>             replace
  7.                         
.     } // END CAT LOOP
  8. 
. } // END SAMPLE LOOP
(Created by command margins; also see char list)
2016 2017 2018 2019 2020 2021 2022 2023 2024
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/individual/fig_cat_yngch_1.pdf saved as
    PDF format
(Created by command margins; also see char list)
2016 2017 2018 2019 2020 2021 2022 2023 2024
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/individual/fig_cat_sex_1.pdf saved as
    PDF format
(Created by command margins; also see char list)
2016 2017 2018 2019 2020 2021 2022 2023 2024
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/individual/fig_cat_married_1.pdf saved
    as PDF format
(Created by command margins; also see char list)
2016 2017 2018 2019 2020 2021 2022 2023 2024
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/individual/fig_cat_age_1.pdf saved as
    PDF format
(Created by command margins; also see char list)
2016 2017 2018 2019 2020 2021 2022 2023 2024
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/individual/fig_cat_child_1.pdf saved as
    PDF format
(Created by command margins; also see char list)
2016 2017 2018 2019 2020 2021 2022 2023 2024
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/individual/fig_cat_educ_1.pdf saved as
    PDF format
(Created by command margins; also see char list)
2016 2017 2018 2019 2020 2021 2022 2023 2024
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/individual/fig_cat_ftotinc_1.pdf saved
    as PDF format
(Created by command margins; also see char list)
2016 2017 2018 2019 2020 2021 2022 2023 2024
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/individual/fig_cat_yngch_2.pdf saved as
    PDF format
(Created by command margins; also see char list)
2016 2017 2018 2019 2020 2021 2022 2023 2024
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/individual/fig_cat_sex_2.pdf saved as
    PDF format
(Created by command margins; also see char list)
2016 2017 2018 2019 2020 2021 2022 2023 2024
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/individual/fig_cat_married_2.pdf saved
    as PDF format
(Created by command margins; also see char list)
2016 2017 2018 2019 2020 2021 2022 2023 2024
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/individual/fig_cat_age_2.pdf saved as
    PDF format
(Created by command margins; also see char list)
2016 2017 2018 2019 2020 2021 2022 2023 2024
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/individual/fig_cat_child_2.pdf saved as
    PDF format
(Created by command margins; also see char list)
2016 2017 2018 2019 2020 2021 2022 2023 2024
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/individual/fig_cat_educ_2.pdf saved as
    PDF format
(Created by command margins; also see char list)
2016 2017 2018 2019 2020 2021 2022 2023 2024
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/individual/fig_cat_ftotinc_2.pdf saved
    as PDF format

. 
. 
. ** ---------------------------------------------------------------------------
. ** Close log
. ** ---------------------------------------------------------------------------
. clear

. log close log_02
      name:  log_02
       log:  C:/Users/ji252/Documents/GitHub/multnomah-county-tax/code/logs/02_log_individual_2026-02-06.lo
> g
  log type:  text
 closed on:   6 Feb 2026, 20:37:11
-----------------------------------------------------------------------------------------------------------
