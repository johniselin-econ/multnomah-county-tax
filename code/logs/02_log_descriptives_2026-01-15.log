------------------------------------------------------------------------------------------------------
      name:  log_02
       log:  C:/Users/ji252/Documents/GitHub/multnomah-county-tax/code/logs/02_log_descriptives_2026-0
> 1-15.log
  log type:  text
 opened on:  15 Jan 2026, 16:36:42

. 
. ** Determine set of common in- and out-migration counties for Multnomah
. use ${data}working/irs_county_flow.dta, clear 

. 
. ** Tag Multnomah
. gen multnomah_o = (state_fips_o == 41 & county_fips_o == 51)

. gen multnomah_d = (state_fips_d == 41 & county_fips_d == 51)

. 
. ** Loop over samples 
. foreach x in "o" "d" {
  2.         
.         ** Preserve 
.         preserve 
  3.         
.         ** Keep Multnomah
.         keep if multnomah_`x' == 1 
  4.         
.         ** Export data 
.         export excel using "${data}multnomah.xlsx",     ///
>                 sheet(irs_`x', replace ) firstrow(variables) 
  5.                 
.         ** Clear and restore 
.         clear 
  6.         restore
  7.                 
. } // END ORIGIN-DESTINATION LOOP 
(361,546 observations deleted)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/multnomah.xlsx saved
(361,434 observations deleted)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/multnomah.xlsx saved

. 
. ** Determine set of common in- and out-migration counties for Multnomah
. use ${data}working/acs_county_flow.dta, clear 

. 
. ** Tag Multnomah
. gen multnomah_o = (state_fips_o == 41 & county_fips_o == 51)

. gen multnomah_d = (state_fips_d == 41 & county_fips_d == 51)

. 
. ** Loop over samples 
. foreach x in "o" "d" {
  2.         
.         ** Preserve 
.         preserve 
  3.         
.         ** Keep Multnomah
.         keep if multnomah_`x' == 1 
  4.         
.         ** Export data 
.         export excel using "${data}multnomah.xlsx",     ///
>                 sheet(acs_`x', replace ) firstrow(variables) 
  5.                 
.         ** Clear and restore 
.         clear 
  6.         restore
  7.                 
. } // END ORIGIN-DESTINATION LOOP 
(230,904 observations deleted)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/multnomah.xlsx saved
(230,847 observations deleted)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/multnomah.xlsx saved

. 
. /*******************************************************************************
> SECTION 2: PRE-POST FLOW COMPARISON (2018-2019 vs 2021-2022)
> Purpose: Compare IRS migration flows to/from Multnomah County before and after
>          the 2020 tax change. Creates datasets and exports CSVs for mapping.
>          Includes both raw flows and rates (flow / Multnomah population).
> *******************************************************************************/
. 
. ** ----------------------------------------------------------------
. ** GET MULTNOMAH BASELINE POPULATION FOR RATE CALCULATIONS
. ** ----------------------------------------------------------------
. 
. ** Load gross data to get Multnomah's total population by period
. use "${data}working/irs_county_gross", clear

. 
. ** Keep only Multnomah County
. keep if state_fips == 41 & county_fips == 51
(21,973 observations deleted)

. 
. ** Keep only pre and post periods
. gen period = ""
(7 missing values generated)

. replace period = "pre" if inlist(year, 2018, 2019)
variable period was str1 now str3
(2 real changes made)

. replace period = "post" if inlist(year, 2021, 2022)
variable period was str3 now str4
(2 real changes made)

. keep if period != ""
(3 observations deleted)

. 
. ** Calculate base population (non-movers + all movers = total filers)
. gen n1_base = n1_out_1 + n1_out_2

. gen n2_base = n2_out_1 + n2_out_2

. gen agi_base = agi_out_1 + agi_out_2

. 
. ** Collapse to get average by period
. collapse (mean) n1_base n2_base agi_base, by(period)

. 
. ** Store population values in locals for later use
. summ n1_base if period == "pre", meanonly

. local n1_pop_pre = r(mean)

. summ n1_base if period == "post", meanonly

. local n1_pop_post = r(mean)

. 
. summ n2_base if period == "pre", meanonly

. local n2_pop_pre = r(mean)

. summ n2_base if period == "post", meanonly

. local n2_pop_post = r(mean)

. 
. summ agi_base if period == "pre", meanonly

. local agi_pop_pre = r(mean)

. summ agi_base if period == "post", meanonly

. local agi_pop_post = r(mean)

. 
. ** Display population values for log
. dis "Multnomah County baseline populations:"
Multnomah County baseline populations:

. dis "  n1 (returns): pre = `n1_pop_pre', post = `n1_pop_post'"
  n1 (returns): pre = 339804, post = 352539.5

. dis "  n2 (exemptions): pre = `n2_pop_pre', post = `n2_pop_post'"
  n2 (exemptions): pre = 619925.5, post = 611226

. dis "  agi: pre = `agi_pop_pre', post = `agi_pop_post'"
  agi: pre = 28851868, post = 33774184

. 
. clear

. 
. ** ----------------------------------------------------------------
. ** LOAD FLOW DATA AND CREATE COMPARISON DATASETS
. ** ----------------------------------------------------------------
. 
. ** Load IRS flow data
. use ${data}working/irs_county_flow.dta, clear

. 
. ** Define Multnomah County FIPS
. local multnomah_fips = 41051

. 
. ** Define pre and post periods
. local pre_years "2018 2019"

. local post_years "2021 2022"

. 
. ** Create period indicator
. gen period = ""
(362,678 missing values generated)

. replace period = "pre" if inlist(year, 2018, 2019)
variable period was str1 now str3
(97,023 real changes made)

. replace period = "post" if inlist(year, 2021, 2022)
variable period was str3 now str4
(107,196 real changes made)

. 
. ** Keep only pre and post periods
. keep if period != ""
(158,459 observations deleted)

. 
. ** Loop over each measure to create separate datasets
. foreach measure in "n1" "n2" "agi" {
  2. 
.         ** Display status
.         dis "Creating flow comparison dataset for `measure'..."
  3. 
.         ** Preserve original data
.         preserve
  4. 
.         ** ----------------------------------------------------------------
.         ** OUT-MIGRATION: Flows FROM Multnomah TO other counties
.         ** ----------------------------------------------------------------
. 
.         ** Keep flows where Multnomah is the origin
.         keep if fips_o == `multnomah_fips'
  5. 
.         ** Collapse to sum flows by destination county and period
.         collapse (sum) `measure', by(fips_d period)
  6. 
.         ** Reshape to wide format (pre and post as columns)
.         reshape wide `measure', i(fips_d) j(period) string
  7. 
.         ** Rename for clarity
.         rename fips_d fips
  8.         rename `measure'pre out_pre
  9.         rename `measure'post out_post
 10. 
.         ** Save temp file for out-migration
.         tempfile out_flows
 11.         save `out_flows'
 12. 
.         ** ----------------------------------------------------------------
.         ** IN-MIGRATION: Flows TO Multnomah FROM other counties
.         ** ----------------------------------------------------------------
. 
.         ** Restore and start fresh
.         restore
 13.         preserve
 14. 
.         ** Keep flows where Multnomah is the destination
.         keep if fips_d == `multnomah_fips'
 15. 
.         ** Collapse to sum flows by origin county and period
.         collapse (sum) `measure', by(fips_o period)
 16. 
.         ** Reshape to wide format
.         reshape wide `measure', i(fips_o) j(period) string
 17. 
.         ** Rename for clarity
.         rename fips_o fips
 18.         rename `measure'pre in_pre
 19.         rename `measure'post in_post
 20. 
.         ** ----------------------------------------------------------------
.         ** MERGE: Combine in and out flows
.         ** ----------------------------------------------------------------
. 
.         ** Merge with out-migration flows
.         merge 1:1 fips using `out_flows', nogen
 21. 
.         ** Replace missing with 0 (counties with flows in only one direction)
.         foreach var of varlist out_pre out_post in_pre in_post {
 22.                 replace `var' = 0 if missing(`var')
 23.         }
 24. 
.         ** ----------------------------------------------------------------
.         ** ADD MULTNOMAH BASELINE POPULATION
.         ** ----------------------------------------------------------------
. 
.         ** Add Multnomah population for pre and post periods
.         gen pop_pre = ``measure'_pop_pre'
 25.         gen pop_post = ``measure'_pop_post'
 26. 
.         ** ----------------------------------------------------------------
.         ** CALCULATE RATES (flow / population * 100)
.         ** ----------------------------------------------------------------
. 
.         ** Out-migration rates (% of Multnomah population moving to each county)
.         gen out_rate_pre = 100 * out_pre / pop_pre
 27.         gen out_rate_post = 100 * out_post / pop_post
 28. 
.         ** In-migration rates (% of Multnomah population represented by in-migrants)
.         gen in_rate_pre = 100 * in_pre / pop_pre
 29.         gen in_rate_post = 100 * in_post / pop_post
 30. 
.         ** Calculate rate changes
.         gen out_rate_change = out_rate_post - out_rate_pre
 31.         gen in_rate_change = in_rate_post - in_rate_pre
 32.         gen net_rate_change = in_rate_change - out_rate_change
 33. 
.         ** Order columns
.         order fips pop_pre pop_post ///
>                 out_pre out_post out_rate_pre out_rate_post out_rate_change ///
>                 in_pre in_post in_rate_pre in_rate_post in_rate_change net_rate_change
 34. 
.         ** Sort by fips
.         sort fips
 35. 
.         ** Label variables
.         label var fips "County FIPS code"
 36.         label var pop_pre "Multnomah baseline population (2018-2019 avg)"
 37.         label var pop_post "Multnomah baseline population (2021-2022 avg)"
 38.         label var out_pre "Out-migration from Multnomah (2018-2019)"
 39.         label var out_post "Out-migration from Multnomah (2021-2022)"
 40.         label var out_rate_pre "Out-migration rate (%, 2018-2019)"
 41.         label var out_rate_post "Out-migration rate (%, 2021-2022)"
 42.         label var out_rate_change "Change in out-migration rate (pp)"
 43.         label var in_pre "In-migration to Multnomah (2018-2019)"
 44.         label var in_post "In-migration to Multnomah (2021-2022)"
 45.         label var in_rate_pre "In-migration rate (%, 2018-2019)"
 46.         label var in_rate_post "In-migration rate (%, 2021-2022)"
 47.         label var in_rate_change "Change in in-migration rate (pp)"
 48.         label var net_rate_change "Change in net migration rate (pp)"
 49. 
.         ** Save Stata dataset to working directory (for R mapping)
.         save "${data}working/multnomah_flow_comparison_`measure'.dta", replace
 50. 
.         ** Export to CSV for R mapping
.         export delimited using "${data}working/multnomah_flow_comparison_`measure'.csv", replace
 51. 
.         ** Display summary statistics
.         dis "Summary for `measure' - Raw flows:"
 52.         summ out_pre out_post in_pre in_post
 53. 
.         dis "Summary for `measure' - Rates (%):"
 54.         summ out_rate_pre out_rate_post in_rate_pre in_rate_post
 55. 
.         dis "Summary for `measure' - Rate changes (pp):"
 56.         summ out_rate_change in_rate_change net_rate_change
 57. 
.         ** Restore original data for next measure
.         restore
 58. 
. } // END MEASURE LOOP
Creating flow comparison dataset for n1...
(203,572 observations deleted)
(j = post pre)

Data                               Long   ->   Wide
-----------------------------------------------------------------------------
Number of observations              355   ->   202         
Number of variables                   3   ->   3           
j variable (2 values)            period   ->   (dropped)
xij variables:
                                     n1   ->   n1post n1pre
-----------------------------------------------------------------------------
file C:\Users\ji252\AppData\Local\Temp\ST_4058_000006.tmp saved as .dta format
(203,528 observations deleted)
(j = post pre)

Data                               Long   ->   Wide
-----------------------------------------------------------------------------
Number of observations              379   ->   202         
Number of variables                   3   ->   3           
j variable (2 values)            period   ->   (dropped)
xij variables:
                                     n1   ->   n1post n1pre
-----------------------------------------------------------------------------

    Result                      Number of obs
    -----------------------------------------
    Not matched                            58
        from master                        29  
        from using                         29  

    Matched                               173  
    -----------------------------------------
(75 real changes made)
(32 real changes made)
(36 real changes made)
(47 real changes made)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/multnomah_flow_comparison_n1.d
    > ta saved
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/multnomah_flow_comparison_n1.cs
> v saved
Summary for n1 - Raw flows:

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
     out_pre |        231     217.658     999.888          0      10579
    out_post |        231    258.5541    1107.284          0      11770
      in_pre |        231    223.6537    835.9653          0       8773
     in_post |        231    225.6753    816.5126          0       8572
Summary for n1 - Rates (%):

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
out_rate_pre |        231     .064054    .2942543          0   3.113265
out_rate_p~t |        231    .0733405    .3140879          0   3.338633
 in_rate_pre |        231    .0658184     .246014          0   2.581782
in_rate_post |        231    .0640142    .2316088          0   2.431501
Summary for n1 - Rate changes (pp):

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
out_rate_c~e |        231    .0092865    .0249054  -.0161129   .2473493
in_rate_ch~e |        231   -.0018042    .0197721  -.1981459   .0960742
net_rate_c~e |        231   -.0110907    .0391617  -.4235137   .0636027
Creating flow comparison dataset for n2...
(203,572 observations deleted)
(j = post pre)

Data                               Long   ->   Wide
-----------------------------------------------------------------------------
Number of observations              355   ->   202         
Number of variables                   3   ->   3           
j variable (2 values)            period   ->   (dropped)
xij variables:
                                     n2   ->   n2post n2pre
-----------------------------------------------------------------------------
file C:\Users\ji252\AppData\Local\Temp\ST_4058_000009.tmp saved as .dta format
(203,528 observations deleted)
(j = post pre)

Data                               Long   ->   Wide
-----------------------------------------------------------------------------
Number of observations              379   ->   202         
Number of variables                   3   ->   3           
j variable (2 values)            period   ->   (dropped)
xij variables:
                                     n2   ->   n2post n2pre
-----------------------------------------------------------------------------

    Result                      Number of obs
    -----------------------------------------
    Not matched                            58
        from master                        29  
        from using                         29  

    Matched                               173  
    -----------------------------------------
(75 real changes made)
(32 real changes made)
(36 real changes made)
(47 real changes made)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/multnomah_flow_comparison_n2.d
    > ta saved
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/multnomah_flow_comparison_n2.cs
> v saved
Summary for n2 - Raw flows:

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
     out_pre |        231    345.1342    1677.485          0      18690
    out_post |        231    398.8095    1806.828          0      20381
      in_pre |        231    322.4978    1252.515          0      12631
     in_post |        231    310.0649    1160.729          0      11789
Summary for n2 - Rates (%):

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
out_rate_pre |        231    .0556735    .2705946          0   3.014879
out_rate_p~t |        231    .0652475    .2956072          0   3.334446
 in_rate_pre |        231     .052022    .2020428          0   2.037503
in_rate_post |        231    .0507284    .1899018          0   1.928746
Summary for n2 - Rate changes (pp):

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
out_rate_c~e |        231     .009574    .0280899  -.0120743   .3195674
in_rate_ch~e |        231   -.0012937    .0163673  -.1644121   .0814157
net_rate_c~e |        231   -.0108676    .0414007  -.4839796   .0637089
Creating flow comparison dataset for agi...
(203,572 observations deleted)
(j = post pre)

Data                               Long   ->   Wide
-----------------------------------------------------------------------------
Number of observations              355   ->   202         
Number of variables                   3   ->   3           
j variable (2 values)            period   ->   (dropped)
xij variables:
                                    agi   ->   agipost agipre
-----------------------------------------------------------------------------
file C:\Users\ji252\AppData\Local\Temp\ST_4058_00000c.tmp saved as .dta format
(203,528 observations deleted)
(j = post pre)

Data                               Long   ->   Wide
-----------------------------------------------------------------------------
Number of observations              379   ->   202         
Number of variables                   3   ->   3           
j variable (2 values)            period   ->   (dropped)
xij variables:
                                    agi   ->   agipost agipre
-----------------------------------------------------------------------------

    Result                      Number of obs
    -----------------------------------------
    Not matched                            58
        from master                        29  
        from using                         29  

    Matched                               173  
    -----------------------------------------
(75 real changes made)
(32 real changes made)
(36 real changes made)
(47 real changes made)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/multnomah_flow_comparison_agi.
    > dta saved
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/multnomah_flow_comparison_agi.c
> sv saved
Summary for agi - Raw flows:

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
     out_pre |        231     15245.4    71845.05          0     727846
    out_post |        231    24860.27    109864.8          0    1170383
      in_pre |        231    14641.75     53537.6          0     592707
     in_post |        231    16286.22    58385.22          0     662028
Summary for agi - Rates (%):

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
out_rate_pre |        231    .0528403    .2490135          0     2.5227
out_rate_p~t |        231    .0736073    .3252922          0   3.465318
 in_rate_pre |        231     .050748    .1855602          0   2.054311
in_rate_post |        231    .0482209    .1728694          0    1.96016
Summary for agi - Rate changes (pp):

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
out_rate_c~e |        231     .020767    .0989045  -.0461846   .9903069
in_rate_ch~e |        231   -.0025271    .0244645  -.2139035   .0881895
net_rate_c~e |        231   -.0232941      .11679  -1.170827   .1055987

. 
. dis "Flow comparison datasets created and exported to ${results}flows/"
Flow comparison datasets created and exported to C:/Users/ji252/Documents/GitHub/multnomah-county-tax/
> results/flows/

. 
. ** Close log
. clear

. log close log_02
      name:  log_02
       log:  C:/Users/ji252/Documents/GitHub/multnomah-county-tax/code/logs/02_log_descriptives_2026-0
> 1-15.log
  log type:  text
 closed on:  15 Jan 2026, 16:36:44
------------------------------------------------------------------------------------------------------
