----------------------------------------------------------------------------------------------------------------
      name:  log_02
       log:  C:/Users/ji252/Documents/GitHub/multnomah-county-tax/code/logs/02_log_individual_2026-02-09.log
  log type:  text
 opened on:  10 Feb 2026, 11:08:03

. 
. 
. ** ---------------------------------------------------------------------------
. ** Program: hdfe_catyear_plot
. **
. ** - Runs:      reghdfe y i.cat#i.year, absorb(...) nocons
. ** - Posts:     cell means and CIs for each cat×year coefficient
. ** - Plots:     one connected series per category + optional CI caps
. ** - Exports:   PDF via graph export
. **
. ** Notes:
. ** - Legend uses category VALUE LABELS. We store those labels immediately after
. **   levelsof (before moving into the posted coefficient dataset) to avoid any
. **   issues from dataset swaps.
. ** - CI and line use the same color; CI uses 50% opacity.
. ** ---------------------------------------------------------------------------
. ** ---------------------------------------------------------------------------
. ** Program: hdfe_catyear_plot
. **
. ** Purpose:
. **   1) Run reghdfe with a CAT × YEAR interaction and absorbed fixed effects.
. **   2) Use margins (rather than reghdfe coefficients) to compute conditional means:
. **        margins i.CAT, over(YEAR)
. **   3) Plot margins by YEAR with one series per CAT (CI optional).
. **
. ** Notes:
. **   - baseyear(0) => plot levels (conditional means).
. **   - baseyear(#) => plot within-CAT differences relative to that year.
. ** ---------------------------------------------------------------------------
. capture program drop hdfe_catyear_plot

. program define hdfe_catyear_plot
  1.     version 16.0
  2. 
.     syntax varname(numeric) [if] [in] [fw aw pw iw] , ///
>         CAT(varname) YEAR(varname) ABSORB(string) ///
>         [ WVAR(varname) WTYPE(string) ///
>           VCE(string) ///
>           TITLE(string) XTITLE(string) YTITLE(string) ///
>           NOCI ///
>           BASEYEAR(integer 0) ///
>           SAVING(string) REPLACE ///
>           DEBUG DEBUGDETAIL ]
  3. 
.     ** -----------------------------------------------------------------------
.     ** Configuration: project root for relative paths
.     ** -----------------------------------------------------------------------
.     local __project_root "C:/Users/ji252/Documents/GitHub/multnomah-county-tax/"
  4. 
.     ** -----------------------------------------------------------------------
.     ** Debug flags
.     ** -----------------------------------------------------------------------
.     local __dbg 0
  5.     local __dbgdetail 0
  6.     if "`debug'" != "" local __dbg 1
  7.     if "`debugdetail'" != "" {
  8.         local __dbg 1
  9.         local __dbgdetail 1
 10.     }
 11. 
.     if `__dbg' {
 12.         di as txt "------------------------------------------------------------"
 13.         di as txt "hdfe_catyear_plot DEBUG START"
 14.         di as txt "Outcome   : `varlist'"
 15.         di as txt "CAT()     : `cat'"
 16.         di as txt "YEAR()    : `year'"
 17.         di as txt "ABSORB()  : `absorb'"
 18.         di as txt "Weights   : weight=`weight' exp=`exp' wvar=`wvar' wtype=`wtype'"
 19.         di as txt "VCE()     : `vce'"
 20.         di as txt "BASEYEAR(): `baseyear'   NOCI: `noci'"
 21.         di as txt "SAVING()  : `saving'   REPLACE: `replace'"
 22.         di as txt "IF/IN     : `if' `in'"
 23.         di as txt "------------------------------------------------------------"
 24.     }
 25. 
.     ** -----------------------------------------------------------------------
.     ** Requirements
.     ** -----------------------------------------------------------------------
.     capture which reghdfe
 26.     if _rc {
 27.         di as error "reghdfe not found. Install with: ssc install reghdfe, replace"
 28.         exit 198
 29.     }
 30. 
.     ** -----------------------------------------------------------------------
.     ** Mark sample
.     ** -----------------------------------------------------------------------
.     if `__dbg' di as txt "[Step 1] Marking estimation sample..."
 31.     marksample touse, strok
 32.     quietly replace `touse' = `touse' & !missing(`varlist', `cat', `year')
 33. 
.     quietly count if `touse'
 34.     if `__dbg' di as txt "  N (after filters): " %12.0gc r(N)
 35.     if r(N) == 0 {
 36.         di as error "No observations available after applying if/in filters."
 37.         exit 2000
 38.     }
 39. 
.     ** -----------------------------------------------------------------------
.     ** Weights (default fw=perwt unless caller provided weights)
.     ** -----------------------------------------------------------------------
.     if `__dbg' di as txt "[Step 2] Resolving weights..."
 40.     local wgt ""
 41.     if "`weight'" != "" {
 42.         local wgt "[`weight'=`exp']"
 43.         if `__dbg' di as txt "  Using caller-provided weights: `wgt'"
 44.     }
 45.     else {
 46.         if "`wvar'"  == "" local wvar  "perwt"
 47.         if "`wtype'" == "" local wtype "fw"
 48.         capture confirm variable `wvar'
 49.         if _rc {
 50.             di as error "Default weight variable `wvar' not found. Either create it or pass weights explici
> tly."
 51.             exit 111
 52.         }
 53.         local wgt "[`wtype'=`wvar']"
 54.         if `__dbg' di as txt "  Using default weights: `wgt'"
 55.     }
 56. 
.     ** -----------------------------------------------------------------------
.     ** Ensure CAT/YEAR numeric for factor variables
.     ** -----------------------------------------------------------------------
.     if `__dbg' di as txt "[Step 3] Harmonizing CAT/YEAR types..."
 57.     tempvar __cat __year
 58. 
.     local cattype : type `cat'
 59.     if substr("`cattype'", 1, 3) == "str" {
 60.         quietly encode `cat' if `touse', gen(`__cat')
 61.         local catv `__cat'
 62.         if `__dbg' di as txt "  Encoded string CAT -> `catv'"
 63.     }
 64.     else {
 65.         local catv `cat'
 66.         if `__dbg' di as txt "  CAT already numeric -> `catv'"
 67.     }
 68. 
.     local yeartype : type `year'
 69.     if substr("`yeartype'", 1, 3) == "str" {
 70.         quietly destring `year' if `touse', gen(`__year') force
 71.         capture assert !missing(`__year') if `touse'
 72.         if _rc {
 73.             di as error "Year variable is string and could not be cleanly converted to numeric."
 74.             exit 459
 75.         }
 76.         local yearv `__year'
 77.         if `__dbg' di as txt "  Destring YEAR -> `yearv'"
 78.     }
 79.     else {
 80.         local yearv `year'
 81.         if `__dbg' di as txt "  YEAR already numeric -> `yearv'"
 82.     }
 83. 
.     ** -----------------------------------------------------------------------
.     ** Guard: CAT should not also be absorbed
.     ** -----------------------------------------------------------------------
.     if `__dbg' di as txt "[Step 4] Validating absorb()..."
 84.     if regexm(" `absorb' ", " `catv' ") {
 85.         di as error "Category variable `catv' appears in absorb(): `absorb'. Remove it from absorb() for th
> is run."
 86.         exit 198
 87.     }
 88. 
.     ** -----------------------------------------------------------------------
.     ** Levels and labels (save labels NOW, before switching datasets)
.     ** -----------------------------------------------------------------------
.     if `__dbg' di as txt "[Step 5] Collecting year and category levels..."
 89.     quietly levelsof `yearv' if `touse', local(yrs)
 90.     quietly levelsof `catv'  if `touse', local(cats)
 91.     local vlab : value label `catv'
 92. 
.     if "`yrs'" == "" | "`cats'" == "" {
 93.         di as error "No year or category levels found in estimation sample."
 94.         exit 2000
 95.     }
 96. 
.     if `__dbg' {
 97.         di as txt "  Years: `yrs'"
 98.         di as txt "  Cats : `cats'"
 99.         di as txt "  CAT value label: `vlab'"
100.     }
101. 
.     ** Save category label text into locals (avoids label-loss during preserve/use)
.     foreach c of local cats {
102.         local __key "`c'"
103.         local __key : subinstr local __key "-" "m", all
104. 
.         local __lab "`c'"
105.         if "`vlab'" != "" {
106.             local __tmp : label `vlab' `c'
107.             if "`__tmp'" != "" local __lab "`__tmp'"
108.         }
109.         local __lab : subinstr local __lab `"""' "", all
110.         local __lab_`__key' "`__lab'"
111.     }   // END CAT LABEL SAVE LOOP
112. 
.     ** -----------------------------------------------------------------------
.     ** Base year sanity check (only if baseyear != 0)
.     ** -----------------------------------------------------------------------
.     if `baseyear' != 0 {
113.         if `__dbg' di as txt "[Step 5b] Checking baseyear()..."
114.         local found 0
115.         foreach y of local yrs {
116.             if `y' == `baseyear' local found 1
117.         }
118.         if `found' == 0 {
119.             di as error "baseyear(`baseyear') not found in estimation sample years: `yrs'"
120.             exit 459
121.         }
122.         if `__dbg' di as txt "  baseyear OK: `baseyear'"
123.     }   // END BASEYEAR CHECK
124. 
.     ** -----------------------------------------------------------------------
.     ** Regression (supports margins over CAT × YEAR)
.     ** -----------------------------------------------------------------------
.     if `__dbg' di as txt "[Step 6] Running reghdfe..."
125.     if "`vce'" == "" local vce "robust"
126.     if `__dbg' {
127.         di as txt "  Command:"
128.         di as txt "    reghdfe `varlist' i.`catv'##i.`yearv' if `touse' `wgt', absorb(`absorb') vce(`vce')"
129.     }
130. 
.     quietly reghdfe `varlist' i.`catv'##i.`yearv' if `touse' `wgt', ///
>         absorb(`absorb') vce(`vce')
131. 
.     ** -----------------------------------------------------------------------
.     ** Margins: conditional means by CAT over YEAR (save to dataset)
.     ** -----------------------------------------------------------------------
.     if `__dbg' di as txt "[Step 7] Computing margins and saving results..."
132.     tempfile __margdata
133.     quietly margins, at(`catv'=(`cats') `yearv'=(`yrs')) saving(`__margdata', replace) post
134. 
.     ** -----------------------------------------------------------------------
.     ** Plot using the saved margins dataset
.     ** -----------------------------------------------------------------------
.     preserve
135. 
.         use `__margdata', clear
136. 
.         ** Identify CAT and YEAR columns in margins output
.         ** We compute margins using at(): at(cat levels × year levels). The saved dataset
.         ** therefore stores the grid in _at1 (cat) and _at2 (year) in the order supplied.
.         capture confirm variable _at1
137.         if _rc {
138.             di as error "margins output missing _at1. Ensure margins is called with: margins, at(`catv'=(`c
> ats') `yearv'=(`yrs')) saving(...)"
139.             exit 459
140.         }
141.         capture confirm variable _at2
142.         if _rc {
143.             di as error "margins output missing _at2. Ensure margins is called with: margins, at(`catv'=(`c
> ats') `yearv'=(`yrs')) saving(...)"
144.             exit 459
145.         }
146. 
.         ** Standardize variable names
.         rename _at1 cat_level
147.         rename _at2 year
148. 
.         capture confirm variable _margin
149.         if _rc {
150.             di as error "margins output missing _margin. Cannot proceed."
151.             exit 459
152.         }
153.         rename _margin b
154. 
.         capture confirm variable _se_margin
155.         if !_rc rename _se_margin se
156.         else {
157.             capture confirm variable _se
158.             if !_rc rename _se se
159.         }
160. 
.         capture confirm variable _ci_lb
161.         if !_rc rename _ci_lb ll
162.         capture confirm variable _ci_ub
163.         if !_rc rename _ci_ub ul
164. if `__dbgdetail' {
165.             di as txt "[DebugDetail] First 8 rows of margins dataset:"
166.             list in 1/8, abbrev(24)
167.         }
168. 
.         ** Ensure year is numeric and sorted
.         capture confirm numeric variable year
169.         if _rc {
170.             di as error "Year in margins dataset is not numeric; cannot plot on x-axis."
171.             exit 459
172.         }
173. 
.         ** Optional normalization to baseyear (within-category)
.         if `baseyear' != 0 {
174.             if `__dbg' di as txt "[Step 8] Normalizing margins to baseyear(`baseyear')..."
175.             bysort cat_level: egen base_b = max(cond(year==`baseyear', b, .))
176.             quietly count if missing(base_b)
177.             if r(N) > 0 {
178.                 di as error "Some categories have no observations in baseyear(`baseyear'). Cannot normalize
> ."
179.                 exit 459
180.             }
181.             replace b  = b  - base_b
182.             capture confirm variable ll
183.             if !_rc replace ll = ll - base_b
184.             capture confirm variable ul
185.             if !_rc replace ul = ul - base_b
186.             drop base_b
187.         }   // END BASEYEAR NORMALIZATION
188. 
.         ** X axis labels (years present in margins results)
.         levelsof year, local(xyrs)
189.         if `__dbg' di as txt "  X-axis years used: `xyrs'"
190. 
.         ** -------------------------------------------------------------------
.         ** Plot styling: use plotplainblind palette if available (scheme-level)
.         ** -------------------------------------------------------------------
.         local __oldscheme "`c(scheme)'"
191.         capture set scheme plotplainblind
192.         if _rc {
193.             if `__dbg' di as txt "  plotplainblind scheme not available; using current scheme: `__oldscheme
> '"
194.         }
195.         else {
196.             if `__dbg' di as txt "  Using scheme: plotplainblind (was `__oldscheme')"
197.         }
198. 
.         ** -------------------------------------------------------------------
.         ** Build twoway spec + legend mapping (one label per series)
.         **   - CI and line share the same pstyle; CI uses 50% opacity.
.         ** -------------------------------------------------------------------
.         if `__dbg' di as txt "[Step 9] Building plot command..."
199.         local plots ""
200.         local leg_order ""
201.         local leg_labels ""
202.         local pnum 0
203. 
.         local cats_n : word count `cats'
204.         local legrows 1
205.         if `cats_n' > 4 local legrows 2
206. 
.         local i 0
207.         foreach c of local cats {
208.             quietly count if cat_level == `c'
209.             if r(N) == 0 continue
210. 
.             local ++i
211.             local pstyle "p`i'"
212. 
.             ** Retrieve pre-saved label text (safe key)
.             local __key "`c'"
213.             local __key : subinstr local __key "-" "m", all
214.             local serieslab "`__lab_`__key''"
215. 
.             ** CI (excluded from legend)
.             if "`noci'" == "" {
216.                 local ++pnum
217.                 local plots `plots' ///
>                     (rcap ll ul year if cat_level==`c', sort ///
>                         pstyle(`pstyle') lcolor(%50))
218.             }
219. 
.             ** Line (in legend)
.             local ++pnum
220.             local plots `plots' ///
>                 (connected b year if cat_level==`c', sort ///
>                     pstyle(`pstyle') lp(solid) msym(O) )
221. 
.             local leg_order  `leg_order' `pnum'
222.             local leg_labels `leg_labels' label(`pnum' `serieslab')
223.         }   // END CATEGORY PLOT LOOP
224. 
.         if `"`plots'"' == `""' {
225.             di as error "No series were built for plotting (plotspec empty)."
226.             exit 2000
227.         }
228. 
.         if `__dbgdetail' {
229.             di as txt "  legend order: `leg_order'"
230.             di as txt "  legend labels: `leg_labels'"
231.             di as txt "  legend rows: `legrows'"
232.         }
233. 
.         ** -------------------------------------------------------------------
.         ** Titles (safe quoting)
.         ** -------------------------------------------------------------------
.         local xtitle_input ""
234.         local ytitle_input ""
235.         local title_input  ""
236. 
.         if `"`xtitle'"' == `""' local xtitle_input "xtitle(Year)"
237.         else                    local xtitle_input `"xtitle(`"`xtitle'"')"'
238. 
.         if `"`ytitle'"' == `""' {
239.             if `baseyear' != 0 local ytitle_input `"ytitle(`"`varlist' (relative to `baseyear')"')"'
240.             else              local ytitle_input `"ytitle(`"`varlist' (adjusted mean)"')"'
241.         }
242.         else {
243.             local ytitle_input `"ytitle(`"`ytitle'"')"'
244.         }
245. 
.         if `"`title'"' != `""' local title_input `"title(`"`title'"')"'
246. 
.                 ** ------------------------------------------------------------
.                 ** Y-axis: round "nice" ticks (e.g., 0,2,4,6,8,10)
.                 ** Uses CI bounds to set max, then rounds to a nice step.
.                 ** ------------------------------------------------------------
. 
.                 quietly summarize ll, meanonly
247.                 local __ymin = r(min)
248. 
.                 quietly summarize ul, meanonly
249.                 local __ymax = r(max)
250. 
.                 ** Always include 0 on axis
.                 if `__ymin' > 0 local __ymin = 0
251.                 if `__ymax' < 0 local __ymax = 0
252. 
.                 ** If plotting levels (baseyear==0), anchor at 0
.                 if `baseyear' == 0 local __ymin = 0
253. 
.                 ** Add a little headroom (5%)
.                 local __ymax = `__ymax' * 1.05
254. 
.                 ** Decide on a "nice" step aiming for ~5 intervals
.                 local __span = `__ymax' - `__ymin'
255.                 if `__span' <= 0 local __span = 1
256. 
.                 local __rawstep = `__span'/5
257. 
.                 ** Snap step to {1,2,5} * 10^k
.                 local __k = floor(log10(`__rawstep'))
258.                 local __base = 10^`__k'
259.                 local __mant = `__rawstep'/`__base'
260. 
.                 local __m = 1
261.                 if `__mant' > 1  local __m = 2
262.                 if `__mant' > 2  local __m = 5
263.                 if `__mant' > 5  local __m = 10
264. 
.                 local __ystep = `__m' * `__base'
265. 
.                 ** Round max up to nearest multiple of step; min down similarly
.                 local __yhigh = ceil(`__ymax'/`__ystep') * `__ystep'
266.                 local __ylow  = floor(`__ymin'/`__ystep') * `__ystep'
267. 
.                 ** For levels, ensure bottom is exactly 0
.                 if `baseyear' == 0 local __ylow = 0
268. 
.                 local __yaxis_opts `"yscale(range(`__ylow' `__yhigh')) ylabel(`__ylow'(`__ystep')`__yhigh')"'
269. 
.         twoway `plots', ///
>             `xtitle_input' ///
>             `ytitle_input' ///
>             `title_input' ///
>             xlabel(`xyrs', angle(45)) ///
>                         `__yaxis_opts' ///           
>                         legend(order(`leg_order') `leg_labels' rows(`legrows') position(6)) 
270. 
.         ** Restore scheme (if we successfully switched)
.         capture set scheme `__oldscheme'
271. 
.         ** -------------------------------------------------------------------
.         ** Export figure (PDF) - robust path handling
.         ** -------------------------------------------------------------------
.         if "`saving'" != "" {
272. 
.             local outpath `"`saving'"'
273.             local outpath : subinstr local outpath `"""' "", all
274.             local outpath : subinstr local outpath "\" "/" , all
275. 
.             ** Prepend project root if relative
.             if !regexm("`outpath'", "^[A-Za-z]:/") & substr("`outpath'", 1, 1) != "/" {
276.                 local outpath "`__project_root'`outpath'"
277.             }
278. 
.             ** Ensure .pdf extension
.             if !regexm("`outpath'", "\.pdf$") local outpath "`outpath'.pdf"
279. 
.             ** Ensure output directory exists
.             local p = strrpos("`outpath'", "/")
280.             if `p' > 0 {
281.                 local outdir = substr("`outpath'", 1, `p' - 1)
282.                 if !direxists("`outdir'") {
283.                     if `__dbg' di as txt "  Creating output directory: `outdir'"
284.                     capture mkdir "`outdir'"
285.                     if _rc & !direxists("`outdir'") {
286.                         di as error "Output directory does not exist and could not be created: `outdir'"
287.                         exit 601
288.                     }
289.                 }
290.             }
291. 
.             if `__dbg' di as txt "[Step 10] Exporting graph to: `outpath'"
292. 
.             if "`replace'" != "" graph export "`outpath'", as(pdf) replace
293.             else                graph export "`outpath'", as(pdf)
294. 
.         }   // END PDF EXPORT
295. 
.     restore    // END PRESERVE BLOCK
296. 
.     if `__dbg' {
297.         di as txt "hdfe_catyear_plot DEBUG END"
298.         di as txt "------------------------------------------------------------"
299.     }
300. 
. end

. 
. ** ---------------------------------------------------------------------------
. ** Load ACS migration data
. ** ---------------------------------------------------------------------------
. use "${data}working/acs_migration_file", replace

. 
. ** Sample restrictions
. drop if year == 2015                                    // Sample: 2016-2024
(2,334,973 observations deleted)

. drop if qmigplc1 == 4                                   // Error in migration place 
(401,283 observations deleted)

. drop if inlist(state_fips_o, 2, 15)     // Alaska and Hawaii
(137,699 observations deleted)

. drop if inlist(state_fips_d, 2, 15)     // Alaska and Hawaii
(3,633 observations deleted)

. drop if ftotinc < 0                                     // Negative Family Income       
(7,571 observations deleted)

. drop if age < 25                                                // Dropping under 25
(1,813,595 observations deleted)

. 
. ** ---------------------------------------------------------------------------
. ** Multnomah indicators and samples
. ** ---------------------------------------------------------------------------
. gen multnomah_o = (state_fips_o == 41 & county_fips_o == 51)

. gen multnomah_d = (state_fips_d == 41 & county_fips_d == 51)

. 
. gen sample_1 = (multnomah_o == 1)      // Multnomah in origin-year

. gen sample_2 = (multnomah_o != 1)      // Not Multnomah in origin-year

. label var sample_1 "Out-migration Sample"

. label var sample_2 "In-migration Sample"

. 
. gen out_1 = (same_county == 0)

. replace out_1 = out_1 * 100
(538,681 real changes made)

. label var out_1 "Moved out of Multnomah"

. 
. gen out_2 = (multnomah_d == 1)

. replace out_2 = out_2 * 100 
(47,795 real changes made)

. label var out_2 "Moved to Multnomah"

. 
. 
. ** ---------------------------------------------------------------------------
. ** Covariate categories
. ** ---------------------------------------------------------------------------
. 
. ** Age
. recode age ///
>     (25/44   = 1 "25-44") ///
>     (45/64   = 2 "45-64") ///
>     (65/max  = 3 "65+"), ///
>     gen(cat_age)
(19,316,283 differences between age and cat_age)

. label var cat_age "Age categories"

. tab year cat_age, m 

           |          Age categories
      year |     25-44      45-64        65+ |     Total
-----------+---------------------------------+----------
      2016 |   681,232    846,523    558,580 | 2,086,335 
      2017 |   696,216    844,761    566,503 | 2,107,480 
      2018 |   699,682    839,747    593,206 | 2,132,635 
      2019 |   701,941    842,626    631,905 | 2,176,472 
      2020 |   561,063    658,321    517,867 | 1,737,251 
      2021 |   709,754    814,479    666,776 | 2,191,009 
      2022 |   733,853    829,567    699,446 | 2,262,866 
      2023 |   742,050    827,783    732,956 | 2,302,789 
      2024 |   747,111    818,947    753,388 | 2,319,446 
-----------+---------------------------------+----------
     Total | 6,272,902  7,322,754  5,720,627 |19,316,283 

. 
. ** Sex
. gen cat_sex = (sex == 2)

. label var cat_sex "Female indicator"

. label define lb_cat_sex 0 "Male" 1 "Female", replace

. label values cat_sex lb_cat_sex

. tab year cat_sex, m 

           |   Female indicator
      year |      Male     Female |     Total
-----------+----------------------+----------
      2016 |   985,296  1,101,039 | 2,086,335 
      2017 |   997,918  1,109,562 | 2,107,480 
      2018 | 1,011,314  1,121,321 | 2,132,635 
      2019 | 1,033,269  1,143,203 | 2,176,472 
      2020 |   827,083    910,168 | 1,737,251 
      2021 | 1,040,856  1,150,153 | 2,191,009 
      2022 | 1,074,312  1,188,554 | 2,262,866 
      2023 | 1,093,921  1,208,868 | 2,302,789 
      2024 | 1,101,922  1,217,524 | 2,319,446 
-----------+----------------------+----------
     Total | 9,165,891 10,150,392 |19,316,283 

. 
. ** Marital status
. recode marst ///
>     (1       = 1 "Married") ///
>     (2/3     = 2 "Separated") ///
>     (4/5     = 3 "Divorced / Widowed") ///
>     (6       = 4 "Single"), ///
>     gen(cat_married)
(7,510,801 differences between marst and cat_married)

. label var cat_married "Marriage categories"

. tab year cat_married, m 

           |             Marriage categories
      year |   Married  Separated  Divorced      Single |     Total
-----------+--------------------------------------------+----------
      2016 | 1,246,569     76,410    412,097    351,259 | 2,086,335 
      2017 | 1,258,859     77,348    411,969    359,304 | 2,107,480 
      2018 | 1,270,842     77,788    417,512    366,493 | 2,132,635 
      2019 | 1,296,192     76,315    428,592    375,373 | 2,176,472 
      2020 | 1,036,515     58,080    334,135    308,521 | 1,737,251 
      2021 | 1,286,638     75,252    428,008    401,111 | 2,191,009 
      2022 | 1,337,299     76,534    438,082    410,951 | 2,262,866 
      2023 | 1,357,438     78,034    446,635    420,682 | 2,302,789 
      2024 | 1,362,975     80,186    447,137    429,148 | 2,319,446 
-----------+--------------------------------------------+----------
     Total |11,453,327    675,947  3,764,167  3,422,842 |19,316,283 

. 
. ** Kids at home
. recode nchild ///
>     (0       = 0 "0 Children") ///
>     (1       = 1 "1 Child") ///
>     (2       = 2 "2 Children") ///
>     (3/max   = 3 "3+ Children"), ///
>     gen(cat_child)
(410,461 differences between nchild and cat_child)

. label var cat_child "Number of Children"

. tab year cat_child, m 

           |             Number of Children
      year | 0 Childre    1 Child  2 Childre  3+ Childr |     Total
-----------+--------------------------------------------+----------
      2016 | 1,265,045    387,964    278,328    154,998 | 2,086,335 
      2017 | 1,278,151    391,173    282,188    155,968 | 2,107,480 
      2018 | 1,303,016    393,135    282,176    154,308 | 2,132,635 
      2019 | 1,347,631    397,666    278,666    152,509 | 2,176,472 
      2020 | 1,071,806    317,831    225,864    121,750 | 1,737,251 
      2021 | 1,357,620    399,889    280,928    152,572 | 2,191,009 
      2022 | 1,406,651    412,943    287,656    155,616 | 2,262,866 
      2023 | 1,439,922    417,603    289,925    155,339 | 2,302,789 
      2024 | 1,452,178    422,685    290,790    153,793 | 2,319,446 
-----------+--------------------------------------------+----------
     Total |11,922,020  3,540,889  2,496,521  1,356,853 |19,316,283 

.  
. ** Age of youngest kid at home
. recode yngch ///
>     (99      = 0 "0 Children") ///
>     (0/4     = 1 "0-4") ///
>     (5/12    = 2 "5-12") ///
>     (13/17   = 3 "13-17")       ///
>         (18/max   = 4 "18+"), ///
>     gen(cat_yngch)
(18,931,365 differences between yngch and cat_yngch)

. label var cat_yngch "Age of youngest child"

. tab year cat_yngch, m 

           |                 Age of youngest child
      year | 0 Childre        0-4       5-12      13-17        18+ |     Total
-----------+-------------------------------------------------------+----------
      2016 | 1,265,045    190,397    226,565    133,962    270,366 | 2,086,335 
      2017 | 1,278,151    194,111    228,166    134,815    272,237 | 2,107,480 
      2018 | 1,303,016    193,389    224,601    134,371    277,258 | 2,132,635 
      2019 | 1,347,631    190,799    221,910    133,393    282,739 | 2,176,472 
      2020 | 1,071,806    149,566    175,026    106,686    234,167 | 1,737,251 
      2021 | 1,357,620    185,632    219,365    135,593    292,799 | 2,191,009 
      2022 | 1,406,651    190,603    227,079    140,003    298,530 | 2,262,866 
      2023 | 1,439,922    189,377    226,827    138,903    307,760 | 2,302,789 
      2024 | 1,452,178    187,207    226,289    137,754    316,018 | 2,319,446 
-----------+-------------------------------------------------------+----------
     Total |11,922,020  1,671,081  1,975,828  1,195,480  2,551,874 |19,316,283 

. 
. ** Education
. recode educd ///
>     (min/61  = 1 "Less than HS") ///
>     (62/71   = 2 "HS Diploma") ///
>     (80/100  = 3 "Some College") ///
>     (101/max = 4 "College Degree"), ///
>     gen(cat_educ)
(19,316,283 differences between educd and cat_educ)

. label var cat_educ "Education categories"

. tab year cat_educ, m 

           |            Education categories
      year | Less than  HS Diplom  Some Coll  College D |     Total
-----------+--------------------------------------------+----------
      2016 |   233,839    988,472    180,050    683,974 | 2,086,335 
      2017 |   223,022    989,424    185,574    709,460 | 2,107,480 
      2018 |   217,254    995,303    190,159    729,919 | 2,132,635 
      2019 |   211,611  1,005,357    194,842    764,662 | 2,176,472 
      2020 |   159,539    788,718    157,250    631,744 | 1,737,251 
      2021 |   206,721    987,206    196,644    800,438 | 2,191,009 
      2022 |   203,911  1,010,494    205,172    843,289 | 2,262,866 
      2023 |   204,039  1,023,290    209,472    865,988 | 2,302,789 
      2024 |   199,902  1,019,323    212,409    887,812 | 2,319,446 
-----------+--------------------------------------------+----------
     Total | 1,859,838  8,807,587  1,731,572  6,917,286 |19,316,283 

. 
. 
. ** ---------------------------------------------------------------------------
. ** Real income (2024 USD) and income categories
. ** ---------------------------------------------------------------------------
. gen tmp1 = cpi99 if year == ${end_year_acs}
(16,996,837 missing values generated)

. egen tmp2 = mean(tmp1)

. gen cpi = cpi99 / tmp2

. drop tmp1 tmp2

. 
. foreach var of varlist inctot incwage incearn ftotinc {
  2. 
.     gen real_`var' = round(`var' * cpi)
  3. 
.     recode real_`var' ///
>         (min/-1        = 1 "Negative income") ///
>         (0             = 2 "$0") ///
>         (1/24999       = 3 "$1-$25K") ///
>         (25000/49999   = 4 "$25K-$50K") ///
>         (50000/99999   = 5 "$50K-$100K") ///
>         (100000/199999 = 6 "$100K-$200K") ///
>         (200000/max    = 7 "$200K+"), ///
>         gen(cat_`var')
  4. 
.     tab cat_`var', missing
  5. 
. } // END INCOME LOOP
(19,316,283 differences between real_inctot and cat_inctot)

      RECODE of |
    real_inctot |      Freq.     Percent        Cum.
----------------+-----------------------------------
Negative income |     14,536        0.08        0.08
             $0 |  1,394,134        7.22        7.29
        $1-$25K |  5,046,142       26.12       33.42
      $25K-$50K |  4,656,072       24.10       57.52
     $50K-$100K |  5,013,759       25.96       83.48
    $100K-$200K |  2,340,127       12.11       95.59
         $200K+ |    851,513        4.41      100.00
----------------+-----------------------------------
          Total | 19,316,283      100.00
(19,316,283 differences between real_incwage and cat_incwage)

      RECODE of |
   real_incwage |      Freq.     Percent        Cum.
----------------+-----------------------------------
             $0 |  7,842,382       40.60       40.60
        $1-$25K |  2,396,723       12.41       53.01
      $25K-$50K |  2,939,183       15.22       68.22
     $50K-$100K |  3,736,966       19.35       87.57
    $100K-$200K |  1,833,197        9.49       97.06
         $200K+ |    567,832        2.94      100.00
----------------+-----------------------------------
          Total | 19,316,283      100.00
(19,316,283 differences between real_incearn and cat_incearn)

      RECODE of |
   real_incearn |      Freq.     Percent        Cum.
----------------+-----------------------------------
Negative income |     13,485        0.07        0.07
             $0 |  7,054,924       36.52       36.59
        $1-$25K |  2,695,453       13.95       50.55
      $25K-$50K |  3,120,356       16.15       66.70
     $50K-$100K |  3,885,631       20.12       86.82
    $100K-$200K |  1,915,292        9.92       96.73
         $200K+ |    631,142        3.27      100.00
----------------+-----------------------------------
          Total | 19,316,283      100.00
(19,316,243 differences between real_ftotinc and cat_ftotinc)

      RECODE of |
   real_ftotinc |      Freq.     Percent        Cum.
----------------+-----------------------------------
             $0 |    187,497        0.97        0.97
        $1-$25K |  1,906,940        9.87       10.84
      $25K-$50K |  2,863,409       14.82       25.67
     $50K-$100K |  5,444,886       28.19       53.85
    $100K-$200K |  5,836,643       30.22       84.07
         $200K+ |  3,076,908       15.93      100.00
----------------+-----------------------------------
          Total | 19,316,283      100.00

. 
. label var cat_inctot  "Total personal income categories (real ${end_year_acs} USD)"

. label var cat_incwage "Total wage income categories (real ${end_year_acs} USD)"

. label var cat_incearn "Total earned income categories (real ${end_year_acs} USD)"

. label var cat_ftotinc "Total family income categories (real ${end_year_acs} USD)"

. 
. 
. ** ---------------------------------------------------------------------------
. ** Analysis loops
. ** ---------------------------------------------------------------------------
. 
. ** Categorical variables to iterate over
. local catvars "cat_yngch cat_sex cat_married cat_age cat_child cat_educ cat_ftotinc"

. 
. forvalues i = 1/2 {
  2. 
.     if `i' == 1 local ytitle_txt "Out-migration rate (%)"
  3.     if `i' == 2 local ytitle_txt "In-migration rate (%)"
  4. 
.     foreach cat of local catvars {
  5. 
.         ** Absorb all other categories (but not the focal one)
.         local othercats : list catvars - cat
  6. 
.         ** Run regression and plot
.         hdfe_catyear_plot out_`i' if sample_`i' == 1, ///
>             cat(`cat') ///
>             year(year) ///
>             absorb(state_fips_o county_fips_o `othercats') ///
>             wvar(perwt) wtype(fw) ///
>                         xtitle("ACS Survey Year (t=2)") ///
>             ytitle("`ytitle_txt'") ///
>             saving("${results}individual/fig_`cat'_`i'") ///
>             replace
  7.                         
.     } // END CAT LOOP
  8. 
. } // END SAMPLE LOOP
(Created by command margins; also see char list)
2016 2017 2018 2019 2020 2021 2022 2023 2024
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/individual/fig_cat_yngch_1.pdf saved as PDF
    format
(Created by command margins; also see char list)
2016 2017 2018 2019 2020 2021 2022 2023 2024
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/individual/fig_cat_sex_1.pdf saved as PDF
    format
(Created by command margins; also see char list)
2016 2017 2018 2019 2020 2021 2022 2023 2024
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/individual/fig_cat_married_1.pdf saved as
    PDF format
(Created by command margins; also see char list)
2016 2017 2018 2019 2020 2021 2022 2023 2024
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/individual/fig_cat_age_1.pdf saved as PDF
    format
(Created by command margins; also see char list)
2016 2017 2018 2019 2020 2021 2022 2023 2024
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/individual/fig_cat_child_1.pdf saved as PDF
    format
(Created by command margins; also see char list)
2016 2017 2018 2019 2020 2021 2022 2023 2024
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/individual/fig_cat_educ_1.pdf saved as PDF
    format
(Created by command margins; also see char list)
2016 2017 2018 2019 2020 2021 2022 2023 2024
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/individual/fig_cat_ftotinc_1.pdf saved as
    PDF format
--Break--
r(1);

end of do-file
--Break--
r(1);

end of do-file

--Break--
r(1);

. clear

. do "C:\Users\ji252\AppData\Local\Temp\STD5ca0_00000t.tmp"

. ** INSTALLATION 
. * net install github, from("https://haghish.github.io/github/")
. * github install haghish/rcall, stable
. * ssc install ftools
. * ssc install reghdfe
. * ssc install fre 
. * ssc install coefplot
. * ssc install sdid 
. * ssc install estout 
. * ssc install sdid_event
. * ssc install geodist
. * ssc install ipfraking 
. ** net install parallel, from(https://raw.github.com/gvegayon/parallel/stable/) replace
. ** mata mata mlib index
. 
. ** Preliminaries 
. capture log close 

. clear matrix

. clear all 

. set more off 

. 
. ** Name of project 
. global pr_name "multnomah"

. 
. ** Date of run 
. global date "`: di %tdCY-N-D daily("$S_DATE", "DMY")'"

. 
. ** Set Directories
. global dir "C:/Users/ji252/Documents/GitHub/multnomah-county-tax/"      

. global code     "${dir}code/"                           // CODE FILEPATH

. global data     "${dir}data/"                           // DATA FILEPATH

. global results  "${dir}results/"                        // RESULTS FILEPATH

. global logs     "${code}logs/"                          // LOG FILE SUB-FILEPATH

. 
. ** Set WD 
. cd ${dir}
C:\Users\ji252\Documents\GitHub\multnomah-county-tax

. 
. ** OVERLEAF FILE PATH 
. /*
> global oth_path         ///
>         "/Users/johniselin/Library/CloudStorage/Dropbox/Apps/Overleaf/Multnomah County/"        
> */
.         
. ** Start log file 
. log using "${logs}00_log_${pr_name}_${date}", replace text 
(file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/code/logs/00_log_multnomah_2026-02-10.log not found)
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  C:/Users/ji252/Documents/GitHub/multnomah-county-tax/code/logs/00_log_multnomah_2026-02-10.log
  log type:  text
 opened on:  10 Feb 2026, 14:21:08

. 
. ** Set Seed 
. set seed 56403

. 
. ** Set scheme
. set scheme plotplainblind

. 
. ** PARALLEL PROCESSING FLAG
. ** Set to 1 to use parallel processing, 0 for sequential processing
. global use_parallel = 1

. 
. ** Set parameters 
. local overwrite_csv = 0

. global start_year_acs = 2015

. global end_year_acs = 2024

. 
end of do-file

. do "C:\Users\ji252\AppData\Local\Temp\STD5ca0_00000u.tmp"

. 
. ** Load treatment effects
. use "${results}sdid/sdid_results.dta", clear

. 
. ** Parse outcome variable names to extract components
. gen outcome_type = ""
(648 missing values generated)

. replace outcome_type = "n1" if strpos(outcome, "n1_") > 0
variable outcome_type was str1 now str2
(216 real changes made)

. replace outcome_type = "n2" if strpos(outcome, "n2_") > 0
(216 real changes made)

. replace outcome_type = "agi" if strpos(outcome, "agi_") > 0
variable outcome_type was str2 now str3
(216 real changes made)

. 
. gen migration = ""
(648 missing values generated)

. replace migration = "net" if strpos(outcome, "_net_") > 0
variable migration was str1 now str3
(216 real changes made)

. replace migration = "in" if strpos(outcome, "_in_") > 0
(216 real changes made)

. replace migration = "out" if strpos(outcome, "_out_") > 0
(216 real changes made)

. 
. gen data_type = ""
(648 missing values generated)

. replace data_type = "IRS" if strpos(outcome, "_irs") > 0 & strpos(outcome, "_irs5") == 0
variable data_type was str1 now str3
(216 real changes made)

. replace data_type = "IRS (Interstate)" if strpos(outcome, "_irs5") > 0
(0 real changes made)

. replace data_type = "IRS (389)" if strpos(sample_data, "irs_389") > 0 & strpos(outcome, "_irs5") == 0
variable data_type was str3 now str9
(108 real changes made)

. replace data_type = "IRS (389, Interstate)" if strpos(sample_data, "irs_389") > 0 & strpos(outcome, "_irs5") > 0
(0 real changes made)

. replace data_type = "ACS All" if strpos(outcome, "_acs1") > 0
(216 real changes made)

. replace data_type = "ACS College" if strpos(outcome, "_acs2") > 0
variable data_type was str9 now str11
(216 real changes made)

. 
. gen period_type = ""
(648 missing values generated)

. replace period_type = "16-22" if strpos(outcome, "_irs") > 0
variable period_type was str1 now str5
(216 real changes made)

. replace period_type = "16-22" if strpos(sample_data, "16_22") > 0
(216 real changes made)

. replace period_type = "16-24" if strpos(sample_data, "16_24") > 0
(216 real changes made)

. 
. ** Create specification indicators for bottom panel
. gen spec_all = sample == "sample_all"

. gen spec_urban95 = sample == "sample_urban95"

. gen spec_covid = sample == "sample_urban95_covid"

. gen spec_16_22 = period_type == "16-22"

. gen spec_16_24 = period_type == "16-24"

. gen spec_covars = controls == 1

. gen spec_excl2020 = exclusion == 1

. gen spec_irs = data_type == "IRS"

. gen spec_irs5 = data_type == "IRS (Interstate)"

. gen spec_irs_389 = data_type == "IRS (389)"

. gen spec_irs5_389 = data_type == "IRS (389, Interstate)"

. gen spec_acs_all = data_type == "ACS All"

. gen spec_acs_col = data_type == "ACS College"

. 
. ** Calculate statistical significance (p < 0.05)
. replace significant = pval < 0.05 if missing(significant)
(0 real changes made)

. 
. ** =============================================================================
. ** DEFINE PREFERRED SPECIFICATIONS
. ** Modify these conditions to change which specifications are highlighted
. ** as "preferred" in the specification curve plots.
. ** =============================================================================
. 
. gen preferred = 0

. 
. ** Example preferred specification criteria:
. ** - ACS data (full period 2016-2024)
. ** - Urban counties (top 5%)
. ** - With covariates
. ** - Not excluding 2020
. ** Modify these conditions as needed for your analysis.
. 
. 
. ** IRS FULL SAMPLE
. replace preferred = 1 if                                                                        ///
>         data_type == "IRS" &                                                                    ///
>         spec_16_22 == 1 &                                                                               ///
>         inlist(sample, "sample_all", "sample_urban95_covid") &  ///
>         controls == 1 &                                                                                 ///
>         exclusion == 1                                                                                  //
(18 real changes made)

. 
. ** ACS COLLEGE SAMPLE
. replace preferred = 1 if                                                                        ///
>         data_type == "ACS College" &                                                    ///
>         spec_16_24 == 1 &                                                                               ///
>         inlist(sample, "sample_all", "sample_urban95_covid") &  ///
>         controls == 1 &                                                                                 ///
>         exclusion == 1                                                                                  //
(18 real changes made)

. 
. ** Display count of preferred specifications
. dis "Number of preferred specifications: "
Number of preferred specifications: 

. count if preferred == 1
  36

. 
. ** =============================================================================
. ** CREATE SPECIFICATION CURVE PLOTS
. ** =============================================================================
. 
. ** Loop over outcome types, migration directions, and plot sets
. foreach otype in "n1" "n2" "agi" {
  2.         foreach migr in "net" "in" "out" {
  3.                 foreach pset in "main" "irs5" {
  4. 
.                 ** Preserve full data
.                 preserve
  5. 
.                 ** Keep only relevant specifications
.                 keep if outcome_type == "`otype'" & migration == "`migr'"
  6. 
.                 ** Filter by plot set
.                 if "`pset'" == "main" {
  7.                         drop if inlist(data_type, "IRS (Interstate)", "IRS (389, Interstate)")
  8.                 }
  9.                 else if "`pset'" == "irs5" {
 10.                         keep if inlist(data_type, "IRS (Interstate)", "IRS (389, Interstate)")
 11.                 }
 12. 
.                 ** Check if we have data
.                 qui count
 13.                 if r(N) == 0 {
 14.                         restore
 15.                         continue
 16.                 }
 17. 
.                 ** Sort by effect size and create rank
.                 sort tau
 18.                 gen spec_rank = _n
 19.                 local n_specs = _N
 20. 
.                 ** Labels for outcome type
.                 if "`otype'" == "n1" local otype_label "Returns/Households"
 21.                 else if "`otype'" == "n2" local otype_label "Exemptions/Persons"
 22.                 else if "`otype'" == "agi" local otype_label "AGI/Income"
 23. 
.                 ** Labels for migration
.                 if "`migr'" == "net" local migr_label "Net Migration"
 24.                 else if "`migr'" == "in" local migr_label "In-Migration"
 25.                 else if "`migr'" == "out" local migr_label "Out-Migration"
 26. 
.                 ** Title suffix for IRS5 plots
.                 if "`pset'" == "irs5" local pset_title " (Interstate)"
 27.                 else local pset_title ""
 28. 
.                 ** ---------------------------------------------------------------------
.                 ** Create variables for significance and preferred-based coloring
.                 ** Four categories:
.                 **   1. Significant + Not Preferred (navy)
.                 **   2. Insignificant + Not Preferred (ltblue)
.                 **   3. Significant + Preferred (red)
.                 **   4. Insignificant + Preferred (orange)
.                 ** ---------------------------------------------------------------------
. 
.                 ** Significant, not preferred
.                 gen tau_sig_notpref = tau if significant == 1 & preferred == 0
 29.                 gen ci_lo_sig_notpref = ci_lower if significant == 1 & preferred == 0
 30.                 gen ci_hi_sig_notpref = ci_upper if significant == 1 & preferred == 0
 31. 
.                 ** Insignificant, not preferred
.                 gen tau_insig_notpref = tau if significant == 0 & preferred == 0
 32.                 gen ci_lo_insig_notpref = ci_lower if significant == 0 & preferred == 0
 33.                 gen ci_hi_insig_notpref = ci_upper if significant == 0 & preferred == 0
 34. 
.                 ** Significant, preferred
.                 gen tau_sig_pref = tau if significant == 1 & preferred == 1
 35.                 gen ci_lo_sig_pref = ci_lower if significant == 1 & preferred == 1
 36.                 gen ci_hi_sig_pref = ci_upper if significant == 1 & preferred == 1
 37. 
.                 ** Insignificant, preferred
.                 gen tau_insig_pref = tau if significant == 0 & preferred == 1
 38.                 gen ci_lo_insig_pref = ci_lower if significant == 0 & preferred == 1
 39.                 gen ci_hi_insig_pref = ci_upper if significant == 0 & preferred == 1
 40. 
.                 ** Count specifications in each category for legend
.                 qui count if significant == 1 & preferred == 0
 41.                 local n_sig_notpref = r(N)
 42.                 qui count if significant == 0 & preferred == 0
 43.                 local n_insig_notpref = r(N)
 44.                 qui count if significant == 1 & preferred == 1
 45.                 local n_sig_pref = r(N)
 46.                 qui count if significant == 0 & preferred == 1
 47.                 local n_insig_pref = r(N)
 48. 
.                 ** ---------------------------------------------------------------------
.                 ** Create upper panel: Coefficient plot with CIs colored by significance
.                 ** and preferred status
.                 ** ---------------------------------------------------------------------
.                 twoway  (rcap ci_lo_sig_notpref ci_hi_sig_notpref spec_rank,            ///
>                                         lc(navy) lw(vthin))                                                                     ///
>                                 (rcap ci_lo_insig_notpref ci_hi_insig_notpref spec_rank,        ///
>                                         lc(ltblue) lw(vthin))                                                                   ///
>                                 (rcap ci_lo_sig_pref ci_hi_sig_pref spec_rank,                          ///
>                                         lc(cranberry) lw(thin))                                                                 ///
>                                 (rcap ci_lo_insig_pref ci_hi_insig_pref spec_rank,                      ///
>                                         lc(orange) lw(thin))                                                                    ///
>                                 (scatter tau_sig_notpref spec_rank,                                             ///
>                                         mc(navy) ms(O) msize(vsmall))                                                   ///
>                                 (scatter tau_insig_notpref spec_rank,                                           ///
>                                         mc(ltblue) ms(O) msize(vsmall))                                                 ///
>                                 (scatter tau_sig_pref spec_rank,                                                        ///
>                                         mc(cranberry) ms(D) msize(small))                                               ///
>                                 (scatter tau_insig_pref spec_rank,                                                      ///
>                                         mc(orange) ms(D) msize(small)),                                                 ///
>                         legend(order(5 "Sig. (p<0.05)" 6 "Insig."                                               ///
>                                                  7 "Sig., Preferred" 8 "Insig., Preferred")             ///
>                                    rows(1) pos(6) size(vsmall))                                                         ///
>                         ytitle("Treatment Effect (pp)")                                                                 ///
>                         xtitle("")                                                                                                              ///
>                         title("`otype_label': `migr_label'`pset_title'", size(medium))  ///
>                         yline(0, lc(red) lp(dash))                                                                              ///
>                         xlabel(none)                                                                                                    ///
>                         name(coef_`otype'_`migr', replace)
 49. 
.                 ** ---------------------------------------------------------------------
.                 ** Create lower panel: Specification indicators
.                 ** (different indicators depending on main vs irs5 plot set)
.                 ** ---------------------------------------------------------------------
. 
.                 if "`pset'" == "main" {
 50. 
.                 gen y_all = -1 if spec_all == 1
 51.                 gen y_urban = -2 if spec_urban95 == 1
 52.                 gen y_covid = -3 if spec_covid == 1
 53.                 gen y_covars = -4 if spec_covars == 1
 54.                 gen y_excl = -5 if spec_excl2020 == 1
 55.                 gen y_irs = -6 if spec_irs == 1
 56.                 gen y_irs_389 = -7 if spec_irs_389 == 1
 57.                 gen y_acs_all = -8 if spec_acs_all == 1
 58.                 gen y_acs_col = -9 if spec_acs_col == 1
 59.                 gen y_16_22 = -10 if spec_16_22 == 1
 60.                 gen y_16_24 = -11 if spec_16_24 == 1
 61. 
.                 twoway  (scatter y_all spec_rank, mc(navy) ms(O) msize(vsmall))         ///
>                                 (scatter y_urban spec_rank, mc(navy) ms(O) msize(vsmall))       ///
>                                 (scatter y_covid spec_rank, mc(navy) ms(O) msize(vsmall))       ///
>                                 (scatter y_covars spec_rank, mc(navy) ms(O) msize(vsmall))      ///
>                                 (scatter y_excl spec_rank, mc(navy) ms(O) msize(vsmall))        ///
>                                 (scatter y_irs spec_rank, mc(navy) ms(O) msize(vsmall))         ///
>                                 (scatter y_irs_389 spec_rank, mc(navy) ms(O) msize(vsmall))     ///
>                                 (scatter y_acs_all spec_rank, mc(navy) ms(O) msize(vsmall))     ///
>                                 (scatter y_acs_col spec_rank, mc(navy) ms(O) msize(vsmall)) ///
>                                 (scatter y_16_22 spec_rank, mc(navy) ms(O) msize(vsmall))       ///
>                                 (scatter y_16_24 spec_rank, mc(navy) ms(O) msize(vsmall)),      ///
>                         legend(off)                                                                                                             ///
>                         ytitle("")                                                                                                              ///
>                         xtitle("Specification (ranked by effect size)")                                 ///
>                         ylabel( -1 "All Counties"                                                                               ///
>                                         -2 "Urban 95%"                                                                                  ///
>                                         -3 "COVID Match"                                                                                ///
>                                         -4 "Covariates"                                                                                 ///
>                                         -5 "Excl. 2020"                                                                                 ///
>                                         -6 "IRS (all counties)"                                                                 ///
>                                         -7 "IRS (ACS counties)"                                                                 ///
>                                         -8 "ACS All"                                                                                    ///
>                                         -9 "ACS College"                                                                                ///
>                                         -10 "16-22"                                                                                             ///
>                                         -11 "16-24",                                                                                    ///
>                                 angle(0) labsize(vsmall))                                                                       ///
>                         xlabel(none)                                                                                                    ///
>                         name(spec_`otype'_`migr', replace)
 62. 
.                 } // END main lower panel
 63. 
.                 else if "`pset'" == "irs5" {
 64. 
.                 gen y_all = -1 if spec_all == 1
 65.                 gen y_urban = -2 if spec_urban95 == 1
 66.                 gen y_covid = -3 if spec_covid == 1
 67.                 gen y_covars = -4 if spec_covars == 1
 68.                 gen y_excl = -5 if spec_excl2020 == 1
 69.                 gen y_irs5 = -6 if spec_irs5 == 1
 70.                 gen y_irs5_389 = -7 if spec_irs5_389 == 1
 71. 
.                 twoway  (scatter y_all spec_rank, mc(navy) ms(O) msize(vsmall))         ///
>                                 (scatter y_urban spec_rank, mc(navy) ms(O) msize(vsmall))       ///
>                                 (scatter y_covid spec_rank, mc(navy) ms(O) msize(vsmall))       ///
>                                 (scatter y_covars spec_rank, mc(navy) ms(O) msize(vsmall))      ///
>                                 (scatter y_excl spec_rank, mc(navy) ms(O) msize(vsmall))        ///
>                                 (scatter y_irs5 spec_rank, mc(navy) ms(O) msize(vsmall))        ///
>                                 (scatter y_irs5_389 spec_rank, mc(navy) ms(O) msize(vsmall)), ///
>                         legend(off)                                                                                                             ///
>                         ytitle("")                                                                                                              ///
>                         xtitle("Specification (ranked by effect size)")                                 ///
>                         ylabel( -1 "All Counties"                                                                               ///
>                                         -2 "Urban 95%"                                                                                  ///
>                                         -3 "COVID Match"                                                                                ///
>                                         -4 "Covariates"                                                                                 ///
>                                         -5 "Excl. 2020"                                                                                 ///
>                                         -6 "IRS Interstate (all counties)"                                              ///
>                                         -7 "IRS Interstate (ACS counties)",                                             ///
>                                 angle(0) labsize(vsmall))                                                                       ///
>                         xlabel(none)                                                                                                    ///
>                         name(spec_`otype'_`migr', replace)
 72. 
.                 } // END irs5 lower panel
 73. 
.                 ** Combine panels
.                 graph combine coef_`otype'_`migr' spec_`otype'_`migr',                          ///
>                         cols(1)                                                                                                                 ///
>                         xcommon                                                                                                                 ///
>                         imargin(zero)
 74. 
.                 ** File suffix for IRS5 plots
.                 if "`pset'" == "irs5" local fsuffix "_irs5"
 75.                 else local fsuffix ""
 76. 
.                 ** Export combined figure
.                 graph export "${results}sdid/fig_speccurve_`otype'_`migr'`fsuffix'.pdf", replace
 77.                 graph export "${results}sdid/fig_speccurve_`otype'_`migr'`fsuffix'.jpg", as(jpg) quality(100) replace
 78. 
.                 ** Clean up
.                 graph drop coef_`otype'_`migr' spec_`otype'_`migr'
 79. 
.                 restore
 80. 
.                 } // END PLOT SET LOOP
 81.         } // END MIGRATION LOOP
 82. } // END OUTCOME TYPE LOOP
(576 observations deleted)
(0 observations deleted)
(62 missing values generated)
(62 missing values generated)
(62 missing values generated)
(14 missing values generated)
(14 missing values generated)
(14 missing values generated)
(72 missing values generated)
(72 missing values generated)
(72 missing values generated)
(68 missing values generated)
(68 missing values generated)
(68 missing values generated)
(48 missing values generated)
(48 missing values generated)
(48 missing values generated)
(36 missing values generated)
(36 missing values generated)
(60 missing values generated)
(60 missing values generated)
(48 missing values generated)
(48 missing values generated)
(24 missing values generated)
(48 missing values generated)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/sdid/fig_speccurve_n1_net.pdf saved as PDF format
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/sdid/fig_speccurve_n1_net.jpg written in JPEG format
(576 observations deleted)
(72 observations deleted)
(576 observations deleted)
(0 observations deleted)
(72 missing values generated)
(72 missing values generated)
(72 missing values generated)
(4 missing values generated)
(4 missing values generated)
(4 missing values generated)
(72 missing values generated)
(72 missing values generated)
(72 missing values generated)
(68 missing values generated)
(68 missing values generated)
(68 missing values generated)
(48 missing values generated)
(48 missing values generated)
(48 missing values generated)
(36 missing values generated)
(36 missing values generated)
(60 missing values generated)
(60 missing values generated)
(48 missing values generated)
(48 missing values generated)
(24 missing values generated)
(48 missing values generated)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/sdid/fig_speccurve_n1_in.pdf saved as PDF format
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/sdid/fig_speccurve_n1_in.jpg written in JPEG format
(576 observations deleted)
(72 observations deleted)
(576 observations deleted)
(0 observations deleted)
(36 missing values generated)
(36 missing values generated)
(36 missing values generated)
(40 missing values generated)
(40 missing values generated)
(40 missing values generated)
(71 missing values generated)
(71 missing values generated)
(71 missing values generated)
(69 missing values generated)
(69 missing values generated)
(69 missing values generated)
(48 missing values generated)
(48 missing values generated)
(48 missing values generated)
(36 missing values generated)
(36 missing values generated)
(60 missing values generated)
(60 missing values generated)
(48 missing values generated)
(48 missing values generated)
(24 missing values generated)
(48 missing values generated)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/sdid/fig_speccurve_n1_out.pdf saved as PDF format
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/sdid/fig_speccurve_n1_out.jpg written in JPEG format
(576 observations deleted)
(72 observations deleted)
(576 observations deleted)
(0 observations deleted)
(56 missing values generated)
(56 missing values generated)
(56 missing values generated)
(20 missing values generated)
(20 missing values generated)
(20 missing values generated)
(72 missing values generated)
(72 missing values generated)
(72 missing values generated)
(68 missing values generated)
(68 missing values generated)
(68 missing values generated)
(48 missing values generated)
(48 missing values generated)
(48 missing values generated)
(36 missing values generated)
(36 missing values generated)
(60 missing values generated)
(60 missing values generated)
(48 missing values generated)
(48 missing values generated)
(24 missing values generated)
(48 missing values generated)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/sdid/fig_speccurve_n2_net.pdf saved as PDF format
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/sdid/fig_speccurve_n2_net.jpg written in JPEG format
(576 observations deleted)
(72 observations deleted)
(576 observations deleted)
(0 observations deleted)
(72 missing values generated)
(72 missing values generated)
(72 missing values generated)
(4 missing values generated)
(4 missing values generated)
(4 missing values generated)
(72 missing values generated)
(72 missing values generated)
(72 missing values generated)
(68 missing values generated)
(68 missing values generated)
(68 missing values generated)
(48 missing values generated)
(48 missing values generated)
(48 missing values generated)
(36 missing values generated)
(36 missing values generated)
(60 missing values generated)
(60 missing values generated)
(48 missing values generated)
(48 missing values generated)
(24 missing values generated)
(48 missing values generated)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/sdid/fig_speccurve_n2_in.pdf saved as PDF format
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/sdid/fig_speccurve_n2_in.jpg written in JPEG format
(576 observations deleted)
(72 observations deleted)
(576 observations deleted)
(0 observations deleted)
(30 missing values generated)
(30 missing values generated)
(30 missing values generated)
(46 missing values generated)
(46 missing values generated)
(46 missing values generated)
(70 missing values generated)
(70 missing values generated)
(70 missing values generated)
(70 missing values generated)
(70 missing values generated)
(70 missing values generated)
(48 missing values generated)
(48 missing values generated)
(48 missing values generated)
(36 missing values generated)
(36 missing values generated)
(60 missing values generated)
(60 missing values generated)
(48 missing values generated)
(48 missing values generated)
(24 missing values generated)
(48 missing values generated)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/sdid/fig_speccurve_n2_out.pdf saved as PDF format
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/sdid/fig_speccurve_n2_out.jpg written in JPEG format
(576 observations deleted)
(72 observations deleted)
(576 observations deleted)
(0 observations deleted)
(27 missing values generated)
(27 missing values generated)
(27 missing values generated)
(49 missing values generated)
(49 missing values generated)
(49 missing values generated)
(69 missing values generated)
(69 missing values generated)
(69 missing values generated)
(71 missing values generated)
(71 missing values generated)
(71 missing values generated)
(48 missing values generated)
(48 missing values generated)
(48 missing values generated)
(36 missing values generated)
(36 missing values generated)
(60 missing values generated)
(60 missing values generated)
(48 missing values generated)
(48 missing values generated)
(24 missing values generated)
(48 missing values generated)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/sdid/fig_speccurve_agi_net.pdf saved as PDF format
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/sdid/fig_speccurve_agi_net.jpg written in JPEG format
(576 observations deleted)
(72 observations deleted)
(576 observations deleted)
(0 observations deleted)
(72 missing values generated)
(72 missing values generated)
(72 missing values generated)
(4 missing values generated)
(4 missing values generated)
(4 missing values generated)
(72 missing values generated)
(72 missing values generated)
(72 missing values generated)
(68 missing values generated)
(68 missing values generated)
(68 missing values generated)
(48 missing values generated)
(48 missing values generated)
(48 missing values generated)
(36 missing values generated)
(36 missing values generated)
(60 missing values generated)
(60 missing values generated)
(48 missing values generated)
(48 missing values generated)
(24 missing values generated)
(48 missing values generated)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/sdid/fig_speccurve_agi_in.pdf saved as PDF format
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/sdid/fig_speccurve_agi_in.jpg written in JPEG format
(576 observations deleted)
(72 observations deleted)
(576 observations deleted)
(0 observations deleted)
(7 missing values generated)
(7 missing values generated)
(7 missing values generated)
(69 missing values generated)
(69 missing values generated)
(69 missing values generated)
(70 missing values generated)
(70 missing values generated)
(70 missing values generated)
(70 missing values generated)
(70 missing values generated)
(70 missing values generated)
(48 missing values generated)
(48 missing values generated)
(48 missing values generated)
(36 missing values generated)
(36 missing values generated)
(60 missing values generated)
(60 missing values generated)
(48 missing values generated)
(48 missing values generated)
(24 missing values generated)
(48 missing values generated)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/sdid/fig_speccurve_agi_out.pdf saved as PDF format
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/sdid/fig_speccurve_agi_out.jpg written in JPEG format
(576 observations deleted)
(72 observations deleted)

. 
. ** =============================================================================
. ** FINISH
. ** =============================================================================
. 
end of do-file

. help graph combine

. do "C:\Users\ji252\AppData\Local\Temp\STD5ca0_00000v.tmp"

. 
. ** Load treatment effects
. use "${results}sdid/sdid_results.dta", clear

. 
. ** Parse outcome variable names to extract components
. gen outcome_type = ""
(648 missing values generated)

. replace outcome_type = "n1" if strpos(outcome, "n1_") > 0
variable outcome_type was str1 now str2
(216 real changes made)

. replace outcome_type = "n2" if strpos(outcome, "n2_") > 0
(216 real changes made)

. replace outcome_type = "agi" if strpos(outcome, "agi_") > 0
variable outcome_type was str2 now str3
(216 real changes made)

. 
. gen migration = ""
(648 missing values generated)

. replace migration = "net" if strpos(outcome, "_net_") > 0
variable migration was str1 now str3
(216 real changes made)

. replace migration = "in" if strpos(outcome, "_in_") > 0
(216 real changes made)

. replace migration = "out" if strpos(outcome, "_out_") > 0
(216 real changes made)

. 
. gen data_type = ""
(648 missing values generated)

. replace data_type = "IRS" if strpos(outcome, "_irs") > 0 & strpos(outcome, "_irs5") == 0
variable data_type was str1 now str3
(216 real changes made)

. replace data_type = "IRS (Interstate)" if strpos(outcome, "_irs5") > 0
(0 real changes made)

. replace data_type = "IRS (389)" if strpos(sample_data, "irs_389") > 0 & strpos(outcome, "_irs5") == 0
variable data_type was str3 now str9
(108 real changes made)

. replace data_type = "IRS (389, Interstate)" if strpos(sample_data, "irs_389") > 0 & strpos(outcome, "_irs5") > 0
(0 real changes made)

. replace data_type = "ACS All" if strpos(outcome, "_acs1") > 0
(216 real changes made)

. replace data_type = "ACS College" if strpos(outcome, "_acs2") > 0
variable data_type was str9 now str11
(216 real changes made)

. 
. gen period_type = ""
(648 missing values generated)

. replace period_type = "16-22" if strpos(outcome, "_irs") > 0
variable period_type was str1 now str5
(216 real changes made)

. replace period_type = "16-22" if strpos(sample_data, "16_22") > 0
(216 real changes made)

. replace period_type = "16-24" if strpos(sample_data, "16_24") > 0
(216 real changes made)

. 
. ** Create specification indicators for bottom panel
. gen spec_all = sample == "sample_all"

. gen spec_urban95 = sample == "sample_urban95"

. gen spec_covid = sample == "sample_urban95_covid"

. gen spec_16_22 = period_type == "16-22"

. gen spec_16_24 = period_type == "16-24"

. gen spec_covars = controls == 1

. gen spec_excl2020 = exclusion == 1

. gen spec_irs = data_type == "IRS"

. gen spec_irs5 = data_type == "IRS (Interstate)"

. gen spec_irs_389 = data_type == "IRS (389)"

. gen spec_irs5_389 = data_type == "IRS (389, Interstate)"

. gen spec_acs_all = data_type == "ACS All"

. gen spec_acs_col = data_type == "ACS College"

. 
. ** Calculate statistical significance (p < 0.05)
. replace significant = pval < 0.05 if missing(significant)
(0 real changes made)

. 
. ** =============================================================================
. ** DEFINE PREFERRED SPECIFICATIONS
. ** Modify these conditions to change which specifications are highlighted
. ** as "preferred" in the specification curve plots.
. ** =============================================================================
. 
. gen preferred = 0

. 
. ** Example preferred specification criteria:
. ** - ACS data (full period 2016-2024)
. ** - Urban counties (top 5%)
. ** - With covariates
. ** - Not excluding 2020
. ** Modify these conditions as needed for your analysis.
. 
. 
. ** IRS FULL SAMPLE
. replace preferred = 1 if                                                                        ///
>         data_type == "IRS" &                                                                    ///
>         spec_16_22 == 1 &                                                                               ///
>         inlist(sample, "sample_all", "sample_urban95_covid") &  ///
>         controls == 1 &                                                                                 ///
>         exclusion == 1                                                                                  //
(18 real changes made)

. 
. ** ACS COLLEGE SAMPLE
. replace preferred = 1 if                                                                        ///
>         data_type == "ACS College" &                                                    ///
>         spec_16_24 == 1 &                                                                               ///
>         inlist(sample, "sample_all", "sample_urban95_covid") &  ///
>         controls == 1 &                                                                                 ///
>         exclusion == 1                                                                                  //
(18 real changes made)

. 
. ** Display count of preferred specifications
. dis "Number of preferred specifications: "
Number of preferred specifications: 

. count if preferred == 1
  36

. 
. ** =============================================================================
. ** CREATE SPECIFICATION CURVE PLOTS
. ** =============================================================================
. 
. ** Loop over outcome types, migration directions, and plot sets
. foreach otype in "n1" "n2" "agi" {
  2.         foreach migr in "net" "in" "out" {
  3.                 foreach pset in "main" "irs5" {
  4. 
.                 ** Preserve full data
.                 preserve
  5. 
.                 ** Keep only relevant specifications
.                 keep if outcome_type == "`otype'" & migration == "`migr'"
  6. 
.                 ** Filter by plot set
.                 if "`pset'" == "main" {
  7.                         drop if inlist(data_type, "IRS (Interstate)", "IRS (389, Interstate)")
  8.                 }
  9.                 else if "`pset'" == "irs5" {
 10.                         keep if inlist(data_type, "IRS (Interstate)", "IRS (389, Interstate)")
 11.                 }
 12. 
.                 ** Check if we have data
.                 qui count
 13.                 if r(N) == 0 {
 14.                         restore
 15.                         continue
 16.                 }
 17. 
.                 ** Sort by effect size and create rank
.                 sort tau
 18.                 gen spec_rank = _n
 19.                 local n_specs = _N
 20. 
.                 ** Labels for outcome type
.                 if "`otype'" == "n1" local otype_label "Returns/Households"
 21.                 else if "`otype'" == "n2" local otype_label "Exemptions/Persons"
 22.                 else if "`otype'" == "agi" local otype_label "AGI/Income"
 23. 
.                 ** Labels for migration
.                 if "`migr'" == "net" local migr_label "Net Migration"
 24.                 else if "`migr'" == "in" local migr_label "In-Migration"
 25.                 else if "`migr'" == "out" local migr_label "Out-Migration"
 26. 
.                 ** Title suffix for IRS5 plots
.                 if "`pset'" == "irs5" local pset_title " (Interstate)"
 27.                 else local pset_title ""
 28. 
.                 ** ---------------------------------------------------------------------
.                 ** Create variables for significance and preferred-based coloring
.                 ** Four categories:
.                 **   1. Significant + Not Preferred (navy)
.                 **   2. Insignificant + Not Preferred (ltblue)
.                 **   3. Significant + Preferred (red)
.                 **   4. Insignificant + Preferred (orange)
.                 ** ---------------------------------------------------------------------
. 
.                 ** Significant, not preferred
.                 gen tau_sig_notpref = tau if significant == 1 & preferred == 0
 29.                 gen ci_lo_sig_notpref = ci_lower if significant == 1 & preferred == 0
 30.                 gen ci_hi_sig_notpref = ci_upper if significant == 1 & preferred == 0
 31. 
.                 ** Insignificant, not preferred
.                 gen tau_insig_notpref = tau if significant == 0 & preferred == 0
 32.                 gen ci_lo_insig_notpref = ci_lower if significant == 0 & preferred == 0
 33.                 gen ci_hi_insig_notpref = ci_upper if significant == 0 & preferred == 0
 34. 
.                 ** Significant, preferred
.                 gen tau_sig_pref = tau if significant == 1 & preferred == 1
 35.                 gen ci_lo_sig_pref = ci_lower if significant == 1 & preferred == 1
 36.                 gen ci_hi_sig_pref = ci_upper if significant == 1 & preferred == 1
 37. 
.                 ** Insignificant, preferred
.                 gen tau_insig_pref = tau if significant == 0 & preferred == 1
 38.                 gen ci_lo_insig_pref = ci_lower if significant == 0 & preferred == 1
 39.                 gen ci_hi_insig_pref = ci_upper if significant == 0 & preferred == 1
 40. 
.                 ** Count specifications in each category for legend
.                 qui count if significant == 1 & preferred == 0
 41.                 local n_sig_notpref = r(N)
 42.                 qui count if significant == 0 & preferred == 0
 43.                 local n_insig_notpref = r(N)
 44.                 qui count if significant == 1 & preferred == 1
 45.                 local n_sig_pref = r(N)
 46.                 qui count if significant == 0 & preferred == 1
 47.                 local n_insig_pref = r(N)
 48. 
.                 ** ---------------------------------------------------------------------
.                 ** Create upper panel: Coefficient plot with CIs colored by significance
.                 ** and preferred status
.                 ** ---------------------------------------------------------------------
.                 twoway  (rcap ci_lo_sig_notpref ci_hi_sig_notpref spec_rank,            ///
>                                         lc(navy) lw(vthin))                                                                     ///
>                                 (rcap ci_lo_insig_notpref ci_hi_insig_notpref spec_rank,        ///
>                                         lc(ltblue) lw(vthin))                                                                   ///
>                                 (rcap ci_lo_sig_pref ci_hi_sig_pref spec_rank,                          ///
>                                         lc(cranberry) lw(thin))                                                                 ///
>                                 (rcap ci_lo_insig_pref ci_hi_insig_pref spec_rank,                      ///
>                                         lc(orange) lw(thin))                                                                    ///
>                                 (scatter tau_sig_notpref spec_rank,                                             ///
>                                         mc(navy) ms(O) msize(vsmall))                                                   ///
>                                 (scatter tau_insig_notpref spec_rank,                                           ///
>                                         mc(ltblue) ms(O) msize(vsmall))                                                 ///
>                                 (scatter tau_sig_pref spec_rank,                                                        ///
>                                         mc(cranberry) ms(D) msize(small))                                               ///
>                                 (scatter tau_insig_pref spec_rank,                                                      ///
>                                         mc(orange) ms(D) msize(small)),                                                 ///
>                         legend(order(5 "Sig. (p<0.05)" 6 "Insig."                                               ///
>                                                  7 "Sig., Preferred" 8 "Insig., Preferred")             ///
>                                    rows(1) pos(6) size(vsmall))                                                         ///
>                         ytitle("Treatment Effect (pp)")                                                                 ///
>                         xtitle("")                                                                                                              ///
>                         title("`otype_label': `migr_label'`pset_title'", size(medium))  ///
>                         yline(0, lc(red) lp(dash))                                                                              ///
>                         xlabel(none)                                                                                                    ///
>                         name(coef_`otype'_`migr', replace)
 49. 
.                 ** ---------------------------------------------------------------------
.                 ** Create lower panel: Specification indicators
.                 ** (different indicators depending on main vs irs5 plot set)
.                 ** ---------------------------------------------------------------------
. 
.                 if "`pset'" == "main" {
 50. 
.                 gen y_all = -1 if spec_all == 1
 51.                 gen y_urban = -2 if spec_urban95 == 1
 52.                 gen y_covid = -3 if spec_covid == 1
 53.                 gen y_covars = -4 if spec_covars == 1
 54.                 gen y_excl = -5 if spec_excl2020 == 1
 55.                 gen y_irs = -6 if spec_irs == 1
 56.                 gen y_irs_389 = -7 if spec_irs_389 == 1
 57.                 gen y_acs_all = -8 if spec_acs_all == 1
 58.                 gen y_acs_col = -9 if spec_acs_col == 1
 59.                 gen y_16_22 = -10 if spec_16_22 == 1
 60.                 gen y_16_24 = -11 if spec_16_24 == 1
 61. 
.                 twoway  (scatter y_all spec_rank, mc(navy) ms(O) msize(vsmall))         ///
>                                 (scatter y_urban spec_rank, mc(navy) ms(O) msize(vsmall))       ///
>                                 (scatter y_covid spec_rank, mc(navy) ms(O) msize(vsmall))       ///
>                                 (scatter y_covars spec_rank, mc(navy) ms(O) msize(vsmall))      ///
>                                 (scatter y_excl spec_rank, mc(navy) ms(O) msize(vsmall))        ///
>                                 (scatter y_irs spec_rank, mc(navy) ms(O) msize(vsmall))         ///
>                                 (scatter y_irs_389 spec_rank, mc(navy) ms(O) msize(vsmall))     ///
>                                 (scatter y_acs_all spec_rank, mc(navy) ms(O) msize(vsmall))     ///
>                                 (scatter y_acs_col spec_rank, mc(navy) ms(O) msize(vsmall)) ///
>                                 (scatter y_16_22 spec_rank, mc(navy) ms(O) msize(vsmall))       ///
>                                 (scatter y_16_24 spec_rank, mc(navy) ms(O) msize(vsmall)),      ///
>                         legend(off)                                                                                                             ///
>                         ytitle("")                                                                                                              ///
>                         xtitle("Specification (ranked by effect size)")                                 ///
>                         ylabel( -1 "All Counties"                                                                               ///
>                                         -2 "Urban 95%"                                                                                  ///
>                                         -3 "COVID Match"                                                                                ///
>                                         -4 "Covariates"                                                                                 ///
>                                         -5 "Excl. 2020"                                                                                 ///
>                                         -6 "IRS (all counties)"                                                                 ///
>                                         -7 "IRS (ACS counties)"                                                                 ///
>                                         -8 "ACS All"                                                                                    ///
>                                         -9 "ACS College"                                                                                ///
>                                         -10 "16-22"                                                                                             ///
>                                         -11 "16-24",                                                                                    ///
>                                 angle(0) labsize(vsmall))                                                                       ///
>                         xlabel(none)                                                                                                    ///
>                         name(spec_`otype'_`migr', replace)
 62. 
.                 } // END main lower panel
 63. 
.                 else if "`pset'" == "irs5" {
 64. 
.                 gen y_all = -1 if spec_all == 1
 65.                 gen y_urban = -2 if spec_urban95 == 1
 66.                 gen y_covid = -3 if spec_covid == 1
 67.                 gen y_covars = -4 if spec_covars == 1
 68.                 gen y_excl = -5 if spec_excl2020 == 1
 69.                 gen y_irs5 = -6 if spec_irs5 == 1
 70.                 gen y_irs5_389 = -7 if spec_irs5_389 == 1
 71. 
.                 twoway  (scatter y_all spec_rank, mc(navy) ms(O) msize(vsmall))         ///
>                                 (scatter y_urban spec_rank, mc(navy) ms(O) msize(vsmall))       ///
>                                 (scatter y_covid spec_rank, mc(navy) ms(O) msize(vsmall))       ///
>                                 (scatter y_covars spec_rank, mc(navy) ms(O) msize(vsmall))      ///
>                                 (scatter y_excl spec_rank, mc(navy) ms(O) msize(vsmall))        ///
>                                 (scatter y_irs5 spec_rank, mc(navy) ms(O) msize(vsmall))        ///
>                                 (scatter y_irs5_389 spec_rank, mc(navy) ms(O) msize(vsmall)), ///
>                         legend(off)                                                                                                             ///
>                         ytitle("")                                                                                                              ///
>                         xtitle("Specification (ranked by effect size)")                                 ///
>                         ylabel( -1 "All Counties"                                                                               ///
>                                         -2 "Urban 95%"                                                                                  ///
>                                         -3 "COVID Match"                                                                                ///
>                                         -4 "Covariates"                                                                                 ///
>                                         -5 "Excl. 2020"                                                                                 ///
>                                         -6 "IRS Interstate (all counties)"                                              ///
>                                         -7 "IRS Interstate (ACS counties)",                                             ///
>                                 angle(0) labsize(vsmall))                                                                       ///
>                         xlabel(none)                                                                                                    ///
>                         name(spec_`otype'_`migr', replace)
 72. 
.                 } // END irs5 lower panel
 73. 
.                 ** Combine panels
.                 graph combine coef_`otype'_`migr' spec_`otype'_`migr',                          ///
>                         cols(1)                                                                                                                 ///
>                         xcommon                                                                                                                 ///
>                         imargin(zero)
 74. 
.                 ** File suffix for IRS5 plots
.                 if "`pset'" == "irs5" local fsuffix "_irs5"
 75.                 else local fsuffix ""
 76. 
.                 ** Export combined figure
.                 graph export "${results}sdid/fig_speccurve_`otype'_`migr'`fsuffix'.pdf", replace
 77.                 graph export "${results}sdid/fig_speccurve_`otype'_`migr'`fsuffix'.jpg", as(jpg) quality(100) replace
 78. 
.                 ** Clean up
.                 graph drop coef_`otype'_`migr' spec_`otype'_`migr'
 79. 
.                 restore
 80. 
.                 } // END PLOT SET LOOP
 81.         } // END MIGRATION LOOP
 82. } // END OUTCOME TYPE LOOP
(576 observations deleted)
(0 observations deleted)
(62 missing values generated)
(62 missing values generated)
(62 missing values generated)
(14 missing values generated)
(14 missing values generated)
(14 missing values generated)
(72 missing values generated)
(72 missing values generated)
(72 missing values generated)
(68 missing values generated)
(68 missing values generated)
(68 missing values generated)
(48 missing values generated)
(48 missing values generated)
(48 missing values generated)
(36 missing values generated)
(36 missing values generated)
(60 missing values generated)
(60 missing values generated)
(48 missing values generated)
(48 missing values generated)
(24 missing values generated)
(48 missing values generated)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/sdid/fig_speccurve_n1_net.pdf saved as PDF format
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/sdid/fig_speccurve_n1_net.jpg written in JPEG format
(576 observations deleted)
(72 observations deleted)
(576 observations deleted)
(0 observations deleted)
(72 missing values generated)
(72 missing values generated)
(72 missing values generated)
(4 missing values generated)
(4 missing values generated)
(4 missing values generated)
(72 missing values generated)
(72 missing values generated)
(72 missing values generated)
(68 missing values generated)
(68 missing values generated)
(68 missing values generated)
(48 missing values generated)
(48 missing values generated)
(48 missing values generated)
(36 missing values generated)
(36 missing values generated)
(60 missing values generated)
(60 missing values generated)
(48 missing values generated)
(48 missing values generated)
(24 missing values generated)
(48 missing values generated)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/sdid/fig_speccurve_n1_in.pdf saved as PDF format
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/sdid/fig_speccurve_n1_in.jpg written in JPEG format
(576 observations deleted)
(72 observations deleted)
(576 observations deleted)
(0 observations deleted)
(36 missing values generated)
(36 missing values generated)
(36 missing values generated)
(40 missing values generated)
(40 missing values generated)
(40 missing values generated)
(71 missing values generated)
(71 missing values generated)
(71 missing values generated)
(69 missing values generated)
(69 missing values generated)
(69 missing values generated)
(48 missing values generated)
(48 missing values generated)
(48 missing values generated)
(36 missing values generated)
(36 missing values generated)
(60 missing values generated)
(60 missing values generated)
(48 missing values generated)
(48 missing values generated)
(24 missing values generated)
(48 missing values generated)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/sdid/fig_speccurve_n1_out.pdf saved as PDF format
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/sdid/fig_speccurve_n1_out.jpg written in JPEG format
(576 observations deleted)
(72 observations deleted)
(576 observations deleted)
(0 observations deleted)
(56 missing values generated)
(56 missing values generated)
(56 missing values generated)
(20 missing values generated)
(20 missing values generated)
(20 missing values generated)
(72 missing values generated)
(72 missing values generated)
(72 missing values generated)
(68 missing values generated)
(68 missing values generated)
(68 missing values generated)
(48 missing values generated)
(48 missing values generated)
(48 missing values generated)
(36 missing values generated)
(36 missing values generated)
(60 missing values generated)
(60 missing values generated)
(48 missing values generated)
(48 missing values generated)
(24 missing values generated)
(48 missing values generated)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/sdid/fig_speccurve_n2_net.pdf saved as PDF format
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/sdid/fig_speccurve_n2_net.jpg written in JPEG format
(576 observations deleted)
(72 observations deleted)
(576 observations deleted)
(0 observations deleted)
(72 missing values generated)
(72 missing values generated)
(72 missing values generated)
(4 missing values generated)
(4 missing values generated)
(4 missing values generated)
(72 missing values generated)
(72 missing values generated)
(72 missing values generated)
(68 missing values generated)
(68 missing values generated)
(68 missing values generated)
(48 missing values generated)
(48 missing values generated)
(48 missing values generated)
(36 missing values generated)
(36 missing values generated)
(60 missing values generated)
(60 missing values generated)
(48 missing values generated)
(48 missing values generated)
(24 missing values generated)
(48 missing values generated)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/sdid/fig_speccurve_n2_in.pdf saved as PDF format
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/sdid/fig_speccurve_n2_in.jpg written in JPEG format
(576 observations deleted)
(72 observations deleted)
(576 observations deleted)
(0 observations deleted)
(30 missing values generated)
(30 missing values generated)
(30 missing values generated)
(46 missing values generated)
(46 missing values generated)
(46 missing values generated)
(70 missing values generated)
(70 missing values generated)
(70 missing values generated)
(70 missing values generated)
(70 missing values generated)
(70 missing values generated)
(48 missing values generated)
(48 missing values generated)
(48 missing values generated)
(36 missing values generated)
(36 missing values generated)
(60 missing values generated)
(60 missing values generated)
(48 missing values generated)
(48 missing values generated)
(24 missing values generated)
(48 missing values generated)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/sdid/fig_speccurve_n2_out.pdf saved as PDF format
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/sdid/fig_speccurve_n2_out.jpg written in JPEG format
(576 observations deleted)
(72 observations deleted)
(576 observations deleted)
(0 observations deleted)
(27 missing values generated)
(27 missing values generated)
(27 missing values generated)
(49 missing values generated)
(49 missing values generated)
(49 missing values generated)
(69 missing values generated)
(69 missing values generated)
(69 missing values generated)
(71 missing values generated)
(71 missing values generated)
(71 missing values generated)
(48 missing values generated)
(48 missing values generated)
(48 missing values generated)
(36 missing values generated)
(36 missing values generated)
(60 missing values generated)
(60 missing values generated)
(48 missing values generated)
(48 missing values generated)
(24 missing values generated)
(48 missing values generated)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/sdid/fig_speccurve_agi_net.pdf saved as PDF format
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/sdid/fig_speccurve_agi_net.jpg written in JPEG format
(576 observations deleted)
(72 observations deleted)
(576 observations deleted)
(0 observations deleted)
(72 missing values generated)
(72 missing values generated)
(72 missing values generated)
(4 missing values generated)
(4 missing values generated)
(4 missing values generated)
(72 missing values generated)
(72 missing values generated)
(72 missing values generated)
(68 missing values generated)
(68 missing values generated)
(68 missing values generated)
(48 missing values generated)
(48 missing values generated)
(48 missing values generated)
(36 missing values generated)
(36 missing values generated)
(60 missing values generated)
(60 missing values generated)
(48 missing values generated)
(48 missing values generated)
(24 missing values generated)
(48 missing values generated)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/sdid/fig_speccurve_agi_in.pdf saved as PDF format
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/sdid/fig_speccurve_agi_in.jpg written in JPEG format
(576 observations deleted)
(72 observations deleted)
(576 observations deleted)
(0 observations deleted)
(7 missing values generated)
(7 missing values generated)
(7 missing values generated)
(69 missing values generated)
(69 missing values generated)
(69 missing values generated)
(70 missing values generated)
(70 missing values generated)
(70 missing values generated)
(70 missing values generated)
(70 missing values generated)
(70 missing values generated)
(48 missing values generated)
(48 missing values generated)
(48 missing values generated)
(36 missing values generated)
(36 missing values generated)
(60 missing values generated)
(60 missing values generated)
(48 missing values generated)
(48 missing values generated)
(24 missing values generated)
(48 missing values generated)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/sdid/fig_speccurve_agi_out.pdf saved as PDF format
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/sdid/fig_speccurve_agi_out.jpg written in JPEG format
(576 observations deleted)
(72 observations deleted)

. 
end of do-file

. do "C:\Users\ji252\AppData\Local\Temp\STD5ca0_00000w.tmp"

. 
. ** Load treatment effects
. use "${results}sdid/sdid_results.dta", clear

. 
. ** Parse outcome variable names to extract components
. gen outcome_type = ""
(648 missing values generated)

. replace outcome_type = "n1" if strpos(outcome, "n1_") > 0
variable outcome_type was str1 now str2
(216 real changes made)

. replace outcome_type = "n2" if strpos(outcome, "n2_") > 0
(216 real changes made)

. replace outcome_type = "agi" if strpos(outcome, "agi_") > 0
variable outcome_type was str2 now str3
(216 real changes made)

. 
. gen migration = ""
(648 missing values generated)

. replace migration = "net" if strpos(outcome, "_net_") > 0
variable migration was str1 now str3
(216 real changes made)

. replace migration = "in" if strpos(outcome, "_in_") > 0
(216 real changes made)

. replace migration = "out" if strpos(outcome, "_out_") > 0
(216 real changes made)

. 
. gen data_type = ""
(648 missing values generated)

. replace data_type = "IRS" if strpos(outcome, "_irs") > 0 & strpos(outcome, "_irs5") == 0
variable data_type was str1 now str3
(216 real changes made)

. replace data_type = "IRS (Interstate)" if strpos(outcome, "_irs5") > 0
(0 real changes made)

. replace data_type = "IRS (389)" if strpos(sample_data, "irs_389") > 0 & strpos(outcome, "_irs5") == 0
variable data_type was str3 now str9
(108 real changes made)

. replace data_type = "IRS (389, Interstate)" if strpos(sample_data, "irs_389") > 0 & strpos(outcome, "_irs5") > 0
(0 real changes made)

. replace data_type = "ACS All" if strpos(outcome, "_acs1") > 0
(216 real changes made)

. replace data_type = "ACS College" if strpos(outcome, "_acs2") > 0
variable data_type was str9 now str11
(216 real changes made)

. 
. gen period_type = ""
(648 missing values generated)

. replace period_type = "16-22" if strpos(outcome, "_irs") > 0
variable period_type was str1 now str5
(216 real changes made)

. replace period_type = "16-22" if strpos(sample_data, "16_22") > 0
(216 real changes made)

. replace period_type = "16-24" if strpos(sample_data, "16_24") > 0
(216 real changes made)

. 
. ** Create specification indicators for bottom panel
. gen spec_all = sample == "sample_all"

. gen spec_urban95 = sample == "sample_urban95"

. gen spec_covid = sample == "sample_urban95_covid"

. gen spec_16_22 = period_type == "16-22"

. gen spec_16_24 = period_type == "16-24"

. gen spec_covars = controls == 1

. gen spec_excl2020 = exclusion == 1

. gen spec_irs = data_type == "IRS"

. gen spec_irs5 = data_type == "IRS (Interstate)"

. gen spec_irs_389 = data_type == "IRS (389)"

. gen spec_irs5_389 = data_type == "IRS (389, Interstate)"

. gen spec_acs_all = data_type == "ACS All"

. gen spec_acs_col = data_type == "ACS College"

. 
. ** Calculate statistical significance (p < 0.05)
. replace significant = pval < 0.05 if missing(significant)
(0 real changes made)

. 
. ** =============================================================================
. ** DEFINE PREFERRED SPECIFICATIONS
. ** Modify these conditions to change which specifications are highlighted
. ** as "preferred" in the specification curve plots.
. ** =============================================================================
. 
. gen preferred = 0

. 
. ** Example preferred specification criteria:
. ** - ACS data (full period 2016-2024)
. ** - Urban counties (top 5%)
. ** - With covariates
. ** - Not excluding 2020
. ** Modify these conditions as needed for your analysis.
. 
. 
. ** IRS FULL SAMPLE
. replace preferred = 1 if                                                                        ///
>         data_type == "IRS" &                                                                    ///
>         spec_16_22 == 1 &                                                                               ///
>         inlist(sample, "sample_all", "sample_urban95_covid") &  ///
>         controls == 1 &                                                                                 ///
>         exclusion == 1                                                                                  //
(18 real changes made)

. 
. ** ACS COLLEGE SAMPLE
. replace preferred = 1 if                                                                        ///
>         data_type == "ACS College" &                                                    ///
>         spec_16_24 == 1 &                                                                               ///
>         inlist(sample, "sample_all", "sample_urban95_covid") &  ///
>         controls == 1 &                                                                                 ///
>         exclusion == 1                                                                                  //
(18 real changes made)

. 
. ** Display count of preferred specifications
. dis "Number of preferred specifications: "
Number of preferred specifications: 

. count if preferred == 1
  36

. 
. ** =============================================================================
. ** CREATE SPECIFICATION CURVE PLOTS
. ** =============================================================================
. 
. ** Loop over outcome types, migration directions, and plot sets
. foreach otype in "n1" "n2" "agi" {
  2.         foreach migr in "net" "in" "out" {
  3.                 foreach pset in "main" "irs5" {
  4. 
.                 ** Preserve full data
.                 preserve
  5. 
.                 ** Keep only relevant specifications
.                 keep if outcome_type == "`otype'" & migration == "`migr'"
  6. 
.                 ** Filter by plot set
.                 if "`pset'" == "main" {
  7.                         drop if inlist(data_type, "IRS (Interstate)", "IRS (389, Interstate)")
  8.                 }
  9.                 else if "`pset'" == "irs5" {
 10.                         keep if inlist(data_type, "IRS (Interstate)", "IRS (389, Interstate)")
 11.                 }
 12. 
.                 ** Check if we have data
.                 qui count
 13.                 if r(N) == 0 {
 14.                         restore
 15.                         continue
 16.                 }
 17. 
.                 ** Sort by effect size and create rank
.                 sort tau
 18.                 gen spec_rank = _n
 19.                 local n_specs = _N
 20. 
.                 ** Labels for outcome type
.                 if "`otype'" == "n1" local otype_label "Returns/Households"
 21.                 else if "`otype'" == "n2" local otype_label "Exemptions/Persons"
 22.                 else if "`otype'" == "agi" local otype_label "AGI/Income"
 23. 
.                 ** Labels for migration
.                 if "`migr'" == "net" local migr_label "Net Migration"
 24.                 else if "`migr'" == "in" local migr_label "In-Migration"
 25.                 else if "`migr'" == "out" local migr_label "Out-Migration"
 26. 
.                 ** Title suffix for IRS5 plots
.                 if "`pset'" == "irs5" local pset_title " (Interstate)"
 27.                 else local pset_title ""
 28. 
.                 ** ---------------------------------------------------------------------
.                 ** Create variables for significance and preferred-based coloring
.                 ** Four categories:
.                 **   1. Significant + Not Preferred (navy)
.                 **   2. Insignificant + Not Preferred (ltblue)
.                 **   3. Significant + Preferred (red)
.                 **   4. Insignificant + Preferred (orange)
.                 ** ---------------------------------------------------------------------
. 
.                 ** Significant, not preferred
.                 gen tau_sig_notpref = tau if significant == 1 & preferred == 0
 29.                 gen ci_lo_sig_notpref = ci_lower if significant == 1 & preferred == 0
 30.                 gen ci_hi_sig_notpref = ci_upper if significant == 1 & preferred == 0
 31. 
.                 ** Insignificant, not preferred
.                 gen tau_insig_notpref = tau if significant == 0 & preferred == 0
 32.                 gen ci_lo_insig_notpref = ci_lower if significant == 0 & preferred == 0
 33.                 gen ci_hi_insig_notpref = ci_upper if significant == 0 & preferred == 0
 34. 
.                 ** Significant, preferred
.                 gen tau_sig_pref = tau if significant == 1 & preferred == 1
 35.                 gen ci_lo_sig_pref = ci_lower if significant == 1 & preferred == 1
 36.                 gen ci_hi_sig_pref = ci_upper if significant == 1 & preferred == 1
 37. 
.                 ** Insignificant, preferred
.                 gen tau_insig_pref = tau if significant == 0 & preferred == 1
 38.                 gen ci_lo_insig_pref = ci_lower if significant == 0 & preferred == 1
 39.                 gen ci_hi_insig_pref = ci_upper if significant == 0 & preferred == 1
 40. 
.                 ** Count specifications in each category for legend
.                 qui count if significant == 1 & preferred == 0
 41.                 local n_sig_notpref = r(N)
 42.                 qui count if significant == 0 & preferred == 0
 43.                 local n_insig_notpref = r(N)
 44.                 qui count if significant == 1 & preferred == 1
 45.                 local n_sig_pref = r(N)
 46.                 qui count if significant == 0 & preferred == 1
 47.                 local n_insig_pref = r(N)
 48. 
.                 ** ---------------------------------------------------------------------
.                 ** Create upper panel: Coefficient plot with CIs colored by significance
.                 ** and preferred status
.                 ** ---------------------------------------------------------------------
.                 twoway  (rcap ci_lo_sig_notpref ci_hi_sig_notpref spec_rank,            ///
>                                         lc(navy) lw(vthin))                                                                     ///
>                                 (rcap ci_lo_insig_notpref ci_hi_insig_notpref spec_rank,        ///
>                                         lc(ltblue) lw(vthin))                                                                   ///
>                                 (rcap ci_lo_sig_pref ci_hi_sig_pref spec_rank,                          ///
>                                         lc(cranberry) lw(thin))                                                                 ///
>                                 (rcap ci_lo_insig_pref ci_hi_insig_pref spec_rank,                      ///
>                                         lc(orange) lw(thin))                                                                    ///
>                                 (scatter tau_sig_notpref spec_rank,                                             ///
>                                         mc(navy) ms(O) msize(vsmall))                                                   ///
>                                 (scatter tau_insig_notpref spec_rank,                                           ///
>                                         mc(ltblue) ms(O) msize(vsmall))                                                 ///
>                                 (scatter tau_sig_pref spec_rank,                                                        ///
>                                         mc(cranberry) ms(D) msize(small))                                               ///
>                                 (scatter tau_insig_pref spec_rank,                                                      ///
>                                         mc(orange) ms(D) msize(small)),                                                 ///
>                         legend(order(5 "Sig. (p<0.05)" 6 "Insig."                                               ///
>                                                  7 "Sig., Preferred" 8 "Insig., Preferred")             ///
>                                    rows(1) pos(6) size(vsmall))                                                         ///
>                         ytitle("Treatment Effect (pp)")                                                                 ///
>                         xtitle("")                                                                                                              ///
>                         title("`otype_label': `migr_label'`pset_title'", size(medium))  ///
>                         yline(0, lc(red) lp(dash))                                                                              ///
>                         xlabel(none)                                                                                                    ///
>                         xscale(range(0.5 `=`n_specs'+0.5'))                                             ///
>                         name(coef_`otype'_`migr', replace)
 49. 
.                 ** ---------------------------------------------------------------------
.                 ** Create lower panel: Specification indicators
.                 ** (different indicators depending on main vs irs5 plot set)
.                 ** ---------------------------------------------------------------------
. 
.                 if "`pset'" == "main" {
 50. 
.                 gen y_all = -1 if spec_all == 1
 51.                 gen y_urban = -2 if spec_urban95 == 1
 52.                 gen y_covid = -3 if spec_covid == 1
 53.                 gen y_covars = -4 if spec_covars == 1
 54.                 gen y_excl = -5 if spec_excl2020 == 1
 55.                 gen y_irs = -6 if spec_irs == 1
 56.                 gen y_irs_389 = -7 if spec_irs_389 == 1
 57.                 gen y_acs_all = -8 if spec_acs_all == 1
 58.                 gen y_acs_col = -9 if spec_acs_col == 1
 59.                 gen y_16_22 = -10 if spec_16_22 == 1
 60.                 gen y_16_24 = -11 if spec_16_24 == 1
 61. 
.                 twoway  (scatter y_all spec_rank, mc(navy) ms(O) msize(vsmall))         ///
>                                 (scatter y_urban spec_rank, mc(navy) ms(O) msize(vsmall))       ///
>                                 (scatter y_covid spec_rank, mc(navy) ms(O) msize(vsmall))       ///
>                                 (scatter y_covars spec_rank, mc(navy) ms(O) msize(vsmall))      ///
>                                 (scatter y_excl spec_rank, mc(navy) ms(O) msize(vsmall))        ///
>                                 (scatter y_irs spec_rank, mc(navy) ms(O) msize(vsmall))         ///
>                                 (scatter y_irs_389 spec_rank, mc(navy) ms(O) msize(vsmall))     ///
>                                 (scatter y_acs_all spec_rank, mc(navy) ms(O) msize(vsmall))     ///
>                                 (scatter y_acs_col spec_rank, mc(navy) ms(O) msize(vsmall)) ///
>                                 (scatter y_16_22 spec_rank, mc(navy) ms(O) msize(vsmall))       ///
>                                 (scatter y_16_24 spec_rank, mc(navy) ms(O) msize(vsmall)),      ///
>                         legend(off)                                                                                                             ///
>                         ytitle("")                                                                                                              ///
>                         xtitle("Specification (ranked by effect size)")                                 ///
>                         ylabel( -1 "All Counties"                                                                               ///
>                                         -2 "Urban 95%"                                                                                  ///
>                                         -3 "COVID Match"                                                                                ///
>                                         -4 "Covariates"                                                                                 ///
>                                         -5 "Excl. 2020"                                                                                 ///
>                                         -6 "IRS (all counties)"                                                                 ///
>                                         -7 "IRS (ACS counties)"                                                                 ///
>                                         -8 "ACS All"                                                                                    ///
>                                         -9 "ACS College"                                                                                ///
>                                         -10 "16-22"                                                                                             ///
>                                         -11 "16-24",                                                                                    ///
>                                 angle(0) labsize(vsmall))                                                                       ///
>                         xlabel(none)                                                                                                    ///
>                         xscale(range(0.5 `=`n_specs'+0.5'))                                             ///
>                         name(spec_`otype'_`migr', replace)
 62. 
.                 } // END main lower panel
 63. 
.                 else if "`pset'" == "irs5" {
 64. 
.                 gen y_all = -1 if spec_all == 1
 65.                 gen y_urban = -2 if spec_urban95 == 1
 66.                 gen y_covid = -3 if spec_covid == 1
 67.                 gen y_covars = -4 if spec_covars == 1
 68.                 gen y_excl = -5 if spec_excl2020 == 1
 69.                 gen y_irs5 = -6 if spec_irs5 == 1
 70.                 gen y_irs5_389 = -7 if spec_irs5_389 == 1
 71. 
.                 twoway  (scatter y_all spec_rank, mc(navy) ms(O) msize(vsmall))         ///
>                                 (scatter y_urban spec_rank, mc(navy) ms(O) msize(vsmall))       ///
>                                 (scatter y_covid spec_rank, mc(navy) ms(O) msize(vsmall))       ///
>                                 (scatter y_covars spec_rank, mc(navy) ms(O) msize(vsmall))      ///
>                                 (scatter y_excl spec_rank, mc(navy) ms(O) msize(vsmall))        ///
>                                 (scatter y_irs5 spec_rank, mc(navy) ms(O) msize(vsmall))        ///
>                                 (scatter y_irs5_389 spec_rank, mc(navy) ms(O) msize(vsmall)), ///
>                         legend(off)                                                                                                             ///
>                         ytitle("")                                                                                                              ///
>                         xtitle("Specification (ranked by effect size)")                                 ///
>                         ylabel( -1 "All Counties"                                                                               ///
>                                         -2 "Urban 95%"                                                                                  ///
>                                         -3 "COVID Match"                                                                                ///
>                                         -4 "Covariates"                                                                                 ///
>                                         -5 "Excl. 2020"                                                                                 ///
>                                         -6 "IRS Interstate (all counties)"                                              ///
>                                         -7 "IRS Interstate (ACS counties)",                                             ///
>                                 angle(0) labsize(vsmall))                                                                       ///
>                         xlabel(none)                                                                                                    ///
>                         xscale(range(0.5 `=`n_specs'+0.5'))                                             ///
>                         name(spec_`otype'_`migr', replace)
 72. 
.                 } // END irs5 lower panel
 73. 
.                 ** Combine panels
.                 graph combine coef_`otype'_`migr' spec_`otype'_`migr',                          ///
>                         cols(1)                                                                                                                 ///
>                         xcommon                                                                                                                 ///
>                         imargin(zero)
 74. 
.                 ** File suffix for IRS5 plots
.                 if "`pset'" == "irs5" local fsuffix "_irs5"
 75.                 else local fsuffix ""
 76. 
.                 ** Export combined figure
.                 graph export "${results}sdid/fig_speccurve_`otype'_`migr'`fsuffix'.pdf", replace
 77.                 graph export "${results}sdid/fig_speccurve_`otype'_`migr'`fsuffix'.jpg", as(jpg) quality(100) replace
 78. 
.                 ** Clean up
.                 graph drop coef_`otype'_`migr' spec_`otype'_`migr'
 79. 
.                 restore
 80. 
.                 } // END PLOT SET LOOP
 81.         } // END MIGRATION LOOP
 82. } // END OUTCOME TYPE LOOP
(576 observations deleted)
(0 observations deleted)
(62 missing values generated)
(62 missing values generated)
(62 missing values generated)
(14 missing values generated)
(14 missing values generated)
(14 missing values generated)
(72 missing values generated)
(72 missing values generated)
(72 missing values generated)
(68 missing values generated)
(68 missing values generated)
(68 missing values generated)
(48 missing values generated)
(48 missing values generated)
(48 missing values generated)
(36 missing values generated)
(36 missing values generated)
(60 missing values generated)
(60 missing values generated)
(48 missing values generated)
(48 missing values generated)
(24 missing values generated)
(48 missing values generated)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/sdid/fig_speccurve_n1_net.pdf saved as PDF format
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/sdid/fig_speccurve_n1_net.jpg written in JPEG format
(576 observations deleted)
(72 observations deleted)
(576 observations deleted)
(0 observations deleted)
(72 missing values generated)
(72 missing values generated)
(72 missing values generated)
(4 missing values generated)
(4 missing values generated)
(4 missing values generated)
(72 missing values generated)
(72 missing values generated)
(72 missing values generated)
(68 missing values generated)
(68 missing values generated)
(68 missing values generated)
(48 missing values generated)
(48 missing values generated)
(48 missing values generated)
(36 missing values generated)
(36 missing values generated)
(60 missing values generated)
(60 missing values generated)
(48 missing values generated)
(48 missing values generated)
(24 missing values generated)
(48 missing values generated)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/sdid/fig_speccurve_n1_in.pdf saved as PDF format
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/sdid/fig_speccurve_n1_in.jpg written in JPEG format
(576 observations deleted)
(72 observations deleted)
(576 observations deleted)
(0 observations deleted)
(36 missing values generated)
(36 missing values generated)
(36 missing values generated)
(40 missing values generated)
(40 missing values generated)
(40 missing values generated)
(71 missing values generated)
(71 missing values generated)
(71 missing values generated)
(69 missing values generated)
(69 missing values generated)
(69 missing values generated)
(48 missing values generated)
(48 missing values generated)
(48 missing values generated)
(36 missing values generated)
(36 missing values generated)
(60 missing values generated)
(60 missing values generated)
(48 missing values generated)
(48 missing values generated)
(24 missing values generated)
(48 missing values generated)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/sdid/fig_speccurve_n1_out.pdf saved as PDF format
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/sdid/fig_speccurve_n1_out.jpg written in JPEG format
(576 observations deleted)
(72 observations deleted)
(576 observations deleted)
(0 observations deleted)
(56 missing values generated)
(56 missing values generated)
(56 missing values generated)
(20 missing values generated)
(20 missing values generated)
(20 missing values generated)
(72 missing values generated)
(72 missing values generated)
(72 missing values generated)
(68 missing values generated)
(68 missing values generated)
(68 missing values generated)
(48 missing values generated)
(48 missing values generated)
(48 missing values generated)
(36 missing values generated)
(36 missing values generated)
(60 missing values generated)
(60 missing values generated)
(48 missing values generated)
(48 missing values generated)
(24 missing values generated)
(48 missing values generated)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/sdid/fig_speccurve_n2_net.pdf saved as PDF format
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/sdid/fig_speccurve_n2_net.jpg written in JPEG format
(576 observations deleted)
(72 observations deleted)
(576 observations deleted)
(0 observations deleted)
(72 missing values generated)
(72 missing values generated)
(72 missing values generated)
(4 missing values generated)
(4 missing values generated)
(4 missing values generated)
(72 missing values generated)
(72 missing values generated)
(72 missing values generated)
(68 missing values generated)
(68 missing values generated)
(68 missing values generated)
(48 missing values generated)
(48 missing values generated)
(48 missing values generated)
(36 missing values generated)
(36 missing values generated)
(60 missing values generated)
(60 missing values generated)
(48 missing values generated)
(48 missing values generated)
(24 missing values generated)
(48 missing values generated)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/sdid/fig_speccurve_n2_in.pdf saved as PDF format
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/sdid/fig_speccurve_n2_in.jpg written in JPEG format
(576 observations deleted)
(72 observations deleted)
(576 observations deleted)
(0 observations deleted)
(30 missing values generated)
(30 missing values generated)
(30 missing values generated)
(46 missing values generated)
(46 missing values generated)
(46 missing values generated)
(70 missing values generated)
(70 missing values generated)
(70 missing values generated)
(70 missing values generated)
(70 missing values generated)
(70 missing values generated)
(48 missing values generated)
(48 missing values generated)
(48 missing values generated)
(36 missing values generated)
(36 missing values generated)
(60 missing values generated)
(60 missing values generated)
(48 missing values generated)
(48 missing values generated)
(24 missing values generated)
(48 missing values generated)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/sdid/fig_speccurve_n2_out.pdf saved as PDF format
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/sdid/fig_speccurve_n2_out.jpg written in JPEG format
(576 observations deleted)
(72 observations deleted)
(576 observations deleted)
(0 observations deleted)
(27 missing values generated)
(27 missing values generated)
(27 missing values generated)
(49 missing values generated)
(49 missing values generated)
(49 missing values generated)
(69 missing values generated)
(69 missing values generated)
(69 missing values generated)
(71 missing values generated)
(71 missing values generated)
(71 missing values generated)
(48 missing values generated)
(48 missing values generated)
(48 missing values generated)
(36 missing values generated)
(36 missing values generated)
(60 missing values generated)
(60 missing values generated)
(48 missing values generated)
(48 missing values generated)
(24 missing values generated)
(48 missing values generated)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/sdid/fig_speccurve_agi_net.pdf saved as PDF format
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/sdid/fig_speccurve_agi_net.jpg written in JPEG format
(576 observations deleted)
(72 observations deleted)
(576 observations deleted)
(0 observations deleted)
(72 missing values generated)
(72 missing values generated)
(72 missing values generated)
(4 missing values generated)
(4 missing values generated)
(4 missing values generated)
(72 missing values generated)
(72 missing values generated)
(72 missing values generated)
(68 missing values generated)
(68 missing values generated)
(68 missing values generated)
(48 missing values generated)
(48 missing values generated)
(48 missing values generated)
(36 missing values generated)
(36 missing values generated)
(60 missing values generated)
(60 missing values generated)
(48 missing values generated)
(48 missing values generated)
(24 missing values generated)
(48 missing values generated)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/sdid/fig_speccurve_agi_in.pdf saved as PDF format
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/sdid/fig_speccurve_agi_in.jpg written in JPEG format
(576 observations deleted)
(72 observations deleted)
(576 observations deleted)
(0 observations deleted)
(7 missing values generated)
(7 missing values generated)
(7 missing values generated)
(69 missing values generated)
(69 missing values generated)
(69 missing values generated)
(70 missing values generated)
(70 missing values generated)
(70 missing values generated)
(70 missing values generated)
(70 missing values generated)
(70 missing values generated)
(48 missing values generated)
(48 missing values generated)
(48 missing values generated)
(36 missing values generated)
(36 missing values generated)
(60 missing values generated)
(60 missing values generated)
(48 missing values generated)
(48 missing values generated)
(24 missing values generated)
(48 missing values generated)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/sdid/fig_speccurve_agi_out.pdf saved as PDF format
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/sdid/fig_speccurve_agi_out.jpg written in JPEG format
(576 observations deleted)
(72 observations deleted)

. 
end of do-file

. do "C:\Users\ji252\AppData\Local\Temp\STD5ca0_00000x.tmp"

. ** Create maps 
. rcall script "${code}R/map_code.R", vanilla
Reading layer `Metro_District_Boundary' from data source 
  `C:\Users\ji252\Documents\GitHub\multnomah-county-tax\data\mapping\Metro_District_Boundary\Metro_District_Boundary.shp' 
  using driver `ESRI Shapefile'
Simple feature collection with 1 feature and 4 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: 7522267 ymin: 596871.4 xmax: 7732958 ymax: 733890
Projected CRS: NAD83(HARN) / Oregon North (ft)
Warning message:
 In  :  

. 
end of do-file

. do "C:\Users\ji252\AppData\Local\Temp\STD5ca0_000010.tmp"

. ** Descriptives 
. do ${code}02_descriptives.do 

. /*******************************************************************************
> File Name:              02_descriptives.do
> Creator:                John Iselin
> Date Update:    January 30, 2026
> 
> Called by: 00_multnomah.do
> 
> Purpose: Perform descriptive analysis
> 
> Outputs:
> - multnomah_flow_comparison_[n1|n2|agi].dta/csv: Pre-post flow comparison with:
>   - Raw flows (out_pre, out_post, in_pre, in_post)
>   - Multnomah baseline population (pop_pre, pop_post)
>   - Migration rates as % of Multnomah population (out_rate_*, in_rate_*)
>   - Rate changes in percentage points (out_rate_change, in_rate_change, net_rate_change)
> 
> - multnomah_partner_flows_[n1|n2|agi].dta/csv: Partner-normalized flows for maps:
>   - Out-migration rates per 100K of DESTINATION county population
>   - In-migration rates per 100K of ORIGIN county population
>   - Used by R/map_code.R to create directional flow maps
> 
> - table2.xlsx: Migration rates for Multnomah and neighboring counties
>   - Sheet "IRS": IRS-based rates (2016-19 vs 2021-22)
>   - Sheet "ACS": ACS-based rates (2016-19 vs 2021-22 vs 2021-24)
>   - Rows: Multnomah, neighboring OR/WA counties, all other OR/WA combined
>   - Rates: in-migration and out-migration as % of partner county population
>   - Change in net in-migration rate (in_rate - out_rate) from pre to post period
> 
> Authors: John Iselin
> 
> For more information, contact john.iselin@yale.edu
> 
> *******************************************************************************/
. 
. ** Start log file 
. capture log close log_02
