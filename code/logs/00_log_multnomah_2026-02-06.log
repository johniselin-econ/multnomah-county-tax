---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  C:/Users/ji252/Documents/GitHub/multnomah-county-tax/code/logs/00_log_multnomah_2026-02-06.log
  log type:  text
 opened on:   6 Feb 2026, 11:16:51

. 
. ** Set Seed 
. set seed 56403

. 
. ** Set scheme
. set scheme plotplainblind

. 
. ** PARALLEL PROCESSING FLAG
. ** Set to 1 to use parallel processing, 0 for sequential processing
. global use_parallel = 1

. 
. ** Set parameters 
. local overwrite_csv = 0

. global start_year_acs = 2015

. global end_year_acs = 2024

. 
. ** CALL R CODE TO IMPORT IPUMS DATA 
. rcall script "${code}R/api_code.R", ///
>     args( project_root  <- "${dir}"; ///
>           dir_data_acs  <- "${data}acs"; ///
>           api_codes_path<- "${dir}api_codes.txt"; ///
>           start_year    <- ${start_year_acs}; ///
>           end_year      <- ${end_year_acs}; ///
>           overwrite_csv <- as.logical(`overwrite_csv'); ///
>     ) vanilla
Warning message:
 In read.table(file = file, header = header, sep = sep, quote = quote, dec = dec, fill = fill, comment.char = comment.char, ...) : incomplete final line found by readTableHeader on 'C:/Users/ji252/Docu
> ments/GitHub/multnomah-county-tax/api_codes.txt' 

. 
. ** CLEAN DATA (01)
. ** (a)  Demographic data via IPUMS NHGIS 
. **              - https://www.nhgis.org/
. ** (b)  Individual-level ACS data via IPUMS USA 
. **              - https://usa.ipums.org/usa/index.shtml
. ** (c)  County-level IRS migration via IRS SOI 
. **              - https://www.irs.gov/statistics/soi-tax-stats-migration-data
. ** (d) County-level IRS data via IRS SOI 
. **              - https://www.irs.gov/statistics/soi-tax-stats-county-data
. ** (e) NYTimes Covid-19 Cases and Deaths by county
. **              - https://github.com/nytimes/covid-19-data
. ** (f) County-level childcare cost data via DOL 
. **              - www.dol.gov/sites/dolgov/files/WB/NDCP2022.xlsx
. ** (g) County-level Unemployment data via BLS 
. **              - https://www.bls.gov/lau/
. do ${code}01_clean_data.do

. /*****************************************************************************
> * Program:                      01_clean_data.do 
> * Author(s):            John Iselin 
> * Date Updated:         October 19, 2025
> 
> **** Data that has been / will be automatically download
> 
> ** Demographic data via IPUMS NHGIS 
> ** Via https://www.nhgis.org/
> ** Downloaded on October 19, 2025
> ** EXTRACT DETAILS in "nhgis0031_ts_nominal_county_codebook"
> 
> ** Economic data via BEA Regional Economic Accounts (CAINC1)
> ** Via https://apps.bea.gov/regional/downloadzip.htm
> 
> ** ACS individual data via IPUMS USA 
> ** Via https://usa.ipums.org/usa/index.shtml
> ** Downloaded via R program 
> 
> ** IRS SOI County-Level Migration Files
> ** Via https://www.irs.gov/statistics/soi-tax-stats-migration-data
> 
> ** IRS SOI County-Level Files
> ** Via https://www.irs.gov/statistics/soi-tax-stats-county-data
> 
> ** NYTimes COVID Cases and Deaths 
> ** Via https://github.com/nytimes/covid-19-data
> 
> **** Data that must be manually downloaded
> 
> ** DOL Childcare Cost Data 
> ** Via www.dol.gov/sites/dolgov/files/WB/NDCP2022.xlsx
> 
> ** BLS Unemployment data 
> ** Via https://download.bls.gov/pub/time.series/la/la.data.64.County 
> 
> ** County Centroids (center of population)
> ** Via https://arc-gis-hub-home-arcgishub.hub.arcgis.com/datasets/myUTK::popcenterstate-us-csv/about
> 
> *******************************************************************************/
. 
. ** Start log file 
. capture log close log_01

. log using "${logs}01_log_data_clean_${pr_name}_${date}", replace text name(log_01)
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
      name:  log_01
       log:  C:/Users/ji252/Documents/GitHub/multnomah-county-tax/code/logs/01_log_data_clean_multnomah_2026-02-06.log
  log type:  text
 opened on:   6 Feb 2026, 11:16:58

. 
. //--------------------------------------------------
. // STEP 0: Preliminary Set-Up 
. //--------------------------------------------------
. 
. ** Define labels 
. label define lb_move_type       0 "ERROR"                               ///
>                                                         1 "Non-movers"                  ///
>                                                         2 "All movers"                  ///
>                                                         3 "Domestic movers"             ///
>                                                         4 "Within-state movers" ///
>                                                         5 "Inter-state movers"  ///
>                                                         6 "Foreign movers", modify

.                                                         
. label define lb_agi             1 "Under $1"                    ///
>                                                         2 "$1 under $10K"               ///
>                                                         3 "$10K under $25K"             ///
>                                                         4 "$25K under $50K"             ///
>                                                         5 "$50K under $75K"             ///
>                                                         6 "$75K under $100K"    ///
>                                                         7 "$100K under $200K"   ///
>                                                         8 "$200K or more", modify                                                       

. 
. 
. ** Define Programs
. 
. ** Make FIPS code from state and county fips codes 
. capture program drop make_fips

. program define make_fips
  1.     syntax varlist(min=2 max=2 numeric), GEN(name)
  2. 
.     quietly {
  3.         tempvar s c
  4. 
.         local v1 : word 1 of `varlist'
  5.         local v2 : word 2 of `varlist'
  6. 
.         gen `s' = string(`v1', "%02.0f")
  7.         gen `c' = string(`v2', "%03.0f")
  8. 
.         gen `gen' = real(`s' + `c')
  9.     }
 10. end

. 
. ** Reclassify suppressed values as 0 
. 
. capture program drop unsuppress

. program define unsuppress
  1.     syntax varlist
  2. 
.     foreach v of varlist `varlist' {
  3.         replace `v' = 0 if `v' == -1
  4.     }
  5. end

. 
. 
. ** Create a gross-migration file via ACS 
. capture program drop acs_make_gross_migration

. program define acs_make_gross_migration
  1.     version 16.0
  2.     /*
>       Build county-year gross migration totals from ACS microdata with origin/destination counties.
> 
>       Outputs (wide):
>         persons_in_*, persons_out_*, persons_net_*
>         households_in_*, households_out_*, households_net_*
>         dollars_in_*, dollars_out_*, dollars_net_*
> 
>       Move-type indices (mirrors your IRS convention as closely as possible):
>         1 = Non-movers (same county)
>         2 = All movers (different county) = 4 + 5
>         3 = Domestic movers (same as 2 here; foreign already dropped upstream)
>         4 = Within-state movers (different county, same state)
>         5 = Inter-state movers (different state)
>     */
. 
.     syntax using/ [if] [in], SAVING(string) [REPLACE] ///
>         [ IDSFILE(string) ///
>           YEARVAR(name) ORIGFIPS(name) DESTFIPS(name) ///
>           PERSONWT(name) HHWT(name) HHPERWT(name) HEADVAR(name) INCOME(name) SAMPLE(string)]
  3. 
.     // Defaults consistent with your 01_clean_data.do
.     if "`idsfile'"  == "" local idsfile  "${data}working/ids"
  4.     if "`yearvar'"  == "" local yearvar  year
  5.     if "`origfips'" == "" local origfips fips_o
  6.     if "`destfips'" == "" local destfips fips_d
  7.         if "`personwt'" == "" local personwt perwt
  8.     if "`hhperwt'"  == "" local hhperwt  hh_perwt
  9.     if "`hhwt'"     == "" local hhwt     hhwt
 10.     if "`headvar'"  == "" local headvar  hh_head
 11.     if "`income'"   == "" local income   inctot
 12. 
.     // Load microdata (optionally subset via if/in)
.     use "`using'" `if' `in', clear
 13.         
.         if "`sample'" != "" keep if `sample'
 14. 
.     // Basic checks
.     foreach v in `yearvar' `origfips' `destfips' `personwt' `hhwt' `headvar' `income' {
 15.         capture confirm variable `v'
 16.         if _rc {
 17.             di as err "Required variable `v' not found in `using'."
 18.             exit 198
 19.         }
 20.     }
 21. 
.     // Keep only valid year/origin/destination
.     drop if missing(`yearvar') | missing(`origfips') | missing(`destfips')
 22. 
.     // Income: treat missing as 0 (keep negatives as reported)
.     replace `income' = 0 if missing(`income')
 23. 
.     // Build weighted components at the person level
.     gen double persons_wt = `hhperwt' if `headvar' == 1
 24.     gen double dollars_wt = `income' * `personwt'
 25.     gen double households_wt = `hhwt' if `headvar' == 1
 26.     replace households_wt = 0 if missing(households_wt)
 27. 
.     // Collapse to origin-destination-year flow first
.     keep `yearvar' `origfips' `destfips' persons_wt dollars_wt households_wt
 28.     collapse (sum) persons=persons_wt dollars=dollars_wt households=households_wt, ///
>         by(`yearvar' `origfips' `destfips')
 29. 
.     // Derive state/county components for mover-type logic
.     gen int state_o  = floor(`origfips'/1000)
 30.     gen int state_d  = floor(`destfips'/1000)
 31. 
.     gen byte same_county = (`origfips' == `destfips')
 32.     gen byte same_state  = (state_o == state_d)
 33.     gen byte within_state_mover = same_state & !same_county
 34.     gen byte inter_state_mover  = !same_state
 35. 
.     // -----------------------
.     // IN-MIGRATION (by destination county)
.     // -----------------------
.     preserve
 36.         gen long fips = `destfips'
 37.         gen int state_fips  = floor(fips/1000)
 38.         gen int county_fips = mod(fips, 1000)
 39. 
.         // type 1/4/5 components
.         foreach m in persons households dollars {
 40.             gen double `m'_1 = `m' if same_county
 41.             gen double `m'_4 = `m' if within_state_mover
 42.             gen double `m'_5 = `m' if inter_state_mover
 43.         }
 44. 
.         collapse (sum) persons_1 persons_4 persons_5 ///
>                        households_1 households_4 households_5 ///
>                        dollars_1 dollars_4 dollars_5, ///
>                 by(`yearvar' fips state_fips county_fips)
 45. 
.         // build 2 and 3
.         gen double persons_2    = persons_4 + persons_5
 46.         gen double persons_3    = persons_2
 47.         gen double households_2 = households_4 + households_5
 48.         gen double households_3 = households_2
 49.         gen double dollars_2    = dollars_4 + dollars_5
 50.         gen double dollars_3    = dollars_2
 51. 
.         // rename to *_in_*
.         foreach t in 1 2 3 4 5 {
 52.             rename persons_`t'    persons_in_`t'
 53.             rename households_`t' households_in_`t'
 54.             rename dollars_`t'    dollars_in_`t'
 55.         }
 56. 
.         tempfile __in
 57.         save `__in', replace
 58.     restore
 59. 
.     // -----------------------
.     // OUT-MIGRATION (by origin county)
.     // -----------------------
.     preserve
 60.         gen long fips = `origfips'
 61.         gen int state_fips  = floor(fips/1000)
 62.         gen int county_fips = mod(fips, 1000)
 63. 
.         foreach m in persons households dollars {
 64.             gen double `m'_1 = `m' if same_county
 65.             gen double `m'_4 = `m' if within_state_mover
 66.             gen double `m'_5 = `m' if inter_state_mover
 67.         }
 68. 
.         collapse (sum) persons_1 persons_4 persons_5 ///
>                        households_1 households_4 households_5 ///
>                        dollars_1 dollars_4 dollars_5, ///
>                 by(`yearvar' fips state_fips county_fips)
 69. 
.         gen double persons_2    = persons_4 + persons_5
 70.         gen double persons_3    = persons_2
 71.         gen double households_2 = households_4 + households_5
 72.         gen double households_3 = households_2
 73.         gen double dollars_2    = dollars_4 + dollars_5
 74.         gen double dollars_3    = dollars_2
 75. 
.         foreach t in 1 2 3 4 5 {
 76.             rename persons_`t'    persons_out_`t'
 77.             rename households_`t' households_out_`t'
 78.             rename dollars_`t'    dollars_out_`t'
 79.         }
 80. 
.         tempfile __out
 81.         save `__out', replace
 82.     restore
 83. 
.     // -----------------------
.     // Merge in/out; compute net
.     // -----------------------
.     use `__in', clear
 84.     merge 1:1 `yearvar' fips state_fips county_fips using `__out', nogen
 85. 
.     // Replace missings with 0 prior to net calcs (counties can be only in or only out)
.     foreach m in persons households dollars {
 86.         foreach t in 1 2 3 4 5 {
 87.             replace `m'_in_`t'  = 0 if missing(`m'_in_`t')
 88.             replace `m'_out_`t' = 0 if missing(`m'_out_`t')
 89.         }
 90.     }
 91. 
.     // Net = in - out (types 2/3/4/5 are the meaningful migration nets; 1 will be ~0 by construction)
.     foreach m in persons households dollars {
 92.         foreach t in 2 3 4 5 {
 93.             gen double `m'_net_`t' = `m'_in_`t' - `m'_out_`t'
 94.         }
 95.     }
 96. 
.     // Merge names
.     merge m:1 state_fips county_fips using "`idsfile'", keep(master match) nogen
 97. 
.     // Labels
.     label var fips "County FIPS (state*1000 + county)"
 98.     label var state_fips "State FIPS"
 99.     label var county_fips "County FIPS"
100. 
.     label var persons_in_2  "Persons, in-migration, all movers"
101.     label var persons_out_2 "Persons, out-migration, all movers"
102.     label var persons_net_2 "Persons, net migration, all movers"
103. 
.     label var households_in_2  "Households, in-migration, all movers (HH heads)"
104.     label var households_out_2 "Households, out-migration, all movers (HH heads)"
105.     label var households_net_2 "Households, net migration, all movers (HH heads)"
106. 
.     label var dollars_in_2  "Dollars, in-migration, all movers (INCTOT*PERWT)"
107.     label var dollars_out_2 "Dollars, out-migration, all movers (INCTOT*PERWT)"
108.     label var dollars_net_2 "Dollars, net migration, all movers (INCTOT*PERWT)"
109. 
.     order `yearvar' fips state_fips county_fips state_name county_name, first
110.     sort `yearvar' state_fips county_fips
111.     compress
112. 
.     // Save
.     save "`saving'", `replace'
113.         clear
114.         
. end

. 
. ********************************************************************************
. ** STEP 1: Download and check non-IPUMS data 
. ********************************************************************************
. 
. ** Ensure expected directory structure exists
. capture mkdir "${data}"

. capture mkdir "${data}working"

. capture mkdir "${data}demographic"

. capture mkdir "${data}demographic/CAINC1"

. capture mkdir "${data}demographic/nhgis0031_csv"

. capture mkdir "${data}demographic/dol"

. capture mkdir "${data}demographic/bls"

. capture mkdir "${data}irs"

. capture mkdir "${data}covid"

. 
. ** This block downloads public-use source data directly from official URLs if 
. ** not present locally.
. /*
> Automated downloads included:
>   - IRS SOI county-to-county migration: countyinflowYYZZ.csv / countyoutflowYYZZ.csv
>   - IRS SOI county data: YYincyallagi.csv
>   - BEA Regional Economic Accounts (CAINC1): CAINC1.zip (unzips to CAINC1__ALL_AREAS_*.csv and related files)
> */
. 
. * ----------------------------
. * IRS SOI: migration files
. * ----------------------------
. local irs_base "https://www.irs.gov/pub/irs-soi"

. 
. forvalues yy = 15/21 {
  2.     local zz = `yy' + 1
  3.     local fn_out "countyoutflow`yy'`zz'.csv"
  4.     local fn_in  "countyinflow`yy'`zz'.csv"
  5. 
.     capture confirm file "${data}irs/`fn_out'"
  6.     if _rc {
  7.         di as txt "Downloading (IRS SOI) `fn_out' ..."
  8.         copy "`irs_base'/`fn_out'" "${data}irs/`fn_out'", replace
  9.     }
 10. 
.     capture confirm file "${data}irs/`fn_in'"
 11.     if _rc {
 12.         di as txt "Downloading (IRS SOI) `fn_in' ..."
 13.         copy "`irs_base'/`fn_in'" "${data}irs/`fn_in'", replace
 14.     }
 15. }

. 
. * ----------------------------
. * IRS SOI: county income (AGI) files
. * ----------------------------
. forvalues yy = 15/22 {
  2.     local fn_inc "`yy'incyallagi.csv"
  3. 
.     capture confirm file "${data}irs/`fn_inc'"
  4.     if _rc {
  5.         di as txt "Downloading (IRS SOI) `fn_inc' ..."
  6.         copy "`irs_base'/`fn_inc'" "${data}irs/`fn_inc'", replace
  7.     }
  8. }

. 
. * ----------------------------
. * BEA Regional: CAINC1.zip
. * ----------------------------
. local bea_dir "${data}demographic/CAINC1"

. local bea_url "https://apps.bea.gov/regional/zip/CAINC1.zip"

. local bea_zip "`bea_dir'/CAINC1.zip"

. 
. * If we don't already have a CAINC1 "_ALL_AREAS" file, download + unzip the ZIP.
. local bea_files : dir "`bea_dir'" files "CAINC1__ALL_AREAS_*.csv"

. if "`bea_files'"=="" {
.     local bea_files : dir "`bea_dir'" files "CAINC1__ALL_STATES_*.csv"
. }

. 
. if "`bea_files'"=="" {
.     di as txt "Downloading (BEA) CAINC1.zip ..."
Downloading (BEA) CAINC1.zip ...
.     copy "`bea_url'" "`bea_zip'", replace
(file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/demographic/CAINC1/CAINC1.zip not found)
. 
.     local curdir "`c(pwd)'"
.     cd "`bea_dir'"
C:\Users\ji252\Documents\GitHub\multnomah-county-tax\data\demographic\CAINC1
.     unzipfile "CAINC1.zip", replace
    inflating: CAINC1__ALL_AREAS_1969_2024.csv
    inflating: CAINC1__definition.xml
    inflating: CAINC1__Footnotes.html
    inflating: CAINC1_AK_1969_2024.csv
    inflating: CAINC1_AL_1969_2024.csv
    inflating: CAINC1_AR_1969_2024.csv
    inflating: CAINC1_AZ_1969_2024.csv
    inflating: CAINC1_CA_1969_2024.csv
    inflating: CAINC1_CO_1969_2024.csv
    inflating: CAINC1_CT_1969_2024.csv
    inflating: CAINC1_DC_1969_2024.csv
    inflating: CAINC1_DE_1969_2024.csv
    inflating: CAINC1_FL_1969_2024.csv
    inflating: CAINC1_GA_1969_2024.csv
    inflating: CAINC1_HI_1969_2024.csv
    inflating: CAINC1_IA_1969_2024.csv
    inflating: CAINC1_ID_1969_2024.csv
    inflating: CAINC1_IL_1969_2024.csv
    inflating: CAINC1_IN_1969_2024.csv
    inflating: CAINC1_KS_1969_2024.csv
    inflating: CAINC1_KY_1969_2024.csv
    inflating: CAINC1_LA_1969_2024.csv
    inflating: CAINC1_MA_1969_2024.csv
    inflating: CAINC1_MD_1969_2024.csv
    inflating: CAINC1_ME_1969_2024.csv
    inflating: CAINC1_MI_1969_2024.csv
    inflating: CAINC1_MN_1969_2024.csv
    inflating: CAINC1_MO_1969_2024.csv
    inflating: CAINC1_MS_1969_2024.csv
    inflating: CAINC1_MT_1969_2024.csv
    inflating: CAINC1_NC_1969_2024.csv
    inflating: CAINC1_ND_1969_2024.csv
    inflating: CAINC1_NE_1969_2024.csv
    inflating: CAINC1_NH_1969_2024.csv
    inflating: CAINC1_NJ_1969_2024.csv
    inflating: CAINC1_NM_1969_2024.csv
    inflating: CAINC1_NV_1969_2024.csv
    inflating: CAINC1_NY_1969_2024.csv
    inflating: CAINC1_OH_1969_2024.csv
    inflating: CAINC1_OK_1969_2024.csv
    inflating: CAINC1_OR_1969_2024.csv
    inflating: CAINC1_PA_1969_2024.csv
    inflating: CAINC1_RI_1969_2024.csv
    inflating: CAINC1_SC_1969_2024.csv
    inflating: CAINC1_SD_1969_2024.csv
    inflating: CAINC1_TN_1969_2024.csv
    inflating: CAINC1_TX_1969_2024.csv
    inflating: CAINC1_US_1969_2024.csv
    inflating: CAINC1_UT_1969_2024.csv
    inflating: CAINC1_VA_1969_2024.csv
    inflating: CAINC1_VT_1969_2024.csv
    inflating: CAINC1_WA_1969_2024.csv
    inflating: CAINC1_WI_1969_2024.csv
    inflating: CAINC1_WV_1969_2024.csv
    inflating: CAINC1_WY_1969_2024.csv

successfully unzipped CAINC1.zip to current directory
total processed:  55
        skipped:  0
      extracted:  55
.     cd "`curdir'"
C:\Users\ji252\Documents\GitHub\multnomah-county-tax
. 
.     capture erase "`bea_zip'"
. }

. 
. * ----------------------------
. * NYTimes COVID Data 
. * ----------------------------
. local covid_dir "${data}covid"

. local covid_url "https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-counties.csv"

. 
. * If we don't already have a COVID file, download.
. local covid_file : dir "`covid_dir'" files "covid_nyt.csv"

. if "`covid_file'"=="" {
.     local covid_file : dir "`covid_dir'" files "covid_nyt.csv"
. }

. 
. if "`covid_file'"=="" {
.     di as txt "Downloading (COVID)  ..."
Downloading (COVID)  ...
.     copy "`covid_url'" "`covid_dir'/covid_nyt.csv", replace
. }

. 
. ** This block checks that non-automatically downloaded data are present: 
. /*
> Non-automtated downloads included:
>   - DOL childcare data (through 2022)
>   - BLS unemployment data 
> */
. 
. ** Define paths 
. local dol_dir "${data}demographic/dol/NDCP2022.xlsx"

. local bls_dir "${data}demographic/bls/la.data.64.County" 

. 
. capture confirm file `dol_dir' // Check if the file exists

. 
. if _rc != 0 {
.     display "Error: The file `dol_dir' was not found."
.     display "Execution of the do-file is stopping."
.     exit // Stops the do-file/program
. }

. 
. capture confirm file `bls_dir' // Check if the file exists

. 
. if _rc != 0 {
.     display "Error: The file `bls_dir' was not found."
.     display "Execution of the do-file is stopping."
.     exit // Stops the do-file/program
. }

. 
. 
. 
. ********************************************************************************
. ** STEP 2: Clean demographic + economic data via IPUMS, BLS, and BEA 
. ********************************************************************************
. 
. ** Import data 
. import delimited        ///
>         "${data}demographic/nhgis0031_csv/nhgis0031_ts_nominal_county.csv", clear 
(encoding automatically selected: ISO-8859-1)
(15 vars, 54,673 obs)

. 
. ** Describe data 
. des 

Contains data
 Observations:        54,673                  
    Variables:            15                  
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable label
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
gisjoin         str8    %9s                   GISJOIN
year            str9    %9s                   YEAR
state           str20   %20s                  STATE
statefp         byte    %8.0g                 STATEFP
statenh         int     %8.0g                 STATENH
county          str46   %46s                  COUNTY
countyfp        int     %8.0g                 COUNTYFP
countynh        int     %8.0g                 COUNTYNH
name            str59   %59s                  NAME
av0aa           long    %12.0g                AV0AA
d15aa           long    %12.0g                D15AA
d15ab           long    %12.0g                D15AB
b79aa           long    %12.0g                B79AA
av0aam          long    %12.0g                AV0AAM
b79aam          long    %12.0g                B79AAM
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.

. 
. ** Drop unnecc variables 
. drop gisjoin statenh countynh name 

. 
. ** Rename 
. rename state state_name 

. rename statefp state_fips 

. rename county county_name 

. rename countyfp county_fips 

. rename av0aa population 

. rename d15aa pop_urban 

. rename d15ab pop_rural 

. rename b79aa median_income 

. rename av0aam population_margin

. rename b79aam median_income_margin 

. 
. ** Create urban percent 
. gen percent_urban = pop_urban / population
(45,090 missing values generated)

. 
. ** Label variables 
. label var state_name "State name"

. label var state_fips "State FIPS code"

. label var county_name "County name"

. label var county_fips "County FIPS code"

. label var population "Population count"

. label var pop_rural "Rural population count"

. label var pop_urban "Urban population count"

. label var percent_urban "Percent of population in urban areas"

. label var median_income "Median household income (prior year)"

. label var population_margin "ACS margin for error: population"

. label var median_income_margin "ACS margin for error: median income"

. 
. ** Save as temporary file 
. tempfile demo

. save `demo'
file C:\Users\ji252\AppData\Local\Temp\ST_92f0_000001.tmp saved as .dta format

. 
. ** Create three datasets 
. 
. ** (1) Basic state and county IDs 
. keep if year == "2020" 
(51,452 observations deleted)

. keep state* county* 

. 
. ** Make FIPS 
. make_fips state_fips county_fips, gen(fips)

. 
. ** Save as state and county Ids 
. save "${data}working/ids", replace 
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/ids.dta saved

. 
. ** Save state IDS 
. keep state_fips state_name 

. duplicates drop 

Duplicates in terms of all variables

(3,169 observations deleted)

. 
. ** Save as state and county Ids 
. save "${data}working/state_ids", replace 
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/state_ids.dta saved

. 
. clear  

. 
. ** (2) Population data 
. use `demo'

. keep if !missing(pop_urban) 
(45,090 observations deleted)

. tab year 

       YEAR |      Freq.     Percent        Cum.
------------+-----------------------------------
       2000 |      3,141       32.78       32.78
       2010 |      3,221       33.61       66.39
       2020 |      3,221       33.61      100.00
------------+-----------------------------------
      Total |      9,583      100.00

. 
. ** Keep 2020 
. keep if year == "2020"
(6,362 observations deleted)

. drop year median_income* population_margin

. 
. ** Make FIPS 
. make_fips state_fips county_fips, gen(fips)

. 
. ** Save data
. save "${data}working/population_2020", replace 
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/population_2020.dta saved

. clear  

. 
. ** (3) 2015-2019 ACS data 
. use `demo'

. keep if !missing(median_income) 
(6,447 observations deleted)

. tab year 

       YEAR |      Freq.     Percent        Cum.
------------+-----------------------------------
       2000 |      3,141        6.51        6.51
  2006-2010 |      3,221        6.68       13.19
  2007-2011 |      3,221        6.68       19.87
  2008-2012 |      3,221        6.68       26.55
  2009-2013 |      3,221        6.68       33.23
  2010-2014 |      3,220        6.68       39.91
  2011-2015 |      3,219        6.67       46.58
  2012-2016 |      3,220        6.68       53.26
  2013-2017 |      3,220        6.68       59.93
  2014-2018 |      3,219        6.67       66.61
  2015-2019 |      3,220        6.68       73.29
  2016-2020 |      3,220        6.68       79.96
  2017-2021 |      3,220        6.68       86.64
  2018-2022 |      3,221        6.68       93.32
  2019-2023 |      3,222        6.68      100.00
------------+-----------------------------------
      Total |     48,226      100.00

. 
. ** Keep 2020 
. keep if year == "2015-2019"
(45,006 observations deleted)

. drop year pop_rural pop_urban percent_urban

. 
. ** Make FIPS 
. make_fips state_fips county_fips, gen(fips)

. 
. ** Save data
. save "${data}working/acs_2015_2019_data", replace 
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/acs_2015_2019_data.dta saved

. 
. ** Rename for merge 
. rename population population_acs

. 
. ** Merge with other data 
. merge 1:1 state_fips county_fips using "${data}working/population_2020",                ///
>         keep(match) nogen 

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                             3,219  
    -----------------------------------------

. 
. ** Save data
. save "${data}working/demographics_2020", replace 
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/demographics_2020.dta saved

. 
. ** Load BEA Data 
. import delimited "${data}demographic/CAINC1/CAINC1__ALL_AREAS_1969_2023.csv",   ///
>         clear 
(encoding automatically selected: ISO-8859-1)
(63 vars, 9,604 obs)

. 
. ** Drop unnecc variables 
. drop region tablename industryclassification unit geoname 

. 
. ** Drop empty cells 
. drop if missing(linecode)
(4 observations deleted)

. 
. ** Update names 
. rename geofips fips 

. replace fips = subinstr(fips, `"""', "", .)
(9,600 real changes made)

. destring fips, replace 
fips: all characters numeric; replaced as long

. 
. ** Keep population and per-capita income, dropping personal income (total)
. tab description linecode

                      |             LineCode
          Description |         1          2          3 |     Total
----------------------+---------------------------------+----------
Per capita personal.. |         0          0      3,200 |     3,200 
Personal income (th.. |     3,200          0          0 |     3,200 
Population (persons.. |         0      3,200          0 |     3,200 
----------------------+---------------------------------+----------
                Total |     3,200      3,200      3,200 |     9,600 

. drop if linecode == 1   
(3,200 observations deleted)

. drop description

.         
. ** Get V* to be in terms of years 
. ** V9 == 1969 
. forvalues i = 9/63 {
  2.         
.         local j = 1960 + `i'
  3.         rename v`i' value`j'
  4.         
. } // END I LOOP 

. 
. ** Reshape 
. reshape long value, i(fips linecode) j(year)
(j = 1969 1970 1971 1972 1973 1974 1975 1976 1977 1978 1979 1980 1981 1982 1983 1984 1985 1986 1987 1988 1989 1990 1991 1992 1993 1994 1995 1996 1997 1998 1999 2000 2001 2002 2003 2004 2005 2006 2007 2
> 008 2009 2010 2011 2012 2013 2014 2015 2016 2017 2018 2019 2020 2021 2022 2023)

Data                               Wide   ->   Long
-----------------------------------------------------------------------------
Number of observations            6,400   ->   352,000     
Number of variables                  57   ->   4           
j variable (55 values)                    ->   year
xij variables:
      value1969 value1970 ... value2023   ->   value
-----------------------------------------------------------------------------

. reshape wide value, i(fips year ) j(linecode)
(j = 2 3)

Data                               Long   ->   Wide
-----------------------------------------------------------------------------
Number of observations          352,000   ->   176,000     
Number of variables                   4   ->   4           
j variable (2 values)          linecode   ->   (dropped)
xij variables:
                                  value   ->   value2 value3
-----------------------------------------------------------------------------

. 
. ** Keep years 
. keep if inrange(year, 2015, ${end_year_acs})
(147,200 observations deleted)

. 
. ** Rename values 
. rename value2 population 

. rename value3 per_capita_income

. 
. ** Drop if missing values 
. drop if population == "(NA)"
(239 observations deleted)

. 
. ** Keep only counties with all observations 
. bysort fips: gen ct = _N 

. tab ct

         ct |      Freq.     Percent        Cum.
------------+-----------------------------------
          4 |          8        0.03        0.03
          5 |          5        0.02        0.05
          9 |     28,548       99.95      100.00
------------+-----------------------------------
      Total |     28,561      100.00

. keep if ct == 9
(13 observations deleted)

. drop ct

. 
. ** Destring 
. destring population, replace 
population: all characters numeric; replaced as long

. destring per_capita_income, replace 
per_capita_income: all characters numeric; replaced as long

. 
. ** Extrapolate through 2024 
. expand 2 if year == 2023, gen(tag)
(3,172 observations created)

. replace year = 2024 if tag == 1 
(3,172 real changes made)

. replace population = . if tag == 1 
(3,172 real changes made, 3,172 to missing)

. replace per_capita_income = . if tag == 1 
(3,172 real changes made, 3,172 to missing)

. 
. ** Get list of all counties 
. qui levelsof fips, local(fips)

. 
. ** Loop over variables
. foreach v of varlist population per_capita_income {
  2.         
.         ** Loop over all FIPS 
.     foreach c of local fips {
  3.                 
.                 quietly{
  4.                         
.                         regress `v' year if fips == `c' & tag != 1 
  5.                         predict `v'_hat
  6.                         replace `v' = `v'_hat if fips == `c' & year == 2024
  7.                         drop `v'_hat
  8.                         
.                 } // END QUIET
  9.     } // END FIPS LOOP 
 10. } // END VAR LOOP 

. 
. ** Drop tag 
. drop tag

. 
. ** Save data
. save "${data}working/bea_economics", replace 
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/bea_economics.dta saved

. 
. ** Load BLS Unemployment data 
. import delimited "${data}demographic\bls\la.data.64.County", clear 
(encoding automatically selected: ISO-8859-1)
(5 vars, 5,974,328 obs)

. 
. ** Keep annual average 
. keep if period == "M13"
(5,523,684 observations deleted)

. drop period 

. 
. ** Keep only Unemployment Rate 
. gen measure = substr(series_id, 20,1)

. keep if measure == "3"
(337,983 observations deleted)

. drop measure 

. 
. ** Keep years 
. keep if inrange(year, 2015, ${end_year_acs})
(80,456 observations deleted)

. tab year 

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       2015 |      3,220       10.00       10.00
       2016 |      3,220       10.00       20.00
       2017 |      3,220       10.00       30.00
       2018 |      3,220       10.00       39.99
       2019 |      3,220       10.00       49.99
       2020 |      3,221       10.00       59.99
       2021 |      3,221       10.00       70.00
       2022 |      3,221       10.00       80.00
       2023 |      3,221       10.00       90.00
       2024 |      3,221       10.00      100.00
------------+-----------------------------------
      Total |     32,205      100.00

. 
. ** Define counties 
. gen fips = substr(series_id, 6,5)

. destring fips, replace 
fips: all characters numeric; replaced as long

. drop series_id 

. isid fips year 

. 
. ** Drop PR 
. drop if fips > 60000
(780 observations deleted)

. drop footnote_codes 

. 
. ** Update names 
. rename value unemp 

. order year fips unemp 

. 
. destring unemp, replace 
unemp: all characters numeric; replaced as double

. 
. ** Save data
. save "${data}working/bls_unemployment", replace 
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/bls_unemployment.dta saved

. 
. ** Load County Centroids 
. import delimited "${data}demographic\PopCenterCounty_US.csv", clear 
(encoding automatically selected: UTF-8)
(18 vars, 9,673 obs)

. 
. ** Keep required years (2010)
. keep if year == 2010 
(6,452 observations deleted)

. 
. ** Keep required variables 
. keep geographicindentifier latitude longitude 

. 
. ** Rename 
. rename geographicindentifier fips 

. rename latitude lat 

. rename longitude lon 

. 
. ** Drop PR 
. drop if fips > 60000
(78 observations deleted)

. 
. ** Save data
. save "${data}working/pop_centers", replace 
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/pop_centers.dta saved

. 
. 
. 
. 
. ********************************************************************************
. ** STEP 3: Import and Clean NYTimes COVID-19 Data 
. ********************************************************************************
. 
. ** Import data 
. import delimited using "${data}covid/covid_nyt.csv", varnames(1) clear case(lower) 
(encoding automatically selected: ISO-8859-1)
(6 vars, 2,502,832 obs)

. 
. ** Describe data 
. des 

Contains data
 Observations:     2,502,832                  
    Variables:             6                  
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable label
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
date            str10   %10s                  
county          str35   %35s                  
state           str24   %24s                  
fips            long    %12.0g                
cases           long    %12.0g                
deaths          long    %8.0g                 
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.

. 
. ** Set up date information 
. generate num_date = date(date, "YMD")

. format num_date %td

. drop date 

. 
. ** Rename 
. rename state state_name 

. rename county county_name 

. rename num_date date 

. 
. ** keep only counties 
. keep if !missing(fips)
(23,678 observations deleted)

. 
. ** Keep in 50 states 
. drop if state_name == "Puerto Rico"
(57,605 observations deleted)

. drop if state_name == "Virgin Islands"
(2,304 observations deleted)

. drop if state_name == "Northern Mariana Islands"
(1,452 observations deleted)

. 
. ** Sort 
. sort date fips 

. 
. ** Create panel 
. xtset fips date

Panel variable: fips (unbalanced)
 Time variable: date, 21jan2020 to 13may2022, but with gaps
         Delta: 1 day

. 
. ** Fill in panel 
. tsfill, full 

. 
. ** Fill in missing values 
. replace cases = 0 if missing(cases)
(228,991 real changes made)

. replace deaths = 0 if missing(deaths)
(228,991 real changes made)

. 
. ** Preserve data 
. preserve 

. 
. ** Preserve fips codes and names 
. keep if !missing(state_name)
(228,991 observations deleted)

. keep if !missing(county_name)
(0 observations deleted)

. duplicates drop fips state_name county_name, force 

Duplicates in terms of fips state_name county_name

(2,414,657 observations deleted)

. 
. ** Save as temporary data 
. tempfile state_county_names 

. save `state_county_names'
file C:\Users\ji252\AppData\Local\Temp\ST_92f0_000003.tmp saved as .dta format

. clear 

. 
. ** Restore 
. restore 

. 
. ** Drop and merge in names 
. drop state_name county_name

. merge m:1 fips using `state_county_names', keep(master match) nogen 

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                         2,646,784  
    -----------------------------------------

. 
. ** Get year, month, day 
. gen year = year(date)

. gen month = month(date)

. gen day = day(date)

. 
. ** Order data 
. order date year month day fips state county cases deaths 

. 
. ** Calculate cumulative cases and deaths 
. bysort fips (date): gen cases_cum = sum(cases)

. bysort fips (date): gen deaths_cum = sum(deaths)

. 
. ** Merge population data (2020)
. merge m:1 fips using "${data}working/population_2020", keep(match) nogen  
(variable county_name was str35, now str46 to accommodate using data's values)
(variable fips was long, now double to accommodate using data's values)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                         2,643,408  
    -----------------------------------------

. 
. ** Save file 
. save ${data}working/covid_cleaned.dta, replace 
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/covid_cleaned.dta saved

. 
. ** Keep one observation per month 
. keep year month fips state_name county_name cases deaths population

. collapse (sum) cases deaths (mean) population, by(year month fips state_name county_name) 

. sort year month fips 

. egen date = group(year month)

. drop year month 

. 
. ** Calculate cumulative cases and deaths 
. bysort fips (date): gen cases_cum = sum(cases)

. bysort fips (date): gen deaths_cum = sum(deaths)

. 
. ** Generate per capita figures
. replace cases_cum = 1000 * cases_cum / population
(82,955 real changes made)

. replace deaths_cum = 1000 * deaths_cum / population
(74,723 real changes made)

. drop population cases deaths

. 
. ** Reshape wide 
. reshape wide cases_cum deaths_cum, i(fips state_name county_name) j(date)
(j = 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29)

Data                               Long   ->   Wide
-----------------------------------------------------------------------------
Number of observations           90,828   ->   3,132       
Number of variables                   6   ->   61          
j variable (29 values)             date   ->   (dropped)
xij variables:
                              cases_cum   ->   cases_cum1 cases_cum2 ... cases_cum29
                             deaths_cum   ->   deaths_cum1 deaths_cum2 ... deaths_cum29
-----------------------------------------------------------------------------

. 
. ** Save file 
. save ${data}working/covid_cleaned_wide.dta, replace 
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/covid_cleaned_wide.dta saved

. clear

. 
. 
. ********************************************************************************
. ** STEP 4: Import and Clean IPUMS ACS Data via IPUMS 
. ********************************************************************************
. 
. ** Load data 
. forvalues y = 2015(1)$end_year_acs {
  2.         
.         ** Import CSV
.         import delimited using "${data}acs/acs_`y'", varnames(1) clear case(lower)
  3.         
.         ** Save as temporary data 
.         tempfile acs_`y'
  4.         save `acs_`y''
  5.         clear 
  6.         
. } // END YEAR LOOP 
(encoding automatically selected: ISO-8859-1)
(68 vars, 2,997,503 obs)
file C:\Users\ji252\AppData\Local\Temp\ST_92f0_000004.tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(68 vars, 3,007,847 obs)
file C:\Users\ji252\AppData\Local\Temp\ST_92f0_000005.tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(68 vars, 3,038,696 obs)
file C:\Users\ji252\AppData\Local\Temp\ST_92f0_000006.tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(68 vars, 3,060,442 obs)
file C:\Users\ji252\AppData\Local\Temp\ST_92f0_000007.tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(68 vars, 3,087,291 obs)
file C:\Users\ji252\AppData\Local\Temp\ST_92f0_000008.tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(68 vars, 2,454,160 obs)
file C:\Users\ji252\AppData\Local\Temp\ST_92f0_000009.tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(68 vars, 3,092,079 obs)
file C:\Users\ji252\AppData\Local\Temp\ST_92f0_00000a.tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(68 vars, 3,190,848 obs)
file C:\Users\ji252\AppData\Local\Temp\ST_92f0_00000b.tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(68 vars, 3,228,659 obs)
file C:\Users\ji252\AppData\Local\Temp\ST_92f0_00000c.tmp saved as .dta format
(encoding automatically selected: ISO-8859-1)
(67 vars, 3,238,311 obs)
file C:\Users\ji252\AppData\Local\Temp\ST_92f0_00000d.tmp saved as .dta format

. 
. ** Append data 
. forvalues y = 2015(1)$end_year_acs {
  2.         
.         append using `acs_`y''  
  3.         
. } // END YEAR LOOP 
(variable cbserial was long, now double to accommodate using data's values)
(variable proptx99 was byte, now int to accommodate using data's values)

. 
. ** Des 
. tab year 

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       2015 |  2,997,503        9.86        9.86
       2016 |  3,007,847        9.90       19.76
       2017 |  3,038,696       10.00       29.75
       2018 |  3,060,442       10.07       39.82
       2019 |  3,087,291       10.16       49.98
       2020 |  2,454,160        8.07       58.05
       2021 |  3,092,079       10.17       68.23
       2022 |  3,190,848       10.50       78.72
       2023 |  3,228,659       10.62       89.35
       2024 |  3,238,311       10.65      100.00
------------+-----------------------------------
      Total | 30,395,836      100.00

. 
. ** Define # of adults and kids in HHs 
. gen adult = age >= 18 

. gen child = age < 18 

. bysort year serial: gen hh_size = _N 

. bysort year serial: egen hh_adult_ct = total(adult)

. bysort year serial: egen hh_child_ct = total(child)

. 
. ** Define HH-wide indicators for creation of gross migration files 
. gen college = educd >= 0 

. gen hh_any_child = hh_child_ct > 0

. bysort year serial: egen hh_any_college = max(college)

. 
. ** Define weighted # of people 
. bysort year serial: egen hh_perwt = total(perwt)

. 
. ** Sample 18+
. drop if child == 1 
(6,257,228 observations deleted)

. drop child adult 

. 
. ** Sample not living abroad last year 
. drop if migplac1 > 56 
(123,571 observations deleted)

. drop if migrate1 == 4 
(0 observations deleted)

. 
. ** Rename variables 
. rename statefip state_fips_d

. rename countyfip county_fips_d 

. 
. ** Set up origin data 
. fre migrate1

migrate1
-----------------------------------------------------------
              |      Freq.    Percent      Valid       Cum.
--------------+--------------------------------------------
Valid   1     |   2.15e+07      89.70      89.70      89.70
        2     |    1990266       8.29       8.29      97.99
        3     |     483752       2.01       2.01     100.00
        Total |   2.40e+07     100.00     100.00           
-----------------------------------------------------------

. drop migrate1d

. tab migplac1

   migplac1 |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 | 21,541,019       89.70       89.70
          1 |     34,638        0.14       89.84
          2 |      6,437        0.03       89.87
          4 |     60,713        0.25       90.12
          5 |     23,837        0.10       90.22
          6 |    286,432        1.19       91.41
          8 |     58,203        0.24       91.66
          9 |     23,742        0.10       91.76
         10 |      5,887        0.02       91.78
         11 |      9,506        0.04       91.82
         12 |    169,310        0.71       92.52
         13 |     78,921        0.33       92.85
         15 |     10,884        0.05       92.90
         16 |     15,101        0.06       92.96
         17 |     94,301        0.39       93.35
         18 |     52,715        0.22       93.57
         19 |     23,702        0.10       93.67
         20 |     24,542        0.10       93.77
         21 |     35,053        0.15       93.92
         22 |     31,495        0.13       94.05
         23 |      8,677        0.04       94.09
         24 |     43,943        0.18       94.27
         25 |     53,708        0.22       94.49
         26 |     71,355        0.30       94.79
         27 |     38,594        0.16       94.95
         28 |     18,617        0.08       95.03
         29 |     49,703        0.21       95.24
         30 |      8,315        0.03       95.27
         31 |     14,930        0.06       95.33
         32 |     27,276        0.11       95.45
         33 |      9,634        0.04       95.49
         34 |     55,622        0.23       95.72
         35 |     13,589        0.06       95.77
         36 |    130,573        0.54       96.32
         37 |     78,068        0.33       96.64
         38 |      6,435        0.03       96.67
         39 |     89,408        0.37       97.04
         40 |     31,763        0.13       97.18
         41 |     39,836        0.17       97.34
         42 |     83,639        0.35       97.69
         44 |      7,189        0.03       97.72
         45 |     37,090        0.15       97.87
         46 |      6,736        0.03       97.90
         47 |     53,208        0.22       98.12
         48 |    219,556        0.91       99.04
         49 |     28,598        0.12       99.16
         50 |      4,493        0.02       99.18
         51 |     70,723        0.29       99.47
         53 |     71,202        0.30       99.77
         54 |     11,625        0.05       99.81
         55 |     39,001        0.16       99.98
         56 |      5,493        0.02      100.00
------------+-----------------------------------
      Total | 24,015,037      100.00

. rename migplac1 state_fips_o

. tab migcounty1

 migcounty1 |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 | 22,397,212       93.26       93.26
          1 |     38,852        0.16       93.43
          3 |     63,981        0.27       93.69
          5 |     23,554        0.10       93.79
          7 |     14,942        0.06       93.85
          9 |     13,176        0.05       93.91
         11 |     25,896        0.11       94.01
         13 |     59,788        0.25       94.26
         15 |      8,049        0.03       94.30
         17 |     24,998        0.10       94.40
         19 |     25,974        0.11       94.51
         20 |      2,285        0.01       94.52
         21 |     14,712        0.06       94.58
         23 |      8,687        0.04       94.62
         25 |     23,269        0.10       94.71
         27 |     16,916        0.07       94.78
         29 |     35,798        0.15       94.93
         31 |     63,004        0.26       95.19
         33 |     37,066        0.15       95.35
         35 |     27,440        0.11       95.46
         37 |     79,114        0.33       95.79
         39 |     11,614        0.05       95.84
         41 |      9,685        0.04       95.88
         43 |      9,722        0.04       95.92
         45 |      6,865        0.03       95.95
         47 |     25,074        0.10       96.06
         49 |     23,558        0.10       96.15
         51 |     19,026        0.08       96.23
         53 |     19,452        0.08       96.31
         55 |     13,919        0.06       96.37
         57 |     20,272        0.08       96.46
         59 |     33,983        0.14       96.60
         61 |     34,892        0.15       96.74
         63 |     13,833        0.06       96.80
         65 |     20,464        0.09       96.89
         67 |     32,851        0.14       97.02
         69 |      4,704        0.02       97.04
         71 |     30,322        0.13       97.17
         73 |     40,463        0.17       97.34
         75 |     13,169        0.05       97.39
         77 |      9,062        0.04       97.43
         79 |      8,380        0.03       97.46
         81 |     33,279        0.14       97.60
         83 |     10,073        0.04       97.64
         85 |     32,160        0.13       97.78
         87 |      7,300        0.03       97.81
         89 |     11,560        0.05       97.86
         91 |     16,976        0.07       97.93
         93 |      5,920        0.02       97.95
         95 |     21,990        0.09       98.04
         97 |     21,423        0.09       98.13
         99 |     21,309        0.09       98.22
        101 |     15,847        0.07       98.29
        103 |     20,195        0.08       98.37
        105 |      8,157        0.03       98.41
        107 |      6,225        0.03       98.43
        109 |     11,773        0.05       98.48
        111 |     16,340        0.07       98.55
        113 |     33,983        0.14       98.69
        115 |      5,301        0.02       98.71
        117 |      8,478        0.04       98.75
        119 |     16,875        0.07       98.82
        121 |     12,017        0.05       98.87
        123 |      4,198        0.02       98.89
        125 |     10,142        0.04       98.93
        127 |      2,922        0.01       98.94
        129 |      1,975        0.01       98.95
        133 |      5,837        0.02       98.97
        135 |      8,815        0.04       99.01
        139 |      6,638        0.03       99.04
        141 |      7,621        0.03       99.07
        143 |      5,187        0.02       99.09
        145 |      2,074        0.01       99.10
        147 |      2,570        0.01       99.11
        149 |      2,427        0.01       99.12
        151 |      2,091        0.01       99.13
        153 |      5,916        0.02       99.15
        157 |     12,742        0.05       99.21
        159 |        807        0.00       99.21
        160 |        234        0.00       99.21
        161 |      5,166        0.02       99.23
        163 |     14,992        0.06       99.29
        165 |      2,647        0.01       99.31
        167 |      5,589        0.02       99.33
        169 |        921        0.00       99.33
        171 |        529        0.00       99.33
        173 |        362        0.00       99.34
        179 |      1,984        0.01       99.34
        183 |     12,753        0.05       99.40
        185 |        956        0.00       99.40
        187 |      2,572        0.01       99.41
        189 |      7,260        0.03       99.44
        191 |        855        0.00       99.45
        197 |      3,714        0.02       99.46
        201 |     32,347        0.13       99.60
        209 |      2,962        0.01       99.61
        215 |      3,501        0.01       99.62
        223 |        849        0.00       99.63
        227 |      1,037        0.00       99.63
        245 |      3,376        0.01       99.64
        251 |      1,136        0.00       99.65
        257 |        957        0.00       99.65
        303 |      3,683        0.02       99.67
        309 |      2,562        0.01       99.68
        313 |        525        0.00       99.68
        329 |      1,285        0.01       99.69
        339 |      3,566        0.01       99.70
        355 |      2,895        0.01       99.71
        367 |      1,109        0.00       99.72
        375 |      1,077        0.00       99.72
        381 |      1,335        0.01       99.73
        423 |      1,679        0.01       99.74
        439 |     16,294        0.07       99.80
        441 |      1,584        0.01       99.81
        451 |      1,056        0.00       99.81
        453 |     13,967        0.06       99.87
        479 |      1,416        0.01       99.88
        485 |      1,431        0.01       99.88
        491 |      4,607        0.02       99.90
        510 |     11,147        0.05       99.95
        550 |      1,187        0.00       99.96
        650 |      1,161        0.00       99.96
        700 |      1,586        0.01       99.97
        710 |        689        0.00       99.97
        760 |      3,068        0.01       99.98
        810 |      4,263        0.02      100.00
------------+-----------------------------------
      Total | 24,015,037      100.00

. rename migcounty1 county_fips_o

. 
. ** Use migrate1 to update values 
. 
. ** Within same house 
. replace state_fips_o = state_fips_d if migrate1 == 1
(21,541,019 real changes made)

. replace county_fips_o = county_fips_d if migrate1 == 1 
(13,111,570 real changes made)

. 
. ** Within same state 
. replace state_fips_o = state_fips_d if migrate1 == 2
(0 real changes made)

. 
. ** Generate county IDS 
. foreach x in "o" "d" {
  2.         
.         make_fips state_fips_`x' county_fips_`x', gen(fips_`x')
  3. 
. }

. 
. ** Check for within-state migration 
. gen same_county = fips_o == fips_d 

. tab year same_county

           |      same_county
      year |         0          1 |     Total
-----------+----------------------+----------
      2015 |    89,492  2,245,481 | 2,334,973 
      2016 |    91,109  2,255,901 | 2,347,010 
      2017 |    93,553  2,278,348 | 2,371,901 
      2018 |    96,080  2,306,022 | 2,402,102 
      2019 |    96,088  2,344,171 | 2,440,259 
      2020 |    71,827  1,877,155 | 1,948,982 
      2021 |    97,600  2,361,518 | 2,459,118 
      2022 |   106,231  2,430,426 | 2,536,657 
      2023 |    98,226  2,479,566 | 2,577,792 
      2024 |    93,040  2,503,203 | 2,596,243 
-----------+----------------------+----------
     Total |   933,246 23,081,791 |24,015,037 

. tab year same_county if migrate1 == 2

           |      same_county
      year |         0          1 |     Total
-----------+----------------------+----------
      2015 |    42,597    172,956 |   215,553 
      2016 |    43,823    172,091 |   215,914 
      2017 |    45,058    174,386 |   219,444 
      2018 |    46,477    173,182 |   219,659 
      2019 |    46,329    168,101 |   214,430 
      2020 |    34,625    119,307 |   153,932 
      2021 |    46,470    148,925 |   195,395 
      2022 |    50,584    141,717 |   192,301 
      2023 |    47,498    135,794 |   183,292 
      2024 |    46,033    134,313 |   180,346 
-----------+----------------------+----------
     Total |   449,494  1,540,772 | 1,990,266 

. 
. ** Tag HH head 
. gen byte hh_head = (relate == 1)

. 
. ** Compress file 
. compress 
  variable incwelfr was long now int
  variable incsupp was long now int
  variable state_fips_o was int now byte
  variable hh_size was float now byte
  variable hh_adult_ct was float now byte
  variable hh_child_ct was float now byte
  variable college was float now byte
  variable hh_any_child was float now byte
  variable hh_any_college was float now byte
  variable hh_perwt was float now int
  variable same_county was float now byte
  (672,421,036 bytes saved)

. 
. ** Save 
. save "${data}working/acs_migration_file", replace 
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/acs_migration_file.dta saved

. 
. ** Keep only observations with valid origin/destination counties and YEAR
. drop if missing(year) | missing(fips_o) | missing(fips_d)
(0 observations deleted)

. 
. ** Clean income (treat missing as 0; keep negative values as reported)
. replace inctot = 0 if missing(inctot)
(0 real changes made)

. gen double income_wt = inctot * perwt

. label var income_wt "Person income (INCTOT) weighted by PERWT"

. 
. ** Persons + income totals by origin/destination/year
. 
. preserve

. keep year fips_o fips_d perwt income_wt

. collapse (sum) persons=perwt income_total=income_wt, by(year fips_o fips_d)

. tempfile acs_pi

. save `acs_pi'
file C:\Users\ji252\AppData\Local\Temp\ST_92f0_00000f.tmp saved as .dta format

. restore

. 
. ** Households by origin/destination/year
. ** Use HHWT among household heads (RELATE==1)
. 
. preserve

. keep if hh_head == 1 
(11,523,232 observations deleted)

. keep year fips_o fips_d hhwt

. collapse (sum) households=hhwt, by(year fips_o fips_d)

. tempfile acs_hh

. save `acs_hh'
file C:\Users\ji252\AppData\Local\Temp\ST_92f0_00000h.tmp saved as .dta format

. restore

. 
. ** Merge persons/income with households
. use `acs_pi', clear

. merge 1:1 year fips_o fips_d using `acs_hh', nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                        50,330
        from master                    50,330  
        from using                          0  

    Matched                           181,401  
    -----------------------------------------

. 
. label var persons "Estimated number of persons (sum PERWT)"

. label var households "Estimated number of households (sum HHWT among heads)"

. label var income_total "Estimated total personal income (sum INCTOT*PERWT)"

. 
. ** Derive state/county components for merges with name crosswalk
. gen int state_fips_o  = floor(fips_o/1000)

. gen int county_fips_o = mod(fips_o,1000)

. gen int state_fips_d  = floor(fips_d/1000)

. gen int county_fips_d = mod(fips_d,1000)

. 
. label var state_fips_o "State FIPS (origin)"

. label var county_fips_o "County FIPS (origin)"

. label var state_fips_d "State FIPS (destination)"

. label var county_fips_d "County FIPS (destination)"

. 
. ** Merge in names (from NHGIS IDs snapshot)
. 
. 
. ** Loop over orgin and destination states
. foreach x in "d" "o" {
  2.         
.         preserve
  3.         
.         ** Load County IDs 
.         use "${data}working/ids", clear
  4.         
.         ** Rename 
.         rename  (state_fips county_fips state_name county_name) ///
>                         (state_fips_`x' county_fips_`x' state_name_`x' county_name_`x')
  5.                 
.         ** Save as temporary file       
.         tempfile ids_`x'
  6.         save `ids_`x''
  7.         
.         ** Restore and merge data 
.         restore
  8.         merge m:1 state_fips_`x' county_fips_`x' using `ids_`x'', keep(master match) nogen
  9. 
. } // END ORIGIN - DESTINATION LOOP 
file C:\Users\ji252\AppData\Local\Temp\ST_92f0_00000j.tmp saved as .dta format

    Result                      Number of obs
    -----------------------------------------
    Not matched                        55,890
        from master                    55,890  
        from using                          0  

    Matched                           175,841  
    -----------------------------------------
file C:\Users\ji252\AppData\Local\Temp\ST_92f0_00000l.tmp saved as .dta format

    Result                      Number of obs
    -----------------------------------------
    Not matched                        52,146
        from master                    52,146  
        from using                          0  

    Matched                           179,585  
    -----------------------------------------

. 
. ** Organize data 
. order year ///
>     state_fips_o county_fips_o state_name_o county_name_o fips_o ///
>     state_fips_d county_fips_d state_name_d county_name_d fips_d ///
>     persons households income_total

. 
. ** Sort data 
. sort year state_fips_o county_fips_o state_fips_d county_fips_d

. 
. ** Identify other counties (suppression)
. replace county_name_o = "Other" if county_fips_o == 0 
(52,066 real changes made)

. replace county_name_d = "Other" if county_fips_d == 0 
(55,163 real changes made)

. 
. ** Save data
. save "${data}working/acs_county_flow", replace
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/acs_county_flow.dta saved

. clear 

. 
. ** Create gross-migration files for ACS 
. 
. ** All (25+)
. acs_make_gross_migration using "${data}working/acs_migration_file", ///
>     saving("${data}working/acs_county_gross_25plus") replace sample("age >= 25")
(2,135,766 observations deleted)
(0 observations deleted)
(0 real changes made)
(9,739,225 missing values generated)
(9,739,225 missing values generated)
(9,739,225 real changes made)
(197,349 missing values generated)
(162,775 missing values generated)
(44,224 missing values generated)
(197,349 missing values generated)
(162,775 missing values generated)
(44,224 missing values generated)
(197,349 missing values generated)
(162,775 missing values generated)
(44,224 missing values generated)
(file C:\Users\ji252\AppData\Local\Temp\ST_92f0_00000n.tmp not found)
file C:\Users\ji252\AppData\Local\Temp\ST_92f0_00000n.tmp saved as .dta format
(197,349 missing values generated)
(162,775 missing values generated)
(44,224 missing values generated)
(197,349 missing values generated)
(162,775 missing values generated)
(44,224 missing values generated)
(197,349 missing values generated)
(162,775 missing values generated)
(44,224 missing values generated)
(file C:\Users\ji252\AppData\Local\Temp\ST_92f0_00000p.tmp not found)
file C:\Users\ji252\AppData\Local\Temp\ST_92f0_00000p.tmp saved as .dta format

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                             4,825  
    -----------------------------------------
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(variable fips was long, now double to accommodate using data's values)

    Result                      Number of obs
    -----------------------------------------
    Not matched                           504
        from master                       504  
        from using                          0  

    Matched                             4,321  
    -----------------------------------------
  variable state_fips was int now byte
  variable fips was double now long
  variable persons_in_1 was double now long
  variable persons_in_4 was double now long
  variable persons_in_5 was double now long
  variable households_in_1 was double now long
  variable households_in_4 was double now long
  variable households_in_5 was double now long
  variable persons_in_2 was double now long
  variable persons_in_3 was double now long
  variable households_in_2 was double now long
  variable households_in_3 was double now long
  variable persons_out_1 was double now long
  variable persons_out_4 was double now long
  variable persons_out_5 was double now long
  variable households_out_1 was double now long
  variable households_out_4 was double now long
  variable households_out_5 was double now long
  variable persons_out_2 was double now long
  variable persons_out_3 was double now long
  variable households_out_2 was double now long
  variable households_out_3 was double now long
  variable persons_net_2 was double now long
  variable persons_net_3 was double now long
  variable persons_net_4 was double now long
  variable persons_net_5 was double now long
  variable households_net_2 was double now long
  variable households_net_3 was double now long
  variable households_net_4 was double now long
  variable households_net_5 was double now long
  variable county_name was str46 now str23
  (675,500 bytes saved)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/acs_county_gross_25plus.dta saved

.         
. ** College-degrees 
. acs_make_gross_migration  using "${data}working/acs_migration_file", ///
>     saving("${data}working/acs_county_gross_college") replace sample("hh_any_college == 1" & "age >= 25")
(2,135,766 observations deleted)
(0 observations deleted)
(0 real changes made)
(9,739,225 missing values generated)
(9,739,225 missing values generated)
(9,739,225 real changes made)
(197,349 missing values generated)
(162,775 missing values generated)
(44,224 missing values generated)
(197,349 missing values generated)
(162,775 missing values generated)
(44,224 missing values generated)
(197,349 missing values generated)
(162,775 missing values generated)
(44,224 missing values generated)
(file C:\Users\ji252\AppData\Local\Temp\ST_92f0_00000n.tmp not found)
file C:\Users\ji252\AppData\Local\Temp\ST_92f0_00000n.tmp saved as .dta format
(197,349 missing values generated)
(162,775 missing values generated)
(44,224 missing values generated)
(197,349 missing values generated)
(162,775 missing values generated)
(44,224 missing values generated)
(197,349 missing values generated)
(162,775 missing values generated)
(44,224 missing values generated)
(file C:\Users\ji252\AppData\Local\Temp\ST_92f0_00000p.tmp not found)
file C:\Users\ji252\AppData\Local\Temp\ST_92f0_00000p.tmp saved as .dta format

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                             4,825  
    -----------------------------------------
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(variable fips was long, now double to accommodate using data's values)

    Result                      Number of obs
    -----------------------------------------
    Not matched                           504
        from master                       504  
        from using                          0  

    Matched                             4,321  
    -----------------------------------------
  variable state_fips was int now byte
  variable fips was double now long
  variable persons_in_1 was double now long
  variable persons_in_4 was double now long
  variable persons_in_5 was double now long
  variable households_in_1 was double now long
  variable households_in_4 was double now long
  variable households_in_5 was double now long
  variable persons_in_2 was double now long
  variable persons_in_3 was double now long
  variable households_in_2 was double now long
  variable households_in_3 was double now long
  variable persons_out_1 was double now long
  variable persons_out_4 was double now long
  variable persons_out_5 was double now long
  variable households_out_1 was double now long
  variable households_out_4 was double now long
  variable households_out_5 was double now long
  variable persons_out_2 was double now long
  variable persons_out_3 was double now long
  variable households_out_2 was double now long
  variable households_out_3 was double now long
  variable persons_net_2 was double now long
  variable persons_net_3 was double now long
  variable persons_net_4 was double now long
  variable persons_net_5 was double now long
  variable households_net_2 was double now long
  variable households_net_3 was double now long
  variable households_net_4 was double now long
  variable households_net_5 was double now long
  variable county_name was str46 now str23
  (675,500 bytes saved)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/acs_county_gross_college.dta saved

.         
. ** No Kids
. acs_make_gross_migration using "${data}working/acs_migration_file", ///
>     saving("${data}working/acs_county_gross_nokids") replace sample("hh_any_child == 0" & "age >= 25")
(8,760,965 observations deleted)
(0 observations deleted)
(0 real changes made)
(6,391,490 missing values generated)
(6,391,490 missing values generated)
(6,391,490 real changes made)
(163,761 missing values generated)
(133,086 missing values generated)
(40,325 missing values generated)
(163,761 missing values generated)
(133,086 missing values generated)
(40,325 missing values generated)
(163,761 missing values generated)
(133,086 missing values generated)
(40,325 missing values generated)
(file C:\Users\ji252\AppData\Local\Temp\ST_92f0_00000n.tmp not found)
file C:\Users\ji252\AppData\Local\Temp\ST_92f0_00000n.tmp saved as .dta format
(163,761 missing values generated)
(133,086 missing values generated)
(40,325 missing values generated)
(163,761 missing values generated)
(133,086 missing values generated)
(40,325 missing values generated)
(163,761 missing values generated)
(133,086 missing values generated)
(40,325 missing values generated)
(file C:\Users\ji252\AppData\Local\Temp\ST_92f0_00000p.tmp not found)
file C:\Users\ji252\AppData\Local\Temp\ST_92f0_00000p.tmp saved as .dta format

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                             4,825  
    -----------------------------------------
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(variable fips was long, now double to accommodate using data's values)

    Result                      Number of obs
    -----------------------------------------
    Not matched                           504
        from master                       504  
        from using                          0  

    Matched                             4,321  
    -----------------------------------------
  variable state_fips was int now byte
  variable fips was double now long
  variable persons_in_1 was double now long
  variable persons_in_4 was double now long
  variable persons_in_5 was double now long
  variable households_in_1 was double now long
  variable households_in_4 was double now int
  variable households_in_5 was double now long
  variable persons_in_2 was double now long
  variable persons_in_3 was double now long
  variable households_in_2 was double now long
  variable households_in_3 was double now long
  variable persons_out_1 was double now long
  variable persons_out_4 was double now long
  variable persons_out_5 was double now long
  variable households_out_1 was double now long
  variable households_out_4 was double now long
  variable households_out_5 was double now long
  variable persons_out_2 was double now long
  variable persons_out_3 was double now long
  variable households_out_2 was double now long
  variable households_out_3 was double now long
  variable persons_net_2 was double now long
  variable persons_net_3 was double now long
  variable persons_net_4 was double now long
  variable persons_net_5 was double now long
  variable households_net_2 was double now long
  variable households_net_3 was double now long
  variable households_net_4 was double now long
  variable households_net_5 was double now int
  variable county_name was str46 now str23
  (694,800 bytes saved)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/acs_county_gross_nokids.dta saved

.         
. ********************************************************************************
. ** STEP 5: Import and Clean IRS Migration Data 
. ********************************************************************************
.         
. ** Loop over years 
. forvalues y = 16(1)22 {
  2.         
.         local start = `y' - 1
  3.         local end = `y'  
  4.         
.         ** Import data (out)
.         import delimited "${data}irs/countyoutflow`start'`end'.csv", clear 
  5.         
.         ** Describe data 
.         des 
  6.         
.         ** Generate year (end year)
.         gen year = 2000 + `y'
  7.         
.         ** Drop Regional Values 
.         drop if y2_state == "DS"
  8.         
.         ** Drop Foreign Migration 
.         drop if y2_state == "FR"
  9.         
.         ** Drop observations without a county
.         drop if y1_countyfips == 0 
 10.         
.         ** Deal with suppressed values 
.         unsuppress n1 n2 agi
 11.         
.         ** Drop unnecc variables 
.         drop y2_state y2_countyname
 12.                 
.         ** Create two versions: gross and net 
.         tempfile tmp
 13.         save `tmp'
 14.         
.         ** Gross first 
.         
.         ** Keep gross categories 
.         keep if ///
>                 (y1_statefips == y2_statefips & y1_countyfips == y2_countyfips) |       ///
>                 inlist(y2_statefips, 96, 97, 98)
 15. 
.         ** Clean up 
.         gen move_type = 0 
 16.         
.         ** Stayers 
.         replace move_type = 1 if        (y1_statefips == y2_statefips) &        ///
>                                                                 (y1_countyfips == y2_countyfips) 
 17.         
.         ** Movers
.         replace move_type = 2 if        y2_statefips == 96              // ALL 
 18.         replace move_type = 3 if        y2_statefips == 97 &    ///
>                                                                 y2_countyfips == 0              // Domestic Total
 19.         replace move_type = 4 if        y2_statefips == 97 &    ///
>                                                                 y2_countyfips == 1              // Within-state
 20.         replace move_type = 5 if        y2_statefips == 97 &    ///
>                                                                 y2_countyfips == 3              // Between-states 
 21.         replace move_type = 6 if        y2_statefips == 98              // Foreign 
 22.         
.         ** Label movers 
.         label values move_type lb_move_type 
 23.         
.         ** Generate total category 
.         foreach var of varlist n1 n2 agi {
 24.                 
.                 gen tmp = `var' if inlist(move_type, 1, 2)
 25.                 bysort y1_statefips y1_countyfips: egen `var'_total = total(tmp)
 26.                 drop tmp 
 27.                 
.         } // END VAR LOOP 
 28.         
.         ** Drop unnecc variables 
.         drop y2_* 
 29.         
.         ** Sort 
.         sort year y1_statefips y1_countyfips move_type 
 30. 
.         ** Order 
.         order year y1_statefips y1_countyfips move_type 
 31.         
.         ** Rename 
.         rename y1_countyfips county_fips 
 32.         rename y1_statefips state_fips 
 33.         
.         ** Label variables 
.         label var year "Tax year (year before move)"
 34.         label var state_fips "State FIPS code (origin state)"
 35.         label var county_fips "County FIPS code (origin county)"
 36.         label var move_type "Mover category"
 37.         label var n1 "Number of returns"
 38.         label var n2 "Number of exemptions"
 39.         label var agi "Adjusted Gross Income"
 40.         label var n1_total "Number of returns, county total (origin)"
 41.         label var n2_total "Number of exemptions, county total (origin)"
 42.         label var agi_total "Adjusted Gross Income, county total (origin)"
 43.         
.         ** Save 
.         save "${data}working/irs_county_gross_out_`y'", replace 
 44.         
.         ** Create version for merge with net 
.         keep if move_type == 3 
 45.         
.         ** Rename variables 
.         rename n1 n1_mover
 46.         rename n2 n2_mover 
 47.         rename agi agi_mover 
 48.         
.         label var n1_mover "Number of domestic mover returns"
 49.         label var n2_mover "Number of domestic mover exemptions"
 50.         label var agi_mover "Adjusted Gross Income, domestic movers"
 51.         
.         ** Save as temp file 
.         tempfile merge 
 52.         save `merge'
 53.         clear 
 54.         
.         ** Next, create flow file 
.         use `tmp', clear 
 55.         
.         ** Drop aggregate values 
.         drop if inlist(y2_statefips, 96, 97, 98)
 56.         drop if (y1_statefips == y2_statefips & y1_countyfips == y2_countyfips) 
 57.         
.         ** Sort 
.         sort year y1_statefips y1_countyfips y2_statefips y2_countyfips 
 58. 
.         ** Order 
.         order year y1_statefips y1_countyfips y2_statefips y2_countyfips
 59. 
.         
.         ** Rename 
.         rename y1_countyfips county_fips 
 60.         rename y1_statefips state_fips 
 61.         rename y2_countyfips y2_county_fips 
 62.         rename y2_statefips y2_state_fips       
 63.         
.         ** Label variables 
.         label var year "Tax year (year before move)"
 64.         label var state_fips "State FIPS code (origin state)"
 65.         label var county_fips "County FIPS code (origin county)"
 66.         label var y2_state_fips "State FIPS code (dest. state)"
 67.         label var y2_county_fips "County FIPS code (dest. county)"      
 68.         label var n1 "Number of returns"
 69.         label var n2 "Number of exemptions"
 70.         label var agi "Adjusted Gross Income"
 71.         
.         ** Merge with county of origin data 
.         merge m:1 state_fips county_fips using `merge', nogen keep(master match)
 72.         
.         ** Rename 
.         rename state_fips state_fips_o
 73.         rename county_fips county_fips_o
 74.         rename y2_* *_d 
 75.         
.         ** Dropo unnecc variable 
.         drop move_type 
 76.         
.         ** Save 
.         save "${data}working/irs_county_flow_`y'", replace 
 77.         clear
 78.         
.         ** Import data (in)
.         import delimited "${data}irs/countyinflow`start'`end'.csv", clear 
 79.         
.         ** Describe data 
.         des 
 80. 
.         ** Generate year 
.         gen year = 2000 + `y' 
 81.         
.         ** Drop Regional Values 
.         drop if y1_state == "DS"
 82.         
.         ** Drop Foreign Migration 
.         drop if y1_state == "FR"
 83.         
.         ** Drop observations with no county ID 
.         drop if y2_countyfips == 0 
 84.         
.         ** Keep gross categories 
.         keep if ///
>                 (y1_statefips == y2_statefips & y1_countyfips == y2_countyfips) |       ///
>                 inlist(y1_statefips, 96, 97, 98)
 85. 
.         ** Clean up 
.         gen move_type = 0 
 86.         
.         ** Deal with suppressed values 
.         unsuppress n1 n2 agi
 87.         
.         ** Stayers 
.         replace move_type = 1 if        (y1_statefips == y2_statefips) &        ///
>                                                                 (y1_countyfips == y2_countyfips) 
 88.         
.         ** Movers
.         replace move_type = 2 if        y1_statefips == 96              // ALL 
 89.         replace move_type = 3 if        y1_statefips == 97 &    ///
>                                                                 y1_countyfips == 0              // Domestic Total
 90.         replace move_type = 4 if        y1_statefips == 97 &    ///
>                                                                 y1_countyfips == 1              // Within-state
 91.         replace move_type = 5 if        y1_statefips == 97 &    ///
>                                                                 y1_countyfips == 3              // Between-states 
 92.         replace move_type = 6 if        y1_statefips == 98              // Foreign 
 93.         
.         ** Label move variable  
.         label values move_type lb_move_type 
 94.         
.         ** Generate total category 
.         foreach var of varlist n1 n2 agi {
 95.                 
.                 gen tmp = `var' if inlist(move_type, 1, 2)
 96.                 bysort y2_statefips y2_countyfips: egen `var'_total = total(tmp)
 97.                 drop tmp 
 98.                 
.         } // END VAR LOOP 
 99.         
.         ** Drop unnecc variables 
.         drop y1_*
100.         
.         ** Sort 
.         sort year y2_statefips y2_countyfips move_type 
101. 
.         ** Order 
.         order year y2_statefips y2_countyfips move_type 
102.         
.         ** Rename 
.         rename y2_countyfips county_fips 
103.         rename y2_statefips state_fips 
104.         
.         ** Label variables 
.         label var year "Tax year (year before move)"
105.         label var state_fips "State FIPS code (dest. state)"
106.         label var county_fips "County FIPS code (dest. county)"
107.         label var move_type "Mover category"
108.         label var n1 "Number of returns"
109.         label var n2 "Number of exemptions"
110.         label var agi "Adjusted Gross Income"
111.         label var n1_total "Number of returns, county total (dest.)"
112.         label var n2_total "Number of exemptions, county total (dest.)"
113.         label var agi_total "Adjusted Gross Income, county total (dest.)"
114.         
.         ** Save 
.         save "${data}working/irs_county_gross_in_`y'", replace 
115.         clear 
116.         
. } // END YEAR LOOP 
(encoding automatically selected: ISO-8859-1)
(9 vars, 86,481 obs)

Contains data
 Observations:        86,481                  
    Variables:             9                  
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable label
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y2_state        str2    %9s                   
y2_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(15,289 observations deleted)
(2,937 observations deleted)
(254 observations deleted)
(2,056 real changes made)
(2,056 real changes made)
(2,056 real changes made)
file C:\Users\ji252\AppData\Local\Temp\ST_92f0_00000m.tmp saved as .dta format
(50,007 observations deleted)
(3,141 real changes made)
(3,141 real changes made)
(3,141 real changes made)
(3,140 real changes made)
(3,140 real changes made)
(2,291 real changes made)
(11,712 missing values generated)
(11,712 missing values generated)
(11,712 missing values generated)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/irs_county_gross_out_16.dta saved
(14,853 observations deleted)
file C:\Users\ji252\AppData\Local\Temp\ST_92f0_00000n.tmp saved as .dta format
(14,853 observations deleted)
(3,141 observations deleted)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            50,007  
    -----------------------------------------
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/irs_county_flow_16.dta saved
(encoding automatically selected: ISO-8859-1)
(9 vars, 86,330 obs)

Contains data
 Observations:        86,330                  
    Variables:             9                  
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable label
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y1_state        str2    %9s                   
y1_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(15,315 observations deleted)
(2,814 observations deleted)
(254 observations deleted)
(50,005 observations deleted)
(2,041 real changes made)
(2,041 real changes made)
(2,041 real changes made)
(3,141 real changes made)
(3,141 real changes made)
(3,141 real changes made)
(3,140 real changes made)
(3,140 real changes made)
(2,239 real changes made)
(11,660 missing values generated)
(11,660 missing values generated)
(11,660 missing values generated)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/irs_county_gross_in_16.dta saved
(encoding automatically selected: ISO-8859-1)
(9 vars, 98,948 obs)

Contains data
 Observations:        98,948                  
    Variables:             9                  
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable label
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y2_state        str2    %9s                   
y2_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(15,372 observations deleted)
(2,360 observations deleted)
(254 observations deleted)
(1,877 real changes made)
(1,877 real changes made)
(1,877 real changes made)
file C:\Users\ji252\AppData\Local\Temp\ST_92f0_00000o.tmp saved as .dta format
(63,249 observations deleted)
(3,140 real changes made)
(3,141 real changes made)
(3,141 real changes made)
(3,140 real changes made)
(3,141 real changes made)
(2,010 real changes made)
(11,432 missing values generated)
(11,432 missing values generated)
(11,432 missing values generated)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/irs_county_gross_out_17.dta saved
(14,572 observations deleted)
file C:\Users\ji252\AppData\Local\Temp\ST_92f0_00000p.tmp saved as .dta format
(14,573 observations deleted)
(3,140 observations deleted)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            63,249  
    -----------------------------------------
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/irs_county_flow_17.dta saved
(encoding automatically selected: ISO-8859-1)
(9 vars, 98,874 obs)

Contains data
 Observations:        98,874                  
    Variables:             9                  
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable label
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y1_state        str2    %9s                   
y1_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(15,432 observations deleted)
(2,282 observations deleted)
(254 observations deleted)
(63,249 observations deleted)
(1,788 real changes made)
(1,788 real changes made)
(1,788 real changes made)
(3,140 real changes made)
(3,141 real changes made)
(3,141 real changes made)
(3,140 real changes made)
(3,140 real changes made)
(1,955 real changes made)
(11,376 missing values generated)
(11,376 missing values generated)
(11,376 missing values generated)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/irs_county_gross_in_17.dta saved
(encoding automatically selected: ISO-8859-1)
(9 vars, 87,820 obs)

Contains data
 Observations:        87,820                  
    Variables:             9                  
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable label
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y2_state        str2    %9s                   
y2_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(15,300 observations deleted)
(2,364 observations deleted)
(254 observations deleted)
(1,942 real changes made)
(1,942 real changes made)
(1,942 real changes made)
file C:\Users\ji252\AppData\Local\Temp\ST_92f0_00000q.tmp saved as .dta format
(52,173 observations deleted)
(3,141 real changes made)
(3,141 real changes made)
(3,141 real changes made)
(3,140 real changes made)
(3,140 real changes made)
(2,026 real changes made)
(11,447 missing values generated)
(11,447 missing values generated)
(11,447 missing values generated)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/irs_county_gross_out_18.dta saved
(14,588 observations deleted)
file C:\Users\ji252\AppData\Local\Temp\ST_92f0_00000r.tmp saved as .dta format
(14,588 observations deleted)
(3,141 observations deleted)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            52,173  
    -----------------------------------------
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/irs_county_flow_18.dta saved
(encoding automatically selected: ISO-8859-1)
(9 vars, 87,932 obs)

Contains data
 Observations:        87,932                  
    Variables:             9                  
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable label
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y1_state        str2    %9s                   
y1_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(15,368 observations deleted)
(2,403 observations deleted)
(254 observations deleted)
(52,174 observations deleted)
(1,919 real changes made)
(1,919 real changes made)
(1,919 real changes made)
(3,141 real changes made)
(3,141 real changes made)
(3,141 real changes made)
(3,140 real changes made)
(3,140 real changes made)
(2,030 real changes made)
(11,451 missing values generated)
(11,451 missing values generated)
(11,451 missing values generated)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/irs_county_gross_in_18.dta saved
(encoding automatically selected: ISO-8859-1)
(9 vars, 83,878 obs)

Contains data
 Observations:        83,878                  
    Variables:             9                  
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable label
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y2_state        str2    %9s                   
y2_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(14,919 observations deleted)
(2,298 observations deleted)
(0 observations deleted)
(53 real changes made)
(53 real changes made)
(53 real changes made)
file C:\Users\ji252\AppData\Local\Temp\ST_92f0_00000s.tmp saved as .dta format
(51,090 observations deleted)
(3,141 real changes made)
(3,107 real changes made)
(3,107 real changes made)
(3,103 real changes made)
(2,778 real changes made)
(335 real changes made)
(9,323 missing values generated)
(9,323 missing values generated)
(9,323 missing values generated)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/irs_county_gross_out_19.dta saved
(12,464 observations deleted)
file C:\Users\ji252\AppData\Local\Temp\ST_92f0_00000t.tmp saved as .dta format
(12,430 observations deleted)
(3,141 observations deleted)

    Result                      Number of obs
    -----------------------------------------
    Not matched                            34
        from master                        34  
        from using                          0  

    Matched                            51,056  
    -----------------------------------------
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/irs_county_flow_19.dta saved
(encoding automatically selected: ISO-8859-1)
(9 vars, 83,762 obs)

Contains data
 Observations:        83,762                  
    Variables:             9                  
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable label
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y1_state        str2    %9s                   
y1_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(14,890 observations deleted)
(2,290 observations deleted)
(0 observations deleted)
(51,090 observations deleted)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(3,141 real changes made)
(3,086 real changes made)
(3,086 real changes made)
(3,082 real changes made)
(2,729 real changes made)
(368 real changes made)
(9,265 missing values generated)
(9,265 missing values generated)
(9,265 missing values generated)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/irs_county_gross_in_19.dta saved
(encoding automatically selected: ISO-8859-1)
(9 vars, 87,325 obs)

Contains data
 Observations:        87,325                  
    Variables:             9                  
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable label
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y2_state        str2    %9s                   
y2_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(14,937 observations deleted)
(2,272 observations deleted)
(0 observations deleted)
(62 real changes made)
(62 real changes made)
(62 real changes made)
file C:\Users\ji252\AppData\Local\Temp\ST_92f0_00000u.tmp saved as .dta format
(54,560 observations deleted)
(3,142 real changes made)
(3,104 real changes made)
(3,104 real changes made)
(3,101 real changes made)
(2,773 real changes made)
(332 real changes made)
(9,310 missing values generated)
(9,310 missing values generated)
(9,310 missing values generated)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/irs_county_gross_out_20.dta saved
(12,452 observations deleted)
file C:\Users\ji252\AppData\Local\Temp\ST_92f0_00000v.tmp saved as .dta format
(12,414 observations deleted)
(3,142 observations deleted)

    Result                      Number of obs
    -----------------------------------------
    Not matched                            38
        from master                        38  
        from using                          0  

    Matched                            54,522  
    -----------------------------------------
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/irs_county_flow_20.dta saved
(encoding automatically selected: ISO-8859-1)
(9 vars, 87,552 obs)

Contains data
 Observations:        87,552                  
    Variables:             9                  
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable label
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y1_state        str2    %9s                   
y1_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(15,060 observations deleted)
(2,323 observations deleted)
(0 observations deleted)
(54,560 observations deleted)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(3,142 real changes made)
(3,102 real changes made)
(3,102 real changes made)
(3,097 real changes made)
(2,805 real changes made)
(361 real changes made)
(9,365 missing values generated)
(9,365 missing values generated)
(9,365 missing values generated)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/irs_county_gross_in_20.dta saved
(encoding automatically selected: ISO-8859-1)
(9 vars, 89,511 obs)

Contains data
 Observations:        89,511                  
    Variables:             9                  
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable label
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y2_state        str2    %9s                   
y2_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(14,963 observations deleted)
(2,175 observations deleted)
(0 observations deleted)
(79 real changes made)
(79 real changes made)
(79 real changes made)
file C:\Users\ji252\AppData\Local\Temp\ST_92f0_00000w.tmp saved as .dta format
(56,831 observations deleted)
(3,143 real changes made)
(3,097 real changes made)
(3,097 real changes made)
(3,094 real changes made)
(2,787 real changes made)
(324 real changes made)
(9,302 missing values generated)
(9,302 missing values generated)
(9,302 missing values generated)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/irs_county_gross_out_21.dta saved
(12,445 observations deleted)
file C:\Users\ji252\AppData\Local\Temp\ST_92f0_00000x.tmp saved as .dta format
(12,399 observations deleted)
(3,143 observations deleted)

    Result                      Number of obs
    -----------------------------------------
    Not matched                            46
        from master                        46  
        from using                          0  

    Matched                            56,785  
    -----------------------------------------
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/irs_county_flow_21.dta saved
(encoding automatically selected: ISO-8859-1)
(9 vars, 89,850 obs)

Contains data
 Observations:        89,850                  
    Variables:             9                  
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable label
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y1_state        str2    %9s                   
y1_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(15,132 observations deleted)
(2,263 observations deleted)
(0 observations deleted)
(56,835 observations deleted)
(1 real change made)
(1 real change made)
(1 real change made)
(3,143 real changes made)
(3,101 real changes made)
(3,101 real changes made)
(3,098 real changes made)
(2,838 real changes made)
(339 real changes made)
(9,376 missing values generated)
(9,376 missing values generated)
(9,376 missing values generated)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/irs_county_gross_in_21.dta saved
(encoding automatically selected: ISO-8859-1)
(9 vars, 90,409 obs)

Contains data
 Observations:        90,409                  
    Variables:             9                  
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable label
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y2_state        str2    %9s                   
y2_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(14,962 observations deleted)
(2,223 observations deleted)
(0 observations deleted)
(64 real changes made)
(64 real changes made)
(64 real changes made)
file C:\Users\ji252\AppData\Local\Temp\ST_92f0_000010.tmp saved as .dta format
(57,644 observations deleted)
(3,144 real changes made)
(3,107 real changes made)
(3,107 real changes made)
(3,103 real changes made)
(2,790 real changes made)
(329 real changes made)
(9,329 missing values generated)
(9,329 missing values generated)
(9,329 missing values generated)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/irs_county_gross_out_22.dta saved
(12,473 observations deleted)
file C:\Users\ji252\AppData\Local\Temp\ST_92f0_000011.tmp saved as .dta format
(12,436 observations deleted)
(3,144 observations deleted)

    Result                      Number of obs
    -----------------------------------------
    Not matched                            37
        from master                        37  
        from using                          0  

    Matched                            57,607  
    -----------------------------------------
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/irs_county_flow_22.dta saved
(encoding automatically selected: ISO-8859-1)
(9 vars, 90,498 obs)

Contains data
 Observations:        90,498                  
    Variables:             9                  
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable label
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
y2_statefips    byte    %8.0g                 
y2_countyfips   int     %8.0g                 
y1_statefips    byte    %8.0g                 
y1_countyfips   int     %8.0g                 
y1_state        str2    %9s                   
y1_countyname   str60   %60s                  
n1              long    %12.0g                
n2              long    %12.0g                
agi             long    %12.0g                
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
(15,093 observations deleted)
(2,179 observations deleted)
(0 observations deleted)
(57,640 observations deleted)
(1 real change made)
(1 real change made)
(1 real change made)
(3,144 real changes made)
(3,098 real changes made)
(3,098 real changes made)
(3,094 real changes made)
(2,822 real changes made)
(330 real changes made)
(9,344 missing values generated)
(9,344 missing values generated)
(9,344 missing values generated)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/irs_county_gross_in_22.dta saved

. 
. ** Append data 
. 
. ** Loop over datasets 
. foreach file in "irs_county_gross_in" "irs_county_gross_out" "irs_county_flow"{
  2.         
.                 
.         ** Loop over years 
.         forvalues y = 16(1)22 {
  3. 
.                 ** Append 
.                 append using "${data}working/`file'_`y'"
  4.                 
.         } // END YEAR LOOP 
  5.         
.         
.         ** Order and sort flow file 
.         if "`file'" == "irs_county_flow" {
  6.                 
.                 ** Loop over orgin and destination state 
.                 foreach x in "o" "d" {
  7.                         
.                         ** Rename 
.                         rename *_fips_`x' *_fips 
  8.                         
.                         ** Merge with county and state names 
.                         merge m:1 state_fips county_fips using "${data}working/ids",    ///
>                                 keep(match) nogen 
  9.                                 
.                         ** Rename 
.                         rename *_fips *_fips_`x' 
 10.                         rename *_name *_name_`x' 
 11.                         
.                         ** Generate county IDS 
.                         make_fips state_fips_`x' county_fips_`x', gen(fips_`x')
 12.                         
.                 } // END ORIGIN / DESTINATION LOOP 
 13.                 
.                 ** Order file 
.                 order year state_*_o county_*_o state_*_d county_*_d  
 14.                 sort year state_*_o county_*_o state_*_d county_*_d  
 15. 
.         } // END MIGRATION FLOW IF-STATEMENT 
 16.         
.         else {
 17.                 
.                 ** Merge with county and state names 
.                 merge m:1 state_fips county_fips using "${data}working/ids",    ///
>                                 keep(match) nogen 
 18.                                 
.                 ** Order 
.                 order year state_* county* move_type
 19.                 
.         } 
 20.         
.         ** Save file 
.         save "${data}working/`file'", replace 
 21.         clear 
 22.         
. } // END FILE LOOP 

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           115,567  
    -----------------------------------------
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/irs_county_gross_in.dta saved

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           115,611  
    -----------------------------------------
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/irs_county_gross_out.dta saved

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           384,896  
    -----------------------------------------

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                           362,678  
    -----------------------------------------
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/irs_county_flow.dta saved

. 
. ** Create gross file with in and out migration 
. use "${data}working/irs_county_gross_in", clear 

. 
. ** Rename 
. rename n1 n1_in_

. rename n2 n2_in_

. rename agi agi_in_

. rename *_total *_total_in

. 
. ** Reshape 
. reshape wide n1_in_ n2_in_ agi_in_, i(year state_fips county_fips) j(move_type)
(j = 1 2 3 4 5 6)

Data                               Long   ->   Wide
-----------------------------------------------------------------------------
Number of observations          115,567   ->   21,980      
Number of variables                  13   ->   27          
j variable (6 values)         move_type   ->   (dropped)
xij variables:
                                 n1_in_   ->   n1_in_1 n1_in_2 ... n1_in_6
                                 n2_in_   ->   n2_in_1 n2_in_2 ... n2_in_6
                                agi_in_   ->   agi_in_1 agi_in_2 ... agi_in_6
-----------------------------------------------------------------------------

. 
. ** Define locals 
. local txt1 "Non-movers"

. local txt2 "All movers"                 

. local txt3 "Domestic movers"            

. local txt4 "Within-state movers"        

. local txt5 "Inter-state movers" 

. local txt6 "Foreign movers"

. 
. ** Label variables, in loop 
. foreach n of numlist 1(1)6 {
  2.         
.         label var n1_in_`n' "Returns, in-migration, `txt`n''"
  3.         label var n2_in_`n' "Exemptions, in-migration, `txt`n''"
  4.         label var agi_in_`n' "AGI, in-migration, `txt`n''"
  5. 
. } // END NUMLIST LOOP 

. 
. ** Preserve 
. tempfile gross_in

. save `gross_in'
file C:\Users\ji252\AppData\Local\Temp\ST_92f0_000012.tmp saved as .dta format

. clear

. 
. ** Create gross file with in and out migration 
. use "${data}working/irs_county_gross_out", clear 

. 
. ** Rename 
. rename n1 n1_out_

. rename n2 n2_out_

. rename agi agi_out_

. rename *_total *_total_out

. 
. ** Reshape 
. reshape wide n1_out_ n2_out_ agi_out_, i(year state_fips county_fips) j(move_type)
(j = 1 2 3 4 5 6)

Data                               Long   ->   Wide
-----------------------------------------------------------------------------
Number of observations          115,611   ->   21,980      
Number of variables                  13   ->   27          
j variable (6 values)         move_type   ->   (dropped)
xij variables:
                                n1_out_   ->   n1_out_1 n1_out_2 ... n1_out_6
                                n2_out_   ->   n2_out_1 n2_out_2 ... n2_out_6
                               agi_out_   ->   agi_out_1 agi_out_2 ... agi_out_6
-----------------------------------------------------------------------------

. 
. ** Define locals 
. local txt1 "Non-movers"

. local txt2 "All movers"                 

. local txt3 "Domestic movers"            

. local txt4 "Within-state movers"        

. local txt5 "Inter-state movers" 

. local txt6 "Foreign movers"

. 
. ** Label variables, in loop 
. foreach n of numlist 1(1)6 {
  2.         
.         label var n1_out_`n' "Returns, out-migration, `txt`n''"
  3.         label var n2_out_`n' "Exemptions, out-migration, `txt`n''"
  4.         label var agi_out_`n' "AGI, out-migration, `txt`n''"
  5. 
. } // END NUMLIST LOOP 

. 
. ** Merge data 
. merge 1:1 year state_fips county_fips using `gross_in', keep(match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                            21,980  
    -----------------------------------------

. 
. ** Text for correct matching (non-movers should match perfectly)
. summ n*_*_1 agi_*_1

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
    n1_out_1 |     21,979    37461.71    123155.4          0    3944880
    n2_out_1 |     21,979    78000.79    252081.2          0    7841705
     n1_in_1 |     21,979    37461.71    123155.4          0    3944880
     n2_in_1 |     21,979    78000.79    252081.2          0    7841705
   agi_out_1 |     21,979     3214755    1.23e+07      -8051   4.30e+08
-------------+---------------------------------------------------------
    agi_in_1 |     21,979     3214755    1.23e+07      -8051   4.30e+08

. 
. ** Define net migration variables 
. 
. ** Loop over variable
. foreach a in "n1" "n2" "agi" {
  2. 
.         if "`a'" == "n1" local txt "Returns"
  3.         else if "`a'" == "n2" local txt "Exemptions"
  4.         else if "`a'" == "agi" local txt "AGI"
  5. 
.         ** Loop over type of movers 
.         forvalues n = 2/6 {
  6.                 
.                 ** Clean up missing values 
.                 replace `a'_in_`n' = 0 if missing(`a'_in_`n')
  7.                 replace `a'_out_`n' = 0 if missing(`a'_out_`n')
  8. 
.                 ** Generate net 
.                 gen `a'_net_`n' = `a'_in_`n' - `a'_out_`n'
  9.                 label var `a'_net_`n' "`txt', net-migration, `txt`n''"
 10. 
.         } // END MOVER TYPE LOOP 
 11. 
. } // END VARIABLE LOOP 
(183 real changes made)
(155 real changes made)
(183 real changes made)
(155 real changes made)
(202 real changes made)
(172 real changes made)
(1,379 real changes made)
(1,444 real changes made)
(14,365 real changes made)
(14,342 real changes made)
(183 real changes made)
(155 real changes made)
(183 real changes made)
(155 real changes made)
(202 real changes made)
(172 real changes made)
(1,379 real changes made)
(1,444 real changes made)
(14,365 real changes made)
(14,342 real changes made)
(183 real changes made)
(155 real changes made)
(183 real changes made)
(155 real changes made)
(202 real changes made)
(172 real changes made)
(1,379 real changes made)
(1,444 real changes made)
(14,365 real changes made)
(14,342 real changes made)

. 
. ** Generate fips variable
. *make_fips state_fips county_fips, gen(fips)
. 
. ** Save file 
. save "${data}working/irs_county_gross", replace 
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/irs_county_gross.dta saved

. clear

. 
. ********************************************************************************
. ** STEP 6: Import and Clean IRS County-Level Aggr. Data 
. ********************************************************************************
. 
. ** Loop over years 
. forvalues y = 15(1)22 {
  2.         
.         
.         ** Import data (out)
.         import delimited "${data}irs/`y'incyallagi.csv", clear 
  3. 
.         ** Describe data 
.         des 
  4.         
.         ** Generate year 
.         gen year = 2000 + `y' 
  5.         
.         ** Define AGI groups 
.         label var agi_stub "AGI Brackets"
  6.         label values agi_stub lb_agi 
  7.         
.         ** Define set of variables to keep 
.         keep state* county* agi_stub year n1 mars1 mars2 mars4 n2 elderly       ///
>                 a00100 n02650 a02650 n00200 a00200 
  8.                 
.         ** Rename variables 
.         rename a00100 agi 
  9.         rename n02650 n_total_inc
 10.         rename a02650 a_total_inc
 11.         rename n00200 n_wage
 12.         rename a00200 a_wage 
 13.         rename statefips state_fips
 14.         rename state state_abb 
 15.         rename countyfips county_fips 
 16.         rename countyname county_name 
 17.         
.         ** Rescale 
.         replace agi = 1000 * agi 
 18.         replace a_total_inc = 1000 * a_total_inc
 19.         replace a_wage = 1000 * a_wage 
 20.         
.         ** Label
.         label var n1 "Number of returns"
 21.         label var mars1 "Number of single returns"
 22.         label var mars2 "Number of MFJ returns"
 23.         label var mars4 "Number of HoH returns"
 24.         label var n2 "Number of individuals"
 25.         label var elderly "Number of returns with one individual over 60"
 26.         label var agi "Adjusted Gross Income (AGI)"
 27.         label var n_total_inc "Number of returns with total income"
 28.         label var a_total_inc "Total income amount"
 29.         label var n_wage "Number of returns with wage income"
 30.         label var a_wage "Wage income amount"
 31.         
.         ** Sort 
.         sort year state_fips county_fips agi_stub 
 32.         
.         ** Order 
.         order year state* county* agi_stub 
 33.         
.         ** Save 
.         save "${data}working/irs_county_all_`y'", replace 
 34.         
.         clear 
 35.         
. } // END YEAR LOOP 
(encoding automatically selected: ISO-8859-1)
(132 vars, 25,536 obs)

Contains data
 Observations:        25,536                  
    Variables:           132                  
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable label
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
statefips       byte    %8.0g                 STATEFIPS
state           str2    %9s                   STATE
countyfips      int     %8.0g                 COUNTYFIPS
countyname      str20   %20s                  COUNTYNAME
agi_stub        byte    %8.0g                 
n1              long    %12.0g                N1
mars1           long    %12.0g                
mars2           long    %12.0g                MARS2
mars4           long    %12.0g                MARS4
prep            long    %12.0g                PREP
n2              long    %12.0g                N2
numdep          long    %12.0g                NUMDEP
total_vita      long    %12.0g                TOTAL_VITA
vita            long    %8.0g                 VITA
tce             long    %8.0g                 TCE
vita_eic        int     %8.0g                 VITA_EIC
ral             long    %8.0g                 RAL
rac             long    %12.0g                RAC
elderly         long    %12.0g                ELDERLY
a00100          long    %12.0g                A00100
n02650          long    %12.0g                N02650
a02650          long    %12.0g                A02650
n00200          long    %12.0g                N00200
a00200          long    %12.0g                A00200
n00300          long    %12.0g                N00300
a00300          long    %12.0g                A00300
n00600          long    %12.0g                N00600
a00600          long    %12.0g                A00600
n00650          long    %12.0g                N00650
a00650          long    %12.0g                A00650
n00700          long    %12.0g                N00700
a00700          long    %12.0g                A00700
n00900          long    %12.0g                N00900
a00900          long    %12.0g                A00900
n01000          long    %12.0g                N01000
a01000          long    %12.0g                A01000
n01400          long    %12.0g                N01400
a01400          long    %12.0g                A01400
n01700          long    %12.0g                N01700
a01700          long    %12.0g                A01700
schf            long    %8.0g                 SCHF
n02300          long    %12.0g                N02300
a02300          long    %12.0g                A02300
n02500          long    %12.0g                N02500
a02500          long    %12.0g                A02500
n26270          long    %12.0g                N26270
a26270          long    %12.0g                A26270
n02900          long    %12.0g                N02900
a02900          long    %12.0g                A02900
n03220          long    %12.0g                N03220
a03220          long    %8.0g                 A03220
n03300          long    %8.0g                 N03300
a03300          long    %12.0g                A03300
n03270          long    %8.0g                 N03270
a03270          long    %12.0g                A03270
n03150          long    %8.0g                 N03150
a03150          long    %12.0g                A03150
n03210          long    %12.0g                N03210
a03210          long    %12.0g                A03210
n03230          long    %8.0g                 N03230
a03230          long    %12.0g                A03230
n03240          int     %8.0g                 N03240
a03240          long    %12.0g                A03240
n04470          long    %12.0g                N04470
a04470          long    %12.0g                A04470
a00101          long    %12.0g                A00101
n18425          long    %12.0g                N18425
a18425          long    %12.0g                A18425
n18450          long    %12.0g                N18450
a18450          long    %12.0g                A18450
n18500          long    %12.0g                N18500
a18500          long    %12.0g                A18500
n18300          long    %12.0g                N18300
a18300          long    %12.0g                A18300
n19300          long    %12.0g                N19300
a19300          long    %12.0g                A19300
n19700          long    %12.0g                N19700
a19700          long    %12.0g                A19700
n04800          long    %12.0g                N04800
a04800          long    %12.0g                A04800
n05800          long    %12.0g                N05800
a05800          long    %12.0g                A05800
n09600          long    %12.0g                N09600
a09600          long    %12.0g                A09600
n05780          long    %8.0g                 N05780
a05780          long    %8.0g                 A05780
n07100          long    %12.0g                N07100
a07100          long    %12.0g                A07100
n07300          long    %12.0g                N07300
a07300          long    %12.0g                A07300
n07180          long    %12.0g                N07180
a07180          long    %8.0g                 A07180
n07230          long    %12.0g                N07230
a07230          long    %12.0g                A07230
n07240          long    %12.0g                N07240
a07240          long    %12.0g                A07240
n07220          long    %12.0g                N07220
a07220          long    %12.0g                A07220
n07260          long    %8.0g                 N07260
a07260          long    %8.0g                 A07260
n09400          long    %12.0g                N09400
a09400          long    %12.0g                A09400
n85770          long    %12.0g                N85770
a85770          long    %12.0g                A85770
n85775          long    %12.0g                N85775
a85775          long    %12.0g                A85775
n09750          long    %12.0g                N09750
a09750          long    %8.0g                 A09750
n10600          long    %12.0g                N10600
a10600          long    %12.0g                A10600
n59660          long    %12.0g                N59660
a59660          long    %12.0g                A59660
n59720          long    %12.0g                N59720
a59720          long    %12.0g                A59720
n11070          long    %12.0g                N11070
a11070          long    %12.0g                A11070
n10960          long    %12.0g                N10960
a10960          long    %12.0g                A10960
n11560          long    %8.0g                 N11560
a11560          long    %8.0g                 A11560
n06500          long    %12.0g                N06500
a06500          long    %12.0g                A06500
n10300          long    %12.0g                N10300
a10300          long    %12.0g                A10300
n85530          long    %12.0g                N85530
a85530          long    %12.0g                A85530
n85300          long    %12.0g                N85300
a85300          long    %12.0g                A85300
n11901          long    %12.0g                N11901
a11901          long    %12.0g                A11901
n11902          long    %12.0g                N11902
a11902          long    %12.0g                A11902
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
variable agi was long now double
(25,283 real changes made)
variable a_total_inc was long now double
(25,283 real changes made)
variable a_wage was long now double
(24,576 real changes made)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/irs_county_all_15.dta saved
(encoding automatically selected: ISO-8859-1)
(148 vars, 25,536 obs)

Contains data
 Observations:        25,536                  
    Variables:           148                  
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable label
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
statefips       byte    %8.0g                 STATEFIPS
state           str2    %9s                   STATE
countyfips      int     %8.0g                 COUNTYFIPS
countyname      str20   %20s                  COUNTYNAME
agi_stub        byte    %8.0g                 
n1              long    %12.0g                N1
mars1           long    %12.0g                
mars2           long    %12.0g                MARS2
mars4           long    %12.0g                MARS4
prep            long    %12.0g                PREP
n2              long    %12.0g                N2
numdep          long    %12.0g                NUMDEP
total_vita      long    %12.0g                TOTAL_VITA
vita            long    %8.0g                 VITA
tce             long    %12.0g                TCE
vita_eic        int     %8.0g                 VITA_EIC
ral             long    %12.0g                RAL
rac             long    %12.0g                RAC
elderly         long    %12.0g                ELDERLY
a00100          long    %12.0g                A00100
n02650          long    %12.0g                N02650
a02650          long    %12.0g                A02650
n00200          long    %12.0g                N00200
a00200          long    %12.0g                A00200
n00300          long    %12.0g                N00300
a00300          long    %12.0g                A00300
n00600          long    %12.0g                N00600
a00600          long    %12.0g                A00600
n00650          long    %12.0g                N00650
a00650          long    %12.0g                A00650
n00700          long    %12.0g                N00700
a00700          long    %12.0g                A00700
n00900          long    %12.0g                N00900
a00900          long    %12.0g                A00900
n01000          long    %12.0g                N01000
a01000          long    %12.0g                A01000
n01400          long    %12.0g                N01400
a01400          long    %12.0g                A01400
n01700          long    %12.0g                N01700
a01700          long    %12.0g                A01700
schf            long    %8.0g                 SCHF
n02300          long    %12.0g                N02300
a02300          long    %12.0g                A02300
n02500          long    %12.0g                N02500
a02500          long    %12.0g                A02500
n26270          long    %12.0g                N26270
a26270          long    %12.0g                A26270
n02900          long    %12.0g                N02900
a02900          long    %12.0g                A02900
n03220          long    %12.0g                N03220
a03220          long    %8.0g                 A03220
n03300          long    %8.0g                 N03300
a03300          long    %12.0g                A03300
n03270          long    %12.0g                N03270
a03270          long    %12.0g                A03270
n03150          long    %12.0g                N03150
a03150          long    %12.0g                A03150
n03210          long    %12.0g                N03210
a03210          long    %12.0g                A03210
n03230          long    %8.0g                 N03230
a03230          long    %12.0g                A03230
n03240          int     %8.0g                 N03240
a03240          long    %12.0g                A03240
n04470          long    %12.0g                N04470
a04470          long    %12.0g                A04470
a00101          long    %12.0g                A00101
n17000          long    %12.0g                N17000
a17000          long    %12.0g                A17000
n18425          long    %12.0g                N18425
a18425          long    %12.0g                A18425
n18450          long    %12.0g                N18450
a18450          long    %12.0g                A18450
n18500          long    %12.0g                N18500
a18500          long    %12.0g                A18500
n18800          long    %12.0g                N18800
a18800          long    %12.0g                A18800
n18300          long    %12.0g                N18300
a18300          long    %12.0g                A18300
n19300          long    %12.0g                N19300
a19300          long    %12.0g                A19300
n19500          long    %8.0g                 N19500
a19500          long    %12.0g                A19500
n19530          long    %12.0g                N19530
a19530          long    %12.0g                A19530
n19550          long    %12.0g                N19550
a19550          long    %12.0g                A19550
n19570          long    %12.0g                N19570
a19570          long    %12.0g                A19570
n19700          long    %12.0g                N19700
a19700          long    %12.0g                A19700
n20800          long    %12.0g                N20800
a20800          long    %12.0g                A20800
n21020          long    %8.0g                 N21020
a21020          long    %12.0g                A21020
n04800          long    %12.0g                N04800
a04800          long    %12.0g                A04800
n05800          long    %12.0g                N05800
a05800          long    %12.0g                A05800
n09600          long    %12.0g                N09600
a09600          long    %12.0g                A09600
n05780          long    %12.0g                N05780
a05780          long    %12.0g                A05780
n07100          long    %12.0g                N07100
a07100          long    %12.0g                A07100
n07300          long    %12.0g                N07300
a07300          long    %12.0g                A07300
n07180          long    %12.0g                N07180
a07180          long    %12.0g                A07180
n07230          long    %12.0g                N07230
a07230          long    %12.0g                A07230
n07240          long    %12.0g                N07240
a07240          long    %12.0g                A07240
n07220          long    %12.0g                N07220
a07220          long    %12.0g                A07220
n07260          long    %12.0g                N07260
a07260          long    %12.0g                A07260
n09400          long    %12.0g                N09400
a09400          long    %12.0g                A09400
n85770          long    %12.0g                N85770
a85770          long    %12.0g                A85770
n85775          long    %12.0g                N85775
a85775          long    %12.0g                A85775
n09750          long    %12.0g                N09750
a09750          long    %12.0g                A09750
n10600          long    %12.0g                N10600
a10600          long    %12.0g                A10600
n59660          long    %12.0g                N59660
a59660          long    %12.0g                A59660
n59720          long    %12.0g                N59720
a59720          long    %12.0g                A59720
n11070          long    %12.0g                N11070
a11070          long    %12.0g                A11070
n10960          long    %12.0g                N10960
a10960          long    %12.0g                A10960
n11560          long    %12.0g                N11560
a11560          long    %12.0g                A11560
n06500          long    %12.0g                N06500
a06500          long    %12.0g                A06500
n10300          long    %12.0g                N10300
a10300          long    %12.0g                A10300
n85530          long    %12.0g                N85530
a85530          long    %12.0g                A85530
n85300          long    %12.0g                N85300
a85300          long    %12.0g                A85300
n11901          long    %12.0g                N11901
a11901          long    %12.0g                A11901
n11902          long    %12.0g                N11902
a11902          long    %12.0g                A11902
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
variable agi was long now double
(25,267 real changes made)
variable a_total_inc was long now double
(25,267 real changes made)
variable a_wage was long now double
(24,662 real changes made)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/irs_county_all_16.dta saved
(encoding automatically selected: ISO-8859-1)
(154 vars, 25,536 obs)

Contains data
 Observations:        25,536                  
    Variables:           154                  
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable label
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
statefips       byte    %8.0g                 STATEFIPS
state           str2    %9s                   STATE
countyfips      int     %8.0g                 COUNTYFIPS
countyname      str20   %20s                  COUNTYNAME
agi_stub        byte    %8.0g                 
n1              long    %12.0g                N1
mars1           long    %12.0g                
mars2           long    %12.0g                MARS2
mars4           long    %12.0g                MARS4
elf             long    %12.0g                ELF
cprep           long    %8.0g                 CPREP
prep            long    %12.0g                PREP
dir_dep         long    %12.0g                DIR_DEP
n2              long    %12.0g                N2
numdep          long    %12.0g                NUMDEP
total_vita      long    %8.0g                 TOTAL_VITA
vita            long    %8.0g                 VITA
tce             long    %8.0g                 TCE
vita_eic        int     %8.0g                 VITA_EIC
rac             long    %12.0g                RAC
elderly         long    %12.0g                ELDERLY
a00100          long    %12.0g                A00100
n02650          long    %12.0g                N02650
a02650          long    %12.0g                A02650
n00200          long    %12.0g                N00200
a00200          long    %12.0g                A00200
n00300          long    %12.0g                N00300
a00300          long    %12.0g                A00300
n00600          long    %12.0g                N00600
a00600          long    %12.0g                A00600
n00650          long    %12.0g                N00650
a00650          long    %12.0g                A00650
n00700          long    %12.0g                N00700
a00700          long    %12.0g                A00700
n00900          long    %12.0g                N00900
a00900          long    %12.0g                A00900
n01000          long    %12.0g                N01000
a01000          long    %12.0g                A01000
n01400          long    %12.0g                N01400
a01400          long    %12.0g                A01400
n01700          long    %12.0g                N01700
a01700          long    %12.0g                A01700
schf            long    %8.0g                 SCHF
n02300          long    %8.0g                 N02300
a02300          long    %12.0g                A02300
n02500          long    %12.0g                N02500
a02500          long    %12.0g                A02500
n26270          long    %8.0g                 N26270
a26270          long    %12.0g                A26270
n02900          long    %12.0g                N02900
a02900          long    %12.0g                A02900
n03220          long    %8.0g                 N03220
a03220          long    %8.0g                 A03220
n03300          long    %8.0g                 N03300
a03300          long    %12.0g                A03300
n03270          long    %8.0g                 N03270
a03270          long    %12.0g                A03270
n03150          long    %8.0g                 N03150
a03150          long    %12.0g                A03150
n03210          long    %12.0g                N03210
a03210          long    %12.0g                A03210
n03230          long    %8.0g                 N03230
a03230          long    %8.0g                 A03230
n03240          long    %8.0g                 N03240
a03240          long    %12.0g                A03240
n04470          long    %12.0g                N04470
a04470          long    %12.0g                A04470
a00101          long    %12.0g                A00101
n17000          long    %12.0g                N17000
a17000          long    %12.0g                A17000
n18425          long    %12.0g                N18425
a18425          long    %12.0g                A18425
n18450          long    %8.0g                 N18450
a18450          long    %12.0g                A18450
n18500          long    %12.0g                N18500
a18500          long    %12.0g                A18500
n18800          long    %12.0g                N18800
a18800          long    %12.0g                A18800
n18300          long    %12.0g                N18300
a18300          long    %12.0g                A18300
n19300          long    %12.0g                N19300
a19300          long    %12.0g                A19300
n19500          long    %8.0g                 N19500
a19500          long    %8.0g                 A19500
n19530          long    %8.0g                 N19530
a19530          long    %8.0g                 A19530
n19550          long    %8.0g                 N19550
a19550          long    %8.0g                 A19550
n19570          long    %8.0g                 N19570
a19570          long    %12.0g                A19570
n19700          long    %12.0g                N19700
a19700          long    %12.0g                A19700
n20800          long    %12.0g                N20800
a20800          long    %12.0g                A20800
n20950          long    %8.0g                 N20950
a20950          long    %12.0g                A20950
n04800          long    %12.0g                N04800
a04800          long    %12.0g                A04800
n05800          long    %12.0g                N05800
a05800          long    %12.0g                A05800
n09600          long    %8.0g                 N09600
a09600          long    %12.0g                A09600
n05780          long    %8.0g                 N05780
a05780          long    %8.0g                 A05780
n07100          long    %12.0g                N07100
a07100          long    %12.0g                A07100
n07300          long    %8.0g                 N07300
a07300          long    %12.0g                A07300
n07180          long    %8.0g                 N07180
a07180          long    %8.0g                 A07180
n07230          long    %12.0g                N07230
a07230          long    %12.0g                A07230
n07240          long    %12.0g                N07240
a07240          long    %8.0g                 A07240
n07220          long    %12.0g                N07220
a07220          long    %12.0g                A07220
n07260          long    %8.0g                 N07260
a07260          long    %8.0g                 A07260
n09400          long    %12.0g                N09400
a09400          long    %12.0g                A09400
n85770          long    %12.0g                N85770
a85770          long    %12.0g                A85770
n85775          long    %12.0g                N85775
a85775          long    %12.0g                A85775
n09750          long    %8.0g                 N09750
a09750          long    %8.0g                 A09750
n10600          long    %12.0g                N10600
a10600          long    %12.0g                A10600
n59660          long    %12.0g                N59660
a59660          long    %12.0g                A59660
n59720          long    %12.0g                N59720
a59720          long    %12.0g                A59720
n11070          long    %12.0g                N11070
a11070          long    %12.0g                A11070
n10960          long    %12.0g                N10960
a10960          long    %12.0g                A10960
n11560          long    %8.0g                 N11560
a11560          long    %8.0g                 A11560
n06500          long    %12.0g                N06500
a06500          long    %12.0g                A06500
n10300          long    %12.0g                N10300
a10300          long    %12.0g                A10300
n85530          long    %8.0g                 N85530
a85530          long    %12.0g                A85530
n85300          long    %12.0g                N85300
a85300          long    %12.0g                A85300
n11901          long    %12.0g                N11901
a11901          long    %12.0g                A11901
n11900          long    %12.0g                N11900
a11900          long    %12.0g                A11900
n11902          long    %12.0g                N11902
a11902          long    %12.0g                A11902
n12000          long    %8.0g                 N12000
a12000          long    %12.0g                A12000
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
variable agi was long now double
(25,280 real changes made)
variable a_total_inc was long now double
(25,280 real changes made)
variable a_wage was long now double
(24,634 real changes made)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/irs_county_all_17.dta saved
(encoding automatically selected: ISO-8859-1)
(154 vars, 25,536 obs)

Contains data
 Observations:        25,536                  
    Variables:           154                  
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable label
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
statefips       byte    %8.0g                 STATEFIPS
state           str2    %9s                   STATE
countyfips      int     %8.0g                 COUNTYFIPS
countyname      str20   %20s                  COUNTYNAME
agi_stub        byte    %8.0g                 
n1              long    %12.0g                N1
mars1           long    %12.0g                
mars2           long    %12.0g                MARS2
mars4           long    %12.0g                MARS4
elf             long    %12.0g                ELF
cprep           long    %8.0g                 CPREP
prep            long    %12.0g                PREP
dir_dep         long    %12.0g                DIR_DEP
n2              long    %12.0g                N2
numdep          long    %12.0g                NUMDEP
total_vita      long    %8.0g                 TOTAL_VITA
vita            long    %8.0g                 VITA
tce             long    %8.0g                 TCE
vita_eic        int     %8.0g                 VITA_EIC
rac             long    %12.0g                RAC
elderly         long    %12.0g                ELDERLY
a00100          long    %12.0g                A00100
n02650          long    %12.0g                N02650
a02650          long    %12.0g                A02650
n00200          long    %12.0g                N00200
a00200          long    %12.0g                A00200
n00300          long    %12.0g                N00300
a00300          long    %12.0g                A00300
n00600          long    %12.0g                N00600
a00600          long    %12.0g                A00600
n00650          long    %12.0g                N00650
a00650          long    %12.0g                A00650
n00700          long    %12.0g                N00700
a00700          long    %12.0g                A00700
n00900          long    %12.0g                N00900
a00900          long    %12.0g                A00900
n01000          long    %12.0g                N01000
a01000          long    %12.0g                A01000
n01750          long    %12.0g                N01750
a01750          long    %12.0g                A01750
schf            long    %8.0g                 SCHF
n02300          long    %8.0g                 N02300
a02300          long    %12.0g                A02300
n02500          long    %12.0g                N02500
a02500          long    %12.0g                A02500
n26270          long    %8.0g                 N26270
a26270          long    %12.0g                A26270
n02900          long    %12.0g                N02900
a02900          long    %12.0g                A02900
n03220          long    %8.0g                 N03220
a03220          long    %8.0g                 A03220
n03300          long    %8.0g                 N03300
a03300          long    %12.0g                A03300
n03270          long    %8.0g                 N03270
a03270          long    %12.0g                A03270
n03150          long    %8.0g                 N03150
a03150          long    %12.0g                A03150
n03210          long    %12.0g                N03210
a03210          long    %12.0g                A03210
n04450          long    %12.0g                N04450
a04450          long    %12.0g                A04450
n04100          long    %12.0g                N04100
a04100          long    %12.0g                A04100
n04200          long    %12.0g                N04200
a04200          long    %12.0g                A04200
n04470          long    %12.0g                N04470
a04470          long    %12.0g                A04470
a00101          long    %12.0g                A00101
n17000          long    %8.0g                 N17000
a17000          long    %12.0g                A17000
n18425          long    %12.0g                N18425
a18425          long    %12.0g                A18425
n18450          long    %8.0g                 N18450
a18450          long    %8.0g                 A18450
n18500          long    %12.0g                N18500
a18500          long    %12.0g                A18500
n18800          long    %12.0g                N18800
a18800          long    %8.0g                 A18800
n18460          long    %12.0g                N18460
a18460          long    %12.0g                A18460
n18300          long    %12.0g                N18300
a18300          long    %12.0g                A18300
n19300          long    %12.0g                N19300
a19300          long    %12.0g                A19300
n19500          long    %8.0g                 N19500
a19500          long    %8.0g                 A19500
n19530          long    %8.0g                 N19530
a19530          long    %8.0g                 A19530
n19570          long    %8.0g                 N19570
a19570          long    %12.0g                A19570
n19700          long    %12.0g                N19700
a19700          long    %12.0g                A19700
n20950          long    %8.0g                 N20950
a20950          long    %12.0g                A20950
n04475          long    %12.0g                N04475
a04475          long    %12.0g                A04475
n04800          long    %12.0g                N04800
a04800          long    %12.0g                A04800
n05800          long    %12.0g                N05800
a05800          long    %12.0g                A05800
n09600          long    %8.0g                 N09600
a09600          long    %8.0g                 A09600
n05780          long    %8.0g                 N05780
a05780          long    %8.0g                 A05780
n07100          long    %12.0g                N07100
a07100          long    %12.0g                A07100
n07300          long    %8.0g                 N07300
a07300          long    %12.0g                A07300
n07180          long    %8.0g                 N07180
a07180          long    %8.0g                 A07180
n07230          long    %12.0g                N07230
a07230          long    %12.0g                A07230
n07240          long    %12.0g                N07240
a07240          long    %8.0g                 A07240
n07225          long    %12.0g                N07225
a07225          long    %12.0g                A07225
n07260          long    %8.0g                 N07260
a07260          long    %8.0g                 A07260
n09400          long    %12.0g                N09400
a09400          long    %12.0g                A09400
n85770          long    %12.0g                N85770
a85770          long    %12.0g                A85770
n85775          long    %12.0g                N85775
a85775          long    %12.0g                A85775
n09750          long    %8.0g                 N09750
a09750          long    %8.0g                 A09750
n10600          long    %12.0g                N10600
a10600          long    %12.0g                A10600
n59660          long    %12.0g                N59660
a59660          long    %12.0g                A59660
n59720          long    %12.0g                N59720
a59720          long    %12.0g                A59720
n11070          long    %12.0g                N11070
a11070          long    %12.0g                A11070
n10960          long    %12.0g                N10960
a10960          long    %12.0g                A10960
n11560          long    %8.0g                 N11560
a11560          long    %8.0g                 A11560
n06500          long    %12.0g                N06500
a06500          long    %12.0g                A06500
n10300          long    %12.0g                N10300
a10300          long    %12.0g                A10300
n85530          long    %8.0g                 N85530
a85530          long    %12.0g                A85530
n85300          long    %12.0g                N85300
a85300          long    %12.0g                A85300
n11901          long    %12.0g                N11901
a11901          long    %12.0g                A11901
n11900          long    %12.0g                N11900
a11900          long    %12.0g                A11900
n11902          long    %12.0g                N11902
a11902          long    %12.0g                A11902
n12000          long    %8.0g                 N12000
a12000          long    %12.0g                A12000
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
variable agi was long now double
(25,325 real changes made)
variable a_total_inc was long now double
(25,325 real changes made)
variable a_wage was long now double
(24,672 real changes made)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/irs_county_all_18.dta saved
(encoding automatically selected: ISO-8859-1)
(153 vars, 25,544 obs)

Contains data
 Observations:        25,544                  
    Variables:           153                  
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable label
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
statefips       byte    %8.0g                 STATEFIPS
state           str2    %9s                   STATE
countyfips      int     %8.0g                 COUNTYFIPS
countyname      str24   %24s                  COUNTYNAME
agi_stub        byte    %8.0g                 
n1              long    %12.0g                N1
mars1           long    %12.0g                
mars2           long    %12.0g                MARS2
mars4           long    %12.0g                MARS4
elf             long    %12.0g                ELF
cprep           long    %12.0g                CPREP
prep            long    %12.0g                PREP
dir_dep         long    %12.0g                DIR_DEP
n2              long    %12.0g                N2
total_vita      long    %12.0g                TOTAL_VITA
vita            long    %12.0g                VITA
tce             int     %8.0g                 TCE
vita_eic        int     %8.0g                 VITA_EIC
rac             long    %12.0g                RAC
elderly         long    %12.0g                ELDERLY
a00100          long    %12.0g                A00100
n02650          long    %12.0g                N02650
a02650          float   %9.0g                 A02650
n00200          long    %12.0g                N00200
a00200          long    %12.0g                A00200
n00300          long    %12.0g                N00300
a00300          long    %12.0g                A00300
n00600          long    %12.0g                N00600
a00600          long    %12.0g                A00600
n00650          long    %12.0g                N00650
a00650          long    %12.0g                A00650
n00700          long    %12.0g                N00700
a00700          long    %12.0g                A00700
n00900          long    %12.0g                N00900
a00900          long    %12.0g                A00900
n01000          long    %12.0g                N01000
a01000          long    %12.0g                A01000
n01400          long    %12.0g                N01400
a01400          long    %12.0g                A01400
n01700          long    %12.0g                N01700
a01700          long    %12.0g                A01700
schf            long    %8.0g                 SCHF
n02300          long    %12.0g                N02300
a02300          long    %12.0g                A02300
n02500          long    %12.0g                N02500
a02500          long    %12.0g                A02500
n26270          long    %12.0g                N26270
a26270          long    %12.0g                A26270
n02900          long    %12.0g                N02900
a02900          long    %12.0g                A02900
n03220          long    %12.0g                N03220
a03220          long    %12.0g                A03220
n03300          long    %12.0g                N03300
a03300          long    %12.0g                A03300
n03270          long    %12.0g                N03270
a03270          long    %12.0g                A03270
n03150          long    %12.0g                N03150
a03150          long    %12.0g                A03150
n03210          long    %12.0g                N03210
a03210          long    %12.0g                A03210
n04450          long    %12.0g                N04450
a04450          long    %12.0g                A04450
n04100          long    %12.0g                N04100
a04100          long    %12.0g                A04100
n04200          long    %12.0g                N04200
a04200          long    %12.0g                A04200
n04470          long    %12.0g                N04470
a04470          long    %12.0g                A04470
a00101          long    %12.0g                A00101
n17000          long    %12.0g                N17000
a17000          long    %12.0g                A17000
n18425          long    %12.0g                N18425
a18425          long    %12.0g                A18425
n18450          long    %12.0g                N18450
a18450          long    %12.0g                A18450
n18500          long    %12.0g                N18500
a18500          long    %12.0g                A18500
n18800          long    %12.0g                N18800
a18800          long    %12.0g                A18800
n18460          long    %12.0g                N18460
a18460          long    %12.0g                A18460
n18300          long    %12.0g                N18300
a18300          long    %12.0g                A18300
n19300          long    %12.0g                N19300
a19300          long    %12.0g                A19300
n19500          long    %12.0g                N19500
a19500          long    %12.0g                A19500
n19530          long    %12.0g                N19530
a19530          long    %12.0g                A19530
n19570          long    %12.0g                N19570
a19570          long    %12.0g                A19570
n19700          long    %12.0g                N19700
a19700          long    %12.0g                A19700
n20950          long    %12.0g                N20950
a20950          long    %12.0g                A20950
n04475          long    %12.0g                N04475
a04475          long    %12.0g                A04475
n04800          long    %12.0g                N04800
a04800          long    %12.0g                A04800
n05800          long    %12.0g                N05800
a05800          long    %12.0g                A05800
n09600          int     %8.0g                 N09600
a09600          long    %12.0g                A09600
n05780          long    %12.0g                N05780
a05780          long    %12.0g                A05780
n07100          long    %12.0g                N07100
a07100          long    %12.0g                A07100
n07300          long    %12.0g                N07300
a07300          long    %12.0g                A07300
n07180          long    %12.0g                N07180
a07180          long    %12.0g                A07180
n07230          long    %12.0g                N07230
a07230          long    %12.0g                A07230
n07240          long    %12.0g                N07240
a07240          long    %12.0g                A07240
n07225          long    %12.0g                N07225
a07225          long    %12.0g                A07225
n07260          long    %12.0g                N07260
a07260          long    %12.0g                A07260
n09400          long    %12.0g                N09400
a09400          long    %12.0g                A09400
n85770          long    %12.0g                N85770
a85770          long    %12.0g                A85770
n85775          long    %12.0g                N85775
a85775          long    %12.0g                A85775
n10600          long    %12.0g                N10600
a10600          long    %12.0g                A10600
n59660          long    %12.0g                N59660
a59660          long    %12.0g                A59660
n59720          long    %12.0g                N59720
a59720          long    %12.0g                A59720
n11070          long    %12.0g                N11070
a11070          long    %12.0g                A11070
n10960          long    %12.0g                N10960
a10960          long    %12.0g                A10960
n11560          long    %12.0g                N11560
a11560          long    %12.0g                A11560
n06500          long    %12.0g                N06500
a06500          long    %12.0g                A06500
n10300          long    %12.0g                N10300
a10300          long    %12.0g                A10300
n85530          long    %12.0g                N85530
a85530          long    %12.0g                A85530
n85300          long    %12.0g                N85300
a85300          long    %12.0g                A85300
n11901          long    %12.0g                N11901
a11901          long    %12.0g                A11901
n11900          long    %12.0g                N11900
a11900          long    %12.0g                A11900
n11902          long    %12.0g                N11902
a11902          long    %12.0g                A11902
n12000          long    %12.0g                N12000
a12000          long    %12.0g                A12000
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
variable agi was long now double
(25,363 real changes made)
(25,363 real changes made)
variable a_wage was long now double
(24,724 real changes made)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/irs_county_all_19.dta saved
(encoding automatically selected: ISO-8859-1)
(166 vars, 25,545 obs)

Contains data
 Observations:        25,545                  
    Variables:           166                  
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable label
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
statefips       byte    %8.0g                 STATEFIPS
state           str2    %9s                   STATE
countyfips      int     %8.0g                 COUNTYFIPS
countyname      str20   %20s                  COUNTYNAME
agi_stub        byte    %8.0g                 
n1              long    %12.0g                N1
mars1           long    %12.0g                
mars2           long    %12.0g                MARS2
mars4           long    %12.0g                MARS4
elf             long    %12.0g                ELF
cprep           long    %8.0g                 CPREP
prep            long    %12.0g                PREP
dir_dep         long    %12.0g                DIR_DEP
vrtcrind        long    %8.0g                 VRTCRIND
n2              long    %12.0g                N2
total_vita      long    %8.0g                 TOTAL_VITA
vita            long    %8.0g                 VITA
tce             int     %8.0g                 TCE
vita_eic        int     %8.0g                 VITA_EIC
rac             long    %12.0g                RAC
elderly         long    %12.0g                ELDERLY
a00100          long    %12.0g                A00100
n02650          long    %12.0g                N02650
a02650          float   %9.0g                 A02650
n00200          long    %12.0g                N00200
a00200          long    %12.0g                A00200
n00300          long    %12.0g                N00300
a00300          long    %12.0g                A00300
n00600          long    %12.0g                N00600
a00600          long    %12.0g                A00600
n00650          long    %12.0g                N00650
a00650          long    %12.0g                A00650
n00700          long    %12.0g                N00700
a00700          long    %12.0g                A00700
n00900          long    %12.0g                N00900
a00900          long    %12.0g                A00900
n01000          long    %12.0g                N01000
a01000          long    %12.0g                A01000
n01400          long    %12.0g                N01400
a01400          long    %12.0g                A01400
n01700          long    %12.0g                N01700
a01700          long    %12.0g                A01700
schf            float   %9.0g                 SCHF
n02300          long    %12.0g                N02300
a02300          long    %12.0g                A02300
n02500          long    %12.0g                N02500
a02500          long    %12.0g                A02500
n26270          long    %12.0g                N26270
a26270          long    %12.0g                A26270
n02900          long    %12.0g                N02900
a02900          long    %12.0g                A02900
n03220          long    %12.0g                N03220
a03220          long    %8.0g                 A03220
n03300          long    %8.0g                 N03300
a03300          long    %12.0g                A03300
n03270          long    %8.0g                 N03270
a03270          long    %12.0g                A03270
n03150          long    %8.0g                 N03150
a03150          long    %12.0g                A03150
n03210          long    %12.0g                N03210
a03210          long    %12.0g                A03210
n02910          long    %12.0g                N02910
a02910          long    %12.0g                A02910
n04450          long    %12.0g                N04450
a04450          long    %12.0g                A04450
n04100          long    %12.0g                N04100
a04100          long    %12.0g                A04100
n04200          long    %12.0g                N04200
a04200          long    %12.0g                A04200
n04470          long    %12.0g                N04470
a04470          long    %12.0g                A04470
a00101          long    %12.0g                A00101
n17000          long    %8.0g                 N17000
a17000          long    %12.0g                A17000
n18425          long    %12.0g                N18425
a18425          long    %12.0g                A18425
n18450          long    %8.0g                 N18450
a18450          long    %8.0g                 A18450
n18500          long    %12.0g                N18500
a18500          long    %12.0g                A18500
n18800          long    %12.0g                N18800
a18800          long    %8.0g                 A18800
n18460          long    %12.0g                N18460
a18460          long    %12.0g                A18460
n18300          long    %12.0g                N18300
a18300          long    %12.0g                A18300
n19300          long    %12.0g                N19300
a19300          long    %12.0g                A19300
n19500          int     %8.0g                 N19500
a19500          long    %8.0g                 A19500
n19530          long    %8.0g                 N19530
a19530          long    %8.0g                 A19530
n19550          long    %8.0g                 N19550
a19550          long    %8.0g                 A19550
n19570          long    %8.0g                 N19570
a19570          long    %12.0g                A19570
n19700          long    %12.0g                N19700
a19700          long    %12.0g                A19700
n20950          long    %8.0g                 N20950
a20950          long    %12.0g                A20950
n04475          long    %12.0g                N04475
a04475          long    %12.0g                A04475
n04800          long    %12.0g                N04800
a04800          long    %12.0g                A04800
n05800          long    %12.0g                N05800
a05800          long    %12.0g                A05800
n09600          int     %8.0g                 N09600
a09600          long    %8.0g                 A09600
n05780          long    %8.0g                 N05780
a05780          long    %8.0g                 A05780
n07100          long    %12.0g                N07100
a07100          long    %12.0g                A07100
n07300          long    %12.0g                N07300
a07300          long    %12.0g                A07300
n07180          long    %12.0g                N07180
a07180          long    %8.0g                 A07180
n07230          long    %12.0g                N07230
a07230          long    %12.0g                A07230
n07240          long    %12.0g                N07240
a07240          long    %12.0g                A07240
n07225          long    %12.0g                N07225
a07225          long    %12.0g                A07225
n07260          long    %8.0g                 N07260
a07260          long    %8.0g                 A07260
n09400          long    %12.0g                N09400
a09400          long    %12.0g                A09400
n85770          long    %8.0g                 N85770
a85770          long    %12.0g                A85770
n85775          long    %8.0g                 N85775
a85775          long    %12.0g                A85775
n10600          long    %12.0g                N10600
a10600          long    %12.0g                A10600
n59660          long    %12.0g                N59660
a59660          long    %12.0g                A59660
n59720          long    %12.0g                N59720
a59720          long    %12.0g                A59720
n11070          long    %12.0g                N11070
a11070          long    %12.0g                A11070
n10960          long    %12.0g                N10960
a10960          long    %12.0g                A10960
n11560          long    %8.0g                 N11560
a11560          long    %8.0g                 A11560
n11450          long    %8.0g                 N11450
a11450          long    %8.0g                 A11450
n10970          long    %12.0g                N10970
a10970          long    %12.0g                A10970
n10971          long    %12.0g                N10971
a10971          long    %12.0g                A10971
n10973          long    %12.0g                N10973
a10973          long    %12.0g                A10973
n06500          long    %12.0g                N06500
a06500          long    %12.0g                A06500
n10300          long    %12.0g                N10300
a10300          long    %12.0g                A10300
n85530          long    %12.0g                N85530
a85530          long    %12.0g                A85530
n85300          long    %12.0g                N85300
a85300          long    %12.0g                A85300
n11901          long    %12.0g                N11901
a11901          long    %12.0g                A11901
n11900          long    %12.0g                N11900
a11900          long    %12.0g                A11900
n11902          long    %12.0g                N11902
a11902          long    %12.0g                A11902
n12000          long    %12.0g                N12000
a12000          long    %12.0g                A12000
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
variable agi was long now double
(25,410 real changes made)
(25,410 real changes made)
variable a_wage was long now double
(24,896 real changes made)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/irs_county_all_20.dta saved
(encoding automatically selected: ISO-8859-1)
(168 vars, 25,552 obs)

Contains data
 Observations:        25,552                  
    Variables:           168                  
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable label
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
statefips       byte    %8.0g                 STATEFIPS
state           str2    %9s                   STATE
countyfips      int     %8.0g                 COUNTYFIPS
countyname      str20   %20s                  COUNTYNAME
agi_stub        byte    %8.0g                 
n1              long    %12.0g                N1
mars1           long    %12.0g                
mars2           long    %12.0g                MARS2
mars4           long    %12.0g                MARS4
elf             long    %12.0g                ELF
cprep           long    %12.0g                CPREP
prep            long    %12.0g                PREP
dir_dep         long    %12.0g                DIR_DEP
vrtcrind        long    %12.0g                VRTCRIND
n2              long    %12.0g                N2
total_vita      long    %8.0g                 TOTAL_VITA
vita            long    %8.0g                 VITA
tce             int     %8.0g                 TCE
vita_eic        int     %8.0g                 VITA_EIC
rac             long    %12.0g                RAC
elderly         long    %12.0g                ELDERLY
a00100          long    %12.0g                A00100
n02650          long    %12.0g                N02650
a02650          float   %9.0g                 A02650
n00200          long    %12.0g                N00200
a00200          long    %12.0g                A00200
n00300          long    %12.0g                N00300
a00300          long    %12.0g                A00300
n00600          long    %12.0g                N00600
a00600          long    %12.0g                A00600
n00650          long    %12.0g                N00650
a00650          long    %12.0g                A00650
n00700          long    %12.0g                N00700
a00700          long    %12.0g                A00700
n00900          long    %12.0g                N00900
a00900          long    %12.0g                A00900
n01000          long    %12.0g                N01000
a01000          long    %12.0g                A01000
n01400          long    %12.0g                N01400
a01400          long    %12.0g                A01400
n01700          long    %12.0g                N01700
a01700          long    %12.0g                A01700
schf            float   %9.0g                 SCHF
n02300          long    %12.0g                N02300
a02300          long    %12.0g                A02300
n02500          long    %12.0g                N02500
a02500          long    %12.0g                A02500
n26270          long    %12.0g                N26270
a26270          long    %12.0g                A26270
n02900          long    %12.0g                N02900
a02900          long    %12.0g                A02900
n03220          long    %12.0g                N03220
a03220          long    %8.0g                 A03220
n03300          long    %8.0g                 N03300
a03300          long    %12.0g                A03300
n03270          long    %8.0g                 N03270
a03270          long    %12.0g                A03270
n03150          long    %8.0g                 N03150
a03150          long    %12.0g                A03150
n03210          long    %12.0g                N03210
a03210          long    %12.0g                A03210
n02910          long    %12.0g                N02910
a02910          long    %12.0g                A02910
n04450          long    %12.0g                N04450
a04450          long    %12.0g                A04450
n04100          long    %12.0g                N04100
a04100          long    %12.0g                A04100
n04200          long    %12.0g                N04200
a04200          long    %12.0g                A04200
n04470          long    %12.0g                N04470
a04470          long    %12.0g                A04470
a00101          long    %12.0g                A00101
n17000          long    %8.0g                 N17000
a17000          long    %12.0g                A17000
n18425          long    %12.0g                N18425
a18425          long    %12.0g                A18425
n18450          long    %8.0g                 N18450
a18450          long    %8.0g                 A18450
n18500          long    %12.0g                N18500
a18500          long    %12.0g                A18500
n18800          long    %8.0g                 N18800
a18800          long    %8.0g                 A18800
n18460          long    %12.0g                N18460
a18460          long    %12.0g                A18460
n18300          long    %12.0g                N18300
a18300          long    %12.0g                A18300
n19300          long    %12.0g                N19300
a19300          long    %12.0g                A19300
n19500          int     %8.0g                 N19500
a19500          long    %8.0g                 A19500
n19530          long    %8.0g                 N19530
a19530          long    %8.0g                 A19530
n19550          long    %8.0g                 N19550
a19550          long    %8.0g                 A19550
n19570          long    %8.0g                 N19570
a19570          long    %12.0g                A19570
n19700          long    %12.0g                N19700
a19700          long    %12.0g                A19700
n20950          long    %8.0g                 N20950
a20950          long    %12.0g                A20950
n04475          long    %12.0g                N04475
a04475          long    %12.0g                A04475
n04800          long    %12.0g                N04800
a04800          long    %12.0g                A04800
n05800          long    %12.0g                N05800
a05800          long    %12.0g                A05800
n09600          long    %8.0g                 N09600
a09600          long    %12.0g                A09600
n05780          long    %8.0g                 N05780
a05780          long    %8.0g                 A05780
n07100          long    %12.0g                N07100
a07100          long    %12.0g                A07100
n07300          long    %12.0g                N07300
a07300          long    %12.0g                A07300
n07180          int     %8.0g                 N07180
a07180          long    %8.0g                 A07180
n07230          long    %12.0g                N07230
a07230          long    %12.0g                A07230
n07240          long    %12.0g                N07240
a07240          long    %12.0g                A07240
n07225          long    %12.0g                N07225
a07225          long    %12.0g                A07225
n07260          long    %8.0g                 N07260
a07260          long    %8.0g                 A07260
n09400          long    %12.0g                N09400
a09400          long    %12.0g                A09400
n85770          long    %12.0g                N85770
a85770          long    %12.0g                A85770
n85775          long    %12.0g                N85775
a85775          long    %12.0g                A85775
n10600          long    %12.0g                N10600
a10600          long    %12.0g                A10600
n59660          long    %12.0g                N59660
a59660          long    %12.0g                A59660
n59720          long    %12.0g                N59720
a59720          long    %12.0g                A59720
n11070          long    %12.0g                N11070
a11070          long    %12.0g                A11070
n10960          long    %12.0g                N10960
a10960          long    %12.0g                A10960
n11560          long    %8.0g                 N11560
a11560          long    %8.0g                 A11560
n11450          long    %8.0g                 N11450
a11450          long    %12.0g                A11450
n11520          long    %12.0g                N11520
a11520          long    %12.0g                A11520
n11530          long    %8.0g                 N11530
a11530          long    %12.0g                A11530
n10970          long    %12.0g                N10970
a10970          long    %12.0g                A10970
n10971          long    %12.0g                N10971
a10971          long    %12.0g                A10971
n06500          long    %12.0g                N06500
a06500          long    %12.0g                A06500
n10300          long    %12.0g                N10300
a10300          long    %12.0g                A10300
n85530          long    %12.0g                N85530
a85530          long    %12.0g                A85530
n85300          long    %12.0g                N85300
a85300          long    %12.0g                A85300
n11901          long    %12.0g                N11901
a11901          long    %12.0g                A11901
n11900          long    %12.0g                N11900
a11900          long    %12.0g                A11900
n11902          long    %12.0g                N11902
a11902          long    %12.0g                A11902
n12000          long    %12.0g                N12000
a12000          long    %12.0g                A12000
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
variable agi was long now double
(25,456 real changes made)
(25,456 real changes made)
variable a_wage was long now double
(24,659 real changes made)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/irs_county_all_21.dta saved
(encoding automatically selected: ISO-8859-1)
(166 vars, 25,552 obs)

Contains data
 Observations:        25,552                  
    Variables:           166                  
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Variable      Storage   Display    Value
    name         type    format    label      Variable label
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
statefips       byte    %8.0g                 STATEFIPS
state           str2    %9s                   STATE
countyfips      int     %8.0g                 COUNTYFIPS
countyname      str20   %20s                  COUNTYNAME
agi_stub        byte    %8.0g                 
n1              long    %12.0g                N1
mars1           long    %12.0g                
mars2           long    %12.0g                MARS2
mars4           long    %12.0g                MARS4
elf             long    %12.0g                ELF
cprep           long    %8.0g                 CPREP
prep            long    %12.0g                PREP
dir_dep         long    %12.0g                DIR_DEP
vrtcrind        long    %8.0g                 VRTCRIND
n2              long    %12.0g                N2
total_vita      long    %8.0g                 TOTAL_VITA
vita            long    %8.0g                 VITA
tce             int     %8.0g                 TCE
vita_eic        int     %8.0g                 VITA_EIC
rac             long    %12.0g                RAC
elderly         long    %12.0g                ELDERLY
a00100          long    %12.0g                A00100
n02650          long    %12.0g                N02650
a02650          long    %12.0g                A02650
n00200          long    %12.0g                N00200
a00200          long    %12.0g                A00200
n00300          long    %12.0g                N00300
a00300          long    %12.0g                A00300
n00400          long    %8.0g                 N00400
a00400          long    %12.0g                A00400
n00600          long    %12.0g                N00600
a00600          long    %12.0g                A00600
n00650          long    %12.0g                N00650
a00650          long    %12.0g                A00650
n00700          long    %8.0g                 N00700
a00700          long    %8.0g                 A00700
n00900          long    %12.0g                N00900
a00900          long    %12.0g                A00900
n01000          long    %12.0g                N01000
a01000          long    %12.0g                A01000
n01400          long    %12.0g                N01400
a01400          long    %12.0g                A01400
n01700          long    %12.0g                N01700
a01700          long    %12.0g                A01700
schf            long    %8.0g                 SCHF
n02300          long    %8.0g                 N02300
a02300          long    %12.0g                A02300
n02500          long    %12.0g                N02500
a02500          long    %12.0g                A02500
n26270          long    %12.0g                N26270
a26270          long    %12.0g                A26270
n25870          long    %8.0g                 N25870
a25870          long    %12.0g                A25870
n02900          long    %12.0g                N02900
a02900          long    %12.0g                A02900
n03220          long    %8.0g                 N03220
a03220          long    %8.0g                 A03220
n03300          long    %8.0g                 N03300
a03300          long    %12.0g                A03300
n03270          long    %8.0g                 N03270
a03270          long    %12.0g                A03270
n03150          long    %8.0g                 N03150
a03150          long    %12.0g                A03150
n03210          long    %8.0g                 N03210
a03210          long    %8.0g                 A03210
n04450          long    %12.0g                N04450
a04450          long    %12.0g                A04450
n04100          long    %12.0g                N04100
a04100          long    %12.0g                A04100
n04200          long    %12.0g                N04200
a04200          long    %12.0g                A04200
n04470          long    %12.0g                N04470
a04470          long    %12.0g                A04470
a00101          long    %12.0g                A00101
n17000          long    %8.0g                 N17000
a17000          long    %12.0g                A17000
n18425          long    %12.0g                N18425
a18425          long    %12.0g                A18425
n18450          long    %8.0g                 N18450
a18450          long    %8.0g                 A18450
n18500          long    %12.0g                N18500
a18500          long    %12.0g                A18500
n18800          long    %12.0g                N18800
a18800          long    %8.0g                 A18800
n18460          long    %12.0g                N18460
a18460          long    %12.0g                A18460
n18300          long    %12.0g                N18300
a18300          long    %12.0g                A18300
n19300          long    %12.0g                N19300
a19300          long    %12.0g                A19300
n19500          int     %8.0g                 N19500
a19500          long    %8.0g                 A19500
n19530          long    %8.0g                 N19530
a19530          long    %8.0g                 A19530
n19570          long    %8.0g                 N19570
a19570          long    %12.0g                A19570
n19700          long    %12.0g                N19700
a19700          long    %12.0g                A19700
n20950          long    %8.0g                 N20950
a20950          long    %12.0g                A20950
n04475          long    %12.0g                N04475
a04475          long    %12.0g                A04475
n04800          long    %12.0g                N04800
a04800          long    %12.0g                A04800
n05800          long    %12.0g                N05800
a05800          long    %12.0g                A05800
n09600          int     %8.0g                 N09600
a09600          long    %8.0g                 A09600
n05780          long    %8.0g                 N05780
a05780          long    %8.0g                 A05780
n07100          long    %12.0g                N07100
a07100          long    %12.0g                A07100
n07300          long    %8.0g                 N07300
a07300          long    %12.0g                A07300
n07180          long    %8.0g                 N07180
a07180          long    %8.0g                 A07180
n07230          long    %12.0g                N07230
a07230          long    %12.0g                A07230
n07240          long    %12.0g                N07240
a07240          long    %8.0g                 A07240
n07225          long    %12.0g                N07225
a07225          long    %12.0g                A07225
n07260          long    %8.0g                 N07260
a07260          long    %8.0g                 A07260
n09400          long    %12.0g                N09400
a09400          long    %12.0g                A09400
n85770          long    %12.0g                N85770
a85770          long    %12.0g                A85770
n85775          long    %12.0g                N85775
a85775          long    %12.0g                A85775
n10600          long    %12.0g                N10600
a10600          long    %12.0g                A10600
n59660          long    %12.0g                N59660
a59660          long    %12.0g                A59660
n59661          long    %12.0g                N59661
a59661          long    %8.0g                 A59661
n59662          long    %12.0g                N59662
a59662          long    %12.0g                A59662
n59663          long    %12.0g                N59663
a59663          long    %12.0g                A59663
n59664          long    %8.0g                 N59664
a59664          long    %12.0g                A59664
n59720          long    %12.0g                N59720
a59720          long    %12.0g                A59720
n11070          long    %12.0g                N11070
a11070          long    %12.0g                A11070
n10960          long    %8.0g                 N10960
a10960          long    %8.0g                 A10960
n11560          long    %8.0g                 N11560
a11560          long    %8.0g                 A11560
n06500          long    %12.0g                N06500
a06500          long    %12.0g                A06500
n10300          long    %12.0g                N10300
a10300          long    %12.0g                A10300
n85530          long    %12.0g                N85530
a85530          long    %12.0g                A85530
n85300          long    %12.0g                N85300
a85300          long    %12.0g                A85300
n11901          long    %12.0g                N11901
a11901          long    %12.0g                A11901
n11900          long    %12.0g                N11900
a11900          long    %12.0g                A11900
n11902          long    %12.0g                N11902
a11902          long    %12.0g                A11902
n12000          long    %8.0g                 N12000
a12000          long    %12.0g                A12000
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.
variable agi was long now double
(25,400 real changes made)
variable a_total_inc was long now double
(25,400 real changes made)
variable a_wage was long now double
(24,693 real changes made)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/irs_county_all_22.dta saved

. 
. ** Append data 
. 
. ** Loop over years 
. forvalues y = 15(1)22 {
  2. 
.         ** Append 
.         append using "${data}working/irs_county_all_`y'"
  3.                 
.         } // END YEAR LOOP 
(variable county_name was str20, now str24 to accommodate using data's values)

.         
. ** Save file 
. save "${data}working/irs_county_all", replace 
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/irs_county_all.dta saved

.         
. ** Generate fips variable
. make_fips state_fips county_fips, gen(fips)

. 
. ** Save file 
. save "${data}working/irs_county_all", replace 
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/irs_county_all.dta saved

. 
. ********************************************************************************
. ** STEP 7: Import and Clean DOL Childcare Cost Data 
. ********************************************************************************
. 
. ** Import data 
. import excel using "${data}demographic/dol/NDCP2022.xlsx", firstrow case(lower) clear
(370 vars, 48,308 obs)

. 
. ** Drop if not in 50 states + DC 
. drop if state_fips == 72
(1,170 observations deleted)

. 
. ** Keep in year range 
. keep if inrange(studyyear, 2015, 2022)
(21,999 observations deleted)

. 
. ** Keep required variables 
. keep county_fips_code studyyear me      ///
>         mcinfant mctoddler mcpreschool  ///
>         mfccinfant mfcctoddler mfccpreschool

.         
. rename county_fips fips 

. rename studyyear year 

. 
. ** Fill-in missing variables 
. xtset fips year 

Panel variable: fips (unbalanced)
 Time variable: year, 2015 to 2022
         Delta: 1 unit

. tsfill, full

. 
. ** Interpotate
. foreach var of varlist me mc* mf* {
  2.         bys fips: ipolate `var' year, g(tmp1)
  3.         replace `var' = tmp1 if missing(`var')
  4.         drop tmp1
  5. } // END VAR LOOP 
(13 missing values generated)
(0 real changes made)
(2857 missing values generated)
(752 real changes made)
(2840 missing values generated)
(748 real changes made)
(2823 missing values generated)
(749 real changes made)
(3280 missing values generated)
(743 real changes made)
(3287 missing values generated)
(743 real changes made)
(3275 missing values generated)
(743 real changes made)

. 
. ** Generate value as a percent of median income 
. gen mc_infant_med = mcinfant / me 
(2,857 missing values generated)

. gen mc_toddler_med = mctoddler / me 
(2,840 missing values generated)

. gen mc_preschool_med = mcpreschool / me 
(2,823 missing values generated)

. gen mf_infant_med = mfccinfant / me 
(3,280 missing values generated)

. gen mf_toddler_med = mfcctoddler / me 
(3,287 missing values generated)

. gen mf_preschool_med = mfccpreschool / me 
(3,275 missing values generated)

. 
. ** Drop unnecc. variables 
. drop me mcinfant mctoddler mcpreschool mfcc* 

. 
. ** Inflate forwards by two years, by county and variable 
. local ct = ${end_year_acs} - 2022 + 1 

. expand `ct' if year == 2022
(6,288 observations created)

. by fips year, sort: replace year = year + _n - 1 if year == 2022 & _n > 1
(6,288 real changes made)

. 
. ** Get list of all counties 
. qui levelsof fips, local(fips)

. 
. ** Loop over variables
. foreach v of varlist mc_* mf_* {
  2.         
.         ** Replace 2023 + 2024 values with missings 
.     replace `v' = . if year > 2022
  3.         
.         ** Loop over all FIPS 
.     foreach c of local fips {
  4.                 
.                 quietly{
  5.                         
.                         ** Run if not missing too many observations 
.                         count if !missing(`v') & fips == `c' 
  6.                         if `r(N)' > 3 {
  7.                                 regress `v' year if fips == `c'
  8.                                 predict `v'_hat
  9.                                 replace `v' = `v'_hat if fips == `c' & year > 2022
 10.                                 drop `v'_hat
 11.                         } // END IF-STATEMENT
 12.                         else drop if fips == `c'
 13.                 } // END QUIET
 14.     } // END FIPS LOOP 
 15. } // END VAR LOOP 
(5,322 real changes made, 5,322 to missing)
(5,310 real changes made, 5,310 to missing)
(5,324 real changes made, 5,324 to missing)
(5,152 real changes made, 5,152 to missing)
(5,140 real changes made, 5,140 to missing)
(5,152 real changes made, 5,152 to missing)

. 
. ** Save file
. save "${data}working/dol_childcare", replace
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/dol_childcare.dta saved

. 
. 
. ********************************************************************************
. ** STEP 8: Calculate County-Level Property Tax Rates from ACS Data
. ********************************************************************************
. 
. ** Load ACS migration file (contains proptx99, valueh, qprotx99, qvalueh)
. use "${data}working/acs_migration_file", clear

. 
. ** Keep household heads only (relate == 1 for household reference person)
. keep if relate == 1
(11,523,232 observations deleted)

. 
. ** Generate FIPS code for destination county
. gen fips = fips_d

. 
. ** Drop if missing FIPS
. drop if missing(fips)
(0 observations deleted)

. 
. ** Drop observations where PROPTX99 == 0 (N/A - not applicable)
. drop if proptx99 == 0
(3,538,913 observations deleted)

. 
. ** Convert PROPTX99 codes to dollar midpoint values
. ** Based on IPUMS coding scheme: https://usa.ipums.org/usa-action/variables/PROPTX99#codes_section
. gen proptx_dollars = .
(8,952,892 missing values generated)

. 
. ** Code 1: None (0)
. replace proptx_dollars = 0 if proptx99 == 1
(419,640 real changes made)

. 
. ** Code 2: $1-49 -> midpoint $25
. replace proptx_dollars = 25 if proptx99 == 2
(66,151 real changes made)

. 
. ** Codes 3-12: $50-99, $100-149, ... $500-549 (increments of 50, midpoints)
. forvalues i = 3/12 {
  2.     local lower = (`i' - 3) * 50 + 50
  3.     local upper = `lower' + 49
  4.     local midpoint = (`lower' + `upper') / 2
  5.     replace proptx_dollars = `midpoint' if proptx99 == `i'
  6. }
(61,747 real changes made)
(68,476 real changes made)
(59,441 real changes made)
(77,852 real changes made)
(62,086 real changes made)
(95,651 real changes made)
(71,811 real changes made)
(99,356 real changes made)
(67,217 real changes made)
(125,470 real changes made)

. 
. ** Codes 13-22: $550-599, $600-699, ... $1000-1099 (transitioning to $100 increments)
. replace proptx_dollars = 575 if proptx99 == 13
(58,866 real changes made)

. replace proptx_dollars = 650 if proptx99 == 14
(133,020 real changes made)

. replace proptx_dollars = 750 if proptx99 == 15
(66,547 real changes made)

. replace proptx_dollars = 850 if proptx99 == 16
(110,304 real changes made)

. replace proptx_dollars = 950 if proptx99 == 17
(65,921 real changes made)

. replace proptx_dollars = 1050 if proptx99 == 18
(144,998 real changes made)

. replace proptx_dollars = 1150 if proptx99 == 19
(61,433 real changes made)

. replace proptx_dollars = 1250 if proptx99 == 20
(116,654 real changes made)

. replace proptx_dollars = 1350 if proptx99 == 21
(59,011 real changes made)

. replace proptx_dollars = 1450 if proptx99 == 22
(226,521 real changes made)

. 
. ** Codes 23+: Higher ranges with $100 increments then $500/$1000 at top
. ** $1500-1599, $1600-1699, ... up to high values
. forvalues i = 23/62 {
  2.     local lower = (`i' - 23) * 100 + 1500
  3.     local upper = `lower' + 99
  4.     local midpoint = (`lower' + `upper') / 2
  5.     replace proptx_dollars = `midpoint' if proptx99 == `i'
  6. }
(131,332 real changes made)
(336,659 real changes made)
(165,059 real changes made)
(163,982 real changes made)
(243,773 real changes made)
(153,651 real changes made)
(127,376 real changes made)
(187,760 real changes made)
(101,576 real changes made)
(318,173 real changes made)
(89,835 real changes made)
(125,362 real changes made)
(101,814 real changes made)
(139,349 real changes made)
(222,116 real changes made)
(94,845 real changes made)
(77,048 real changes made)
(106,250 real changes made)
(54,428 real changes made)
(300,072 real changes made)
(46,524 real changes made)
(98,363 real changes made)
(57,043 real changes made)
(61,714 real changes made)
(164,160 real changes made)
(88,141 real changes made)
(48,743 real changes made)
(73,708 real changes made)
(37,840 real changes made)
(242,752 real changes made)
(30,279 real changes made)
(59,165 real changes made)
(37,313 real changes made)
(36,840 real changes made)
(0 real changes made)
(114,171 real changes made)
(35,379 real changes made)
(27,958 real changes made)
(54,035 real changes made)
(23,313 real changes made)

. 
. ** Codes 63+: Higher brackets ($5500+)
. replace proptx_dollars = 5750 if proptx99 == 63
(326,858 real changes made)

. replace proptx_dollars = 6250 if proptx99 == 64
(157,452 real changes made)

. replace proptx_dollars = 6750 if proptx99 == 65
(386,770 real changes made)

. replace proptx_dollars = 7250 if proptx99 == 66
(248,309 real changes made)

. replace proptx_dollars = 7750 if proptx99 == 67
(209,153 real changes made)

. replace proptx_dollars = 8500 if proptx99 == 68
(133,804 real changes made)

. replace proptx_dollars = 9500 if proptx99 == 69
(221,304 real changes made)

. 
. ** For codes 70+: Use approximate midpoints for higher brackets
. ** These are $10000+ ranges
. forvalues i = 70/100 {
  2.     if proptx_dollars == . & proptx99 == `i' {
  3.         local midpoint = 10000 + (`i' - 70) * 1000
  4.         replace proptx_dollars = `midpoint' if proptx99 == `i'
  5.     }
  6. }

. 
. ** Top codes (very high property taxes)
. replace proptx_dollars = 75000 if proptx99 >= 140 & proptx99 < 159
(0 real changes made)

. replace proptx_dollars = 100000 if proptx99 == 159
(0 real changes made)

. 
. ** Label variable
. label var proptx_dollars "Property tax ($ midpoint from PROPTX99 codes)"

. 
. ** Drop if property tax could not be assigned or home value is missing/zero
. drop if missing(proptx_dollars)
(373,168 observations deleted)

. drop if missing(valueh) | valueh == 0 | valueh == 9999999
(0 observations deleted)

. 
. ** Calculate property tax rate (as percentage of home value)
. gen prop_rate = 100 * proptx_dollars / valueh

. label var prop_rate "Property tax rate (% of home value)"

. 
. ** ============================================================================
. ** VERSION 1: Overall (all observations)
. ** ============================================================================
. preserve

. 
. ** Collapse to county X year, weighted by household weight
. collapse (mean) prop_rate_mean = prop_rate ///
>          (semean) prop_rate_se = prop_rate ///
>          (count) prop_rate_n = prop_rate ///
>          [fw = hhwt], by(year fips)

. 
. ** Label variables
. label var prop_rate_mean "Mean property tax rate (% of home value)"

. label var prop_rate_se "SE of property tax rate"

. label var prop_rate_n "Number of observations"

. 
. ** Generate state and county FIPS
. gen state_fips = floor(fips / 1000)

. gen county_fips = mod(fips, 1000)

. 
. ** Merge with county names
. merge m:1 state_fips county_fips using "${data}working/ids", keep(master match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                           504
        from master                       504  
        from using                          0  

    Matched                             4,321  
    -----------------------------------------

. 
. ** Handle suppressed counties (county_fips == 0): merge state names and set county to "Other"
. merge m:1 state_fips using "${data}working/state_ids", keep(master match) update nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0

    Matched                             4,321
        not updated                     4,321  
        missing updated                     0  
        nonmissing conflict                 0  
    -----------------------------------------

. replace county_name = "Other" if county_fips == 0
(0 real changes made)

. 
. ** Order variables
. order year fips state_fips county_fips state_name county_name prop_rate_mean prop_rate_se prop_rate_n

. 
. ** Sort
. sort fips year

. 
. ** Save overall version
. save "${data}working/property_tax_rates_overall", replace
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/property_tax_rates_overall.dta saved

. 
. ** Export to CSV
. export delimited using "${data}working/property_tax_rates_overall.csv", replace
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/property_tax_rates_overall.csv saved

. 
. restore

. 
. ** ============================================================================
. ** VERSION 2: Excluding allocated values (qprotx99 != 4, qvalueh != 4)
. ** ============================================================================
. 
. ** Drop observations where values are allocated (quality flag == 4)
. drop if qprotx99 == 4
(1,223,562 observations deleted)

. drop if qvalueh == 4
(319,989 observations deleted)

. 
. ** Collapse to county X year, weighted by household weight
. collapse (mean) prop_rate_mean = prop_rate ///
>          (semean) prop_rate_se = prop_rate ///
>          (count) prop_rate_n = prop_rate ///
>          [fw = hhwt], by(year fips)

. 
. ** Label variables
. label var prop_rate_mean "Mean property tax rate (% of home value, excl. allocated)"

. label var prop_rate_se "SE of property tax rate (excl. allocated)"

. label var prop_rate_n "Number of observations (excl. allocated)"

. 
. ** Generate state and county FIPS
. gen state_fips = floor(fips / 1000)

. gen county_fips = mod(fips, 1000)

. 
. ** Merge with county names
. merge m:1 state_fips county_fips using "${data}working/ids", keep(master match) nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                           504
        from master                       504  
        from using                          0  

    Matched                             4,321  
    -----------------------------------------

. 
. ** Handle suppressed counties (county_fips == 0): merge state names and set county to "Other"
. merge m:1 state_fips using "${data}working/state_ids", keep(master match) update nogen

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0

    Matched                             4,321
        not updated                     4,321  
        missing updated                     0  
        nonmissing conflict                 0  
    -----------------------------------------

. replace county_name = "Other" if county_fips == 0
(0 real changes made)

. 
. ** Order variables
. order year fips state_fips county_fips state_name county_name prop_rate_mean prop_rate_se prop_rate_n

. 
. ** Sort
. sort fips year

. 
. ** Save version excluding allocated
. save "${data}working/property_tax_rates_excl_allocated", replace
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/property_tax_rates_excl_allocated.dta saved

. 
. ** Export to CSV
. export delimited using "${data}working/property_tax_rates_excl_allocated.csv", replace
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/property_tax_rates_excl_allocated.csv saved

. 
. ** Display summary
. dis "Property tax rate calculation complete."
Property tax rate calculation complete.

. dis "Overall version saved to: ${data}working/property_tax_rates_overall.dta"
Overall version saved to: C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/property_tax_rates_overall.dta

. dis "Excluding allocated saved to: ${data}working/property_tax_rates_excl_allocated.dta"
Excluding allocated saved to: C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/property_tax_rates_excl_allocated.dta

. 
. clear

. 
. 
. ** Close log
. log close log_01
      name:  log_01
       log:  C:/Users/ji252/Documents/GitHub/multnomah-county-tax/code/logs/01_log_data_clean_multnomah_2026-02-06.log
  log type:  text
 closed on:   6 Feb 2026, 11:39:56
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

. 
end of do-file

. 
. ** ANALYSIS (02)
. 
. ** Descriptives 
. do ${code}02_descriptives.do 

. /*******************************************************************************
> File Name:              02_descriptives.do
> Creator:                John Iselin
> Date Update:    January 30, 2026
> 
> Called by: 00_multnomah.do
> 
> Purpose: Perform descriptive analysis
> 
> Outputs:
> - multnomah_flow_comparison_[n1|n2|agi].dta/csv: Pre-post flow comparison with:
>   - Raw flows (out_pre, out_post, in_pre, in_post)
>   - Multnomah baseline population (pop_pre, pop_post)
>   - Migration rates as % of Multnomah population (out_rate_*, in_rate_*)
>   - Rate changes in percentage points (out_rate_change, in_rate_change, net_rate_change)
> 
> - multnomah_partner_flows_[n1|n2|agi].dta/csv: Partner-normalized flows for maps:
>   - Out-migration rates per 100K of DESTINATION county population
>   - In-migration rates per 100K of ORIGIN county population
>   - Used by R/map_code.R to create directional flow maps
> 
> - table2.xlsx: Migration rates for Multnomah and neighboring counties
>   - Sheet "IRS": IRS-based rates (2016-19 vs 2021-22)
>   - Sheet "ACS": ACS-based rates (2016-19 vs 2021-22 vs 2021-24)
>   - Rows: Multnomah, neighboring OR/WA counties, all other OR/WA combined
>   - Rates: in-migration and out-migration as % of partner county population
>   - Change in net in-migration rate (in_rate - out_rate) from pre to post period
> 
> Authors: John Iselin
> 
> For more information, contact john.iselin@yale.edu
> 
> *******************************************************************************/
. 
. ** Start log file 
. capture log close log_02

. log using "${logs}02_log_descriptives_${date}", replace text name(log_02)
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
      name:  log_02
       log:  C:/Users/ji252/Documents/GitHub/multnomah-county-tax/code/logs/02_log_descriptives_2026-02-06.log
  log type:  text
 opened on:   6 Feb 2026, 11:39:57

. 
. ** Determine set of common in- and out-migration counties for Multnomah
. use ${data}working/irs_county_flow.dta, clear 

. 
. ** Tag Multnomah
. gen multnomah_o = (state_fips_o == 41 & county_fips_o == 51)

. gen multnomah_d = (state_fips_d == 41 & county_fips_d == 51)

. 
. ** Loop over samples 
. foreach x in "o" "d" {
  2.         
.         ** Preserve 
.         preserve 
  3.         
.         ** Keep Multnomah
.         keep if multnomah_`x' == 1 
  4.         
.         ** Export data 
.         export excel using "${data}multnomah.xlsx",     ///
>                 sheet(irs_`x', replace ) firstrow(variables) 
  5.                 
.         ** Clear and restore 
.         clear 
  6.         restore
  7.                 
. } // END ORIGIN-DESTINATION LOOP 
(361,546 observations deleted)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/multnomah.xlsx saved
(361,434 observations deleted)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/multnomah.xlsx saved

. 
. ** Determine set of common in- and out-migration counties for Multnomah
. use ${data}working/acs_county_flow.dta, clear 

. 
. ** Tag Multnomah
. gen multnomah_o = (state_fips_o == 41 & county_fips_o == 51)

. gen multnomah_d = (state_fips_d == 41 & county_fips_d == 51)

. 
. ** Loop over samples 
. foreach x in "o" "d" {
  2.         
.         ** Preserve 
.         preserve 
  3.         
.         ** Keep Multnomah
.         keep if multnomah_`x' == 1 
  4.         
.         ** Export data 
.         export excel using "${data}multnomah.xlsx",     ///
>                 sheet(acs_`x', replace ) firstrow(variables) 
  5.                 
.         ** Clear and restore 
.         clear 
  6.         restore
  7.                 
. } // END ORIGIN-DESTINATION LOOP 
(230,904 observations deleted)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/multnomah.xlsx saved
(230,847 observations deleted)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/multnomah.xlsx saved

. 
. /*******************************************************************************
> SECTION 2: PRE-POST FLOW COMPARISON (2018-2019 vs 2021-2022 / 21-24)
> *******************************************************************************/
. 
. ** IRS DATA 
. 
. ** Load gross data to get Multnomah's total population by period
. use "${data}working/irs_county_gross", clear

. 
. ** Keep only in sample 
. keep if inlist(state_name, "Oregon", "Washington")
(21,455 observations deleted)

. keep if inlist(year, 2018, 2019, 2021, 2022)
(225 observations deleted)

. 
. ** Keep required variables 
. keep year fips state_* county_*         ///
>         *_out_1 *_out_2 *_out_3                 ///
>         *_in_1 *_in_2 *_in_3                    //

.         
. ** Keep only pre and post periods
. gen period = ""
(300 missing values generated)

. replace period = "pre" if inlist(year, 2018, 2019)
variable period was str1 now str3
(150 real changes made)

. replace period = "post_21_22" if inlist(year, 2021, 2022)
variable period was str3 now str10
(150 real changes made)

. keep if period != ""
(0 observations deleted)

. 
. ** Calculate base population (non-movers + all movers = total filers)
. gen n1_base = n1_out_1 + n1_out_2

. gen n2_base = n2_out_1 + n2_out_2

. gen agi_base = agi_out_1 + agi_out_2

. 
. ** Create Other Oregon and Other Washington 
. drop county_fips state_fips 

. 
. replace county_name = "Other" if state_name == "Oregon" & !inlist(fips, 41051, 41067, 41005, 41047, 41071, 41009)
(120 real changes made)

. replace county_name = "Other" if state_name == "Washington" & !inlist(fips, 53011, 53059)
(148 real changes made)

. 
. ** Collapse by time 
. collapse (sum) *_base *_out_3 *_in_3, by(state_name county_name period)

. 
. ** Calculate rates 
. foreach x in "n1" "n2" "agi" {
  2.         gen `x'_out_rate = `x'_out_3 / `x'_base
  3.         gen `x'_in_rate = `x'_in_3 / `x'_base
  4. } // END RATE LOOP 

. 
. ** Keep final variables 
. keep state_name county_name period *_rate

. 
. ** Export 
. export excel using "${results}Table2.xlsx",     ///
>         sheet("raw_irs") sheetreplace firstrow(variables)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/Table2.xlsx saved

. 
. clear

. 
. ** ACS DATA
. 
. ** Load gross data to get Multnomah's total population by period
. use "${data}working/acs_county_gross_25plus.dta", clear

. 
. ** Keep only in sample 
. keep if inlist(state_name, "Oregon", "Washington")
(4,652 observations deleted)

. keep if inlist(year, 2018, 2019, 2021, 2022, 2023, 2024)
(68 observations deleted)

. 
. ** Keep required variables 
. keep year fips state_* county_*         ///
>         *_out_1 *_out_2 *_out_3                 ///
>         *_in_1 *_in_2 *_in_3                    //

.         
. ** Keep only pre and post periods
. gen period = ""
(105 missing values generated)

. replace period = "pre" if inlist(year, 2018, 2019)
variable period was str1 now str3
(34 real changes made)

. replace period = "post_21_22" if inlist(year, 2021, 2022)
variable period was str3 now str10
(35 real changes made)

. replace period = "post_23_24" if inlist(year, 2023, 2024)
(36 real changes made)

. keep if period != ""
(0 observations deleted)

. 
. ** Calculate base population (non-movers + all movers = total filers)
. gen hh_base = households_out_1 + households_out_2

. gen per_base = persons_out_1 + persons_out_2

. gen dol_base = dollars_out_1 + dollars_out_2

. 
. ** Rename 
. rename households_* hh_* 

. rename persons_* per_* 

. rename dollars_* dol_*

. 
. ** Create Other Oregon and Other Washington 
. drop county_fips state_fips 

. 
. replace county_name = "Other" if state_name == "Oregon" & !inlist(fips, 41051, 41067, 41005, 41047, 41071, 41009)
(21 real changes made)

. replace county_name = "Other" if state_name == "Washington" & !inlist(fips, 53011, 53059)
(51 real changes made)

. 
. ** Collapse by time 
. collapse (sum) *_base *_out_3 *_in_3, by(state_name county_name period)

. 
. ** Update period
. gen tmp = inlist(period, "post_21_22", "post_23_24")

. 
. ** Loop over variables 
. foreach var of varlist hh_* per_* dol_* {
  2.         
.         bysort state_name county_name tmp: egen total = total(`var')
  3.         replace `var' = total if period == "post_23_24"
  4.         drop total 
  5. 
. }
(8 real changes made)
(8 real changes made)
(8 real changes made)
(8 real changes made)
(8 real changes made)
(8 real changes made)
(8 real changes made)
(8 real changes made)
(8 real changes made)

. 
. drop tmp 

. replace period = "post_21_24" if period == "post_23_24"
(8 real changes made)

. 
. 
. ** Calculate rates 
. foreach x in "hh" "per" "dol" {
  2.         gen `x'_out_rate = `x'_out_3 / `x'_base
  3.         gen `x'_in_rate = `x'_in_3 / `x'_base
  4. } // END RATE LOOP 

. 
. ** Keep final variables 
. keep state_name county_name period *_rate

. 
. ** Export 
. export excel using "${results}Table2.xlsx",     ///
>         sheet("raw_acs") sheetreplace firstrow(variables)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/Table2.xlsx saved

. 
. clear

. 
. /*******************************************************************************
> SECTION 3: PARTNER-COUNTY NORMALIZED FLOW MAPS
> Purpose: Create flow data normalized by partner county population (per 100K)
>          for directional flow maps showing Multnomah's migration patterns.
> 
> Out-flow map: Rate of migration FROM Multnomah TO each destination county
>               normalized by DESTINATION county average population
> In-flow map:  Rate of migration TO Multnomah FROM each origin county
>               normalized by ORIGIN county average population
> 
> Outputs:
> - multnomah_partner_flows_[n1|n2|agi].csv: Flow data with partner normalization
> *******************************************************************************/
. 
. ** ------------------------------------------------------------
. ** GET COUNTY POPULATIONS FOR RATE CALCULATIONS
. ** ------------------------------------------------------------
. 
. ** Load gross data to get each county's population by period
. use "${data}working/irs_county_gross", clear

. 
. ** Keep only pre and post periods
. gen period = ""
(21,980 missing values generated)

. replace period = "pre" if inlist(year, 2018, 2019)
variable period was str1 now str3
(6,280 real changes made)

. replace period = "post" if inlist(year, 2021, 2022)
variable period was str3 now str4
(6,278 real changes made)

. keep if period != ""
(9,422 observations deleted)

. 
. ** Calculate base population (non-movers + all movers = total filers)
. gen n1_pop = n1_out_1 + n1_out_2

. gen n2_pop = n2_out_1 + n2_out_2

. gen agi_pop = agi_out_1 + agi_out_2

. 
. ** Drop non-balanced counties 
. bysort fips: gen ct = _N

. keep if ct == 4
(30 observations deleted)

. drop ct 

. 
. ** Keep relevant variables
. keep fips period n1_pop n2_pop agi_pop 

. 
. ** Collapse to get average by period
. collapse (sum) n1_pop n2_pop agi_pop, by(fips period)

. 
. ** Reshape to wide format
. reshape wide n1_pop n2_pop agi_pop, i(fips) j(period) string
(j = post pre)

Data                               Long   ->   Wide
-----------------------------------------------------------------------------
Number of observations            6,264   ->   3,132       
Number of variables                   5   ->   7           
j variable (2 values)            period   ->   (dropped)
xij variables:
                                 n1_pop   ->   n1_poppost n1_poppre
                                 n2_pop   ->   n2_poppost n2_poppre
                                agi_pop   ->   agi_poppost agi_poppre
-----------------------------------------------------------------------------

. 
. ** Calculate average population across periods
. gen n1_pop_avg = (n1_poppre + n1_poppost) / 2

. gen n2_pop_avg = (n2_poppre + n2_poppost) / 2

. gen agi_pop_avg = (agi_poppre + agi_poppost) / 2

. 
. ** Keep needed variables
. keep fips *_pop_avg *_poppre *_poppost

. rename *_poppre *_pop_pre

. rename *_poppost *_pop_post

. 
. ** Save county populations
. tempfile county_pops

. save `county_pops'
file C:\Users\ji252\AppData\Local\Temp\ST_92f0_000005.tmp saved as .dta format

. 
. clear

. 
. ** ------------------------------------------------------------
. ** LOAD FLOW DATA AND CREATE PARTNER-NORMALIZED DATASETS
. ** ------------------------------------------------------------
. 
. ** Load IRS flow data
. use ${data}working/irs_county_flow.dta, clear

. 
. ** Define Multnomah County FIPS
. local multnomah_fips = 41051

. 
. ** Define pre and post periods
. gen period = ""
(362,678 missing values generated)

. replace period = "pre" if inlist(year, 2018, 2019)
variable period was str1 now str3
(97,023 real changes made)

. replace period = "post" if inlist(year, 2021, 2022)
variable period was str3 now str4
(107,196 real changes made)

. 
. ** Keep only pre and post periods
. keep if period != ""
(158,459 observations deleted)

. 
. ** Loop over each measure to create separate datasets
. foreach measure in "n1" "n2" "agi" {
  2. 
.         ** Display status
.         dis "Creating partner-normalized flow dataset for `measure'..."
  3. 
.         ** Preserve original data
.         preserve
  4. 
.         ** ------------------------------------------------------------
.         ** OUT-MIGRATION: Flows FROM Multnomah TO other counties
.         ** ------------------------------------------------------------
. 
.         ** Keep flows where Multnomah is the origin
.         keep if fips_o == `multnomah_fips'
  5. 
.         ** Collapse to sum flows by destination county and period
.         collapse (sum) `measure', by(fips_d period)
  6. 
.         ** Reshape to wide format (pre and post as columns)
.         reshape wide `measure', i(fips_d) j(period) string
  7. 
.         ** Rename for clarity
.         rename fips_d fips
  8.         rename `measure'pre out_pre
  9.         rename `measure'post out_post
 10.         
.         ** Replace missing values with 0s
.         replace out_pre = 0 if missing(out_pre)
 11.         replace out_post = 0 if missing(out_post)
 12. 
.         ** Merge with destination county populations
.         merge 1:1 fips using `county_pops', keep(match) nogen ///
>                 keepusing(`measure'_pop_pre `measure'_pop_post `measure'_pop_avg)
 13. 
.         ** Rename population variables for out-migration (destination pop)
.         rename `measure'_pop_pre dest_pop_pre
 14.         rename `measure'_pop_post dest_pop_post
 15.         rename `measure'_pop_avg dest_pop_avg
 16. 
.         ** Calculate out-migration rate per 100K of destination population
.         gen out_rate_pre = 100000 * out_pre / dest_pop_pre
 17.         gen out_rate_post = 100000 * out_post / dest_pop_post
 18.         gen out_rate_change = out_rate_post - out_rate_pre
 19. 
.         ** Save temp file for out-migration
.         tempfile out_flows
 20.         save `out_flows'
 21. 
.         ** ------------------------------------------------------------
.         ** IN-MIGRATION: Flows TO Multnomah FROM other counties
.         ** ------------------------------------------------------------
. 
.         ** Restore and start fresh
.         restore
 22.         preserve
 23. 
.         ** Keep flows where Multnomah is the destination
.         keep if fips_d == `multnomah_fips'
 24. 
.         ** Collapse to sum flows by origin county and period
.         collapse (sum) `measure', by(fips_o period)
 25. 
.         ** Reshape to wide format
.         reshape wide `measure', i(fips_o) j(period) string
 26. 
.         ** Rename for clarity
.         rename fips_o fips
 27.         rename `measure'pre in_pre
 28.         rename `measure'post in_post
 29.         
.         ** Replace missing values with 0s
.         replace in_pre = 0 if missing(in_pre)
 30.         replace in_post = 0 if missing(in_post)
 31. 
.         ** Merge with origin county populations
.         merge 1:1 fips using `county_pops', keep(match) nogen ///
>                 keepusing(`measure'_pop_pre `measure'_pop_post `measure'_pop_avg)
 32. 
.         ** Rename population variables for in-migration (origin pop)
.         rename `measure'_pop_pre orig_pop_pre
 33.         rename `measure'_pop_post orig_pop_post
 34.         rename `measure'_pop_avg orig_pop_avg
 35. 
.         ** Calculate in-migration rate per 100K of origin population
.         gen in_rate_pre = 100000 * in_pre / orig_pop_pre
 36.         gen in_rate_post = 100000 * in_post / orig_pop_post
 37.         gen in_rate_change = in_rate_post - in_rate_pre
 38. 
.         ** ------------------------------------------------------------
.         ** MERGE: Combine in and out flows
.         ** ------------------------------------------------------------
. 
.         ** Merge with out-migration flows
.         merge 1:1 fips using `out_flows', nogen
 39. 
.         ** Replace missing with 0 (counties with flows in only one direction)
.         foreach var of varlist out_pre out_post in_pre in_post {
 40.                 replace `var' = 0 if missing(`var')
 41.         }
 42. 
.         ** Calculate net rate change (negative = net outflow from Multnomah)
.         gen net_rate_change = in_rate_change - out_rate_change
 43. 
.         ** Order columns
.         order fips ///
>                 dest_pop_avg out_pre out_post out_rate_pre out_rate_post out_rate_change ///
>                 orig_pop_avg in_pre in_post in_rate_pre in_rate_post in_rate_change ///
>                 net_rate_change
 44. 
.         ** Sort by fips
.         sort fips
 45. 
.         ** Label variables
.         label var fips "Partner county FIPS code"
 46.         label var dest_pop_avg "Destination county avg population (for out-migration rate)"
 47.         label var out_pre "Out-migration from Multnomah (2018-2019)"
 48.         label var out_post "Out-migration from Multnomah (2021-2022)"
 49.         label var out_rate_pre "Out-migration rate per 100K dest pop (pre)"
 50.         label var out_rate_post "Out-migration rate per 100K dest pop (post)"
 51.         label var out_rate_change "Change in out-migration rate (per 100K)"
 52.         label var orig_pop_avg "Origin county avg population (for in-migration rate)"
 53.         label var in_pre "In-migration to Multnomah (2018-2019)"
 54.         label var in_post "In-migration to Multnomah (2021-2022)"
 55.         label var in_rate_pre "In-migration rate per 100K origin pop (pre)"
 56.         label var in_rate_post "In-migration rate per 100K origin pop (post)"
 57.         label var in_rate_change "Change in in-migration rate (per 100K)"
 58.         label var net_rate_change "Net rate change: in_change - out_change"
 59. 
.         ** Save Stata dataset
.         save "${data}working/multnomah_partner_flows_`measure'.dta", replace
 60. 
.         ** Export to CSV for R mapping
.         export delimited using "${data}working/multnomah_partner_flows_`measure'.csv", replace
 61. 
.         ** Display summary statistics
.         dis ""
 62.         dis "Summary for `measure' - Partner-normalized rates (per 100K):"
 63.         summ out_rate_pre out_rate_post out_rate_change
 64.         summ in_rate_pre in_rate_post in_rate_change
 65. 
.         ** Top 10 destinations for out-migration from Multnomah
.         dis ""
 66.         dis "Top 10 destinations for out-migration (by post rate):"
 67.         gsort -out_rate_post
 68.         list fips out_rate_post out_rate_change in 1/10
 69. 
.         ** Top 10 origins for in-migration to Multnomah
.         dis ""
 70.         dis "Top 10 origins for in-migration (by post rate):"
 71.         gsort -in_rate_post
 72.         list fips in_rate_post in_rate_change in 1/10
 73. 
.         ** Restore original data for next measure
.         restore
 74. 
. } // END MEASURE LOOP
Creating partner-normalized flow dataset for n1...
(203,572 observations deleted)
(j = post pre)

Data                               Long   ->   Wide
-----------------------------------------------------------------------------
Number of observations              355   ->   202         
Number of variables                   3   ->   3           
j variable (2 values)            period   ->   (dropped)
xij variables:
                                     n1   ->   n1post n1pre
-----------------------------------------------------------------------------
(46 real changes made)
(3 real changes made)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                               200  
    -----------------------------------------
file C:\Users\ji252\AppData\Local\Temp\ST_92f0_000007.tmp saved as .dta format
(203,528 observations deleted)
(j = post pre)

Data                               Long   ->   Wide
-----------------------------------------------------------------------------
Number of observations              379   ->   202         
Number of variables                   3   ->   3           
j variable (2 values)            period   ->   (dropped)
xij variables:
                                     n1   ->   n1post n1pre
-----------------------------------------------------------------------------
(7 real changes made)
(18 real changes made)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                               199  
    -----------------------------------------

    Result                      Number of obs
    -----------------------------------------
    Not matched                            57
        from master                        28  
        from using                         29  

    Matched                               171  
    -----------------------------------------
(28 real changes made)
(28 real changes made)
(29 real changes made)
(29 real changes made)
(57 missing values generated)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/multnomah_partner_flows_n1.dta saved
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/multnomah_partner_flows_n1.csv saved

Summary for n1 - Partner-normalized rates (per 100K):

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
out_rate_pre |        200    121.8938    356.1084          0   3176.085
out_rate_p~t |        200    148.3483    391.7624          0   3388.815
out_rate_c~e |        200    26.45453    79.14416  -71.74336   770.7445

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
 in_rate_pre |        199    96.97235    265.7597          0   2431.526
in_rate_post |        199    93.18275    246.5365          0   2218.134
in_rate_ch~e |        199   -3.789604    28.53578  -213.3923   134.5368

Top 10 destinations for out-migration (by post rate):

     +------------------------------+
     |  fips   out_ra~t   out_ra~ge |
     |------------------------------|
  1. | 41005   3388.815    212.7302 |
  2. | 41067   2003.892    38.55579 |
  3. | 41009    1637.13   -55.42285 |
  4. | 41027   1632.853    417.7493 |
  5. | 53011   1590.774    136.3123 |
     |------------------------------|
  6. | 53059   1424.658    405.0963 |
  7. | 41057   1350.739    273.7562 |
  8. | 41007   1112.906    29.94348 |
  9. | 41065   882.6558   -25.07538 |
 10. | 41041   813.1492    206.5953 |
     +------------------------------+

Top 10 origins for in-migration (by post rate):

     +------------------------------+
     |  fips   in_rat~t   in_rat~ge |
     |------------------------------|
  1. | 41005   2218.134   -213.3923 |
  2. | 41067   1728.452   -127.9098 |
  3. | 41027   860.4254   -98.60254 |
  4. | 53011   842.1321     -94.591 |
  5. | 41009   831.5959    -85.6261 |
     |------------------------------|
  6. | 41003   785.7072   -78.97198 |
  7. | 41007   673.1287    41.40051 |
  8. | 41057   548.4543   -50.40588 |
  9. | 53059   547.9452   -56.67841 |
 10. | 41065   534.4971    13.58319 |
     +------------------------------+
Creating partner-normalized flow dataset for n2...
(203,572 observations deleted)
(j = post pre)

Data                               Long   ->   Wide
-----------------------------------------------------------------------------
Number of observations              355   ->   202         
Number of variables                   3   ->   3           
j variable (2 values)            period   ->   (dropped)
xij variables:
                                     n2   ->   n2post n2pre
-----------------------------------------------------------------------------
(46 real changes made)
(3 real changes made)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                               200  
    -----------------------------------------
file C:\Users\ji252\AppData\Local\Temp\ST_92f0_00000a.tmp saved as .dta format
(203,528 observations deleted)
(j = post pre)

Data                               Long   ->   Wide
-----------------------------------------------------------------------------
Number of observations              379   ->   202         
Number of variables                   3   ->   3           
j variable (2 values)            period   ->   (dropped)
xij variables:
                                     n2   ->   n2post n2pre
-----------------------------------------------------------------------------
(7 real changes made)
(18 real changes made)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                               199  
    -----------------------------------------

    Result                      Number of obs
    -----------------------------------------
    Not matched                            57
        from master                        28  
        from using                         29  

    Matched                               171  
    -----------------------------------------
(28 real changes made)
(28 real changes made)
(29 real changes made)
(29 real changes made)
(57 missing values generated)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/multnomah_partner_flows_n2.dta saved
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/multnomah_partner_flows_n2.csv saved

Summary for n2 - Partner-normalized rates (per 100K):

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
out_rate_pre |        200    95.07484    288.3589          0   2695.604
out_rate_p~t |        200    120.8469    328.0628          0   2941.834
out_rate_c~e |        200    25.77202    75.37264  -94.23657   640.5934

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
 in_rate_pre |        199    68.13857    191.0117          0   1819.857
in_rate_post |        199    65.64387    177.4693          0   1650.695
in_rate_ch~e |        199   -2.494699    19.80333  -169.1622   85.40136

Top 10 destinations for out-migration (by post rate):

     +------------------------------+
     |  fips   out_ra~t   out_ra~ge |
     |------------------------------|
  1. | 41005   2941.834      246.23 |
  2. | 41067   1502.273    73.46338 |
  3. | 41027   1409.879    455.1591 |
  4. | 41009   1353.573   -94.23657 |
  5. | 53011   1299.091    98.06836 |
     |------------------------------|
  6. | 41057   1205.822    362.7706 |
  7. | 53059   1182.073    362.1641 |
  8. | 41007   903.9294     66.7583 |
  9. | 41065   743.1895    112.5855 |
 10. | 41041   682.8362    197.6551 |
     +------------------------------+

Top 10 origins for in-migration (by post rate):

     +------------------------------+
     |  fips   in_rat~t   in_rat~ge |
     |------------------------------|
  1. | 41005   1650.695   -169.1622 |
  2. | 41067   1195.349   -72.55103 |
  3. | 41027   622.8574   -17.44733 |
  4. | 53011   619.4438   -83.22137 |
  5. | 41009   610.7878   -81.43085 |
     |------------------------------|
  6. | 41003   509.1627   -24.75842 |
  7. | 41007   493.7835    23.38873 |
  8. | 41057   418.5892   -50.31268 |
  9. | 41065   405.1501    6.096008 |
 10. | 53059   369.7479   -11.33646 |
     +------------------------------+
Creating partner-normalized flow dataset for agi...
(203,572 observations deleted)
(j = post pre)

Data                               Long   ->   Wide
-----------------------------------------------------------------------------
Number of observations              355   ->   202         
Number of variables                   3   ->   3           
j variable (2 values)            period   ->   (dropped)
xij variables:
                                    agi   ->   agipost agipre
-----------------------------------------------------------------------------
(46 real changes made)
(3 real changes made)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                               200  
    -----------------------------------------
file C:\Users\ji252\AppData\Local\Temp\ST_92f0_00000d.tmp saved as .dta format
(203,528 observations deleted)
(j = post pre)

Data                               Long   ->   Wide
-----------------------------------------------------------------------------
Number of observations              379   ->   202         
Number of variables                   3   ->   3           
j variable (2 values)            period   ->   (dropped)
xij variables:
                                    agi   ->   agipost agipre
-----------------------------------------------------------------------------
(7 real changes made)
(18 real changes made)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                               199  
    -----------------------------------------

    Result                      Number of obs
    -----------------------------------------
    Not matched                            57
        from master                        28  
        from using                         29  

    Matched                               171  
    -----------------------------------------
(28 real changes made)
(28 real changes made)
(29 real changes made)
(29 real changes made)
(57 missing values generated)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/multnomah_partner_flows_agi.dta saved
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/multnomah_partner_flows_agi.csv saved

Summary for agi - Partner-normalized rates (per 100K):

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
out_rate_pre |        200    112.4336    320.6304          0   2172.595
out_rate_p~t |        200    188.9238    581.4595          0   4420.437
out_rate_c~e |        200    76.49017    333.4416  -231.8961   3249.586

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
 in_rate_pre |        199    66.16498    176.7936          0   1370.445
in_rate_post |        199    60.69565      159.33          0   1234.148
in_rate_ch~e |        199   -5.469326    36.30775  -341.2853    81.7718

Top 10 destinations for out-migration (by post rate):

     +------------------------------+
     |  fips   out_ra~t   out_ra~ge |
     |------------------------------|
  1. | 41057   4420.437    3249.586 |
  2. | 41027   3592.764    2260.638 |
  3. | 41007   3272.164    1686.282 |
  4. | 41005   3016.007    843.4116 |
  5. | 53011   1814.292    744.7755 |
     |------------------------------|
  6. | 41017    1667.65    959.0034 |
  7. | 53059   1619.798    436.4052 |
  8. | 41067   1615.359     55.9165 |
  9. | 41009   1404.539   -120.7758 |
 10. | 53039   1254.896    25.63843 |
     +------------------------------+

Top 10 origins for in-migration (by post rate):

     +------------------------------+
     |  fips   in_rat~t   in_rat~ge |
     |------------------------------|
  1. | 41067   1234.148   -53.61023 |
  2. | 41005   1198.792    -171.653 |
  3. | 41007   727.4794    70.41144 |
  4. | 41027   613.8173   -20.34229 |
  5. | 41057   573.3669    32.42407 |
     |------------------------------|
  6. | 41009    519.243   -341.2853 |
  7. | 53011   463.6598    -180.342 |
  8. | 41065   411.1717    64.10931 |
  9. | 41003   355.4082   -50.44141 |
 10. | 41041   354.0095    25.80093 |
     +------------------------------+

. 
. dis ""


. dis "Partner-normalized flow datasets created successfully!"
Partner-normalized flow datasets created successfully!

. dis "Files saved to: ${data}working/multnomah_partner_flows_*.csv"
Files saved to: C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/multnomah_partner_flows_*.csv

. 
. ** Close log
. clear

. log close log_02
      name:  log_02
       log:  C:/Users/ji252/Documents/GitHub/multnomah-county-tax/code/logs/02_log_descriptives_2026-02-06.log
  log type:  text
 closed on:   6 Feb 2026, 11:40:01
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

. 
end of do-file

. 
. ** Create maps 
. *rcall script "${code}R/map_code.R", vanilla
. 
. ** Flow-based models (IRS)
. *do ${code}02_flow_analysis.do
. 
. ** Difference-in-Difference (ACS)
. do ${code}02_did_analysis.do

. /*******************************************************************************
> File Name:              02_did_analysis.do
> Creator:                John Iselin
> Date Update:    January 11, 2026
> 
> Called by: 00_multnomah.do
> 
> Purpose: Perform DiD analysis on ACS data examining the effect of the
>          Multnomah County tax on migration patterns by education level.
> 
> Authors: John Iselin
> 
> For more information, contact john.iselin@yale.edu
> 
> *******************************************************************************/
. 
. 
. ** Start log file
. capture log close log_02

. log using "${logs}02_log_did_${date}", replace text name(log_02)
(file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/code/logs/02_log_did_2026-02-06.log not found)
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
      name:  log_02
       log:  C:/Users/ji252/Documents/GitHub/multnomah-county-tax/code/logs/02_log_did_2026-02-06.log
  log type:  text
 opened on:   6 Feb 2026, 11:40:01

. 
. 
. ********************************************************************************
. ** LOAD AND PREPARE DATA
. ********************************************************************************
. 
. ** Load ACS migration data
. use "${data}working/acs_migration_file", replace

. 
. ** Sample restrictions
. drop if year == 2015                                    // Sample: 2016-2024
(2,334,973 observations deleted)

. drop if qmigplc1 == 4                                   // Error in migration place
(401,283 observations deleted)

. drop if inlist(state_fips_o, 2, 15)     // Alaska and Hawaii
(137,699 observations deleted)

. drop if inlist(state_fips_d, 2, 15)     // Alaska and Hawaii
(3,633 observations deleted)

. drop if age < 25                                                // Dropping under 25
(1,814,112 observations deleted)

. drop if ftotinc < 0                                     // Negative Family Income       
(7,054 observations deleted)

. 
. ********************************************************************************
. ** DEFINE SAMPLES AND TREATMENT
. ********************************************************************************
. 
. ** Multnomah county indicators
. gen multnomah_o = (state_fips_o == 41 & county_fips_o == 51)

. gen multnomah_d = (state_fips_d == 41 & county_fips_d == 51)

. 
. ** Analysis samples
. gen sample_1 = (multnomah_o == 1) & year != 2020    // Multnomah in origin (out-migration)

. gen sample_2 = (multnomah_o != 1) &                             ///
>                                 year != 2020 &                                          /// Not Multnomah in origin
>                            inlist(state_fips_o, 6, 41, 53)      // CA, OR, WA (in-migration)

. gen sample_3 = (multnomah_o != 1) &                             /// Not Multnomah in origin
>                                 year != 2020                                            // 

. 
. label var sample_1 "Out-migration Sample"

. label var sample_2 "In-migration Sample (West Coast)"

. label var sample_3 "In-migration Sample (Lower 48 + DC)"

. 
. ** Outcome variables (scaled to percentages)
. gen out_1 = (same_county == 0) * 100

. label var out_1 "Moved out of Multnomah (%)"

. 
. gen out_2 = (multnomah_d == 1) * 100

. label var out_2 "Moved to Multnomah (%)"

. 
. gen out_3 = (state_fips_o != state_fips_d) * 100

. label var out_3 "Moved out of Oregon (%)"

. 
. ** Treatment variables
. gen post = year > 2020

. label var post "Post-2020"

. 
. gen high_ed = educd >= 101

. label var high_ed "College Degree"

. 
. gen treated = high_ed * post

. label var treated "College Degree  Post"

. 
. ********************************************************************************
. ** COVARIATE CATEGORIES
. ********************************************************************************
. 
. ** Age categories
. recode age ///
>     (25/44   = 1 "25-44") ///
>     (45/64   = 2 "45-64") ///
>     (65/max  = 3 "65+"), ///
>     gen(cat_age)
(19,316,283 differences between age and cat_age)

. label var cat_age "Age categories"

. 
. ** Sex
. gen cat_sex = (sex == 2)

. label var cat_sex "Female indicator"

. label define lb_cat_sex 0 "Male" 1 "Female", replace

. label values cat_sex lb_cat_sex

. 
. ** Marital status
. recode marst ///
>     (1       = 1 "Married") ///
>     (2/3     = 2 "Separated") ///
>     (4/5     = 3 "Divorced / Widowed") ///
>     (6       = 4 "Single"), ///
>     gen(cat_married)
(7,510,801 differences between marst and cat_married)

. label var cat_married "Marriage categories"

. 
. ** Number of children
. recode nchild ///
>     (0       = 0 "0 Children") ///
>     (1       = 1 "1 Child") ///
>     (2       = 2 "2 Children") ///
>     (3/max   = 3 "3+ Children"), ///
>     gen(cat_child)
(410,461 differences between nchild and cat_child)

. label var cat_child "Number of Children"

. 
. ** Age of youngest child
. recode yngch ///
>     (99      = 0 "No Children") ///
>     (0/4     = 1 "0-4") ///
>     (5/12    = 2 "5-12") ///
>     (13/17   = 3 "13-17")       ///
>         (18/max  = 4 "18+"), ///
>     gen(cat_yngch)
(18,931,365 differences between yngch and cat_yngch)

. label var cat_yngch "Age of youngest child"

. 
. ** Education categories
. recode educd ///
>     (min/61  = 1 "Less than HS") ///
>     (62/71   = 2 "HS Diploma") ///
>     (80/100  = 3 "Some College") ///
>     (101/max = 4 "College Degree"), ///
>     gen(cat_educ)
(19,316,283 differences between educd and cat_educ)

. label var cat_educ "Education categories"

. 
. ********************************************************************************
. ** REGRESSION 1: DIFFERENCE-IN-DIFFERENCES
. ********************************************************************************
. 
. ** Store estimates for coefficient plot
. estimates clear

. 
. ** Out-migration regression (Sample 1: Multnomah residents)
. reghdfe out_1 treated if sample_1 == 1 [pw = perwt],    ///
>         vce(robust) absorb(year cat_*)
(MWFE estimator converged in 8 iterations)

HDFE Linear regression                            Number of obs   =     43,700
Absorbing 7 HDFE groups                           F(   1,  43676) =      10.80
                                                  Prob > F        =     0.0010
                                                  R-squared       =     0.0176
                                                  Adj R-squared   =     0.0171
                                                  Within R-sq.    =     0.0004
                                                  Root MSE        =    22.8530

------------------------------------------------------------------------------
             |               Robust
       out_1 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
     treated |    1.87921   .5719049     3.29   0.001     .7582661    3.000154
       _cons |   5.154435   .1897731    27.16   0.000     4.782476    5.526394
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------+
 Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------+---------------------------------------|
        year |         8           0           8     |
     cat_age |         3           1           2     |
     cat_sex |         2           1           1    ?|
 cat_married |         4           1           3    ?|
   cat_child |         4           1           3    ?|
   cat_yngch |         5           2           3    ?|
    cat_educ |         4           1           3    ?|
-----------------------------------------------------+
? = number of redundant parameters may be higher

. qui count if e(sample)

. estadd scalar N_unwtd = r(N)

added scalar:
            e(N_unwtd) =  43700

. estimates store did_out

. 
. ** In-migration regression (Sample 2: CA/OR/WA residents)
. reghdfe out_2 treated if sample_2 == 1 [pw = perwt],    ///
>         vce(cluster fips_o) absorb(year fips_o cat_*)
(MWFE estimator converged in 8 iterations)

HDFE Linear regression                            Number of obs   =  2,671,879
Absorbing 8 HDFE groups                           F(   1,     54) =       0.36
Statistics robust to heteroskedasticity           Prob > F        =     0.5516
                                                  R-squared       =     0.0057
                                                  Adj R-squared   =     0.0057
                                                  Within R-sq.    =     0.0000
Number of clusters (fips_o)  =         55         Root MSE        =     2.4386

                                (Std. err. adjusted for 55 clusters in fips_o)
------------------------------------------------------------------------------
             |               Robust
       out_2 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
     treated |  -.0059234   .0098863    -0.60   0.552    -.0257441    .0138974
       _cons |   .0609758   .0018896    32.27   0.000     .0571874    .0647642
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------+
 Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------+---------------------------------------|
        year |         8           1           7     |
      fips_o |        55          55           0    *|
     cat_age |         3           1           2     |
     cat_sex |         2           1           1    ?|
 cat_married |         4           1           3    ?|
   cat_child |         4           1           3    ?|
   cat_yngch |         5           2           3    ?|
    cat_educ |         4           1           3    ?|
-----------------------------------------------------+
? = number of redundant parameters may be higher
* = FE nested within cluster; treated as redundant for DoF computation

. qui count if e(sample)

. estadd scalar N_unwtd = r(N)

added scalar:
            e(N_unwtd) =  2671879

. estimates store did_in_west

. 
. ** In-migration regression (Sample 3: Lower 48 + DC residents)
. reghdfe out_2 treated if sample_3 == 1 [pw = perwt],    ///
>         vce(cluster fips_o) absorb(year fips_o cat_*)
(MWFE estimator converged in 8 iterations)

HDFE Linear regression                            Number of obs   = 17,535,332
Absorbing 8 HDFE groups                           F(   1,    527) =       1.96
Statistics robust to heteroskedasticity           Prob > F        =     0.1624
                                                  R-squared       =     0.0040
                                                  Adj R-squared   =     0.0039
                                                  Within R-sq.    =     0.0000
Number of clusters (fips_o)  =        528         Root MSE        =     1.1658

                               (Std. err. adjusted for 528 clusters in fips_o)
------------------------------------------------------------------------------
             |               Robust
       out_2 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
     treated |  -.0027702   .0019803    -1.40   0.162    -.0066605      .00112
       _cons |    .014161   .0003675    38.53   0.000      .013439     .014883
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------+
 Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------+---------------------------------------|
        year |         8           1           7     |
      fips_o |       528         528           0    *|
     cat_age |         3           1           2     |
     cat_sex |         2           1           1    ?|
 cat_married |         4           1           3    ?|
   cat_child |         4           1           3    ?|
   cat_yngch |         5           2           3    ?|
    cat_educ |         4           1           3    ?|
-----------------------------------------------------+
? = number of redundant parameters may be higher
* = FE nested within cluster; treated as redundant for DoF computation

. qui count if e(sample)

. estadd scalar N_unwtd = r(N)

added scalar:
            e(N_unwtd) =  17535332

. estimates store did_in_48

. 
. ** Out-of-state migration regression (Sample 1: Multnomah residents)
. reghdfe out_3 treated if sample_1 == 1 [pw = perwt],    ///
>         vce(robust) absorb(year cat_*)
(MWFE estimator converged in 8 iterations)

HDFE Linear regression                            Number of obs   =     43,700
Absorbing 7 HDFE groups                           F(   1,  43676) =       9.12
                                                  Prob > F        =     0.0025
                                                  R-squared       =     0.0124
                                                  Adj R-squared   =     0.0118
                                                  Within R-sq.    =     0.0004
                                                  Root MSE        =    17.2846

------------------------------------------------------------------------------
             |               Robust
       out_3 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
     treated |   1.336162   .4425255     3.02   0.003     .4688043     2.20352
       _cons |   2.782316   .1417274    19.63   0.000     2.504528    3.060105
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------+
 Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------+---------------------------------------|
        year |         8           0           8     |
     cat_age |         3           1           2     |
     cat_sex |         2           1           1    ?|
 cat_married |         4           1           3    ?|
   cat_child |         4           1           3    ?|
   cat_yngch |         5           2           3    ?|
    cat_educ |         4           1           3    ?|
-----------------------------------------------------+
? = number of redundant parameters may be higher

. qui count if e(sample)

. estadd scalar N_unwtd = r(N)

added scalar:
            e(N_unwtd) =  43700

. estimates store did_out_state

. 
. ********************************************************************************
. ** TABLE: DiD RESULTS
. ********************************************************************************
. 
. esttab did_out did_out_state did_in_west did_in_48                                              ///
>         using "${results}did/tab_did_overall.tex",                                                      ///
>         starlevel("*" 0.10 "**" 0.05 "***" 0.01)                                                        ///
>         b(%-9.3f) se(%-9.3f) replace                                                                            ///
>         keep(treated)                                                                                                           ///
>         coeflabels(treated  "College Degree $\times$ Post")                             ///
>         mtitle( "Out-migration"                                                                                         ///
>                         "Out-of-state"                                                                                          ///
>                         "In-migration (West Coast)"                                                             ///
>                         "In-migration (Lower 48 + DC)")                                                         ///
>         stats(N_unwtd, fmt(%12.0fc) labels("Observations"))
(output written to C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/did/tab_did_overall.tex)

. 
. ********************************************************************************
. ** REGRESSION 2: EVENT STUDY
. ********************************************************************************
. 
. ** Create year  education interactions (base year = 2019, 2020 excluded)
. foreach y in 2016 2017 2018 2021 2022 2023 2024 {
  2.         gen x_high_ed_`y' = high_ed * (year == `y')
  3. }

. 
. ** Out-migration event study
. reghdfe out_1 x_high_ed_* if sample_1 == 1 [pw = perwt],        ///
>         vce(robust) absorb(year cat_*)
(MWFE estimator converged in 8 iterations)

HDFE Linear regression                            Number of obs   =     43,700
Absorbing 7 HDFE groups                           F(   7,  43670) =       2.16
                                                  Prob > F        =     0.0345
                                                  R-squared       =     0.0177
                                                  Adj R-squared   =     0.0171
                                                  Within R-sq.    =     0.0005
                                                  Root MSE        =    22.8532

--------------------------------------------------------------------------------
               |               Robust
         out_1 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
---------------+----------------------------------------------------------------
x_high_ed_2016 |   .0111546   1.096317     0.01   0.992    -2.137646    2.159956
x_high_ed_2017 |   1.612263   1.062038     1.52   0.129    -.4693515    3.693878
x_high_ed_2018 |   .9835067   1.004267     0.98   0.327    -.9848755    2.951889
x_high_ed_2021 |   2.236601   1.051952     2.13   0.033     .1747565    4.298445
x_high_ed_2022 |   2.877864   1.237786     2.33   0.020     .4517803    5.303948
x_high_ed_2023 |   2.477298   .9783823     2.53   0.011     .5596508    4.394945
x_high_ed_2024 |   2.529116   .9572056     2.64   0.008     .6529754    4.405256
         _cons |   4.841722   .3271145    14.80   0.000     4.200571    5.482872
--------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------+
 Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------+---------------------------------------|
        year |         8           0           8     |
     cat_age |         3           1           2     |
     cat_sex |         2           1           1    ?|
 cat_married |         4           1           3    ?|
   cat_child |         4           1           3    ?|
   cat_yngch |         5           2           3    ?|
    cat_educ |         4           1           3    ?|
-----------------------------------------------------+
? = number of redundant parameters may be higher

. estimates store es_out

. 
. ** In-migration event study
. reghdfe out_2 x_high_ed_* if sample_2 == 1 [pw = perwt],        ///
>         vce(cluster fips_o) absorb(year fips_o cat_*)
(MWFE estimator converged in 8 iterations)

HDFE Linear regression                            Number of obs   =  2,671,879
Absorbing 8 HDFE groups                           F(   7,     54) =       1.60
Statistics robust to heteroskedasticity           Prob > F        =     0.1562
                                                  R-squared       =     0.0057
                                                  Adj R-squared   =     0.0057
                                                  Within R-sq.    =     0.0000
Number of clusters (fips_o)  =         55         Root MSE        =     2.4386

                                  (Std. err. adjusted for 55 clusters in fips_o)
--------------------------------------------------------------------------------
               |               Robust
         out_2 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
---------------+----------------------------------------------------------------
x_high_ed_2016 |   .0081211   .0199764     0.41   0.686    -.0319292    .0481714
x_high_ed_2017 |  -.0130854   .0166265    -0.79   0.435    -.0464195    .0202487
x_high_ed_2018 |    .024363   .0189363     1.29   0.204     -.013602    .0623279
x_high_ed_2021 |   .0294417   .0252506     1.17   0.249    -.0211826    .0800661
x_high_ed_2022 |  -.0041697    .017745    -0.23   0.815    -.0397463     .031407
x_high_ed_2023 |  -.0175256   .0238206    -0.74   0.465     -.065283    .0302318
x_high_ed_2024 |  -.0113086    .022593    -0.50   0.619    -.0566048    .0339877
         _cons |   .0592554   .0052014    11.39   0.000     .0488272    .0696835
--------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------+
 Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------+---------------------------------------|
        year |         8           1           7     |
      fips_o |        55          55           0    *|
     cat_age |         3           1           2     |
     cat_sex |         2           1           1    ?|
 cat_married |         4           1           3    ?|
   cat_child |         4           1           3    ?|
   cat_yngch |         5           2           3    ?|
    cat_educ |         4           1           3    ?|
-----------------------------------------------------+
? = number of redundant parameters may be higher
* = FE nested within cluster; treated as redundant for DoF computation

. estimates store es_in_west

. 
. ** In-migration event study
. reghdfe out_2 x_high_ed_* if sample_3 == 1 [pw = perwt],        ///
>         vce(cluster fips_o) absorb(year fips_o cat_*)
(MWFE estimator converged in 8 iterations)

HDFE Linear regression                            Number of obs   = 17,535,332
Absorbing 8 HDFE groups                           F(   7,    527) =       1.16
Statistics robust to heteroskedasticity           Prob > F        =     0.3263
                                                  R-squared       =     0.0040
                                                  Adj R-squared   =     0.0039
                                                  Within R-sq.    =     0.0000
Number of clusters (fips_o)  =        528         Root MSE        =     1.1658

                                 (Std. err. adjusted for 528 clusters in fips_o)
--------------------------------------------------------------------------------
               |               Robust
         out_2 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
---------------+----------------------------------------------------------------
x_high_ed_2016 |   .0007498   .0039623     0.19   0.850    -.0070342    .0085337
x_high_ed_2017 |  -.0031063   .0033683    -0.92   0.357    -.0097232    .0035107
x_high_ed_2018 |   .0025704   .0038514     0.67   0.505    -.0049956    .0101363
x_high_ed_2021 |   .0014856   .0047718     0.31   0.756    -.0078886    .0108597
x_high_ed_2022 |  -.0009981   .0036541    -0.27   0.785    -.0081764    .0061802
x_high_ed_2023 |  -.0058045    .004544    -1.28   0.202    -.0147312    .0031222
x_high_ed_2024 |  -.0053443    .004367    -1.22   0.222    -.0139231    .0032345
         _cons |   .0141468   .0009804    14.43   0.000     .0122207    .0160728
--------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------+
 Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------+---------------------------------------|
        year |         8           1           7     |
      fips_o |       528         528           0    *|
     cat_age |         3           1           2     |
     cat_sex |         2           1           1    ?|
 cat_married |         4           1           3    ?|
   cat_child |         4           1           3    ?|
   cat_yngch |         5           2           3    ?|
    cat_educ |         4           1           3    ?|
-----------------------------------------------------+
? = number of redundant parameters may be higher
* = FE nested within cluster; treated as redundant for DoF computation

. estimates store es_in_48

. 
. ** Out-of-state migration event study
. reghdfe out_3 x_high_ed_* if sample_1 == 1 [pw = perwt],        ///
>         vce(robust) absorb(year cat_*)
(MWFE estimator converged in 8 iterations)

HDFE Linear regression                            Number of obs   =     43,700
Absorbing 7 HDFE groups                           F(   7,  43670) =       1.65
                                                  Prob > F        =     0.1173
                                                  R-squared       =     0.0125
                                                  Adj R-squared   =     0.0119
                                                  Within R-sq.    =     0.0006
                                                  Root MSE        =    17.2842

--------------------------------------------------------------------------------
               |               Robust
         out_3 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
---------------+----------------------------------------------------------------
x_high_ed_2016 |   .3908869   .7863394     0.50   0.619    -1.150353    1.932126
x_high_ed_2017 |   -.104465     .83409    -0.13   0.900    -1.739297    1.530367
x_high_ed_2018 |   .0619677   .7419937     0.08   0.933    -1.392353    1.516289
x_high_ed_2021 |   .6481993   .8224614     0.79   0.431    -.9638402    2.260239
x_high_ed_2022 |   2.400929   .9828922     2.44   0.015     .4744427    4.327416
x_high_ed_2023 |   1.302751   .7438215     1.75   0.080    -.1551531    2.760655
x_high_ed_2024 |   1.337775   .7407058     1.81   0.071    -.1140222    2.789572
         _cons |   2.741633   .2481168    11.05   0.000     2.255319    3.227946
--------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------+
 Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------+---------------------------------------|
        year |         8           0           8     |
     cat_age |         3           1           2     |
     cat_sex |         2           1           1    ?|
 cat_married |         4           1           3    ?|
   cat_child |         4           1           3    ?|
   cat_yngch |         5           2           3    ?|
    cat_educ |         4           1           3    ?|
-----------------------------------------------------+
? = number of redundant parameters may be higher

. estimates store es_out_state

. 
. ********************************************************************************
. ** EVENT STUDY PLOTS
. ********************************************************************************
. 
. ** Extract coefficients and create event study dataset
. preserve

.         clear

.         set obs 9
Number of observations (_N) was 0, now 9.

.         gen year = 2015 + _n

. 
.         ** Out-migration coefficients
.         gen out_coef = .
(9 missing values generated)

.         gen out_ci_lo = .
(9 missing values generated)

.         gen out_ci_hi = .
(9 missing values generated)

. 
.         ** In-migration coefficients
.         gen in_west_coef = .
(9 missing values generated)

.         gen in_west_ci_lo = .
(9 missing values generated)

.         gen in_west_ci_hi = .
(9 missing values generated)

.         
.         ** In-migration coefficients
.         gen in_48_coef = .
(9 missing values generated)

.         gen in_48_ci_lo = .
(9 missing values generated)

.         gen in_48_ci_hi = .
(9 missing values generated)

. 
.         ** Out-of-state migration coefficients
.         gen out_state_coef = .
(9 missing values generated)

.         gen out_state_ci_lo = .
(9 missing values generated)

.         gen out_state_ci_hi = .
(9 missing values generated)

. 
.         ** Fill in coefficients (2020 = base year = 0)
.         foreach y in 2016 2017 2018 2021 2022 2023 2024 {
  2. 
.                 ** Out-migration
.                 estimates restore es_out
  3.                 capture {
  4.                         replace out_coef = _b[x_high_ed_`y'] if year == `y'
  5.                         replace out_ci_lo = _b[x_high_ed_`y'] - 1.96 * _se[x_high_ed_`y'] if year == `y'
  6.                         replace out_ci_hi = _b[x_high_ed_`y'] + 1.96 * _se[x_high_ed_`y'] if year == `y'
  7.                 }
  8. 
.                 ** In-migration
.                 estimates restore es_in_west
  9.                 capture {
 10.                         replace in_west_coef = _b[x_high_ed_`y'] if year == `y'
 11.                         replace in_west_ci_lo = _b[x_high_ed_`y'] - 1.96 * _se[x_high_ed_`y'] if year == `y'
 12.                         replace in_west_ci_hi = _b[x_high_ed_`y'] + 1.96 * _se[x_high_ed_`y'] if year == `y'
 13.                 }
 14.                 
.                 ** In-migration
.                 estimates restore es_in_48
 15.                 capture {
 16.                         replace in_48_coef = _b[x_high_ed_`y'] if year == `y'
 17.                         replace in_48_ci_lo = _b[x_high_ed_`y'] - 1.96 * _se[x_high_ed_`y'] if year == `y'
 18.                         replace in_48_ci_hi = _b[x_high_ed_`y'] + 1.96 * _se[x_high_ed_`y'] if year == `y'
 19.                 }
 20. 
.                 ** Out-of-state migration
.                 estimates restore es_out_state
 21.                 capture {
 22.                         replace out_state_coef = _b[x_high_ed_`y'] if year == `y'
 23.                         replace out_state_ci_lo = _b[x_high_ed_`y'] - 1.96 * _se[x_high_ed_`y'] if year == `y'
 24.                         replace out_state_ci_hi = _b[x_high_ed_`y'] + 1.96 * _se[x_high_ed_`y'] if year == `y'
 25.                 }
 26. 
.         }
(results es_out are active now)
(results es_in_west are active now)
(results es_in_48 are active now)
(results es_out_state are active now)
(results es_out are active now)
(results es_in_west are active now)
(results es_in_48 are active now)
(results es_out_state are active now)
(results es_out are active now)
(results es_in_west are active now)
(results es_in_48 are active now)
(results es_out_state are active now)
(results es_out are active now)
(results es_in_west are active now)
(results es_in_48 are active now)
(results es_out_state are active now)
(results es_out are active now)
(results es_in_west are active now)
(results es_in_48 are active now)
(results es_out_state are active now)
(results es_out are active now)
(results es_in_west are active now)
(results es_in_48 are active now)
(results es_out_state are active now)
(results es_out are active now)
(results es_in_west are active now)
(results es_in_48 are active now)
(results es_out_state are active now)

. 
.         ** Base year (2019) = 0; 2020 excluded (no coefficient)
.         foreach v in out_coef out_ci_lo out_ci_hi in_west_coef in_west_ci_lo in_west_ci_hi in_48_coef in_48_ci_lo in_48_ci_hi out_state_coef out_state_ci_lo out_state_ci_hi {
  2.                 replace `v' = 0 if year == 2019
  3.         }
(1 real change made)
(1 real change made)
(1 real change made)
(1 real change made)
(1 real change made)
(1 real change made)
(1 real change made)
(1 real change made)
(1 real change made)
(1 real change made)
(1 real change made)
(1 real change made)

. 
.         ** Offset years slightly for visibility
.         gen year_out = year - 0.2

.         gen year_out_state = year - 0.07

.         gen year_in_west = year + 0.07

.         gen year_in_48 = year + 0.2

. 
.         ** Plot 1: Out-migration event study
.         twoway  (rcap out_ci_lo out_ci_hi year, lc(navy))                               ///
>                         (scatter out_coef year, mc(navy) ms(O)),                ///
>                 yline(0, lc(gs10) lp(dash))                                                             ///
>                 xline(2020.5, lc(black) lp(solid))                                                      ///
>                 xlabel(2016(1)2024)                                                                             ///
>                 ytitle("Effect on Out-Migration (pp)")                                          ///
>                 xtitle("Year")                                                                                          ///
>                 legend(off)                                                                                             ///
>                 title("Out-Migration from Multnomah County")                            ///
>                 subtitle("College Degree vs. No College Degree")                        ///
>                 note("Base year: 2019. 2020 excluded. Vertical line indicates tax implementation.")     ///
>                 graphregion(color(white))

. 
.         graph export "${results}did/fig_es_out_migration.png", replace
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/did/fig_es_out_migration.png saved as PNG format

. 
.         ** Plot 2: In-migration event study (West Coast)
.         twoway  (rcap in_west_ci_lo in_west_ci_hi year, lc(maroon))     ///
>                         (scatter in_west_coef year, mc(maroon) ms(O)),  ///
>                 yline(0, lc(gs10) lp(dash))                                                             ///
>                 xline(2020.5, lc(black) lp(solid))                                                      ///
>                 xlabel(2016(1)2024)                                                                             ///
>                 ytitle("Effect on In-Migration (pp)")                                           ///
>                 xtitle("Year")                                                                                          ///
>                 legend(off)                                                                                             ///
>                 title("In-Migration to Multnomah County (West Coast)")          ///
>                 subtitle("College Degree vs. No College Degree")                        ///
>                 note("Base year: 2019. 2020 excluded. Vertical line indicates tax implementation.")     ///
>                 graphregion(color(white))

. 
.         graph export "${results}did/fig_es_in_migration_west.png", replace
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/did/fig_es_in_migration_west.png saved as PNG format

. 
.         ** Plot 3: In-migration event study (Lower 48 + DC)
.         twoway  (rcap in_48_ci_lo in_48_ci_hi year, lc(forest_green))   ///
>                         (scatter in_48_coef year, mc(forest_green) ms(O)),      ///
>                 yline(0, lc(gs10) lp(dash))                                                             ///
>                 xline(2020.5, lc(black) lp(solid))                                                      ///
>                 xlabel(2016(1)2024)                                                                             ///
>                 ytitle("Effect on In-Migration (pp)")                                           ///
>                 xtitle("Year")                                                                                          ///
>                 legend(off)                                                                                             ///
>                 title("In-Migration to Multnomah County (Lower 48 + DC)")       ///
>                 subtitle("College Degree vs. No College Degree")                        ///
>                 note("Base year: 2019. 2020 excluded. Vertical line indicates tax implementation.")     ///
>                 graphregion(color(white))

. 
.         graph export "${results}did/fig_es_in_migration_48.png", replace
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/did/fig_es_in_migration_48.png saved as PNG format

. 
.         ** Plot 4: Out-of-state migration event study
.         twoway  (rcap out_state_ci_lo out_state_ci_hi year, lc(purple))                 ///
>                         (scatter out_state_coef year, mc(purple) ms(D)),                                ///
>                 yline(0, lc(gs10) lp(dash))                                                                             ///
>                 xline(2020.5, lc(black) lp(solid))                                                                      ///
>                 xlabel(2016(1)2024)                                                                                             ///
>                 ytitle("Effect on Out-of-State Migration (pp)")                                         ///
>                 xtitle("Year")                                                                                                          ///
>                 legend(off)                                                                                                             ///
>                 title("Out-of-State Migration from Multnomah County")                           ///
>                 subtitle("College Degree vs. No College Degree")                                        ///
>                 note("Base year: 2019. 2020 excluded. Vertical line indicates tax implementation.")     ///
>                 graphregion(color(white))

. 
.         graph export "${results}did/fig_es_out_state_migration.png", replace
(file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/did/fig_es_out_state_migration.png not found)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/did/fig_es_out_state_migration.png saved as PNG format

. 
.         ** Plot 5: Combined event study
.         twoway  (rcap out_ci_lo out_ci_hi year_out, lc(navy))                                   ///
>                         (scatter out_coef year_out, mc(navy) ms(O))                     ///
>                         (rcap out_state_ci_lo out_state_ci_hi year_out_state, lc(purple))       ///
>                         (scatter out_state_coef year_out_state, mc(purple) ms(D))       ///
>                         (rcap in_west_ci_lo in_west_ci_hi year_in_west, lc(maroon))     ///
>                         (scatter in_west_coef year_in_west, mc(maroon) ms(T))   ///
>                         (rcap in_48_ci_lo in_48_ci_hi year_in_48, lc(forest_green))     ///
>                         (scatter in_48_coef year_in_48, mc(forest_green) ms(S)),        ///
>                 yline(0, lc(gs10) lp(dash))                                                                             ///
>                 xline(2020.5, lc(black) lp(solid))                                                                      ///
>                 xlabel(2016(1)2024)                                                                                             ///
>                 ytitle("Effect on Migration Rate (pp)")                                                         ///
>                 xtitle("Year")                                                                                                          ///
>                 legend(order(2 "Out-migration" 4 "Out-of-state"                                         ///
>                         6 "In-migration (West Coast)"                                                                   ///
>                         8 "In-migration (Lower 48 + DC)") pos(6) rows(1))                               ///
>                 title("Migration Effects: Multnomah County Tax")                                        ///
>                 subtitle("College Degree vs. No College Degree")                                        ///
>                 note("Base year: 2019. 2020 excluded. Vertical line indicates tax implementation.")     ///
>                 graphregion(color(white))

. 
.         graph export "${results}did/fig_es_combined.png", replace
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/did/fig_es_combined.png saved as PNG format

. 
. restore

. 
. ********************************************************************************
. ** REGRESSION 3: DIFFERENCE-IN-DIFFERENCES BY AGE
. ********************************************************************************
. 
. ** Create age  treatment interactions
. gen treated_age_1 = treated * (cat_age == 1)

. gen treated_age_2 = treated * (cat_age == 2)

. gen treated_age_3 = treated * (cat_age == 3)

. 
. label var treated_age_1 "College x Post x Age 25-44"

. label var treated_age_2 "College x Post x Age 45-64"

. label var treated_age_3 "College x Post x Age 65+"

. 
. ** Store estimates
. estimates clear

. 
. ** Out-migration regression by age (Sample 1: Multnomah residents)
. reghdfe out_1 treated_age_* if sample_1 == 1 [pw = perwt],      ///
>         vce(robust) absorb(year cat_*)
(MWFE estimator converged in 8 iterations)

HDFE Linear regression                            Number of obs   =     43,700
Absorbing 7 HDFE groups                           F(   3,  43674) =       4.72
                                                  Prob > F        =     0.0027
                                                  R-squared       =     0.0178
                                                  Adj R-squared   =     0.0172
                                                  Within R-sq.    =     0.0006
                                                  Root MSE        =    22.8517

-------------------------------------------------------------------------------
              |               Robust
        out_1 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
--------------+----------------------------------------------------------------
treated_age_1 |   2.265208    .755182     3.00   0.003     .7850374    3.745378
treated_age_2 |   2.038199   .6907515     2.95   0.003     .6843137    3.392085
treated_age_3 |    .473663   .6616506     0.72   0.474    -.8231843     1.77051
        _cons |   5.153861   .1897256    27.16   0.000     4.781996    5.525727
-------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------+
 Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------+---------------------------------------|
        year |         8           0           8     |
     cat_age |         3           1           2     |
     cat_sex |         2           1           1    ?|
 cat_married |         4           1           3    ?|
   cat_child |         4           1           3    ?|
   cat_yngch |         5           2           3    ?|
    cat_educ |         4           1           3    ?|
-----------------------------------------------------+
? = number of redundant parameters may be higher

. qui count if e(sample)

. estadd scalar N_unwtd = r(N)

added scalar:
            e(N_unwtd) =  43700

. estimates store did_age_out

. 
. ** In-migration regression by age (Sample 2: CA/OR/WA residents)
. reghdfe out_2 treated_age_* if sample_2 == 1 [pw = perwt],      ///
>         vce(cluster fips_o) absorb(year fips_o cat_*)
(MWFE estimator converged in 8 iterations)

HDFE Linear regression                            Number of obs   =  2,671,879
Absorbing 8 HDFE groups                           F(   3,     54) =       1.52
Statistics robust to heteroskedasticity           Prob > F        =     0.2205
                                                  R-squared       =     0.0057
                                                  Adj R-squared   =     0.0057
                                                  Within R-sq.    =     0.0000
Number of clusters (fips_o)  =         55         Root MSE        =     2.4386

                                 (Std. err. adjusted for 55 clusters in fips_o)
-------------------------------------------------------------------------------
              |               Robust
        out_2 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
--------------+----------------------------------------------------------------
treated_age_1 |   .0138113   .0159846     0.86   0.391     -.018236    .0458585
treated_age_2 |  -.0185364   .0152836    -1.21   0.230    -.0491783    .0121054
treated_age_3 |  -.0265835   .0143442    -1.85   0.069    -.0553419    .0021749
        _cons |   .0609475   .0018883    32.28   0.000     .0571616    .0647334
-------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------+
 Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------+---------------------------------------|
        year |         8           1           7     |
      fips_o |        55          55           0    *|
     cat_age |         3           1           2     |
     cat_sex |         2           1           1    ?|
 cat_married |         4           1           3    ?|
   cat_child |         4           1           3    ?|
   cat_yngch |         5           2           3    ?|
    cat_educ |         4           1           3    ?|
-----------------------------------------------------+
? = number of redundant parameters may be higher
* = FE nested within cluster; treated as redundant for DoF computation

. qui count if e(sample)

. estadd scalar N_unwtd = r(N)

added scalar:
            e(N_unwtd) =  2671879

. estimates store did_age_in_west

. 
. ** In-migration regression by age (Sample 3: Lower 48 + DC residents)
. reghdfe out_2 treated_age_* if sample_3 == 1 [pw = perwt],      ///
>         vce(cluster fips_o) absorb(year fips_o cat_*)
(MWFE estimator converged in 8 iterations)

HDFE Linear regression                            Number of obs   = 17,535,332
Absorbing 8 HDFE groups                           F(   3,    527) =       3.39
Statistics robust to heteroskedasticity           Prob > F        =     0.0178
                                                  R-squared       =     0.0040
                                                  Adj R-squared   =     0.0039
                                                  Within R-sq.    =     0.0000
Number of clusters (fips_o)  =        528         Root MSE        =     1.1658

                                (Std. err. adjusted for 528 clusters in fips_o)
-------------------------------------------------------------------------------
              |               Robust
        out_2 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
--------------+----------------------------------------------------------------
treated_age_1 |   .0036081    .003105     1.16   0.246    -.0024916    .0097078
treated_age_2 |  -.0072223   .0026292    -2.75   0.006    -.0123874   -.0020572
treated_age_3 |  -.0081355   .0029817    -2.73   0.007     -.013993    -.002278
        _cons |   .0141567   .0003688    38.39   0.000     .0134322    .0148812
-------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------+
 Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------+---------------------------------------|
        year |         8           1           7     |
      fips_o |       528         528           0    *|
     cat_age |         3           1           2     |
     cat_sex |         2           1           1    ?|
 cat_married |         4           1           3    ?|
   cat_child |         4           1           3    ?|
   cat_yngch |         5           2           3    ?|
    cat_educ |         4           1           3    ?|
-----------------------------------------------------+
? = number of redundant parameters may be higher
* = FE nested within cluster; treated as redundant for DoF computation

. qui count if e(sample)

. estadd scalar N_unwtd = r(N)

added scalar:
            e(N_unwtd) =  17535332

. estimates store did_age_in_48

. 
. ** Out-of-state migration regression by age (Sample 1: Multnomah residents)
. reghdfe out_3 treated_age_* if sample_1 == 1 [pw = perwt],      ///
>         vce(robust) absorb(year cat_*)
(MWFE estimator converged in 8 iterations)

HDFE Linear regression                            Number of obs   =     43,700
Absorbing 7 HDFE groups                           F(   3,  43674) =       9.37
                                                  Prob > F        =     0.0000
                                                  R-squared       =     0.0128
                                                  Adj R-squared   =     0.0123
                                                  Within R-sq.    =     0.0008
                                                  Root MSE        =    17.2809

-------------------------------------------------------------------------------
              |               Robust
        out_3 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
--------------+----------------------------------------------------------------
treated_age_1 |   1.779864   .6103926     2.92   0.004     .5834834    2.976245
treated_age_2 |   1.656235   .5494208     3.01   0.003       .57936     2.73311
treated_age_3 |  -.5268591   .4092551    -1.29   0.198    -1.329007    .2752883
        _cons |    2.78137   .1416907    19.63   0.000     2.503653    3.059086
-------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------+
 Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------+---------------------------------------|
        year |         8           0           8     |
     cat_age |         3           1           2     |
     cat_sex |         2           1           1    ?|
 cat_married |         4           1           3    ?|
   cat_child |         4           1           3    ?|
   cat_yngch |         5           2           3    ?|
    cat_educ |         4           1           3    ?|
-----------------------------------------------------+
? = number of redundant parameters may be higher

. qui count if e(sample)

. estadd scalar N_unwtd = r(N)

added scalar:
            e(N_unwtd) =  43700

. estimates store did_age_out_state

. 
. ********************************************************************************
. ** TABLE: DiD BY AGE
. ********************************************************************************
. 
. esttab did_age_out did_age_out_state did_age_in_west did_age_in_48              ///
>         using "${results}did/tab_did_by_age.tex",                                                       ///
>         starlevel("*" 0.10 "**" 0.05 "***" 0.01)                                                        ///
>         b(%-9.3f) se(%-9.3f) replace                                                                            ///
>         keep(treated_age_*)                                                                                             ///
>         order(treated_age_1 treated_age_2 treated_age_3)                                        ///
>         coeflabels(     treated_age_1  "College $\times$ Post $\times$ Age 25-44"       ///
>                                 treated_age_2  "College $\times$ Post $\times$ Age 45-64"       ///
>                                 treated_age_3  "College $\times$ Post $\times$ Age 65+")        ///
>         mtitle( "Out-migration"                                                                                         ///
>                         "Out-of-state"                                                                                          ///
>                         "In-migration (West Coast)"                                                             ///
>                         "In-migration (Lower 48 + DC)")                                                         ///
>         stats(N_unwtd, fmt(%12.0fc) labels("Observations"))
(output written to C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/did/tab_did_by_age.tex)

. 
. ********************************************************************************
. ** REGRESSION 4: EVENT STUDY BY AGE
. ********************************************************************************
. 
. ** Create year  education  age interactions (base year = 2019, 2020 excluded)
. foreach y in 2016 2017 2018 2021 2022 2023 2024 {
  2.         forvalues a = 1/3 {
  3.                 gen x_he_`y'_age`a' = high_ed * (year == `y') * (cat_age == `a')
  4.         }
  5. }

. 
. ** Out-migration event study by age
. reghdfe out_1 x_he_*_age* if sample_1 == 1 [pw = perwt],        ///
>         vce(robust) absorb(year cat_*)
(MWFE estimator converged in 7 iterations)

HDFE Linear regression                            Number of obs   =     43,700
Absorbing 7 HDFE groups                           F(  21,  43656) =       1.89
                                                  Prob > F        =     0.0080
                                                  R-squared       =     0.0184
                                                  Adj R-squared   =     0.0175
                                                  Within R-sq.    =     0.0013
                                                  Root MSE        =    22.8486

--------------------------------------------------------------------------------
               |               Robust
         out_1 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
---------------+----------------------------------------------------------------
x_he_2016_age1 |   .5654758   1.407002     0.40   0.688    -2.192274    3.323225
x_he_2016_age2 |  -.4646754   1.236332    -0.38   0.707     -2.88791    1.958559
x_he_2016_age3 |   -.739679   1.266197    -0.58   0.559    -3.221448     1.74209
x_he_2017_age1 |   1.070128   1.285403     0.83   0.405    -1.449285    3.589541
x_he_2017_age2 |   2.187111   1.477376     1.48   0.139    -.7085736    5.082795
x_he_2017_age3 |    2.34649   1.428167     1.64   0.100    -.4527433    5.145724
x_he_2018_age1 |   2.297031   1.304998     1.76   0.078    -.2607899    4.854851
x_he_2018_age2 |  -.5506761   1.073324    -0.51   0.608    -2.654411    1.553059
x_he_2018_age3 |  -.3888978   1.105224    -0.35   0.725    -2.555156    1.777361
x_he_2021_age1 |   3.239788   1.346531     2.41   0.016     .6005636    5.879013
x_he_2021_age2 |    1.51225   1.254731     1.21   0.228    -.9470459    3.971547
x_he_2021_age3 |   .5173142   1.261616     0.41   0.682    -1.955476    2.990105
x_he_2022_age1 |   3.609613     1.7562     2.06   0.040     .1674288    7.051798
x_he_2022_age2 |   1.651577   1.290632     1.28   0.201    -.8780849    4.181238
x_he_2022_age3 |   2.978487    1.59915     1.86   0.063    -.1558756    6.112849
x_he_2023_age1 |   2.302332   1.188666     1.94   0.053    -.0274744    4.632139
x_he_2023_age2 |    3.97115   1.361482     2.92   0.004      1.30262     6.63968
x_he_2023_age3 |   .2711685   1.092291     0.25   0.804    -1.869742    2.412079
x_he_2024_age1 |   2.927704   1.232188     2.38   0.018     .5125931    5.342814
x_he_2024_age2 |   3.058156    1.16764     2.62   0.009     .7695591    5.346752
x_he_2024_age3 |   .4458743   .9505898     0.47   0.639    -1.417299    2.309048
         _cons |   4.837621   .3273582    14.78   0.000     4.195992    5.479249
--------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------+
 Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------+---------------------------------------|
        year |         8           0           8     |
     cat_age |         3           1           2     |
     cat_sex |         2           1           1    ?|
 cat_married |         4           1           3    ?|
   cat_child |         4           1           3    ?|
   cat_yngch |         5           2           3    ?|
    cat_educ |         4           1           3    ?|
-----------------------------------------------------+
? = number of redundant parameters may be higher

. estimates store es_age_out

. 
. ** In-migration event study by age (West Coast)
. reghdfe out_2 x_he_*_age* if sample_2 == 1 [pw = perwt],        ///
>         vce(cluster fips_o) absorb(year fips_o cat_*)
(MWFE estimator converged in 8 iterations)

HDFE Linear regression                            Number of obs   =  2,671,879
Absorbing 8 HDFE groups                           F(  21,     54) =       4.13
Statistics robust to heteroskedasticity           Prob > F        =     0.0000
                                                  R-squared       =     0.0058
                                                  Adj R-squared   =     0.0057
                                                  Within R-sq.    =     0.0001
Number of clusters (fips_o)  =         55         Root MSE        =     2.4385

                                  (Std. err. adjusted for 55 clusters in fips_o)
--------------------------------------------------------------------------------
               |               Robust
         out_2 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
---------------+----------------------------------------------------------------
x_he_2016_age1 |   .0421749   .0247268     1.71   0.094    -.0073994    .0917492
x_he_2016_age2 |   -.012331   .0303391    -0.41   0.686    -.0731572    .0484952
x_he_2016_age3 |  -.0312634   .0199959    -1.56   0.124    -.0713527    .0088259
x_he_2017_age1 |   .0242656   .0190252     1.28   0.208    -.0138777    .0624089
x_he_2017_age2 |  -.0343093   .0177475    -1.93   0.058    -.0698908    .0012723
x_he_2017_age3 |  -.0584671    .028811    -2.03   0.047    -.1162296   -.0007046
x_he_2018_age1 |   .0561582   .0346995     1.62   0.111    -.0134101    .1257265
x_he_2018_age2 |    .006481   .0260016     0.25   0.804    -.0456491     .058611
x_he_2018_age3 |  -.0142124   .0200198    -0.71   0.481    -.0543497    .0259248
x_he_2021_age1 |   .0951098    .047103     2.02   0.048      .000674    .1895455
x_he_2021_age2 |  -.0324995   .0249188    -1.30   0.198    -.0824588    .0174597
x_he_2021_age3 |   -.009891   .0249196    -0.40   0.693    -.0598518    .0400699
x_he_2022_age1 |   .0132397    .018503     0.72   0.477    -.0238566     .050336
x_he_2022_age2 |  -.0004084   .0304345    -0.01   0.989    -.0614259    .0606091
x_he_2022_age3 |  -.0454088   .0214991    -2.11   0.039     -.088512   -.0023056
x_he_2023_age1 |  -.0037799   .0326808    -0.12   0.908     -.069301    .0617412
x_he_2023_age2 |   -.028886   .0296214    -0.98   0.334    -.0882733    .0305013
x_he_2023_age3 |  -.0271568   .0308182    -0.88   0.382    -.0889435    .0346299
x_he_2024_age1 |  -.0043577   .0284376    -0.15   0.879    -.0613716    .0526562
x_he_2024_age2 |  -.0079026   .0245824    -0.32   0.749    -.0571872    .0413821
x_he_2024_age3 |  -.0292426    .025533    -1.15   0.257    -.0804333    .0219481
         _cons |   .0592401   .0051705    11.46   0.000     .0488738    .0696064
--------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------+
 Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------+---------------------------------------|
        year |         8           1           7     |
      fips_o |        55          55           0    *|
     cat_age |         3           1           2     |
     cat_sex |         2           1           1    ?|
 cat_married |         4           1           3    ?|
   cat_child |         4           1           3    ?|
   cat_yngch |         5           2           3    ?|
    cat_educ |         4           1           3    ?|
-----------------------------------------------------+
? = number of redundant parameters may be higher
* = FE nested within cluster; treated as redundant for DoF computation

. estimates store es_age_in_west

. 
. ** In-migration event study by age (Lower 48 + DC)
. reghdfe out_2 x_he_*_age* if sample_3 == 1 [pw = perwt],        ///
>         vce(cluster fips_o) absorb(year fips_o cat_*)
(MWFE estimator converged in 8 iterations)

HDFE Linear regression                            Number of obs   = 17,535,332
Absorbing 8 HDFE groups                           F(  21,    527) =       2.60
Statistics robust to heteroskedasticity           Prob > F        =     0.0001
                                                  R-squared       =     0.0040
                                                  Adj R-squared   =     0.0040
                                                  Within R-sq.    =     0.0000
Number of clusters (fips_o)  =        528         Root MSE        =     1.1658

                                 (Std. err. adjusted for 528 clusters in fips_o)
--------------------------------------------------------------------------------
               |               Robust
         out_2 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
---------------+----------------------------------------------------------------
x_he_2016_age1 |   .0107592   .0052532     2.05   0.041     .0004394    .0210791
x_he_2016_age2 |  -.0052065   .0053178    -0.98   0.328    -.0156533    .0052402
x_he_2016_age3 |  -.0101711   .0042646    -2.39   0.017    -.0185488   -.0017934
x_he_2017_age1 |   .0089671   .0049154     1.82   0.069    -.0006891    .0186232
x_he_2017_age2 |  -.0105508   .0034474    -3.06   0.002    -.0173231   -.0037785
x_he_2017_age3 |  -.0154797   .0052641    -2.94   0.003     -.025821   -.0051385
x_he_2018_age1 |   .0095084    .006351     1.50   0.135    -.0029679    .0219848
x_he_2018_age2 |   .0000986   .0052492     0.02   0.985    -.0102133    .0104105
x_he_2018_age3 |  -.0077424   .0045299    -1.71   0.088    -.0166413    .0011565
x_he_2021_age1 |   .0163991   .0089717     1.83   0.068    -.0012256    .0340238
x_he_2021_age2 |  -.0111084   .0044173    -2.51   0.012    -.0197861   -.0024307
x_he_2021_age3 |  -.0077473   .0045318    -1.71   0.088    -.0166499    .0011553
x_he_2022_age1 |   .0086928    .004765     1.82   0.069     -.000668    .0180536
x_he_2022_age2 |  -.0050524   .0050831    -0.99   0.321    -.0150381    .0049333
x_he_2022_age3 |  -.0135022   .0040139    -3.36   0.001    -.0213875    -.005617
x_he_2023_age1 |    .000257   .0064691     0.04   0.968    -.0124515    .0129654
x_he_2023_age2 |  -.0107436   .0048548    -2.21   0.027    -.0202808   -.0012063
x_he_2023_age3 |  -.0096725   .0067135    -1.44   0.150     -.022861     .003516
x_he_2024_age1 |  -.0037182   .0056401    -0.66   0.510    -.0147982    .0073617
x_he_2024_age2 |  -.0057541   .0044777    -1.29   0.199    -.0145504    .0030422
x_he_2024_age3 |   -.007678   .0059703    -1.29   0.199    -.0194065    .0040505
         _cons |   .0141441   .0009805    14.43   0.000     .0122179    .0160703
--------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------+
 Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------+---------------------------------------|
        year |         8           1           7     |
      fips_o |       528         528           0    *|
     cat_age |         3           1           2     |
     cat_sex |         2           1           1    ?|
 cat_married |         4           1           3    ?|
   cat_child |         4           1           3    ?|
   cat_yngch |         5           2           3    ?|
    cat_educ |         4           1           3    ?|
-----------------------------------------------------+
? = number of redundant parameters may be higher
* = FE nested within cluster; treated as redundant for DoF computation

. estimates store es_age_in_48

. 
. ** Out-of-state migration event study by age
. reghdfe out_3 x_he_*_age* if sample_1 == 1 [pw = perwt],        ///
>         vce(robust) absorb(year cat_*)
(MWFE estimator converged in 7 iterations)

HDFE Linear regression                            Number of obs   =     43,700
Absorbing 7 HDFE groups                           F(  21,  43656) =       2.40
                                                  Prob > F        =     0.0003
                                                  R-squared       =     0.0136
                                                  Adj R-squared   =     0.0126
                                                  Within R-sq.    =     0.0016
                                                  Root MSE        =    17.2778

--------------------------------------------------------------------------------
               |               Robust
         out_3 | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
---------------+----------------------------------------------------------------
x_he_2016_age1 |   .8247441   1.023638     0.81   0.420    -1.181605    2.831094
x_he_2016_age2 |   .1103482   .9434687     0.12   0.907    -1.738868    1.959564
x_he_2016_age3 |  -.3369884   .9186078    -0.37   0.714    -2.137477      1.4635
x_he_2017_age1 |   .1226511   1.021224     0.12   0.904    -1.878967     2.12427
x_he_2017_age2 |  -.0547736   1.198555    -0.05   0.964    -2.403963    2.294415
x_he_2017_age3 |  -.8828364   .8614916    -1.02   0.305    -2.571376    .8057029
x_he_2018_age1 |   .8173409    .976319     0.84   0.403    -1.096262    2.730944
x_he_2018_age2 |  -.7050017   .7946651    -0.89   0.375     -2.26256    .8525565
x_he_2018_age3 |  -.9147078   .7681922    -1.19   0.234    -2.420379    .5909631
x_he_2021_age1 |   1.732888    1.06905     1.62   0.105    -.3624699    3.828247
x_he_2021_age2 |  -.0695909   .9750672    -0.07   0.943     -1.98074    1.841559
x_he_2021_age3 |  -1.323025   .8054941    -1.64   0.100    -2.901808    .2557585
x_he_2022_age1 |   3.489822   1.538601     2.27   0.023      .474136    6.505508
x_he_2022_age2 |   1.597339   .9672462     1.65   0.099    -.2984815    3.493159
x_he_2022_age3 |   .6653446   .8673947     0.77   0.443    -1.034765    2.365454
x_he_2023_age1 |   1.051456   .9393392     1.12   0.263    -.7896665    2.892578
x_he_2023_age2 |   2.999209   1.104547     2.72   0.007     .8342769     5.16414
x_he_2023_age3 |   -1.04621   .6507414    -1.61   0.108    -2.321675    .2292549
x_he_2024_age1 |    1.61121   .9407872     1.71   0.087    -.2327497    3.455171
x_he_2024_age2 |   2.044851   .9759195     2.10   0.036     .1320311    3.957671
x_he_2024_age3 |  -.7007509   .6796308    -1.03   0.303     -2.03284     .631338
         _cons |   2.736044   .2483739    11.02   0.000     2.249226    3.222861
--------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------+
 Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------+---------------------------------------|
        year |         8           0           8     |
     cat_age |         3           1           2     |
     cat_sex |         2           1           1    ?|
 cat_married |         4           1           3    ?|
   cat_child |         4           1           3    ?|
   cat_yngch |         5           2           3    ?|
    cat_educ |         4           1           3    ?|
-----------------------------------------------------+
? = number of redundant parameters may be higher

. estimates store es_age_out_state

. 
. ********************************************************************************
. ** EVENT STUDY BY AGE PLOTS
. ********************************************************************************
. 
. 
.         clear

.         set obs 9
Number of observations (_N) was 0, now 9.

.         gen year = 2015 + _n

. 
.         ** Create coefficient variables for each age group and sample
.         forvalues a = 1/3 {
  2.                 foreach s in "out" "out_state" "in_west" "in_48" {
  3.                         gen `s'_coef_age`a' = .
  4.                         gen `s'_ci_lo_age`a' = .
  5.                         gen `s'_ci_hi_age`a' = .
  6.                 }
  7.         }
(9 missing values generated)
(9 missing values generated)
(9 missing values generated)
(9 missing values generated)
(9 missing values generated)
(9 missing values generated)
(9 missing values generated)
(9 missing values generated)
(9 missing values generated)
(9 missing values generated)
(9 missing values generated)
(9 missing values generated)
(9 missing values generated)
(9 missing values generated)
(9 missing values generated)
(9 missing values generated)
(9 missing values generated)
(9 missing values generated)
(9 missing values generated)
(9 missing values generated)
(9 missing values generated)
(9 missing values generated)
(9 missing values generated)
(9 missing values generated)
(9 missing values generated)
(9 missing values generated)
(9 missing values generated)
(9 missing values generated)
(9 missing values generated)
(9 missing values generated)
(9 missing values generated)
(9 missing values generated)
(9 missing values generated)
(9 missing values generated)
(9 missing values generated)
(9 missing values generated)

. 
.         ** Fill in coefficients
.         foreach y in 2016 2017 2018 2021 2022 2023 2024 {
  2.                 forvalues a = 1/3 {
  3. 
.                         ** Out-migration
.                         estimates restore es_age_out
  4.                         capture {
  5.                                 replace out_coef_age`a' = _b[x_he_`y'_age`a'] if year == `y'
  6.                                 replace out_ci_lo_age`a' = _b[x_he_`y'_age`a'] - 1.96 * _se[x_he_`y'_a
> ge`a'] if year == `y'
  7.                                 replace out_ci_hi_age`a' = _b[x_he_`y'_age`a'] + 1.96 * _se[x_he_`y'_a
> ge`a'] if year == `y'
  8.                         }
  9. 
.                         ** Out-of-state migration
.                         estimates restore es_age_out_state
 10.                         capture {
 11.                                 replace out_state_coef_age`a' = _b[x_he_`y'_age`a'] if year == `y'
 12.                                 replace out_state_ci_lo_age`a' = _b[x_he_`y'_age`a'] - 1.96 * _se[x_he
> _`y'_age`a'] if year == `y'
 13.                                 replace out_state_ci_hi_age`a' = _b[x_he_`y'_age`a'] + 1.96 * _se[x_he
> _`y'_age`a'] if year == `y'
 14.                         }
 15. 
.                         ** In-migration (West Coast)
.                         estimates restore es_age_in_west
 16.                         capture {
 17.                                 replace in_west_coef_age`a' = _b[x_he_`y'_age`a'] if year == `y'
 18.                                 replace in_west_ci_lo_age`a' = _b[x_he_`y'_age`a'] - 1.96 * _se[x_he_`
> y'_age`a'] if year == `y'
 19.                                 replace in_west_ci_hi_age`a' = _b[x_he_`y'_age`a'] + 1.96 * _se[x_he_`
> y'_age`a'] if year == `y'
 20.                         }
 21. 
.                         ** In-migration (Lower 48)
.                         estimates restore es_age_in_48
 22.                         capture {
 23.                                 replace in_48_coef_age`a' = _b[x_he_`y'_age`a'] if year == `y'
 24.                                 replace in_48_ci_lo_age`a' = _b[x_he_`y'_age`a'] - 1.96 * _se[x_he_`y'
> _age`a'] if year == `y'
 25.                                 replace in_48_ci_hi_age`a' = _b[x_he_`y'_age`a'] + 1.96 * _se[x_he_`y'
> _age`a'] if year == `y'
 26.                         }
 27. 
.                 }
 28.         }
(results es_age_out are active now)
(results es_age_out_state are active now)
(results es_age_in_west are active now)
(results es_age_in_48 are active now)
(results es_age_out are active now)
(results es_age_out_state are active now)
(results es_age_in_west are active now)
(results es_age_in_48 are active now)
(results es_age_out are active now)
(results es_age_out_state are active now)
(results es_age_in_west are active now)
(results es_age_in_48 are active now)
(results es_age_out are active now)
(results es_age_out_state are active now)
(results es_age_in_west are active now)
(results es_age_in_48 are active now)
(results es_age_out are active now)
(results es_age_out_state are active now)
(results es_age_in_west are active now)
(results es_age_in_48 are active now)
(results es_age_out are active now)
(results es_age_out_state are active now)
(results es_age_in_west are active now)
(results es_age_in_48 are active now)
(results es_age_out are active now)
(results es_age_out_state are active now)
(results es_age_in_west are active now)
(results es_age_in_48 are active now)
(results es_age_out are active now)
(results es_age_out_state are active now)
(results es_age_in_west are active now)
(results es_age_in_48 are active now)
(results es_age_out are active now)
(results es_age_out_state are active now)
(results es_age_in_west are active now)
(results es_age_in_48 are active now)
(results es_age_out are active now)
(results es_age_out_state are active now)
(results es_age_in_west are active now)
(results es_age_in_48 are active now)
(results es_age_out are active now)
(results es_age_out_state are active now)
(results es_age_in_west are active now)
(results es_age_in_48 are active now)
(results es_age_out are active now)
(results es_age_out_state are active now)
(results es_age_in_west are active now)
(results es_age_in_48 are active now)
(results es_age_out are active now)
(results es_age_out_state are active now)
(results es_age_in_west are active now)
(results es_age_in_48 are active now)
(results es_age_out are active now)
(results es_age_out_state are active now)
(results es_age_in_west are active now)
(results es_age_in_48 are active now)
(results es_age_out are active now)
(results es_age_out_state are active now)
(results es_age_in_west are active now)
(results es_age_in_48 are active now)
(results es_age_out are active now)
(results es_age_out_state are active now)
(results es_age_in_west are active now)
(results es_age_in_48 are active now)
(results es_age_out are active now)
(results es_age_out_state are active now)
(results es_age_in_west are active now)
(results es_age_in_48 are active now)
(results es_age_out are active now)
(results es_age_out_state are active now)
(results es_age_in_west are active now)
(results es_age_in_48 are active now)
(results es_age_out are active now)
(results es_age_out_state are active now)
(results es_age_in_west are active now)
(results es_age_in_48 are active now)
(results es_age_out are active now)
(results es_age_out_state are active now)
(results es_age_in_west are active now)
(results es_age_in_48 are active now)
(results es_age_out are active now)
(results es_age_out_state are active now)
(results es_age_in_west are active now)
(results es_age_in_48 are active now)

. 
.         ** Base year (2019) = 0; 2020 excluded (no coefficient)
.         forvalues a = 1/3 {
  2.                 foreach s in "out" "out_state" "in_west" "in_48" {
  3.                         foreach v in coef ci_lo ci_hi {
  4.                                 replace `s'_`v'_age`a' = 0 if year == 2019
  5.                         }
  6.                 }
  7.         }
(1 real change made)
(1 real change made)
(1 real change made)
(1 real change made)
(1 real change made)
(1 real change made)
(1 real change made)
(1 real change made)
(1 real change made)
(1 real change made)
(1 real change made)
(1 real change made)
(1 real change made)
(1 real change made)
(1 real change made)
(1 real change made)
(1 real change made)
(1 real change made)
(1 real change made)
(1 real change made)
(1 real change made)
(1 real change made)
(1 real change made)
(1 real change made)
(1 real change made)
(1 real change made)
(1 real change made)
(1 real change made)
(1 real change made)
(1 real change made)
(1 real change made)
(1 real change made)
(1 real change made)
(1 real change made)
(1 real change made)
(1 real change made)

. 
.         ** Offset years slightly for visibility across age groups
.         gen year_age1 = year - 0.15

.         gen year_age2 = year

.         gen year_age3 = year + 0.15

. 
.         ** Plot 1: Out-migration event study by age
.         twoway  (rcap out_ci_lo_age1 out_ci_hi_age1 year_age1, lc(maroon))                              /
> //
>                         (scatter out_coef_age1 year_age1, mc(maroon) ms(O))                     ///
>                         (rcap out_ci_lo_age2 out_ci_hi_age2 year_age2, lc(forest_green))                 
>        ///
>                         (scatter out_coef_age2 year_age2, mc(forest_green) ms(T))       ///
>                         (rcap out_ci_lo_age3 out_ci_hi_age3 year_age3, lc(dkorange))                     
>        ///
>                         (scatter out_coef_age3 year_age3, mc(dkorange) ms(S)),          ///
>                 yline(0, lc(gs10) lp(dash))                                                              
>                                        ///
>                 xline(2020.5, lc(black) lp(solid))                                                       
>                                        ///
>                 xlabel(2016(1)2024)                                                                      
>                                                ///
>                 ytitle("Effect on Out-Migration (pp)")                                                   
>                                ///
>                 xtitle("Year")                                                                           
>                                                        ///
>                 legend(order(2 "25-44" 4 "45-64" 6 "65+") pos(6) rows(1))                                
>                ///
>                 title("Out-Migration from Multnomah County by Age")                                      
>                        ///
>                 subtitle("College Degree vs. No College Degree")                                         
>                        ///
>                 note("Base year: 2019. 2020 excluded. Vertical line indicates tax implementation.")     /
> //
>                 graphregion(color(white))

. 
.         graph export "${results}did/fig_es_age_out_migration.png", replace
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/did/fig_es_age_out_migration.png saved
    as PNG format

. 
.         ** Plot 2: In-migration (West Coast) event study by age
.         twoway  (rcap in_west_ci_lo_age1 in_west_ci_hi_age1 year_age1, lc(maroon))              ///
>                         (scatter in_west_coef_age1 year_age1, mc(maroon) ms(O))                 ///
>                         (rcap in_west_ci_lo_age2 in_west_ci_hi_age2 year_age2, lc(forest_green))        /
> //
>                         (scatter in_west_coef_age2 year_age2, mc(forest_green) ms(T)) ///
>                         (rcap in_west_ci_lo_age3 in_west_ci_hi_age3 year_age3, lc(dkorange))            /
> //
>                         (scatter in_west_coef_age3 year_age3, mc(dkorange) ms(S)),      ///
>                 yline(0, lc(gs10) lp(dash))                                                              
>                                        ///
>                 xline(2020.5, lc(black) lp(solid))                                                       
>                                        ///
>                 xlabel(2016(1)2024)                                                                      
>                                                ///
>                 ytitle("Effect on In-Migration (pp)")                                                    
>                                ///
>                 xtitle("Year")                                                                           
>                                                        ///
>                 legend(order(2 "25-44" 4 "45-64" 6 "65+") pos(6) rows(1))                                
>                ///
>                 title("In-Migration to Multnomah (West Coast) by Age")                                   
>                ///
>                 subtitle("College Degree vs. No College Degree")                                         
>                        ///
>                 note("Base year: 2019. 2020 excluded. Vertical line indicates tax implementation.")     /
> //
>                 graphregion(color(white))

. 
.         graph export "${results}did/fig_es_age_in_migration_west.png", replace
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/did/fig_es_age_in_migration_west.png
    saved as PNG format

. 
.         ** Plot 3: In-migration (Lower 48 + DC) event study by age
.         twoway  (rcap in_48_ci_lo_age1 in_48_ci_hi_age1 year_age1, lc(maroon))                  ///
>                         (scatter in_48_coef_age1 year_age1, mc(maroon) ms(O))           ///
>                         (rcap in_48_ci_lo_age2 in_48_ci_hi_age2 year_age2, lc(forest_green))            /
> //
>                         (scatter in_48_coef_age2 year_age2, mc(forest_green) ms(T)) ///
>                         (rcap in_48_ci_lo_age3 in_48_ci_hi_age3 year_age3, lc(dkorange))                 
>        ///
>                         (scatter in_48_coef_age3 year_age3, mc(dkorange) ms(S)),        ///
>                 yline(0, lc(gs10) lp(dash))                                                              
>                                        ///
>                 xline(2020.5, lc(black) lp(solid))                                                       
>                                        ///
>                 xlabel(2016(1)2024)                                                                      
>                                                ///
>                 ytitle("Effect on In-Migration (pp)")                                                    
>                                ///
>                 xtitle("Year")                                                                           
>                                                        ///
>                 legend(order(2 "25-44" 4 "45-64" 6 "65+") pos(6) rows(1))                                
>                ///
>                 title("In-Migration to Multnomah (Lower 48 + DC) by Age")                                
>                ///
>                 subtitle("College Degree vs. No College Degree")                                         
>                        ///
>                 note("Base year: 2019. 2020 excluded. Vertical line indicates tax implementation.")     /
> //
>                 graphregion(color(white))

. 
.         graph export "${results}did/fig_es_age_in_migration_48.png", replace
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/did/fig_es_age_in_migration_48.png
    saved as PNG format

. 
.         ** Plot 4: Out-of-state migration event study by age
.         twoway  (rcap out_state_ci_lo_age1 out_state_ci_hi_age1 year_age1, lc(maroon))                  /
> //
>                         (scatter out_state_coef_age1 year_age1, mc(maroon) ms(O))               ///
>                         (rcap out_state_ci_lo_age2 out_state_ci_hi_age2 year_age2, lc(forest_green))     
>        ///
>                         (scatter out_state_coef_age2 year_age2, mc(forest_green) ms(T)) ///
>                         (rcap out_state_ci_lo_age3 out_state_ci_hi_age3 year_age3, lc(dkorange))         
>                ///
>                         (scatter out_state_coef_age3 year_age3, mc(dkorange) ms(S)),    ///
>                 yline(0, lc(gs10) lp(dash))                                                              
>                                        ///
>                 xline(2020.5, lc(black) lp(solid))                                                       
>                                        ///
>                 xlabel(2016(1)2024)                                                                      
>                                                ///
>                 ytitle("Effect on Out-of-State Migration (pp)")                                          
>                        ///
>                 xtitle("Year")                                                                           
>                                                        ///
>                 legend(order(2 "25-44" 4 "45-64" 6 "65+") pos(6) rows(1))                                
>                ///
>                 title("Out-of-State Migration from Multnomah County by Age")                             
>        ///
>                 subtitle("College Degree vs. No College Degree")                                         
>                        ///
>                 note("Base year: 2019. 2020 excluded. Vertical line indicates tax implementation.")     /
> //
>                 graphregion(color(white))

. 
.         graph export "${results}did/fig_es_age_out_state_migration.png", replace
(file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/did/fig_es_age_out_state_migration.png
    not found)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/did/fig_es_age_out_state_migration.png
    saved as PNG format

. 
. 
. ********************************************************************************
. ** CLEANUP
. ********************************************************************************
. 
. ** Close log
. clear

. log close log_02
      name:  log_02
       log:  C:/Users/ji252/Documents/GitHub/multnomah-county-tax/code/logs/02_log_did_2026-02-06.log
  log type:  text
 closed on:   6 Feb 2026, 12:32:32
-----------------------------------------------------------------------------------------------------------

. 
end of do-file

. 
. ** Synthetic Difference-in-Difference Analysis
. *do ${code}02_sdid_analysis_parallel.do 
. *do ${code}02_sdid_analysis.do 
. 
. ** Individual-level Model
. do ${code}02_indiv_analysis.do 

. /*******************************************************************************
> File Name:       02_indiv_analysis.do
> Creator:         John Iselin
> Date Update:     November 29, 2025
> 
> Called by:       00_multnomah.do
> 
> Purpose:         Perform individual-level migration analysis.
> 
> Authors:         John Iselin
> 
> For more information, contact john.iselin@yale.edu
> *******************************************************************************/
. 
. ** ---------------------------------------------------------------------------
. ** Start log file
. ** ---------------------------------------------------------------------------
. capture log close log_02

. log using "${logs}02_log_individual_${date}", replace text name(log_02)
(file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/code/logs/02_log_individual_2026-02-06.log not
    found)
-----------------------------------------------------------------------------------------------------------
      name:  log_02
       log:  C:/Users/ji252/Documents/GitHub/multnomah-county-tax/code/logs/02_log_individual_2026-02-06.lo
> g
  log type:  text
 opened on:   6 Feb 2026, 12:32:32

. 
. 
. ** ---------------------------------------------------------------------------
. ** Program: hdfe_catyear_plot
. **
. ** - Runs:      reghdfe y i.cat#i.year, absorb(...) nocons
. ** - Posts:     cell means and CIs for each catyear coefficient
. ** - Plots:     one connected series per category + optional CI caps
. ** - Exports:   PDF via graph export
. **
. ** Notes:
. ** - Legend uses category VALUE LABELS. We store those labels immediately after
. **   levelsof (before moving into the posted coefficient dataset) to avoid any
. **   issues from dataset swaps.
. ** - CI and line use the same color; CI uses 50% opacity.
. ** ---------------------------------------------------------------------------
. ** ---------------------------------------------------------------------------
. ** Program: hdfe_catyear_plot
. **
. ** Purpose:
. **   1) Run reghdfe with a CAT  YEAR interaction and absorbed fixed effects.
. **   2) Use margins (rather than reghdfe coefficients) to compute conditional means:
. **        margins i.CAT, over(YEAR)
. **   3) Plot margins by YEAR with one series per CAT (CI optional).
. **
. ** Notes:
. **   - baseyear(0) => plot levels (conditional means).
. **   - baseyear(#) => plot within-CAT differences relative to that year.
. ** ---------------------------------------------------------------------------
. capture program drop hdfe_catyear_plot

. program define hdfe_catyear_plot
  1.     version 16.0
  2. 
.     syntax varname(numeric) [if] [in] [fw aw pw iw] , ///
>         CAT(varname) YEAR(varname) ABSORB(string) ///
>         [ WVAR(varname) WTYPE(string) ///
>           VCE(string) ///
>           TITLE(string) XTITLE(string) YTITLE(string) ///
>           NOCI ///
>           BASEYEAR(integer 0) ///
>           SAVING(string) REPLACE ///
>           DEBUG DEBUGDETAIL ]
  3. 
.     ** -----------------------------------------------------------------------
.     ** Configuration: project root for relative paths
.     ** -----------------------------------------------------------------------
.     local __project_root "C:/Users/ji252/Documents/GitHub/multnomah-county-tax/"
  4. 
.     ** -----------------------------------------------------------------------
.     ** Debug flags
.     ** -----------------------------------------------------------------------
.     local __dbg 0
  5.     local __dbgdetail 0
  6.     if "`debug'" != "" local __dbg 1
  7.     if "`debugdetail'" != "" {
  8.         local __dbg 1
  9.         local __dbgdetail 1
 10.     }
 11. 
.     if `__dbg' {
 12.         di as txt "------------------------------------------------------------"
 13.         di as txt "hdfe_catyear_plot DEBUG START"
 14.         di as txt "Outcome   : `varlist'"
 15.         di as txt "CAT()     : `cat'"
 16.         di as txt "YEAR()    : `year'"
 17.         di as txt "ABSORB()  : `absorb'"
 18.         di as txt "Weights   : weight=`weight' exp=`exp' wvar=`wvar' wtype=`wtype'"
 19.         di as txt "VCE()     : `vce'"
 20.         di as txt "BASEYEAR(): `baseyear'   NOCI: `noci'"
 21.         di as txt "SAVING()  : `saving'   REPLACE: `replace'"
 22.         di as txt "IF/IN     : `if' `in'"
 23.         di as txt "------------------------------------------------------------"
 24.     }
 25. 
.     ** -----------------------------------------------------------------------
.     ** Requirements
.     ** -----------------------------------------------------------------------
.     capture which reghdfe
 26.     if _rc {
 27.         di as error "reghdfe not found. Install with: ssc install reghdfe, replace"
 28.         exit 198
 29.     }
 30. 
.     ** -----------------------------------------------------------------------
.     ** Mark sample
.     ** -----------------------------------------------------------------------
.     if `__dbg' di as txt "[Step 1] Marking estimation sample..."
 31.     marksample touse, strok
 32.     quietly replace `touse' = `touse' & !missing(`varlist', `cat', `year')
 33. 
.     quietly count if `touse'
 34.     if `__dbg' di as txt "  N (after filters): " %12.0gc r(N)
 35.     if r(N) == 0 {
 36.         di as error "No observations available after applying if/in filters."
 37.         exit 2000
 38.     }
 39. 
.     ** -----------------------------------------------------------------------
.     ** Weights (default fw=perwt unless caller provided weights)
.     ** -----------------------------------------------------------------------
.     if `__dbg' di as txt "[Step 2] Resolving weights..."
 40.     local wgt ""
 41.     if "`weight'" != "" {
 42.         local wgt "[`weight'=`exp']"
 43.         if `__dbg' di as txt "  Using caller-provided weights: `wgt'"
 44.     }
 45.     else {
 46.         if "`wvar'"  == "" local wvar  "perwt"
 47.         if "`wtype'" == "" local wtype "fw"
 48.         capture confirm variable `wvar'
 49.         if _rc {
 50.             di as error "Default weight variable `wvar' not found. Either create it or pass weights ex
> plicitly."
 51.             exit 111
 52.         }
 53.         local wgt "[`wtype'=`wvar']"
 54.         if `__dbg' di as txt "  Using default weights: `wgt'"
 55.     }
 56. 
.     ** -----------------------------------------------------------------------
.     ** Ensure CAT/YEAR numeric for factor variables
.     ** -----------------------------------------------------------------------
.     if `__dbg' di as txt "[Step 3] Harmonizing CAT/YEAR types..."
 57.     tempvar __cat __year
 58. 
.     local cattype : type `cat'
 59.     if substr("`cattype'", 1, 3) == "str" {
 60.         quietly encode `cat' if `touse', gen(`__cat')
 61.         local catv `__cat'
 62.         if `__dbg' di as txt "  Encoded string CAT -> `catv'"
 63.     }
 64.     else {
 65.         local catv `cat'
 66.         if `__dbg' di as txt "  CAT already numeric -> `catv'"
 67.     }
 68. 
.     local yeartype : type `year'
 69.     if substr("`yeartype'", 1, 3) == "str" {
 70.         quietly destring `year' if `touse', gen(`__year') force
 71.         capture assert !missing(`__year') if `touse'
 72.         if _rc {
 73.             di as error "Year variable is string and could not be cleanly converted to numeric."
 74.             exit 459
 75.         }
 76.         local yearv `__year'
 77.         if `__dbg' di as txt "  Destring YEAR -> `yearv'"
 78.     }
 79.     else {
 80.         local yearv `year'
 81.         if `__dbg' di as txt "  YEAR already numeric -> `yearv'"
 82.     }
 83. 
.     ** -----------------------------------------------------------------------
.     ** Guard: CAT should not also be absorbed
.     ** -----------------------------------------------------------------------
.     if `__dbg' di as txt "[Step 4] Validating absorb()..."
 84.     if regexm(" `absorb' ", " `catv' ") {
 85.         di as error "Category variable `catv' appears in absorb(): `absorb'. Remove it from absorb() f
> or this run."
 86.         exit 198
 87.     }
 88. 
.     ** -----------------------------------------------------------------------
.     ** Levels and labels (save labels NOW, before switching datasets)
.     ** -----------------------------------------------------------------------
.     if `__dbg' di as txt "[Step 5] Collecting year and category levels..."
 89.     quietly levelsof `yearv' if `touse', local(yrs)
 90.     quietly levelsof `catv'  if `touse', local(cats)
 91.     local vlab : value label `catv'
 92. 
.     if "`yrs'" == "" | "`cats'" == "" {
 93.         di as error "No year or category levels found in estimation sample."
 94.         exit 2000
 95.     }
 96. 
.     if `__dbg' {
 97.         di as txt "  Years: `yrs'"
 98.         di as txt "  Cats : `cats'"
 99.         di as txt "  CAT value label: `vlab'"
100.     }
101. 
.     ** Save category label text into locals (avoids label-loss during preserve/use)
.     foreach c of local cats {
102.         local __key "`c'"
103.         local __key : subinstr local __key "-" "m", all
104. 
.         local __lab "`c'"
105.         if "`vlab'" != "" {
106.             local __tmp : label `vlab' `c'
107.             if "`__tmp'" != "" local __lab "`__tmp'"
108.         }
109.         local __lab : subinstr local __lab `"""' "", all
110.         local __lab_`__key' "`__lab'"
111.     }   // END CAT LABEL SAVE LOOP
112. 
.     ** -----------------------------------------------------------------------
.     ** Base year sanity check (only if baseyear != 0)
.     ** -----------------------------------------------------------------------
.     if `baseyear' != 0 {
113.         if `__dbg' di as txt "[Step 5b] Checking baseyear()..."
114.         local found 0
115.         foreach y of local yrs {
116.             if `y' == `baseyear' local found 1
117.         }
118.         if `found' == 0 {
119.             di as error "baseyear(`baseyear') not found in estimation sample years: `yrs'"
120.             exit 459
121.         }
122.         if `__dbg' di as txt "  baseyear OK: `baseyear'"
123.     }   // END BASEYEAR CHECK
124. 
.     ** -----------------------------------------------------------------------
.     ** Regression (supports margins over CAT  YEAR)
.     ** -----------------------------------------------------------------------
.     if `__dbg' di as txt "[Step 6] Running reghdfe..."
125.     if "`vce'" == "" local vce "robust"
126.     if `__dbg' {
127.         di as txt "  Command:"
128.         di as txt "    reghdfe `varlist' i.`catv'##i.`yearv' if `touse' `wgt', absorb(`absorb') vce(`v
> ce')"
129.     }
130. 
.     quietly reghdfe `varlist' i.`catv'##i.`yearv' if `touse' `wgt', ///
>         absorb(`absorb') vce(`vce')
131. 
.     ** -----------------------------------------------------------------------
.     ** Margins: conditional means by CAT over YEAR (save to dataset)
.     ** -----------------------------------------------------------------------
.     if `__dbg' di as txt "[Step 7] Computing margins and saving results..."
132.     tempfile __margdata
133.     quietly margins, at(`catv'=(`cats') `yearv'=(`yrs')) saving(`__margdata', replace) post
134. 
.     ** -----------------------------------------------------------------------
.     ** Plot using the saved margins dataset
.     ** -----------------------------------------------------------------------
.     preserve
135. 
.         use `__margdata', clear
136. 
.         ** Identify CAT and YEAR columns in margins output
.         ** We compute margins using at(): at(cat levels  year levels). The saved dataset
.         ** therefore stores the grid in _at1 (cat) and _at2 (year) in the order supplied.
.         capture confirm variable _at1
137.         if _rc {
138.             di as error "margins output missing _at1. Ensure margins is called with: margins, at(`catv
> '=(`cats') `yearv'=(`yrs')) saving(...)"
139.             exit 459
140.         }
141.         capture confirm variable _at2
142.         if _rc {
143.             di as error "margins output missing _at2. Ensure margins is called with: margins, at(`catv
> '=(`cats') `yearv'=(`yrs')) saving(...)"
144.             exit 459
145.         }
146. 
.         ** Standardize variable names
.         rename _at1 cat_level
147.         rename _at2 year
148. 
.         capture confirm variable _margin
149.         if _rc {
150.             di as error "margins output missing _margin. Cannot proceed."
151.             exit 459
152.         }
153.         rename _margin b
154. 
.         capture confirm variable _se_margin
155.         if !_rc rename _se_margin se
156.         else {
157.             capture confirm variable _se
158.             if !_rc rename _se se
159.         }
160. 
.         capture confirm variable _ci_lb
161.         if !_rc rename _ci_lb ll
162.         capture confirm variable _ci_ub
163.         if !_rc rename _ci_ub ul
164. if `__dbgdetail' {
165.             di as txt "[DebugDetail] First 8 rows of margins dataset:"
166.             list in 1/8, abbrev(24)
167.         }
168. 
.         ** Ensure year is numeric and sorted
.         capture confirm numeric variable year
169.         if _rc {
170.             di as error "Year in margins dataset is not numeric; cannot plot on x-axis."
171.             exit 459
172.         }
173. 
.         ** Optional normalization to baseyear (within-category)
.         if `baseyear' != 0 {
174.             if `__dbg' di as txt "[Step 8] Normalizing margins to baseyear(`baseyear')..."
175.             bysort cat_level: egen base_b = max(cond(year==`baseyear', b, .))
176.             quietly count if missing(base_b)
177.             if r(N) > 0 {
178.                 di as error "Some categories have no observations in baseyear(`baseyear'). Cannot norm
> alize."
179.                 exit 459
180.             }
181.             replace b  = b  - base_b
182.             capture confirm variable ll
183.             if !_rc replace ll = ll - base_b
184.             capture confirm variable ul
185.             if !_rc replace ul = ul - base_b
186.             drop base_b
187.         }   // END BASEYEAR NORMALIZATION
188. 
.         ** X axis labels (years present in margins results)
.         levelsof year, local(xyrs)
189.         if `__dbg' di as txt "  X-axis years used: `xyrs'"
190. 
.         ** -------------------------------------------------------------------
.         ** Plot styling: use plotplainblind palette if available (scheme-level)
.         ** -------------------------------------------------------------------
.         local __oldscheme "`c(scheme)'"
191.         capture set scheme plotplainblind
192.         if _rc {
193.             if `__dbg' di as txt "  plotplainblind scheme not available; using current scheme: `__olds
> cheme'"
194.         }
195.         else {
196.             if `__dbg' di as txt "  Using scheme: plotplainblind (was `__oldscheme')"
197.         }
198. 
.         ** -------------------------------------------------------------------
.         ** Build twoway spec + legend mapping (one label per series)
.         **   - CI and line share the same pstyle; CI uses 50% opacity.
.         ** -------------------------------------------------------------------
.         if `__dbg' di as txt "[Step 9] Building plot command..."
199.         local plots ""
200.         local leg_order ""
201.         local leg_labels ""
202.         local pnum 0
203. 
.         local cats_n : word count `cats'
204.         local legrows 1
205.         if `cats_n' > 4 local legrows 2
206. 
.         local i 0
207.         foreach c of local cats {
208.             quietly count if cat_level == `c'
209.             if r(N) == 0 continue
210. 
.             local ++i
211.             local pstyle "p`i'"
212. 
.             ** Retrieve pre-saved label text (safe key)
.             local __key "`c'"
213.             local __key : subinstr local __key "-" "m", all
214.             local serieslab "`__lab_`__key''"
215. 
.             ** CI (excluded from legend)
.             if "`noci'" == "" {
216.                 local ++pnum
217.                 local plots `plots' ///
>                     (rcap ll ul year if cat_level==`c', sort ///
>                         pstyle(`pstyle') lcolor(%50))
218.             }
219. 
.             ** Line (in legend)
.             local ++pnum
220.             local plots `plots' ///
>                 (connected b year if cat_level==`c', sort ///
>                     pstyle(`pstyle') lp(solid) msym(O) )
221. 
.             local leg_order  `leg_order' `pnum'
222.             local leg_labels `leg_labels' label(`pnum' `serieslab')
223.         }   // END CATEGORY PLOT LOOP
224. 
.         if `"`plots'"' == `""' {
225.             di as error "No series were built for plotting (plotspec empty)."
226.             exit 2000
227.         }
228. 
.         if `__dbgdetail' {
229.             di as txt "  legend order: `leg_order'"
230.             di as txt "  legend labels: `leg_labels'"
231.             di as txt "  legend rows: `legrows'"
232.         }
233. 
.         ** -------------------------------------------------------------------
.         ** Titles (safe quoting)
.         ** -------------------------------------------------------------------
.         local xtitle_input ""
234.         local ytitle_input ""
235.         local title_input  ""
236. 
.         if `"`xtitle'"' == `""' local xtitle_input "xtitle(Year)"
237.         else                    local xtitle_input `"xtitle(`"`xtitle'"')"'
238. 
.         if `"`ytitle'"' == `""' {
239.             if `baseyear' != 0 local ytitle_input `"ytitle(`"`varlist' (relative to `baseyear')"')"'
240.             else              local ytitle_input `"ytitle(`"`varlist' (adjusted mean)"')"'
241.         }
242.         else {
243.             local ytitle_input `"ytitle(`"`ytitle'"')"'
244.         }
245. 
.         if `"`title'"' != `""' local title_input `"title(`"`title'"')"'
246. 
.                 ** ------------------------------------------------------------
.                 ** Y-axis: round "nice" ticks (e.g., 0,2,4,6,8,10)
.                 ** Uses CI bounds to set max, then rounds to a nice step.
.                 ** ------------------------------------------------------------
. 
.                 quietly summarize ll, meanonly
247.                 local __ymin = r(min)
248. 
.                 quietly summarize ul, meanonly
249.                 local __ymax = r(max)
250. 
.                 ** Always include 0 on axis
.                 if `__ymin' > 0 local __ymin = 0
251.                 if `__ymax' < 0 local __ymax = 0
252. 
.                 ** If plotting levels (baseyear==0), anchor at 0
.                 if `baseyear' == 0 local __ymin = 0
253. 
.                 ** Add a little headroom (5%)
.                 local __ymax = `__ymax' * 1.05
254. 
.                 ** Decide on a "nice" step aiming for ~5 intervals
.                 local __span = `__ymax' - `__ymin'
255.                 if `__span' <= 0 local __span = 1
256. 
.                 local __rawstep = `__span'/5
257. 
.                 ** Snap step to {1,2,5} * 10^k
.                 local __k = floor(log10(`__rawstep'))
258.                 local __base = 10^`__k'
259.                 local __mant = `__rawstep'/`__base'
260. 
.                 local __m = 1
261.                 if `__mant' > 1  local __m = 2
262.                 if `__mant' > 2  local __m = 5
263.                 if `__mant' > 5  local __m = 10
264. 
.                 local __ystep = `__m' * `__base'
265. 
.                 ** Round max up to nearest multiple of step; min down similarly
.                 local __yhigh = ceil(`__ymax'/`__ystep') * `__ystep'
266.                 local __ylow  = floor(`__ymin'/`__ystep') * `__ystep'
267. 
.                 ** For levels, ensure bottom is exactly 0
.                 if `baseyear' == 0 local __ylow = 0
268. 
.                 local __yaxis_opts `"yscale(range(`__ylow' `__yhigh')) ylabel(`__ylow'(`__ystep')`__yhigh
> ')"'
269. 
.         twoway `plots', ///
>             `xtitle_input' ///
>             `ytitle_input' ///
>             `title_input' ///
>             xlabel(`xyrs', angle(45)) ///
>                         `__yaxis_opts' ///           
>                         legend(order(`leg_order') `leg_labels' rows(`legrows') position(6)) 
270. 
.         ** Restore scheme (if we successfully switched)
.         capture set scheme `__oldscheme'
271. 
.         ** -------------------------------------------------------------------
.         ** Export figure (PDF) - robust path handling
.         ** -------------------------------------------------------------------
.         if "`saving'" != "" {
272. 
.             local outpath `"`saving'"'
273.             local outpath : subinstr local outpath `"""' "", all
274.             local outpath : subinstr local outpath "\" "/" , all
275. 
.             ** Prepend project root if relative
.             if !regexm("`outpath'", "^[A-Za-z]:/") & substr("`outpath'", 1, 1) != "/" {
276.                 local outpath "`__project_root'`outpath'"
277.             }
278. 
.             ** Ensure .pdf extension
.             if !regexm("`outpath'", "\.pdf$") local outpath "`outpath'.pdf"
279. 
.             ** Ensure output directory exists
.             local p = strrpos("`outpath'", "/")
280.             if `p' > 0 {
281.                 local outdir = substr("`outpath'", 1, `p' - 1)
282.                 if !direxists("`outdir'") {
283.                     if `__dbg' di as txt "  Creating output directory: `outdir'"
284.                     capture mkdir "`outdir'"
285.                     if _rc & !direxists("`outdir'") {
286.                         di as error "Output directory does not exist and could not be created: `outdir
> '"
287.                         exit 601
288.                     }
289.                 }
290.             }
291. 
.             if `__dbg' di as txt "[Step 10] Exporting graph to: `outpath'"
292. 
.             if "`replace'" != "" graph export "`outpath'", as(pdf) replace
293.             else                graph export "`outpath'", as(pdf)
294. 
.         }   // END PDF EXPORT
295. 
.     restore    // END PRESERVE BLOCK
296. 
.     if `__dbg' {
297.         di as txt "hdfe_catyear_plot DEBUG END"
298.         di as txt "------------------------------------------------------------"
299.     }
300. 
. end

. 
. ** ---------------------------------------------------------------------------
. ** Load ACS migration data
. ** ---------------------------------------------------------------------------
. use "${data}working/acs_migration_file", replace

. 
. ** Sample restrictions
. drop if year == 2015                                    // Sample: 2016-2024
(2,334,973 observations deleted)

. drop if qmigplc1 == 4                                   // Error in migration place 
(401,283 observations deleted)

. drop if inlist(state_fips_o, 2, 15)     // Alaska and Hawaii
(137,699 observations deleted)

. drop if inlist(state_fips_d, 2, 15)     // Alaska and Hawaii
(3,633 observations deleted)

. drop if ftotinc < 0                                     // Negative Family Income       
(7,571 observations deleted)

. drop if age < 25                                                // Dropping under 25
(1,813,595 observations deleted)

. 
. ** ---------------------------------------------------------------------------
. ** Multnomah indicators and samples
. ** ---------------------------------------------------------------------------
. gen multnomah_o = (state_fips_o == 41 & county_fips_o == 51)

. gen multnomah_d = (state_fips_d == 41 & county_fips_d == 51)

. 
. gen sample_1 = (multnomah_o == 1)      // Multnomah in origin-year

. gen sample_2 = (multnomah_o != 1)      // Not Multnomah in origin-year

. label var sample_1 "Out-migration Sample"

. label var sample_2 "In-migration Sample"

. 
. gen out_1 = (same_county == 0)

. replace out_1 = out_1 * 100
(538,681 real changes made)

. label var out_1 "Moved out of Multnomah"

. 
. gen out_2 = (multnomah_d == 1)

. replace out_2 = out_2 * 100 
(47,795 real changes made)

. label var out_2 "Moved to Multnomah"

. 
. 
. ** ---------------------------------------------------------------------------
. ** Covariate categories
. ** ---------------------------------------------------------------------------
. 
. ** Age
. recode age ///
>     (25/44   = 1 "25-44") ///
>     (45/64   = 2 "45-64") ///
>     (65/max  = 3 "65+"), ///
>     gen(cat_age)
(19,316,283 differences between age and cat_age)

. label var cat_age "Age categories"

. tab year cat_age, m 

           |          Age categories
      year |     25-44      45-64        65+ |     Total
-----------+---------------------------------+----------
      2016 |   681,232    846,523    558,580 | 2,086,335 
      2017 |   696,216    844,761    566,503 | 2,107,480 
      2018 |   699,682    839,747    593,206 | 2,132,635 
      2019 |   701,941    842,626    631,905 | 2,176,472 
      2020 |   561,063    658,321    517,867 | 1,737,251 
      2021 |   709,754    814,479    666,776 | 2,191,009 
      2022 |   733,853    829,567    699,446 | 2,262,866 
      2023 |   742,050    827,783    732,956 | 2,302,789 
      2024 |   747,111    818,947    753,388 | 2,319,446 
-----------+---------------------------------+----------
     Total | 6,272,902  7,322,754  5,720,627 |19,316,283 

. 
. ** Sex
. gen cat_sex = (sex == 2)

. label var cat_sex "Female indicator"

. label define lb_cat_sex 0 "Male" 1 "Female", replace

. label values cat_sex lb_cat_sex

. tab year cat_sex, m 

           |   Female indicator
      year |      Male     Female |     Total
-----------+----------------------+----------
      2016 |   985,296  1,101,039 | 2,086,335 
      2017 |   997,918  1,109,562 | 2,107,480 
      2018 | 1,011,314  1,121,321 | 2,132,635 
      2019 | 1,033,269  1,143,203 | 2,176,472 
      2020 |   827,083    910,168 | 1,737,251 
      2021 | 1,040,856  1,150,153 | 2,191,009 
      2022 | 1,074,312  1,188,554 | 2,262,866 
      2023 | 1,093,921  1,208,868 | 2,302,789 
      2024 | 1,101,922  1,217,524 | 2,319,446 
-----------+----------------------+----------
     Total | 9,165,891 10,150,392 |19,316,283 

. 
. ** Marital status
. recode marst ///
>     (1       = 1 "Married") ///
>     (2/3     = 2 "Separated") ///
>     (4/5     = 3 "Divorced / Widowed") ///
>     (6       = 4 "Single"), ///
>     gen(cat_married)
(7,510,801 differences between marst and cat_married)

. label var cat_married "Marriage categories"

. tab year cat_married, m 

           |             Marriage categories
      year |   Married  Separated  Divorced      Single |     Total
-----------+--------------------------------------------+----------
      2016 | 1,246,569     76,410    412,097    351,259 | 2,086,335 
      2017 | 1,258,859     77,348    411,969    359,304 | 2,107,480 
      2018 | 1,270,842     77,788    417,512    366,493 | 2,132,635 
      2019 | 1,296,192     76,315    428,592    375,373 | 2,176,472 
      2020 | 1,036,515     58,080    334,135    308,521 | 1,737,251 
      2021 | 1,286,638     75,252    428,008    401,111 | 2,191,009 
      2022 | 1,337,299     76,534    438,082    410,951 | 2,262,866 
      2023 | 1,357,438     78,034    446,635    420,682 | 2,302,789 
      2024 | 1,362,975     80,186    447,137    429,148 | 2,319,446 
-----------+--------------------------------------------+----------
     Total |11,453,327    675,947  3,764,167  3,422,842 |19,316,283 

. 
. ** Kids at home
. recode nchild ///
>     (0       = 0 "0 Children") ///
>     (1       = 1 "1 Child") ///
>     (2       = 2 "2 Children") ///
>     (3/max   = 3 "3+ Children"), ///
>     gen(cat_child)
(410,461 differences between nchild and cat_child)

. label var cat_child "Number of Children"

. tab year cat_child, m 

           |             Number of Children
      year | 0 Childre    1 Child  2 Childre  3+ Childr |     Total
-----------+--------------------------------------------+----------
      2016 | 1,265,045    387,964    278,328    154,998 | 2,086,335 
      2017 | 1,278,151    391,173    282,188    155,968 | 2,107,480 
      2018 | 1,303,016    393,135    282,176    154,308 | 2,132,635 
      2019 | 1,347,631    397,666    278,666    152,509 | 2,176,472 
      2020 | 1,071,806    317,831    225,864    121,750 | 1,737,251 
      2021 | 1,357,620    399,889    280,928    152,572 | 2,191,009 
      2022 | 1,406,651    412,943    287,656    155,616 | 2,262,866 
      2023 | 1,439,922    417,603    289,925    155,339 | 2,302,789 
      2024 | 1,452,178    422,685    290,790    153,793 | 2,319,446 
-----------+--------------------------------------------+----------
     Total |11,922,020  3,540,889  2,496,521  1,356,853 |19,316,283 

.  
. ** Age of youngest kid at home
. recode yngch ///
>     (99      = 0 "0 Children") ///
>     (0/4     = 1 "0-4") ///
>     (5/12    = 2 "5-12") ///
>     (13/17   = 3 "13-17")       ///
>         (18/max   = 4 "18+"), ///
>     gen(cat_yngch)
(18,931,365 differences between yngch and cat_yngch)

. label var cat_yngch "Age of youngest child"

. tab year cat_yngch, m 

           |                 Age of youngest child
      year | 0 Childre        0-4       5-12      13-17        18+ |     Total
-----------+-------------------------------------------------------+----------
      2016 | 1,265,045    190,397    226,565    133,962    270,366 | 2,086,335 
      2017 | 1,278,151    194,111    228,166    134,815    272,237 | 2,107,480 
      2018 | 1,303,016    193,389    224,601    134,371    277,258 | 2,132,635 
      2019 | 1,347,631    190,799    221,910    133,393    282,739 | 2,176,472 
      2020 | 1,071,806    149,566    175,026    106,686    234,167 | 1,737,251 
      2021 | 1,357,620    185,632    219,365    135,593    292,799 | 2,191,009 
      2022 | 1,406,651    190,603    227,079    140,003    298,530 | 2,262,866 
      2023 | 1,439,922    189,377    226,827    138,903    307,760 | 2,302,789 
      2024 | 1,452,178    187,207    226,289    137,754    316,018 | 2,319,446 
-----------+-------------------------------------------------------+----------
     Total |11,922,020  1,671,081  1,975,828  1,195,480  2,551,874 |19,316,283 

. 
. ** Education
. recode educd ///
>     (min/61  = 1 "Less than HS") ///
>     (62/71   = 2 "HS Diploma") ///
>     (80/100  = 3 "Some College") ///
>     (101/max = 4 "College Degree"), ///
>     gen(cat_educ)
(19,316,283 differences between educd and cat_educ)

. label var cat_educ "Education categories"

. tab year cat_educ, m 

           |            Education categories
      year | Less than  HS Diplom  Some Coll  College D |     Total
-----------+--------------------------------------------+----------
      2016 |   233,839    988,472    180,050    683,974 | 2,086,335 
      2017 |   223,022    989,424    185,574    709,460 | 2,107,480 
      2018 |   217,254    995,303    190,159    729,919 | 2,132,635 
      2019 |   211,611  1,005,357    194,842    764,662 | 2,176,472 
      2020 |   159,539    788,718    157,250    631,744 | 1,737,251 
      2021 |   206,721    987,206    196,644    800,438 | 2,191,009 
      2022 |   203,911  1,010,494    205,172    843,289 | 2,262,866 
      2023 |   204,039  1,023,290    209,472    865,988 | 2,302,789 
      2024 |   199,902  1,019,323    212,409    887,812 | 2,319,446 
-----------+--------------------------------------------+----------
     Total | 1,859,838  8,807,587  1,731,572  6,917,286 |19,316,283 

. 
. 
. ** ---------------------------------------------------------------------------
. ** Real income (2024 USD) and income categories
. ** ---------------------------------------------------------------------------
. gen tmp1 = cpi99 if year == ${end_year_acs}
(16,996,837 missing values generated)

. egen tmp2 = mean(tmp1)

. gen cpi = cpi99 / tmp2

. drop tmp1 tmp2

. 
. foreach var of varlist inctot incwage incearn ftotinc {
  2. 
.     gen real_`var' = round(`var' * cpi)
  3. 
.     recode real_`var' ///
>         (min/-1        = 1 "Negative income") ///
>         (0             = 2 "$0") ///
>         (1/24999       = 3 "$1-$25K") ///
>         (25000/49999   = 4 "$25K-$50K") ///
>         (50000/99999   = 5 "$50K-$100K") ///
>         (100000/199999 = 6 "$100K-$200K") ///
>         (200000/max    = 7 "$200K+"), ///
>         gen(cat_`var')
  4. 
.     tab cat_`var', missing
  5. 
. } // END INCOME LOOP
(19,316,283 differences between real_inctot and cat_inctot)

      RECODE of |
    real_inctot |      Freq.     Percent        Cum.
----------------+-----------------------------------
Negative income |     14,536        0.08        0.08
             $0 |  1,394,134        7.22        7.29
        $1-$25K |  5,046,142       26.12       33.42
      $25K-$50K |  4,656,072       24.10       57.52
     $50K-$100K |  5,013,759       25.96       83.48
    $100K-$200K |  2,340,127       12.11       95.59
         $200K+ |    851,513        4.41      100.00
----------------+-----------------------------------
          Total | 19,316,283      100.00
(19,316,283 differences between real_incwage and cat_incwage)

      RECODE of |
   real_incwage |      Freq.     Percent        Cum.
----------------+-----------------------------------
             $0 |  7,842,382       40.60       40.60
        $1-$25K |  2,396,723       12.41       53.01
      $25K-$50K |  2,939,183       15.22       68.22
     $50K-$100K |  3,736,966       19.35       87.57
    $100K-$200K |  1,833,197        9.49       97.06
         $200K+ |    567,832        2.94      100.00
----------------+-----------------------------------
          Total | 19,316,283      100.00
(19,316,283 differences between real_incearn and cat_incearn)

      RECODE of |
   real_incearn |      Freq.     Percent        Cum.
----------------+-----------------------------------
Negative income |     13,485        0.07        0.07
             $0 |  7,054,924       36.52       36.59
        $1-$25K |  2,695,453       13.95       50.55
      $25K-$50K |  3,120,356       16.15       66.70
     $50K-$100K |  3,885,631       20.12       86.82
    $100K-$200K |  1,915,292        9.92       96.73
         $200K+ |    631,142        3.27      100.00
----------------+-----------------------------------
          Total | 19,316,283      100.00
(19,316,243 differences between real_ftotinc and cat_ftotinc)

      RECODE of |
   real_ftotinc |      Freq.     Percent        Cum.
----------------+-----------------------------------
             $0 |    187,497        0.97        0.97
        $1-$25K |  1,906,940        9.87       10.84
      $25K-$50K |  2,863,409       14.82       25.67
     $50K-$100K |  5,444,886       28.19       53.85
    $100K-$200K |  5,836,643       30.22       84.07
         $200K+ |  3,076,908       15.93      100.00
----------------+-----------------------------------
          Total | 19,316,283      100.00

. 
. label var cat_inctot  "Total personal income categories (real ${end_year_acs} USD)"

. label var cat_incwage "Total wage income categories (real ${end_year_acs} USD)"

. label var cat_incearn "Total earned income categories (real ${end_year_acs} USD)"

. label var cat_ftotinc "Total family income categories (real ${end_year_acs} USD)"

. 
. 
. ** ---------------------------------------------------------------------------
. ** Analysis loops
. ** ---------------------------------------------------------------------------
. 
. ** Categorical variables to iterate over
. local catvars "cat_yngch cat_sex cat_married cat_age cat_child cat_educ cat_ftotinc"

. 
. forvalues i = 1/2 {
  2. 
.     if `i' == 1 local ytitle_txt "Out-migration rate (%)"
  3.     if `i' == 2 local ytitle_txt "In-migration rate (%)"
  4. 
.     foreach cat of local catvars {
  5. 
.         ** Absorb all other categories (but not the focal one)
.         local othercats : list catvars - cat
  6. 
.         ** Run regression and plot
.         hdfe_catyear_plot out_`i' if sample_`i' == 1, ///
>             cat(`cat') ///
>             year(year) ///
>             absorb(state_fips_o county_fips_o `othercats') ///
>             wvar(perwt) wtype(fw) ///
>                         xtitle("ACS Survey Year (t=2)") ///
>             ytitle("`ytitle_txt'") ///
>             saving("${results}individual/fig_`cat'_`i'") ///
>             replace
  7.                         
.     } // END CAT LOOP
  8. 
. } // END SAMPLE LOOP
(Created by command margins; also see char list)
2016 2017 2018 2019 2020 2021 2022 2023 2024
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/individual/fig_cat_yngch_1.pdf saved as
    PDF format
(Created by command margins; also see char list)
2016 2017 2018 2019 2020 2021 2022 2023 2024
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/individual/fig_cat_sex_1.pdf saved as
    PDF format
(Created by command margins; also see char list)
2016 2017 2018 2019 2020 2021 2022 2023 2024
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/individual/fig_cat_married_1.pdf saved
    as PDF format
(Created by command margins; also see char list)
2016 2017 2018 2019 2020 2021 2022 2023 2024
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/individual/fig_cat_age_1.pdf saved as
    PDF format
(Created by command margins; also see char list)
2016 2017 2018 2019 2020 2021 2022 2023 2024
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/individual/fig_cat_child_1.pdf saved as
    PDF format
(Created by command margins; also see char list)
2016 2017 2018 2019 2020 2021 2022 2023 2024
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/individual/fig_cat_educ_1.pdf saved as
    PDF format
(Created by command margins; also see char list)
2016 2017 2018 2019 2020 2021 2022 2023 2024
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/individual/fig_cat_ftotinc_1.pdf saved
    as PDF format
(Created by command margins; also see char list)
2016 2017 2018 2019 2020 2021 2022 2023 2024
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/results/individual/fig_cat_yngch_2.pdf saved as
    PDF format
(Created by command margins; also see char list)
2016 2017 2018 2019 2020 2021 2022 2023 2024
