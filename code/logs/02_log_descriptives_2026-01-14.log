--------------------------------------------------------------------------------------------------
      name:  log_02
       log:  C:/Users/ji252/Documents/GitHub/multnomah-county-tax/code/logs/02_log_descriptives_20
> 26-01-14.log
  log type:  text
 opened on:  14 Jan 2026, 20:39:07

. 
. ** Determine set of common in- and out-migration counties for Multnomah
. use ${data}working/irs_county_flow.dta, clear 

. 
. ** Tag Multnomah
. gen multnomah_o = (state_fips_o == 41 & county_fips_o == 51)

. gen multnomah_d = (state_fips_d == 41 & county_fips_d == 51)

. 
. ** Loop over samples 
. foreach x in "o" "d" {
  2.         
.         ** Preserve 
.         preserve 
  3.         
.         ** Keep Multnomah
.         keep if multnomah_`x' == 1 
  4.         
.         ** Export data 
.         export excel using "${data}multnomah.xlsx",     ///
>                 sheet(irs_`x', replace ) firstrow(variables) 
  5.                 
.         ** Clear and restore 
.         clear 
  6.         restore
  7.                 
. } // END ORIGIN-DESTINATION LOOP 
(361,546 observations deleted)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/multnomah.xlsx saved
(361,434 observations deleted)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/multnomah.xlsx saved

. 
. ** Determine set of common in- and out-migration counties for Multnomah
. use ${data}working/acs_county_flow.dta, clear 

. 
. ** Tag Multnomah
. gen multnomah_o = (state_fips_o == 41 & county_fips_o == 51)

. gen multnomah_d = (state_fips_d == 41 & county_fips_d == 51)

. 
. ** Loop over samples 
. foreach x in "o" "d" {
  2.         
.         ** Preserve 
.         preserve 
  3.         
.         ** Keep Multnomah
.         keep if multnomah_`x' == 1 
  4.         
.         ** Export data 
.         export excel using "${data}multnomah.xlsx",     ///
>                 sheet(acs_`x', replace ) firstrow(variables) 
  5.                 
.         ** Clear and restore 
.         clear 
  6.         restore
  7.                 
. } // END ORIGIN-DESTINATION LOOP 
(230,904 observations deleted)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/multnomah.xlsx saved
(230,847 observations deleted)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/multnomah.xlsx saved

. 
. /*******************************************************************************
> SECTION 2: PRE-POST FLOW COMPARISON (2018-2019 vs 2021-2022)
> Purpose: Compare IRS migration flows to/from Multnomah County before and after
>          the 2020 tax change. Creates datasets and exports CSVs for mapping.
> *******************************************************************************/
. 
. ** Load IRS flow data
. use ${data}working/irs_county_flow.dta, clear

. 
. ** Define Multnomah County FIPS
. local multnomah_fips = 41051

. 
. ** Define pre and post periods
. local pre_years "2018 2019"

. local post_years "2021 2022"

. 
. ** Create period indicator
. gen period = ""
(362,678 missing values generated)

. replace period = "pre" if inlist(year, 2018, 2019)
variable period was str1 now str3
(97,023 real changes made)

. replace period = "post" if inlist(year, 2021, 2022)
variable period was str3 now str4
(107,196 real changes made)

. 
. ** Keep only pre and post periods
. keep if period != ""
(158,459 observations deleted)

. 
. ** Loop over each measure to create separate datasets
. foreach measure in "n1" "n2" "agi" {
  2. 
.         ** Display status
.         dis "Creating flow comparison dataset for `measure'..."
  3. 
.         ** Preserve original data
.         preserve
  4. 
.         ** ----------------------------------------------------------------
.         ** OUT-MIGRATION: Flows FROM Multnomah TO other counties
.         ** ----------------------------------------------------------------
. 
.         ** Keep flows where Multnomah is the origin
.         keep if fips_o == `multnomah_fips'
  5. 
.         ** Collapse to sum flows by destination county and period
.         collapse (sum) `measure', by(fips_d period)
  6. 
.         ** Reshape to wide format (pre and post as columns)
.         reshape wide `measure', i(fips_d) j(period) string
  7. 
.         ** Rename for clarity
.         rename fips_d fips
  8.         rename `measure'pre out_pre
  9.         rename `measure'post out_post
 10. 
.         ** Save temp file for out-migration
.         tempfile out_flows
 11.         save `out_flows'
 12. 
.         ** ----------------------------------------------------------------
.         ** IN-MIGRATION: Flows TO Multnomah FROM other counties
.         ** ----------------------------------------------------------------
. 
.         ** Restore and start fresh
.         restore
 13.         preserve
 14. 
.         ** Keep flows where Multnomah is the destination
.         keep if fips_d == `multnomah_fips'
 15. 
.         ** Collapse to sum flows by origin county and period
.         collapse (sum) `measure', by(fips_o period)
 16. 
.         ** Reshape to wide format
.         reshape wide `measure', i(fips_o) j(period) string
 17. 
.         ** Rename for clarity
.         rename fips_o fips
 18.         rename `measure'pre in_pre
 19.         rename `measure'post in_post
 20. 
.         ** ----------------------------------------------------------------
.         ** MERGE: Combine in and out flows
.         ** ----------------------------------------------------------------
. 
.         ** Merge with out-migration flows
.         merge 1:1 fips using `out_flows', nogen
 21. 
.         ** Replace missing with 0 (counties with flows in only one direction)
.         foreach var of varlist out_pre out_post in_pre in_post {
 22.                 replace `var' = 0 if missing(`var')
 23.         }
 24. 
.         ** Order columns: fips, out_pre, out_post, in_pre, in_post
.         order fips out_pre out_post in_pre in_post
 25. 
.         ** Sort by fips
.         sort fips
 26. 
.         ** Label variables
.         label var fips "County FIPS code"
 27.         label var out_pre "Out-migration from Multnomah (2018-2019)"
 28.         label var out_post "Out-migration from Multnomah (2021-2022)"
 29.         label var in_pre "In-migration to Multnomah (2018-2019)"
 30.         label var in_post "In-migration to Multnomah (2021-2022)"
 31. 
.         ** Save Stata dataset to working directory (for R mapping)
.         save "${data}working/multnomah_flow_comparison_`measure'.dta", replace
 32. 
.         ** Export to CSV for R mapping
.         export delimited using "${data}working/multnomah_flow_comparison_`measure'.csv", replace
 33. 
.         ** Display summary statistics
.         dis "Summary for `measure':"
 34.         summ out_pre out_post in_pre in_post
 35. 
.         ** Restore original data for next measure
.         restore
 36. 
. } // END MEASURE LOOP
Creating flow comparison dataset for n1...
(203,572 observations deleted)
(j = post pre)

Data                               Long   ->   Wide
-----------------------------------------------------------------------------
Number of observations              355   ->   202         
Number of variables                   3   ->   3           
j variable (2 values)            period   ->   (dropped)
xij variables:
                                     n1   ->   n1post n1pre
-----------------------------------------------------------------------------
file C:\Users\ji252\AppData\Local\Temp\ST_72bc_000006.tmp saved as .dta format
(203,528 observations deleted)
(j = post pre)

Data                               Long   ->   Wide
-----------------------------------------------------------------------------
Number of observations              379   ->   202         
Number of variables                   3   ->   3           
j variable (2 values)            period   ->   (dropped)
xij variables:
                                     n1   ->   n1post n1pre
-----------------------------------------------------------------------------

    Result                      Number of obs
    -----------------------------------------
    Not matched                            58
        from master                        29  
        from using                         29  

    Matched                               173  
    -----------------------------------------
(75 real changes made)
(32 real changes made)
(36 real changes made)
(47 real changes made)
(file
    C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/multnomah_flow_comparison_
    > n1.dta not found)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/multnomah_flow_comparison_
    > n1.dta saved
(file
    C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/multnomah_flow_comparison_
    > n1.csv not found)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/multnomah_flow_comparison_n
> 1.csv saved
Summary for n1:

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
     out_pre |        231     217.658     999.888          0      10579
    out_post |        231    258.5541    1107.284          0      11770
      in_pre |        231    223.6537    835.9653          0       8773
     in_post |        231    225.6753    816.5126          0       8572
Creating flow comparison dataset for n2...
(203,572 observations deleted)
(j = post pre)

Data                               Long   ->   Wide
-----------------------------------------------------------------------------
Number of observations              355   ->   202         
Number of variables                   3   ->   3           
j variable (2 values)            period   ->   (dropped)
xij variables:
                                     n2   ->   n2post n2pre
-----------------------------------------------------------------------------
file C:\Users\ji252\AppData\Local\Temp\ST_72bc_000009.tmp saved as .dta format
(203,528 observations deleted)
(j = post pre)

Data                               Long   ->   Wide
-----------------------------------------------------------------------------
Number of observations              379   ->   202         
Number of variables                   3   ->   3           
j variable (2 values)            period   ->   (dropped)
xij variables:
                                     n2   ->   n2post n2pre
-----------------------------------------------------------------------------

    Result                      Number of obs
    -----------------------------------------
    Not matched                            58
        from master                        29  
        from using                         29  

    Matched                               173  
    -----------------------------------------
(75 real changes made)
(32 real changes made)
(36 real changes made)
(47 real changes made)
(file
    C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/multnomah_flow_comparison_
    > n2.dta not found)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/multnomah_flow_comparison_
    > n2.dta saved
(file
    C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/multnomah_flow_comparison_
    > n2.csv not found)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/multnomah_flow_comparison_n
> 2.csv saved
Summary for n2:

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
     out_pre |        231    345.1342    1677.485          0      18690
    out_post |        231    398.8095    1806.828          0      20381
      in_pre |        231    322.4978    1252.515          0      12631
     in_post |        231    310.0649    1160.729          0      11789
Creating flow comparison dataset for agi...
(203,572 observations deleted)
(j = post pre)

Data                               Long   ->   Wide
-----------------------------------------------------------------------------
Number of observations              355   ->   202         
Number of variables                   3   ->   3           
j variable (2 values)            period   ->   (dropped)
xij variables:
                                    agi   ->   agipost agipre
-----------------------------------------------------------------------------
file C:\Users\ji252\AppData\Local\Temp\ST_72bc_00000c.tmp saved as .dta format
(203,528 observations deleted)
(j = post pre)

Data                               Long   ->   Wide
-----------------------------------------------------------------------------
Number of observations              379   ->   202         
Number of variables                   3   ->   3           
j variable (2 values)            period   ->   (dropped)
xij variables:
                                    agi   ->   agipost agipre
-----------------------------------------------------------------------------

    Result                      Number of obs
    -----------------------------------------
    Not matched                            58
        from master                        29  
        from using                         29  

    Matched                               173  
    -----------------------------------------
(75 real changes made)
(32 real changes made)
(36 real changes made)
(47 real changes made)
(file
    C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/multnomah_flow_comparison_
    > agi.dta not found)
file
    C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/multnomah_flow_comparison_
    > agi.dta saved
(file
    C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/multnomah_flow_comparison_
    > agi.csv not found)
file C:/Users/ji252/Documents/GitHub/multnomah-county-tax/data/working/multnomah_flow_comparison_a
> gi.csv saved
Summary for agi:

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
     out_pre |        231     15245.4    71845.05          0     727846
    out_post |        231    24860.27    109864.8          0    1170383
      in_pre |        231    14641.75     53537.6          0     592707
     in_post |        231    16286.22    58385.22          0     662028

. 
. dis "Flow comparison datasets created and exported to ${results}flows/"
Flow comparison datasets created and exported to C:/Users/ji252/Documents/GitHub/multnomah-county-
> tax/results/flows/

. 
. ** Close log
. clear

. log close log_02
      name:  log_02
       log:  C:/Users/ji252/Documents/GitHub/multnomah-county-tax/code/logs/02_log_descriptives_20
> 26-01-14.log
  log type:  text
 closed on:  14 Jan 2026, 20:39:09
--------------------------------------------------------------------------------------------------
