# ==============================================================================
# Tariff Impacts - Master Run Script
# ==============================================================================
#
# Purpose: Execute the full tariff impacts analysis pipeline
#
# Usage:
#   source("run_all.R")
#
# Or from command line:
#   Rscript run_all.R
#
# This script:
#   1. Checks for required packages and installs missing ones
#   2. Validates the environment (Haver connection, directories)
#   3. Runs the data processing script
#   4. Generates the HTML report
#   5. Logs execution status
#
# Author: John Iselin, Yale Budget Lab
# Date: January 2026
# ==============================================================================
cat("\n")
cat(rep("=", 70), "\n", sep = "")
cat("TARIFF IMPACTS ANALYSIS PIPELINE\n")
cat(rep("=", 70), "\n", sep = "")
cat("Started:", format(Sys.time(), "%Y-%m-%d %H:%M:%S"), "\n\n")
# ==============================================================================
# LOGGING SETUP
# ==============================================================================
# Create logs directory if it doesn't exist
LOG_DIR <- file.path(getwd(), "logs")
dir.create(LOG_DIR, showWarnings = FALSE, recursive = TRUE)
# Create log file with timestamp
LOG_FILE <- file.path(LOG_DIR, paste0("run_all_", format(Sys.time(), "%Y%m%d_%H%M%S"), ".log"))
# Initialize log file
cat(paste0("Tariff Impacts Pipeline Log\n"),
paste0("Started: ", format(Sys.time(), "%Y-%m-%d %H:%M:%S"), "\n"),
paste0(rep("=", 70), "\n"),
file = LOG_FILE, sep = "")
# ==============================================================================
# CONFIGURATION
# ==============================================================================
# Required packages
REQUIRED_PACKAGES <- c(
"Haver",       # Haver Analytics data access
"dplyr",       # Data manipulation
"tidyr",       # Data reshaping
"lubridate",   # Date handling
"readr",       # CSV reading/writing
"readxl",      # Excel file reading
"openxlsx",    # Excel file writing (for results export)
"here",        # Project-relative paths
"stringr",     # String manipulation
"ggplot2",     # Plotting
"scales",      # Plot scales
"knitr",       # Report generation
"kableExtra",  # Table formatting
"rmarkdown",   # R Markdown rendering
"sandwich",    # Newey-West HAC standard errors
"lmtest",      # Robust coefficient testing
"MSwM",        # Markov-switching models for local projection trend
"depmixS4"     # Hidden Markov models (fallback for MSwM)
)
# ==============================================================================
# HELPER FUNCTIONS
# ==============================================================================
# Simple log_msg for early use (before utils.R is sourced)
log_msg <- function(level, message) {
timestamp <- format(Sys.time(), "%Y-%m-%d %H:%M:%S")
log_line <- paste0("[", timestamp, "][", level, "] ", message, "\n")
# Print to console
cat(log_line)
# Append to log file
if (exists("LOG_FILE") && file.exists(dirname(LOG_FILE))) {
cat(log_line, file = LOG_FILE, append = TRUE)
}
}
install_missing_packages <- function(packages) {
missing <- packages[!sapply(packages, requireNamespace, quietly = TRUE)]
if (length(missing) > 0) {
log_msg("INFO", paste("Installing missing packages:", paste(missing, collapse = ", ")))
# Haver package needs special handling
if ("Haver" %in% missing) {
haver_install_result <- tryCatch({
install.packages("Haver", repos = "http://www.haver.com/r/")
TRUE
}, error = function(e) {
log_msg("WARN", "Could not install Haver package - Haver connection will not be available")
FALSE
})
# Update missing list (without using <<-)
missing <- missing[missing != "Haver"]
}
# Install remaining packages from CRAN
if (length(missing) > 0) {
install.packages(missing)
}
}
}
check_packages_available <- function(packages) {
missing <- packages[!sapply(packages, requireNamespace, quietly = TRUE)]
if (length(missing) > 0) {
log_msg("WARN", paste("Missing packages:", paste(missing, collapse = ", ")))
return(FALSE)
}
return(TRUE)
}
# ==============================================================================
# STEP 1: CHECK AND INSTALL PACKAGES
# ==============================================================================
log_msg("INFO", "Step 1: Checking required packages...")
if (!check_packages_available(REQUIRED_PACKAGES)) {
log_msg("INFO", "Attempting to install missing packages...")
install_missing_packages(REQUIRED_PACKAGES)
# Verify installation
if (!check_packages_available(REQUIRED_PACKAGES[REQUIRED_PACKAGES != "Haver"])) {
stop("Failed to install required packages. Please install manually.")
}
}
log_msg("INFO", "All required packages available")
# ==============================================================================
# STEP 2: VALIDATE ENVIRONMENT
# ==============================================================================
log_msg("INFO", "Step 2: Validating environment...")
# Load here package for path management
library(here)
# Check if we're in the right project directory
if (!file.exists(here("R", "tariff_impacts_work.R"))) {
stop("Cannot find R/tariff_impacts_work.R - please run from project root directory")
}
